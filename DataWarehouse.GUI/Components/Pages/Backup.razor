@page "/backup"
@inject InstanceManager InstanceManager
@inject CapabilityManager CapabilityManager
@inject DialogService DialogService

<div class="content-header">
    <h2>Backup & Restore</h2>
    <div class="d-flex gap-2">
        <button class="btn btn-primary" @onclick="CreateBackup" disabled="@(!_hasBackupCapability)">
            Create Backup
        </button>
        <button class="btn btn-secondary" @onclick="RefreshBackups">Refresh</button>
    </div>
</div>

<div class="content-body">
    @if (!InstanceManager.IsConnected)
    {
        <div class="alert alert-warning">Not connected to a DataWarehouse instance.</div>
    }
    else if (!_hasBackupCapability)
    {
        <div class="alert alert-info">
            <strong>Backup Not Available</strong><br />
            The connected instance does not have backup capability. Install a backup plugin to enable this feature.
        </div>
    }
    else
    {
        <!-- Backup Schedule Card -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Backup Schedule</span>
                <button class="btn btn-secondary" style="padding: 4px 12px;" @onclick="ConfigureSchedule">
                    Configure
                </button>
            </div>
            <div class="card-body">
                @if (_schedule != null)
                {
                    <div class="d-flex gap-3">
                        <div>
                            <strong>Frequency:</strong> @_schedule.Frequency
                        </div>
                        <div>
                            <strong>Next Run:</strong> @_schedule.NextRun.ToString("yyyy-MM-dd HH:mm")
                        </div>
                        <div>
                            <strong>Retention:</strong> @_schedule.RetentionDays days
                        </div>
                    </div>
                }
                else
                {
                    <p class="text-muted">No backup schedule configured</p>
                }
            </div>
        </div>

        <!-- Backups List -->
        <div class="card mt-3">
            <div class="card-header">Available Backups</div>
            <div class="card-body">
                @if (_isLoading)
                {
                    <div class="text-center">
                        <div class="spinner"></div>
                    </div>
                }
                else if (_backups.Any())
                {
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Created</th>
                                <th>Size</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var backup in _backups)
                            {
                                <tr>
                                    <td>@backup.Name</td>
                                    <td>@backup.Created.ToString("yyyy-MM-dd HH:mm")</td>
                                    <td>@FormatBytes(backup.Size)</td>
                                    <td>@backup.Type</td>
                                    <td><span class="badge @GetStatusBadge(backup.Status)">@backup.Status</span></td>
                                    <td>
                                        <button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;"
                                                @onclick="() => RestoreBackup(backup)"
                                                disabled="@(backup.Status != "Complete")">
                                            Restore
                                        </button>
                                        <button class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;"
                                                @onclick="() => DeleteBackup(backup)">
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p class="text-muted text-center">No backups available</p>
                }
            </div>
        </div>

        <!-- Restore History -->
        <div class="card mt-3">
            <div class="card-header">Recent Restore Operations</div>
            <div class="card-body">
                @if (_restoreHistory.Any())
                {
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Backup</th>
                                <th>Restored At</th>
                                <th>Duration</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var restore in _restoreHistory)
                            {
                                <tr>
                                    <td>@restore.BackupName</td>
                                    <td>@restore.RestoredAt.ToString("yyyy-MM-dd HH:mm")</td>
                                    <td>@restore.Duration</td>
                                    <td><span class="badge @GetStatusBadge(restore.Status)">@restore.Status</span></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p class="text-muted text-center">No restore operations yet</p>
                }
            </div>
        </div>
    }
</div>

@code {
    private bool _hasBackupCapability;
    private bool _isLoading = false;
    private BackupSchedule? _schedule;
    private List<BackupEntry> _backups = new();
    private List<RestoreEntry> _restoreHistory = new();

    protected override async Task OnInitializedAsync()
    {
        _hasBackupCapability = CapabilityManager.HasFeature("backup");
        if (_hasBackupCapability)
        {
            await RefreshBackups();
        }
    }

    private async Task RefreshBackups()
    {
        if (!InstanceManager.IsConnected) return;

        _isLoading = true;
        StateHasChanged();

        try
        {
            // Get backup list
            var result = await InstanceManager.ExecuteAsync("backup.list");
            _backups = ParseBackups(result);

            // Get schedule
            var scheduleResult = await InstanceManager.ExecuteAsync("backup.schedule.get");
            _schedule = ParseSchedule(scheduleResult);

            // Get restore history
            var historyResult = await InstanceManager.ExecuteAsync("backup.restore.history");
            _restoreHistory = ParseRestoreHistory(historyResult);
        }
        catch
        {
            // Handle error
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task CreateBackup()
    {
        var name = await DialogService.PromptAsync("Create Backup", "Enter backup name:");
        if (!string.IsNullOrEmpty(name))
        {
            try
            {
                await InstanceManager.ExecuteAsync("backup.create", new Dictionary<string, object>
                {
                    ["name"] = name,
                    ["type"] = "full"
                });
                await DialogService.AlertAsync("Success", "Backup started successfully");
                await RefreshBackups();
            }
            catch (Exception ex)
            {
                await DialogService.AlertAsync("Error", $"Failed to create backup: {ex.Message}");
            }
        }
    }

    private async Task RestoreBackup(BackupEntry backup)
    {
        var confirmed = await DialogService.ConfirmAsync(
            "Confirm Restore",
            $"Are you sure you want to restore from '{backup.Name}'? This will replace current data.");

        if (confirmed)
        {
            try
            {
                await InstanceManager.ExecuteAsync("backup.restore", new Dictionary<string, object>
                {
                    ["name"] = backup.Name
                });
                await DialogService.AlertAsync("Success", "Restore started successfully");
                await RefreshBackups();
            }
            catch (Exception ex)
            {
                await DialogService.AlertAsync("Error", $"Failed to restore: {ex.Message}");
            }
        }
    }

    private async Task DeleteBackup(BackupEntry backup)
    {
        var confirmed = await DialogService.ConfirmAsync(
            "Confirm Delete",
            $"Are you sure you want to delete backup '{backup.Name}'?");

        if (confirmed)
        {
            try
            {
                await InstanceManager.ExecuteAsync("backup.delete", new Dictionary<string, object>
                {
                    ["name"] = backup.Name
                });
                await RefreshBackups();
            }
            catch (Exception ex)
            {
                await DialogService.AlertAsync("Error", $"Failed to delete backup: {ex.Message}");
            }
        }
    }

    private async Task ConfigureSchedule()
    {
        await DialogService.AlertAsync("Schedule Configuration",
            "Schedule configuration UI would open here.\n\n" +
            "Available options:\n- Frequency (hourly, daily, weekly)\n- Retention period\n- Destination");
    }

    private string FormatBytes(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        int order = 0;
        double size = bytes;
        while (size >= 1024 && order < sizes.Length - 1) { order++; size /= 1024; }
        return $"{size:0.##} {sizes[order]}";
    }

    private string GetStatusBadge(string status) => status.ToLower() switch
    {
        "complete" or "success" => "badge-success",
        "in progress" or "running" => "badge-info",
        "failed" or "error" => "badge-danger",
        _ => "badge-warning"
    };

    private List<BackupEntry> ParseBackups(object? result)
    {
        var backups = new List<BackupEntry>();
        if (result is IEnumerable<object> list)
        {
            foreach (var item in list)
            {
                if (item is IDictionary<string, object> dict)
                {
                    backups.Add(new BackupEntry
                    {
                        Name = dict.TryGetValue("name", out var n) ? n?.ToString() ?? "" : "",
                        Created = dict.TryGetValue("created", out var c) && DateTime.TryParse(c?.ToString(), out var dt) ? dt : DateTime.MinValue,
                        Size = dict.TryGetValue("size", out var s) && long.TryParse(s?.ToString(), out var sz) ? sz : 0,
                        Type = dict.TryGetValue("type", out var t) ? t?.ToString() ?? "" : "",
                        Status = dict.TryGetValue("status", out var st) ? st?.ToString() ?? "" : ""
                    });
                }
            }
        }
        return backups.OrderByDescending(b => b.Created).ToList();
    }

    private BackupSchedule? ParseSchedule(object? result)
    {
        if (result is IDictionary<string, object> dict && dict.Count > 0)
        {
            return new BackupSchedule
            {
                Frequency = dict.TryGetValue("frequency", out var f) ? f?.ToString() ?? "" : "",
                NextRun = dict.TryGetValue("nextRun", out var n) && DateTime.TryParse(n?.ToString(), out var dt) ? dt : DateTime.MinValue,
                RetentionDays = dict.TryGetValue("retentionDays", out var r) && int.TryParse(r?.ToString(), out var days) ? days : 30
            };
        }
        return null;
    }

    private List<RestoreEntry> ParseRestoreHistory(object? result)
    {
        var history = new List<RestoreEntry>();
        if (result is IEnumerable<object> list)
        {
            foreach (var item in list)
            {
                if (item is IDictionary<string, object> dict)
                {
                    history.Add(new RestoreEntry
                    {
                        BackupName = dict.TryGetValue("backupName", out var n) ? n?.ToString() ?? "" : "",
                        RestoredAt = dict.TryGetValue("restoredAt", out var r) && DateTime.TryParse(r?.ToString(), out var dt) ? dt : DateTime.MinValue,
                        Duration = dict.TryGetValue("duration", out var d) ? d?.ToString() ?? "" : "",
                        Status = dict.TryGetValue("status", out var s) ? s?.ToString() ?? "" : ""
                    });
                }
            }
        }
        return history.OrderByDescending(r => r.RestoredAt).ToList();
    }

    private record BackupEntry { public string Name { get; init; } = ""; public DateTime Created { get; init; } public long Size { get; init; } public string Type { get; init; } = ""; public string Status { get; init; } = ""; }
    private record BackupSchedule { public string Frequency { get; init; } = ""; public DateTime NextRun { get; init; } public int RetentionDays { get; init; } }
    private record RestoreEntry { public string BackupName { get; init; } = ""; public DateTime RestoredAt { get; init; } public string Duration { get; init; } = ""; public string Status { get; init; } = ""; }
}
