@page "/compliance/soc2"
@inject InstanceManager InstanceManager

<div class="content-header">
    <h2>SOC 2 Evidence Collection</h2>
    <div class="d-flex gap-2">
        <button class="btn btn-secondary" @onclick="RefreshData" disabled="@_isLoading">Refresh</button>
        <button class="btn btn-secondary" @onclick="ExportEvidence" disabled="@_isLoading">Export Evidence</button>
    </div>
</div>

<div class="content-body">
    @if (!InstanceManager.IsConnected)
    {
        <div class="alert alert-warning" role="alert">Not connected to a DataWarehouse instance.</div>
    }
    else if (_isLoading)
    {
        <div class="text-center mt-4"><div class="spinner"></div></div>
    }
    else
    {
        <div class="card">
            <div class="card-header">Trust Service Criteria Status</div>
            <div class="card-body">
                <div class="d-flex gap-3" style="flex-wrap: wrap;">
                    @foreach (var criteria in _trustCriteria)
                    {
                        <div class="card" style="flex: 1; min-width: 180px;">
                            <div class="card-body text-center">
                                <div style="font-size: 16px; font-weight: bold;">@criteria.Name</div>
                                <div class="mt-2">
                                    <span class="badge @GetComplianceBadge(criteria.ComplianceScore)" style="font-size: 14px;">
                                        @criteria.ComplianceScore.ToString("F0")%
                                    </span>
                                </div>
                                <div class="text-muted mt-1" style="font-size: 12px;">@criteria.ControlsPassing / @criteria.TotalControls controls</div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">Control Evidence Collection</div>
            <div class="card-body" style="padding: 0;">
                <table class="data-table" role="table" aria-label="Control evidence">
                    <thead>
                        <tr>
                            <th scope="col">Control ID</th>
                            <th scope="col">Description</th>
                            <th scope="col">Criteria</th>
                            <th scope="col">Evidence Type</th>
                            <th scope="col">Collected At</th>
                            <th scope="col">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var evidence in _evidenceRecords)
                        {
                            <tr>
                                <td><code>@evidence.ControlId</code></td>
                                <td>@evidence.Description</td>
                                <td><span class="badge badge-info">@evidence.Criteria</span></td>
                                <td>@evidence.EvidenceType</td>
                                <td>@evidence.CollectedAt.ToString("yyyy-MM-dd HH:mm")</td>
                                <td><span class="badge @GetEvidenceStatusBadge(evidence.Status)">@evidence.Status</span></td>
                            </tr>
                        }
                        @if (!_evidenceRecords.Any())
                        {
                            <tr><td colspan="6" class="text-center text-muted">No evidence collected yet</td></tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">Control Assessment Summary</div>
            <div class="card-body" style="padding: 0;">
                <table class="data-table" role="table" aria-label="Control assessments">
                    <thead>
                        <tr>
                            <th scope="col">Control Category</th>
                            <th scope="col">Total Controls</th>
                            <th scope="col">Implemented</th>
                            <th scope="col">Operating Effectively</th>
                            <th scope="col">Deficiencies</th>
                            <th scope="col">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var assessment in _controlAssessments)
                        {
                            <tr>
                                <td>@assessment.Category</td>
                                <td>@assessment.TotalControls</td>
                                <td>@assessment.Implemented</td>
                                <td>@assessment.OperatingEffectively</td>
                                <td>@assessment.Deficiencies</td>
                                <td><span class="badge @GetAssessmentBadge(assessment.Status)">@assessment.Status</span></td>
                            </tr>
                        }
                        @if (!_controlAssessments.Any())
                        {
                            <tr><td colspan="6" class="text-center text-muted">No assessments available</td></tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">Audit Trail Viewer</div>
            <div class="card-body" style="padding: 0;">
                <table class="data-table" role="table" aria-label="Audit trail">
                    <thead>
                        <tr>
                            <th scope="col">Timestamp</th>
                            <th scope="col">Event Type</th>
                            <th scope="col">User</th>
                            <th scope="col">Resource</th>
                            <th scope="col">Action</th>
                            <th scope="col">Result</th>
                            <th scope="col">IP Address</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var trail in _auditTrail)
                        {
                            <tr>
                                <td>@trail.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                <td>@trail.EventType</td>
                                <td>@trail.User</td>
                                <td>@trail.Resource</td>
                                <td>@trail.Action</td>
                                <td><span class="badge @(trail.Success ? "badge-success" : "badge-danger")">@(trail.Success ? "Success" : "Failed")</span></td>
                                <td><code>@trail.IpAddress</code></td>
                            </tr>
                        }
                        @if (!_auditTrail.Any())
                        {
                            <tr><td colspan="7" class="text-center text-muted">No audit events recorded</td></tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">Continuous Monitoring Status</div>
            <div class="card-body">
                <div class="d-flex gap-3" style="flex-wrap: wrap;">
                    @foreach (var monitor in _monitoringChecks)
                    {
                        <div class="card" style="flex: 1; min-width: 250px;">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>@monitor.CheckName</span>
                                    <span class="badge @GetMonitorBadge(monitor.Status)">@monitor.Status</span>
                                </div>
                                <div class="text-muted mt-1" style="font-size: 12px;">
                                    Last Check: @monitor.LastCheckAt.ToString("yyyy-MM-dd HH:mm")
                                </div>
                                @if (!string.IsNullOrEmpty(monitor.Details))
                                {
                                    <div class="text-muted mt-1" style="font-size: 11px;">@monitor.Details</div>
                                }
                            </div>
                        </div>
                    }
                </div>
                @if (!_monitoringChecks.Any())
                {
                    <div class="text-center text-muted">No monitoring checks configured</div>
                }
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">Audit Readiness Score</div>
            <div class="card-body">
                <div class="d-flex align-items-center gap-3">
                    <div style="flex: 0 0 120px;">
                        <div style="font-size: 48px; font-weight: bold; color: @GetScoreColor(_auditReadinessScore);">
                            @_auditReadinessScore.ToString("F0")%
                        </div>
                    </div>
                    <div style="flex: 1;">
                        <div class="progress" style="height: 30px;">
                            <div class="progress-bar @GetProgressBarClass(_auditReadinessScore)"
                                 role="progressbar"
                                 style="width: @_auditReadinessScore%"
                                 aria-valuenow="@_auditReadinessScore"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <div class="mt-2 text-muted">
                            @_readinessMessage
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <h6>Readiness Checklist</h6>
                    <ul class="list-unstyled">
                        @foreach (var item in _readinessChecklist)
                        {
                            <li class="d-flex align-items-center gap-2 mb-1">
                                <span class="@(item.Completed ? "text-success" : "text-muted")">
                                    @(item.Completed ? "✓" : "○")
                                </span>
                                <span class="@(item.Completed ? "" : "text-muted")">@item.Description</span>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">Recent Findings & Exceptions</div>
            <div class="card-body" style="padding: 0;">
                <table class="data-table" role="table" aria-label="Findings and exceptions">
                    <thead>
                        <tr>
                            <th scope="col">Finding ID</th>
                            <th scope="col">Control</th>
                            <th scope="col">Severity</th>
                            <th scope="col">Description</th>
                            <th scope="col">Identified</th>
                            <th scope="col">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var finding in _findings)
                        {
                            <tr>
                                <td><code>@finding.FindingId</code></td>
                                <td>@finding.ControlId</td>
                                <td><span class="badge @GetSeverityBadge(finding.Severity)">@finding.Severity</span></td>
                                <td>@finding.Description</td>
                                <td>@finding.IdentifiedAt.ToString("yyyy-MM-dd")</td>
                                <td>@finding.Status</td>
                            </tr>
                        }
                        @if (!_findings.Any())
                        {
                            <tr><td colspan="6" class="text-center text-success">No findings or exceptions</td></tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@code {
    private bool _isLoading = false;
    private double _auditReadinessScore = 0;
    private string _readinessMessage = "";
    private List<TrustCriteria> _trustCriteria = new();
    private List<EvidenceRecord> _evidenceRecords = new();
    private List<ControlAssessment> _controlAssessments = new();
    private List<AuditTrailEntry> _auditTrail = new();
    private List<MonitoringCheck> _monitoringChecks = new();
    private List<ReadinessChecklistItem> _readinessChecklist = new();
    private List<Finding> _findings = new();

    protected override async Task OnInitializedAsync() => await RefreshData();

    private async Task RefreshData()
    {
        if (!InstanceManager.IsConnected) return;
        _isLoading = true;
        StateHasChanged();

        try
        {
            var report = await InstanceManager.ExecuteAsync("soc2.evidence.report");
            ParseReport(report);
        }
        catch (Exception)
        {
            LoadMockData();
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void ParseReport(object? result)
    {
        if (result is IDictionary<string, object> dict)
        {
            // Parse report data - similar pattern to other compliance pages
        }
        else
        {
            LoadMockData();
        }
    }

    private void LoadMockData()
    {
        _auditReadinessScore = 87.5;
        _readinessMessage = "Your organization is well-prepared for a SOC 2 audit. Address remaining findings to improve readiness.";

        _trustCriteria = new List<TrustCriteria>
        {
            new() { Name = "Security", ComplianceScore = 92, TotalControls = 25, ControlsPassing = 23 },
            new() { Name = "Availability", ComplianceScore = 88, TotalControls = 15, ControlsPassing = 13 },
            new() { Name = "Processing Integrity", ComplianceScore = 85, TotalControls = 12, ControlsPassing = 10 },
            new() { Name = "Confidentiality", ComplianceScore = 90, TotalControls = 18, ControlsPassing = 16 },
            new() { Name = "Privacy", ComplianceScore = 82, TotalControls = 20, ControlsPassing = 16 }
        };

        _evidenceRecords = new List<EvidenceRecord>
        {
            new() { ControlId = "CC6.1", Description = "Logical access controls", Criteria = "Security", EvidenceType = "Screenshot", CollectedAt = DateTime.UtcNow.AddHours(-2), Status = "Verified" },
            new() { ControlId = "CC7.2", Description = "System monitoring", Criteria = "Security", EvidenceType = "Log Export", CollectedAt = DateTime.UtcNow.AddHours(-5), Status = "Verified" },
            new() { ControlId = "A1.2", Description = "System availability monitoring", Criteria = "Availability", EvidenceType = "Report", CollectedAt = DateTime.UtcNow.AddDays(-1), Status = "Pending Review" }
        };

        _controlAssessments = new List<ControlAssessment>
        {
            new() { Category = "CC1 - Control Environment", TotalControls = 12, Implemented = 12, OperatingEffectively = 11, Deficiencies = 1, Status = "Effective" },
            new() { Category = "CC2 - Communication", TotalControls = 8, Implemented = 8, OperatingEffectively = 8, Deficiencies = 0, Status = "Effective" },
            new() { Category = "CC3 - Risk Assessment", TotalControls = 10, Implemented = 10, OperatingEffectively = 9, Deficiencies = 1, Status = "Effective" },
            new() { Category = "CC6 - Logical Access", TotalControls = 15, Implemented = 15, OperatingEffectively = 14, Deficiencies = 1, Status = "Effective" },
            new() { Category = "CC7 - System Operations", TotalControls = 18, Implemented = 17, OperatingEffectively = 15, Deficiencies = 2, Status = "Needs Improvement" }
        };

        _auditTrail = new List<AuditTrailEntry>
        {
            new() { Timestamp = DateTime.UtcNow.AddMinutes(-10), EventType = "Authentication", User = "admin@company.com", Resource = "Control Panel", Action = "Login", Success = true, IpAddress = "192.168.1.100" },
            new() { Timestamp = DateTime.UtcNow.AddMinutes(-25), EventType = "Configuration", User = "security@company.com", Resource = "Access Control", Action = "Update Policy", Success = true, IpAddress = "192.168.1.105" },
            new() { Timestamp = DateTime.UtcNow.AddHours(-1), EventType = "Data Access", User = "auditor@company.com", Resource = "Evidence Repository", Action = "View", Success = true, IpAddress = "192.168.1.110" }
        };

        _monitoringChecks = new List<MonitoringCheck>
        {
            new() { CheckName = "Encryption Status", Status = "Passed", LastCheckAt = DateTime.UtcNow.AddMinutes(-15), Details = "All data encrypted at rest and in transit" },
            new() { CheckName = "Access Control Review", Status = "Passed", LastCheckAt = DateTime.UtcNow.AddHours(-2), Details = "No unauthorized access detected" },
            new() { CheckName = "Backup Verification", Status = "Passed", LastCheckAt = DateTime.UtcNow.AddHours(-6), Details = "Last backup completed successfully" },
            new() { CheckName = "Vulnerability Scan", Status = "Warning", LastCheckAt = DateTime.UtcNow.AddDays(-1), Details = "2 low-severity vulnerabilities found" }
        };

        _readinessChecklist = new List<ReadinessChecklistItem>
        {
            new() { Description = "All controls documented with evidence", Completed = true },
            new() { Description = "System description complete and current", Completed = true },
            new() { Description = "Risk assessment performed within last 12 months", Completed = true },
            new() { Description = "No critical findings outstanding", Completed = true },
            new() { Description = "Continuous monitoring active for all TSCs", Completed = true },
            new() { Description = "Vendor assessments completed for all subservice organizations", Completed = false },
            new() { Description = "Incident response plan tested within last year", Completed = true },
            new() { Description = "All deficiencies remediated or have approved exceptions", Completed = false }
        };

        _findings = new List<Finding>
        {
            new() { FindingId = "F-001", ControlId = "CC7.2", Severity = "Medium", Description = "System monitoring logs retention period is 60 days, should be 90 days", IdentifiedAt = DateTime.UtcNow.AddDays(-10), Status = "Remediation in Progress" },
            new() { FindingId = "F-002", ControlId = "CC1.4", Severity = "Low", Description = "Security awareness training completion rate at 92%, target is 95%", IdentifiedAt = DateTime.UtcNow.AddDays(-5), Status = "Open" }
        };
    }

    private async Task ExportEvidence()
    {
        if (!InstanceManager.IsConnected) return;
        await InstanceManager.ExecuteAsync("soc2.evidence.export", new Dictionary<string, object> { ["format"] = "zip" });
    }

    private string GetComplianceBadge(double score) => score switch
    {
        >= 90 => "badge-success",
        >= 75 => "badge-warning",
        _ => "badge-danger"
    };

    private string GetEvidenceStatusBadge(string status) => status?.ToLower() switch
    {
        "verified" => "badge-success",
        "pending review" => "badge-warning",
        "rejected" => "badge-danger",
        _ => "badge-info"
    };

    private string GetAssessmentBadge(string status) => status?.ToLower() switch
    {
        "effective" => "badge-success",
        "needs improvement" => "badge-warning",
        "ineffective" => "badge-danger",
        _ => "badge-info"
    };

    private string GetMonitorBadge(string status) => status?.ToLower() switch
    {
        "passed" => "badge-success",
        "warning" => "badge-warning",
        "failed" => "badge-danger",
        _ => "badge-info"
    };

    private string GetSeverityBadge(string severity) => severity?.ToLower() switch
    {
        "critical" => "badge-danger",
        "high" => "badge-danger",
        "medium" => "badge-warning",
        "low" => "badge-info",
        _ => "badge-info"
    };

    private string GetScoreColor(double score) => score switch
    {
        >= 90 => "#28a745",
        >= 75 => "#ffc107",
        _ => "#dc3545"
    };

    private string GetProgressBarClass(double score) => score switch
    {
        >= 90 => "bg-success",
        >= 75 => "bg-warning",
        _ => "bg-danger"
    };

    private record TrustCriteria
    {
        public string Name { get; init; } = "";
        public double ComplianceScore { get; init; }
        public int TotalControls { get; init; }
        public int ControlsPassing { get; init; }
    }

    private record EvidenceRecord
    {
        public string ControlId { get; init; } = "";
        public string Description { get; init; } = "";
        public string Criteria { get; init; } = "";
        public string EvidenceType { get; init; } = "";
        public DateTime CollectedAt { get; init; }
        public string Status { get; init; } = "";
    }

    private record ControlAssessment
    {
        public string Category { get; init; } = "";
        public int TotalControls { get; init; }
        public int Implemented { get; init; }
        public int OperatingEffectively { get; init; }
        public int Deficiencies { get; init; }
        public string Status { get; init; } = "";
    }

    private record AuditTrailEntry
    {
        public DateTime Timestamp { get; init; }
        public string EventType { get; init; } = "";
        public string User { get; init; } = "";
        public string Resource { get; init; } = "";
        public string Action { get; init; } = "";
        public bool Success { get; init; }
        public string IpAddress { get; init; } = "";
    }

    private record MonitoringCheck
    {
        public string CheckName { get; init; } = "";
        public string Status { get; init; } = "";
        public DateTime LastCheckAt { get; init; }
        public string Details { get; init; } = "";
    }

    private record ReadinessChecklistItem
    {
        public string Description { get; init; } = "";
        public bool Completed { get; init; }
    }

    private record Finding
    {
        public string FindingId { get; init; } = "";
        public string ControlId { get; init; } = "";
        public string Severity { get; init; } = "";
        public string Description { get; init; } = "";
        public DateTime IdentifiedAt { get; init; }
        public string Status { get; init; } = "";
    }
}
