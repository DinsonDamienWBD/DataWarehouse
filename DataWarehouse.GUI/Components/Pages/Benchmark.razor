@page "/benchmark"
@inject InstanceManager InstanceManager
@inject DialogService DialogService

<div class="content-header">
    <h2>Benchmark Tools</h2>
    <button class="btn btn-primary" @onclick="RunBenchmark" disabled="@_isRunning">@(_isRunning ? "Running..." : "Run Benchmark")</button>
</div>

<div class="content-body">
    @if (!InstanceManager.IsConnected)
    {
        <div class="alert alert-warning">Not connected to a DataWarehouse instance.</div>
    }
    else
    {
        <div class="card">
            <div class="card-header">Benchmark Configuration</div>
            <div class="card-body">
                <div class="d-flex gap-3">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">Test Type</label>
                        <select class="form-select" @bind="_testType">
                            <option value="read">Read Performance</option>
                            <option value="write">Write Performance</option>
                            <option value="mixed">Mixed Read/Write</option>
                            <option value="throughput">Throughput</option>
                            <option value="latency">Latency</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">File Size (MB)</label>
                        <input type="number" class="form-input" @bind="_fileSizeMb" min="1" max="1024" />
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">Iterations</label>
                        <input type="number" class="form-input" @bind="_iterations" min="1" max="100" />
                    </div>
                </div>
            </div>
        </div>

        @if (_isRunning)
        {
            <div class="card mt-3">
                <div class="card-body text-center">
                    <div class="spinner"></div>
                    <p class="mt-2">Running benchmark: @_progress%</p>
                    <div class="progress" style="max-width: 400px; margin: 0 auto;">
                        <div class="progress-bar" style="width: @_progress%"></div>
                    </div>
                </div>
            </div>
        }

        @if (_results != null)
        {
            <div class="card mt-3">
                <div class="card-header">Benchmark Results</div>
                <div class="card-body">
                    <div class="d-flex gap-3" style="flex-wrap: wrap;">
                        <div class="card" style="flex: 1; min-width: 200px;">
                            <div class="card-body text-center">
                                <div style="font-size: 24px; font-weight: bold;">@_results.ReadMbps.ToString("F2")</div>
                                <div class="text-muted">Read MB/s</div>
                            </div>
                        </div>
                        <div class="card" style="flex: 1; min-width: 200px;">
                            <div class="card-body text-center">
                                <div style="font-size: 24px; font-weight: bold;">@_results.WriteMbps.ToString("F2")</div>
                                <div class="text-muted">Write MB/s</div>
                            </div>
                        </div>
                        <div class="card" style="flex: 1; min-width: 200px;">
                            <div class="card-body text-center">
                                <div style="font-size: 24px; font-weight: bold;">@_results.Iops</div>
                                <div class="text-muted">IOPS</div>
                            </div>
                        </div>
                        <div class="card" style="flex: 1; min-width: 200px;">
                            <div class="card-body text-center">
                                <div style="font-size: 24px; font-weight: bold;">@_results.LatencyMs.ToString("F2")</div>
                                <div class="text-muted">Latency (ms)</div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 text-muted">
                        Test completed at @_results.CompletedAt.ToString("yyyy-MM-dd HH:mm:ss") | Duration: @_results.DurationSeconds.ToString("F1")s
                    </div>
                </div>
            </div>
        }

        <div class="card mt-3">
            <div class="card-header">Benchmark History</div>
            <div class="card-body" style="padding: 0;">
                <table class="data-table">
                    <thead><tr><th>Date</th><th>Type</th><th>Read MB/s</th><th>Write MB/s</th><th>IOPS</th><th>Latency</th></tr></thead>
                    <tbody>
                        @foreach (var h in _history)
                        {
                            <tr>
                                <td>@h.CompletedAt.ToString("yyyy-MM-dd HH:mm")</td>
                                <td>@h.TestType</td>
                                <td>@h.ReadMbps.ToString("F2")</td>
                                <td>@h.WriteMbps.ToString("F2")</td>
                                <td>@h.Iops</td>
                                <td>@h.LatencyMs.ToString("F2") ms</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@code {
    private string _testType = "mixed";
    private int _fileSizeMb = 100;
    private int _iterations = 10;
    private bool _isRunning = false;
    private int _progress = 0;
    private BenchmarkResult? _results;
    private List<BenchmarkResult> _history = new();

    private async Task RunBenchmark()
    {
        _isRunning = true; _progress = 0; StateHasChanged();
        try
        {
            for (int i = 0; i <= 100; i += 10) { _progress = i; StateHasChanged(); await Task.Delay(200); }
            var result = await InstanceManager.ExecuteAsync("benchmark.run", new Dictionary<string, object>
            {
                ["type"] = _testType, ["sizeMb"] = _fileSizeMb, ["iterations"] = _iterations
            });
            _results = ParseResult(result);
            if (_results != null) _history.Insert(0, _results);
        }
        finally { _isRunning = false; StateHasChanged(); }
    }

    private BenchmarkResult? ParseResult(object? r)
    {
        if (r is IDictionary<string, object> d)
            return new()
            {
                TestType = _testType,
                ReadMbps = d.TryGetValue("readMbps", out var rm) && double.TryParse(rm?.ToString(), out var rmv) ? rmv : 0,
                WriteMbps = d.TryGetValue("writeMbps", out var wm) && double.TryParse(wm?.ToString(), out var wmv) ? wmv : 0,
                Iops = d.TryGetValue("iops", out var io) && int.TryParse(io?.ToString(), out var iov) ? iov : 0,
                LatencyMs = d.TryGetValue("latencyMs", out var lm) && double.TryParse(lm?.ToString(), out var lmv) ? lmv : 0,
                DurationSeconds = d.TryGetValue("duration", out var dur) && double.TryParse(dur?.ToString(), out var durv) ? durv : 0,
                CompletedAt = DateTime.Now
            };
        return new() { TestType = _testType, ReadMbps = 150.5, WriteMbps = 120.3, Iops = 5000, LatencyMs = 2.5, DurationSeconds = 10, CompletedAt = DateTime.Now };
    }

    private record BenchmarkResult { public string TestType { get; init; } = ""; public double ReadMbps { get; init; } public double WriteMbps { get; init; } public int Iops { get; init; } public double LatencyMs { get; init; } public double DurationSeconds { get; init; } public DateTime CompletedAt { get; init; } }
}
