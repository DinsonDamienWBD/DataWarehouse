@page "/system"
@inject InstanceManager InstanceManager

<div class="content-header">
    <h2>System Information</h2>
    <button class="btn btn-secondary" @onclick="RefreshInfo">Refresh</button>
</div>

<div class="content-body">
    @if (!InstanceManager.IsConnected)
    {
        <div class="alert alert-warning">Not connected to a DataWarehouse instance.</div>
    }
    else if (_isLoading)
    {
        <div class="text-center mt-4"><div class="spinner"></div></div>
    }
    else
    {
        <div class="d-flex gap-3" style="flex-wrap: wrap;">
            <div class="card" style="flex: 1; min-width: 300px;">
                <div class="card-header">Instance Information</div>
                <div class="card-body">
                    <table class="data-table">
                        <tbody>
                            <tr><td><strong>Instance ID</strong></td><td>@_info.InstanceId</td></tr>
                            <tr><td><strong>Version</strong></td><td>@_info.Version</td></tr>
                            <tr><td><strong>Build Date</strong></td><td>@_info.BuildDate</td></tr>
                            <tr><td><strong>Uptime</strong></td><td>@_info.Uptime</td></tr>
                            <tr><td><strong>Start Time</strong></td><td>@_info.StartTime</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card" style="flex: 1; min-width: 300px;">
                <div class="card-header">Host Information</div>
                <div class="card-body">
                    <table class="data-table">
                        <tbody>
                            <tr><td><strong>Hostname</strong></td><td>@_info.Hostname</td></tr>
                            <tr><td><strong>OS</strong></td><td>@_info.OperatingSystem</td></tr>
                            <tr><td><strong>.NET Version</strong></td><td>@_info.DotNetVersion</td></tr>
                            <tr><td><strong>Processors</strong></td><td>@_info.ProcessorCount</td></tr>
                            <tr><td><strong>Total Memory</strong></td><td>@FormatBytes(_info.TotalMemory)</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">Runtime Statistics</div>
            <div class="card-body">
                <div class="d-flex gap-3" style="flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 150px;">
                        <div style="font-size: 24px; font-weight: bold;">@_info.TotalRequests.ToString("N0")</div>
                        <div class="text-muted">Total Requests</div>
                    </div>
                    <div style="flex: 1; min-width: 150px;">
                        <div style="font-size: 24px; font-weight: bold;">@_info.ActiveConnections</div>
                        <div class="text-muted">Active Connections</div>
                    </div>
                    <div style="flex: 1; min-width: 150px;">
                        <div style="font-size: 24px; font-weight: bold;">@_info.LoadedPlugins</div>
                        <div class="text-muted">Loaded Plugins</div>
                    </div>
                    <div style="flex: 1; min-width: 150px;">
                        <div style="font-size: 24px; font-weight: bold;">@FormatBytes(_info.MemoryUsed)</div>
                        <div class="text-muted">Memory Used</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">Storage Backends</div>
            <div class="card-body" style="padding: 0;">
                <table class="data-table">
                    <thead><tr><th>Backend</th><th>Type</th><th>Status</th><th>Capacity</th><th>Used</th></tr></thead>
                    <tbody>
                        @foreach (var backend in _info.Backends)
                        {
                            <tr>
                                <td>@backend.Name</td>
                                <td>@backend.Type</td>
                                <td><span class="badge @(backend.Status == "Online" ? "badge-success" : "badge-danger")">@backend.Status</span></td>
                                <td>@FormatBytes(backend.Capacity)</td>
                                <td>@FormatBytes(backend.Used)</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@code {
    private bool _isLoading = false;
    private SystemInfo _info = new();

    protected override async Task OnInitializedAsync() => await RefreshInfo();

    private async Task RefreshInfo()
    {
        if (!InstanceManager.IsConnected) return;
        _isLoading = true; StateHasChanged();
        try
        {
            var result = await InstanceManager.ExecuteAsync("system.info");
            _info = ParseInfo(result);
        }
        finally { _isLoading = false; StateHasChanged(); }
    }

    private string FormatBytes(long b) { string[] s = { "B", "KB", "MB", "GB", "TB" }; int o = 0; double sz = b; while (sz >= 1024 && o < s.Length - 1) { o++; sz /= 1024; } return $"{sz:0.##} {s[o]}"; }

    private SystemInfo ParseInfo(object? r)
    {
        var info = new SystemInfo
        {
            InstanceId = "dw-" + Guid.NewGuid().ToString()[..8],
            Version = "1.0.0",
            BuildDate = "2026-01-15",
            Uptime = "3d 12h 45m",
            StartTime = DateTime.Now.AddDays(-3).ToString("yyyy-MM-dd HH:mm"),
            Hostname = Environment.MachineName,
            OperatingSystem = Environment.OSVersion.ToString(),
            DotNetVersion = Environment.Version.ToString(),
            ProcessorCount = Environment.ProcessorCount,
            TotalMemory = GC.GetGCMemoryInfo().TotalAvailableMemoryBytes,
            MemoryUsed = GC.GetTotalMemory(false),
            TotalRequests = 125000,
            ActiveConnections = 5,
            LoadedPlugins = 12,
            Backends = new() { new() { Name = "primary", Type = "Local", Status = "Online", Capacity = 1000000000000, Used = 250000000000 } }
        };
        if (r is IDictionary<string, object> d)
        {
            if (d.TryGetValue("instanceId", out var id)) info.InstanceId = id?.ToString() ?? info.InstanceId;
            if (d.TryGetValue("version", out var v)) info.Version = v?.ToString() ?? info.Version;
        }
        return info;
    }

    private class SystemInfo
    {
        public string InstanceId { get; set; } = "";
        public string Version { get; set; } = "";
        public string BuildDate { get; set; } = "";
        public string Uptime { get; set; } = "";
        public string StartTime { get; set; } = "";
        public string Hostname { get; set; } = "";
        public string OperatingSystem { get; set; } = "";
        public string DotNetVersion { get; set; } = "";
        public int ProcessorCount { get; set; }
        public long TotalMemory { get; set; }
        public long MemoryUsed { get; set; }
        public long TotalRequests { get; set; }
        public int ActiveConnections { get; set; }
        public int LoadedPlugins { get; set; }
        public List<BackendInfo> Backends { get; set; } = new();
    }

    private class BackendInfo { public string Name { get; set; } = ""; public string Type { get; set; } = ""; public string Status { get; set; } = ""; public long Capacity { get; set; } public long Used { get; set; } }
}
