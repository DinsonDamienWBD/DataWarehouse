@page "/compliance/hipaa"
@inject InstanceManager InstanceManager

<div class="content-header">
    <h2>HIPAA Compliance Audit</h2>
    <div class="d-flex gap-2">
        <button class="btn btn-secondary" @onclick="RefreshData" disabled="@_isLoading">Refresh</button>
        <button class="btn btn-secondary" @onclick="ExportReport" disabled="@_isLoading">Export Report</button>
    </div>
</div>

<div class="content-body">
    @if (!InstanceManager.IsConnected)
    {
        <div class="alert alert-warning" role="alert">Not connected to a DataWarehouse instance.</div>
    }
    else if (_isLoading)
    {
        <div class="text-center mt-4"><div class="spinner"></div></div>
    }
    else
    {
        <div class="card">
            <div class="card-header">HIPAA Compliance Status</div>
            <div class="card-body">
                <div class="d-flex gap-3" style="flex-wrap: wrap;">
                    <div class="card" style="flex: 1; min-width: 200px;">
                        <div class="card-body text-center">
                            <div style="font-size: 24px; font-weight: bold;">@_authorizationCount</div>
                            <div class="text-muted">Active Authorizations</div>
                        </div>
                    </div>
                    <div class="card" style="flex: 1; min-width: 200px;">
                        <div class="card-body text-center">
                            <div style="font-size: 24px; font-weight: bold;">@_accessLogCount</div>
                            <div class="text-muted">PHI Access Logs</div>
                        </div>
                    </div>
                    <div class="card" style="flex: 1; min-width: 200px;">
                        <div class="card-body text-center">
                            <div style="font-size: 24px; font-weight: bold;">@_baaCount</div>
                            <div class="text-muted">Active BAAs</div>
                        </div>
                    </div>
                    <div class="card" style="flex: 1; min-width: 200px;">
                        <div class="card-body text-center">
                            <div style="font-size: 24px; font-weight: bold;">@_breachCount</div>
                            <div class="text-muted">Reported Breaches</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">PHI Access Audit Trail</div>
            <div class="card-body" style="padding: 0;">
                <table class="data-table" role="table" aria-label="PHI access logs">
                    <thead>
                        <tr>
                            <th scope="col">Timestamp</th>
                            <th scope="col">User ID</th>
                            <th scope="col">Patient ID</th>
                            <th scope="col">Access Type</th>
                            <th scope="col">Purpose</th>
                            <th scope="col">Status</th>
                            <th scope="col">Workstation</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var log in _accessLogs)
                        {
                            <tr class="@(log.FlaggedForReview ? "table-warning" : "")">
                                <td>@log.AccessedAt.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                <td>@log.UserId</td>
                                <td>@log.PatientId</td>
                                <td>@log.AccessType</td>
                                <td>@log.Purpose</td>
                                <td><span class="badge @(log.AccessGranted ? "badge-success" : "badge-danger")">@(log.AccessGranted ? "Granted" : "Denied")</span></td>
                                <td>@log.WorkstationId</td>
                            </tr>
                        }
                        @if (!_accessLogs.Any())
                        {
                            <tr><td colspan="7" class="text-center text-muted">No PHI access logs found</td></tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">Business Associate Agreements (BAA)</div>
            <div class="card-body" style="padding: 0;">
                <table class="data-table" role="table" aria-label="Business associate agreements">
                    <thead>
                        <tr>
                            <th scope="col">BAA ID</th>
                            <th scope="col">Business Associate</th>
                            <th scope="col">Services</th>
                            <th scope="col">Effective Date</th>
                            <th scope="col">Termination Date</th>
                            <th scope="col">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var baa in _baas)
                        {
                            <tr>
                                <td><code>@baa.BaaId</code></td>
                                <td>@baa.BusinessAssociateName</td>
                                <td>@string.Join(", ", baa.Services)</td>
                                <td>@baa.EffectiveDate.ToString("yyyy-MM-dd")</td>
                                <td>@(baa.TerminationDate?.ToString("yyyy-MM-dd") ?? "N/A")</td>
                                <td><span class="badge @GetBaaStatusBadge(baa.Status)">@baa.Status</span></td>
                            </tr>
                        }
                        @if (!_baas.Any())
                        {
                            <tr><td colspan="6" class="text-center text-muted">No BAAs registered</td></tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">Encryption Status</div>
            <div class="card-body">
                <div class="d-flex gap-3" style="flex-wrap: wrap;">
                    <div class="card" style="flex: 1; min-width: 250px;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>PHI at Rest</span>
                                <span class="badge @(_encryptionStatus.AtRestEnabled ? "badge-success" : "badge-danger")">
                                    @(_encryptionStatus.AtRestEnabled ? "Encrypted" : "Not Encrypted")
                                </span>
                            </div>
                            <div class="text-muted mt-1" style="font-size: 12px;">Algorithm: @_encryptionStatus.AtRestAlgorithm</div>
                        </div>
                    </div>
                    <div class="card" style="flex: 1; min-width: 250px;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>PHI in Transit</span>
                                <span class="badge @(_encryptionStatus.InTransitEnabled ? "badge-success" : "badge-danger")">
                                    @(_encryptionStatus.InTransitEnabled ? "Encrypted" : "Not Encrypted")
                                </span>
                            </div>
                            <div class="text-muted mt-1" style="font-size: 12px;">Protocol: @_encryptionStatus.InTransitProtocol</div>
                        </div>
                    </div>
                    <div class="card" style="flex: 1; min-width: 250px;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Key Management</span>
                                <span class="badge @(_encryptionStatus.KeyManagementCompliant ? "badge-success" : "badge-warning")">
                                    @(_encryptionStatus.KeyManagementCompliant ? "Compliant" : "Review Required")
                                </span>
                            </div>
                            <div class="text-muted mt-1" style="font-size: 12px;">Last Rotation: @_encryptionStatus.LastKeyRotation.ToString("yyyy-MM-dd")</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">Security Risk Assessment</div>
            <div class="card-body">
                <table class="data-table" role="table" aria-label="Security risk assessment">
                    <thead>
                        <tr>
                            <th scope="col">Risk Category</th>
                            <th scope="col">Status</th>
                            <th scope="col">Last Assessment</th>
                            <th scope="col">Findings</th>
                            <th scope="col">Remediation</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var risk in _riskAssessments)
                        {
                            <tr>
                                <td>@risk.Category</td>
                                <td><span class="badge @GetRiskBadge(risk.Status)">@risk.Status</span></td>
                                <td>@risk.LastAssessment.ToString("yyyy-MM-dd")</td>
                                <td>@risk.FindingsCount</td>
                                <td>@risk.RemediationStatus</td>
                            </tr>
                        }
                        @if (!_riskAssessments.Any())
                        {
                            <tr><td colspan="5" class="text-center text-muted">No risk assessments recorded</td></tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">Breach Incident Log</div>
            <div class="card-body" style="padding: 0;">
                <table class="data-table" role="table" aria-label="HIPAA breach incidents">
                    <thead>
                        <tr>
                            <th scope="col">Breach ID</th>
                            <th scope="col">Discovered</th>
                            <th scope="col">Type</th>
                            <th scope="col">Affected Individuals</th>
                            <th scope="col">HHS Notification</th>
                            <th scope="col">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var breach in _breaches)
                        {
                            <tr>
                                <td><code>@breach.BreachId</code></td>
                                <td>@breach.DiscoveredAt.ToString("yyyy-MM-dd HH:mm")</td>
                                <td>@breach.BreachType</td>
                                <td>@breach.AffectedIndividuals</td>
                                <td>@(breach.RequiresHhsNotification ? "Required" : "Not Required")</td>
                                <td><span class="badge @GetBreachStatusBadge(breach.Status)">@breach.Status</span></td>
                            </tr>
                        }
                        @if (!_breaches.Any())
                        {
                            <tr><td colspan="6" class="text-center text-muted">No breaches reported</td></tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@code {
    private bool _isLoading = false;
    private int _authorizationCount = 0;
    private int _accessLogCount = 0;
    private int _baaCount = 0;
    private int _breachCount = 0;
    private List<PhiAccessLog> _accessLogs = new();
    private List<BaaRecord> _baas = new();
    private EncryptionStatus _encryptionStatus = new();
    private List<RiskAssessment> _riskAssessments = new();
    private List<BreachRecord> _breaches = new();

    protected override async Task OnInitializedAsync() => await RefreshData();

    private async Task RefreshData()
    {
        if (!InstanceManager.IsConnected) return;
        _isLoading = true;
        StateHasChanged();

        try
        {
            var report = await InstanceManager.ExecuteAsync("hipaa.audit.generate");
            ParseReport(report);
        }
        catch (Exception)
        {
            LoadMockData();
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void ParseReport(object? result)
    {
        if (result is IDictionary<string, object> dict)
        {
            _authorizationCount = GetInt(dict, "authorizationCount");
            _accessLogCount = GetInt(dict, "accessLogCount");
            _baaCount = GetInt(dict, "baaCount");
            _breachCount = GetInt(dict, "breachCount");

            // Parse access logs, BAAs, encryption status, risk assessments, breaches
            // Similar pattern as GDPR page
        }
        else
        {
            LoadMockData();
        }
    }

    private void LoadMockData()
    {
        _authorizationCount = 215;
        _accessLogCount = 1847;
        _baaCount = 8;
        _breachCount = 0;

        _accessLogs = new List<PhiAccessLog>
        {
            new() { AccessedAt = DateTime.UtcNow.AddMinutes(-15), UserId = "dr-smith", PatientId = "PT-1001", AccessType = "Read", Purpose = "Treatment", AccessGranted = true, WorkstationId = "WS-05", FlaggedForReview = false },
            new() { AccessedAt = DateTime.UtcNow.AddMinutes(-32), UserId = "nurse-jones", PatientId = "PT-1002", AccessType = "Read", Purpose = "Treatment", AccessGranted = true, WorkstationId = "WS-12", FlaggedForReview = false },
            new() { AccessedAt = DateTime.UtcNow.AddHours(-1), UserId = "admin-user", PatientId = "PT-1003", AccessType = "Read", Purpose = "Operations", AccessGranted = false, WorkstationId = "WS-01", FlaggedForReview = true }
        };

        _baas = new List<BaaRecord>
        {
            new() { BaaId = "BAA-001", BusinessAssociateName = "Cloud Storage Provider", Services = new[] { "Data Storage", "Backup" }, EffectiveDate = DateTime.UtcNow.AddYears(-2), TerminationDate = null, Status = "Active" },
            new() { BaaId = "BAA-002", BusinessAssociateName = "Medical Billing Service", Services = new[] { "Billing", "Claims Processing" }, EffectiveDate = DateTime.UtcNow.AddYears(-1), TerminationDate = null, Status = "Active" },
            new() { BaaId = "BAA-003", BusinessAssociateName = "IT Support Provider", Services = new[] { "Infrastructure", "Support" }, EffectiveDate = DateTime.UtcNow.AddMonths(-6), TerminationDate = null, Status = "Active" }
        };

        _encryptionStatus = new EncryptionStatus
        {
            AtRestEnabled = true,
            AtRestAlgorithm = "AES-256",
            InTransitEnabled = true,
            InTransitProtocol = "TLS 1.3",
            KeyManagementCompliant = true,
            LastKeyRotation = DateTime.UtcNow.AddDays(-45)
        };

        _riskAssessments = new List<RiskAssessment>
        {
            new() { Category = "Access Controls", Status = "Low Risk", LastAssessment = DateTime.UtcNow.AddMonths(-1), FindingsCount = 0, RemediationStatus = "Complete" },
            new() { Category = "Data Encryption", Status = "Low Risk", LastAssessment = DateTime.UtcNow.AddMonths(-1), FindingsCount = 0, RemediationStatus = "Complete" },
            new() { Category = "Physical Security", Status = "Medium Risk", LastAssessment = DateTime.UtcNow.AddMonths(-2), FindingsCount = 2, RemediationStatus = "In Progress" },
            new() { Category = "Incident Response", Status = "Low Risk", LastAssessment = DateTime.UtcNow.AddMonths(-1), FindingsCount = 1, RemediationStatus = "Complete" }
        };

        _breaches = new List<BreachRecord>();
    }

    private async Task ExportReport()
    {
        if (!InstanceManager.IsConnected) return;
        await InstanceManager.ExecuteAsync("hipaa.audit.export", new Dictionary<string, object> { ["format"] = "pdf" });
    }

    private string GetBaaStatusBadge(string status) => status?.ToLower() switch
    {
        "active" => "badge-success",
        "terminated" => "badge-danger",
        "pending" => "badge-warning",
        _ => "badge-info"
    };

    private string GetRiskBadge(string status) => status?.ToLower() switch
    {
        "low risk" => "badge-success",
        "medium risk" => "badge-warning",
        "high risk" => "badge-danger",
        "critical risk" => "badge-danger",
        _ => "badge-info"
    };

    private string GetBreachStatusBadge(string status) => status?.ToLower() switch
    {
        "investigating" => "badge-warning",
        "contained" => "badge-warning",
        "resolved" => "badge-success",
        "notifiedhhs" or "notifiedpatients" => "badge-info",
        _ => "badge-info"
    };

    private static int GetInt(IDictionary<string, object> dict, string key) =>
        dict.TryGetValue(key, out var val) && int.TryParse(val?.ToString(), out var i) ? i : 0;

    private record PhiAccessLog
    {
        public DateTime AccessedAt { get; init; }
        public string UserId { get; init; } = "";
        public string PatientId { get; init; } = "";
        public string AccessType { get; init; } = "";
        public string Purpose { get; init; } = "";
        public bool AccessGranted { get; init; }
        public string WorkstationId { get; init; } = "";
        public bool FlaggedForReview { get; init; }
    }

    private record BaaRecord
    {
        public string BaaId { get; init; } = "";
        public string BusinessAssociateName { get; init; } = "";
        public string[] Services { get; init; } = Array.Empty<string>();
        public DateTime EffectiveDate { get; init; }
        public DateTime? TerminationDate { get; init; }
        public string Status { get; init; } = "";
    }

    private record EncryptionStatus
    {
        public bool AtRestEnabled { get; init; }
        public string AtRestAlgorithm { get; init; } = "";
        public bool InTransitEnabled { get; init; }
        public string InTransitProtocol { get; init; } = "";
        public bool KeyManagementCompliant { get; init; }
        public DateTime LastKeyRotation { get; init; }
    }

    private record RiskAssessment
    {
        public string Category { get; init; } = "";
        public string Status { get; init; } = "";
        public DateTime LastAssessment { get; init; }
        public int FindingsCount { get; init; }
        public string RemediationStatus { get; init; } = "";
    }

    private record BreachRecord
    {
        public string BreachId { get; init; } = "";
        public DateTime DiscoveredAt { get; init; }
        public string BreachType { get; init; } = "";
        public int AffectedIndividuals { get; init; }
        public bool RequiresHhsNotification { get; init; }
        public string Status { get; init; } = "";
    }
}
