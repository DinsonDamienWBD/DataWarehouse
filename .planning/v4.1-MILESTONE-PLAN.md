# v4.1 Milestone: Production Readiness Fixes + Verification Cycle

## Philosophy

Iterative fix-then-verify cycle:
1. **v4.x** = Fix & implement (P0, P1, Cloud SDK, Test Coverage, Identity Delegation)
2. **v4.0 re-run** = Re-verify using same audit framework (Phases 42-51)
3. Repeat until v4.0 verification returns **100% production readiness** across ALL criteria

## Scope (v4.1 Implementation)

### Wave 1: P0 Critical (33-53h) — MUST complete first

#### 1A. Identity Delegation Framework (NEW — Security Architecture)
**The Problem:** Commands, messages, and AI requests carry NO user identity. When AI agents execute actions, they use their own (system-level) privileges instead of the delegating user's permissions.

**The Fix:** Typed `CommandIdentity` object that auto-populates:
- `ActorId` (read-only) — Who is physically executing (CLI user, AI agent, system service)
- `OnBehalfOfUserId` (read-only) — Whose permissions to check (the human user)
- `TenantId` (read-only) — Tenant context
- `Roles` (read-only) — Resolved from `OnBehalfOfUserId`, NOT from `ActorId`
- `AuthenticationMethod` — How identity was established (token, certificate, API key)
- `DelegationChain` — Audit trail: User → Gemini → Claude → Command

**Enforcement Rule:** Access control ALWAYS evaluates `OnBehalfOfUserId` permissions, NEVER `ActorId` permissions. The `ActorId` is for audit logging only.

**Changes Required:**
1. SDK: Add `CommandIdentity` record (immutable, read-only after construction)
2. SDK: Add `CommandIdentity` to `ISecurityContext` (extend, not replace)
3. SDK: Add `CommandIdentity` to message bus envelope (all messages carry identity)
4. Shared: Add `CommandIdentity` to `CommandContext`
5. CLI: Construct `CommandIdentity` from `--auth-token` at startup
6. GUI: Construct `CommandIdentity` from JWT/session at login
7. Intelligence: Add `CommandIdentity` to `IntelligenceRequest` and `AgentContext`
8. Intelligence: When AI executes actions, propagate the *user's* `CommandIdentity`, not the AI's
9. AccessControl: Update `AccessContext` to use `OnBehalfOfUserId` for all permission checks
10. AccessControl: Add `DelegationChain` to audit trail
11. All plugins: Update message bus handlers to extract and forward `CommandIdentity`

**Estimated effort:** 40-60h (architectural, touches SDK + all consumers)

#### 1B. Existing P0 Security Fixes (21-35h)
- TLS certificate validation: Enable in 15 files (configurable `VerifySsl`, default true)
- XXE: Set `DtdProcessing.Prohibit` in 2 files
- Launcher API auth: Add API key or JWT middleware
- Password hashing: Replace SHA256 with Argon2id/PBKDF2
- Default admin password: Remove "admin" fallback

#### 1C. P0 Quality Fixes (12-18h)
- 15 dispose method sync-over-async (proven pattern from Phase 43-04)
- Decompression algorithm selection bug
- PNG compression uses HMAC-SHA256 instead of DEFLATE

### Wave 2: P1 High Priority (460-700h)

#### 2A. Async Cleanup (98-126h)
- Remaining 60 `GetAwaiter().GetResult()` occurrences
- Timer callback async conversions
- Property getter deadlock prevention

#### 2B. Security Hardening (50-80h)
- Rate limiting on all public APIs
- mTLS enforcement for inter-node communication
- Secure file deletion (cryptographic erasure)
- ABAC regex timeout hardening
- Null! suppression cleanup (75 occurrences)

#### 2C. Domain-Specific P1 Fixes (65 items, ~200h)
- RAID scrubbing implementation (replace no-ops)
- HSM crypto operations (PKCS#11)
- Multi-Raft coordinator (extend from single-group)
- Auto-scaler implementation (beyond InMemoryAutoScaler)
- Transcoding: Real FFmpeg integration or clear "requires FFmpeg" pattern
- WASM: Embedded runtime option (not just CLI tools)

### Wave 3: Cloud SDK Integration (60-90h)

- Add AWS SDK NuGet packages (S3, EC2, Lambda, RDS, DynamoDB)
- Add Azure SDK NuGet packages (Blob, VMs, Functions, SQL, Cosmos)
- Add GCP SDK NuGet packages (Cloud Storage, Compute, Functions, Cloud SQL, Firestore)
- Replace stub implementations with real cloud API calls
- Credential loading (env vars, config files, IMDS)
- Error handling (invalid credentials, rate limits, region failover)

### Wave 4: Test Coverage (200-400h)

- Create test projects for 50 untested plugins
- Priority: 7 critical plugins first (DataProtection, DatabaseStorage, DataManagement, DataPrivacy, DataGovernance, DataIntegrity, Blockchain)
- Integration tests for cross-plugin flows (write pipeline, RAID rebuild, cluster formation)
- Edge case tests (circuit breaker, timeout, OOM, disk full)
- Cross-platform tests (Windows + Linux CI matrix)
- Target: 70% line coverage (from 2.4%)

## Verification Cycle

After v4.1 implementation completes, re-run v4.0 verification:

### Cycle 1: v4.1 → v4.0 Re-verify
- Re-run Phase 43 (automated scan) — expect P0 count = 0
- Re-run Phase 44 (domain audit) — spot-check fixed domains
- Re-run Phase 45 (tier verification) — expect all 7 tiers PASS
- Re-run Phase 47 (security audit) — expect identity delegation verified
- Re-run Phase 48 (test coverage) — expect 70%+ coverage
- Issue new certification: expect CERTIFIED (no conditions)

### Cycle 2+ (if needed): v4.2 → v4.0 Re-verify
- Fix any remaining findings from Cycle 1
- Re-verify
- Repeat until 100% production readiness

## Success Criteria (v4.1 complete)

- [ ] `CommandIdentity` propagated end-to-end (CLI → bus → plugin → AI → back)
- [ ] AI delegation CANNOT escalate privileges (verified with test cases)
- [ ] 0 P0 findings remaining
- [ ] 0 P1 security findings remaining
- [ ] Cloud SDK integration functional (AWS S3 upload, Azure Blob upload, GCS upload)
- [ ] Test coverage >= 70%
- [ ] Build: 0 errors, 0 warnings
- [ ] All tests pass
- [ ] v4.0 re-verification returns CERTIFIED (no conditions)

## Phase Structure

| Phase | Name | Plans | Depends On |
|-------|------|-------|------------|
| 52 | Identity Delegation Framework | 5 | — |
| 53 | P0 Security + Quality Fixes | 3 | — |
| 54 | P1 Async Cleanup + Security Hardening | 4 | Phase 53 |
| 55 | P1 Domain-Specific Fixes | 5 | Phase 53 |
| 56 | Cloud SDK Integration | 3 | Phase 52 |
| 57 | Test Coverage Expansion | 5 | Phase 53 |
| 58 | v4.0 Re-verification Cycle | 5 | ALL prior |

## Effort Summary

| Wave | Effort | Priority |
|------|--------|----------|
| Wave 1: P0 + Identity | 73-113h | Week 1-3 |
| Wave 2: P1 fixes | 348-406h | Week 4-12 |
| Wave 3: Cloud SDK | 60-90h | Week 4-8 (parallel) |
| Wave 4: Test Coverage | 200-400h | Week 4-16 (parallel) |
| Re-verification | 20-40h | Week 17-18 |
| **Total** | **701-1,049h** | **~18 weeks** |
