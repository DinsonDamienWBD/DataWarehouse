---
phase: 06-interface-layer
plan: 06
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateInterface/Strategies/Messaging/MqttStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateInterface/Strategies/Messaging/AmqpStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateInterface/Strategies/Messaging/StompStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateInterface/Strategies/Messaging/NatsStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateInterface/Strategies/Messaging/KafkaRestStrategy.cs
  - Metadata/TODO.md
autonomous: true

must_haves:
  truths:
    - "5 messaging strategies exist and compile with production-ready broker integration"
    - "MQTT strategy implements publish/subscribe with QoS levels"
    - "AMQP strategy implements exchange/queue routing"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateInterface/Strategies/Messaging/"
      provides: "5 messaging protocol strategy implementations"
  key_links:
    - from: "Strategies/Messaging/*.cs"
      to: "InterfaceStrategyBase"
      via: "class inheritance"
      pattern: "InterfaceStrategyBase"
---

<objective>
Implement 5 messaging protocol strategies (T109.B6)

Purpose: Provide production-ready messaging interface strategies for integrating with message brokers via MQTT, AMQP, STOMP, NATS, and Kafka REST proxy.

Output: 5 strategy files in Strategies/Messaging/ directory, all compiling cleanly.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-interface-layer/06-RESEARCH.md
@.planning/phases/06-interface-layer/06-01-SUMMARY.md
@DataWarehouse.SDK/Contracts/Interface/IInterfaceStrategy.cs
@DataWarehouse.SDK/Contracts/Interface/InterfaceStrategyBase.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement 5 messaging strategies in Strategies/Messaging/ directory</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateInterface/Strategies/Messaging/MqttStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateInterface/Strategies/Messaging/AmqpStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateInterface/Strategies/Messaging/StompStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateInterface/Strategies/Messaging/NatsStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateInterface/Strategies/Messaging/KafkaRestStrategy.cs
  </files>
  <action>
Create 5 messaging strategy files. Each extends InterfaceStrategyBase and implements IPluginInterfaceStrategy.

**MqttStrategy** (StrategyId: "mqtt"):
- Protocol: InterfaceProtocol.MQTT
- HandleRequestAsync: Map InterfaceRequest to MQTT operations:
  - POST to topic path = PUBLISH (QoS 0/1/2 based on header)
  - GET with topic path = SUBSCRIBE (return messages as JSON array)
  - DELETE with topic path = UNSUBSCRIBE
- Implement MQTT 5.0 features: user properties, message expiry, topic aliases, shared subscriptions
- Support QoS levels: 0 (at most once), 1 (at least once), 2 (exactly once)
- Support retained messages and last will testament
- Track client sessions for persistent subscriptions
- Route received messages to DataWarehouse via internal message bus

**AmqpStrategy** (StrategyId: "amqp"):
- Protocol: InterfaceProtocol.AMQP
- HandleRequestAsync: Map to AMQP operations:
  - POST = publish message to exchange with routing key
  - GET = consume from queue (basic.get or basic.consume)
  - PUT = declare exchange/queue/binding
  - DELETE = delete exchange/queue
- Support exchange types: direct, topic, fanout, headers
- Support message properties: content-type, correlation-id, reply-to, expiration, priority
- Implement dead letter exchange routing for failed messages
- Support message acknowledgement (ack/nack/reject)

**StompStrategy** (StrategyId: "stomp"):
- Protocol: InterfaceProtocol.Custom (STOMP)
- HandleRequestAsync: Map to STOMP frames:
  - CONNECT/STOMP frame for connection
  - SEND frame for publishing
  - SUBSCRIBE/UNSUBSCRIBE for subscriptions
  - ACK/NACK for message acknowledgement
- Implement STOMP 1.2 protocol: heart-beating, receipt confirmations
- Support transaction support (BEGIN, COMMIT, ABORT)
- Content negotiation via content-type header in STOMP frame

**NatsStrategy** (StrategyId: "nats"):
- Protocol: InterfaceProtocol.NATS
- HandleRequestAsync: Map to NATS operations:
  - POST = publish to subject
  - GET = subscribe to subject (return messages)
  - PUT = request/reply pattern (publish with reply subject, wait for response)
- Support NATS JetStream for durable subscriptions and message replay
- Support queue groups for load balancing
- Support subject wildcards (* and >)
- Implement request/reply with timeout

**KafkaRestStrategy** (StrategyId: "kafka-rest"):
- Protocol: InterfaceProtocol.Kafka
- HandleRequestAsync: Implement Confluent REST Proxy API patterns:
  - POST /topics/{topic} = produce messages (support key, value, partition)
  - POST /consumers/{group} = create consumer instance
  - GET /consumers/{group}/instances/{id}/records = consume records
  - POST /consumers/{group}/instances/{id}/offsets = commit offsets
- Support Avro, JSON Schema, and Protobuf serialization via schema registry
- Support consumer groups and partition assignment
- Return record metadata: offset, partition, timestamp

All strategies use internal message bus for DataWarehouse integration, handle broker disconnection gracefully, include XML docs.
  </action>
  <verify>
`dotnet build Plugins/DataWarehouse.Plugins.UltimateInterface/DataWarehouse.Plugins.UltimateInterface.csproj` -- zero errors.
Verify 5 .cs files exist in Strategies/Messaging/.
  </verify>
  <done>5 messaging strategies implemented with broker protocol semantics, QoS support, and message routing.</done>
</task>

<task type="auto">
  <name>Task 2: Mark T109.B6 complete in TODO.md</name>
  <files>Metadata/TODO.md</files>
  <action>Find lines `| 109.B6.1 |` through `| 109.B6.5 |` and change `[ ]` to `[x]`.</action>
  <verify>Grep TODO.md for `109.B6` -- all 5 should show `[x]`.</verify>
  <done>T109.B6.1-B6.5 marked [x] in TODO.md.</done>
</task>

</tasks>

<verification>
- `dotnet build` passes with zero errors
- 5 messaging strategy files exist and extend InterfaceStrategyBase
- T109.B6.1-B6.5 marked [x]
</verification>

<success_criteria>
5 messaging strategies are production-ready with correct broker protocol semantics and QoS support.
</success_criteria>

<output>
After completion, create `.planning/phases/06-interface-layer/06-06-SUMMARY.md`
</output>
