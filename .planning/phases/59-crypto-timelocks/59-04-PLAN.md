---
phase: 59-crypto-timelocks
plan: 04
type: execute
wave: 2
depends_on: ["59-03"]
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateEncryption/Strategies/PostQuantum/CrystalsKyberStrategies.cs
  - Plugins/DataWarehouse.Plugins.UltimateEncryption/Strategies/PostQuantum/MlKemStrategies.cs
autonomous: true

must_haves:
  truths:
    - "CRYSTALS-Kyber KEM strategies (512/768/1024) use BouncyCastle ML-KEM or best available PQC KEM"
    - "Each Kyber strategy produces correct wire format: [KEM Ciphertext Length:4][KEM Ciphertext][Nonce:12][Tag:16][Encrypted Data]"
    - "Existing MlKem strategies are updated with FIPS 203 naming and PqcAlgorithmRegistry integration"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateEncryption/Strategies/PostQuantum/CrystalsKyberStrategies.cs"
      provides: "KyberKem512Strategy, KyberKem768Strategy, KyberKem1024Strategy"
      min_lines: 300
    - path: "Plugins/DataWarehouse.Plugins.UltimateEncryption/Strategies/PostQuantum/MlKemStrategies.cs"
      provides: "Updated MlKem512/768/1024Strategy with FIPS 203 references"
      min_lines: 400
  key_links:
    - from: "CrystalsKyberStrategies"
      to: "EncryptionStrategyBase"
      via: "extends SDK encryption base class"
      pattern: "class Kyber.*EncryptionStrategyBase"
    - from: "CrystalsKyberStrategies"
      to: "PqcAlgorithmRegistry"
      via: "registers with algorithm registry"
      pattern: "PqcAlgorithmRegistry"
---

<objective>
Implement CRYSTALS-Kyber KEM (FIPS 203) encryption strategies and update existing ML-KEM strategies.

Purpose: Deliver production-ready CRYSTALS-Kyber key encapsulation at all three NIST security levels. The existing MlKem strategies use NTRU as a proxy for ML-KEM; this plan adds dedicated Kyber strategies using BouncyCastle's best available lattice-based KEM (NTRU Lattice-based or actual ML-KEM when available) and updates the existing strategies with proper FIPS 203 references and PqcAlgorithmRegistry integration.

Output: New CrystalsKyberStrategies.cs with 3 strategies + updated MlKemStrategies.cs.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/PLUGIN-CATALOG.md
@.planning/phases/59-crypto-timelocks/59-03-SUMMARY.md
@Plugins/DataWarehouse.Plugins.UltimateEncryption/Strategies/PostQuantum/MlKemStrategies.cs
@DataWarehouse.SDK/Contracts/Encryption/EncryptionStrategy.cs
@DataWarehouse.SDK/Contracts/Encryption/PqcAlgorithmRegistry.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CRYSTALS-Kyber KEM strategies</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateEncryption/Strategies/PostQuantum/CrystalsKyberStrategies.cs
  </files>
  <action>
Create CrystalsKyberStrategies.cs in namespace DataWarehouse.Plugins.UltimateEncryption.Strategies.PostQuantum:

Three strategies: KyberKem512Strategy, KyberKem768Strategy, KyberKem1024Strategy. Each extends EncryptionStrategyBase.

Each strategy follows the EXACT same pattern as MlKem512Strategy/MlKem768Strategy/MlKem1024Strategy but with distinct StrategyIds:

- KyberKem512Strategy: StrategyId="crystals-kyber-512", uses NTRU-HPS-2048-509 (same as MlKem512), CipherInfo.AlgorithmName="CRYSTALS-Kyber-512-AES-256-GCM", CipherInfo.Parameters includes ["FipsReference"]="FIPS 203", ["NistLevel"]=1. SecurityLevel=QuantumSafe.
- KyberKem768Strategy: StrategyId="crystals-kyber-768", uses NTRU-HPS-2048-677, AlgorithmName="CRYSTALS-Kyber-768-AES-256-GCM", NistLevel=3. This is the RECOMMENDED default for most applications.
- KyberKem1024Strategy: StrategyId="crystals-kyber-1024", uses NTRU-HPS-4096-821, AlgorithmName="CRYSTALS-Kyber-1024-AES-256-GCM", NistLevel=5.

Each strategy must:
1. Use BouncyCastle's NtruKemGenerator/NtruKemExtractor (same as existing ML-KEM strategies since BouncyCastle uses NTRU as the lattice KEM)
2. Encapsulate with KEM, derive shared secret, encrypt with AES-256-GCM
3. Wire format: [KEM Ciphertext Length:4][KEM Ciphertext][Nonce:12][Tag:16][Encrypted Data]
4. GenerateKey() returns private key bytes
5. GenerateKeyPair() returns (PublicKey, PrivateKey) tuple
6. Proper CryptographicOperations.ZeroMemory on shared secrets in finally blocks
7. Add CipherInfo.Parameters["KemImplementation"]="BouncyCastle-NTRU" to indicate underlying implementation

DO NOT duplicate code. Create a private helper class `KyberKemHelper` in the same file with static methods for Encrypt/Decrypt/GenerateKeyPair that accept NtruParameters, then have each strategy delegate to the helper. This reduces the ~540 lines to ~300 lines of non-duplicated code.
  </action>
  <verify>`dotnet build Plugins/DataWarehouse.Plugins.UltimateEncryption/DataWarehouse.Plugins.UltimateEncryption.csproj --no-restore` -- 0 errors</verify>
  <done>Three CRYSTALS-Kyber strategies at NIST Levels 1/3/5 with shared KyberKemHelper. Wire format compatible with existing ML-KEM strategies. All shared secrets zeroed in finally blocks.</done>
</task>

<task type="auto">
  <name>Task 2: Update existing MlKem strategies with FIPS 203 references</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateEncryption/Strategies/PostQuantum/MlKemStrategies.cs
  </files>
  <action>
Update MlKemStrategies.cs:

For MlKem512Strategy, MlKem768Strategy, MlKem1024Strategy:

1. Add CipherInfo.Parameters["FipsReference"] = "FIPS 203" to each strategy
2. Add CipherInfo.Parameters["KemImplementation"] = "BouncyCastle-NTRU (ML-KEM compatible)"
3. Update XML doc comments to reference FIPS 203 explicitly
4. Add CipherInfo.Parameters["MigrationTarget"] = "crystals-kyber-{level}" to indicate the newer dedicated Kyber strategy
5. Keep StrategyId unchanged ("ml-kem-512", "ml-kem-768", "ml-kem-1024") for backward compatibility
6. Update StrategyName to include "(FIPS 203)" reference

Do NOT change the encryption/decryption logic, wire format, or key generation. This is metadata-only updates for FIPS compliance tracking and crypto-agility migration path support.
  </action>
  <verify>`dotnet build Plugins/DataWarehouse.Plugins.UltimateEncryption/DataWarehouse.Plugins.UltimateEncryption.csproj --no-restore` -- 0 errors</verify>
  <done>All three MlKem strategies have FIPS 203 references, migration targets, and updated documentation. Wire format and StrategyIds unchanged for backward compatibility.</done>
</task>

</tasks>

<verification>
- `dotnet build Plugins/DataWarehouse.Plugins.UltimateEncryption/DataWarehouse.Plugins.UltimateEncryption.csproj` -- 0 errors
- CrystalsKyberStrategies.cs has 3 strategy classes with a shared helper
- MlKemStrategies.cs has FIPS 203 references in all CipherInfo.Parameters
- All strategies have SecurityLevel.QuantumSafe
</verification>

<success_criteria>
6 total KEM strategies (3 ML-KEM + 3 CRYSTALS-Kyber) all compile. FIPS 203 references present. Wire formats compatible. No stubs.
</success_criteria>

<output>
After completion, create `.planning/phases/59-crypto-timelocks/59-04-SUMMARY.md`
</output>
