---
phase: 59-crypto-timelocks
plan: 06
type: execute
wave: 2
depends_on: ["59-03"]
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateEncryption/Strategies/Hybrid/X25519Kyber768Strategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateEncryption/Strategies/Hybrid/HybridStrategies.cs
autonomous: true

must_haves:
  truths:
    - "X25519+Kyber768 hybrid strategy combines classical and PQC key exchange in single operation"
    - "Hybrid mode provides defense-in-depth: secure if either classical OR PQC algorithm remains unbroken"
    - "Existing hybrid strategies updated with FIPS references and PqcAlgorithmRegistry integration"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateEncryption/Strategies/Hybrid/X25519Kyber768Strategy.cs"
      provides: "Dedicated X25519+Kyber768 hybrid with HKDF secret combination"
      min_lines: 250
    - path: "Plugins/DataWarehouse.Plugins.UltimateEncryption/Strategies/Hybrid/HybridStrategies.cs"
      provides: "Updated HybridAesKyberStrategy, HybridChaChaKyberStrategy, HybridX25519KyberStrategy with FIPS refs"
      min_lines: 500
  key_links:
    - from: "X25519Kyber768Strategy"
      to: "EncryptionStrategyBase"
      via: "extends SDK encryption base"
      pattern: "class X25519Kyber768Strategy.*EncryptionStrategyBase"
    - from: "X25519Kyber768Strategy"
      to: "HKDF"
      via: "combines X25519 and Kyber shared secrets via HKDF-SHA256"
      pattern: "HKDF\\.DeriveKey"
---

<objective>
Implement the X25519+Kyber768 hybrid encryption strategy and update existing hybrid strategies.

Purpose: The X25519+Kyber768 hybrid is the recommended default for post-quantum transition. It combines the proven X25519 key exchange with Kyber768 (NIST Level 3) lattice-based KEM, providing defense-in-depth. If either algorithm is broken, the other still protects the data. This matches the TLS 1.3 hybrid approach used by Chrome/Firefox for post-quantum security.

Output: New dedicated X25519+Kyber768 strategy + updated existing hybrid strategies with FIPS metadata.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/PLUGIN-CATALOG.md
@.planning/phases/59-crypto-timelocks/59-03-SUMMARY.md
@Plugins/DataWarehouse.Plugins.UltimateEncryption/Strategies/Hybrid/HybridStrategies.cs
@DataWarehouse.SDK/Contracts/Encryption/EncryptionStrategy.cs
@DataWarehouse.SDK/Contracts/Encryption/PqcAlgorithmRegistry.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dedicated X25519+Kyber768 hybrid strategy</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateEncryption/Strategies/Hybrid/X25519Kyber768Strategy.cs
  </files>
  <action>
Create X25519Kyber768Strategy.cs in namespace DataWarehouse.Plugins.UltimateEncryption.Strategies.Hybrid:

Class `X25519Kyber768Strategy : EncryptionStrategyBase`:

- StrategyId = "hybrid-x25519-kyber768"
- StrategyName = "X25519 + CRYSTALS-Kyber-768 Hybrid (FIPS 203)"
- CipherInfo: AlgorithmName="Hybrid-X25519-Kyber768-AES-256-GCM", KeySizeBits=256, SecurityLevel=QuantumSafe
- Parameters: HybridScheme="X25519 + CRYSTALS-Kyber-768", ClassicalAlgorithm="X25519", PostQuantumAlgorithm="CRYSTALS-Kyber-768 (FIPS 203)", SymmetricCipher="AES-256-GCM", KDF="HKDF-SHA256", TlsCompatible=true

EncryptCoreAsync:
1. Generate ephemeral X25519 key pair (BouncyCastle X25519KeyPairGenerator)
2. X25519 key agreement with recipient public key -> classicalSecret (32 bytes)
3. NTRU-HPS-2048-677 encapsulate -> pqSecret
4. Combine: HKDF.DeriveKey(SHA256, classicalSecret || pqSecret, 32 bytes, salt=empty, info="DataWarehouse.Hybrid.X25519.Kyber768.v1")
5. Encrypt plaintext with AES-256-GCM using derived key
6. Wire format: [X25519 Public Key:32][KEM Ciphertext Length:4][KEM Ciphertext][Nonce:12][Tag:16][Encrypted Data]

DecryptCoreAsync:
1. Extract X25519 public key (first 32 bytes)
2. X25519 key agreement with recipient private key
3. Extract and decapsulate NTRU KEM ciphertext
4. HKDF combine secrets (same info string)
5. Decrypt with AES-256-GCM

Key difference from existing HybridX25519KyberStrategy: This strategy uses a FIXED-LENGTH X25519 public key field (no length prefix, always 32 bytes) for TLS-compatible wire format. The existing strategy writes the full 32 bytes without length prefix too, so this should be wire-compatible. Verify the existing wire format and match it exactly.

CRITICAL: Zero all shared secrets in finally blocks using CryptographicOperations.ZeroMemory. This is not optional.

GenerateKey returns X25519 private key (32 bytes). GenerateKeyPair returns (X25519PublicKey, X25519PrivateKey) -- the NTRU key pair is ephemeral and generated per-encryption.

Add a composite key format for decryption that carries both X25519 private key and NTRU private key: [X25519 Private:32][NTRU Private Key:rest]. Document this format in XML comments.
  </action>
  <verify>`dotnet build Plugins/DataWarehouse.Plugins.UltimateEncryption/DataWarehouse.Plugins.UltimateEncryption.csproj --no-restore` -- 0 errors</verify>
  <done>X25519+Kyber768 hybrid strategy implements TLS-compatible wire format, HKDF secret combination, and composite key management. All secrets zeroed.</done>
</task>

<task type="auto">
  <name>Task 2: Update existing hybrid strategies with FIPS metadata</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateEncryption/Strategies/Hybrid/HybridStrategies.cs
  </files>
  <action>
Update HybridStrategies.cs:

For HybridAesKyberStrategy:
1. Add CipherInfo.Parameters["FipsReference"] = "FIPS 203 (PQ component)"
2. Add CipherInfo.Parameters["MigrationTarget"] = "hybrid-x25519-kyber768"
3. Update XML doc to reference FIPS 203

For HybridChaChaKyberStrategy:
1. Add CipherInfo.Parameters["FipsReference"] = "FIPS 203 (PQ component)"
2. Add CipherInfo.Parameters["Advantage"] = "No AES-NI required, ARM/mobile optimized"
3. Update XML doc to reference FIPS 203

For HybridX25519KyberStrategy:
1. Add CipherInfo.Parameters["FipsReference"] = "FIPS 203 (PQ component)"
2. Add CipherInfo.Parameters["TlsCompatible"] = false (this version uses NTRU-677, not standard Kyber768)
3. Add CipherInfo.Parameters["MigrationTarget"] = "hybrid-x25519-kyber768"
4. Update XML doc to distinguish from the new dedicated X25519+Kyber768 strategy

Do NOT change encryption/decryption logic, wire formats, or StrategyIds. Metadata-only changes.
  </action>
  <verify>`dotnet build Plugins/DataWarehouse.Plugins.UltimateEncryption/DataWarehouse.Plugins.UltimateEncryption.csproj --no-restore` -- 0 errors</verify>
  <done>All 3 existing hybrid strategies have FIPS 203 references and migration targets pointing to the new X25519+Kyber768 strategy. Wire formats unchanged.</done>
</task>

</tasks>

<verification>
- `dotnet build Plugins/DataWarehouse.Plugins.UltimateEncryption/DataWarehouse.Plugins.UltimateEncryption.csproj` -- 0 errors
- X25519Kyber768Strategy has TLS-compatible wire format
- All hybrid strategies reference FIPS 203
- 4 total hybrid strategies (3 existing + 1 new)
</verification>

<success_criteria>
New X25519+Kyber768 strategy compiles and uses HKDF for secret combination. Existing hybrids have FIPS metadata. No stubs.
</success_criteria>

<output>
After completion, create `.planning/phases/59-crypto-timelocks/59-06-SUMMARY.md`
</output>
