---
phase: 59-crypto-timelocks
plan: 08
type: execute
wave: 3
depends_on: ["59-01", "59-02"]
files_modified:
  - Plugins/DataWarehouse.Plugins.TamperProof/TimeLock/HsmTimeLockProvider.cs
  - Plugins/DataWarehouse.Plugins.TamperProof/TimeLock/CloudTimeLockProvider.cs
  - Plugins/DataWarehouse.Plugins.TamperProof/TimeLock/RansomwareVaccinationService.cs
autonomous: true

must_haves:
  truths:
    - "HSM time-lock provider uses hardware security module concepts for key-release time enforcement"
    - "Cloud time-lock provider leverages S3 Object Lock / Azure Immutable Blob temporal retention"
    - "Ransomware vaccination service coordinates time-locks, integrity checks, PQC signatures, and blockchain anchoring"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.TamperProof/TimeLock/HsmTimeLockProvider.cs"
      provides: "HsmTimeLockProvider with HSM-backed time-release key management"
      min_lines: 200
    - path: "Plugins/DataWarehouse.Plugins.TamperProof/TimeLock/CloudTimeLockProvider.cs"
      provides: "CloudTimeLockProvider with S3/Azure temporal lock support"
      min_lines: 200
    - path: "Plugins/DataWarehouse.Plugins.TamperProof/TimeLock/RansomwareVaccinationService.cs"
      provides: "Orchestrates vaccination across time-lock, integrity, PQC, and blockchain"
      min_lines: 250
  key_links:
    - from: "HsmTimeLockProvider"
      to: "TimeLockProviderPluginBase"
      via: "extends SDK base class"
      pattern: "class HsmTimeLockProvider.*TimeLockProviderPluginBase"
    - from: "CloudTimeLockProvider"
      to: "TimeLockProviderPluginBase"
      via: "extends SDK base class"
      pattern: "class CloudTimeLockProvider.*TimeLockProviderPluginBase"
    - from: "RansomwareVaccinationService"
      to: "ITimeLockProvider"
      via: "coordinates time-lock operations"
      pattern: "ITimeLockProvider"
    - from: "RansomwareVaccinationService"
      to: "timelock.*"
      via: "publishes vaccination events to message bus"
      pattern: "timelock\\.vaccination"
---

<objective>
Implement HSM and cloud time-lock providers plus the ransomware vaccination orchestrator.

Purpose: Deliver the full time-lock provider suite: HSM-backed for hardware-enforced time-release (keys are sealed until a time condition is met), cloud-native for leveraging S3 Object Lock / Azure Immutable Blob temporal retention APIs, and the ransomware vaccination service that orchestrates all protection layers (time-locks + integrity + PQC signatures + blockchain anchoring) into a comprehensive anti-ransomware defense.

Output: Three production-ready classes completing the time-lock subsystem.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/PLUGIN-CATALOG.md
@.planning/phases/59-crypto-timelocks/59-01-SUMMARY.md
@.planning/phases/59-crypto-timelocks/59-02-SUMMARY.md
@DataWarehouse.SDK/Contracts/TamperProof/ITimeLockProvider.cs
@DataWarehouse.SDK/Contracts/TamperProof/TimeLockTypes.cs
@Plugins/DataWarehouse.Plugins.TamperProof/TimeLock/SoftwareTimeLockProvider.cs
@Plugins/DataWarehouse.Plugins.TamperProof/TimeLock/TimeLockPolicyEngine.cs
@Plugins/DataWarehouse.Plugins.TamperProof/Storage/S3WormStorage.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement HSM and Cloud time-lock providers</name>
  <files>
    Plugins/DataWarehouse.Plugins.TamperProof/TimeLock/HsmTimeLockProvider.cs
    Plugins/DataWarehouse.Plugins.TamperProof/TimeLock/CloudTimeLockProvider.cs
  </files>
  <action>
HsmTimeLockProvider.cs in namespace DataWarehouse.Plugins.TamperProof.TimeLock:

Extends TimeLockProviderPluginBase. Id="tamperproof.timelock.hsm", TimeLockMode=HardwareHsm.

Concept: HSM time-lock uses a time-release key scheme. When locking, generate AES-256 key, encrypt the object's decryption key with it, and store the AES key in an "HSM vault" (ConcurrentDictionary<Guid, HsmTimeLockEntry>) with a release timestamp. The key is only released after the timestamp passes.

- `HsmTimeLockEntry` private sealed record: LockId, ObjectId, LockedAt, UnlocksAt, EncryptedKeyMaterial (byte[]), KeyWrappingAlgorithm (string), ContentHash, VaccinationLevel
- LockInternalAsync: Generate random 256-bit key wrapping key, "encrypt" the content hash as proof of lock (use AES-256-GCM to wrap), store entry with release time. In production the HSM would hold the key material; here we use ConcurrentDictionary as the HSM abstraction (Rule 13 compliant because we actually encrypt/wrap keys, not just set a flag).
- AttemptUnlockInternalAsync: Check if current time >= UnlocksAt. If yes, release the key material, zero the copy, remove entry. For EmergencyBreakGlass: release immediately but flag in audit trail.
- ExtendLockInternalAsync: Update UnlocksAt (cannot shorten).
- GetStatusAsync/IsLockedAsync/GetVaccinationInfoAsync: Query ConcurrentDictionary.
- ListLockedObjectsAsync: Enumerate with pagination.

CloudTimeLockProvider.cs in same namespace:

Extends TimeLockProviderPluginBase. Id="tamperproof.timelock.cloud", TimeLockMode=CloudNative.

Concept: Cloud time-lock delegates to cloud provider retention APIs. Uses ConcurrentDictionary to track lock metadata, with the actual enforcement delegated to cloud WORM storage (S3 Object Lock retention, Azure Blob immutability policy).

- `CloudTimeLockEntry` private sealed record: LockId, ObjectId, LockedAt, UnlocksAt, CloudProvider (string), CloudRetentionId (string?), ContentHash, VaccinationLevel
- LockInternalAsync: Create lock entry, publish to bus "storage.retention.set" with retention duration (this allows cloud WORM providers like S3WormStorage to enforce). Store entry.
- AttemptUnlockInternalAsync: For TimeExpiry: check clock. For cloud-enforced locks, also publish "storage.retention.check" to verify cloud still enforces.
- Supports all major cloud patterns: S3 Object Lock (Governance/Compliance mode), Azure Immutable Blob Storage, GCS Retention Policy.

Both providers: production-ready, no stubs, proper key zeroing, XML docs, intelligence socket.
  </action>
  <verify>`dotnet build Plugins/DataWarehouse.Plugins.TamperProof/DataWarehouse.Plugins.TamperProof.csproj --no-restore` -- 0 errors</verify>
  <done>HsmTimeLockProvider implements HSM key-wrapping time-release. CloudTimeLockProvider delegates to cloud retention APIs via message bus. Both extend TimeLockProviderPluginBase.</done>
</task>

<task type="auto">
  <name>Task 2: Implement RansomwareVaccinationService</name>
  <files>
    Plugins/DataWarehouse.Plugins.TamperProof/TimeLock/RansomwareVaccinationService.cs
  </files>
  <action>
RansomwareVaccinationService.cs in namespace DataWarehouse.Plugins.TamperProof.TimeLock:

This is the orchestrator that combines all protection layers into ransomware vaccination.

Constructor: Takes IMessageBus (for cross-plugin coordination).

Public methods:

- `VaccinateAsync(Guid objectId, VaccinationLevel level, TimeLockPolicy policy, CancellationToken ct)`:
  Based on VaccinationLevel:
  - Basic: Apply time-lock only (publish to "timelock.lock" bus topic)
  - Enhanced: Time-lock + integrity hash verification (publish to "integrity.hash.compute" and "timelock.lock")
  - Maximum: Time-lock + integrity + PQC signature (publish to "encryption.sign" with algorithm from PqcAlgorithmRegistry) + blockchain anchor (publish to "blockchain.anchor.create")
  Returns RansomwareVaccinationInfo with all results.

- `VerifyVaccinationAsync(Guid objectId, CancellationToken ct)`:
  1. Check time-lock status (publish to "timelock.status" or query directly)
  2. Verify integrity hash (publish to "integrity.hash.verify")
  3. If PQC-signed: verify signature (publish to "encryption.verify")
  4. If blockchain-anchored: verify anchor (publish to "blockchain.anchor.verify")
  5. Compute threat score: 0.0 = fully protected, 1.0 = fully compromised
  Return RansomwareVaccinationInfo.

- `ScanAllAsync(int batchSize, CancellationToken ct)`:
  Enumerate all time-locked objects, verify each, publish scan results.
  Returns IAsyncEnumerable<RansomwareVaccinationInfo>.

- `GetThreatDashboardAsync(CancellationToken ct)`:
  Return aggregate stats: total vaccinated objects, average threat score, objects with expired locks, objects with failed integrity, objects needing re-vaccination.

Internal: `CalculateThreatScore(bool timeLockActive, bool integrityVerified, bool? pqcSignatureValid, bool? blockchainAnchored)` -- weighted average: timeLock=0.3, integrity=0.3, pqc=0.2, blockchain=0.2. Missing checks (null) are excluded from calculation.

Bus topics published: timelock.vaccination.applied, timelock.vaccination.verified, timelock.vaccination.scan.started, timelock.vaccination.scan.completed, timelock.vaccination.threat.detected

All methods production-ready. No stubs. XML docs on every member.
  </action>
  <verify>`dotnet build Plugins/DataWarehouse.Plugins.TamperProof/DataWarehouse.Plugins.TamperProof.csproj --no-restore` -- 0 errors</verify>
  <done>RansomwareVaccinationService orchestrates 4 protection layers (time-lock, integrity, PQC signatures, blockchain) with threat scoring and batch scanning.</done>
</task>

</tasks>

<verification>
- `dotnet build Plugins/DataWarehouse.Plugins.TamperProof/DataWarehouse.Plugins.TamperProof.csproj` -- 0 errors
- HsmTimeLockProvider uses key-wrapping for time-release
- CloudTimeLockProvider delegates to cloud retention via bus
- RansomwareVaccinationService supports all 3 vaccination levels
- Threat score calculation is weighted average of protection layers
</verification>

<success_criteria>
All 3 time-lock providers (Software from Plan 02 + HSM + Cloud) compile. Vaccination service coordinates all layers. No stubs.
</success_criteria>

<output>
After completion, create `.planning/phases/59-crypto-timelocks/59-08-SUMMARY.md`
</output>
