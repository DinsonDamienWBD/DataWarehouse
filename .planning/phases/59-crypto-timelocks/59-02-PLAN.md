---
phase: 59-crypto-timelocks
plan: 02
type: execute
wave: 2
depends_on: ["59-01"]
files_modified:
  - Plugins/DataWarehouse.Plugins.TamperProof/TimeLock/SoftwareTimeLockProvider.cs
  - Plugins/DataWarehouse.Plugins.TamperProof/TimeLock/TimeLockPolicyEngine.cs
  - Plugins/DataWarehouse.Plugins.TamperProof/TimeLock/TimeLockMessageBusIntegration.cs
autonomous: true

must_haves:
  truths:
    - "Software time-lock provider enforces per-object lock durations using filesystem ACLs and UTC clock"
    - "Policy engine auto-assigns time-lock durations based on configurable rules (data classification, compliance, content type)"
    - "Time-lock events published to message bus for cross-plugin coordination"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.TamperProof/TimeLock/SoftwareTimeLockProvider.cs"
      provides: "SoftwareTimeLockProvider extending TimeLockProviderPluginBase"
      min_lines: 200
    - path: "Plugins/DataWarehouse.Plugins.TamperProof/TimeLock/TimeLockPolicyEngine.cs"
      provides: "Rule-based policy engine for auto-assigning time-lock durations"
      min_lines: 150
    - path: "Plugins/DataWarehouse.Plugins.TamperProof/TimeLock/TimeLockMessageBusIntegration.cs"
      provides: "Message bus topics for time-lock events"
      min_lines: 100
  key_links:
    - from: "SoftwareTimeLockProvider"
      to: "TimeLockProviderPluginBase"
      via: "extends SDK base class"
      pattern: "class SoftwareTimeLockProvider.*TimeLockProviderPluginBase"
    - from: "TimeLockPolicyEngine"
      to: "TimeLockPolicy"
      via: "evaluates rules to produce TimeLockPolicy"
      pattern: "TimeLockPolicy"
    - from: "TimeLockMessageBusIntegration"
      to: "MessageBus"
      via: "publishes timelock.* topics"
      pattern: "timelock\\."
---

<objective>
Implement the software time-lock provider, policy engine, and message bus integration.

Purpose: Deliver the core time-lock functionality. The software provider uses ConcurrentDictionary-based state with UTC clock enforcement (production-ready for single-node). The policy engine evaluates rules to auto-assign lock durations based on data classification, compliance requirements, and content type. Message bus integration publishes lock/unlock/extend events for cross-plugin coordination.

Output: Three production-ready classes in TamperProof/TimeLock/ directory.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/PLUGIN-CATALOG.md
@.planning/phases/59-crypto-timelocks/59-01-SUMMARY.md
@DataWarehouse.SDK/Contracts/TamperProof/ITimeLockProvider.cs
@DataWarehouse.SDK/Contracts/TamperProof/TimeLockTypes.cs
@Plugins/DataWarehouse.Plugins.TamperProof/Services/MessageBusIntegration.cs
@Plugins/DataWarehouse.Plugins.TamperProof/Storage/S3WormStorage.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement SoftwareTimeLockProvider</name>
  <files>
    Plugins/DataWarehouse.Plugins.TamperProof/TimeLock/SoftwareTimeLockProvider.cs
  </files>
  <action>
Create SoftwareTimeLockProvider in namespace DataWarehouse.Plugins.TamperProof.TimeLock:

Extends TimeLockProviderPluginBase. Override all abstract methods:

- `LockInternalAsync`: Generate lock ID (GUID), compute content hash via ComputeHashAsync (delegate to bus `integrity.hash.compute`), store lock metadata in ConcurrentDictionary keyed by objectId. Build TimeLockResult with all fields populated. Store lock state as internal `TimeLockEntry` record (LockId, ObjectId, LockedAt, UnlocksAt, ContentHash, VaccinationLevel, TimeLockMode=Software). Publish lock event to bus.
- `ExtendLockInternalAsync`: Look up entry, update UnlocksAt, publish extend event.
- `AttemptUnlockInternalAsync`: Validate condition type. For TimeExpiry: check if current time >= UnlocksAt. For MultiPartyApproval: check approval count >= required. For EmergencyBreakGlass: always succeed but flag as emergency-unlocked with audit. For NeverUnlock: always return false. Remove entry on success, publish unlock event.
- `GetStatusAsync`: Look up entry, build TimeLockStatus. If not found, return Exists=false status.
- `IsLockedAsync`: Quick check against ConcurrentDictionary.
- `GetVaccinationInfoAsync`: Build RansomwareVaccinationInfo from lock entry + integrity check.
- `ListLockedObjectsAsync`: Enumerate ConcurrentDictionary with Skip/Take.

Internal state: `ConcurrentDictionary<Guid, TimeLockEntry>` where TimeLockEntry is a private sealed record.

Plugin metadata: Id="tamperproof.timelock.software", Name="Software Time-Lock Provider", Version=new Version(5,0,0).

No stubs. Every method must be production-ready. Use `DateTimeOffset.UtcNow` for time comparisons. Use `CryptographicOperations.ZeroMemory` for any sensitive data cleanup.
  </action>
  <verify>`dotnet build Plugins/DataWarehouse.Plugins.TamperProof/DataWarehouse.Plugins.TamperProof.csproj --no-restore` -- 0 errors</verify>
  <done>SoftwareTimeLockProvider implements all 7 ITimeLockProvider operations with ConcurrentDictionary state, UTC clock enforcement, content hashing, and audit events. No stubs.</done>
</task>

<task type="auto">
  <name>Task 2: Implement TimeLockPolicyEngine and message bus integration</name>
  <files>
    Plugins/DataWarehouse.Plugins.TamperProof/TimeLock/TimeLockPolicyEngine.cs
    Plugins/DataWarehouse.Plugins.TamperProof/TimeLock/TimeLockMessageBusIntegration.cs
  </files>
  <action>
TimeLockPolicyEngine in namespace DataWarehouse.Plugins.TamperProof.TimeLock:

- Class with `IReadOnlyList<TimeLockRule> Rules` property
- `TimeLockRule` record: Name (string), Priority (int), DataClassificationPattern (string? regex), ComplianceFrameworks (string[]), ContentTypePatterns (string[]), MinLockDuration (TimeSpan), MaxLockDuration (TimeSpan), DefaultLockDuration (TimeSpan), VaccinationLevel (VaccinationLevel), RequireMultiPartyUnlock (bool)
- `EvaluatePolicy(string? dataClassification, string? complianceFramework, string? contentType)` method: iterate rules by priority descending, match against patterns, return first match as TimeLockPolicy. If no match, return default policy (7 days, Basic vaccination).
- Built-in rules: "HIPAA-PHI" (7 year lock, Enhanced vaccination, multi-party unlock), "PCI-DSS" (1 year lock, Enhanced), "GDPR-Personal" (30 day lock, Basic), "SOX-Financial" (7 year lock, Maximum vaccination), "Classified-Secret" (25 year lock, Maximum, NeverUnlock condition), "Default" (7 day lock, Basic)
- `AddRule`, `RemoveRule`, `GetEffectivePolicy` methods

TimeLockMessageBusIntegration:
- Static class with topic constants: `timelock.locked`, `timelock.unlocked`, `timelock.extended`, `timelock.tamper.detected`, `timelock.vaccination.scan`, `timelock.policy.evaluated`
- `PublishLockEvent(IMessageBus bus, TimeLockResult result)` -- publish to timelock.locked
- `PublishUnlockEvent(IMessageBus bus, Guid objectId, string lockId, UnlockConditionType reason)` -- publish to timelock.unlocked
- `PublishExtendEvent(IMessageBus bus, Guid objectId, TimeSpan newDuration)` -- publish to timelock.extended
- `PublishTamperDetectedEvent(IMessageBus bus, Guid objectId, string details)` -- publish to timelock.tamper.detected
- Follow the same pattern as Plugins/DataWarehouse.Plugins.TamperProof/Services/MessageBusIntegration.cs

Use `IMessageBus` from SDK. All methods async. XML docs on everything.
  </action>
  <verify>`dotnet build Plugins/DataWarehouse.Plugins.TamperProof/DataWarehouse.Plugins.TamperProof.csproj --no-restore` -- 0 errors</verify>
  <done>TimeLockPolicyEngine has 6 built-in compliance rules with pattern matching. TimeLockMessageBusIntegration publishes 6 topic types following existing TamperProof bus patterns.</done>
</task>

</tasks>

<verification>
- Full solution build passes: `dotnet build DataWarehouse.slnx` -- 0 errors
- SoftwareTimeLockProvider extends TimeLockProviderPluginBase
- TimeLockPolicyEngine has at least 6 built-in rules
- Message bus topics follow `timelock.*` pattern
</verification>

<success_criteria>
Time-lock provider handles lock/unlock/extend/status. Policy engine evaluates compliance rules. Bus integration publishes all events. Zero stubs or TODOs.
</success_criteria>

<output>
After completion, create `.planning/phases/59-crypto-timelocks/59-02-SUMMARY.md`
</output>
