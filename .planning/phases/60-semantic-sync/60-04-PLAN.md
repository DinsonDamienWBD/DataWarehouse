---
phase: 60-semantic-sync
plan: 04
type: execute
wave: 2
depends_on: ["60-01", "60-02"]
files_modified:
  - Plugins/DataWarehouse.Plugins.SemanticSync/Strategies/Routing/BandwidthAwareSummaryRouter.cs
  - Plugins/DataWarehouse.Plugins.SemanticSync/Strategies/Routing/SummaryGenerator.cs
  - Plugins/DataWarehouse.Plugins.SemanticSync/Strategies/Routing/FidelityDownsampler.cs
autonomous: true

must_haves:
  truths:
    - "Sync decisions route data as raw, summarized, or metadata-only based on importance and bandwidth"
    - "AI generates meaningful summaries that preserve semantic intent"
    - "Fidelity downsampler reduces data size while maintaining critical fields"
    - "Bandwidth constraints drive automatic fidelity reduction"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.SemanticSync/Strategies/Routing/BandwidthAwareSummaryRouter.cs"
      provides: "Routing decision engine: raw vs summary vs metadata"
      contains: "class BandwidthAwareSummaryRouter : SemanticSyncStrategyBase, ISummaryRouter"
    - path: "Plugins/DataWarehouse.Plugins.SemanticSync/Strategies/Routing/SummaryGenerator.cs"
      provides: "AI-powered data summarization"
      contains: "class SummaryGenerator"
    - path: "Plugins/DataWarehouse.Plugins.SemanticSync/Strategies/Routing/FidelityDownsampler.cs"
      provides: "Progressive fidelity reduction engine"
      contains: "class FidelityDownsampler"
  key_links:
    - from: "BandwidthAwareSummaryRouter"
      to: "SummaryGenerator"
      via: "composition — router uses generator when summary fidelity chosen"
      pattern: "SummaryGenerator.*GenerateSummary"
    - from: "BandwidthAwareSummaryRouter"
      to: "FidelityDownsampler"
      via: "composition — router uses downsampler for intermediate fidelities"
      pattern: "FidelityDownsampler.*Downsample"
---

<objective>
Implement the summary-vs-raw routing engine that decides HOW to sync data based on its semantic importance and available bandwidth.

Purpose: This is the bandwidth optimization core. A Critical data item syncs at Full fidelity even on satellite links. A Negligible item gets metadata-only even on fiber. Between those extremes, the router progressively reduces fidelity: Full -> Detailed -> Standard -> Summarized -> Metadata. The SummaryGenerator creates AI-powered summaries. The FidelityDownsampler strips non-essential fields at each fidelity level.

Output: 3 strategy/helper files in Strategies/Routing/
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/PLUGIN-CATALOG.md
@.planning/phases/60-semantic-sync/60-01-SUMMARY.md
@DataWarehouse.SDK/Contracts/SemanticSync/ISummaryRouter.cs
@DataWarehouse.SDK/Contracts/SemanticSync/SemanticSyncModels.cs
@DataWarehouse.SDK/AI/IAIProvider.cs
@Plugins/DataWarehouse.Plugins.AdaptiveTransport/BandwidthMonitor/BandwidthModels.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Summary Generator and Fidelity Downsampler</name>
  <files>
    Plugins/DataWarehouse.Plugins.SemanticSync/Strategies/Routing/SummaryGenerator.cs
    Plugins/DataWarehouse.Plugins.SemanticSync/Strategies/Routing/FidelityDownsampler.cs
  </files>
  <action>
**SummaryGenerator.cs:**
- Internal class (used by router, not exposed as strategy)
- Constructor takes optional `IAIProvider` — works without it (falls back to extraction)
- `Task<DataSummary> GenerateAsync(string dataId, ReadOnlyMemory<byte> rawData, SyncFidelity targetFidelity, CancellationToken ct)`:
  1. If AI provider available and data is text-based (UTF-8 decodable): use `IAIProvider.CompleteAsync` with a prompt asking for a summary at the target fidelity level. Prompt varies by fidelity: Summarized = "Summarize key facts in 3 sentences", Metadata = "Extract only field names and types"
  2. If AI unavailable or data is binary: use extraction fallback — take first N bytes based on fidelity (Summarized=10%, Metadata=header only up to 256 bytes), plus compute and include an embedding if AI is available
  3. Compute compressionRatio = summary size / raw size
  4. Return DataSummary with all fields populated

- `Task<ReadOnlyMemory<byte>> ReconstructAsync(DataSummary summary, CancellationToken ct)`:
  1. If summary contains embedding and AI available: use AI to expand summary back
  2. Otherwise return summary text as UTF-8 bytes (best effort, lossy reconstruction acknowledged)

**FidelityDownsampler.cs:**
- Internal class for progressive field stripping
- `ReadOnlyMemory<byte> Downsample(ReadOnlyMemory<byte> data, SyncFidelity from, SyncFidelity to, IDictionary<string, string>? metadata)`:
  - Full -> Detailed: Strip audit trail, access logs, version history (look for JSON arrays named "audit", "history", "versions" and remove them; for binary, truncate trailing metadata blocks)
  - Detailed -> Standard: Additionally strip embedded previews, thumbnails, redundant indexes
  - Standard -> Summarized: Delegate to SummaryGenerator
  - Summarized -> Metadata: Keep only top-level keys/types/sizes (for JSON: key names + value types; for binary: header bytes + size)
- Each level targets a size reduction: Detailed ~80%, Standard ~50%, Summarized ~15%, Metadata ~2% of original
- For JSON data: parse with System.Text.Json, remove fields, re-serialize
- For binary data: progressive truncation with header preservation
- Production-ready: handles malformed JSON gracefully (returns original if parsing fails), handles empty data, handles data smaller than target
  </action>
  <verify>dotnet build Plugins/DataWarehouse.Plugins.SemanticSync/DataWarehouse.Plugins.SemanticSync.csproj 2>&1 | tail -5</verify>
  <done>Both helper classes compile, SummaryGenerator handles AI and fallback paths, FidelityDownsampler implements real field stripping</done>
</task>

<task type="auto">
  <name>Task 2: Bandwidth-Aware Summary Router Strategy</name>
  <files>Plugins/DataWarehouse.Plugins.SemanticSync/Strategies/Routing/BandwidthAwareSummaryRouter.cs</files>
  <action>
**BandwidthAwareSummaryRouter.cs:**
- Class: `BandwidthAwareSummaryRouter : SemanticSyncStrategyBase, ISummaryRouter`
- StrategyId: `"summary-router-bandwidth-aware"`, Name: `"Bandwidth-Aware Summary Router"`
- Constructor takes `SummaryGenerator` and `FidelityDownsampler` (composition)

**RouteAsync decision matrix (importance x bandwidth):**
```
                    | High BW (>100Mbps) | Medium (10-100) | Low (1-10)    | Very Low (<1)
Critical            | Full               | Full            | Detailed      | Standard
High                | Full               | Detailed        | Standard      | Summarized
Normal              | Detailed           | Standard        | Summarized    | Summarized
Low                 | Standard           | Summarized      | Metadata      | Metadata
Negligible          | Summarized         | Metadata        | Metadata      | Defer
```

- Implement this as a lookup table (not giant if/else chain): `Dictionary<(SemanticImportance, BandwidthTier), SyncFidelity>` where BandwidthTier is computed from FidelityBudget.AvailableBandwidthBps
- When decision is "Defer": set SyncDecision.DeferUntil to now + 15 minutes (re-evaluate later)
- EstimatedSizeBytes: compute using FidelityDownsampler's target ratios (e.g., if raw = 1MB and fidelity = Summarized, estimate 150KB)
- RequiresSummary = true when fidelity is Summarized or Metadata

**GenerateSummaryAsync:** Delegate to SummaryGenerator.GenerateAsync

**ReconstructFromSummaryAsync:** Delegate to SummaryGenerator.ReconstructAsync

**Capabilities:** SupportedFidelities = all 5, MaxSummarySizeBytes = 10MB, SupportsReconstruction = true
  </action>
  <verify>dotnet build Plugins/DataWarehouse.Plugins.SemanticSync/DataWarehouse.Plugins.SemanticSync.csproj 2>&1 | tail -5</verify>
  <done>Router compiles, implements ISummaryRouter, decision matrix covers all 20 importance-bandwidth combinations</done>
</task>

</tasks>

<verification>
- All 3 files compile in plugin project
- BandwidthAwareSummaryRouter implements ISummaryRouter
- Decision matrix covers all SemanticImportance x bandwidth tier combinations
- SummaryGenerator works with and without IAIProvider
- FidelityDownsampler actually parses JSON and strips fields (not a stub)
- No Task.Delay or placeholder implementations
</verification>

<success_criteria>
- Routing engine makes deterministic decisions based on importance + bandwidth
- Summary generation works in AI and non-AI environments
- Progressive fidelity reduction preserves critical data while cutting bandwidth
</success_criteria>

<output>
After completion, create `.planning/phases/60-semantic-sync/60-04-SUMMARY.md`
</output>
