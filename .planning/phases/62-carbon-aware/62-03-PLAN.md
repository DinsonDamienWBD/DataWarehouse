---
phase: 62-carbon-aware
plan: 03
type: execute
wave: 2
depends_on: ["62-01"]
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/CarbonBudget/CarbonBudgetStore.cs
  - Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/CarbonBudget/CarbonBudgetEnforcementStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/CarbonBudget/CarbonThrottlingStrategy.cs
autonomous: true

must_haves:
  truths:
    - "Each tenant has an independently configurable carbon budget with period (hourly to annual)"
    - "Operations are throttled (delayed) when tenant reaches soft threshold (default 80%)"
    - "Operations are rejected when tenant exceeds hard limit (default 100%)"
    - "Budget usage resets automatically at period boundaries"
    - "Budget state persists across restarts via file-based store"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/CarbonBudget/CarbonBudgetStore.cs"
      provides: "Persistent per-tenant budget storage with atomic updates"
      min_lines: 150
    - path: "Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/CarbonBudget/CarbonBudgetEnforcementStrategy.cs"
      provides: "Budget enforcement implementing ICarbonBudgetService"
      min_lines: 200
    - path: "Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/CarbonBudget/CarbonThrottlingStrategy.cs"
      provides: "Progressive throttling based on budget consumption"
      min_lines: 120
  key_links:
    - from: "Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/CarbonBudget/CarbonBudgetEnforcementStrategy.cs"
      to: "DataWarehouse.SDK/Contracts/Carbon/ICarbonBudget.cs"
      via: "implements ICarbonBudgetService"
      pattern: "ICarbonBudgetService"
    - from: "Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/CarbonBudget/CarbonBudgetEnforcementStrategy.cs"
      to: "message bus sustainability.carbon.budget.*"
      via: "publishes budget events"
      pattern: "sustainability\\.carbon\\.budget"
---

<objective>
Implement per-tenant carbon budget enforcement with progressive throttling. Tenants get configurable carbon budgets; approaching the limit triggers soft throttling, exceeding it rejects operations.

Purpose: Carbon budgets give organizations control over their emissions. Without enforcement, sustainability reporting is purely informational. This plan makes carbon limits actionable.

Output: Three strategy files implementing budget storage, enforcement, and throttling.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/PLUGIN-CATALOG.md
@.planning/phases/62-carbon-aware/62-01-SUMMARY.md
@Plugins/DataWarehouse.Plugins.UltimateSustainability/SustainabilityStrategyBase.cs
@Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/CarbonAwareness/CarbonOffsettingStrategy.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement carbon budget persistent store</name>
  <files>Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/CarbonBudget/CarbonBudgetStore.cs</files>
  <action>
Create `CarbonBudgetStore` class in namespace `DataWarehouse.Plugins.UltimateSustainability.Strategies.CarbonBudget`:

- Stores per-tenant `CarbonBudget` records (from SDK types) in a `ConcurrentDictionary<string, CarbonBudget>`
- Persists to JSON file at configurable path (default: `{dataDir}/carbon-budgets.json`)
- Methods:
  - `Task<CarbonBudget?> GetAsync(string tenantId)` -- returns budget or null
  - `Task SetAsync(string tenantId, CarbonBudget budget)` -- upsert budget
  - `Task<bool> RecordUsageAsync(string tenantId, double carbonGramsCO2e)` -- atomically increments UsedGramsCO2e, returns false if would exceed hard limit
  - `Task ResetExpiredBudgetsAsync()` -- checks all budgets, resets UsedGramsCO2e to 0 for any where PeriodEnd < UtcNow and advances period
  - `Task LoadAsync(CancellationToken ct)` -- loads from disk
  - `Task SaveAsync(CancellationToken ct)` -- persists to disk
- Period advancement logic: when a budget expires, set new PeriodStart = old PeriodEnd, compute new PeriodEnd based on BudgetPeriod enum (add 1 hour/day/week/month/quarter/year)
- Thread-safety: use `SemaphoreSlim(1,1)` for file I/O, `ConcurrentDictionary` for in-memory access
- Use `System.Text.Json` for serialization (project convention, NOT Newtonsoft)
- Auto-save after every `RecordUsageAsync` call (debounced: save at most every 5 seconds via timer)
  </action>
  <verify>`dotnet build Plugins/DataWarehouse.Plugins.UltimateSustainability/DataWarehouse.Plugins.UltimateSustainability.csproj --no-restore` compiles with 0 errors.</verify>
  <done>Budget store compiles with persistent JSON storage, atomic usage recording, and automatic period reset.</done>
</task>

<task type="auto">
  <name>Task 2: Implement budget enforcement and throttling strategies</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/CarbonBudget/CarbonBudgetEnforcementStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/CarbonBudget/CarbonThrottlingStrategy.cs
  </files>
  <action>
**CarbonBudgetEnforcementStrategy.cs** -- extends `SustainabilityStrategyBase`, also implements `ICarbonBudgetService`:
- Category: CarbonAwareness, Capabilities: ActiveControl | CarbonCalculation | Alerting
- Wraps `CarbonBudgetStore` for persistence
- `GetBudgetAsync(tenantId)`: returns budget from store, or a default unlimited budget for unknown tenants
- `SetBudgetAsync(tenantId, budgetGrams, period)`: creates/updates budget with computed period boundaries
- `CanProceedAsync(tenantId, estimatedCarbon)`: checks current usage + estimated against hard limit
- `RecordUsageAsync(tenantId, carbonGrams, operationType)`:
  1. Records to store
  2. Checks thresholds
  3. Publishes `sustainability.carbon.budget.usage` message with tenant, usage, remaining
  4. If threshold crossed, publishes `sustainability.carbon.budget.threshold` with throttle level
  5. If exhausted, publishes `sustainability.carbon.budget.exhausted`
- `EvaluateThrottleAsync(tenantId)`:
  - Below 80% (configurable): ThrottleLevel.None
  - 80-100%: ThrottleLevel.Soft, RecommendedDelayMs scales linearly from 100ms at 80% to 2000ms at 100%
  - Above 100%: ThrottleLevel.Hard, operation should be rejected
- Background timer: every 60 seconds, calls `ResetExpiredBudgetsAsync()` on the store
- Subscribe to `sustainability.energy.measured` to auto-record usage when energy measurement is available (convert Wh to gCO2e using current grid intensity from `CarbonIntensityTrackingStrategy` via bus request)

**CarbonThrottlingStrategy.cs** -- extends `SustainabilityStrategyBase`:
- Category: CarbonAwareness, Capabilities: ActiveControl | Scheduling
- Provides the actual throttling mechanism that other plugins call
- `Task<ThrottleResult> ThrottleIfNeededAsync(string tenantId, CancellationToken ct)`:
  1. Calls `EvaluateThrottleAsync` on the enforcement strategy (via message bus `sustainability.carbon.budget.evaluate`)
  2. If Soft: `await Task.Delay(RecommendedDelayMs, ct)` then returns ThrottleResult.Delayed
  3. If Hard: returns ThrottleResult.Rejected (caller must handle)
  4. If None: returns ThrottleResult.Allowed immediately
- `ThrottleResult` enum: Allowed, Delayed, Rejected
- Tracks throttle events in statistics (RecordOptimizationAction for each throttle)
- Publishes `sustainability.carbon.throttle.applied` message for observability
- Generates recommendations when tenants are frequently throttled
  </action>
  <verify>`dotnet build Plugins/DataWarehouse.Plugins.UltimateSustainability/DataWarehouse.Plugins.UltimateSustainability.csproj --no-restore` compiles with 0 errors.</verify>
  <done>Budget enforcement and throttling compile, implement ICarbonBudgetService, and provide progressive throttling (none/soft/hard) based on tenant carbon usage.</done>
</task>

</tasks>

<verification>
- Full solution build passes: `dotnet build DataWarehouse.slnx` with 0 errors
- CarbonBudgetEnforcementStrategy implements ICarbonBudgetService from SDK
- All 3 new files exist in Strategies/CarbonBudget/
- Message bus topics follow existing naming convention (sustainability.carbon.budget.*)
</verification>

<success_criteria>
Per-tenant carbon budgets with persistent storage and progressive throttling. Tenants hitting 80% get progressively delayed; tenants exceeding 100% get operations rejected.
</success_criteria>

<output>
After completion, create `.planning/phases/62-carbon-aware/62-03-SUMMARY.md`
</output>
