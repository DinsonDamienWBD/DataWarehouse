---
phase: 62-carbon-aware
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.SDK/Contracts/Carbon/CarbonTypes.cs
  - DataWarehouse.SDK/Contracts/Carbon/ICarbonBudget.cs
  - DataWarehouse.SDK/Contracts/Carbon/IEnergyMeasurement.cs
  - DataWarehouse.SDK/Contracts/Carbon/ICarbonReporting.cs
  - DataWarehouse.SDK/Contracts/Carbon/IGreenPlacement.cs
autonomous: true

must_haves:
  truths:
    - "All carbon-aware strategies can reference shared SDK types without circular dependencies"
    - "Energy measurement, carbon budget, green placement, and reporting contracts are defined in SDK"
    - "Tenant-scoped carbon budget model exists with budget, usage, and throttle threshold"
  artifacts:
    - path: "DataWarehouse.SDK/Contracts/Carbon/CarbonTypes.cs"
      provides: "Core carbon domain types (EnergyMeasurement, CarbonBudget, GridCarbonData, GreenScore, GhgReport)"
      min_lines: 200
    - path: "DataWarehouse.SDK/Contracts/Carbon/ICarbonBudget.cs"
      provides: "Per-tenant carbon budget contract"
      exports: ["ICarbonBudgetService"]
    - path: "DataWarehouse.SDK/Contracts/Carbon/IEnergyMeasurement.cs"
      provides: "Energy measurement contract for watts-per-operation"
      exports: ["IEnergyMeasurementService"]
    - path: "DataWarehouse.SDK/Contracts/Carbon/ICarbonReporting.cs"
      provides: "GHG Protocol reporting contract"
      exports: ["ICarbonReportingService"]
    - path: "DataWarehouse.SDK/Contracts/Carbon/IGreenPlacement.cs"
      provides: "Renewable-aware placement contract"
      exports: ["IGreenPlacementService"]
  key_links:
    - from: "DataWarehouse.SDK/Contracts/Carbon/CarbonTypes.cs"
      to: "DataWarehouse.SDK/Contracts/Carbon/ICarbonBudget.cs"
      via: "CarbonBudget type used in budget contract"
      pattern: "CarbonBudget"
---

<objective>
Define all SDK carbon-aware lifecycle contracts and types that Plans 02-06 will implement.

Purpose: Establish the shared type system so energy measurement, carbon budgets, green placement, and reporting strategies all speak the same language. Follows SDK-first architecture (plugins reference only SDK).

Output: Five files in DataWarehouse.SDK/Contracts/Carbon/ defining the complete carbon-aware type system.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/PLUGIN-CATALOG.md
@Plugins/DataWarehouse.Plugins.UltimateSustainability/SustainabilityStrategyBase.cs
@DataWarehouse.SDK/Contracts/Storage/StorageStrategy.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create core carbon domain types</name>
  <files>DataWarehouse.SDK/Contracts/Carbon/CarbonTypes.cs</files>
  <action>
Create `DataWarehouse.SDK/Contracts/Carbon/CarbonTypes.cs` in namespace `DataWarehouse.SDK.Contracts.Carbon` with these types:

1. `EnergyMeasurement` record: `OperationId` (string), `Timestamp` (DateTimeOffset), `WattsConsumed` (double), `DurationMs` (double), `EnergyWh` (double, computed = WattsConsumed * DurationMs / 3_600_000), `Component` (EnergyComponent enum), `Source` (EnergySource enum), `TenantId` (string?), `OperationType` (string -- "read"/"write"/"delete"/"list")

2. `EnergyComponent` enum: Cpu, Gpu, Memory, Storage, Network, System, Unknown

3. `EnergySource` enum: Rapl, Powercap, IpmiDcmi, SmartPdu, CloudProviderApi, Estimation, Manual

4. `CarbonBudget` record: `TenantId` (string), `BudgetPeriod` (CarbonBudgetPeriod enum), `BudgetGramsCO2e` (double), `UsedGramsCO2e` (double), `RemainingGramsCO2e` (double, computed), `ThrottleThresholdPercent` (double, default 80), `HardLimitPercent` (double, default 100), `PeriodStart` (DateTimeOffset), `PeriodEnd` (DateTimeOffset), `IsThrottled` (bool, computed from usage vs threshold), `IsExhausted` (bool, computed from usage vs hard limit)

5. `CarbonBudgetPeriod` enum: Hourly, Daily, Weekly, Monthly, Quarterly, Annual

6. `GridCarbonData` record: `Region` (string), `Timestamp` (DateTimeOffset), `CarbonIntensityGCO2ePerKwh` (double), `RenewablePercentage` (double), `FossilPercentage` (double, computed), `Source` (GridDataSource enum), `ForecastHours` (int), `MarginalIntensity` (double?), `AverageIntensity` (double?)

7. `GridDataSource` enum: WattTime, ElectricityMaps, CarbonIntensityUkApi, EiaOpenData, Estimation

8. `GreenScore` record: `BackendId` (string), `Region` (string), `RenewablePercentage` (double), `CarbonIntensityGCO2ePerKwh` (double), `PowerUsageEffectiveness` (double), `WaterUsageEffectiveness` (double?), `Score` (double, 0-100 composite), `LastUpdated` (DateTimeOffset)

9. `GhgScopeCategory` enum: Scope1_DirectEmissions, Scope2_PurchasedElectricity, Scope3_ValueChain

10. `GhgReportEntry` record: `Scope` (GhgScopeCategory), `Category` (string), `EmissionsGramsCO2e` (double), `EnergyConsumedWh` (double), `Period` (DateTimeOffset start, DateTimeOffset end), `Region` (string), `Source` (string), `DataQuality` (DataQualityLevel enum)

11. `DataQualityLevel` enum: Measured, Calculated, Estimated, Default

12. `CarbonPlacementDecision` record: `PreferredBackendId` (string), `GreenScore` (GreenScore), `Reason` (string), `AlternativeBackendIds` (IReadOnlyList of string), `EstimatedCarbonGramsCO2e` (double), `EstimatedEnergyWh` (double)

All records should use `required` on mandatory properties. Use XML doc comments throughout. Place all types in a single file for discoverability. Follow existing SDK patterns (see StorageStrategy.cs for style).
  </action>
  <verify>Build DataWarehouse.SDK project: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore` compiles with 0 errors.</verify>
  <done>All 12 types compile and are accessible from any project referencing the SDK.</done>
</task>

<task type="auto">
  <name>Task 2: Create carbon service contracts (interfaces)</name>
  <files>
    DataWarehouse.SDK/Contracts/Carbon/ICarbonBudget.cs
    DataWarehouse.SDK/Contracts/Carbon/IEnergyMeasurement.cs
    DataWarehouse.SDK/Contracts/Carbon/ICarbonReporting.cs
    DataWarehouse.SDK/Contracts/Carbon/IGreenPlacement.cs
  </files>
  <action>
Create four interface files in `DataWarehouse.SDK.Contracts.Carbon`:

**IEnergyMeasurement.cs:**
- `IEnergyMeasurementService` with:
  - `Task<EnergyMeasurement> MeasureOperationAsync(string operationId, string operationType, long dataSizeBytes, CancellationToken ct)`
  - `Task<double> GetWattsPerOperationAsync(string operationType, CancellationToken ct)` -- returns average watts for operation type
  - `Task<IReadOnlyList<EnergyMeasurement>> GetMeasurementsAsync(DateTimeOffset from, DateTimeOffset to, string? tenantId, CancellationToken ct)`
  - `Task<double> GetCurrentPowerDrawWatts(CancellationToken ct)` -- current system power

**ICarbonBudget.cs:**
- `ICarbonBudgetService` with:
  - `Task<CarbonBudget> GetBudgetAsync(string tenantId, CancellationToken ct)`
  - `Task SetBudgetAsync(string tenantId, double budgetGramsCO2e, CarbonBudgetPeriod period, CancellationToken ct)`
  - `Task<bool> CanProceedAsync(string tenantId, double estimatedCarbonGramsCO2e, CancellationToken ct)` -- checks budget, returns false if exhausted
  - `Task RecordUsageAsync(string tenantId, double carbonGramsCO2e, string operationType, CancellationToken ct)`
  - `Task<CarbonThrottleDecision> EvaluateThrottleAsync(string tenantId, CancellationToken ct)` -- returns throttle level (None, Soft, Hard)
  - Add `CarbonThrottleDecision` record in same file: `ThrottleLevel` (enum None/Soft/Hard), `CurrentUsagePercent` (double), `RecommendedDelayMs` (int), `Message` (string)

**IGreenPlacement.cs:**
- `IGreenPlacementService` with:
  - `Task<CarbonPlacementDecision> SelectGreenestBackendAsync(IReadOnlyList<string> candidateBackendIds, long dataSizeBytes, CancellationToken ct)`
  - `Task<IReadOnlyList<GreenScore>> GetGreenScoresAsync(CancellationToken ct)` -- all known backend scores
  - `Task<GridCarbonData> GetGridCarbonDataAsync(string region, CancellationToken ct)`
  - `Task RefreshGridDataAsync(CancellationToken ct)` -- force refresh from external APIs

**ICarbonReporting.cs:**
- `ICarbonReportingService` with:
  - `Task<IReadOnlyList<GhgReportEntry>> GenerateGhgReportAsync(DateTimeOffset from, DateTimeOffset to, string? tenantId, CancellationToken ct)`
  - `Task<double> GetTotalEmissionsAsync(GhgScopeCategory scope, DateTimeOffset from, DateTimeOffset to, CancellationToken ct)`
  - `Task<IReadOnlyDictionary<string, double>> GetEmissionsByRegionAsync(DateTimeOffset from, DateTimeOffset to, CancellationToken ct)`
  - `Task<CarbonSummary> GetCarbonSummaryAsync(string? tenantId, CancellationToken ct)`
  - Add `CarbonSummary` record: `TotalEmissionsGramsCO2e`, `TotalEnergyWh`, `RenewablePercentage`, `AvgCarbonIntensity`, `TopEmittingRegion`, `Period` (start, end)

All interfaces should have XML doc comments explaining each method. Follow existing SDK contract patterns (see IStorageStrategy, IMessageBus for style).
  </action>
  <verify>Build DataWarehouse.SDK project: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore` compiles with 0 errors.</verify>
  <done>Four service contracts exist with full method signatures. Any plugin can implement these interfaces by referencing only the SDK.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` passes with 0 errors
- All types are in namespace `DataWarehouse.SDK.Contracts.Carbon`
- No circular dependencies introduced
</verification>

<success_criteria>
SDK carbon contracts compiled and available for Plans 02-06 to implement against. Types cover energy measurement, carbon budgets, green placement, and GHG reporting.
</success_criteria>

<output>
After completion, create `.planning/phases/62-carbon-aware/62-01-SUMMARY.md`
</output>
