---
phase: 62-carbon-aware
plan: 04
type: execute
wave: 3
depends_on: ["62-01", "62-02"]
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/GreenPlacement/WattTimeGridApiStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/GreenPlacement/ElectricityMapsApiStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/GreenPlacement/GreenPlacementService.cs
  - Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/GreenPlacement/BackendGreenScoreRegistry.cs
autonomous: true

must_haves:
  truths:
    - "System fetches real-time grid carbon intensity from WattTime API v3"
    - "System fetches real-time grid carbon intensity from ElectricityMaps API as fallback"
    - "Storage backends are scored by renewable percentage, carbon intensity, PUE, and WUE"
    - "Data placement decisions prefer the backend with highest green score"
    - "Grid data is cached with configurable TTL (default 5 minutes) to avoid API rate limits"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/GreenPlacement/WattTimeGridApiStrategy.cs"
      provides: "WattTime v3 API integration for real-time grid carbon intensity"
      min_lines: 180
    - path: "Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/GreenPlacement/ElectricityMapsApiStrategy.cs"
      provides: "ElectricityMaps API integration as WattTime alternative"
      min_lines: 150
    - path: "Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/GreenPlacement/GreenPlacementService.cs"
      provides: "Composite placement service implementing IGreenPlacementService"
      min_lines: 180
    - path: "Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/GreenPlacement/BackendGreenScoreRegistry.cs"
      provides: "Registry mapping storage backends to green scores"
      min_lines: 120
  key_links:
    - from: "Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/GreenPlacement/GreenPlacementService.cs"
      to: "DataWarehouse.SDK/Contracts/Carbon/IGreenPlacement.cs"
      via: "implements IGreenPlacementService"
      pattern: "IGreenPlacementService"
    - from: "Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/GreenPlacement/WattTimeGridApiStrategy.cs"
      to: "DataWarehouse.SDK/Contracts/Carbon/CarbonTypes.cs"
      via: "returns GridCarbonData"
      pattern: "GridCarbonData"
---

<objective>
Implement renewable-aware data placement with real grid carbon API integration. Storage operations route to the greenest available backend using live carbon intensity data from WattTime and ElectricityMaps.

Purpose: The biggest carbon reduction comes from placing data where the grid is cleanest. Real-time grid APIs enable dynamic routing as renewable generation fluctuates.

Output: Four strategy files implementing grid API clients, backend scoring, and a composite placement service.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/PLUGIN-CATALOG.md
@.planning/phases/62-carbon-aware/62-01-SUMMARY.md
@.planning/phases/62-carbon-aware/62-02-SUMMARY.md
@Plugins/DataWarehouse.Plugins.UltimateSustainability/SustainabilityStrategyBase.cs
@Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Innovation/CarbonNeutralStorageStrategy.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement WattTime and ElectricityMaps grid API strategies</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/GreenPlacement/WattTimeGridApiStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/GreenPlacement/ElectricityMapsApiStrategy.cs
  </files>
  <action>
**WattTimeGridApiStrategy.cs** -- extends `SustainabilityStrategyBase`:
- Category: CarbonAwareness, Capabilities: ExternalIntegration | RealTimeMonitoring | CarbonCalculation
- Integrates with WattTime API v3 (https://api.watttime.org/v3):
  - Authentication: POST `/login` with Basic auth (username/password from config), returns bearer token
  - Token refresh: cache token, re-authenticate when 401 returned
  - Signal endpoint: GET `/signal-index` with `region={balancing_authority}&signal_type=co2_moer` -- returns MOER (Marginal Operating Emissions Rate) in lbs CO2/MWh
  - Historical: GET `/historical` with `region`, `start`, `end` for time-series data
  - Forecast: GET `/forecast` with `region` for 24-hour forecast
- Convert MOER (lbs CO2/MWh) to gCO2e/kWh: `moer * 453.592 / 1000`
- Region mapping: map common cloud regions to WattTime balancing authorities:
  - us-east-1 -> PJM, us-west-2 -> BPAT, eu-west-1 -> IE, eu-central-1 -> DE, ap-southeast-1 -> SG
- Cache responses in `ConcurrentDictionary<string, (GridCarbonData data, DateTimeOffset expiry)>` with 5-min TTL
- Use `IHttpClientFactory` pattern: accept `HttpClient` in constructor (no `new HttpClient()`)
- Return `GridCarbonData` with Source = GridDataSource.WattTime
- Handle rate limits (HTTP 429): exponential backoff with 3 retries

**ElectricityMapsApiStrategy.cs** -- extends `SustainabilityStrategyBase`:
- Category: CarbonAwareness, Capabilities: ExternalIntegration | RealTimeMonitoring | CarbonCalculation
- Integrates with Electricity Maps API (https://api.electricitymap.org/v3):
  - Auth: `auth-token` header with API key from config
  - Carbon intensity: GET `/carbon-intensity/latest?zone={zone}` -- returns `carbonIntensity` in gCO2eq/kWh (already in our target unit)
  - Power breakdown: GET `/power-breakdown/latest?zone={zone}` -- returns renewable vs fossil percentages
  - Forecast: GET `/carbon-intensity/forecast?zone={zone}`
- Zone mapping: map cloud regions to EM zones:
  - us-east-1 -> US-PJM, us-west-2 -> US-NW-BPAT, eu-west-1 -> IE, eu-central-1 -> DE, ap-southeast-1 -> SG
- Same caching pattern as WattTime (5-min TTL)
- Return `GridCarbonData` with Source = GridDataSource.ElectricityMaps, fill in RenewablePercentage from power breakdown
- Handle rate limits and auth errors gracefully

Both strategies must:
- Log API errors but never throw to callers (return cached/estimated data on failure)
- Support configuration via properties: ApiKey, ApiEndpoint, CacheTtlSeconds
- Implement `IsAvailable()` returning true only if API credentials are configured
  </action>
  <verify>`dotnet build Plugins/DataWarehouse.Plugins.UltimateSustainability/DataWarehouse.Plugins.UltimateSustainability.csproj --no-restore` compiles with 0 errors.</verify>
  <done>WattTime v3 and ElectricityMaps API strategies compile with real API paths, auth, caching, and rate limit handling.</done>
</task>

<task type="auto">
  <name>Task 2: Implement backend green score registry and composite placement service</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/GreenPlacement/BackendGreenScoreRegistry.cs
    Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/GreenPlacement/GreenPlacementService.cs
  </files>
  <action>
**BackendGreenScoreRegistry.cs**:
- Stores `GreenScore` records per storage backend ID in `ConcurrentDictionary<string, GreenScore>`
- `RegisterBackend(string backendId, string region, double renewablePct, double pue, double? wue)` -- computes composite Score: `(renewablePct * 0.4) + ((1 - carbonIntensity/1000) * 100 * 0.3) + ((2 - pue) * 100 * 0.2) + (wue.HasValue ? (2 - wue.Value) * 100 * 0.1 : 5)`
- `UpdateCarbonIntensity(string region, double intensity)` -- updates all backends in that region
- `GetScore(string backendId)` -> `GreenScore?`
- `GetAllScores()` -> ordered by Score descending
- `GetBestBackend(IReadOnlyList<string> candidates)` -> highest-scoring from candidates
- Pre-register known cloud provider sustainability data:
  - AWS us-west-2 (Oregon): 96% renewable, PUE 1.135
  - AWS eu-north-1 (Stockholm): 100% renewable, PUE 1.09
  - Azure West Europe: 100% renewable, PUE 1.12
  - GCP us-central1: 97% carbon-free, PUE 1.10
  - On-prem defaults: 40% renewable, PUE 1.5 (configurable)
- Persist to JSON file for reload

**GreenPlacementService.cs** -- extends `SustainabilityStrategyBase`, implements `IGreenPlacementService`:
- Category: CarbonAwareness, Capabilities: CarbonCalculation | ExternalIntegration | Scheduling
- Composite service combining grid API and backend registry:
- `SelectGreenestBackendAsync(candidates, dataSizeBytes)`:
  1. For each candidate, look up its GreenScore from registry
  2. For each candidate's region, fetch latest GridCarbonData from WattTime (fallback ElectricityMaps, fallback estimation)
  3. Update registry with fresh carbon intensity data
  4. Re-score candidates with live data
  5. Select highest score
  6. Estimate carbon for the operation: `energyWh = dataSizeBytes * storageEnergyPerByte * pue; carbonGrams = energyWh * carbonIntensity / 1000`
  7. Return `CarbonPlacementDecision` with best backend, alternatives sorted by score, estimated carbon
- `GetGreenScoresAsync()` -- returns all scores from registry
- `GetGridCarbonDataAsync(region)` -- tries WattTime first, falls back to ElectricityMaps, then estimation
- `RefreshGridDataAsync()` -- forces refresh of all known regions
- Subscribe to message bus `storage.backend.registered` to auto-register new backends
- Publish `sustainability.placement.decision` message on each placement decision for audit trail
  </action>
  <verify>`dotnet build Plugins/DataWarehouse.Plugins.UltimateSustainability/DataWarehouse.Plugins.UltimateSustainability.csproj --no-restore` compiles with 0 errors.</verify>
  <done>Green placement service compiles, scores backends with live grid data, and selects the greenest option for data placement.</done>
</task>

</tasks>

<verification>
- Full solution build passes: `dotnet build DataWarehouse.slnx` with 0 errors
- GreenPlacementService implements IGreenPlacementService
- WattTime and ElectricityMaps strategies use real API endpoints (not simulated)
- Backend registry pre-populated with known cloud provider sustainability data
</verification>

<success_criteria>
Renewable-aware placement operational: system fetches live grid carbon data from WattTime/ElectricityMaps, scores storage backends, and routes data to the greenest option.
</success_criteria>

<output>
After completion, create `.planning/phases/62-carbon-aware/62-04-SUMMARY.md`
</output>
