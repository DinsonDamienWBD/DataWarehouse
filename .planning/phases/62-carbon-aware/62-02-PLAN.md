---
phase: 62-carbon-aware
plan: 02
type: execute
wave: 2
depends_on: ["62-01"]
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/EnergyMeasurement/RaplEnergyMeasurementStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/EnergyMeasurement/PowercapEnergyMeasurementStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/EnergyMeasurement/CloudProviderEnergyStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/EnergyMeasurement/EstimationEnergyStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/EnergyMeasurement/EnergyMeasurementService.cs
autonomous: true

must_haves:
  truths:
    - "System can measure watts consumed per storage operation using RAPL on Intel/AMD Linux"
    - "System falls back to powercap sysfs interface when RAPL MSR is unavailable"
    - "System falls back to cloud provider metrics API on cloud VMs"
    - "System always has an estimation fallback using TDP-based power modeling"
    - "Watts-per-operation measurements are recorded with operation type, size, and tenant"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/EnergyMeasurement/RaplEnergyMeasurementStrategy.cs"
      provides: "Intel RAPL MSR-based energy measurement"
      min_lines: 150
    - path: "Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/EnergyMeasurement/PowercapEnergyMeasurementStrategy.cs"
      provides: "Linux powercap sysfs energy measurement"
      min_lines: 120
    - path: "Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/EnergyMeasurement/CloudProviderEnergyStrategy.cs"
      provides: "AWS/Azure/GCP billing/metrics API energy measurement"
      min_lines: 150
    - path: "Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/EnergyMeasurement/EstimationEnergyStrategy.cs"
      provides: "TDP-based estimation fallback"
      min_lines: 100
    - path: "Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/EnergyMeasurement/EnergyMeasurementService.cs"
      provides: "Composite service implementing IEnergyMeasurementService with auto-detection"
      min_lines: 120
  key_links:
    - from: "Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/EnergyMeasurement/EnergyMeasurementService.cs"
      to: "DataWarehouse.SDK/Contracts/Carbon/IEnergyMeasurement.cs"
      via: "implements IEnergyMeasurementService"
      pattern: "IEnergyMeasurementService"
    - from: "Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/EnergyMeasurement/RaplEnergyMeasurementStrategy.cs"
      to: "DataWarehouse.SDK/Contracts/Carbon/CarbonTypes.cs"
      via: "returns EnergyMeasurement records"
      pattern: "EnergyMeasurement"
---

<objective>
Implement the Energy Measurement Engine -- the foundation for all carbon-aware features. Measures actual watts consumed per storage operation using a cascade of hardware/software sources.

Purpose: Without real energy data, carbon budgets and green placement are guesswork. This plan provides ground-truth watt measurements using RAPL, powercap, cloud APIs, and TDP estimation.

Output: Five strategy files in UltimateSustainability/Strategies/EnergyMeasurement/ plus a composite service.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/PLUGIN-CATALOG.md
@.planning/phases/62-carbon-aware/62-01-SUMMARY.md
@Plugins/DataWarehouse.Plugins.UltimateSustainability/SustainabilityStrategyBase.cs
@Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/EnergyOptimization/PowerCappingStrategy.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement hardware energy measurement strategies (RAPL + powercap)</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/EnergyMeasurement/RaplEnergyMeasurementStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/EnergyMeasurement/PowercapEnergyMeasurementStrategy.cs
  </files>
  <action>
**RaplEnergyMeasurementStrategy.cs** -- extends `SustainabilityStrategyBase`:
- Category: EnergyOptimization, Capabilities: RealTimeMonitoring | CarbonCalculation
- On Linux: reads from `/sys/class/powercap/intel-rapl/intel-rapl:0/energy_uj` (microjoules counter)
- `MeasureOperationAsync(Func<Task> operation)` method:
  1. Read energy_uj counter before operation
  2. Execute operation
  3. Read energy_uj counter after
  4. Compute delta in watt-hours: `(afterUj - beforeUj) / 1_000_000 / 3600`
  5. Handle counter overflow (32-bit wrap at ~2^32 microjoules)
  6. Return `EnergyMeasurement` record with EnergySource.Rapl
- `IsAvailable()` static method: checks RuntimeInformation.IsOSPlatform(Linux) AND `/sys/class/powercap/intel-rapl` directory exists
- Support multiple RAPL domains: package (intel-rapl:0), core, uncore, dram
- Track per-domain readings in `ConcurrentDictionary<string, double>`
- Record samples via base class `RecordSample(watts, carbonIntensity: 0)`

**PowercapEnergyMeasurementStrategy.cs** -- extends `SustainabilityStrategyBase`:
- Category: EnergyOptimization, Capabilities: RealTimeMonitoring | CarbonCalculation
- Reads from Linux powercap sysfs: `/sys/class/powercap/*/energy_uj`
- More generic than RAPL -- works with any powercap-compatible driver (AMD, ARM)
- Same measurement pattern: before/after counter reads around operations
- `IsAvailable()`: checks `/sys/class/powercap` directory exists with subdirectories
- Enumerate all powercap zones dynamically, aggregate package-level readings
- Handle AMD RAPL (same sysfs path but different domain names)

Both strategies must:
- Use `File.ReadAllTextAsync` for sysfs reads (not File.ReadAllText)
- Handle `FileNotFoundException` and `UnauthorizedAccessException` gracefully
- Return `EnergySource.Rapl` or `EnergySource.Powercap` respectively
- NOT use `Task.Delay` for simulation -- return real readings or throw if unavailable
  </action>
  <verify>`dotnet build Plugins/DataWarehouse.Plugins.UltimateSustainability/DataWarehouse.Plugins.UltimateSustainability.csproj --no-restore` compiles with 0 errors.</verify>
  <done>RAPL and powercap strategies compile, read real sysfs counters on Linux, and produce EnergyMeasurement records.</done>
</task>

<task type="auto">
  <name>Task 2: Implement cloud provider and estimation strategies + composite service</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/EnergyMeasurement/CloudProviderEnergyStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/EnergyMeasurement/EstimationEnergyStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/EnergyMeasurement/EnergyMeasurementService.cs
  </files>
  <action>
**CloudProviderEnergyStrategy.cs** -- extends `SustainabilityStrategyBase`:
- Category: EnergyOptimization, Capabilities: RealTimeMonitoring | ExternalIntegration
- Supports three cloud providers via configuration:
  - AWS: Uses CloudWatch `EC2/CPUCreditUsage` and instance-type TDP mapping (e.g., m5.xlarge = 4 vCPU * 10W = 40W TDP). Map instance types to known TDPs from AWS Graviton/Intel spec sheets.
  - Azure: Uses Azure Monitor `Percentage CPU` metric + VM SKU TDP mapping
  - GCP: Uses Cloud Monitoring `compute.googleapis.com/instance/cpu/utilization` + machine type TDP
- `DetectCloudProvider()`: check environment for AWS_EXECUTION_ENV, WEBSITE_INSTANCE_ID (Azure), GCE_METADATA_HOST
- Each provider: `HttpClient` call to metrics endpoint (use real API paths, not simulated)
- Convert CPU utilization percentage to watts: `watts = cpuUtilization * instanceTdpWatts * PUE`
- Include PUE estimates per cloud region (AWS us-east-1: 1.2, EU: 1.1, etc.)
- Return EnergySource.CloudProviderApi

**EstimationEnergyStrategy.cs** -- extends `SustainabilityStrategyBase`:
- Category: EnergyOptimization, Capabilities: CarbonCalculation
- Always available -- the universal fallback
- Uses a TDP-based power model:
  - Detect CPU via `Environment.ProcessorCount` and `RuntimeInformation.ProcessArchitecture`
  - Estimate TDP: x64 desktop ~65W, x64 server ~125W, ARM64 ~15W, ARM ~5W
  - Model: `watts = baseTdpWatts * (idleFraction + loadFraction * cpuUtilization)`
  - Where idleFraction = 0.3 (idle power ratio), cpuUtilization from System.Diagnostics.Process.GetCurrentProcess().TotalProcessorTime delta
  - Storage I/O energy model: SSD read ~0.003 Wh/GB, SSD write ~0.005 Wh/GB, HDD read ~0.01 Wh/GB, HDD write ~0.015 Wh/GB
  - Network I/O: ~0.001 Wh/GB
- Return EnergySource.Estimation

**EnergyMeasurementService.cs** -- implements `IEnergyMeasurementService`:
- Composite service that auto-detects available measurement source
- Constructor attempts in order: RAPL -> Powercap -> CloudProvider -> Estimation
- Picks the first `IsAvailable()` = true strategy
- Stores measurements in a `ConcurrentQueue<EnergyMeasurement>` (bounded to 100,000 entries)
- `MeasureOperationAsync`: delegates to active strategy, records with tenantId and operationType
- `GetWattsPerOperationAsync`: computes rolling average from stored measurements by operation type
- `GetMeasurementsAsync`: filters stored measurements by time range and optional tenantId
- `GetCurrentPowerDrawWatts`: delegates to active strategy's current reading
- Publishes measurements to message bus topic `sustainability.energy.measured` for other plugins to consume
  </action>
  <verify>`dotnet build Plugins/DataWarehouse.Plugins.UltimateSustainability/DataWarehouse.Plugins.UltimateSustainability.csproj --no-restore` compiles with 0 errors.</verify>
  <done>Complete energy measurement cascade (RAPL -> powercap -> cloud -> estimation) compiles and implements IEnergyMeasurementService.</done>
</task>

</tasks>

<verification>
- Full solution build passes: `dotnet build DataWarehouse.slnx` with 0 errors
- All 5 new files exist in Strategies/EnergyMeasurement/
- EnergyMeasurementService implements IEnergyMeasurementService from SDK
- Strategies auto-register via reflection (SustainabilityStrategyBase pattern)
</verification>

<success_criteria>
Energy measurement engine complete with 4 measurement sources and a composite service. System can measure watts-per-operation on any platform (Linux RAPL, cloud VM, bare metal with estimation fallback).
</success_criteria>

<output>
After completion, create `.planning/phases/62-carbon-aware/62-02-SUMMARY.md`
</output>
