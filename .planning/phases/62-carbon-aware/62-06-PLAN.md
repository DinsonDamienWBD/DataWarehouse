---
phase: 62-carbon-aware
plan: 06
type: execute
wave: 4
depends_on: ["62-02", "62-03", "62-04", "62-05"]
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/CarbonReporting/GhgProtocolReportingStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/CarbonReporting/CarbonDashboardDataStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/CarbonReporting/CarbonReportingService.cs
  - DataWarehouse.Tests/Plugins/CarbonAwareLifecycleTests.cs
autonomous: true

must_haves:
  truths:
    - "GHG Protocol Scope 2 emissions reported from measured energy consumption + grid carbon intensity"
    - "GHG Protocol Scope 3 emissions reported from data transfer and vendor-hosted storage"
    - "Reports are generated per tenant with configurable time periods"
    - "Dashboard data includes time-series carbon intensity, budget utilization, and green score trends"
    - "Tests verify budget enforcement, green scoring, and GHG report generation"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/CarbonReporting/GhgProtocolReportingStrategy.cs"
      provides: "GHG Protocol Scope 2/3 compliant report generation"
      min_lines: 200
    - path: "Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/CarbonReporting/CarbonDashboardDataStrategy.cs"
      provides: "Time-series data aggregation for carbon dashboards"
      min_lines: 150
    - path: "Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/CarbonReporting/CarbonReportingService.cs"
      provides: "Composite reporting service implementing ICarbonReportingService"
      min_lines: 150
    - path: "DataWarehouse.Tests/Plugins/CarbonAwareLifecycleTests.cs"
      provides: "Integration tests for carbon budget, green scoring, and GHG reporting"
      min_lines: 200
  key_links:
    - from: "Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/CarbonReporting/CarbonReportingService.cs"
      to: "DataWarehouse.SDK/Contracts/Carbon/ICarbonReporting.cs"
      via: "implements ICarbonReportingService"
      pattern: "ICarbonReportingService"
    - from: "Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/CarbonReporting/GhgProtocolReportingStrategy.cs"
      to: "message bus sustainability.energy.measured"
      via: "consumes energy measurements for Scope 2 calculation"
      pattern: "sustainability\\.energy\\.measured"
    - from: "DataWarehouse.Tests/Plugins/CarbonAwareLifecycleTests.cs"
      to: "Plugins/DataWarehouse.Plugins.UltimateSustainability"
      via: "tests carbon-aware strategies end-to-end"
      pattern: "CarbonBudgetEnforcementStrategy|GreenScore|GhgProtocol"
---

<objective>
Implement GHG Protocol-compliant carbon reporting and dashboard data aggregation, plus integration tests for the entire carbon-aware lifecycle. This is the capstone plan that ties energy measurement, budgets, placement, and tiering into auditable sustainability reports.

Purpose: Regulatory compliance (EU CSRD, SEC Climate Disclosure) requires auditable GHG emissions reporting. Dashboard data enables real-time visibility for operations teams.

Output: Three reporting strategy files plus comprehensive integration tests.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/PLUGIN-CATALOG.md
@.planning/phases/62-carbon-aware/62-01-SUMMARY.md
@.planning/phases/62-carbon-aware/62-02-SUMMARY.md
@.planning/phases/62-carbon-aware/62-03-SUMMARY.md
@.planning/phases/62-carbon-aware/62-04-SUMMARY.md
@.planning/phases/62-carbon-aware/62-05-SUMMARY.md
@Plugins/DataWarehouse.Plugins.UltimateSustainability/SustainabilityStrategyBase.cs
@DataWarehouse.Tests/Plugins/UltimateSustainabilityTests.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement GHG Protocol reporting and dashboard data strategies</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/CarbonReporting/GhgProtocolReportingStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/CarbonReporting/CarbonDashboardDataStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateSustainability/Strategies/CarbonReporting/CarbonReportingService.cs
  </files>
  <action>
**GhgProtocolReportingStrategy.cs** -- extends `SustainabilityStrategyBase`:
- Category: Metrics, Capabilities: Reporting | CarbonCalculation
- Generates GHG Protocol-compliant emission reports:
- `GenerateScope2ReportAsync(DateTimeOffset from, DateTimeOffset to, string? tenantId, CancellationToken ct)`:
  1. Request energy measurements from `sustainability.energy.measurements` bus topic for the period
  2. Group measurements by region
  3. For each region, multiply energy by grid carbon intensity (location-based method)
  4. Also compute market-based method using actual renewable energy certificates if available
  5. Return list of `GhgReportEntry` with Scope = Scope2_PurchasedElectricity
  6. Categories: "Electricity consumption - compute", "Electricity consumption - storage", "Electricity consumption - network"
  7. DataQuality: Measured if from RAPL/powercap, Calculated if from cloud API, Estimated if from estimation
- `GenerateScope3ReportAsync(DateTimeOffset from, DateTimeOffset to, string? tenantId, CancellationToken ct)`:
  1. Scope 3 Category 1 (Purchased goods/services): vendor-hosted storage (cloud provider upstream emissions)
  2. Scope 3 Category 4 (Upstream transportation): data transfers between regions
  3. Scope 3 Category 11 (Use of sold products): if DataWarehouse serves downstream users, include their compute
  4. Use emission factors: cloud storage ~0.023 kgCO2e/GB/month (AWS), data transfer ~0.06 kgCO2e/GB
  5. Return list of `GhgReportEntry` with Scope = Scope3_ValueChain
- `GenerateFullReportAsync` -- combines Scope 2 + Scope 3, adds executive summary
- Report metadata: `GhgFullReport` record with `ReportId`, `GeneratedAt`, `OrganizationName`, `ReportingPeriod`, `Entries`, `TotalScope2`, `TotalScope3`, `TotalEmissions`, `Methodology` (string describing calculation approach)

**CarbonDashboardDataStrategy.cs** -- extends `SustainabilityStrategyBase`:
- Category: Metrics, Capabilities: Reporting | RealTimeMonitoring
- Aggregates time-series data for real-time dashboards:
- `GetCarbonIntensityTimeSeriesAsync(string region, TimeSpan period, TimeSpan granularity)`:
  - Returns `IReadOnlyList<TimeSeriesPoint>` with Timestamp, Value (gCO2e/kWh)
  - Granularity: 5min, 15min, 1h, 1d
- `GetBudgetUtilizationTimeSeriesAsync(string tenantId, TimeSpan period)`:
  - Returns time-series of budget usage percentage
- `GetGreenScoreTrendAsync(TimeSpan period)`:
  - Returns average green score across all backends over time
- `GetEmissionsByOperationTypeAsync(DateTimeOffset from, DateTimeOffset to)`:
  - Returns breakdown: {read: X grams, write: Y grams, delete: Z grams, list: W grams}
- `GetTopEmittingTenantsAsync(int topN, DateTimeOffset from, DateTimeOffset to)`:
  - Returns ranked list of tenants by carbon usage
- `TimeSeriesPoint` record: Timestamp, Value, Unit (string)
- Stores aggregated data in `ConcurrentDictionary` keyed by (metric, granularity, bucket)
- Subscribes to bus topics to aggregate data in real-time: `sustainability.energy.measured`, `sustainability.carbon.budget.usage`, `sustainability.placement.decision`

**CarbonReportingService.cs** -- extends `SustainabilityStrategyBase`, implements `ICarbonReportingService`:
- Category: Metrics, Capabilities: Reporting | CarbonCalculation
- Composite service wrapping GHG and dashboard strategies:
- `GenerateGhgReportAsync`: delegates to GhgProtocolReportingStrategy, combines Scope 2 + 3
- `GetTotalEmissionsAsync`: sums entries from GHG report for requested scope
- `GetEmissionsByRegionAsync`: groups GHG entries by region
- `GetCarbonSummaryAsync`: aggregates all data into a single `CarbonSummary`:
  - Total emissions from GHG report
  - Total energy from measurements
  - Renewable percentage from green scores average
  - Average carbon intensity from grid data
  - Top emitting region from regional breakdown
  </action>
  <verify>`dotnet build Plugins/DataWarehouse.Plugins.UltimateSustainability/DataWarehouse.Plugins.UltimateSustainability.csproj --no-restore` compiles with 0 errors.</verify>
  <done>GHG Protocol reporting (Scope 2 + 3), dashboard data aggregation, and composite service compile and implement ICarbonReportingService.</done>
</task>

<task type="auto">
  <name>Task 2: Write integration tests for carbon-aware lifecycle</name>
  <files>DataWarehouse.Tests/Plugins/CarbonAwareLifecycleTests.cs</files>
  <action>
Create `CarbonAwareLifecycleTests.cs` in `DataWarehouse.Tests/Plugins/` namespace `DataWarehouse.Tests.Plugins`:

Follow the existing test patterns in `UltimateSustainabilityTests.cs`. Use xUnit with `[Fact]` and `[Theory]` attributes.

**Test groups:**

1. **Energy Measurement Tests:**
   - `EstimationEnergyStrategy_ReturnsReasonableWattage()` -- instantiate EstimationEnergyStrategy, measure a no-op, verify watts > 0 and < 500
   - `EnergyMeasurementService_SelectsBestAvailableSource()` -- verify it falls back to estimation when RAPL unavailable (Windows test env)
   - `EnergyMeasurement_RecordContainsAllFields()` -- verify OperationId, Timestamp, WattsConsumed, Component, Source are populated

2. **Carbon Budget Tests:**
   - `CarbonBudgetStore_SetAndGetBudget()` -- set budget for tenant, retrieve, verify all fields match
   - `CarbonBudgetStore_RecordUsage_UpdatesBalance()` -- set 1000g budget, record 300g, verify 700g remaining
   - `CarbonBudgetEnforcement_SoftThrottle_At80Percent()` -- set 1000g budget, record 800g, evaluate throttle = Soft
   - `CarbonBudgetEnforcement_HardThrottle_At100Percent()` -- set 1000g, record 1000g, evaluate throttle = Hard
   - `CarbonBudgetEnforcement_CanProceed_ReturnsFalseWhenExhausted()` -- set 100g, record 100g, CanProceed(10g) = false
   - `CarbonBudgetStore_ResetExpiredBudgets_AdvancesPeriod()` -- create budget with past PeriodEnd, call reset, verify new period and zero usage

3. **Green Score Tests:**
   - `BackendGreenScoreRegistry_ScoresCorrectly()` -- register 100% renewable backend (PUE 1.1) and 40% renewable (PUE 1.5), verify first scores higher
   - `BackendGreenScoreRegistry_GetBestBackend_ReturnsHighestScore()` -- register 3 backends, verify GetBestBackend returns the greenest
   - `GreenPlacementService_SelectsGreenestBackend()` -- verify placement decision picks highest-scored backend

4. **GHG Reporting Tests:**
   - `GhgProtocolReporting_Scope2_CalculatesFromEnergyAndIntensity()` -- provide 100 Wh at 400 gCO2e/kWh, verify ~40g CO2e reported
   - `GhgProtocolReporting_Scope3_IncludesDataTransfer()` -- provide 1GB transfer, verify Scope 3 entry with emission factor
   - `CarbonReportingService_GetCarbonSummary_AggregatesAllData()` -- verify summary includes total emissions, renewable %, top region

5. **Green Tiering Tests:**
   - `GreenTieringPolicy_DefaultValues()` -- verify default ColdThreshold=30d, TargetGreenScore=80
   - `GreenTieringStrategy_IdentifiesColdData()` -- create migration candidate with LastAccessed > 30d ago, verify identified
   - `ColdDataMigration_CalculatesCarbonSavings()` -- migrate from 600 gCO2e/kWh to 20 gCO2e/kWh, verify positive savings

Use temporary directories for any file-based persistence (CarbonBudgetStore). Clean up in Dispose/finally.
  </action>
  <verify>`dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter "FullyQualifiedName~CarbonAwareLifecycle" --no-restore` -- all tests pass.</verify>
  <done>20+ integration tests pass covering energy measurement, carbon budgets, green scoring, GHG reporting, and green tiering.</done>
</task>

</tasks>

<verification>
- Full solution build passes: `dotnet build DataWarehouse.slnx` with 0 errors
- All tests pass: `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter CarbonAwareLifecycle`
- CarbonReportingService implements ICarbonReportingService
- GHG reports include both Scope 2 and Scope 3 entries
</verification>

<success_criteria>
Carbon reporting API complete with GHG Protocol compliance (Scope 2 + 3), dashboard time-series data, and comprehensive test coverage for the entire carbon-aware lifecycle.
</success_criteria>

<output>
After completion, create `.planning/phases/62-carbon-aware/62-06-SUMMARY.md`
</output>
