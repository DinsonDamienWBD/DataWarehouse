---
phase: 53-security-wiring
plan: 08
type: execute
wave: 3
depends_on: []
files_modified:
  - Plugins/DataWarehouse.Plugins.AedsCore/MqttControlPlanePlugin.cs
  - Plugins/DataWarehouse.Plugins.AedsCore/WebSocketControlPlanePlugin.cs
  - Plugins/DataWarehouse.Plugins.UltimateInterface/Strategies/GraphQlConnectorStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateConnector/Strategies/IoT/CoApConnectionStrategy.cs
autonomous: true

must_haves:
  truths:
    - "MQTT control plane enforces topic-level authorization"
    - "WebSocket control plane validates Origin headers"
    - "GraphQL has query depth limiting and introspection disabled in production"
    - "CoAP client documents DTLS requirement for production"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.AedsCore/MqttControlPlanePlugin.cs"
      provides: "Topic-level ACL for MQTT"
      contains: "TopicAuthorization|AuthorizeTopic|TopicAcl"
    - path: "Plugins/DataWarehouse.Plugins.UltimateInterface/Strategies/GraphQlConnectorStrategy.cs"
      provides: "Query depth limiting"
      contains: "MaxDepth|DepthLimit|maxQueryDepth"
  key_links:
    - from: "MqttControlPlanePlugin.cs"
      to: "Topic authorization check"
      via: "Verify client has access before allowing subscribe/publish"
      pattern: "Authorize|TopicAcl"
---

<objective>
Fix application-layer protocol vulnerabilities: MQTT topic ACL, WebSocket origin validation, GraphQL depth limiting, CoAP DTLS.

Purpose: Resolves NET-04 (CVSS 7.5 -- MQTT no topic ACL), NET-07 (CVSS 6.1 -- WebSocket origin), NET-08 (CVSS 5.3 -- GraphQL introspection/depth), NET-05 (CVSS 7.5 -- CoAP no DTLS). These are the application-layer network findings.

Output: All control plane protocols have appropriate security controls.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/47-penetration-testing/47-v4.5-PENTEST-REPORT.md
@.planning/phases/47-penetration-testing/v4.5-06-NETWORK-FINDINGS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MQTT topic ACL and WebSocket origin validation</name>
  <files>
    Plugins/DataWarehouse.Plugins.AedsCore/MqttControlPlanePlugin.cs,
    Plugins/DataWarehouse.Plugins.AedsCore/WebSocketControlPlanePlugin.cs
  </files>
  <action>
  **NET-04: MQTT no topic-level authorization (CVSS 7.5)**

  In MqttControlPlanePlugin.cs:
  1. Find where MQTT clients subscribe to topics
  2. Add topic-level authorization:
     - Define allowed topic patterns per client role:
       * `aeds/client/{clientId}/#` -- each client can only access their own namespace
       * `aeds/manifest/#` -- restricted to authorized manifest publishers
       * `aeds/control/#` -- admin only
     - On subscribe request: validate the topic against the client's allowed patterns
     - On publish: validate that the client has publish rights to the topic
  3. If using MQTTnet, implement `InterceptingSubscriptionAsync` and `InterceptingPublishAsync` handlers:
     ```csharp
     // In MQTT server configuration
     server.InterceptingSubscriptionAsync += args =>
     {
         var clientId = args.ClientId;
         var topic = args.TopicFilter.Topic;
         if (!IsTopicAllowed(clientId, topic))
         {
             args.ProcessSubscription = false;
             args.Response.ReasonCode = MqttSubscribeReasonCode.NotAuthorized;
         }
         return Task.CompletedTask;
     };
     ```
  4. Log all authorization denials for audit

  **NET-07: WebSocket missing Origin validation (CVSS 6.1)**

  In WebSocketControlPlanePlugin.cs (line ~108-117):
  1. Add Origin header validation on WebSocket upgrade requests
  2. Maintain a list of allowed origins (configurable, default: same-origin only)
  3. Reject WebSocket connections from unauthorized origins:
     ```csharp
     var origin = request.Headers["Origin"];
     if (!string.IsNullOrEmpty(origin) && !_allowedOrigins.Contains(origin))
     {
         // Reject connection
         context.Response.StatusCode = 403;
         return;
     }
     ```
  4. When no allowed origins configured, default to rejecting all cross-origin requests
  </action>
  <verify>
  - `dotnet build Plugins/DataWarehouse.Plugins.AedsCore/DataWarehouse.Plugins.AedsCore.csproj` succeeds
  - `grep -rn "TopicAuthorization\|AuthorizeTopic\|IsTopicAllowed\|InterceptingSubscription" Plugins/DataWarehouse.Plugins.AedsCore/MqttControlPlanePlugin.cs` returns matches
  - `grep -rn "Origin\|_allowedOrigins" Plugins/DataWarehouse.Plugins.AedsCore/WebSocketControlPlanePlugin.cs` returns matches
  - Full solution builds with 0 errors
  </verify>
  <done>
  - NET-04 (CVSS 7.5) RESOLVED: MQTT has topic-level authorization
  - NET-07 (CVSS 6.1) RESOLVED: WebSocket validates Origin headers
  </done>
</task>

<task type="auto">
  <name>Task 2: Add GraphQL depth limiting and CoAP DTLS guidance</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateInterface/Strategies/GraphQlConnectorStrategy.cs,
    Plugins/DataWarehouse.Plugins.UltimateConnector/Strategies/IoT/CoApConnectionStrategy.cs
  </files>
  <action>
  **NET-08: GraphQL introspection and no depth limiting (CVSS 5.3)**

  In GraphQlConnectorStrategy.cs (line ~88-94):
  1. Add query depth limiting:
     - Implement a recursive depth counter that walks the query AST
     - Default max depth: 10 (configurable)
     - Reject queries exceeding max depth with a clear error message
  2. Disable introspection in production:
     - Add a `_enableIntrospection` configuration option (default: false)
     - When false: intercept and reject `__schema` and `__type` queries
     - When true (dev mode): allow introspection with warning log
  3. Add query complexity analysis (optional, if the GraphQL library supports it):
     - Assign cost to each field resolver
     - Reject queries exceeding cost threshold
  4. If the strategy uses a GraphQL library (HotChocolate, GraphQL.NET), use the library's built-in depth/complexity limiters

  **NET-05: CoAP no DTLS (CVSS 7.5)**

  In CoApConnectionStrategy.cs and CoApClient.cs:
  1. Check if the CoAP library (CoAP.NET or similar) supports DTLS
  2. If DTLS is supported:
     - Add a `UseDtls` configuration option (default: true)
     - When true: configure DTLS 1.2+ with proper certificate validation
     - When false: log a security warning
  3. If DTLS is NOT supported by the library:
     - Add a prominent warning comment: "// SECURITY: CoAP transport is unencrypted. Use IPSec or VPN tunnel for production."
     - Log a warning on startup: "CoAP operating without DTLS -- transport is unencrypted"
     - Add a configuration option `AllowInsecureCoap` (default: false) that must be explicitly set to use unencrypted CoAP
     - When false and no DTLS: throw on initialization with message explaining the risk
  4. Fix sequential CoAP message IDs (mentioned in pentest): randomize the initial message ID using CSPRNG
  </action>
  <verify>
  - `grep -rn "MaxDepth\|DepthLimit\|maxQueryDepth" Plugins/DataWarehouse.Plugins.UltimateInterface/Strategies/GraphQlConnectorStrategy.cs` returns matches
  - `grep -rn "__schema\|introspection\|Introspection" Plugins/DataWarehouse.Plugins.UltimateInterface/Strategies/GraphQlConnectorStrategy.cs` returns matches
  - `grep -rn "DTLS\|Dtls\|AllowInsecureCoap" Plugins/DataWarehouse.Plugins.UltimateConnector/Strategies/IoT/CoApConnectionStrategy.cs` returns matches
  - `dotnet build` full solution with 0 errors
  </verify>
  <done>
  - NET-08 (CVSS 5.3) RESOLVED: GraphQL has depth limiting and introspection control
  - NET-05 (CVSS 7.5) MITIGATED: CoAP DTLS requirement enforced or documented with fail-safe
  - Sequential CoAP message IDs randomized
  - Solution builds with 0 errors
  </done>
</task>

</tasks>

<verification>
- Full solution builds with 0 errors
- MQTT has topic-level authorization
- WebSocket validates origins
- GraphQL has depth limiting
- CoAP has DTLS requirement or fail-safe
</verification>

<success_criteria>
- NET-04, NET-05, NET-07, NET-08 all RESOLVED or MITIGATED
- All application-layer protocols have appropriate security controls
</success_criteria>

<output>
After completion, create `.planning/phases/53-security-wiring/53-08-SUMMARY.md`
</output>
