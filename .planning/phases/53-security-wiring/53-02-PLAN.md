---
phase: 53-security-wiring
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.Kernel/DataWarehouseKernel.cs
  - DataWarehouse.Kernel/Plugins/PluginLoader.cs
  - DataWarehouse.SDK/Contracts/PluginBase.cs
autonomous: true

must_haves:
  truths:
    - "Kernel loads all plugin assemblies through PluginLoader with hash/signature validation"
    - "Assembly.LoadFrom is never called directly in kernel plugin loading"
    - "PluginBase.InjectKernelServices is sealed to prevent reflection-based override"
    - "Plugin StopAsync has a timeout to prevent resource exhaustion"
  artifacts:
    - path: "DataWarehouse.Kernel/DataWarehouseKernel.cs"
      provides: "Secure plugin loading through PluginLoader"
      contains: "PluginLoader"
    - path: "DataWarehouse.SDK/Contracts/PluginBase.cs"
      provides: "Sealed InjectKernelServices method"
  key_links:
    - from: "DataWarehouseKernel.cs"
      to: "PluginLoader"
      via: "LoadPlugin method call"
      pattern: "PluginLoader.*Load"
---

<objective>
Secure plugin loading and isolation -- route kernel assembly loading through PluginLoader and seal reflection attack vectors.

Purpose: Resolves ISO-02/INFRA-01 (CVSS 8.8 -- kernel bypasses PluginLoader), ISO-01 (CVSS 9.4 -- reflection escape via InjectKernelServices), ISO-04 (CVSS 7.1 -- no StopAsync timeout). These are Root Cause 4 from the pentest report.

Output: All plugin loading goes through validated PluginLoader; InjectKernelServices is sealed; plugin shutdown has timeout.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/47-penetration-testing/47-v4.5-PENTEST-REPORT.md
@.planning/phases/47-penetration-testing/v4.5-03-BUS-FINDINGS.md
@.planning/phases/47-penetration-testing/47-v4.5-07-INFRA-FINDINGS.md
@.planning/PLUGIN-CATALOG.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Route kernel plugin loading through PluginLoader</name>
  <files>DataWarehouse.Kernel/DataWarehouseKernel.cs</files>
  <action>
  In DataWarehouseKernel.cs, find the `LoadPluginsFromAssemblyAsync` method (around line 421-423) that uses `Assembly.LoadFrom()` directly.

  Replace with:
  1. Use the existing PluginLoader from the SDK (check DataWarehouse.SDK for PluginLoader class location)
  2. Call `PluginLoader.LoadPlugin(assemblyPath)` or equivalent instead of `Assembly.LoadFrom(assemblyPath)`
  3. PluginLoader already has: hash verification, signature check, size limits, blocklist, collectible AssemblyLoadContext
  4. If PluginLoader is not already instantiated in the kernel, create one during kernel initialization
  5. Remove or comment out any direct `Assembly.LoadFrom` calls in the kernel

  Also check DataWarehouse.Dashboard/Services/PluginDiscoveryService if it has similar Assembly.LoadFrom patterns and fix those too.

  IMPORTANT: Verify that the PluginLoader's AssemblyLoadContext approach is compatible with how plugins interact with the kernel. Plugins need to share SDK types (loaded in the default context), so the PluginLoader should use a shared AssemblyLoadContext that loads SDK types from the host but isolates plugin-specific assemblies.

  Set `RequireSignedAssemblies = true` as the default in the PluginLoader configuration (fixes ISO-05 partially). Add a configuration option to override for development mode only.
  </action>
  <verify>
  - `dotnet build DataWarehouse.Kernel/DataWarehouse.Kernel.csproj` succeeds
  - `grep -r "Assembly.LoadFrom" DataWarehouse.Kernel/` returns zero results
  - `grep -r "PluginLoader" DataWarehouse.Kernel/DataWarehouseKernel.cs` returns at least one result
  - Full solution builds with 0 errors
  </verify>
  <done>
  - ISO-02 (CVSS 8.8) RESOLVED: Kernel uses PluginLoader for all assembly loading
  - INFRA-01 (CVSS 7.2) RESOLVED: Assembly.LoadFrom removed from kernel
  - ISO-05 (CVSS 7.7) PARTIALLY RESOLVED: RequireSignedAssemblies defaults to true
  - No direct Assembly.LoadFrom in kernel code
  </done>
</task>

<task type="auto">
  <name>Task 2: Seal InjectKernelServices and add plugin shutdown timeout</name>
  <files>DataWarehouse.SDK/Contracts/PluginBase.cs, DataWarehouse.Kernel/DataWarehouseKernel.cs</files>
  <action>
  1. In PluginBase.cs, find `InjectKernelServices` method (around line 836):
     - Change from `public virtual void InjectKernelServices(...)` to `public sealed void InjectKernelServices(...)`
     - This prevents any plugin from overriding the method to intercept kernel service references via reflection
     - If any plugin legitimately overrides this (check with grep), extract the override logic into a protected virtual `OnKernelServicesInjected()` callback that is called at the end of the sealed method

  2. In DataWarehouseKernel.cs, find where plugins are stopped (likely `StopAsync` calls around line 499-510):
     - Wrap each plugin's StopAsync in a timeout: `await plugin.StopAsync(ct).WaitAsync(TimeSpan.FromSeconds(30), ct)`
     - If a plugin exceeds the timeout, log a warning and continue stopping other plugins
     - This prevents a malicious or buggy plugin from blocking shutdown indefinitely (ISO-04)

  3. Check if there are shared mutable statics exposed to plugins (ISO-03):
     - Look at CompressionStrategy.cs:481 and BoundedMemoryRuntime.cs:42 mentioned in the pentest
     - If static fields are shared across plugin boundaries, make them thread-safe or per-plugin scoped
     - At minimum, document the shared state risk in a code comment

  grep first to verify:
  - `grep -rn "override.*InjectKernelServices" --include="*.cs"` to find any overrides
  - `grep -rn "StopAsync" DataWarehouse.Kernel/DataWarehouseKernel.cs` to find shutdown code
  </action>
  <verify>
  - `dotnet build` full solution builds with 0 errors
  - `grep -rn "sealed.*InjectKernelServices\|InjectKernelServices.*sealed" DataWarehouse.SDK/Contracts/PluginBase.cs` confirms sealed
  - No compilation errors from plugins that previously overrode the method
  - Plugin shutdown timeout is present in kernel
  </verify>
  <done>
  - ISO-01 (CVSS 9.4) MITIGATED: InjectKernelServices is sealed, preventing reflection-based override
  - ISO-04 (CVSS 7.1) RESOLVED: Plugin StopAsync has 30-second timeout
  - ISO-03 (CVSS 5.9) DOCUMENTED: Shared mutable state risk noted
  - Solution builds with 0 errors
  </done>
</task>

</tasks>

<verification>
- Full solution builds with 0 errors, 0 new warnings
- No Assembly.LoadFrom in kernel
- InjectKernelServices is sealed
- Plugin shutdown has timeout
</verification>

<success_criteria>
- ISO-02/INFRA-01 RESOLVED: Plugin loading through PluginLoader with validation
- ISO-01 MITIGATED: Sealed InjectKernelServices prevents reflection escape
- ISO-04 RESOLVED: Plugin shutdown timeout prevents resource exhaustion
- ISO-05 PARTIALLY RESOLVED: Signed assemblies required by default
- Full solution compiles
</success_criteria>

<output>
After completion, create `.planning/phases/53-security-wiring/53-02-SUMMARY.md`
</output>
