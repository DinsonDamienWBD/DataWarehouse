---
phase: 53-security-wiring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.Kernel/DataWarehouseKernel.cs
  - DataWarehouse.SDK/Security/AccessEnforcementInterceptor.cs
  - DataWarehouse.SDK/Security/AccessVerificationMatrix.cs
autonomous: true

must_haves:
  truths:
    - "Message bus enforces access control on every publish/subscribe operation"
    - "Plugins receive an access-enforced bus wrapper, not the raw DefaultMessageBus"
    - "Null-identity messages are rejected by the interceptor"
    - "System topics (system.startup, system.shutdown) remain accessible for bootstrap"
  artifacts:
    - path: "DataWarehouse.Kernel/DataWarehouseKernel.cs"
      provides: "Wired AccessEnforcementInterceptor around DefaultMessageBus"
      contains: "WithAccessEnforcement"
    - path: "DataWarehouse.SDK/Security/AccessEnforcementInterceptor.cs"
      provides: "Access control enforcement on message bus"
  key_links:
    - from: "DataWarehouseKernel.cs"
      to: "AccessEnforcementInterceptor.cs"
      via: "WithAccessEnforcement() extension method"
      pattern: "WithAccessEnforcement"
    - from: "DataWarehouseKernel.cs"
      to: "PluginBase.InjectKernelServices"
      via: "Passes enforced bus instead of raw bus"
      pattern: "_enforcedBus|enforcedMessageBus"
---

<objective>
Wire the AccessEnforcementInterceptor into the kernel runtime -- the single highest-impact security fix.

Purpose: The AccessEnforcementInterceptor exists in the SDK as fully implemented dead code. Wiring it resolves 6 findings (AUTH-01, AUTH-08, AUTH-09, AUTH-10, BUS-01 partial, BUS-05 partial) with CVSS scores up to 9.8. This is Root Cause 1 from the pentest report.

Output: DataWarehouseKernel passes an access-enforced message bus to all plugins instead of the raw DefaultMessageBus.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/47-penetration-testing/47-v4.5-PENTEST-REPORT.md
@.planning/phases/47-penetration-testing/v4.5-02-AUTH-FINDINGS.md
@.planning/phases/47-penetration-testing/v4.5-03-BUS-FINDINGS.md
@.planning/PLUGIN-CATALOG.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire AccessEnforcementInterceptor in DataWarehouseKernel</name>
  <files>DataWarehouse.Kernel/DataWarehouseKernel.cs, DataWarehouse.SDK/Security/AccessEnforcementInterceptor.cs</files>
  <action>
  In DataWarehouseKernel.cs, after creating the DefaultMessageBus at line ~112:

  1. Keep the raw `_messageBus = new DefaultMessageBus(logger)` for kernel-internal use (system topics during bootstrap)
  2. Create an enforced wrapper: `_enforcedMessageBus = _messageBus.WithAccessEnforcement(accessMatrix, logger)` where accessMatrix is an AccessVerificationMatrix instance
  3. At line ~200 where `pluginBase.InjectKernelServices(_messageBus, ...)` is called, change to pass `_enforcedMessageBus` instead of `_messageBus`
  4. The AccessEnforcementInterceptor already has bypass logic for system topics (system.startup, system.shutdown, etc.) -- verify this is adequate for kernel bootstrap sequence
  5. Ensure the AccessVerificationMatrix is constructed with a reasonable default policy: plugins can publish/subscribe to their own domain topics, kernel topics require kernel identity
  6. Add a private field `_enforcedMessageBus` of type IMessageBus

  Review AccessEnforcementInterceptor.cs to confirm:
  - It checks `message.Identity` on every publish (rejects null identity)
  - It evaluates AccessVerificationMatrix for topic authorization
  - The bypass list for system topics is correct
  - The WithAccessEnforcement extension method signature matches what we need

  If the AccessVerificationMatrix needs a default configuration, create one that:
  - Allows all plugins to subscribe to their own registered topic prefixes
  - Denies cross-plugin publish to security.*, kernel.*, system.* topics
  - Allows publish to storage.*, pipeline.*, intelligence.* for inter-plugin collaboration with identity attached

  IMPORTANT: Do NOT break the kernel bootstrap sequence. The kernel needs to publish system.startup before plugins are fully initialized. The raw bus should be used for kernel-internal messages, enforced bus for plugin-facing communication.
  </action>
  <verify>
  - `dotnet build DataWarehouse.Kernel/DataWarehouse.Kernel.csproj` succeeds with 0 errors
  - `grep -r "WithAccessEnforcement" DataWarehouse.Kernel/` returns at least one result
  - `grep -r "_messageBus" DataWarehouse.Kernel/DataWarehouseKernel.cs` shows the raw bus is NOT passed to InjectKernelServices
  - `dotnet build` full solution builds with 0 errors
  </verify>
  <done>
  - AccessEnforcementInterceptor is instantiated in DataWarehouseKernel
  - Plugins receive the enforced message bus, not the raw DefaultMessageBus
  - Kernel bootstrap (system.startup/shutdown) still works through raw bus
  - Findings AUTH-01, AUTH-08, AUTH-10, BUS-01 (partial) are resolved
  - Solution builds with 0 errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure default AccessVerificationMatrix topic policies</name>
  <files>DataWarehouse.SDK/Security/AccessVerificationMatrix.cs, DataWarehouse.Kernel/DataWarehouseKernel.cs</files>
  <action>
  Configure the AccessVerificationMatrix with production-ready default policies:

  1. Read AccessVerificationMatrix.cs to understand its policy model (levels, roles, topic patterns)
  2. Create a default configuration method (or static factory) that establishes:
     - DENY by default (fail-closed)
     - System topics (system.*) -- kernel only
     - Security topics (security.*) -- UltimateAccessControl, UltimateEncryption, UltimateKeyManagement only
     - Kernel topics (kernel.*) -- kernel only
     - Storage topics (storage.*) -- any plugin with identity, read-only subscribe for observability
     - Pipeline topics (pipeline.*) -- any plugin with identity
     - Intelligence topics (intelligence.*) -- any plugin with identity (UltimateIntelligence primary publisher)
     - Plugin-specific topics ({pluginName}.*) -- owning plugin only for publish, any authenticated for subscribe
     - Compliance topics (compliance.*) -- UltimateCompliance primary, any can publish tamper alerts
     - Config topics (config.*) -- kernel only for publish, any for subscribe

  3. Wire this default configuration into DataWarehouseKernel.cs when constructing the AccessVerificationMatrix

  4. Ensure tenant isolation: if CommandIdentity has a TenantId, messages should be scoped to that tenant's namespace (AUTH-09 fix)

  5. Ensure the matrix handles pattern subscriptions securely -- wildcard "*" subscriptions should be denied unless the subscriber has admin/kernel identity (BUS-05 fix)

  The goal is a REASONABLE default policy, not perfect granularity. Plugins that need cross-domain communication will work because they have valid identity -- the interceptor blocks anonymous/null-identity messages.
  </action>
  <verify>
  - `dotnet build` full solution builds with 0 errors
  - AccessVerificationMatrix has a default configuration that denies null-identity
  - Wildcard pattern subscriptions are restricted
  - grep confirms topic policy setup in kernel initialization
  </verify>
  <done>
  - Default topic authorization matrix configured with fail-closed policy
  - System/kernel/security topics restricted to appropriate plugins
  - Wildcard subscriptions denied for non-admin identities (BUS-05)
  - Tenant isolation enforced via identity scoping (AUTH-09)
  - AUTH-09, BUS-05 findings resolved
  </done>
</task>

</tasks>

<verification>
- Full solution builds with 0 errors, 0 new warnings
- AccessEnforcementInterceptor is wired (not dead code)
- grep for "WithAccessEnforcement" returns kernel usage
- Plugins receive enforced bus
- No regression in kernel bootstrap sequence
</verification>

<success_criteria>
- AUTH-01 (CVSS 9.8) RESOLVED: AccessEnforcementInterceptor wired
- AUTH-08 (CVSS 8.8) RESOLVED: Bus enforces identity
- AUTH-09 (CVSS 6.5) RESOLVED: Tenant isolation via identity
- AUTH-10 (CVSS 8.4) RESOLVED: Plugins get enforced bus, not raw
- BUS-01 (CVSS 9.1) PARTIALLY RESOLVED: Topic injection blocked by policy
- BUS-05 (CVSS 7.5) RESOLVED: Wildcard subscriptions restricted
</success_criteria>

<output>
After completion, create `.planning/phases/53-security-wiring/53-01-SUMMARY.md`
</output>
