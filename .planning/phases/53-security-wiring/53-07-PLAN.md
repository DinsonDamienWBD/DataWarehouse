---
phase: 53-security-wiring
plan: 07
type: execute
wave: 3
depends_on: []
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Network/SmbStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Network/WebDavStrategy.cs
  - DataWarehouse.SDK/VirtualDiskEngine/Metadata/NamespaceTree.cs
  - DataWarehouse.Launcher/LauncherHttpServer.cs
autonomous: true

must_haves:
  truths:
    - "SMB storage strategy validates paths against traversal attacks"
    - "WebDAV strategy validates paths against traversal attacks"
    - "VDE symlink resolution has a depth limit preventing infinite loops"
    - "Launcher API key comparison is constant-time"
    - "API key is not logged in plaintext"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Network/SmbStrategy.cs"
      provides: "Path traversal protection matching LocalFileStrategy pattern"
      contains: "GetFullPath|traversal"
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Metadata/NamespaceTree.cs"
      provides: "Symlink depth limit"
      contains: "MaxSymlinkDepth|symlinkDepth"
  key_links:
    - from: "SmbStrategy.cs"
      to: "Path.GetFullPath validation"
      via: "Canonicalize and prefix check"
      pattern: "GetFullPath.*StartsWith"
---

<objective>
Fix data path vulnerabilities: path traversal in SMB/WebDAV, VDE symlink DoS, and Launcher API timing attack.

Purpose: Resolves D01 (CVSS 7.5 -- SMB path traversal), D03 (CVSS 5.4 -- WebDAV path traversal), D02 (CVSS 5.3 -- VDE symlink loop), AUTH-03 (CVSS 5.9 -- API key timing attack + plaintext logging). These are the input validation findings from Root Cause 5.

Output: All storage strategies validate paths; VDE has symlink depth limit; API key comparisons are constant-time.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/47-penetration-testing/47-v4.5-PENTEST-REPORT.md
@.planning/phases/47-penetration-testing/v4.5-04-DATA-FINDINGS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix path traversal in SMB and WebDAV strategies</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Network/SmbStrategy.cs,
    Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Network/WebDavStrategy.cs
  </files>
  <action>
  **D01: SMB path traversal (CVSS 7.5)**

  In SmbStrategy.cs, find `GetFilePath` method (line ~769-781):
  1. Add the same path traversal protection used by LocalFileStrategy, NvmeStrategy, ScmStrategy, and NfsStrategy:
     ```csharp
     private string GetFilePath(string key)
     {
         var relativePath = NormalizePath(key);
         if (string.IsNullOrEmpty(_basePath))
             return relativePath;

         var combinedPath = string.IsNullOrEmpty(relativePath)
             ? _basePath
             : Path.Combine(_basePath, relativePath).Replace('/', '\\');

         // Path traversal protection
         var fullPath = Path.GetFullPath(combinedPath);
         var normalizedBasePath = Path.GetFullPath(_basePath);
         if (!fullPath.StartsWith(normalizedBasePath, StringComparison.OrdinalIgnoreCase))
             throw new UnauthorizedAccessException("Path traversal attempt detected");

         return fullPath;
     }
     ```
  2. Also check `NormalizePath` to ensure it doesn't strip `..` sequences before the check

  **D03: WebDAV path traversal (CVSS 5.4)**

  In WebDavStrategy.cs (line ~1086-1091), find the path construction method:
  1. Add the same Path.GetFullPath + StartsWith validation pattern
  2. For WebDAV, the base path is a URL -- use Uri.GetLeftPart and string comparison for URL-based paths
  3. Reject keys containing `..`, `//`, `\`, or URL-encoded traversal sequences (`%2e%2e`, `%2f`)
  4. If the strategy uses a local path for caching, apply the file path traversal check there too

  grep for any other storage strategies that might be missing the check:
  `grep -rn "Path.Combine.*_basePath" Plugins/DataWarehouse.Plugins.UltimateStorage/` and cross-reference with `grep -rn "GetFullPath" Plugins/DataWarehouse.Plugins.UltimateStorage/` to find strategies that combine paths but don't validate.
  </action>
  <verify>
  - `grep -rn "GetFullPath" Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Network/SmbStrategy.cs` returns a match
  - `grep -rn "traversal\|GetFullPath" Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Network/WebDavStrategy.cs` returns a match
  - `dotnet build Plugins/DataWarehouse.Plugins.UltimateStorage/DataWarehouse.Plugins.UltimateStorage.csproj` succeeds
  - Full solution builds with 0 errors
  </verify>
  <done>
  - D01 (CVSS 7.5) RESOLVED: SMB strategy has path traversal protection
  - D03 (CVSS 5.4) RESOLVED: WebDAV strategy has path traversal protection
  - Pattern consistent with already-secure LocalFile, NVMe, SCM, NFS strategies
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix VDE symlink loop, API key timing attack, and plaintext logging</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/Metadata/NamespaceTree.cs,
    DataWarehouse.Launcher/LauncherHttpServer.cs
  </files>
  <action>
  **D02: VDE symlink infinite loop DoS (CVSS 5.3)**

  In NamespaceTree.cs (line ~74-87), find the symlink resolution method:
  1. Add a `MaxSymlinkDepth` constant (e.g., 40, matching Linux's MAXSYMLINKS)
  2. Track recursion depth during symlink resolution
  3. If depth exceeds MaxSymlinkDepth, throw an exception (IOException with "Too many levels of symbolic links")
  4. This prevents A->B->A circular symlink chains from infinite looping

  **AUTH-03: Launcher API key timing attack + plaintext logging (CVSS 5.9)**

  In LauncherHttpServer.cs:
  1. At line ~164, find the API key comparison:
     - Replace string equality (`==` or `.Equals`) with `CryptographicOperations.FixedTimeEquals`
     - Convert both strings to UTF8 bytes first:
       ```csharp
       var expected = Encoding.UTF8.GetBytes(configuredApiKey);
       var actual = Encoding.UTF8.GetBytes(providedApiKey);
       if (!CryptographicOperations.FixedTimeEquals(expected, actual))
       {
           // Reject
       }
       ```
  2. At line ~80, find the plaintext API key logging:
     - Replace with masked logging: log only the first 4 characters followed by "****"
     - Or better: log only the hash of the key for correlation: `SHA256(key)[:8]`
     - NEVER log the full API key

  **AUTH-07: Rate limiting bypassable via proxy (CVSS 4.3)**
  In LauncherHttpServer.cs (line ~119):
  1. Check if rate limiting uses only the direct IP
  2. Add X-Forwarded-For handling: when behind a trusted proxy, use the original client IP
  3. BUT: only trust X-Forwarded-For from configured trusted proxy IPs to prevent header spoofing
  4. If no trusted proxies configured, always use the direct connection IP
  </action>
  <verify>
  - `grep -rn "MaxSymlinkDepth\|symlinkDepth" DataWarehouse.SDK/VirtualDiskEngine/Metadata/NamespaceTree.cs` returns a match
  - `grep -rn "FixedTimeEquals" DataWarehouse.Launcher/LauncherHttpServer.cs` returns a match
  - `grep -rn "ApiKey.*=\|key.*=\|Key.*=" DataWarehouse.Launcher/LauncherHttpServer.cs` does NOT show plaintext key in log statements
  - `dotnet build` full solution with 0 errors
  </verify>
  <done>
  - D02 (CVSS 5.3) RESOLVED: VDE symlink resolution has depth limit
  - AUTH-03 (CVSS 5.9) RESOLVED: Constant-time API key comparison, no plaintext logging
  - AUTH-07 (CVSS 4.3) RESOLVED: Rate limiting uses correct client IP
  - Solution builds with 0 errors
  </done>
</task>

</tasks>

<verification>
- Full solution builds with 0 errors
- Path traversal tests would fail on `../../` keys
- Symlink depth is bounded
- API key comparison is constant-time
</verification>

<success_criteria>
- D01, D02, D03, AUTH-03, AUTH-07 all RESOLVED
- All storage strategies have consistent path traversal protection
- VDE is resilient to symlink-based DoS
- Launcher API key handling is secure
</success_criteria>

<output>
After completion, create `.planning/phases/53-security-wiring/53-07-SUMMARY.md`
</output>
