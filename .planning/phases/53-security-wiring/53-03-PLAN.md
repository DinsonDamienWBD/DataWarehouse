---
phase: 53-security-wiring
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Specialized/GrpcStorageStrategy.cs
  - Plugins/DataWarehouse.Plugins.AedsCore/GrpcControlPlanePlugin.cs
  - Plugins/DataWarehouse.Plugins.UltimateDataTransit/Strategies/Direct/FtpTransitStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateKeyManagement/Strategies/Hsm/AwsCloudHsmStrategy.cs
  - DataWarehouse.Dashboard/Program.cs
  - DataWarehouse.Dashboard/Hubs/DashboardHub.cs
autonomous: true

must_haves:
  truths:
    - "GrpcStorageStrategy validates TLS certificates by default (no unconditional return true)"
    - "GrpcControlPlanePlugin uses SslCredentials when connecting to HTTPS endpoints"
    - "FtpTransitStrategy validates certificates by default with configurable override"
    - "DashboardHub requires authentication via [Authorize] attribute"
    - "JWT development secret is randomly generated per startup, not hardcoded"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Specialized/GrpcStorageStrategy.cs"
      provides: "Configurable TLS validation with secure default"
    - path: "DataWarehouse.Dashboard/Hubs/DashboardHub.cs"
      provides: "Authenticated SignalR hub"
      contains: "[Authorize]"
  key_links:
    - from: "GrpcStorageStrategy.cs"
      to: "TLS validation"
      via: "Certificate callback with configurable bypass"
      pattern: "_validateCertificate|_verifySsl"
---

<objective>
Fix all critical and high TLS/certificate bypasses and Dashboard authentication gaps.

Purpose: Resolves NET-01 (CVSS 9.1), NET-02 (CVSS 8.7), NET-03 (CVSS 7.4), NET-06 (CVSS 6.5), AUTH-02 (CVSS 8.1), AUTH-04 (CVSS 7.5). These represent the remaining unconditional TLS bypasses and authentication gaps.

Output: All TLS connections validate certificates by default; Dashboard SignalR hub requires auth; JWT dev secret is random.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/47-penetration-testing/47-v4.5-PENTEST-REPORT.md
@.planning/phases/47-penetration-testing/v4.5-06-NETWORK-FINDINGS.md
@.planning/phases/47-penetration-testing/v4.5-02-AUTH-FINDINGS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix TLS certificate validation bypasses (NET-01, NET-02, NET-03, NET-06)</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Specialized/GrpcStorageStrategy.cs,
    Plugins/DataWarehouse.Plugins.AedsCore/GrpcControlPlanePlugin.cs,
    Plugins/DataWarehouse.Plugins.UltimateDataTransit/Strategies/Direct/FtpTransitStrategy.cs,
    Plugins/DataWarehouse.Plugins.UltimateKeyManagement/Strategies/Hsm/AwsCloudHsmStrategy.cs
  </files>
  <action>
  Fix each TLS bypass following the pattern already used by the 13 fixed strategies (configurable with secure default):

  **NET-01: GrpcStorageStrategy.cs (line 160-163)**
  - Replace `RemoteCertificateValidationCallback = (_, _, _, _) => true` with configurable validation
  - Add a `_validateCertificate` field initialized from options/config (default: true)
  - When true: use default .NET certificate validation (remove the callback entirely, or check `sslPolicyErrors == SslPolicyErrors.None`)
  - When false (opt-in for dev): keep the bypass with a warning log
  - Follow the exact same pattern used by RestStorageStrategy, WebDavStrategy, and other already-fixed strategies
  - Also reduce the 100MB default message size (NET-09, CVSS 3.1): change `MaxReceiveMessageSize` and `MaxSendMessageSize` to 10MB (configurable)

  **NET-02: GrpcControlPlanePlugin.cs (line ~108)**
  - Replace `ChannelCredentials.Insecure` with conditional: if URL starts with "https://", use `new SslCredentials()` (or `ChannelCredentials.SecureSsl`). If "http://", keep insecure for local dev but log a warning.
  - Add a configuration option `UseTls` defaulting to true

  **NET-03: FtpTransitStrategy.cs (line 280)**
  - Replace hardcoded `ValidateAnyCertificate = true` with a configurable `_validateCertificate` field (default: true)
  - When true: set `ValidateAnyCertificate = false` (FluentFTP default validation) or provide a proper callback
  - Follow the same pattern as FtpStrategy.cs which is already fixed

  **NET-06: AwsCloudHsmStrategy.cs (line 229-231)**
  - Fix the fallback that accepts `RemoteCertificateChainErrors` when no CA cert is configured
  - When no CA cert path is provided, use default .NET validation (do NOT fall back to accepting chain errors)
  - Only accept chain errors when a custom CA cert is explicitly provided AND the chain validates against that CA
  </action>
  <verify>
  - `grep -rn "return true" Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Specialized/GrpcStorageStrategy.cs` -- should NOT appear in certificate callbacks
  - `grep -rn "Insecure" Plugins/DataWarehouse.Plugins.AedsCore/GrpcControlPlanePlugin.cs` -- should NOT appear unconditionally
  - `grep -rn "ValidateAnyCertificate = true" Plugins/DataWarehouse.Plugins.UltimateDataTransit/` -- should NOT appear
  - `dotnet build` full solution with 0 errors
  </verify>
  <done>
  - NET-01 (CVSS 9.1) RESOLVED: GrpcStorageStrategy validates certs by default
  - NET-02 (CVSS 8.7) RESOLVED: GrpcControlPlanePlugin uses TLS for HTTPS endpoints
  - NET-03 (CVSS 7.4) RESOLVED: FtpTransitStrategy validates certs by default
  - NET-06 (CVSS 6.5) RESOLVED: HSM strategy doesn't fall back to insecure
  - NET-09 (CVSS 3.1) RESOLVED: gRPC message size reduced to 10MB
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix Dashboard auth gaps (AUTH-02, AUTH-04, AUTH-05)</name>
  <files>DataWarehouse.Dashboard/Program.cs, DataWarehouse.Dashboard/Hubs/DashboardHub.cs</files>
  <action>
  **AUTH-04: DashboardHub missing [Authorize] (CVSS 7.5)**
  - Add `[Authorize]` attribute to the DashboardHub class (line ~10)
  - This is literally one line of code. Ensure the `using Microsoft.AspNetCore.Authorization;` import exists.

  **AUTH-02: JWT dev secret hardcoded (CVSS 8.1)**
  - In Program.cs (line ~29), replace the hardcoded development secret:
    `"DataWarehouse_Development_Secret_Key_At_Least_32_Chars!"`
  - With: generate a random 64-byte key on each development startup using `RandomNumberGenerator.GetBytes(64)` converted to base64
  - This means dev tokens are NOT portable across restarts (acceptable for development)
  - Keep the production path that throws if no key is configured (that's already correct)
  - Log a warning when using auto-generated dev key: "Using ephemeral JWT signing key -- tokens will not survive restart"

  **AUTH-05: Launcher API no HTTPS (CVSS 5.3)**
  - Check DataWarehouse.Launcher/LauncherHttpServer.cs for HTTPS configuration
  - If the HTTP listener doesn't support TLS, add a configuration option `UseHttps` (default: true in production)
  - Add CORS headers restricting to configured origins (fix LOW-07 from original pentest)
  - If full HTTPS is complex (HttpListener TLS requires cert binding on Windows), at minimum:
    a) Add a `X-Forwarded-Proto` check that rejects non-HTTPS in production
    b) Add CORS headers with `Access-Control-Allow-Origin` restricted to configured domains
    c) Document that a reverse proxy (nginx/Kestrel) should terminate TLS for the Launcher API
  </action>
  <verify>
  - `grep -rn "\[Authorize\]" DataWarehouse.Dashboard/Hubs/DashboardHub.cs` returns a match
  - `grep -rn "Development_Secret" DataWarehouse.Dashboard/Program.cs` returns zero matches
  - `dotnet build DataWarehouse.Dashboard/DataWarehouse.Dashboard.csproj` succeeds
  - Full solution builds with 0 errors
  </verify>
  <done>
  - AUTH-04 (CVSS 7.5) RESOLVED: DashboardHub has [Authorize]
  - AUTH-02 (CVSS 8.1) RESOLVED: Dev JWT key is random, not hardcoded
  - AUTH-05 (CVSS 5.3) MITIGATED: CORS restricted, HTTPS documented/configured
  - Solution builds with 0 errors
  </done>
</task>

</tasks>

<verification>
- Full solution builds with 0 errors, 0 new warnings
- Zero unconditional TLS bypasses remain
- Dashboard hub requires authentication
- JWT dev secret is not in source code
</verification>

<success_criteria>
- All 3 remaining unconditional TLS bypasses fixed (NET-01, NET-02, NET-03)
- HSM cert fallback fixed (NET-06)
- DashboardHub authenticated (AUTH-04)
- JWT dev secret randomized (AUTH-02)
- Launcher API HTTPS/CORS addressed (AUTH-05)
</success_criteria>

<output>
After completion, create `.planning/phases/53-security-wiring/53-03-SUMMARY.md`
</output>
