---
phase: 53-security-wiring
plan: 04
type: execute
wave: 2
depends_on: []
files_modified:
  - DataWarehouse.SDK/Infrastructure/Distributed/Consensus/RaftConsensusEngine.cs
  - DataWarehouse.SDK/Infrastructure/Distributed/TcpP2PNetwork.cs
  - Plugins/DataWarehouse.Plugins.Raft/RaftConsensusPlugin.cs
autonomous: true

must_haves:
  truths:
    - "Raft messages are only processed from known cluster members"
    - "Raft TCP connections require authentication (mTLS or HMAC)"
    - "Term inflation is rate-limited to prevent election storm DoS"
    - "Unknown node IDs cannot participate in elections"
  artifacts:
    - path: "DataWarehouse.SDK/Infrastructure/Distributed/Consensus/RaftConsensusEngine.cs"
      provides: "Authenticated Raft message processing with membership verification"
      contains: "membership.*Verify|VerifyMembership|IsKnownMember"
  key_links:
    - from: "RaftConsensusEngine.cs"
      to: "Membership verification"
      via: "Check sender against known members before processing"
      pattern: "IsKnownMember|VerifySender|membership"
---

<objective>
Add authentication and membership verification to Raft consensus protocol.

Purpose: Resolves DIST-01 (CVSS 9.1 -- election hijack), DIST-02 (CVSS 9.1 -- log injection), AUTH-06 (CVSS 8.6 -- unauthenticated Raft). These are the most critical distributed system findings, enabling complete cluster takeover.

Output: Raft only processes messages from verified cluster members; term inflation is bounded; mTLS enforced on Raft TCP.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/47-penetration-testing/47-v4.5-PENTEST-REPORT.md
@.planning/phases/47-penetration-testing/v4.5-05-DISTRIBUTED-FINDINGS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add membership verification to RaftConsensusEngine</name>
  <files>DataWarehouse.SDK/Infrastructure/Distributed/Consensus/RaftConsensusEngine.cs</files>
  <action>
  In RaftConsensusEngine.cs, modify `HandleIncomingMessageAsync` (line ~594-605):

  1. BEFORE the message type switch, add membership verification:
     ```csharp
     // Verify sender is a known cluster member
     var knownMembers = _membership?.GetMembers() ?? Array.Empty<...>();
     if (message.SenderId != null && !knownMembers.Any(m => m.NodeId == message.SenderId))
     {
         _logger?.LogWarning("Rejected Raft message from unknown node {NodeId}", message.SenderId);
         return null; // Silently reject -- do not reveal cluster info
     }
     ```

  2. Add term inflation rate limiting in `HandleRequestVoteAsync` (line ~613-617):
     - Before accepting a higher term, check that the term jump is reasonable
     - Max term jump per message: current term + 100 (prevents long.MaxValue attack)
     - Rate limit: max 1 term change per second per sender
     ```csharp
     if (request.Term > _persistent.CurrentTerm + MaxTermJump)
     {
         _logger?.LogWarning("Rejected suspicious term inflation from {NodeId}: term {Term} vs current {CurrentTerm}",
             request.SenderId, request.Term, _persistent.CurrentTerm);
         return new RequestVoteResponse { Term = _persistent.CurrentTerm, VoteGranted = false };
     }
     ```
     Define `private const long MaxTermJump = 100;`

  3. Add sender validation in `HandleAppendEntriesAsync` (line ~659-801):
     - Only accept AppendEntries from the current known leader OR from a node with higher term that is a known member
     - Reject AppendEntries from unknown nodes entirely

  4. Add HMAC message authentication:
     - Add an optional `ClusterSecret` property to RaftConsensusEngine
     - If set, compute HMAC-SHA256 of the serialized message bytes using the cluster secret
     - Attach HMAC to outgoing messages, verify on incoming
     - If HMAC verification fails, drop the message
     - The cluster secret should be provided during engine initialization from configuration

  IMPORTANT: Do not break the Raft protocol semantics. Term advancement is essential for leader election -- we are rate-limiting suspicious jumps, not preventing all term changes. A legitimate candidate increments term by 1.
  </action>
  <verify>
  - `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` succeeds
  - `grep -rn "IsKnownMember\|VerifyMembership\|knownMembers\|GetMembers" DataWarehouse.SDK/Infrastructure/Distributed/Consensus/RaftConsensusEngine.cs` returns matches
  - `grep -rn "MaxTermJump" DataWarehouse.SDK/Infrastructure/Distributed/Consensus/RaftConsensusEngine.cs` returns a match
  - Full solution builds with 0 errors
  </verify>
  <done>
  - DIST-01 (CVSS 9.1) RESOLVED: Unknown nodes cannot win elections
  - DIST-02 (CVSS 9.1) RESOLVED: Log entries only accepted from verified members
  - Term inflation attack prevented via MaxTermJump
  - HMAC authentication available for Raft messages
  </done>
</task>

<task type="auto">
  <name>Task 2: Enforce mTLS on Raft TCP transport and P2P network</name>
  <files>Plugins/DataWarehouse.Plugins.Raft/RaftConsensusPlugin.cs, DataWarehouse.SDK/Infrastructure/Distributed/TcpP2PNetwork.cs</files>
  <action>
  **AUTH-06: Raft TCP listener no authentication (CVSS 8.6)**

  In RaftConsensusPlugin.cs (line ~1199), find the TCP listener setup:
  1. Make mTLS mandatory by default (not optional)
  2. If `UseMutualTls` configuration exists, change its default to `true`
  3. When mTLS is enabled, reject any connection that doesn't present a valid client certificate
  4. The TcpP2PNetwork.cs already has SECURE cert validation (line 236, 303) -- ensure Raft uses this

  **DIST-05: P2P mTLS optional with self-signed bypass (CVSS 7.5)**

  In TcpP2PNetwork.cs (line ~79):
  1. Change `AllowSelfSignedCertificates` default from `true` to `false`
  2. Self-signed certificates should only be allowed when explicitly configured (development mode)
  3. Ensure `RequireMutualTls` defaults to `true`
  4. The existing ValidateServerCertificate/ValidateClientCertificate methods are already secure -- just ensure they are always active

  For both files:
  - grep first to understand the current mTLS configuration structure
  - Change defaults only, do not remove the configuration options (operators need them for dev/test)
  - Log warnings when mTLS is disabled or self-signed certs are allowed
  </action>
  <verify>
  - `dotnet build` full solution with 0 errors
  - grep for mTLS defaults shows `true` as default
  - grep for self-signed defaults shows `false` as default
  </verify>
  <done>
  - AUTH-06 (CVSS 8.6) RESOLVED: Raft TCP requires mTLS by default
  - DIST-05 (CVSS 7.5) RESOLVED: P2P mTLS mandatory, self-signed disabled by default
  - Configuration overrides preserved for development use
  - Solution builds with 0 errors
  </done>
</task>

</tasks>

<verification>
- Full solution builds with 0 errors
- Raft rejects messages from unknown nodes
- mTLS is default for Raft and P2P
- Term inflation is rate-limited
</verification>

<success_criteria>
- DIST-01 (CVSS 9.1), DIST-02 (CVSS 9.1), AUTH-06 (CVSS 8.6) RESOLVED
- DIST-05 (CVSS 7.5) RESOLVED
- Cluster takeover attack chain broken
</success_criteria>

<output>
After completion, create `.planning/phases/53-security-wiring/53-04-SUMMARY.md`
</output>
