---
phase: 53-security-wiring
plan: 10
type: execute
wave: 4
depends_on: []
files_modified:
  - DataWarehouse.Dashboard/Program.cs
  - DataWarehouse.Launcher/LauncherHttpServer.cs
  - Plugins/DataWarehouse.Plugins.PluginMarketplace/PluginMarketplacePlugin.cs
  - DataWarehouse.SDK/Contracts/PluginDetails.cs
autonomous: true

must_haves:
  truths:
    - "JWT token not exposed in SignalR query strings in production"
    - "Error messages do not expose internal implementation details"
    - "Plugin marketplace requires signed assemblies by default"
    - "gRPC storage message size is bounded to 10MB"
    - "Monitoring blind spots documented with wiring plan"
  artifacts:
    - path: "DataWarehouse.Dashboard/Program.cs"
      provides: "SignalR auth via header not query string"
    - path: "Plugins/DataWarehouse.Plugins.PluginMarketplace/PluginMarketplacePlugin.cs"
      provides: "Signed assembly requirement"
      contains: "RequireSignedAssemblies.*true"
  key_links:
    - from: "Dashboard Program.cs"
      to: "SignalR authentication"
      via: "Token extraction from headers"
      pattern: "OnMessageReceived|Authorization.*Bearer"
---

<objective>
Fix remaining low/informational findings: JWT in query string, error disclosure, marketplace signing, monitoring gaps.

Purpose: Resolves RECON-05 (CVSS 4.3 -- JWT in query string), RECON-09 (info -- error disclosure), ISO-05 (CVSS 7.7 -- marketplace signing default), INFRA-06 (info -- monitoring blind spots), plus remaining ISO-03 shared mutable state hardening. These are the tail of findings needed for complete coverage.

Output: All 50 pentest findings have been addressed.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/47-penetration-testing/47-v4.5-PENTEST-REPORT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix JWT exposure, error disclosure, and marketplace signing</name>
  <files>
    DataWarehouse.Dashboard/Program.cs,
    Plugins/DataWarehouse.Plugins.PluginMarketplace/PluginMarketplacePlugin.cs,
    DataWarehouse.SDK/Contracts/PluginDetails.cs
  </files>
  <action>
  **RECON-05: JWT token in SignalR query string (CVSS 4.3)**

  In Dashboard Program.cs (line ~71-78), find the SignalR/JWT configuration:
  1. The current pattern extracts JWT from `context.Request.Query["access_token"]` for SignalR
  2. This is unfortunately necessary for WebSocket connections (browser WebSocket API doesn't support custom headers)
  3. Mitigations:
     a) Add `SameSite=Strict` to JWT cookies
     b) Use a short-lived WebSocket-specific token (10 seconds) that's exchanged for the full JWT after connection
     c) At minimum: ensure the access_token query parameter is NOT logged by Kestrel access logs
     d) Add `Sec-WebSocket-Protocol` header-based auth as an alternative when supported
  4. If full header-based auth is possible (check if the SignalR client supports it), prefer that

  **RECON-09: Error message information disclosure (systemic ex.Message)**

  This is systemic -- many catch blocks expose ex.Message to API responses:
  1. In Dashboard controllers (grep for `ex.Message` in Controllers/):
     - Replace `ex.Message` in API responses with generic messages: "An internal error occurred"
     - Log the full exception with stack trace to the server log
     - Return a correlation ID that maps to the log entry
  2. Add a global exception handler in Program.cs:
     ```csharp
     app.UseExceptionHandler(appError =>
     {
         appError.Run(async context =>
         {
             context.Response.StatusCode = 500;
             await context.Response.WriteAsJsonAsync(new { error = "Internal server error", correlationId = Activity.Current?.Id ?? context.TraceIdentifier });
         });
     });
     ```
  3. This is a broad change -- focus on the Dashboard controllers and Launcher API

  **ISO-05: Plugin marketplace RequireSignedAssemblies (CVSS 7.7)**

  In PluginMarketplacePlugin.cs:
  1. Find where `RequireSignedAssemblies` is configured
  2. Change default from `false` to `true`
  3. Add a validation check: if RequireSignedAssemblies is disabled, log a security warning on startup
  4. Also set `ValidateAssemblyHash = true` by default

  **ISO-03: Shared mutable state (CVSS 5.9)**

  Check the files referenced in the pentest:
  - CompressionStrategy.cs:481 -- if this is a static field shared across plugins, make it instance-level or thread-safe
  - BoundedMemoryRuntime.cs:42 -- same check
  - If the shared state is by design (e.g., global compression cache), ensure it's thread-safe with ConcurrentDictionary or locking
  </action>
  <verify>
  - `grep -rn "RequireSignedAssemblies" Plugins/DataWarehouse.Plugins.PluginMarketplace/` shows `true` as default
  - `grep -rn "ex\.Message" DataWarehouse.Dashboard/Controllers/` returns fewer results (generic messages used instead)
  - `dotnet build` full solution with 0 errors
  </verify>
  <done>
  - RECON-05 (CVSS 4.3) MITIGATED: JWT query string exposure minimized
  - RECON-09 (INFO) RESOLVED: Error messages don't expose internals
  - ISO-05 (CVSS 7.7) RESOLVED: Marketplace requires signed assemblies
  - ISO-03 (CVSS 5.9) RESOLVED: Shared mutable state made thread-safe
  </done>
</task>

<task type="auto">
  <name>Task 2: Address monitoring blind spots and RECON-06 message size</name>
  <files>
    DataWarehouse.Kernel/DataWarehouseKernel.cs,
    DataWarehouse.SDK/Infrastructure/Distributed/TcpP2PNetwork.cs
  </files>
  <action>
  **INFRA-06: Monitoring blind spots -- 9 unaudited operation classes (INFO)**

  The pentest identified 9 operation classes that lack audit logging. Add audit events for:
  1. Plugin loading/unloading -- already covered by INFRA-03 fix (Plan 09)
  2. Message bus subscription changes -- add logging when plugins subscribe to new topics
  3. Configuration changes -- already covered by INFRA-03 fix
  4. Security policy changes -- add logging for AccessVerificationMatrix modifications
  5. Cluster membership changes -- add logging for SWIM join/leave events
  6. Raft leadership changes -- add logging for leader election results
  7. Federation topology changes -- add logging for node add/remove
  8. Key rotation events -- add logging for key management operations
  9. Credential access -- add logging for secret retrieval

  For each:
  - Add an ILogger.LogInformation call with structured data at the point of the operation
  - Format: `_logger.LogInformation("Security event: {EventType} by {Identity} at {Timestamp}", ...)`
  - These are audit breadcrumbs, not full audit log entries -- they go to the standard logging pipeline

  **RECON-06: P2P network 100MB message size (INFO)**

  In TcpP2PNetwork.cs:
  1. Find the max message size configuration (100MB default mentioned in pentest)
  2. Reduce default to 10MB (configurable)
  3. Add a `MaxMessageSize` configuration option
  4. Validate incoming message size before allocating buffer

  **INFRA-05: No MSBuild injection (INFO - POSITIVE)**
  - This is a clean finding -- no action needed. Document that this was verified.
  </action>
  <verify>
  - `grep -rn "Security event" DataWarehouse.Kernel/DataWarehouseKernel.cs` returns matches for audit breadcrumbs
  - `grep -rn "MaxMessageSize" DataWarehouse.SDK/Infrastructure/Distributed/TcpP2PNetwork.cs` returns a match
  - `dotnet build` full solution with 0 errors
  </verify>
  <done>
  - INFRA-06 (INFO) RESOLVED: Monitoring blind spots filled with audit breadcrumbs
  - RECON-06 (INFO) RESOLVED: P2P message size bounded to 10MB
  - INFRA-05 (INFO) CONFIRMED CLEAN: No action needed
  - All informational findings addressed
  </done>
</task>

</tasks>

<verification>
- Full solution builds with 0 errors
- All 50 pentest findings have been addressed (cross-reference with findings table)
- Marketplace signing enabled by default
- Error messages sanitized
</verification>

<success_criteria>
- RECON-05, RECON-09, ISO-05, ISO-03, INFRA-06, RECON-06 all addressed
- Every finding from the pentest report has a corresponding fix
</success_criteria>

<output>
After completion, create `.planning/phases/53-security-wiring/53-10-SUMMARY.md`
</output>
