---
phase: 53-security-wiring
plan: 05
type: execute
wave: 2
depends_on: []
files_modified:
  - DataWarehouse.SDK/Infrastructure/Distributed/Membership/SwimClusterMembership.cs
  - DataWarehouse.SDK/Infrastructure/Distributed/Replication/CrdtReplicationSync.cs
  - DataWarehouse.SDK/Infrastructure/Distributed/Replication/SdkCrdtTypes.cs
  - DataWarehouse.SDK/Infrastructure/Distributed/Discovery/MdnsServiceDiscovery.cs
  - DataWarehouse.SDK/Infrastructure/Distributed/Discovery/ZeroConfigClusterBootstrap.cs
autonomous: true

must_haves:
  truths:
    - "SWIM gossip messages are HMAC-authenticated with a cluster shared secret"
    - "CRDT state updates are authenticated and timestamp-bounded"
    - "mDNS service discovery validates announced nodes before auto-joining"
    - "LWW Register timestamps are bounded to prevent MaxValue poisoning"
  artifacts:
    - path: "DataWarehouse.SDK/Infrastructure/Distributed/Membership/SwimClusterMembership.cs"
      provides: "HMAC-authenticated SWIM gossip"
      contains: "HMAC|hmac|Authenticate"
    - path: "DataWarehouse.SDK/Infrastructure/Distributed/Replication/SdkCrdtTypes.cs"
      provides: "Timestamp-bounded LWW Register"
      contains: "MaxTimestamp|TimestampBound"
  key_links:
    - from: "SwimClusterMembership.cs"
      to: "HMAC verification"
      via: "Verify gossip message signature before processing"
      pattern: "Verify.*HMAC|hmac.*Verify"
---

<objective>
Add authentication to SWIM gossip, CRDT replication, and mDNS discovery protocols.

Purpose: Resolves DIST-03 (CVSS 8.6 -- SWIM poisoning), DIST-04 (CVSS 8.1 -- CRDT injection), DIST-06 (CVSS 7.3 -- mDNS spoofing), DIST-08 (CVSS 6.5 -- LWW timestamp attack). These complete the distributed protocol hardening.

Output: All gossip protocols authenticate messages; CRDT timestamps are bounded; mDNS discovery validates before join.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/47-penetration-testing/47-v4.5-PENTEST-REPORT.md
@.planning/phases/47-penetration-testing/v4.5-05-DISTRIBUTED-FINDINGS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add HMAC authentication to SWIM gossip and CRDT replication</name>
  <files>
    DataWarehouse.SDK/Infrastructure/Distributed/Membership/SwimClusterMembership.cs,
    DataWarehouse.SDK/Infrastructure/Distributed/Replication/CrdtReplicationSync.cs,
    DataWarehouse.SDK/Infrastructure/Distributed/Replication/SdkCrdtTypes.cs
  </files>
  <action>
  **DIST-03: SWIM membership poisoning (CVSS 8.6)**

  In SwimClusterMembership.cs (around line 619-630), find where incoming SWIM messages are processed:
  1. Add a `ClusterSecret` property (byte[]) that can be set during initialization
  2. Add HMAC-SHA256 authentication to SWIM messages:
     - On send: compute HMAC-SHA256(message_bytes, cluster_secret), append to message
     - On receive: verify HMAC before processing any message
     - Reject messages with invalid or missing HMAC when ClusterSecret is configured
  3. In `HandleDeadMessage` specifically: require quorum confirmation before marking a node as dead
     - A single Dead message should not immediately evict a node
     - Require at least 2 independent Dead reports before marking as dead (indirect probe first)
  4. Rate-limit membership state changes: max 1 state change per node per second

  **DIST-04: CRDT state injection (CVSS 8.1)**

  In CrdtReplicationSync.cs (around line 328-388):
  1. Add HMAC authentication to CRDT gossip messages (same cluster secret)
  2. Validate that the sender is a known cluster member before merging state
  3. Reject CRDT updates from unknown nodes

  **DIST-08: LWW timestamp attack (CVSS 6.5)**

  In SdkCrdtTypes.cs, find the LWW Register implementation:
  1. Add a timestamp bound: reject any timestamp more than 1 hour in the future
     ```csharp
     private static readonly TimeSpan MaxTimestampSkew = TimeSpan.FromHours(1);

     // In Merge method:
     if (incoming.Timestamp > DateTimeOffset.UtcNow + MaxTimestampSkew)
     {
         // Reject -- timestamp too far in the future
         return this; // Keep current value
     }
     ```
  2. This prevents DateTimeOffset.MaxValue poisoning while allowing for reasonable clock skew
  3. Add a similar check for ORSet, GCounter, and any other CRDT types that use timestamps
  </action>
  <verify>
  - `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` succeeds
  - `grep -rn "HMAC\|hmac" DataWarehouse.SDK/Infrastructure/Distributed/Membership/SwimClusterMembership.cs` returns matches
  - `grep -rn "MaxTimestampSkew\|TimestampBound" DataWarehouse.SDK/Infrastructure/Distributed/Replication/SdkCrdtTypes.cs` returns matches
  - Full solution builds with 0 errors
  </verify>
  <done>
  - DIST-03 (CVSS 8.6) RESOLVED: SWIM gossip HMAC-authenticated
  - DIST-04 (CVSS 8.1) RESOLVED: CRDT updates authenticated
  - DIST-08 (CVSS 6.5) RESOLVED: LWW timestamps bounded
  - Dead node detection requires quorum, not single message
  </done>
</task>

<task type="auto">
  <name>Task 2: Secure mDNS discovery and federation heartbeat</name>
  <files>
    DataWarehouse.SDK/Infrastructure/Distributed/Discovery/MdnsServiceDiscovery.cs,
    DataWarehouse.SDK/Infrastructure/Distributed/Discovery/ZeroConfigClusterBootstrap.cs
  </files>
  <action>
  **DIST-06: mDNS spoofing for rogue node injection (CVSS 7.3)**

  In MdnsServiceDiscovery.cs (around line 183-185) and ZeroConfigClusterBootstrap.cs:
  1. Do NOT auto-join nodes discovered via mDNS without verification
  2. Add a verification step after discovery:
     - Discovered node must present valid cluster credentials (cluster secret or mTLS cert)
     - Add a `RequireClusterVerification` flag (default: true)
     - When true: discovered node is added to "pending" list, then verified via TLS handshake
     - When false (legacy mode): current behavior preserved with warning log
  3. Add a `AllowedNetworkPrefixes` configuration to restrict which network ranges are trusted for mDNS discovery
  4. Add logging for all join/leave events (audit trail)

  **DIST-07: Federation heartbeat spoofing (CVSS 7.1)**

  Find the FederationOrchestrator in the SDK or plugins:
  - `grep -rn "FederationOrchestrator" --include="*.cs"` to locate
  - Around line 169-185 (per pentest report), heartbeats are accepted without verification
  - Add: heartbeat messages must include HMAC or come from an authenticated TLS connection
  - Reject heartbeats from unknown federation nodes
  - Rate-limit topology change requests

  **DIST-09: Hardware probe results trusted without validation (CVSS 5.3)**

  Find HardwareProbeFactory:
  - Add input validation to hardware probe results before they influence routing/placement decisions
  - Sanitize string fields (prevent injection)
  - Validate numeric ranges (e.g., disk size > 0, memory > 0, values within reasonable bounds)
  </action>
  <verify>
  - `dotnet build` full solution with 0 errors
  - `grep -rn "RequireClusterVerification\|ClusterVerification" DataWarehouse.SDK/Infrastructure/Distributed/Discovery/` returns matches
  - mDNS auto-join requires verification by default
  </verify>
  <done>
  - DIST-06 (CVSS 7.3) RESOLVED: mDNS discovery requires cluster verification
  - DIST-07 (CVSS 7.1) RESOLVED: Federation heartbeats authenticated
  - DIST-09 (CVSS 5.3) RESOLVED: Hardware probe results validated
  - All distributed protocol findings addressed
  </done>
</task>

</tasks>

<verification>
- Full solution builds with 0 errors
- All gossip protocols have HMAC authentication
- CRDT timestamps bounded
- mDNS requires verification before auto-join
</verification>

<success_criteria>
- DIST-03, DIST-04, DIST-06, DIST-07, DIST-08, DIST-09 all RESOLVED
- Cluster takeover via gossip poisoning no longer possible
- CRDT permanent corruption via timestamp attack prevented
</success_criteria>

<output>
After completion, create `.planning/phases/53-security-wiring/53-05-SUMMARY.md`
</output>
