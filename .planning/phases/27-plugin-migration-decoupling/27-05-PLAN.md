---
phase: 27-plugin-migration-decoupling
plan: 05
type: execute
wave: 3
depends_on: ["27-02", "27-03", "27-04"]
files_modified: []
autonomous: true
gap_closure: false

must_haves:
  truths:
    - "Zero plugins or kernel depend on any other plugin directly -- static analysis confirms SDK-only dependencies (DECPL-01)"
    - "All inter-plugin communication uses Commands/Messages via message bus only (DECPL-02)"
    - "All plugins register capabilities and knowledge into the system knowledge bank (DECPL-04)"
    - "All Ultimate plugins inherit from respective feature-specific plugin base classes (UPLT-01)"
    - "All standalone plugins inherit from IntelligenceAwarePluginBase at minimum (UPST-01)"
    - "Full solution builds with zero new errors and all existing tests pass (REGR-03)"
  artifacts:
    - path: "DataWarehouse.slnx"
      provides: "Solution builds cleanly"
  key_links:
    - from: "All plugin .csproj files"
      to: "DataWarehouse.SDK.csproj"
      via: "ProjectReference (SDK only)"
      pattern: "ProjectReference.*DataWarehouse\\.SDK"
    - from: "Plugin code"
      to: "MessageBus"
      via: "Publish/Subscribe calls"
      pattern: "MessageBus\\.(Publish|Send|Subscribe)"
---

<objective>
Run comprehensive decoupling verification across the entire codebase: static analysis of project references, message bus audit, capability/knowledge registration check, and full build verification.

Purpose: This is the verification gate for Phase 27. All migration work (Plans 27-01 through 27-04) is complete. This plan proves all 11 requirements (UPLT-01/02/03, UPST-01/02/03, DECPL-01/02/03/04/05) are satisfied through automated verification. Phase 27 does not complete until this plan passes.

Output: Verification report confirming all requirements. No files modified unless issues found.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/27-plugin-migration-decoupling/27-RESEARCH.md
@.planning/phases/27-plugin-migration-decoupling/27-01-SUMMARY.md
@.planning/phases/27-plugin-migration-decoupling/27-02-SUMMARY.md
@.planning/phases/27-plugin-migration-decoupling/27-03-SUMMARY.md
@.planning/phases/27-plugin-migration-decoupling/27-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Static analysis -- project references, namespace imports, base class audit, and message bus verification</name>
  <files></files>
  <action>
    Run comprehensive static analysis. This task reads files and runs grep/build commands but does NOT modify any files unless a violation is found and can be auto-fixed.

    **Check 1: DECPL-01 -- Zero plugin-to-plugin ProjectReferences**
    ```bash
    # Grep all plugin .csproj files for ProjectReference
    grep -r "ProjectReference" Plugins/DataWarehouse.Plugins.*/*.csproj
    ```
    Every ProjectReference MUST point to `DataWarehouse.SDK.csproj` only. If any plugin references another plugin, report as FAIL.

    Also verify Kernel references only SDK:
    ```bash
    grep "ProjectReference" DataWarehouse.Kernel/DataWarehouse.Kernel.csproj
    ```

    **Check 2: DECPL-01 -- Zero cross-plugin using directives**
    ```bash
    grep -r "using DataWarehouse.Plugins\." Plugins/ --include="*.cs"
    ```
    All matches MUST be intra-plugin (plugin referencing its own sub-namespaces). If `DataWarehouse.Plugins.X` is referenced from `Plugins/DataWarehouse.Plugins.Y/`, that's a FAIL.

    **Check 3: UPLT-01 / UPST-01 -- All plugins on correct Hierarchy bases**
    Audit every plugin class's base class:
    ```bash
    grep -r "class.*Plugin.*:" Plugins/ --include="*.cs"
    ```
    Verify:
    - No plugin inherits `LegacyFeaturePluginBase` directly
    - No plugin inherits bare `PluginBase` (except UltimateIntelligencePlugin which is special per HIER-07)
    - No plugin inherits obsolete `IntelligenceAware*PluginBase` specialized bases
    - All plugins ultimately chain through IntelligenceAwarePluginBase (except UltimateIntelligence)

    **Check 4: DECPL-02 -- Message bus communication audit**
    ```bash
    # Count MessageBus usage across all plugins
    grep -r "MessageBus\.\(Publish\|Send\|Subscribe\)" Plugins/ --include="*.cs" | wc -l
    ```
    Research showed 219 calls across 56 files. Verify count is stable or increased (migration should not reduce message bus usage).

    Identify plugins with ZERO MessageBus usage:
    ```bash
    # For each plugin directory, check if any .cs file mentions MessageBus
    for dir in Plugins/DataWarehouse.Plugins.*/; do
      if ! grep -q "MessageBus" "$dir"*.cs 2>/dev/null; then
        echo "NO MESSAGEBUS: $dir"
      fi
    done
    ```
    For plugins with zero MessageBus usage, determine if they NEED inter-plugin communication. If they're self-contained (e.g., pure data transformation), zero usage is acceptable. Document findings.

    **Check 5: DECPL-04 -- Capability and knowledge registration**
    ```bash
    grep -r "RegisterCapability\|RegisterKnowledge" Plugins/ --include="*.cs"
    ```
    Research showed only 5 occurrences across 3 files. Note current count. Phase 27 research recommended adding capability registration to all plugins -- but this is ADDITIVE work. If not yet done in Plans 27-01 through 27-04, report as a finding (not a blocker, since the base classes provide the mechanism).

    **Check 6: UPLT-03 / UPST-02 -- Strategy hierarchy compliance**
    Verify all plugin strategies inherit from the unified strategy hierarchy (Phase 25b):
    ```bash
    grep -r "class.*Strategy.*:" Plugins/ --include="*.cs" | grep -v "StrategyBase\|EncryptionStrategyBase\|CompressionStrategyBase\|StorageStrategyBase" | head -20
    ```
    Any strategy NOT inheriting from a StrategyBase subclass should be flagged.

    **Check 7: Full build**
    ```bash
    dotnet build DataWarehouse.slnx
    ```
    Count errors. Only pre-existing CS1729/CS0234 in UltimateCompression and AedsCore are acceptable. Any NEW errors = FAIL.

    **Check 8: Test suite**
    ```bash
    dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --no-build 2>&1 || true
    ```
    If tests can run (UltimateCompression build error may block), verify all pass. If blocked, document as pre-existing.

    **For each check, record: PASS/FAIL, evidence (counts, file names), and any findings.**

    If any FAIL is found that can be auto-fixed (e.g., a missed plugin still on LegacyFeaturePluginBase), fix it immediately and re-run the check.
  </action>
  <verify>
    All 8 checks return PASS (or KNOWN-PREEXISTING for items blocked by UltimateCompression).
    Compile the results into a verification report.
  </verify>
  <done>
    Static analysis complete with results for all 11 Phase 27 requirements:
    - UPLT-01: All Ultimate plugins on feature-specific bases (PASS)
    - UPLT-02: Distributed infrastructure accessible via base classes (PASS or DEPENDS-ON-PHASE-26)
    - UPLT-03: All strategies on unified hierarchy (PASS)
    - UPST-01: All standalone plugins on IntelligenceAwarePluginBase minimum (PASS)
    - UPST-02: All standalone strategies on unified hierarchy (PASS)
    - UPST-03: Distributed infrastructure accessible (PASS or DEPENDS-ON-PHASE-26)
    - DECPL-01: Zero cross-plugin dependencies (PASS)
    - DECPL-02: All communication via message bus (PASS)
    - DECPL-03: Kernel uses capability registry (PASS)
    - DECPL-04: All plugins can register capabilities (PASS -- mechanism exists, adoption is additive)
    - DECPL-05: Distributed infrastructure leverage (DEPENDS-ON-PHASE-26)
  </done>
</task>

<task type="auto">
  <name>Task 2: Compile Phase 27 verification report and update ROADMAP requirements status</name>
  <files></files>
  <action>
    Based on Task 1 results, compile a comprehensive verification report as part of the SUMMARY.

    The SUMMARY for this plan should include:

    **Requirement Verification Matrix:**

    | Requirement | Description | Status | Evidence |
    |-------------|-------------|--------|----------|
    | UPLT-01 | Ultimate plugins on feature-specific bases | {PASS/FAIL} | {count} plugins verified |
    | UPLT-02 | Distributed infrastructure in base classes | {status} | Phase 26 dependency |
    | UPLT-03 | Ultimate strategies on unified hierarchy | {PASS/FAIL} | Phase 25b verified |
    | UPST-01 | Standalone plugins on IntelligenceAwarePluginBase | {PASS/FAIL} | {count} plugins verified |
    | UPST-02 | Standalone strategies on unified hierarchy | {PASS/FAIL} | Phase 25b verified |
    | UPST-03 | Standalone distributed infrastructure | {status} | Phase 26 dependency |
    | DECPL-01 | Zero cross-plugin dependencies | {PASS/FAIL} | {count} ProjectRefs checked |
    | DECPL-02 | Message bus communication | {PASS/FAIL} | {count} calls found |
    | DECPL-03 | Kernel capability/knowledge routing | {PASS/FAIL} | Kernel code verified |
    | DECPL-04 | Plugin capability registration | {PASS/FAIL} | {count} RegisterCapability calls |
    | DECPL-05 | Distributed infrastructure leverage | {status} | Phase 26 dependency |

    **Migration Census:**

    | Category | Count | Status |
    |----------|-------|--------|
    | SDK intermediate bases re-parented | ~60 | Plan 27-01 |
    | Ultimate DataPipeline plugins migrated | 10 | Plan 27-02 |
    | Ultimate Feature plugins migrated | 32 | Plan 27-03 |
    | Standalone/special-case plugins migrated | 16+ | Plan 27-04 |
    | Total plugin classes verified | 78 | All plans |

    **Build Status:**
    - Total projects: 69
    - Successful builds: {count}
    - Pre-existing failures: {count} (list)
    - New failures: 0

    **Findings/Recommendations:**
    - Any plugins with zero MessageBus usage that might need it
    - Capability registration adoption status (additive, not blocking)
    - DECPL-05 dependency on Phase 26

    This is a verification-only task. No code files should be modified unless fixing verification failures.
  </action>
  <verify>
    Verification report is complete and comprehensive. All 11 requirements have a status.
    `dotnet build DataWarehouse.slnx` confirms zero new errors.
  </verify>
  <done>Phase 27 verification report complete. All achievable requirements PASS. Phase 26-dependent requirements documented as dependencies.</done>
</task>

</tasks>

<verification>
- All 11 Phase 27 requirements have a verified status (PASS, DEPENDS-ON-PHASE-26, or documented finding)
- Zero new compilation errors in full solution build
- Zero cross-plugin ProjectReferences confirmed
- Zero obsolete base class references remain in plugin code
- Message bus usage audited
</verification>

<success_criteria>
1. DECPL-01 PASS: Zero cross-plugin ProjectReferences (all plugins reference SDK only)
2. DECPL-02 PASS: All inter-plugin communication via message bus (no direct method calls)
3. DECPL-04 PASS: Capability registration mechanism available in all plugin base classes
4. UPLT-01 PASS: All Ultimate plugins on feature-specific Hierarchy bases
5. UPST-01 PASS: All standalone plugins on IntelligenceAwarePluginBase minimum
6. Full solution builds with zero new errors
7. Comprehensive verification report compiled in SUMMARY
</success_criteria>

<output>
After completion, create `.planning/phases/27-plugin-migration-decoupling/27-05-SUMMARY.md`
</output>
