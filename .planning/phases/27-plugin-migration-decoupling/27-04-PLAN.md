---
phase: 27-plugin-migration-decoupling
plan: 04
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - Plugins/DataWarehouse.Plugins.AirGapBridge/AirGapBridgePlugin.cs
  - Plugins/DataWarehouse.Plugins.AdaptiveTransport/AdaptiveTransportPlugin.cs
  - Plugins/DataWarehouse.Plugins.RaftConsensus/RaftConsensusPlugin.cs
  - Plugins/DataWarehouse.Plugins.KubernetesCsi/KubernetesCsiPlugin.cs
  - Plugins/DataWarehouse.Plugins.FuseDriver/FuseDriverPlugin.cs
  - Plugins/DataWarehouse.Plugins.WinFspDriver/WinFspDriverPlugin.cs
  - Plugins/DataWarehouse.Plugins.DataMarketplace/DataMarketplacePlugin.cs
  - Plugins/DataWarehouse.Plugins.PluginMarketplace/PluginMarketplacePlugin.cs
  - Plugins/DataWarehouse.Plugins.SelfEmulatingObjects/SelfEmulatingObjectsPlugin.cs
  - Plugins/DataWarehouse.Plugins.WasmCompute/WasmComputePlugin.cs
  - Plugins/DataWarehouse.Plugins.SqlOverObject/SqlOverObjectPlugin.cs
  - Plugins/DataWarehouse.Plugins.MediaTranscoding/MediaTranscodingPlugin.cs
  - Plugins/DataWarehouse.Plugins.UltimateFilesystem/UltimateFilesystemPlugin.cs
  - Plugins/DataWarehouse.Plugins.UltimateResourceManager/UltimateResourceManagerPlugin.cs
  - Plugins/DataWarehouse.Plugins.UltimateDataLineage/UltimateDataLineagePlugin.cs
  - Plugins/DataWarehouse.Plugins.AedsCore/AedsCorePlugin.cs
autonomous: true

must_haves:
  truths:
    - "AirGapBridgePlugin migrated from raw IFeaturePlugin to InfrastructurePluginBase with full PluginBase lifecycle"
    - "All standalone plugins on LegacyFeaturePluginBase inherit from a Hierarchy Feature base"
    - "AEDS sub-plugins compile after SDK intermediate bases were re-parented in Plan 27-01"
    - "All migrated plugins implement required abstract members from Hierarchy bases"
    - "All standalone plugins inherit from IntelligenceAwarePluginBase at minimum (UPST-01)"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.AirGapBridge/AirGapBridgePlugin.cs"
      provides: "AirGapBridge on InfrastructurePluginBase (Hierarchy)"
      contains: "InfrastructurePluginBase"
    - path: "Plugins/DataWarehouse.Plugins.DataMarketplace/DataMarketplacePlugin.cs"
      provides: "DataMarketplace on PlatformPluginBase"
      contains: "PlatformPluginBase"
    - path: "Plugins/DataWarehouse.Plugins.AedsCore/AedsCorePlugin.cs"
      provides: "AedsCore plugins building after SDK re-parenting"
  key_links:
    - from: "Standalone plugins"
      to: "Hierarchy Feature/DataPipeline bases"
      via: "inheritance (replacing LegacyFeaturePluginBase)"
      pattern: ":\\s*(InfrastructurePluginBase|PlatformPluginBase|ComputePluginBase|InterfacePluginBase|StreamingPluginBase|MediaPluginBase|DataManagementPluginBase|OrchestrationPluginBase)"
---

<objective>
Migrate all remaining standalone plugins and special cases: (1) AirGapBridge from raw IFeaturePlugin, (2) 14 standalone plugins from LegacyFeaturePluginBase, (3) verify AEDS sub-plugins compile after Plan 27-01 SDK re-parenting.

Purpose: After Plan 27-01 re-parented SDK intermediate bases, many standalone plugins (AEDS, WasmCompute, SqlOverObject, MediaTranscoding) should already compile through their intermediate bases. This plan handles the remaining direct LegacyFeaturePluginBase users and the AirGapBridge special case that has no base class at all.

Output: All standalone plugins on correct Hierarchy bases; AirGapBridge fully migrated; zero LegacyFeaturePluginBase references in any plugin file.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-plugin-migration-decoupling/27-RESEARCH.md
@.planning/phases/27-plugin-migration-decoupling/27-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate AirGapBridge (special case) and direct LegacyFeaturePluginBase standalone plugins</name>
  <files>
    Plugins/DataWarehouse.Plugins.AirGapBridge/AirGapBridgePlugin.cs
    Plugins/DataWarehouse.Plugins.AdaptiveTransport/AdaptiveTransportPlugin.cs
    Plugins/DataWarehouse.Plugins.DataMarketplace/DataMarketplacePlugin.cs
    Plugins/DataWarehouse.Plugins.PluginMarketplace/PluginMarketplacePlugin.cs
    Plugins/DataWarehouse.Plugins.SelfEmulatingObjects/SelfEmulatingObjectsPlugin.cs
    Plugins/DataWarehouse.Plugins.FuseDriver/FuseDriverPlugin.cs
    Plugins/DataWarehouse.Plugins.WinFspDriver/WinFspDriverPlugin.cs
    Plugins/DataWarehouse.Plugins.UltimateFilesystem/UltimateFilesystemPlugin.cs
    Plugins/DataWarehouse.Plugins.UltimateResourceManager/UltimateResourceManagerPlugin.cs
    Plugins/DataWarehouse.Plugins.UltimateDataLineage/UltimateDataLineagePlugin.cs
  </files>
  <action>
    **AirGapBridgePlugin -- CATEGORY E SPECIAL CASE (highest effort):**
    - Currently implements `IFeaturePlugin` directly with NO base class. Has its own `_isRunning`, manual `_disposed` tracking.
    - TARGET: `InfrastructurePluginBase` (Hierarchy.Feature)
    - Add: `public override string InfrastructureDomain => "AirGap";`
    - Migration steps:
      1. Change class declaration from `: IFeaturePlugin, IDisposable` to `: InfrastructurePluginBase, IDisposable`
      2. InfrastructurePluginBase inherits FeaturePluginBase -> IntelligenceAwarePluginBase -> PluginBase, which provides:
         - Id, Name, Version, Category (abstract -- must implement if not present)
         - InitializeAsync, ExecuteAsync, ShutdownAsync (virtual lifecycle)
         - Dispose(bool) pattern, IDisposable
         - IFeaturePlugin is satisfied through the chain
      3. Move `_isRunning` tracking to use PluginBase lifecycle (InitializeAsync -> active, ShutdownAsync -> stopped)
      4. Keep the plugin's existing logic but map it:
         - Constructor init logic stays in constructor
         - Start/activation logic -> override `InitializeAsync`
         - Stop logic -> override `ShutdownAsync`
         - Dispose logic -> override `Dispose(bool)` calling `base.Dispose(disposing)`
      5. Add required PluginBase abstract members: `public override string Id => "air-gap-bridge";`, `public override string Name => "Air-Gap Bridge";`, etc. (check what's already there)
      6. Remove manual `_disposed` tracking in favor of PluginBase's built-in dispose chain
    - This is the most complex single migration in Phase 27. Take extra care with AD-08 zero regression.

    **Direct LegacyFeaturePluginBase standalone plugins:**
    For each of these, the migration pattern is:
    1. Change `: LegacyFeaturePluginBase` to the correct Hierarchy base
    2. Add `using DataWarehouse.SDK.Contracts.Hierarchy;`
    3. Implement required abstract members from the Hierarchy base
    4. Handle StartAsync/StopAsync -> InitializeAsync/ShutdownAsync lifecycle mapping:
       - If plugin has `override Task StartAsync(CancellationToken ct)` -> change to `override Task InitializeAsync(CancellationToken ct)` and call `base.InitializeAsync(ct)` at the end
       - If plugin has `override Task StopAsync()` -> change to `override Task ShutdownAsync(CancellationToken ct)` (note: ShutdownAsync takes CancellationToken, StopAsync didn't) and call `base.ShutdownAsync(ct)` at the end
       - If StartAsync/StopAsync are NOT overridden (just inherited abstract), simply remove them

    **Mapping:**
    - `AdaptiveTransportPlugin : LegacyFeaturePluginBase` -> `: StreamingPluginBase`
      - Implement PublishAsync, SubscribeAsync
    - `DataMarketplacePlugin : LegacyFeaturePluginBase` -> `: PlatformPluginBase`
      - Add: `public override string PlatformDomain => "DataMarketplace";`
    - `PluginMarketplacePlugin : LegacyFeaturePluginBase` -> `: PlatformPluginBase`
      - Add: `public override string PlatformDomain => "PluginMarketplace";`
    - `SelfEmulatingObjectsPlugin : LegacyFeaturePluginBase` -> `: ComputePluginBase`
      - Add: `public override string RuntimeType => "SelfEmulating";`
      - Add: `ExecuteWorkloadAsync` implementation
    - `FuseDriverPlugin : LegacyFeaturePluginBase` -> `: InterfacePluginBase` (Hierarchy)
      - Add: `public override string Protocol => "FUSE";`
    - `WinFspDriverPlugin : LegacyFeaturePluginBase` -> `: InterfacePluginBase` (Hierarchy)
      - Add: `public override string Protocol => "WinFsp";`
    - `UltimateFilesystemPlugin : LegacyFeaturePluginBase` -> `: StoragePluginBase` (Hierarchy.DataPipeline)
      - Implement 7 StoragePluginBase abstract methods (StoreAsync, RetrieveAsync, etc.)
    - `UltimateResourceManagerPlugin : LegacyFeaturePluginBase` -> `: InfrastructurePluginBase`
      - Add: `public override string InfrastructureDomain => "ResourceManagement";`
    - `UltimateDataLineagePlugin : LegacyFeaturePluginBase` -> `: DataManagementPluginBase`
      - DataManagementPluginBase has virtual-only methods, no abstract members required

    Build after each batch of 3-4 plugins.
  </action>
  <verify>
    `dotnet build DataWarehouse.slnx` -- all standalone plugins compile.
    Grep `IFeaturePlugin` in AirGapBridge -- should no longer directly implement it (inherited through chain).
    Grep `LegacyFeaturePluginBase` across all plugin directories -- should find zero direct references.
  </verify>
  <done>AirGapBridge on InfrastructurePluginBase. All 9 direct LegacyFeaturePluginBase standalone plugins migrated. Zero LegacyFeaturePluginBase in plugin code.</done>
</task>

<task type="auto">
  <name>Task 2: Verify AEDS and intermediate-base-dependent plugins compile, migrate remaining edge cases</name>
  <files>
    Plugins/DataWarehouse.Plugins.AedsCore/AedsCorePlugin.cs
    Plugins/DataWarehouse.Plugins.RaftConsensus/RaftConsensusPlugin.cs
    Plugins/DataWarehouse.Plugins.KubernetesCsi/KubernetesCsiPlugin.cs
    Plugins/DataWarehouse.Plugins.WasmCompute/WasmComputePlugin.cs
    Plugins/DataWarehouse.Plugins.SqlOverObject/SqlOverObjectPlugin.cs
    Plugins/DataWarehouse.Plugins.MediaTranscoding/MediaTranscodingPlugin.cs
  </files>
  <action>
    After Plan 27-01 re-parented SDK intermediate bases, these plugins should already be on the new Hierarchy through their intermediate bases. Verify they compile and fix any issues.

    **Verification and fix approach for each:**

    1. **AedsCore** (17 plugin classes across AEDS intermediate bases):
       - Plan 27-01 re-parented ControlPlaneTransportPluginBase -> InterfacePluginBase, DataPlaneTransportPluginBase -> InterfacePluginBase, ServerDispatcherPluginBase -> OrchestrationPluginBase, ClientSentinelPluginBase -> SecurityPluginBase, ClientExecutorPluginBase -> ComputePluginBase
       - The concrete AEDS plugins (GrpcControlPlane, MqttControlPlane, WebSocketControlPlane, Http2DataPlane, Http3DataPlane, QuicDataPlane, WebTransportDataPlane, ServerDispatcher, etc.) inherit these intermediate bases
       - New abstract members from Hierarchy bases (Protocol, OrchestrationMode, SecurityDomain, RuntimeType, ExecuteWorkloadAsync) will need implementation in either the intermediate bases or the concrete plugins
       - If intermediate bases don't implement them (left abstract), concrete plugins must. Read each concrete plugin file and add implementations.
       - For transport plugins needing Protocol: `"gRPC"`, `"MQTT"`, `"WebSocket"`, `"HTTP/2"`, `"HTTP/3"`, `"QUIC"`, `"WebTransport"`
       - NOTE: AedsCore has pre-existing CS0234 build errors. Do NOT attempt to fix those -- only ensure no NEW errors.

    2. **RaftConsensusPlugin** (via ConsensusPluginBase -> InfrastructurePluginBase):
       - Plan 27-01 re-parented ConsensusPluginBase. Raft inherits it.
       - Needs: `public override string InfrastructureDomain => "Consensus";` (either in ConsensusPluginBase or RaftConsensusPlugin)
       - Check if ConsensusPluginBase already implements InfrastructureDomain.

    3. **KubernetesCsiPlugin** (via old InterfacePluginBase -> new Hierarchy InterfacePluginBase):
       - Plan 27-01 resolved the name collision. KubernetesCsi inherits old InterfacePluginBase which now inherits new Hierarchy InterfacePluginBase.
       - Needs: `public override string Protocol` -- either in old InterfacePluginBase or KubernetesCsiPlugin
       - Add: `public override string Protocol => "CSI";`

    4. **WasmComputePlugin** (via WasmFunctionPluginBase -> ComputePluginBase):
       - Plan 27-01 re-parented WasmFunctionPluginBase.
       - Needs: `RuntimeType` and `ExecuteWorkloadAsync` -- either in WasmFunctionPluginBase or WasmComputePlugin
       - Add: `public override string RuntimeType => "WASM";` and map existing WASM execution to ExecuteWorkloadAsync

    5. **SqlOverObjectPlugin** (via DataVirtualizationPluginBase -> InterfacePluginBase):
       - Plan 27-01 re-parented DataVirtualizationPluginBase.
       - Needs: `Protocol` property
       - Add: `public override string Protocol => "SQL";`

    6. **MediaTranscodingPlugin** (via MediaTranscodingPluginBase -> MediaPluginBase):
       - Plan 27-01 re-parented MediaTranscodingPluginBase.
       - MediaPluginBase has NO abstract methods (check to confirm). Should compile cleanly.

    For each, build the specific project first, then build the full solution.

    After all fixes, do a final full solution build: `dotnet build DataWarehouse.slnx`
  </action>
  <verify>
    `dotnet build DataWarehouse.slnx` -- zero new errors (only pre-existing CS1729/CS0234 acceptable).
    Grep `LegacyFeaturePluginBase` across ALL Plugins/ directories -- should return ZERO matches.
    Grep `IntelligenceAwareEncryptionPluginBase|IntelligenceAwareCompressionPluginBase|IntelligenceAwareStoragePluginBase|IntelligenceAwareAccessControlPluginBase|IntelligenceAwareCompliancePluginBase|IntelligenceAwareKeyManagementPluginBase|IntelligenceAwareInterfacePluginBase|IntelligenceAwareConnectorPluginBase|IntelligenceAwareDataManagementPluginBase` across Plugins/ -- should return ZERO matches.
  </verify>
  <done>All AEDS, consensus, CSI, WASM, SQL, and media plugins verified on Hierarchy. Full solution builds. Zero LegacyFeaturePluginBase or obsolete IntelligenceAware* base references remain in any plugin file.</done>
</task>

</tasks>

<verification>
- Zero `LegacyFeaturePluginBase` references in any `Plugins/` directory
- Zero obsolete `IntelligenceAware*PluginBase` references in any `Plugins/` directory
- AirGapBridgePlugin no longer implements IFeaturePlugin directly
- `dotnet build DataWarehouse.slnx` shows only pre-existing errors
- All ~78 plugin classes inherit from a Hierarchy base (via direct or intermediate inheritance)
</verification>

<success_criteria>
1. AirGapBridgePlugin -> InfrastructurePluginBase with full PluginBase lifecycle (UPST-01)
2. All 9 direct LegacyFeaturePluginBase plugins migrated to correct Hierarchy bases
3. All AEDS sub-plugins compile after intermediate base re-parenting
4. RaftConsensus, KubernetesCsi, WasmCompute, SqlOverObject, MediaTranscoding verified building
5. Zero LegacyFeaturePluginBase or obsolete IntelligenceAware* references in plugin code
6. Full solution builds with zero new errors
</success_criteria>

<output>
After completion, create `.planning/phases/27-plugin-migration-decoupling/27-04-SUMMARY.md`
</output>
