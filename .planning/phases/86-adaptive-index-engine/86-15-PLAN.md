---
phase: 86-adaptive-index-engine
plan: 15
type: execute
wave: 4
depends_on: ["86-01"]
files_modified:
  - DataWarehouse.SDK/VirtualDiskEngine/AdaptiveIndex/SimdOperations.cs
  - DataWarehouse.SDK/VirtualDiskEngine/AdaptiveIndex/PersistentExtentTree.cs
autonomous: true
must_haves:
  truths:
    - "SIMD bloom probe processes 4 hash functions in single Vector256 operation"
    - "ART Node16 SIMD search finds key in single Vector128 comparison"
    - "Runtime Avx2.IsSupported/Sse2.IsSupported detection with scalar fallback"
    - "Persistent extent tree checkpoints to VDE blocks for crash recovery"
  artifacts:
    - path: "DataWarehouse.SDK/VirtualDiskEngine/AdaptiveIndex/SimdOperations.cs"
      provides: "SIMD-accelerated core operations"
      exports: ["SimdOperations"]
    - path: "DataWarehouse.SDK/VirtualDiskEngine/AdaptiveIndex/PersistentExtentTree.cs"
      provides: "Extent tree with VDE block persistence"
      exports: ["PersistentExtentTree"]
  key_links:
    - from: "SimdOperations"
      to: "ArtNode (Node16)"
      via: "SIMD key search in ART nodes"
      pattern: "SimdOperations\\.ArtNode16Search"
---

<objective>
Implement SIMD acceleration for bloom probe, ART Node16 search, XxHash, and bitmap scanning. Implement persistent extent tree with VDE block checkpointing for crash recovery.

Purpose: SIMD operations are the foundation of performance-critical paths across the adaptive index. Persistent extent tree enables the index to track block allocations durably.
Output: 2 files implementing SIMD operations and persistent extent tree.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@DataWarehouse.SDK/VirtualDiskEngine/BlockAllocation/SimdBitmapScanner.cs
@DataWarehouse.SDK/VirtualDiskEngine/BlockAllocation/ExtentTree.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: SIMD-accelerated operations for bloom, ART, hash, and bitmap</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/AdaptiveIndex/SimdOperations.cs
  </files>
  <action>
    **SimdOperations.cs**: Static class providing SIMD-accelerated operations used across the adaptive index.

    1. **Bloom filter SIMD probe** — `BloomProbe(byte[] filter, byte[] key, int hashCount)`:
       - Compute hashCount hash values via XxHash64 with different seeds
       - Pack 4 hash-derived bit positions into `Vector256<int>`
       - Load 4 filter bytes at those positions into another Vector256
       - `Avx2.And` + compare — single operation checks 4 positions
       - If `Avx2.IsSupported`, process 4 at a time. Else scalar loop.
       - Returns bool (all bits set = may contain).

    2. **ART Node16 SIMD search** — `ArtNode16Search(byte[] nodeKeys, byte searchKey)`:
       - Load 16 node keys into `Vector128<byte>` via `Sse2.LoadVector128`
       - Broadcast search key: `Sse2.SetAllVector128(searchKey)`
       - `Sse2.CompareEqual` → mask
       - `Sse2.MoveMask` → bitmask of matches
       - `BitOperations.TrailingZeroCount(mask)` → index of match
       - Returns index or -1 if not found
       - Scalar fallback: linear scan of 16 bytes

    3. **Bitmap SIMD scanning** — `FindFirstZeroBit256(byte[] bitmap, long startBit, long totalBits)`:
       - Enhancement of existing `SimdBitmapScanner`. Process 32 bytes (256 bits) at a time via `Vector256<byte>`.
       - `Avx2.CompareEqual(chunk, allOnes)` → mask of all-1 bytes
       - `Avx2.MoveMask` → skip if all 0xFF
       - When non-0xFF found, narrow to byte, use `BitOperations.TrailingZeroCount`
       - 4x speedup over ulong-at-a-time scanning

    4. **XxHash SIMD** — `XxHash64Simd(ReadOnlySpan<byte> data, ulong seed)`:
       - For data >= 32 bytes: process 32 bytes per iteration using 4x Vector256<ulong> accumulators
       - Follows XXH64 algorithm: round(), mergeRound(), finalize()
       - For data < 32 bytes: standard scalar XXH64
       - `[MethodImpl(MethodImplOptions.AggressiveInlining)]`

    5. **Runtime capability detection**:
       - `static readonly bool HasAvx2 = Avx2.IsSupported`
       - `static readonly bool HasSse2 = Sse2.IsSupported`
       - `static readonly bool HasAvx512 = Avx512BW.IsSupported` (future)
       - Each method checks flags and dispatches to SIMD or scalar path
       - `static string GetCapabilityString()`: Returns "AVX2+SSE2", "SSE2", "Scalar" for diagnostics

    All methods are static with `[MethodImpl(MethodImplOptions.AggressiveInlining)]`.
    Add `[SdkCompatibility("6.0.0", Notes = "Phase 86: AIE-15 SIMD operations")]`.
  </action>
  <verify>Build: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore` compiles with zero errors.</verify>
  <done>SimdOperations provides SIMD-accelerated bloom probe (4 hashes at once), ART Node16 search (single Vector128 compare), bitmap scanning (256-bit chunks), and XxHash64. Runtime detection with scalar fallback.</done>
</task>

<task type="auto">
  <name>Task 2: Persistent extent tree with VDE block checkpointing</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/AdaptiveIndex/PersistentExtentTree.cs
  </files>
  <action>
    **PersistentExtentTree.cs**: Extends the existing in-memory `ExtentTree` with durable persistence to VDE blocks.

    1. **PersistentExtentTree** class (wraps `ExtentTree`):
       - Constructor: `IBlockDevice device`, `IBlockAllocator allocator`, `IWriteAheadLog wal`, `long regionStartBlock`, `int blockSize`
       - Delegates all in-memory operations (AddFreeExtent, AllocateExtent, etc.) to inner `ExtentTree`
       - Adds persistence layer on top

    2. **Checkpoint to VDE blocks**:
       - `CheckpointAsync()`: Serialize entire extent tree state to VDE blocks.
       - Format per block: [MagicEXTR:4][Version:2][ExtentCount:4][Extents:(StartBlock:8, Count:4)*N][XxHash64:8]
       - Multi-block: if extents exceed one block, chain via next-block pointer in header
       - WAL-protect: write WAL entry before checkpoint, complete after
       - `_dirty` flag: set on any mutation, cleared on checkpoint

    3. **Load from VDE blocks**:
       - `LoadAsync()`: Read extent tree blocks from region, deserialize, populate inner ExtentTree
       - Validate XxHash64 checksum per block
       - On corruption: log warning, return empty tree (caller must rebuild from allocation bitmap)

    4. **Incremental checkpointing**:
       - `_changeLog` ConcurrentQueue of extent mutations since last checkpoint
       - `IncrementalCheckpointAsync()`: Only write changed extents (append new block with deltas)
       - Delta format: [MagicEXTD:4][DeltaCount:4][(Operation:1)(StartBlock:8)(Count:4)*N][XxHash64:8]
       - Operation: 0 = AddFree, 1 = RemoveFree (allocated)
       - Full checkpoint rebuilds from scratch, clearing delta chain

    5. **Auto-checkpoint policy**:
       - `CheckpointPolicy`: `int ChangeThreshold` (default 1000), `TimeSpan TimeThreshold` (default 60s)
       - Background timer triggers checkpoint when either threshold exceeded
       - `_checkpointLock` SemaphoreSlim(1,1) prevents concurrent checkpoints

    6. **Crash recovery**:
       - On load: read full checkpoint, then replay any delta blocks after it
       - If delta blocks are corrupt (partial write during crash): discard deltas, use last full checkpoint
       - `RecoverAsync()`: Load + replay deltas + mark clean

    Thread safety: Inner ExtentTree mutations protected by `ReaderWriterLockSlim`. Checkpoint is read-side (snapshots state) so doesn't block mutations.

    Add `[SdkCompatibility("6.0.0", Notes = "Phase 86: AIE-15 Persistent extent tree")]`.
  </action>
  <verify>Build: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore` compiles with zero errors.</verify>
  <done>PersistentExtentTree wraps ExtentTree with VDE block persistence, incremental checkpointing, WAL protection, and crash recovery.</done>
</task>

</tasks>

<verification>
- Both files exist under `DataWarehouse.SDK/VirtualDiskEngine/AdaptiveIndex/`
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` succeeds with zero errors
- SIMD operations check Avx2.IsSupported/Sse2.IsSupported at runtime
- Persistent extent tree has full + incremental checkpoint modes
</verification>

<success_criteria>
- SIMD bloom probe processes 4 hashes in single Vector256 operation
- ART Node16 search finds key in single Vector128 comparison
- Persistent extent tree checkpoints to VDE blocks durably
- Crash recovery replays delta blocks after last full checkpoint
- All operations have scalar fallback when SIMD unavailable
- Build passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/86-adaptive-index-engine/86-15-SUMMARY.md`
</output>
