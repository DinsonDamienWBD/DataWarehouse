---
phase: 86-adaptive-index-engine
plan: 06
type: execute
wave: 3
depends_on: ["86-01", "86-02", "86-03", "86-04"]
files_modified:
  - DataWarehouse.SDK/VirtualDiskEngine/AdaptiveIndex/IndexMorphAdvisor.cs
  - DataWarehouse.SDK/VirtualDiskEngine/AdaptiveIndex/IndexMorphPolicy.cs
  - DataWarehouse.SDK/VirtualDiskEngine/AdaptiveIndex/MorphMetrics.cs
autonomous: true
must_haves:
  truths:
    - "Advisor makes autonomous morph decisions based on real metrics"
    - "All morph decisions are logged to VDE audit log"
    - "Admin can override advisor decisions via IndexMorphPolicy"
    - "Thresholds are self-tuning based on observed latency regression"
  artifacts:
    - path: "DataWarehouse.SDK/VirtualDiskEngine/AdaptiveIndex/IndexMorphAdvisor.cs"
      provides: "Autonomous morph decision engine"
      exports: ["IndexMorphAdvisor"]
    - path: "DataWarehouse.SDK/VirtualDiskEngine/AdaptiveIndex/IndexMorphPolicy.cs"
      provides: "Admin policy override for morph decisions"
      exports: ["IndexMorphPolicy"]
  key_links:
    - from: "IndexMorphAdvisor"
      to: "MorphMetrics"
      via: "reads metrics to determine optimal level"
      pattern: "_metrics\\."
    - from: "IndexMorphAdvisor"
      to: "IndexMorphPolicy"
      via: "policy check before executing morph"
      pattern: "_policy\\.IsAllowed|_policy\\.GetOverride"
---

<objective>
Implement IndexMorphAdvisor (autonomous decision engine with metrics, threshold self-tuning, latency regression auto-revert), IndexMorphPolicy (admin override), and VDE Audit Log integration.

Purpose: The morph advisor is the brain of the adaptive index — it decides when and how to morph based on real-time metrics (object count, R/W ratio, latency, entropy). Admin policies provide guardrails. Self-tuning prevents oscillation.
Output: 3 files implementing the advisory and policy system.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/86-adaptive-index-engine/86-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Morph metrics collection and policy system</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/AdaptiveIndex/MorphMetrics.cs
    DataWarehouse.SDK/VirtualDiskEngine/AdaptiveIndex/IndexMorphPolicy.cs
  </files>
  <action>
    1. **MorphMetrics.cs**: Real-time metrics collection for morph decisions.
       - `MorphMetricsCollector`: Collects metrics with sliding windows.
         - `long ObjectCount` — current count via Interlocked
         - `double ReadWriteRatio` — reads / (reads + writes) over last 60 seconds. Uses two `long` counters reset every 60s.
         - `double P50LatencyMs`, `double P99LatencyMs` — from sorted circular buffer of last 10,000 operation latencies (Stopwatch ticks -> ms)
         - `double KeyEntropy` — Shannon entropy of key prefix distribution. Sample last 1,000 keys, bucket by first 4 bytes, compute -sum(p*log2(p)). High entropy = uniform, low = skewed.
         - `double InsertRate` — inserts per second (sliding 10s window)
         - `RecordRead(long latencyTicks)`, `RecordWrite(long latencyTicks)`, `RecordInsert(byte[] key)`, `RecordDelete()`
         - Thread-safe: Interlocked for counters, lock-free ring buffer for latencies

       - `MorphMetricsSnapshot` record: Captures all metrics at a point in time for decision-making. `ObjectCount`, `ReadWriteRatio`, `P50LatencyMs`, `P99LatencyMs`, `KeyEntropy`, `InsertRate`, `MorphLevel CurrentLevel`, `DateTimeOffset Timestamp`.

    2. **IndexMorphPolicy.cs**: Admin override policy.
       - `IndexMorphPolicy`: Configurable constraints on morph behavior.
         - `MorphLevel? MinLevel` — never morph below this (null = no minimum)
         - `MorphLevel? MaxLevel` — never morph above this
         - `MorphLevel? ForcedLevel` — always use this level (overrides advisor)
         - `bool AllowBackwardMorph` — default true. Set false to prevent demotion.
         - `TimeSpan MorphCooldown` — minimum time between morphs (default 5 minutes, prevents oscillation)
         - `Dictionary<MorphLevel, bool> DisabledLevels` — explicitly disable specific levels
         - `bool IsAllowed(MorphLevel from, MorphLevel to)` — checks all constraints
         - `MorphLevel? GetOverride()` — returns ForcedLevel if set
         - Serialization: JSON via System.Text.Json with `[JsonPropertyName]` attributes
         - `static IndexMorphPolicy Default` — no constraints, 5-min cooldown
         - `static IndexMorphPolicy Conservative` — MaxLevel = BeTree, no backward morph, 15-min cooldown
         - `static IndexMorphPolicy Performance` — no constraints, 1-min cooldown, AllowBackwardMorph = true
  </action>
  <verify>Build: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore` compiles with zero errors.</verify>
  <done>MorphMetricsCollector tracks object count, R/W ratio, latency percentiles, key entropy, and insert rate. IndexMorphPolicy provides admin override constraints with presets.</done>
</task>

<task type="auto">
  <name>Task 2: IndexMorphAdvisor autonomous decision engine</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/AdaptiveIndex/IndexMorphAdvisor.cs
  </files>
  <action>
    **IndexMorphAdvisor.cs**: The decision engine that recommends morph level transitions.

    Constructor: `MorphMetricsCollector metrics`, `IndexMorphPolicy policy`, `Action<MorphAuditEntry>? auditLogger` (optional, for VDE audit log integration).

    **Core decision algorithm** — `MorphLevel? Recommend(MorphMetricsSnapshot snapshot)`:

    1. Check policy override: if `ForcedLevel` set, return it.
    2. Compute recommended level based on object count thresholds:
       - 0-1 objects: Level 0 (DirectPointer)
       - 2-10K: Level 1 (SortedArray)
       - 10K-1M: Level 2 (ART)
       - 1M-100M: Level 3 (BeTree)
       - 100M-10B: check if ALEX beneficial (R/W ratio > 0.7 and key entropy < 3.0): Level 4, else Level 3
       - 10B-1T: Level 5 (Forest)
       - 1T+: Level 6 (Distributed)
    3. Apply modifiers:
       - If P99 latency > 10ms and current level > recommended: recommend downgrade (complexity hurting performance)
       - If insert rate > 100K/s and current level uses ALEX: recommend Level 3 (ALEX overhead on heavy writes)
       - If R/W ratio > 0.9 (read-heavy) at Level 3: consider Level 4 (ALEX helps reads)
    4. Check policy constraints: `_policy.IsAllowed(current, recommended)`
    5. Check cooldown: if last morph was within cooldown period, return null (no change)
    6. If recommended != current, return recommended. Else return null.

    **Self-tuning thresholds**:
    - After each morph, record pre-morph and post-morph P99 latency.
    - If post-morph P99 > pre-morph P99 * 1.5 (50% regression), auto-revert to previous level and increase the threshold that triggered the morph by 2x (prevents re-triggering).
    - `Dictionary<(MorphLevel From, MorphLevel To), int> _revertCount` — if reverted 3 times for same transition, permanently disable it.
    - `_adjustedThresholds` dictionary overrides default object count thresholds.

    **Audit logging**:
    - `MorphAuditEntry` record: `DateTimeOffset Timestamp`, `MorphLevel FromLevel`, `MorphLevel ToLevel`, `MorphMetricsSnapshot Metrics`, `string Reason`, `bool WasAutoReverted`
    - Every recommendation logged via `_auditLogger?.Invoke(entry)`

    **Periodic evaluation**:
    - `EvaluateAsync()` — called by AdaptiveIndexEngine on a timer (default every 30 seconds)
    - Takes snapshot, runs Recommend, returns advisory result
    - Does NOT execute the morph (caller decides)

    Thread-safe: All state in `_adjustedThresholds` and `_revertCount` protected by lock. Metrics collector is independently thread-safe.

    Add `[SdkCompatibility("6.0.0", Notes = "Phase 86: AIE-06 IndexMorphAdvisor")]`.
  </action>
  <verify>Build: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore` compiles with zero errors.</verify>
  <done>IndexMorphAdvisor makes autonomous morph decisions based on object count, R/W ratio, latency, and key entropy. Self-tunes thresholds after regressions. All decisions audit-logged. Policy constraints honored.</done>
</task>

</tasks>

<verification>
- All 3 files exist under `DataWarehouse.SDK/VirtualDiskEngine/AdaptiveIndex/`
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` succeeds with zero errors
- Advisor considers 6+ metrics for morph decisions
- Self-tuning reverts and adjusts thresholds on latency regression
- Policy ForcedLevel overrides all advisor logic
</verification>

<success_criteria>
- IndexMorphAdvisor recommends morph levels based on real metrics
- All decisions are audit-logged with reason and metrics snapshot
- Admin policy constraints (min/max/forced level, cooldown) are honored
- Self-tuning prevents oscillation via revert detection and threshold adjustment
- Build passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/86-adaptive-index-engine/86-06-SUMMARY.md`
</output>
