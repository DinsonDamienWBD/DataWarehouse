---
phase: 86-adaptive-index-engine
plan: 16
type: execute
wave: 5
depends_on: ["86-05", "86-06", "86-07", "86-08", "86-12", "86-13", "86-14", "86-15"]
files_modified:
  - DataWarehouse.Tests/AdaptiveIndex/MorphSpectrumTests.cs
  - DataWarehouse.Tests/AdaptiveIndex/IndexRaidTests.cs
  - DataWarehouse.Tests/AdaptiveIndex/PerformanceBenchmarks.cs
  - DataWarehouse.Tests/AdaptiveIndex/LegacyMigrationTests.cs
autonomous: true
must_haves:
  truths:
    - "Full morph spectrum test: insert to Level 6, delete back to Level 0"
    - "Index RAID tests verify striping, mirroring, and tiering"
    - "Backward morph verified: 1M objects -> delete 999K -> Level 1"
    - "v1.0 B-tree opens correctly and migrates to Be-tree"
    - "Performance benchmarks compare each level vs current B-tree"
  artifacts:
    - path: "DataWarehouse.Tests/AdaptiveIndex/MorphSpectrumTests.cs"
      provides: "Full morph spectrum integration tests"
      min_lines: 200
    - path: "DataWarehouse.Tests/AdaptiveIndex/IndexRaidTests.cs"
      provides: "Index RAID configuration tests"
      min_lines: 100
    - path: "DataWarehouse.Tests/AdaptiveIndex/LegacyMigrationTests.cs"
      provides: "v1.0 B-tree compatibility tests"
      min_lines: 50
  key_links:
    - from: "MorphSpectrumTests"
      to: "AdaptiveIndexEngine"
      via: "exercises full Level 0-6 morph cycle"
      pattern: "engine\\.InsertAsync|engine\\.CurrentLevel"
---

<objective>
Implement comprehensive AIE integration tests: full morph spectrum test (insert to Level 6, delete back to Level 0), Index RAID tests, backward morph tests, v1.0 B-tree migration, and performance benchmarks comparing each level vs current B-tree.

Purpose: Final verification that all AIE components work together correctly. Exercises the full morph cycle, RAID configurations, legacy compatibility, and performance characteristics.
Output: 4 test files covering all AIE requirements.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/86-adaptive-index-engine/86-01-SUMMARY.md
@.planning/phases/86-adaptive-index-engine/86-02-SUMMARY.md
@.planning/phases/86-adaptive-index-engine/86-07-SUMMARY.md
@.planning/phases/86-adaptive-index-engine/86-08-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Morph spectrum tests and backward morph verification</name>
  <files>
    DataWarehouse.Tests/AdaptiveIndex/MorphSpectrumTests.cs
    DataWarehouse.Tests/AdaptiveIndex/LegacyMigrationTests.cs
  </files>
  <action>
    1. **MorphSpectrumTests.cs**: xUnit tests exercising the full morph spectrum.

       Test infrastructure:
       - `InMemoryBlockDevice` implementing `IBlockDevice` with `Dictionary<long, byte[]>` (for fast tests without disk)
       - `InMemoryBlockAllocator` implementing `IBlockAllocator` with monotonic counter
       - `InMemoryWriteAheadLog` implementing `IWriteAheadLog` with `List<byte[]>`
       - Helper: `CreateEngine(int blockSize = 4096)` returns configured AdaptiveIndexEngine

       Tests (one per morph level transition):
       - `Level0_SingleObject_DirectPointer`: Insert 1 object, verify CurrentLevel = DirectPointer, lookup succeeds
       - `Level0To1_AutoMorph_OnSecondInsert`: Insert 2 objects, verify CurrentLevel = SortedArray
       - `Level1_SortedArray_BinarySearch`: Insert 100 objects, verify all lookups succeed, verify sorted range query
       - `Level1To2_AutoMorph_At10K`: Insert 10,001 objects, verify CurrentLevel = AdaptiveRadixTree
       - `Level2_ART_PathCompression`: Insert keys with shared prefix, verify path compression (fewer nodes than keys)
       - `Level2To3_AutoMorph_At1M`: Insert 1,000,001 objects (use sequential keys for speed), verify CurrentLevel = BeTree
       - `Level3_BeTree_MessageBuffering`: Insert keys, verify they're queryable before flush (buffered in message buffer)
       - `Level3_BeTree_TombstonePropagation`: Insert then delete, verify lookup returns null
       - `ForwardMorph_Level0Through5`: Progressive insert triggering each level transition. Assert CurrentLevel at each threshold. (Level 6 requires distributed setup, test separately.)
       - `BackwardMorph_Level3ToLevel1`: Insert 1M objects (Level 3), delete 999,000, verify CurrentLevel drops to Level 1
       - `BackwardMorph_Level2ToLevel0`: Insert 50K (Level 2), delete all but 1, verify Level 0
       - `ZeroDowntime_ReadsWorkDuringMorph`: Start morph, issue concurrent reads, verify all succeed
       - `MorphAdvisor_RecommendsCorrectLevel`: Create metrics snapshot, verify advisor returns expected level
       - `MorphAdvisor_PolicyOverride`: Set ForcedLevel, verify advisor returns forced level regardless of metrics
       - `MorphAdvisor_CooldownPreventsOscillation`: Trigger morph, immediately re-evaluate, verify null (cooldown active)
       - `CrashRecovery_ResumesFromCheckpoint`: Start morph, simulate crash (abort WAL), recover, verify complete or clean abort

    2. **LegacyMigrationTests.cs**: v1.0 B-tree compatibility.
       - `V1BTree_OpensCorrectly`: Create a BTree (existing implementation), populate with entries, verify AdaptiveIndexEngine can wrap it as Level 3 equivalent
       - `V1BTree_MigratesToBeTree`: Create BTree, wrap in migration engine, migrate to BeTree, verify all entries preserved
       - `MigratedBeTree_PerformsCorrectly`: After migration, insert/delete/lookup/range all work correctly
       - `MigrationIsIdempotent`: Migrating already-migrated index is a no-op
  </action>
  <verify>Run: `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter "FullyQualifiedName~AdaptiveIndex.MorphSpectrum|FullyQualifiedName~AdaptiveIndex.LegacyMigration" --no-restore` — all tests pass.</verify>
  <done>Full morph spectrum covered: Level 0 through 5 forward and backward. Backward morph verified (1M -> delete 999K -> Level 1). v1.0 B-tree migration to Be-tree verified. Crash recovery tested.</done>
</task>

<task type="auto">
  <name>Task 2: Index RAID tests and performance benchmarks</name>
  <files>
    DataWarehouse.Tests/AdaptiveIndex/IndexRaidTests.cs
    DataWarehouse.Tests/AdaptiveIndex/PerformanceBenchmarks.cs
  </files>
  <action>
    1. **IndexRaidTests.cs**: xUnit tests for Index RAID configurations.
       - Use same InMemoryBlockDevice/Allocator/WAL from MorphSpectrumTests

       Tests:
       - `Striping_4Way_InsertAndLookup`: Create 4-stripe index, insert 10K entries, verify all lookups succeed
       - `Striping_4Way_RangeQuery_MergesSorted`: Insert unsorted keys across stripes, range query returns sorted
       - `Striping_DistributesEvenly`: Insert 10K entries, verify per-stripe counts are within 20% of each other
       - `Mirroring_2Way_Sync_AllCopiesMatch`: Insert entries with sync mirroring, verify both mirrors have identical data
       - `Mirroring_2Way_ReadFromPrimary`: Reads always come from primary mirror
       - `Mirroring_Rebuild_RestoresDegraded`: Corrupt one mirror, rebuild from primary, verify restored
       - `StripeMirror_RAID10_Functionality`: 4 stripes x 2 mirrors, insert/lookup/delete all work
       - `Tiering_HotKeyInL1`: Insert keys, access one key 20 times, verify it's promoted to L1 (lookup latency should be faster)
       - `Tiering_ColdKeyDemoted`: Insert many keys, don't access some, verify they stay in L2/L3
       - `Tiering_CountMinSketch_Accuracy`: Insert access patterns, verify count-min sketch estimates are within 2x of actual
       - `PerShardMorphLevel_DifferentLevels`: Create forest with 2 shards, insert different amounts, verify shards at different morph levels

    2. **PerformanceBenchmarks.cs**: Performance comparison tests (lightweight, not full benchmarks).
       - `BeTree_VsBTree_SequentialInsert`: Insert 100K sequential keys into both, measure wall clock. Assert BeTree uses fewer "I/O operations" (tracked via counter on InMemoryBlockDevice).
       - `ART_PointLookup_VsBTree`: 10K lookups on 100K entries. Assert ART is faster (fewer node reads).
       - `SortedArray_SmallSet_Fastest`: For 100 entries, sorted array should be fastest (no tree overhead).
       - `ALEX_SkewedWorkload`: Insert 100K entries with Zipfian distribution, train ALEX, measure hit rate > 0.7.
       - `Striping_4Way_ReadThroughput`: Measure parallel reads across 4 stripes vs single index.
       - `BloomFilter_FalsePositiveRate`: Insert 10K keys, check 10K non-existent keys, verify FPR < 5%.
       - `Disruptor_MessageThroughput`: Publish 1M messages, measure messages/sec > 1M.
       - `ExtendibleHash_GrowthNoRebuild`: Insert 100K inodes, verify no full-table rebuild (only directory doublings).
       - `HilbertVsZOrder_Locality`: Compare locality ratios on 2D point set, assert Hilbert > Z-order.
       - `SimdBloomProbe_VsScalar`: Measure bloom probe with SIMD vs scalar, verify SIMD faster (when available).
       - Each test uses `Stopwatch` and asserts relative performance (not absolute, for CI stability).
  </action>
  <verify>Run: `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter "FullyQualifiedName~AdaptiveIndex.IndexRaid|FullyQualifiedName~AdaptiveIndex.PerformanceBenchmark" --no-restore` — all tests pass.</verify>
  <done>Index RAID (striping, mirroring, tiering) fully tested. Performance benchmarks verify Be-tree vs B-tree, ALEX hit rate, Disruptor throughput, Hilbert locality, and SIMD acceleration.</done>
</task>

</tasks>

<verification>
- All 4 test files exist under `DataWarehouse.Tests/AdaptiveIndex/`
- `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter "FullyQualifiedName~AdaptiveIndex"` — all tests pass
- Full morph spectrum: Level 0 -> 5 forward, Level 3 -> 1 backward
- Index RAID: striping, mirroring, tiering all verified
- v1.0 B-tree migration verified
</verification>

<success_criteria>
- All morph level transitions (0-5) tested forward and backward
- Backward morph: insert 1M, delete 999K, verify demotion to Level 1
- v1.0 B-tree opens correctly and migrates to Be-tree
- Index RAID striping/mirroring/tiering all functional
- Performance benchmarks confirm expected characteristics
- All tests pass with zero failures
</success_criteria>

<output>
After completion, create `.planning/phases/86-adaptive-index-engine/86-16-SUMMARY.md`
</output>
