---
phase: 77-ai-policy-intelligence
plan: 03
type: execute
wave: 2
depends_on: ["77-01"]
files_modified:
  - DataWarehouse.SDK/Infrastructure/Intelligence/ThreatDetector.cs
  - DataWarehouse.SDK/Infrastructure/Intelligence/CostAnalyzer.cs
  - DataWarehouse.SDK/Infrastructure/Intelligence/DataSensitivityAnalyzer.cs
autonomous: true

must_haves:
  truths:
    - "ThreatDetector feeds into policy tightening when threat signals exceed threshold"
    - "CostAnalyzer calculates cloud billing and per-algorithm compute cost for recommendation rationale"
    - "DataSensitivityAnalyzer detects PII and classification patterns in sampled data"
    - "All three implement IAiAdvisor and process observation batches"
  artifacts:
    - path: "DataWarehouse.SDK/Infrastructure/Intelligence/ThreatDetector.cs"
      provides: "Threat signal detection and policy tightening triggers"
      contains: "class ThreatDetector"
    - path: "DataWarehouse.SDK/Infrastructure/Intelligence/CostAnalyzer.cs"
      provides: "Cloud billing and compute cost analysis"
      contains: "class CostAnalyzer"
    - path: "DataWarehouse.SDK/Infrastructure/Intelligence/DataSensitivityAnalyzer.cs"
      provides: "PII and data classification detection"
      contains: "class DataSensitivityAnalyzer"
  key_links:
    - from: "DataWarehouse.SDK/Infrastructure/Intelligence/ThreatDetector.cs"
      to: "DataWarehouse.SDK/Infrastructure/Intelligence/AiObservationPipeline.cs"
      via: "implements IAiAdvisor"
      pattern: "IAiAdvisor"
    - from: "DataWarehouse.SDK/Infrastructure/Intelligence/CostAnalyzer.cs"
      to: "DataWarehouse.SDK/Infrastructure/Intelligence/AiObservationPipeline.cs"
      via: "implements IAiAdvisor"
      pattern: "IAiAdvisor"
---

<objective>
Implement ThreatDetector, CostAnalyzer, and DataSensitivityAnalyzer advisors that consume observation events to detect security threats, track costs, and identify sensitive data patterns.

Purpose: AIPI-04, AIPI-05, AIPI-06 -- these advisors provide security, cost, and sensitivity context for the PolicyAdvisor (Plan 04).
Output: Three IAiAdvisor implementations in Infrastructure/Intelligence/
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/77-ai-policy-intelligence/77-01-SUMMARY.md
@DataWarehouse.SDK/Infrastructure/Intelligence/AiObservationPipeline.cs
@DataWarehouse.SDK/Infrastructure/Intelligence/AiObservationRingBuffer.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: ThreatDetector advisor</name>
  <files>DataWarehouse.SDK/Infrastructure/Intelligence/ThreatDetector.cs</files>
  <action>
Create `ThreatDetector.cs` in `DataWarehouse.SDK/Infrastructure/Intelligence/`:

- Namespace: `DataWarehouse.SDK.Infrastructure.Intelligence`
- `[SdkCompatibility("6.0.0", Notes = "Phase 77: AI Policy Intelligence (AIPI-04)")]`
- `sealed class ThreatDetector : IAiAdvisor`
- `string AdvisorId => "threat_detector"`

**ThreatLevel enum:** None = 0, Low = 1, Elevated = 2, High = 3, Critical = 4

**ThreatAssessment record:**
- `ThreatLevel Level`
- `double ThreatScore` (0.0-1.0)
- `List<ThreatSignal> ActiveSignals`
- `bool ShouldTightenPolicy` -- true if Level >= Elevated
- `DateTimeOffset AssessedAt`

**ThreatSignal record:**
- `string SignalType` (e.g., "auth_failure_spike", "anomaly_rate_high", "access_pattern_anomaly", "data_exfiltration_attempt")
- `double Confidence` (0.0-1.0)
- `string Description`
- `DateTimeOffset DetectedAt`

**Detection logic in ProcessObservationsAsync:**
- Track anomaly observations (where AnomalyType is not null) in a sliding window (last 5 minutes)
- Signal: "anomaly_rate_high" if anomaly count > 10 in 5 minutes
- Signal: "auth_failure_spike" if observations with MetricName containing "auth_fail" exceed 5/minute
- Signal: "access_pattern_anomaly" if observations from a single PluginId spike > 5x their rolling average
- Signal: "data_exfiltration_attempt" if observations with MetricName "data_read_bytes" show sudden 10x spike
- ThreatScore = weighted sum of active signal confidences (max 1.0)
- ThreatLevel: None (0-0.1), Low (0.1-0.3), Elevated (0.3-0.6), High (0.6-0.8), Critical (0.8-1.0)

**Policy tightening output:**
- `bool ShouldTightenPolicy` returns true when Level >= Elevated
- `CascadeStrategy RecommendedCascade` -- returns MostRestrictive when High+, Enforce when Critical
- `double configuredThreshold` (default 0.3) -- constructor parameter for when ShouldTightenPolicy triggers

**Public API:**
- `ThreatAssessment CurrentAssessment { get; }` (volatile swap)
  </action>
  <verify>
`dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` succeeds with zero errors.
  </verify>
  <done>
ThreatDetector tracks 4 signal types via sliding windows, computes composite threat score, triggers policy tightening above configurable threshold. AIPI-04 satisfied.
  </done>
</task>

<task type="auto">
  <name>Task 2: CostAnalyzer and DataSensitivityAnalyzer advisors</name>
  <files>
    DataWarehouse.SDK/Infrastructure/Intelligence/CostAnalyzer.cs
    DataWarehouse.SDK/Infrastructure/Intelligence/DataSensitivityAnalyzer.cs
  </files>
  <action>
**CostAnalyzer.cs:**
- Namespace: `DataWarehouse.SDK.Infrastructure.Intelligence`
- `[SdkCompatibility("6.0.0", Notes = "Phase 77: AI Policy Intelligence (AIPI-05)")]`
- `sealed class CostAnalyzer : IAiAdvisor`
- `string AdvisorId => "cost_analyzer"`

**CostProfile record:**
- `Dictionary<string, AlgorithmCost> AlgorithmCosts` -- per-algorithm compute cost tracking
- `double EstimatedHourlyCostUsd` -- estimated based on observation rates and algorithm costs
- `double EstimatedMonthlyCostUsd`
- `string MostExpensiveAlgorithm` -- highest cost/operation
- `string MostEfficientAlgorithm` -- lowest cost/operation
- `DateTimeOffset CalculatedAt`

**AlgorithmCost record:**
- `string AlgorithmId`
- `long OperationCount`
- `double AverageDurationMs`
- `double EstimatedCpuCostPerOp` -- CPU-seconds per operation
- `double EstimatedCloudCostPerOp` -- USD estimate (configurable rate per CPU-second, default $0.000012/CPU-sec for general compute)

**ProcessObservationsAsync:**
- Track observations where MetricName matches patterns like "algorithm_*_duration_ms", "encryption_*_ms", "compression_*_ms"
- Parse algorithm ID from metric name
- Update AlgorithmCost rolling averages
- Compute hourly/monthly projections from current operation rates

**Constructor:** Takes `double cpuCostPerSecondUsd = 0.000012` (configurable cloud billing rate)

**Public API:**
- `CostProfile CurrentProfile { get; }` (volatile swap)
- `AlgorithmCost? GetCostForAlgorithm(string algorithmId)`

---

**DataSensitivityAnalyzer.cs:**
- Namespace: `DataWarehouse.SDK.Infrastructure.Intelligence`
- `[SdkCompatibility("6.0.0", Notes = "Phase 77: AI Policy Intelligence (AIPI-06)")]`
- `sealed class DataSensitivityAnalyzer : IAiAdvisor`
- `string AdvisorId => "data_sensitivity_analyzer"`

**SensitivityProfile record:**
- `DataClassification HighestClassification` (enum: Public = 0, Internal = 1, Confidential = 2, Restricted = 3, TopSecret = 4)
- `bool PiiDetected`
- `List<SensitivitySignal> ActiveSignals`
- `double SensitivityScore` (0.0-1.0)
- `DateTimeOffset AssessedAt`

**SensitivitySignal record:**
- `string SignalType` (e.g., "pii_email", "pii_ssn", "pii_phone", "classification_restricted", "hipaa_phi", "gdpr_personal")
- `double Confidence`
- `string PluginId` -- which plugin's observations triggered this
- `DateTimeOffset DetectedAt`

**Detection in ProcessObservationsAsync:**
- Track observations where MetricName matches "pii_*" or "classification_*" or "sensitivity_*"
- PII signals: observations with MetricName "pii_detected" or AnomalyType containing "pii"
- Classification signals: observations with MetricName "data_classification" where Value maps to enum (0=Public...4=TopSecret)
- Compute SensitivityScore as max of all signal confidences
- Set HighestClassification from the most sensitive signal detected

**Public API:**
- `SensitivityProfile CurrentProfile { get; }` (volatile swap)
- `bool RequiresEncryption` -- true if HighestClassification >= Confidential
- `bool RequiresAuditTrail` -- true if PiiDetected or HighestClassification >= Restricted
  </action>
  <verify>
`dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` succeeds with zero errors.
  </verify>
  <done>
CostAnalyzer tracks per-algorithm compute costs with cloud billing projection. DataSensitivityAnalyzer detects PII signals and data classification patterns. Both implement IAiAdvisor. AIPI-05 and AIPI-06 satisfied.
  </done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` -- zero errors
- All three classes implement IAiAdvisor
- ThreatDetector has ShouldTightenPolicy with configurable threshold
- CostAnalyzer tracks per-algorithm costs with USD projections
- DataSensitivityAnalyzer has PII detection and classification
</verification>

<success_criteria>
1. ThreatDetector tracks threat signals and triggers policy tightening (AIPI-04)
2. CostAnalyzer computes per-algorithm and cloud billing costs (AIPI-05)
3. DataSensitivityAnalyzer detects PII and classification patterns (AIPI-06)
4. All three implement IAiAdvisor for pipeline integration
5. Full SDK build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/77-ai-policy-intelligence/77-03-SUMMARY.md`
</output>
