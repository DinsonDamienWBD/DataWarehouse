---
phase: 77-ai-policy-intelligence
plan: 02
type: execute
wave: 2
depends_on: ["77-01"]
files_modified:
  - DataWarehouse.SDK/Infrastructure/Intelligence/HardwareProbe.cs
  - DataWarehouse.SDK/Infrastructure/Intelligence/WorkloadAnalyzer.cs
autonomous: true

must_haves:
  truths:
    - "HardwareProbe detects CPU capabilities, RAM, storage speed, and thermal throttling state"
    - "WorkloadAnalyzer identifies time-of-day patterns, seasonal trends, and burst events"
    - "Both advisors implement IAiAdvisor and process observation batches"
  artifacts:
    - path: "DataWarehouse.SDK/Infrastructure/Intelligence/HardwareProbe.cs"
      provides: "Hardware detection advisor"
      contains: "class HardwareProbe"
    - path: "DataWarehouse.SDK/Infrastructure/Intelligence/WorkloadAnalyzer.cs"
      provides: "Workload pattern detection advisor"
      contains: "class WorkloadAnalyzer"
  key_links:
    - from: "DataWarehouse.SDK/Infrastructure/Intelligence/HardwareProbe.cs"
      to: "DataWarehouse.SDK/Infrastructure/Intelligence/AiObservationPipeline.cs"
      via: "implements IAiAdvisor"
      pattern: "IAiAdvisor"
    - from: "DataWarehouse.SDK/Infrastructure/Intelligence/WorkloadAnalyzer.cs"
      to: "DataWarehouse.SDK/Infrastructure/Intelligence/AiObservationPipeline.cs"
      via: "implements IAiAdvisor"
      pattern: "IAiAdvisor"
---

<objective>
Implement the HardwareProbe and WorkloadAnalyzer advisors that consume observation events from the AI pipeline to build hardware-aware and workload-aware context for policy recommendations.

Purpose: AIPI-02 and AIPI-03 -- these advisors provide environmental context that the PolicyAdvisor (Plan 04) uses to generate informed recommendations.
Output: Two IAiAdvisor implementations in Infrastructure/Intelligence/
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/77-ai-policy-intelligence/77-01-SUMMARY.md
@DataWarehouse.SDK/Infrastructure/Intelligence/AiObservationPipeline.cs
@DataWarehouse.SDK/Infrastructure/Intelligence/AiObservationRingBuffer.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: HardwareProbe advisor</name>
  <files>DataWarehouse.SDK/Infrastructure/Intelligence/HardwareProbe.cs</files>
  <action>
Create `HardwareProbe.cs` in `DataWarehouse.SDK/Infrastructure/Intelligence/`:

- Namespace: `DataWarehouse.SDK.Infrastructure.Intelligence`
- `[SdkCompatibility("6.0.0", Notes = "Phase 77: AI Policy Intelligence (AIPI-02)")]`
- `sealed class HardwareProbe : IAiAdvisor`
- `string AdvisorId => "hardware_probe"`

**HardwareSnapshot record:**
- `int LogicalProcessors` (Environment.ProcessorCount)
- `bool HasAvx2` (System.Runtime.Intrinsics.X86.Avx2.IsSupported)
- `bool HasAes` (System.Runtime.Intrinsics.X86.Aes.IsSupported)
- `bool HasSse42` (System.Runtime.Intrinsics.X86.Sse42.IsSupported)
- `long TotalMemoryBytes` (GC.GetGCMemoryInfo().TotalAvailableMemoryBytes)
- `long AvailableMemoryBytes` (computed from GC info)
- `double MemoryPressurePercent` (used/total * 100)
- `StorageSpeedClass StorageSpeed` (enum: Unknown, Hdd, Sata, NvMe -- estimated from sequential write benchmark or Environment variable hint)
- `ThermalState Thermal` (enum: Normal, Warm, Throttling, Critical)

**Detection logic:**
- `RefreshSnapshot()` -- updates all hardware readings
- CPU capabilities: use `System.Runtime.Intrinsics.X86.*` IsSupported checks (and Arm equivalents via `System.Runtime.Intrinsics.Arm` for cross-platform)
- RAM: `GC.GetGCMemoryInfo()` for total/available
- Thermal: estimate from CPU frequency degradation (measure compute-bound loop timing delta vs baseline) or default to Normal; track if recent observations show latency spikes consistent with throttling
- Storage: check `DATAWAREHOUSE_STORAGE_SPEED` env var first; if not set, default to Unknown

**ProcessObservationsAsync:** Updates snapshot if enough time has elapsed (30s cooldown). Tracks observation latency patterns to detect thermal throttling (if p99 latency > 3x p50, set Thermal to Warm/Throttling).

**Public API:**
- `HardwareSnapshot CurrentSnapshot { get; }` -- latest snapshot (volatile reference swap)
- `bool IsHardwareConstrained` -- true if MemoryPressurePercent > 85 or Thermal >= Warm
  </action>
  <verify>
`dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` succeeds with zero errors.
  </verify>
  <done>
HardwareProbe detects CPU SIMD capabilities, RAM pressure, storage speed class, and thermal state. Implements IAiAdvisor. AIPI-02 satisfied.
  </done>
</task>

<task type="auto">
  <name>Task 2: WorkloadAnalyzer advisor</name>
  <files>DataWarehouse.SDK/Infrastructure/Intelligence/WorkloadAnalyzer.cs</files>
  <action>
Create `WorkloadAnalyzer.cs` in `DataWarehouse.SDK/Infrastructure/Intelligence/`:

- Namespace: `DataWarehouse.SDK.Infrastructure.Intelligence`
- `[SdkCompatibility("6.0.0", Notes = "Phase 77: AI Policy Intelligence (AIPI-03)")]`
- `sealed class WorkloadAnalyzer : IAiAdvisor`
- `string AdvisorId => "workload_analyzer"`

**WorkloadProfile record:**
- `double ObservationsPerSecond` -- current throughput
- `TimeOfDayPattern TimeOfDay` (enum: OffPeak, Normal, Peak, Unknown)
- `SeasonalTrend Season` (enum: Stable, Rising, Falling, Unknown)
- `bool IsBurstDetected` -- true if current rate > 3x rolling average
- `DateTimeOffset LastBurstAt`
- `int BurstCount` -- number of bursts detected in current session

**Internal tracking:**
- Circular buffer of `(DateTimeOffset, int)` tuples representing observation counts per 1-minute bucket (last 1440 minutes = 24 hours)
- Rolling average over last 60 minutes for baseline
- Time-of-day classification: map current hour (UTC) to OffPeak (0-6), Normal (6-9, 17-22), Peak (9-17), OffPeak (22-24)
- Seasonal trend: compare last-7-day average to previous-7-day average (Rising if >10% increase, Falling if >10% decrease, Stable otherwise). If insufficient data (<14 days), return Unknown.
- Burst detection: if observations in current minute > 3x the rolling 60-minute average, set IsBurstDetected = true

**ProcessObservationsAsync:**
- Count observations in the batch, update per-minute bucket
- Recalculate WorkloadProfile
- Update `CurrentProfile` via volatile reference swap

**Public API:**
- `WorkloadProfile CurrentProfile { get; }`
- `bool ShouldOptimizeForThroughput` -- true during Peak or Burst
- `bool ShouldConserveResources` -- true during OffPeak with Falling trend
  </action>
  <verify>
`dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` succeeds with zero errors.
  </verify>
  <done>
WorkloadAnalyzer tracks observation rates, classifies time-of-day patterns, detects seasonal trends via 7-day comparison, and identifies burst events at 3x baseline. AIPI-03 satisfied.
  </done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` -- zero errors
- HardwareProbe.cs contains Avx2.IsSupported or Aes.IsSupported check
- WorkloadAnalyzer.cs contains burst detection logic (3x threshold)
- Both implement IAiAdvisor interface
</verification>

<success_criteria>
1. HardwareProbe detects CPU/RAM/storage/thermal (AIPI-02)
2. WorkloadAnalyzer detects time-of-day, seasonal trends, burst events (AIPI-03)
3. Both implement IAiAdvisor and can be registered with AiObservationPipeline
4. Full SDK build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/77-ai-policy-intelligence/77-02-SUMMARY.md`
</output>
