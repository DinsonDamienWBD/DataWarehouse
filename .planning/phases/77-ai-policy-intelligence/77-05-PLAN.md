---
phase: 77-ai-policy-intelligence
plan: 05
type: execute
wave: 4
depends_on: ["77-04"]
files_modified:
  - DataWarehouse.SDK/Infrastructure/Intelligence/HybridAutonomyProfile.cs
  - DataWarehouse.SDK/Infrastructure/Intelligence/AiSelfModificationGuard.cs
  - DataWarehouse.SDK/Infrastructure/Intelligence/AiPolicyIntelligenceFactory.cs
autonomous: true

must_haves:
  truths:
    - "Different feature categories can have different autonomy levels (hybrid configuration)"
    - "AI cannot modify its own autonomy configuration (allowSelfModification: false enforced)"
    - "Quorum is required for AI configuration changes"
    - "Factory wires all components together for end-to-end AI observation pipeline"
  artifacts:
    - path: "DataWarehouse.SDK/Infrastructure/Intelligence/HybridAutonomyProfile.cs"
      provides: "Per-category autonomy configuration profiles"
      contains: "class HybridAutonomyProfile"
    - path: "DataWarehouse.SDK/Infrastructure/Intelligence/AiSelfModificationGuard.cs"
      provides: "Self-modification prevention and quorum enforcement"
      contains: "allowSelfModification"
    - path: "DataWarehouse.SDK/Infrastructure/Intelligence/AiPolicyIntelligenceFactory.cs"
      provides: "Factory wiring all pipeline components"
      contains: "class AiPolicyIntelligenceFactory"
  key_links:
    - from: "DataWarehouse.SDK/Infrastructure/Intelligence/AiSelfModificationGuard.cs"
      to: "DataWarehouse.SDK/Infrastructure/Authority/AuthorityChainFacade.cs"
      via: "quorum enforcement for AI config changes"
      pattern: "IQuorumService|QuorumAction"
    - from: "DataWarehouse.SDK/Infrastructure/Intelligence/AiSelfModificationGuard.cs"
      to: "DataWarehouse.SDK/Infrastructure/Intelligence/AiAutonomyConfiguration.cs"
      via: "wraps configuration to prevent self-modification"
      pattern: "AiAutonomyConfiguration"
    - from: "DataWarehouse.SDK/Infrastructure/Intelligence/AiPolicyIntelligenceFactory.cs"
      to: "DataWarehouse.SDK/Infrastructure/Intelligence/AiObservationPipeline.cs"
      via: "wires all components into pipeline"
      pattern: "AiObservationPipeline"
---

<objective>
Implement hybrid autonomy profiles (different autonomy per feature category), the self-modification guard that prevents AI from changing its own configuration (with quorum enforcement), and the factory that wires all AI pipeline components together.

Purpose: AIPI-09 and AIPI-11 -- completes the AI Policy Intelligence system with safety guardrails and integration.
Output: HybridAutonomyProfile, AiSelfModificationGuard, AiPolicyIntelligenceFactory
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/77-ai-policy-intelligence/77-01-SUMMARY.md
@.planning/phases/77-ai-policy-intelligence/77-04-SUMMARY.md
@DataWarehouse.SDK/Infrastructure/Intelligence/AiAutonomyConfiguration.cs
@DataWarehouse.SDK/Infrastructure/Intelligence/AiObservationPipeline.cs
@DataWarehouse.SDK/Infrastructure/Intelligence/PolicyAdvisor.cs
@DataWarehouse.SDK/Infrastructure/Authority/AuthorityChainFacade.cs
@DataWarehouse.SDK/Contracts/Policy/PolicyEnums.cs
@DataWarehouse.SDK/Infrastructure/Policy/Performance/CheckClassification.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: HybridAutonomyProfile and AiSelfModificationGuard</name>
  <files>
    DataWarehouse.SDK/Infrastructure/Intelligence/HybridAutonomyProfile.cs
    DataWarehouse.SDK/Infrastructure/Intelligence/AiSelfModificationGuard.cs
  </files>
  <action>
**HybridAutonomyProfile.cs:**
- Namespace: `DataWarehouse.SDK.Infrastructure.Intelligence`
- `[SdkCompatibility("6.0.0", Notes = "Phase 77: AI Policy Intelligence (AIPI-09)")]`

**HybridAutonomyProfile sealed class:**
- Allows setting different autonomy levels per CheckTiming category (ConnectTime, SessionCached, PerOperation, Deferred, Periodic)
- Constructor takes `AiAutonomyConfiguration config`
- `void ApplyProfile(string profileName, Dictionary<CheckTiming, AiAutonomyLevel> categoryLevels)` -- sets autonomy for all features in each timing category per the specified levels
- Pre-built profiles as static methods:
  - `static HybridAutonomyProfile Paranoid(AiAutonomyConfiguration config)` -- ConnectTime=ManualOnly, SessionCached=ManualOnly, PerOperation=Suggest, Deferred=Suggest, Periodic=ManualOnly
  - `static HybridAutonomyProfile Balanced(AiAutonomyConfiguration config)` -- ConnectTime=Suggest, SessionCached=SuggestExplain, PerOperation=AutoNotify, Deferred=AutoNotify, Periodic=SuggestExplain
  - `static HybridAutonomyProfile Performance(AiAutonomyConfiguration config)` -- ConnectTime=SuggestExplain, SessionCached=AutoNotify, PerOperation=AutoSilent, Deferred=AutoSilent, Periodic=AutoNotify
- `string ActiveProfileName { get; }` -- currently applied profile name
- `IReadOnlyDictionary<CheckTiming, AiAutonomyLevel> GetCategoryLevels()` -- returns current per-category autonomy mapping

**AiSelfModificationGuard.cs:**
- Namespace: `DataWarehouse.SDK.Infrastructure.Intelligence`
- `[SdkCompatibility("6.0.0", Notes = "Phase 77: AI Policy Intelligence (AIPI-11)")]`

**AiSelfModificationGuard sealed class:**
- Wraps `AiAutonomyConfiguration` with safety enforcement
- Constructor takes `AiAutonomyConfiguration innerConfig`, `IQuorumService quorumService`, `AiSelfModificationPolicy policy`

**AiSelfModificationPolicy record:**
- `bool AllowSelfModification` (default: false)
- `bool ModificationRequiresQuorum` (default: true)
- `int MinimumQuorumSize` (default: 3)

**Guard logic:**
- `Task<bool> TryModifyAutonomyAsync(string requesterId, string featureId, PolicyLevel level, AiAutonomyLevel newLevel, CancellationToken ct)`:
  1. If `requesterId` starts with "ai:" or "system:ai" (AI-originated request) and `!AllowSelfModification`:
     - Reject immediately, return false, log the attempt
  2. If `ModificationRequiresQuorum`:
     - Call `quorumService.RequestApprovalAsync(QuorumAction.OverrideAi, ...)` (from Phase 75)
     - If approved, apply change to `innerConfig` and return true
     - If denied, return false
  3. If no quorum required and not AI self-modification, apply directly
- `AiAutonomyLevel GetAutonomy(string featureId, PolicyLevel level)` -- delegates to inner config (read-only, no guard needed)
- `long BlockedSelfModificationAttempts` -- Interlocked counter
- `long QuorumApprovedChanges` -- Interlocked counter
- `long QuorumDeniedChanges` -- Interlocked counter
  </action>
  <verify>
`dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` succeeds with zero errors.
  </verify>
  <done>
HybridAutonomyProfile applies per-category autonomy with Paranoid/Balanced/Performance presets. AiSelfModificationGuard blocks AI self-modification (allowSelfModification: false) and requires quorum for changes. AIPI-09 and AIPI-11 satisfied.
  </done>
</task>

<task type="auto">
  <name>Task 2: AiPolicyIntelligenceFactory (end-to-end wiring)</name>
  <files>DataWarehouse.SDK/Infrastructure/Intelligence/AiPolicyIntelligenceFactory.cs</files>
  <action>
Create `AiPolicyIntelligenceFactory.cs`:

- Namespace: `DataWarehouse.SDK.Infrastructure.Intelligence`
- `[SdkCompatibility("6.0.0", Notes = "Phase 77: AI Policy Intelligence (AIPI-01 through AIPI-11)")]`

**AiPolicyIntelligenceFactory static class:**
- `static AiPolicyIntelligenceSystem Create(AiPolicyIntelligenceOptions options)`
- `static AiPolicyIntelligenceSystem CreateDefault()` -- uses default options

**AiPolicyIntelligenceOptions record:**
- `double MaxCpuOverheadPercent` (default 1.0)
- `int RingBufferCapacity` (default 8192, must be power of two)
- `TimeSpan DrainInterval` (default 100ms)
- `double ThreatThreshold` (default 0.3)
- `double CloudCpuCostPerSecondUsd` (default 0.000012)
- `AiAutonomyLevel DefaultAutonomyLevel` (default Suggest)
- `AiSelfModificationPolicy SelfModificationPolicy` (default AllowSelfModification=false, RequiresQuorum=true)
- `IQuorumService? QuorumService` (null = no quorum enforcement available)

**AiPolicyIntelligenceSystem sealed class : IAsyncDisposable:**
- Holds all components:
  - `AiObservationRingBuffer RingBuffer { get; }`
  - `OverheadThrottle Throttle { get; }`
  - `AiObservationPipeline Pipeline { get; }`
  - `HardwareProbe Hardware { get; }`
  - `WorkloadAnalyzer Workload { get; }`
  - `ThreatDetector Threat { get; }`
  - `CostAnalyzer Cost { get; }`
  - `DataSensitivityAnalyzer Sensitivity { get; }`
  - `PolicyAdvisor Advisor { get; }`
  - `AiAutonomyConfiguration AutonomyConfig { get; }`
  - `AiSelfModificationGuard SelfModificationGuard { get; }`
  - `HybridAutonomyProfile? ActiveProfile { get; }`

- `Task StartAsync(CancellationToken ct)` -- starts the pipeline (calls Pipeline.StartAsync)
- `Task StopAsync()` -- stops the pipeline
- `void AttachToEmitter(ObservationEmitter emitter)` -- calls `emitter.AttachRingBuffer(RingBuffer)` to wire an existing emitter
- `void ApplyProfile(HybridAutonomyProfile profile)` -- applies a hybrid profile

- `DisposeAsync()` -- stops pipeline, disposes all disposable components

**Create method wiring order:**
1. Create RingBuffer
2. Create OverheadThrottle
3. Create all 5 advisors (HardwareProbe, WorkloadAnalyzer, ThreatDetector, CostAnalyzer, DataSensitivityAnalyzer)
4. Create AiAutonomyConfiguration
5. Create PolicyAdvisor (takes all 5 advisors + config)
6. Create AiObservationPipeline (takes buffer + throttle)
7. Register all 6 advisors (5 domain + PolicyAdvisor) with pipeline
8. Create AiSelfModificationGuard (wraps config with quorum)
9. Return AiPolicyIntelligenceSystem holding everything
  </action>
  <verify>
`dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` succeeds with zero errors. Verify the factory creates all components (grep for all 5 advisor types in factory file).
  </verify>
  <done>
Factory wires all AI observation pipeline components end-to-end. AiPolicyIntelligenceSystem provides unified entry point. All AIPI-01 through AIPI-11 requirements are addressed across Plans 01-05.
  </done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` -- zero errors
- AiSelfModificationGuard blocks "ai:*" requester IDs when AllowSelfModification=false
- AiSelfModificationGuard references IQuorumService for quorum enforcement
- HybridAutonomyProfile has 3 pre-built profiles (Paranoid/Balanced/Performance)
- Factory creates and wires all components (ring buffer, throttle, 5 advisors, policy advisor, guard)
- All 11 AIPI requirements have implementing code across Plans 01-05
</verification>

<success_criteria>
1. Hybrid autonomy profiles allow different levels per feature category (AIPI-09)
2. Self-modification guard blocks AI from changing its own config (AIPI-11)
3. Quorum required for AI config changes via AuthorityChainFacade integration
4. Factory wires all components into a single AiPolicyIntelligenceSystem
5. Full SDK build succeeds with all 10 new files
</success_criteria>

<output>
After completion, create `.planning/phases/77-ai-policy-intelligence/77-05-SUMMARY.md`
</output>
