---
phase: 50.1-feature-gap-closure
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Network/IscsiStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Network/FcStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/S3Compatible/GenericS3Strategy.cs
autonomous: true
must_haves:
  truths:
    - "iSCSI strategy has config validation for target IQN, portal address, CHAP auth"
    - "Fibre Channel strategy has config validation for WWPN, fabric login, zone sets"
    - "S3-Compatible Generic strategy has config validation for endpoint URL, credentials, region"
    - "All 3 strategies have cached health checks, shutdown, counters, edge case guards"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Network/IscsiStrategy.cs"
      provides: "iSCSI storage with production infrastructure"
      contains: "InitializeAsyncCore"
    - path: "Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Network/FcStrategy.cs"
      provides: "Fibre Channel storage with production infrastructure"
      contains: "InitializeAsyncCore"
  key_links:
    - from: "Storage network strategies"
      to: "StrategyBase"
      via: "InitializeAsyncCore, GetCachedHealthAsync, IncrementCounter"
      pattern: "InitializeAsyncCore|GetCachedHealthAsync"
---

<objective>
Add production readiness infrastructure to 3 storage strategies: iSCSI, Fibre Channel, and S3-Compatible Generic.

Purpose: Push Domain 02 storage features from 90% to 100%. These are network/protocol storage backends that need proper initialization validation, health monitoring, and resource lifecycle.

Output: 3 strategy files updated with full production infrastructure.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/50.1-feature-gap-closure-push-all-80-99-features-to-100-production-readiness/50.1-RESEARCH.md

IMPORTANT: The S3-Compatible Generic strategy may not exist as a separate file. Check:
```bash
find Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies -name "*Generic*" -o -name "*S3Compat*" -o -name "*S3Generic*"
```
If it doesn't exist as a standalone file, it may be a mode/option within one of the S3Compatible strategies (like a base class or configuration flag). In that case, locate the nearest equivalent and apply production hardening there.

Storage strategies likely inherit from a StorageStrategyBase which may have different method signatures. Check the base class first:
```bash
grep -n "class.*StorageStrategyBase\|class.*UltimateStorageStrategyBase" DataWarehouse.SDK/Contracts/Storage/*.cs
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Production-harden iSCSI and Fibre Channel storage strategies</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Network/IscsiStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Network/FcStrategy.cs
  </files>
  <action>
For each strategy, add production infrastructure preserving all existing I/O code:

1. **InitializeAsyncCore override**:
   - iSCSI: Validate target IQN format (iqn.yyyy-mm.domain:target), portal address (valid IP:port), CHAP credentials if enabled, session timeout (1000-300000ms), max connections (1-64).
   - FC: Validate WWPN format (8 hex pairs), fabric login type, zone set name, buffer-to-buffer credits (1-255).
   - Throw InvalidOperationException for missing required config, ArgumentException for invalid values.

2. **Health check**: `CheckHealthAsync` using `GetCachedHealthAsync()`. For iSCSI: check session state. For FC: check port state. Both with 60-second cache.

3. **ShutdownAsyncCore**: Close connections/sessions gracefully with 10-second timeout. Dispose SemaphoreSlim, HttpClient, or other resources.

4. **DisposeAsyncCore**: Async disposal of all IDisposable fields.

5. **Strategy-specific counters**: `IncrementCounter("iscsi.read")`, `IncrementCounter("iscsi.write")`, `IncrementCounter("fc.read")`, etc.

6. **Edge case guards**: Null/empty key validation, max object size validation, handle disconnection during I/O with retry or specific exception.

DO NOT modify any I/O or protocol logic.
  </action>
  <verify>
`dotnet build DataWarehouse.slnx --no-restore 2>&1 | tail -5` — 0 errors 0 warnings.
  </verify>
  <done>iSCSI and Fibre Channel strategies have full production infrastructure. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Production-harden S3-Compatible Generic storage strategy</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/S3Compatible/
  </files>
  <action>
FIRST: Locate the S3-Compatible Generic strategy. It may be:
- A standalone `GenericS3Strategy.cs` or `S3CompatibleStrategy.cs`
- A base class for all S3-compatible strategies
- Part of the existing S3Compatible folder strategies

If no dedicated "generic" strategy exists, identify which S3Compatible strategy acts as the generic/base pattern and harden it. Also check if there's a shared base that all S3Compatible strategies inherit from — that would be the ideal target.

For the identified file(s), add production infrastructure:

1. **InitializeAsyncCore override**: Validate endpoint URL (must be valid URI, must be HTTPS or explicitly opt-in to HTTP), access key (non-empty), secret key (non-empty), region (if required), bucket name (valid S3 bucket name format). Throw InvalidOperationException for missing config.

2. **Health check**: `CheckHealthAsync` using `GetCachedHealthAsync()`. Check endpoint reachability (HEAD request to bucket). 60-second cache.

3. **ShutdownAsyncCore**: Dispose HttpClient or S3 client. Cancel pending operations.

4. **Strategy-specific counters**: `IncrementCounter("s3generic.read")`, `IncrementCounter("s3generic.write")`, etc.

5. **Edge case guards**: Empty key validation, max object size (5TB S3 limit), handle 403/404/503 responses with specific exceptions.

DO NOT modify any S3 protocol logic.
  </action>
  <verify>
`dotnet build DataWarehouse.slnx --no-restore 2>&1 | tail -5` — 0 errors 0 warnings.
  </verify>
  <done>S3-Compatible Generic strategy has full production infrastructure. Build passes.</done>
</task>

</tasks>

<verification>
1. `dotnet build DataWarehouse.slnx --no-restore` passes with 0 errors, 0 warnings
2. All 3 storage strategies contain production infrastructure patterns
</verification>

<success_criteria>
iSCSI, Fibre Channel, and S3-Compatible Generic storage strategies pushed to 100%. Zero build errors.
</success_criteria>

<output>
After completion, create `.planning/phases/50.1-feature-gap-closure-push-all-80-99-features-to-100-production-readiness/50.1-04-SUMMARY.md`
</output>
