---
phase: 50.1-feature-gap-closure
plan: 10
type: execute
wave: 3  # Waves are execution scheduling groups (max 2-3 concurrent), not dependency markers
depends_on: []
files_modified:
  - Plugins/DataWarehouse.Plugins.UniversalObservability/Strategies/Metrics/StackdriverStrategy.cs
  - Plugins/DataWarehouse.Plugins.UniversalObservability/Strategies/Logging/ElasticsearchStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateDeployment/Strategies/DeploymentPatterns/RollingUpdateStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateDeployment/Strategies/ContainerOrchestration/KubernetesStrategies.cs
autonomous: true
must_haves:
  truths:
    - "Stackdriver metrics strategy has config validation for project ID, credentials"
    - "Elasticsearch logging strategy has config validation for cluster URL, index pattern"
    - "ABTesting strategy (in RollingUpdateStrategy.cs) has config validation for traffic split, experiment ID"
    - "Shadow Deployment strategy (in RollingUpdateStrategy.cs) has config validation for shadow endpoint, traffic percentage"
    - "Kubernetes deployment strategy has config validation for cluster context, namespace"
    - "All strategies have cached health checks, shutdown, counters, error boundaries"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UniversalObservability/Strategies/Metrics/StackdriverStrategy.cs"
      provides: "Stackdriver metrics with production infrastructure"
      contains: "InitializeAsyncCore"
    - path: "Plugins/DataWarehouse.Plugins.UniversalObservability/Strategies/Logging/ElasticsearchStrategy.cs"
      provides: "Elasticsearch logging with production infrastructure"
      contains: "InitializeAsyncCore"
    - path: "Plugins/DataWarehouse.Plugins.UltimateDeployment/Strategies/DeploymentPatterns/RollingUpdateStrategy.cs"
      provides: "ABTesting and Shadow Deployment strategies with production infrastructure"
      contains: "ABTestingStrategy|ShadowDeploymentStrategy"
    - path: "Plugins/DataWarehouse.Plugins.UltimateDeployment/Strategies/ContainerOrchestration/KubernetesStrategies.cs"
      provides: "K8s deployment with production infrastructure"
      contains: "InitializeAsyncCore"
  key_links:
    - from: "Observability/Deployment strategies"
      to: "StrategyBase"
      via: "InitializeAsyncCore, GetCachedHealthAsync, IncrementCounter"
      pattern: "InitializeAsyncCore|GetCachedHealthAsync"
---

<objective>
Add production readiness infrastructure to observability strategies (Stackdriver, Elasticsearch) and deployment strategies (ABTesting, Shadow Deployment, Kubernetes Deployment).

Purpose: Push Domain 14 (Observability) and Domain 16 (Cloud/Deployment) features from 90% to 100%. These are the final 5 features in the 90-94% tier.

Output: 4 strategy files updated with production infrastructure (RollingUpdateStrategy.cs contains 2 strategies: ABTesting + Shadow Deployment).
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/50.1-feature-gap-closure-push-all-80-99-features-to-100-production-readiness/50.1-RESEARCH.md

Domain 14 features at 90%:
- Stackdriver (UniversalObservability) — Plugins/DataWarehouse.Plugins.UniversalObservability/Strategies/Metrics/StackdriverStrategy.cs
- Elasticsearch (UniversalObservability) — Plugins/DataWarehouse.Plugins.UniversalObservability/Strategies/Logging/ElasticsearchStrategy.cs

Domain 16 features at 90%:
- ABTesting — Plugins/DataWarehouse.Plugins.UltimateDeployment/Strategies/DeploymentPatterns/RollingUpdateStrategy.cs (class ABTestingStrategy)
- Shadow Deployment — Plugins/DataWarehouse.Plugins.UltimateDeployment/Strategies/DeploymentPatterns/RollingUpdateStrategy.cs (class ShadowDeploymentStrategy)
- Kubernetes Deployment — Plugins/DataWarehouse.Plugins.UltimateDeployment/Strategies/ContainerOrchestration/KubernetesStrategies.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Production-harden Stackdriver and Elasticsearch observability strategies</name>
  <files>
    Plugins/DataWarehouse.Plugins.UniversalObservability/Strategies/Metrics/StackdriverStrategy.cs
    Plugins/DataWarehouse.Plugins.UniversalObservability/Strategies/Logging/ElasticsearchStrategy.cs
  </files>
  <action>
For Stackdriver metrics strategy (Plugins/DataWarehouse.Plugins.UniversalObservability/Strategies/Metrics/StackdriverStrategy.cs):

1. **InitializeAsyncCore**: Validate GCP project ID (non-empty, valid format), credentials path or default credentials, metric prefix (non-empty), export interval (1000-300000ms). Throw InvalidOperationException for missing project ID.
2. **Health check**: Test metric descriptor API reachability (or validate credentials). 60-second cache.
3. **ShutdownAsyncCore**: Flush pending metrics, close HTTP connections. 10-second timeout.
4. **Counters**: `IncrementCounter("stackdriver.metrics_sent")`, `IncrementCounter("stackdriver.metrics_failed")`.
5. **Error boundaries**: Handle 401 (auth failure), 429 (quota), 503 (service unavailable) specifically.

For Elasticsearch logging strategy (Plugins/DataWarehouse.Plugins.UniversalObservability/Strategies/Logging/ElasticsearchStrategy.cs):

1. **InitializeAsyncCore**: Validate cluster URL (valid URI, HTTPS preferred), index pattern (valid name, no special chars), authentication (API key or basic auth if configured), bulk batch size (1-10000), flush interval (100-60000ms). Throw InvalidOperationException for missing cluster URL.
2. **Health check**: Call `_cluster/health` endpoint. Report green/yellow/red. 60-second cache.
3. **ShutdownAsyncCore**: Flush buffered logs, close connection. 10-second timeout.
4. **Counters**: `IncrementCounter("elasticsearch.docs_indexed")`, `IncrementCounter("elasticsearch.bulk_requests")`.
5. **Error boundaries**: Handle connection refused, 401, index write block (429/503).
6. **Edge cases**: Handle Elasticsearch version differences (7.x vs 8.x index type handling).

DO NOT modify any metrics export or logging logic.
  </action>
  <verify>
`dotnet build DataWarehouse.slnx --no-restore 2>&1 | tail -5` — 0 errors 0 warnings.
  </verify>
  <done>Stackdriver and Elasticsearch strategies have full production infrastructure. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Production-harden ABTesting, Shadow Deployment, and Kubernetes Deployment strategies</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateDeployment/Strategies/DeploymentPatterns/RollingUpdateStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateDeployment/Strategies/ContainerOrchestration/KubernetesStrategies.cs
  </files>
  <action>
For ABTesting strategy (class ABTestingStrategy in Plugins/DataWarehouse.Plugins.UltimateDeployment/Strategies/DeploymentPatterns/RollingUpdateStrategy.cs):

1. **InitializeAsyncCore**: Validate experiment ID format, traffic split percentages (must sum to 100%), variant definitions (at least 2), measurement duration (1h-90d), statistical significance threshold (0.01-0.1). Throw ArgumentException for invalid splits.
2. **Health check**: Validate experiment state (running/paused/completed). 60-second cache.
3. **ShutdownAsyncCore**: Save experiment state, flush event queue.
4. **Counters**: `IncrementCounter("abtest.assignment")`, `IncrementCounter("abtest.conversion")`.

For Shadow Deployment strategy (class ShadowDeploymentStrategy in Plugins/DataWarehouse.Plugins.UltimateDeployment/Strategies/DeploymentPatterns/RollingUpdateStrategy.cs):

1. **InitializeAsyncCore**: Validate shadow endpoint (valid URI), traffic percentage (0-100), comparison mode (sync/async), timeout multiplier (1.0-10.0). Throw InvalidOperationException for missing shadow endpoint.
2. **Health check**: Check shadow endpoint reachability. 60-second cache.
3. **ShutdownAsyncCore**: Cancel shadow requests, flush comparison results.
4. **Counters**: `IncrementCounter("shadow.request_mirrored")`, `IncrementCounter("shadow.response_divergence")`.

For Kubernetes Deployment strategy (Plugins/DataWarehouse.Plugins.UltimateDeployment/Strategies/ContainerOrchestration/KubernetesStrategies.cs):

1. **InitializeAsyncCore**: Validate cluster context name, namespace (valid K8s name), kubeconfig path (if not in-cluster), deployment timeout (10s-3600s), max unavailable replicas. Throw InvalidOperationException for missing cluster context.
2. **Health check**: Check K8s API server reachability (if possible). 60-second cache.
3. **ShutdownAsyncCore**: Cancel pending rollouts if configured.
4. **Counters**: `IncrementCounter("k8s.deploy")`, `IncrementCounter("k8s.rollback")`, `IncrementCounter("k8s.scale")`.
5. **Error boundaries**: Handle K8s API 401, 403, 409 (conflict), 422 (validation).

DO NOT modify any deployment logic.
  </action>
  <verify>
`dotnet build DataWarehouse.slnx --no-restore 2>&1 | tail -5` — 0 errors 0 warnings.
  </verify>
  <done>ABTesting, Shadow Deployment, K8s Deployment strategies have full production infrastructure. Build passes. Domains 14, 16 complete.</done>
</task>

</tasks>

<verification>
1. `dotnet build DataWarehouse.slnx --no-restore` passes with 0 errors, 0 warnings
2. All 5 observability/deployment strategies have production infrastructure
3. Domains 14 and 16 fully at 100%
4. ALL 51 features at 90-94% tier now at 100%
</verification>

<success_criteria>
Stackdriver, Elasticsearch, ABTesting, Shadow Deployment, and K8s Deployment pushed to 100%. Zero build errors. All 90-94% tier features complete.
</success_criteria>

<output>
After completion, create `.planning/phases/50.1-feature-gap-closure-push-all-80-99-features-to-100-production-readiness/50.1-10-SUMMARY.md`
</output>
