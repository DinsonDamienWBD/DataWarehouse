---
phase: 50.1-feature-gap-closure
plan: 08
type: execute
wave: 2  # Waves are execution scheduling groups (max 2-3 concurrent), not dependency markers
depends_on: []
files_modified:
  - Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/Video/H264CodecStrategy.cs
  - Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/Video/H265CodecStrategy.cs
  - Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/Streaming/HlsStreamingStrategy.cs
  - Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/Streaming/DashStreamingStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Watermarking/WatermarkingStrategy.cs
  - Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/Image/JpegImageStrategy.cs
  - Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/Image/PngImageStrategy.cs
autonomous: true
must_haves:
  truths:
    - "H.264 and H.265 codec strategies have config validation for 10-bit encoding parameters"
    - "Adaptive bitrate streaming strategies have config validation for segment duration, bitrate ladder"
    - "Both ABR variants (HLS and DASH) hardened - HLS and DASH represent the 2 'Adaptive Bitrate Streaming' feature instances"
    - "Video watermarking strategy has config validation for watermark operations"
    - "Image strategies have config validation for resize/rotate/crop operations"
    - "All media strategies have cached health checks, shutdown, counters, error boundaries"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/Video/H264CodecStrategy.cs"
      provides: "H.264 with 10-bit support and production infrastructure"
      contains: "InitializeAsyncCore"
    - path: "Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/Streaming/HlsStreamingStrategy.cs"
      provides: "HLS ABR streaming with production infrastructure"
      contains: "InitializeAsyncCore"
    - path: "Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/Streaming/DashStreamingStrategy.cs"
      provides: "DASH ABR streaming with production infrastructure"
      contains: "InitializeAsyncCore"
  key_links:
    - from: "Media strategies"
      to: "StrategyBase"
      via: "InitializeAsyncCore, GetCachedHealthAsync, IncrementCounter"
      pattern: "InitializeAsyncCore|GetCachedHealthAsync"
---

<objective>
Add production readiness infrastructure to media domain strategies: H.264 10-bit, H.265 10-bit, Adaptive Bitrate Streaming (HLS + DASH), Video Watermarking, and Image Operations (resize/rotate/crop).

Purpose: Push Domain 04 (Media) features from 90% to 100%. These strategies handle video encoding, streaming, watermarking, and image manipulation.

Output: 7 strategy files updated with production infrastructure.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/50.1-feature-gap-closure-push-all-80-99-features-to-100-production-readiness/50.1-RESEARCH.md

Domain 04 features at 90%:
1. H.264 10-bit Encoding (Transcoding plugin) — Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/Video/H264CodecStrategy.cs
2. H.265 10-bit Encoding (Transcoding plugin) — Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/Video/H265CodecStrategy.cs
3. Adaptive Bitrate Streaming HLS (Transcoding plugin) — Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/Streaming/HlsStreamingStrategy.cs
4. Adaptive Bitrate Streaming DASH (Transcoding plugin) — Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/Streaming/DashStreamingStrategy.cs
5. Video Watermarking (UltimateAccessControl plugin) — Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Watermarking/WatermarkingStrategy.cs
6. Image Resizing (Transcoding plugin) — Implemented within JpegImageStrategy and PngImageStrategy
7. Image Rotation (Transcoding plugin) — Implemented within JpegImageStrategy and PngImageStrategy
8. Image Cropping (Transcoding plugin) — Implemented within JpegImageStrategy and PngImageStrategy

NOTE: The 2 "Adaptive Bitrate Streaming" entries in the feature matrix map to HLS and DASH variants.
NOTE: Image resize/rotate/crop are methods within the image strategies, not separate strategy files.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Production-harden H.264, H.265, and ABR streaming strategies</name>
  <files>
    Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/Video/H264CodecStrategy.cs
    Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/Video/H265CodecStrategy.cs
    Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/Streaming/HlsStreamingStrategy.cs
    Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/Streaming/DashStreamingStrategy.cs
  </files>
  <action>
For H.264 and H.265 codec strategies:

1. **InitializeAsyncCore override**: Validate bit depth (8, 10, or 12), profile (Baseline/Main/High for H.264, Main/Main10/Main12 for H.265), level, max bitrate (1000-100000000 bps), keyframe interval (1-300), B-frame count (0-16). For 10-bit mode: ensure profile supports 10-bit (High10 for H.264, Main10 for H.265). Throw ArgumentException for invalid combinations.

2. **Health check**: `CheckHealthAsync` using `GetCachedHealthAsync()`. Validate codec availability (check if the encoding library/native dependency is loadable). 60-second cache.

3. **ShutdownAsyncCore**: Cancel pending encodes, flush output buffers, dispose encoder instances.

4. **Counters**: `IncrementCounter("h264.encode")`, `IncrementCounter("h264.decode")`, `IncrementCounter("h264.frames_processed")`.

5. **Error boundaries**: Catch encoding-specific exceptions, wrap with MediaTranscodingException including codec, resolution, bit depth.

For HLS and DASH streaming strategies:

1. **InitializeAsyncCore**: Validate segment duration (1-30 seconds), target bitrate ladder (array of valid bitrates, ascending order), max concurrent encodings (1-32), output format. Throw ArgumentException for invalid bitrate ladder.

2. **Health check**: Validate segment output directory accessibility. 60-second cache.

3. **ShutdownAsyncCore**: Cancel active segment generation, flush manifest.

4. **Counters**: `IncrementCounter("hls.segment_generated")`, `IncrementCounter("dash.manifest_updated")`.

DO NOT modify any encoding or streaming logic.
  </action>
  <verify>
`dotnet build DataWarehouse.slnx --no-restore 2>&1 | tail -5` — 0 errors 0 warnings.
  </verify>
  <done>H.264, H.265, HLS, DASH strategies have full production infrastructure. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Production-harden video watermarking and image operation strategies</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Watermarking/WatermarkingStrategy.cs
    Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/Image/JpegImageStrategy.cs
    Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/Image/PngImageStrategy.cs
  </files>
  <action>
For Video Watermarking strategy (Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Watermarking/WatermarkingStrategy.cs):

1. **InitializeAsyncCore**: Validate watermark type (text/image/invisible), opacity (0.0-1.0), position (valid enum), watermark source (non-empty for image type), strength for invisible watermarks. Throw ArgumentException for invalid values.
2. **Health check**: Validate watermark assets accessible. 60-second cache.
3. **ShutdownAsyncCore**: Dispose image resources.
4. **Counters**: `IncrementCounter("watermark.apply")`, `IncrementCounter("watermark.detect")`.

For Image Operation strategies (JpegImageStrategy, PngImageStrategy):

These strategies already exist and implement image processing. Add production infrastructure for the resize/rotate/crop operations they contain:

1. **InitializeAsyncCore**: Validate max dimensions (1-65536 pixels), quality (1-100 for JPEG), rotation angle (0, 90, 180, 270 or arbitrary), crop bounds validation.
2. **Health check**: Test with minimal 1x1 pixel operation. 60-second cache.
3. **ShutdownAsyncCore**: Dispose image buffers using ArrayPool pattern.
4. **Counters**: `IncrementCounter("image.resize")`, `IncrementCounter("image.rotate")`, `IncrementCounter("image.crop")` in the respective methods.
5. **Edge cases**: Zero-dimension output guard, oversized input (>100MP) guard, EXIF orientation handling.

DO NOT modify any image/video processing logic.
  </action>
  <verify>
`dotnet build DataWarehouse.slnx --no-restore 2>&1 | tail -5` — 0 errors 0 warnings.
  </verify>
  <done>Video watermarking and image operation strategies have full production infrastructure. Build passes. Domain 04 complete (all 8 media features at 100%).</done>
</task>

</tasks>

<verification>
1. `dotnet build DataWarehouse.slnx --no-restore` passes with 0 errors, 0 warnings
2. All Domain 04 media strategies have production infrastructure
3. Domain 04 (all 8 media features) fully at 100%
</verification>

<success_criteria>
H.264 10-bit, H.265 10-bit, ABR streaming (HLS + DASH), video watermarking, and image ops pushed to 100%. Zero build errors. Domain 04 complete.
</success_criteria>

<output>
After completion, create `.planning/phases/50.1-feature-gap-closure-push-all-80-99-features-to-100-production-readiness/50.1-08-SUMMARY.md`
</output>
