---
phase: 50.1-feature-gap-closure
plan: 07
type: execute
wave: 2
depends_on: []
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Core/PbacStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Identity/KerberosStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Identity/U2fStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Core/ZeroTrustStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/ZeroTrust/ZtnaStrategy.cs
  - Plugins/DataWarehouse.Plugins.TamperProof/Strategies/ConsensusStrategy.cs
autonomous: true
must_haves:
  truths:
    - "PBAC strategy has config validation for policy evaluation parameters"
    - "Kerberos strategy has config validation for KDC address, realm, keytab"
    - "U2F strategy has config validation for relying party ID, attestation"
    - "ZTNA strategy has config validation for trust broker, policy engine"
    - "TamperProof consensus has config validation for consensus mode, quorum"
    - "All 5-6 strategies have cached health checks, shutdown, counters"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Identity/KerberosStrategy.cs"
      provides: "Kerberos authentication with production infrastructure"
      contains: "InitializeAsyncCore"
    - path: "Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Core/ZeroTrustStrategy.cs"
      provides: "Zero Trust access control with production infrastructure"
      contains: "InitializeAsyncCore"
  key_links:
    - from: "AccessControl/TamperProof strategies"
      to: "StrategyBase"
      via: "InitializeAsyncCore, GetCachedHealthAsync, IncrementCounter"
      pattern: "InitializeAsyncCore|GetCachedHealthAsync"
---

<objective>
Add production readiness infrastructure to access control strategies (PBAC, Kerberos, U2F, ZTNA) and TamperProof consensus modes.

Purpose: Push remaining Domain 03 security features from 90% to 100%. These are authentication/authorization strategies that need proper init validation, health monitoring, and secure resource cleanup.

Output: 5-6 strategy files updated with production infrastructure.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/50.1-feature-gap-closure-push-all-80-99-features-to-100-production-readiness/50.1-RESEARCH.md

IMPORTANT: File names may differ from expected. Locate actual files:
```bash
find Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies -name "*Pbac*" -o -name "*Kerberos*" -o -name "*U2f*" -o -name "*Fido*" -o -name "*Ztna*" -o -name "*ZeroTrust*"
find Plugins/DataWarehouse.Plugins.TamperProof -name "*Consensus*" -o -name "*consensus*"
```

The "Zero Trust Network Access" feature is listed as a separate feature from "Zero Trust" — there may be both a ZeroTrustStrategy (core RBAC/ABAC-based) and a ZtnaStrategy (network-level) in separate folders.

The PBAC (Purpose-Based Access Control) may be under Core/ or a dedicated folder. Check for PbacStrategy.cs or PurposeBasedStrategy.cs.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Production-harden PBAC, Kerberos, and U2F access control strategies</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/
  </files>
  <action>
FIRST: Locate the actual files for PBAC, Kerberos, and U2F:
```bash
find Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies -name "*.cs" | xargs grep -l "class.*Pbac\|class.*Kerberos\|class.*U2f\|class.*Fido"
```

For PBAC strategy:
1. **InitializeAsyncCore**: Validate policy evaluation timeout (100-60000ms), max policy chain depth (1-100), purpose categories (non-empty list). Throw ArgumentException for invalid values.
2. **Health check**: Validate policy engine reachability, test simple policy evaluation. 60-second cache.
3. **ShutdownAsyncCore**: Clear cached policy decisions, dispose resources.
4. **Counters**: `IncrementCounter("pbac.evaluate")`, `IncrementCounter("pbac.deny")`.
5. **Edge cases**: Null subject/resource/purpose guards, empty policy set handling.

For Kerberos strategy:
1. **InitializeAsyncCore**: Validate KDC address (valid hostname/IP), realm (non-empty, uppercase convention), service principal name format, ticket lifetime (5min-24h). Throw InvalidOperationException for missing KDC config.
2. **Health check**: Check KDC reachability (if possible without actual auth). 60-second cache.
3. **ShutdownAsyncCore**: Clear cached tickets (securely), close connections.
4. **Counters**: `IncrementCounter("kerberos.tgt_request")`, `IncrementCounter("kerberos.service_ticket")`.
5. **Error boundaries**: Catch Kerberos-specific errors (KRB_AP_ERR_SKEW, etc.), wrap with context.

For U2F strategy:
1. **InitializeAsyncCore**: Validate relying party ID (valid domain), app ID (valid URL), attestation mode (none/indirect/direct), timeout (1000-120000ms). Throw ArgumentException for invalid values.
2. **Health check**: Validate configuration consistency. 60-second cache.
3. **ShutdownAsyncCore**: Clear any challenge caches.
4. **Counters**: `IncrementCounter("u2f.register")`, `IncrementCounter("u2f.authenticate")`.

DO NOT modify any authentication/authorization logic.
  </action>
  <verify>
`dotnet build DataWarehouse.slnx --no-restore 2>&1 | tail -5` — 0 errors 0 warnings.
  </verify>
  <done>PBAC, Kerberos, U2F strategies have full production infrastructure. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Production-harden ZTNA and TamperProof consensus strategies</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/ZeroTrust/
    Plugins/DataWarehouse.Plugins.TamperProof/
  </files>
  <action>
FIRST: Locate the actual ZTNA and consensus files:
```bash
find Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies -name "*Ztna*" -o -name "*ZeroTrust*"
find Plugins/DataWarehouse.Plugins.TamperProof -name "*.cs" -type f
```

For ZTNA / Zero Trust Network Access strategy:
1. **InitializeAsyncCore**: Validate trust broker endpoint (valid URI), policy engine endpoint, device posture check interval (1000-300000ms), micro-segmentation rules. Throw InvalidOperationException for missing required endpoints.
2. **Health check**: Check trust broker reachability. 60-second cache.
3. **ShutdownAsyncCore**: Close persistent connections to trust broker. 10-second timeout.
4. **Counters**: `IncrementCounter("ztna.access_request")`, `IncrementCounter("ztna.posture_check")`.
5. **Error boundaries**: Handle trust broker unavailability (fail-closed by default).

For TamperProof consensus modes:
1. **InitializeAsyncCore**: Validate consensus mode (BFT/CFT/Raft/PBFT), quorum size (must be > n/2 for CFT, > 2n/3+1 for BFT), timeout per round (1000-60000ms), max rounds. Throw ArgumentException for invalid quorum.
2. **Health check**: Check consensus peer count vs quorum requirement. 60-second cache.
3. **ShutdownAsyncCore**: Cancel pending consensus rounds, flush logs.
4. **Counters**: `IncrementCounter("consensus.propose")`, `IncrementCounter("consensus.commit")`, `IncrementCounter("consensus.abort")`.
5. **Error boundaries**: Handle split-brain scenarios with specific exception types.

DO NOT modify any zero trust or consensus algorithm logic.
  </action>
  <verify>
`dotnet build DataWarehouse.slnx --no-restore 2>&1 | tail -5` — 0 errors 0 warnings.
  </verify>
  <done>ZTNA and TamperProof consensus strategies have full production infrastructure. Build passes. Domain 03 complete.</done>
</task>

</tasks>

<verification>
1. `dotnet build DataWarehouse.slnx --no-restore` passes with 0 errors, 0 warnings
2. All Domain 03 security strategies have production infrastructure
3. Domain 03 (all 9 security features) fully at 100%
</verification>

<success_criteria>
PBAC, Kerberos, U2F, ZTNA, and Consensus Mode features pushed to 100%. Zero build errors. Domain 03 complete.
</success_criteria>

<output>
After completion, create `.planning/phases/50.1-feature-gap-closure-push-all-80-99-features-to-100-production-readiness/50.1-07-SUMMARY.md`
</output>
