---
phase: 41.1-architecture-kill-shots
plan: 04
type: execute
wave: 2
depends_on: ["41.1-01"]
files_modified:
  - DataWarehouse.SDK/Replication/DottedVersionVector.cs
  - DataWarehouse.SDK/Replication/IClusterMembership.cs
  - DataWarehouse.SDK/Replication/IMultiMasterReplication.cs
  - DataWarehouse.SDK/Contracts/Replication/ReplicationStrategy.cs
  - DataWarehouse.SDK/Infrastructure/Distributed/Replication/CrdtReplicationSync.cs
  - DataWarehouse.SDK/Contracts/Hierarchy/Feature/InfrastructurePluginBase.cs
  - DataWarehouse.SDK/Contracts/Hierarchy/ConsensusPluginBase.cs
  - DataWarehouse.SDK/Contracts/Hierarchy/ResiliencePluginBase.cs
  - Plugins/DataWarehouse.Plugins.UltimateReplication/ReplicationStrategyBase.cs
  - Plugins/DataWarehouse.Plugins.UltimateReplication/Strategies/Conflict/ConflictResolutionStrategies.cs
  - Plugins/DataWarehouse.Plugins.UltimateConsensus/UltimateConsensusPlugin.cs
  - Plugins/DataWarehouse.Plugins.UltimateConsensus/DataWarehouse.Plugins.UltimateConsensus.csproj
  - Plugins/DataWarehouse.Plugins.UltimateResilience/UltimateResiliencePlugin.cs
  - Plugins/DataWarehouse.Plugins.Raft/RaftConsensusPlugin.cs
autonomous: true
must_haves:
  truths:
    - "VectorClock replaced with DottedVersionVector bounded by cluster membership"
    - "DVV prunes entries for dead/departed nodes automatically"
    - "ConsensusPluginBase and ResiliencePluginBase exist in SDK hierarchy under InfrastructurePluginBase"
    - "UltimateConsensus plugin consolidates Raft/Paxos/PBFT/ZAB as strategies with Multi-Raft groups"
    - "Raft plugin is deprecated in favor of UltimateConsensus"
  artifacts:
    - path: "DataWarehouse.SDK/Replication/DottedVersionVector.cs"
      provides: "DVV with membership-based pruning"
      contains: "PruneDeadNodes"
    - path: "DataWarehouse.SDK/Replication/IClusterMembership.cs"
      provides: "Cluster membership interface for DVV pruning"
      contains: "GetAliveMembers"
    - path: "DataWarehouse.SDK/Contracts/Hierarchy/ConsensusPluginBase.cs"
      provides: "Base class for consensus plugins"
      contains: "class ConsensusPluginBase"
    - path: "DataWarehouse.SDK/Contracts/Hierarchy/ResiliencePluginBase.cs"
      provides: "Base class for resilience plugins"
      contains: "class ResiliencePluginBase"
    - path: "Plugins/DataWarehouse.Plugins.UltimateConsensus/UltimateConsensusPlugin.cs"
      provides: "Multi-Raft consensus with configurable group size"
      contains: "RaftGroup"
  key_links:
    - from: "DottedVersionVector"
      to: "IClusterMembership"
      via: "PruneDeadNodes uses GetAliveMembers"
      pattern: "_membership\\.GetAliveMembers"
    - from: "UltimateConsensus"
      to: "ConsensusPluginBase"
      via: "Inheritance"
      pattern: "class UltimateConsensus.*ConsensusPluginBase"
    - from: "CrdtReplicationSync"
      to: "DottedVersionVector"
      via: "Replaces VectorClock usage"
      pattern: "DottedVersionVector"
---

<objective>
Fix Killshot 7 (scalable vector clocks with DVV) and Killshot 8 (Multi-Raft consensus consolidation).

Purpose: KS7 replaces unbounded VectorClock (grows with every node ever seen) with Dotted Version Vector that prunes dead nodes based on cluster membership — scales to 10M+ nodes. KS8 creates ConsensusPluginBase/ResiliencePluginBase in the SDK hierarchy and consolidates three scattered Raft implementations into a single UltimateConsensus plugin with Multi-Raft groups of 3-5 voters.

Output: DottedVersionVector class, IClusterMembership interface, ConsensusPluginBase, ResiliencePluginBase, UltimateConsensus plugin, deprecated Raft plugin.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/41.1-architecture-kill-shots-10-critical-fixes-from-hostile-audit/41.1-RESEARCH.md
@DataWarehouse.SDK/Contracts/Replication/ReplicationStrategy.cs
@DataWarehouse.SDK/Replication/IMultiMasterReplication.cs
@DataWarehouse.SDK/Infrastructure/Distributed/Replication/CrdtReplicationSync.cs
@DataWarehouse.SDK/Contracts/Hierarchy/Feature/InfrastructurePluginBase.cs
@Plugins/DataWarehouse.Plugins.UltimateReplication/ReplicationStrategyBase.cs
@Plugins/DataWarehouse.Plugins.Raft/RaftConsensusPlugin.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace VectorClock with DottedVersionVector (KS7)</name>
  <files>
    DataWarehouse.SDK/Replication/DottedVersionVector.cs
    DataWarehouse.SDK/Replication/IClusterMembership.cs
    DataWarehouse.SDK/Replication/IMultiMasterReplication.cs
    DataWarehouse.SDK/Contracts/Replication/ReplicationStrategy.cs
    DataWarehouse.SDK/Infrastructure/Distributed/Replication/CrdtReplicationSync.cs
    Plugins/DataWarehouse.Plugins.UltimateReplication/ReplicationStrategyBase.cs
    Plugins/DataWarehouse.Plugins.UltimateReplication/Strategies/Conflict/ConflictResolutionStrategies.cs
  </files>
  <action>
**Step 1: Create IClusterMembership.cs** in `DataWarehouse.SDK/Replication/`:
```csharp
namespace DataWarehouse.SDK.Replication;

public record ClusterMember(string Id, string Address, bool IsAlive, DateTime LastSeen);

public interface IClusterMembership
{
    IReadOnlyList<ClusterMember> GetAliveMembers();
    IReadOnlyList<ClusterMember> GetAllMembers();
    bool IsMemberAlive(string memberId);
    event EventHandler<ClusterMember>? MemberJoined;
    event EventHandler<ClusterMember>? MemberLeft;
}
```

**Step 2: Create DottedVersionVector.cs** in `DataWarehouse.SDK/Replication/`:

Implement as shown in the research RESEARCH.md Pattern 6. Key methods:
- `Increment(string nodeId)` — increments + prunes dead nodes
- `HappensBefore(DottedVersionVector other)` — partial order comparison
- `static Merge(DottedVersionVector a, DottedVersionVector b)` — join with prune
- `PruneDeadNodes()` — removes entries for nodes not in IClusterMembership.GetAliveMembers()
- `Size` property — for monitoring

Also add:
- `IsConcurrent(DottedVersionVector other)` — neither happens-before the other
- `ToImmutableDictionary()` — for serialization
- `static FromDictionary(IReadOnlyDictionary<string, long>, IClusterMembership)` — for deserialization
- Constructor that accepts optional IClusterMembership (null = no pruning, for backward compat)

**Step 3: Update VectorClock references:**

In `IMultiMasterReplication.cs`: The `VectorClock` record (line ~119) should be marked `[Obsolete("Use DottedVersionVector for bounded memory at scale")]`. Do NOT delete it — existing code references it. Add a conversion method: `DottedVersionVector ToDvv(IClusterMembership membership)`.

In `ReplicationStrategy.cs`: The `VectorClock` class (line ~208) — same treatment, mark `[Obsolete]` with conversion.

In `CrdtReplicationSync.cs`: Update to use DottedVersionVector internally. Keep accepting VectorClock at API boundaries with automatic conversion.

In `ReplicationStrategyBase.cs` (UltimateReplication): Mark `EnhancedVectorClock` as `[Obsolete]`. Add `DottedVersionVector` equivalent methods.

In `ConflictResolutionStrategies.cs` (VectorClockStrategy): Update to use DottedVersionVector internally while maintaining the strategy interface.

**CRITICAL:** Do NOT break existing API contracts. Use [Obsolete] on old types, add new types alongside. Existing code that uses VectorClock continues to compile with warnings only.
  </action>
  <verify>
Build: `dotnet build DataWarehouse.sln --no-restore -v q` — 0 errors (warnings for [Obsolete] expected).
Grep for `DottedVersionVector` in SDK — present in at least 2 files.
Grep for `IClusterMembership` in SDK — present.
  </verify>
  <done>DottedVersionVector created with membership-based pruning. IClusterMembership interface defined. Old VectorClock marked Obsolete with conversion methods. All replication code updated to use DVV internally.</done>
</task>

<task type="auto">
  <name>Task 2: Multi-Raft Consensus Consolidation (KS8)</name>
  <files>
    DataWarehouse.SDK/Contracts/Hierarchy/ConsensusPluginBase.cs
    DataWarehouse.SDK/Contracts/Hierarchy/ResiliencePluginBase.cs
    DataWarehouse.SDK/Contracts/Hierarchy/Feature/InfrastructurePluginBase.cs
    Plugins/DataWarehouse.Plugins.UltimateConsensus/UltimateConsensusPlugin.cs
    Plugins/DataWarehouse.Plugins.UltimateConsensus/DataWarehouse.Plugins.UltimateConsensus.csproj
    Plugins/DataWarehouse.Plugins.UltimateResilience/UltimateResiliencePlugin.cs
    Plugins/DataWarehouse.Plugins.Raft/RaftConsensusPlugin.cs
  </files>
  <action>
**Step 1: Create ConsensusPluginBase.cs** in `DataWarehouse.SDK/Contracts/Hierarchy/`:

```csharp
namespace DataWarehouse.SDK.Contracts.Hierarchy;

/// <summary>Base class for consensus plugins (Raft, Paxos, PBFT, ZAB, etc.).</summary>
public abstract class ConsensusPluginBase : InfrastructurePluginBase
{
    public override string InfrastructureDomain => "Consensus";

    /// <summary>Proposes a value to the consensus group.</summary>
    protected abstract Task<ConsensusResult> ProposeAsync(byte[] data, CancellationToken ct = default);

    /// <summary>Returns true if this node is the current leader.</summary>
    protected abstract Task<bool> IsLeaderAsync(CancellationToken ct = default);

    /// <summary>Gets the current consensus state.</summary>
    protected abstract Task<ConsensusState> GetStateAsync(CancellationToken ct = default);

    /// <summary>Gets cluster health information.</summary>
    protected virtual Task<ClusterHealthInfo> GetClusterHealthAsync(CancellationToken ct = default)
        => Task.FromResult(new ClusterHealthInfo());
}

public record ConsensusResult(bool Committed, long Index, string? Error = null);
public record ConsensusState(string LeaderId, long CommitIndex, long Term, int GroupCount);
public record ClusterHealthInfo(int AliveNodes = 0, int TotalNodes = 0, bool HasQuorum = false);
```

**Step 2: Create ResiliencePluginBase.cs** in `DataWarehouse.SDK/Contracts/Hierarchy/`:

```csharp
namespace DataWarehouse.SDK.Contracts.Hierarchy;

/// <summary>Base class for resilience plugins (circuit breaker, retry, bulkhead, etc.).</summary>
public abstract class ResiliencePluginBase : InfrastructurePluginBase
{
    public override string InfrastructureDomain => "Resilience";

    /// <summary>Executes an operation with resilience policies applied.</summary>
    protected abstract Task<T> ExecuteWithResilienceAsync<T>(
        Func<CancellationToken, Task<T>> operation,
        string policyName,
        CancellationToken ct = default);

    /// <summary>Gets the health of resilience circuits.</summary>
    protected virtual Task<ResilienceHealthInfo> GetResilienceHealthAsync(CancellationToken ct = default)
        => Task.FromResult(new ResilienceHealthInfo());
}

public record ResilienceHealthInfo(int OpenCircuits = 0, int HalfOpenCircuits = 0, int ClosedCircuits = 0);
```

**Step 3: Create UltimateConsensus plugin project:**

Create `Plugins/DataWarehouse.Plugins.UltimateConsensus/` directory and .csproj referencing DataWarehouse.SDK. Add to the solution file.

Create `UltimateConsensusPlugin.cs` implementing Multi-Raft:
- Extends ConsensusPluginBase
- Contains `ConcurrentDictionary<int, RaftGroup> _groups`
- `RaftGroup` inner class: 3-5 voters per group, independent leader election, log replication
- `GetGroupForKey(string key)` — consistent hashing to route to group
- `ProposeAsync` routes to correct group
- Configurable group count and voters-per-group (default: 5 voters)
- Contains Raft, Paxos, PBFT, ZAB as strategy enum (default: Raft)
- RaftGroup implements: AppendEntries, RequestVote, heartbeat timer, election timeout
- Each group has own log, commitIndex, term

The RaftGroup implementation should be production-ready:
- Leader election with randomized timeout (150-300ms configurable)
- Log replication with AppendEntries RPC
- Commit when majority acknowledges
- Leader heartbeats at 1/3 of election timeout
- Snapshot support for log compaction

**Step 4: Update UltimateResilience** to extend ResiliencePluginBase instead of InfrastructurePluginBase. This is a base class change only — read the current UltimateResiliencePlugin.cs and change the inheritance. Implement the abstract `ExecuteWithResilienceAsync<T>` using its existing resilience strategy infrastructure.

**Step 5: Mark Raft plugin as deprecated:**

In `RaftConsensusPlugin.cs`, add `[Obsolete("Use UltimateConsensus plugin which consolidates Raft, Paxos, PBFT, ZAB with Multi-Raft support")]` to the class. Do NOT delete the plugin — it remains for backward compatibility.

**Step 6: Add UltimateConsensus project to solution file** using `dotnet sln add`.

**IMPORTANT:** Check the solution file structure. Other plugins are in `Plugins/` directory. Follow the same .csproj pattern as existing plugins (e.g., UltimateResilience). The project should reference `DataWarehouse.SDK` via ProjectReference.
  </action>
  <verify>
Build: `dotnet build DataWarehouse.sln --no-restore -v q` — 0 errors.
Verify ConsensusPluginBase exists: grep for `class ConsensusPluginBase` in SDK.
Verify ResiliencePluginBase exists: grep for `class ResiliencePluginBase` in SDK.
Verify UltimateConsensus compiles: `dotnet build Plugins/DataWarehouse.Plugins.UltimateConsensus/ --no-restore -v q`.
Verify UltimateResilience extends ResiliencePluginBase: grep for `ResiliencePluginBase` in UltimateResilience.
All tests pass: `dotnet test DataWarehouse.Tests/ --no-build -v q`.
  </verify>
  <done>ConsensusPluginBase and ResiliencePluginBase created in SDK hierarchy. UltimateConsensus plugin implements Multi-Raft with configurable groups. UltimateResilience migrated to ResiliencePluginBase. Raft plugin deprecated. Build succeeds with 0 errors.</done>
</task>

</tasks>

<verification>
1. `dotnet build DataWarehouse.sln --no-restore -v q` — 0 errors
2. DottedVersionVector exists with PruneDeadNodes, IClusterMembership
3. Old VectorClock types marked [Obsolete]
4. ConsensusPluginBase, ResiliencePluginBase in SDK hierarchy
5. UltimateConsensus plugin in solution with Multi-Raft
6. UltimateResilience extends ResiliencePluginBase
7. Raft plugin marked [Obsolete]
8. All existing tests pass
</verification>

<success_criteria>
- KS7: DottedVersionVector with membership pruning replaces unbounded VectorClock
- KS8: Multi-Raft consensus with new SDK base classes, UltimateConsensus plugin
- Build: 0 errors (Obsolete warnings expected)
- Tests: All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/41.1-architecture-kill-shots-10-critical-fixes-from-hostile-audit/41.1-04-SUMMARY.md`
</output>
