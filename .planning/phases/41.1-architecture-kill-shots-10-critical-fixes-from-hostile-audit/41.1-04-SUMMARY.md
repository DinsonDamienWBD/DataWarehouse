---
phase: 41.1-architecture-kill-shots-10-critical-fixes-from-hostile-audit
plan: 04
subsystem: sdk, hierarchy, architecture
tags: [base-classes, legacy-deletion, v3.0-hierarchy, plugin-migration, key-management, storage-chain]

# Dependency graph
requires:
  - phase: 41.1-03
    provides: Strategy lifecycle fixes, naming collision resolution
  - phase: 41.1-06
    provides: ConsensusPluginBase extensions, Multi-Raft records
provides:
  - SelectOptimalAlgorithmAsync consolidated in DataTransformationPluginBase
  - Full key management in hierarchy EncryptionPluginBase (IKeyStore, envelope, per-user config)
  - Opt-in caching and indexing in hierarchy StoragePluginBase
  - PluginBase.cs reduced to 1,161 lines (legacy block deleted)
  - 4 legacy extraction files for unmigrated consumers
  - Kernel and plugin pipeline references updated to hierarchy types
affects: [41.1-05, 41.1-07, v3.0-phases]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Extraction pattern: classes with unmigrated URI-based consumers extracted to standalone Legacy*.cs files"
    - "Opt-in features: StoragePluginBase.EnableCaching()/EnableIndexing() instead of inheritance chain"
    - "Forwarding shim: LegacyInterfacePluginBase.cs provides namespace compatibility"

key-files:
  created:
    - DataWarehouse.SDK/Contracts/LegacyStoragePluginBases.cs
    - DataWarehouse.SDK/Contracts/LegacyConsensusPluginBase.cs
    - DataWarehouse.SDK/Contracts/LegacyContainerManagerPluginBase.cs
    - DataWarehouse.SDK/Contracts/LegacyInterfacePluginBase.cs
  modified:
    - DataWarehouse.SDK/Contracts/PluginBase.cs
    - DataWarehouse.SDK/Contracts/Hierarchy/DataPipeline/DataTransformationPluginBase.cs
    - DataWarehouse.SDK/Contracts/Hierarchy/DataPipeline/EncryptionPluginBase.cs
    - DataWarehouse.SDK/Contracts/Hierarchy/DataPipeline/StoragePluginBase.cs
    - DataWarehouse.SDK/Contracts/TransitEncryptionPluginBases.cs
    - DataWarehouse.SDK/Contracts/MilitarySecurityPluginBases.cs
    - DataWarehouse.SDK/Contracts/LowLatencyPluginBases.cs
    - DataWarehouse.SDK/Contracts/Encryption/EncryptionStrategy.cs
    - DataWarehouse.Kernel/Pipeline/PipelineOrchestrator.cs
    - DataWarehouse.Kernel/Pipeline/EnhancedPipelineOrchestrator.cs
    - Plugins/DataWarehouse.Plugins.UltimateIntelligence/UltimateIntelligencePlugin.cs
    - Plugins/DataWarehouse.Plugins.UltimateStorage/Migration/StorageMigrationService.cs
    - .planning/PLUGIN-CATALOG.md

key-decisions:
  - "Extraction over deletion for URI-based storage chain: HybridDatabase, HybridStorage, InMemoryStorage deeply depend on URI-based APIs (SaveAsync(Uri)/LoadAsync(Uri)) incompatible with key-based hierarchy StoragePluginBase"
  - "InterfacePluginBase kept as forwarding shim: 4 SDK files and 1 plugin still use it, thin wrapper avoids multi-file migration"
  - "EncryptionStatistics extended (not replaced): added UniqueKeysUsed/LastKeyAccess to existing class in EncryptionStrategy.cs for hierarchy compat"
  - "Opt-in caching/indexing pattern: StoragePluginBase uses EnableCaching()/EnableIndexing() instead of inheritance chain (CacheableStoragePluginBase -> IndexableStoragePluginBase)"

patterns-established:
  - "Legacy extraction: unmigrated consumers get Legacy*.cs standalone files while main PluginBase.cs is cleaned"
  - "Hierarchy consolidation: methods previously duplicated in leaf classes (SelectOptimalAlgorithmAsync) moved to single base class"

# Metrics
duration: ~120min
completed: 2026-02-17
---

# Phase 41.1 Plan 04: Architecture Kill Shots (FIX-10/11/12/13) Summary

**PluginBase.cs legacy deletion (3310->1161 lines), key management port to hierarchy EncryptionPluginBase, SelectOptimalAlgorithmAsync consolidated in DataTransformationPluginBase, storage chain opt-in caching/indexing**

## Performance

- **Duration:** ~120 min (across 2 sessions)
- **Started:** 2026-02-17T09:11:27Z
- **Completed:** 2026-02-17T11:17:09Z
- **Tasks:** 11 (10 executed + 1 verification)
- **Files modified:** 17

## Accomplishments
- Deleted ~2,150 lines of legacy base classes from PluginBase.cs (14 classes removed)
- Ported full key management (IKeyStore, IEnvelopeKeyStore, envelope wrap/unwrap, per-user config, statistics) to hierarchy EncryptionPluginBase
- Consolidated SelectOptimalAlgorithmAsync in DataTransformationPluginBase (was duplicated in leaf classes)
- Added opt-in caching and indexing to hierarchy StoragePluginBase via EnableCaching()/EnableIndexing()
- Migrated 4 SDK intermediate bases and 1 plugin to v3.0 hierarchy
- Full build succeeds with zero errors across SDK, Kernel, all 60+ plugins, and Tests

## Task Commits

Each task was committed atomically:

1. **Task 1: FIX-10 Discovery** - `b2251fb` (docs)
2. **Task 2: FIX-10 Execution** - `49d795a` (feat)
3. **Task 3: FIX-12 Discovery** - `61a6d59` (docs)
4. **Task 4: FIX-12 Execution** - `b38a52e` (feat)
5. **Task 5: FIX-13 Discovery** - `1dfe22a` (docs)
6. **Task 6: FIX-13 Execution** - `02f6c34` (feat)
7. **Task 7: FIX-11 Pre-deletion Checklist** - `6f44249` (docs)
8. **Task 8: FIX-11 Migration** - `41eabd6` (feat)
9. **Task 9: FIX-11 Deletion** - `dc53de8` (feat)
10. **Task 10: Final Build Verification** - (no separate commit, verified in Task 9)
11. **Task 11: PLUGIN-CATALOG Update** - `9fe4cd2` (docs)

## Files Created/Modified

**Created:**
- `DataWarehouse.SDK/Contracts/LegacyStoragePluginBases.cs` - Extracted URI-based storage chain (StorageProviderPluginBase, ListableStoragePluginBase, CacheableStoragePluginBase, IndexableStoragePluginBase, TieredStoragePluginBase)
- `DataWarehouse.SDK/Contracts/LegacyConsensusPluginBase.cs` - Extracted ConsensusPluginBase + ClusterState
- `DataWarehouse.SDK/Contracts/LegacyContainerManagerPluginBase.cs` - Extracted ContainerManagerPluginBase
- `DataWarehouse.SDK/Contracts/LegacyInterfacePluginBase.cs` - Forwarding shim to Hierarchy.InterfacePluginBase

**Modified (SDK hierarchy):**
- `DataWarehouse.SDK/Contracts/PluginBase.cs` - 3310 -> 1161 lines (legacy block deleted)
- `DataWarehouse.SDK/Contracts/Hierarchy/DataPipeline/DataTransformationPluginBase.cs` - Added SelectOptimalAlgorithmAsync
- `DataWarehouse.SDK/Contracts/Hierarchy/DataPipeline/EncryptionPluginBase.cs` - Full key management port
- `DataWarehouse.SDK/Contracts/Hierarchy/DataPipeline/StoragePluginBase.cs` - Opt-in caching/indexing
- `DataWarehouse.SDK/Contracts/Encryption/EncryptionStrategy.cs` - Added UniqueKeysUsed/LastKeyAccess

**Modified (SDK intermediate bases):**
- `DataWarehouse.SDK/Contracts/TransitEncryptionPluginBases.cs` - Migrated to hierarchy DataTransformationPluginBase
- `DataWarehouse.SDK/Contracts/MilitarySecurityPluginBases.cs` - Migrated to hierarchy SecurityPluginBase
- `DataWarehouse.SDK/Contracts/LowLatencyPluginBases.cs` - Migrated to hierarchy DataPipelinePluginBase

**Modified (Kernel):**
- `DataWarehouse.Kernel/Pipeline/PipelineOrchestrator.cs` - PipelinePluginBase -> DataPipelinePluginBase
- `DataWarehouse.Kernel/Pipeline/EnhancedPipelineOrchestrator.cs` - Same migration

**Modified (Plugins):**
- `Plugins/DataWarehouse.Plugins.UltimateIntelligence/UltimateIntelligencePlugin.cs` - PipelinePluginBase -> DataTransformationPluginBase
- `Plugins/DataWarehouse.Plugins.UltimateStorage/Migration/StorageMigrationService.cs` - PipelinePluginBase -> DataTransformationPluginBase

## Decisions Made
1. **Extraction over deletion for URI-based storage chain** - HybridDatabasePluginBase, HybridStoragePluginBase, InMemoryStoragePlugin deeply depend on URI-based APIs (SaveAsync(Uri)/LoadAsync(Uri)). The hierarchy StoragePluginBase uses key-based APIs. Migrating would require complete rewrites of 2,000+ lines across 3 files. Extraction preserves functionality while cleaning PluginBase.cs.
2. **InterfacePluginBase forwarding shim** - 4 SDK files and 1 plugin still reference `DataWarehouse.SDK.Contracts.InterfacePluginBase`. Rather than modifying all consumers, a one-line forwarding class provides namespace compatibility.
3. **EncryptionStatistics extension** - Added `UniqueKeysUsed` and `LastKeyAccess` properties to the existing `EncryptionStatistics` class in `EncryptionStrategy.cs` rather than creating a new class. The hierarchy EncryptionPluginBase populates these from its `KeyAccessLog`.
4. **Opt-in caching/indexing** - New `StoragePluginBase` uses `EnableCaching()`/`EnableIndexing()` method calls instead of inheritance chain. More flexible and doesn't force consumers to extend a specific base class.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] EncryptionStatistics missing UniqueKeysUsed/LastKeyAccess**
- **Found during:** Task 9 (FIX-11 Deletion)
- **Issue:** Hierarchy EncryptionPluginBase sets UniqueKeysUsed and LastKeyAccess on EncryptionStatistics, but those properties didn't exist on the class in EncryptionStrategy.cs (they were on the deleted legacy record in PluginBase.cs)
- **Fix:** Added UniqueKeysUsed (int) and LastKeyAccess (DateTime) to EncryptionStatistics class
- **Files modified:** DataWarehouse.SDK/Contracts/Encryption/EncryptionStrategy.cs
- **Verification:** SDK builds clean
- **Committed in:** dc53de8

**2. [Rule 3 - Blocking] Kernel PipelineOrchestrator referenced deleted PipelinePluginBase**
- **Found during:** Task 9 (FIX-11 Deletion)
- **Issue:** PipelineOrchestrator.cs and EnhancedPipelineOrchestrator.cs cast plugins to PipelinePluginBase for DefaultOrder/AllowBypass
- **Fix:** Updated to cast to DataPipelinePluginBase, updated property name DefaultOrder -> DefaultPipelineOrder, added .ToArray() for IReadOnlyList<string> compat
- **Files modified:** DataWarehouse.Kernel/Pipeline/PipelineOrchestrator.cs, EnhancedPipelineOrchestrator.cs
- **Verification:** Kernel builds clean
- **Committed in:** dc53de8

**3. [Rule 3 - Blocking] UltimateStorage referenced deleted PipelinePluginBase**
- **Found during:** Task 9 (FIX-11 Deletion)
- **Issue:** StorageMigrationService.cs cast plugins to PipelinePluginBase for SubCategory checks
- **Fix:** Updated to cast to DataTransformationPluginBase
- **Files modified:** Plugins/DataWarehouse.Plugins.UltimateStorage/Migration/StorageMigrationService.cs
- **Verification:** Full build succeeds
- **Committed in:** dc53de8

**4. [Rule 3 - Blocking] InterfacePluginBase consumers not migrated**
- **Found during:** Task 9 (FIX-11 Deletion)
- **Issue:** 4 SDK files and 1 plugin still extend legacy InterfacePluginBase from DataWarehouse.SDK.Contracts namespace
- **Fix:** Created LegacyInterfacePluginBase.cs as forwarding shim to Hierarchy.InterfacePluginBase
- **Files modified:** DataWarehouse.SDK/Contracts/LegacyInterfacePluginBase.cs (created)
- **Verification:** Full build succeeds
- **Committed in:** dc53de8

**5. [Rule 3 - Blocking] LegacyContainerManagerPluginBase missing ISecurityContext using**
- **Found during:** Task 9 (FIX-11 Deletion)
- **Issue:** Extracted ContainerManagerPluginBase referenced ISecurityContext without using DataWarehouse.SDK.Security
- **Fix:** Added missing using directive
- **Files modified:** DataWarehouse.SDK/Contracts/LegacyContainerManagerPluginBase.cs
- **Verification:** SDK builds clean
- **Committed in:** dc53de8

---

**Total deviations:** 5 auto-fixed (1 bug, 4 blocking)
**Impact on plan:** All auto-fixes were necessary for build correctness after legacy deletion. No scope creep.

## Issues Encountered
- **Linter reverts on Raft/Consensus plugin files**: External linter repeatedly reverted changes to RaftConsensusPlugin.cs (3+ attempts). Resolution: extracted ConsensusPluginBase to standalone file instead of migrating consumers.
- **URI-based vs key-based API mismatch**: Legacy storage chain uses URI-based APIs; hierarchy uses key-based. Full migration would require rewriting ~2,000 lines. Resolution: extraction to standalone files.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- PluginBase.cs is now clean (1,161 lines, main class only)
- v3.0 hierarchy is the primary base class system
- 4 extraction files document exactly which consumers still need migration (future phases)
- Full build succeeds across all projects with zero errors

## Self-Check: PASSED

All 7 key files verified present. All 10 commit hashes verified in git log.

---
*Phase: 41.1-architecture-kill-shots-10-critical-fixes-from-hostile-audit*
*Plan: 04*
*Completed: 2026-02-17*
