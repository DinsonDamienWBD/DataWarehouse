# Phase 41.1: Architecture Kill Shots — 20 Critical Fixes from Hostile Audit - Context

**Gathered:** 2026-02-17
**Status:** Ready for planning

<domain>
## Phase Boundary

Fix 20 critical architecture defects across the SDK, kernel, and plugin system identified by hostile audit. Covers: sync-over-async elimination (KS1), kernel DI wiring (KS2), typed message handlers (KS3), NativeKeyHandle secure memory (KS5), tenant isolation (KS6+10), DVV vector clocks (KS7), Multi-Raft consensus consolidation (KS8), lineage stub replacement (KS9), strategy base lifecycle shadowing (KS14), common infrastructure consolidation (KS15), naming consistency (KS16), and hierarchy cleanup.

All changes are correctness fixes and architectural hardening — no new user-facing features.

</domain>

<decisions>
## Implementation Decisions

### Deprecation Policy
- **Hard removal, not [Obsolete]**: Once code is fully migrated, delete the old code entirely. No deprecation shims, no warning-only markers.
- **VectorClock**: Delete the class entirely after DVV migration is complete. No tombstone files.
- **Raft plugin**: Port all useful logic into UltimateConsensus, then delete the entire Plugins/DataWarehouse.Plugins.Raft/ project directory, remove from solution. Full deletion.
- **Sync wrappers**: Delete ALL .GetAwaiter().GetResult(), .Result, .Wait() patterns across the ENTIRE solution (SDK, kernel, all plugins) — not just SDK. Zero sync-over-async unless specifically and explicitly needed with comments explaining why.
- **Files/projects removed**: Full deletion from solution, no tombstone files or redirect comments.

### New Plugin Boundaries
- **UltimateConsensus**: Standalone plugin (DataWarehouse.Plugins.UltimateConsensus). One domain = one plugin. Consensus is its own domain, separate from replication.
- **Consensus strategies**: Full 100% production-ready implementations for ALL consensus protocols (Raft, Paxos, PBFT, ZAB). Zero stubs unless intentionally left with explicit comments explaining why.
- **Clean domain separation**: Move ALL consensus code out of UltimateReplication. It becomes pure replication (CRDTs, sync, conflict resolution).
- **Shared types in SDK**: Shared types (LogEntry, etc.) move to SDK at the correct hierarchy level, not duplicated across plugins.
- **Phase 26 in-memory implementations → refactor into base classes + plugins**: All 13 Phase 26 in-memory implementations (SWIM, Raft, CRDT, gossip, load balancers, etc.) get refactored: common logic moves into SDK base classes at the correct hierarchy level, concrete implementations move to the correct Ultimate plugins. No duplication — plugins implement only their unique logic. Included in 41.1 scope (not deferred).
- **Base class defaults**: SDK base classes provide sensible in-memory/single-node defaults as virtual methods. Plugins override with distributed/production implementations. System is always functional without plugins (development/testing). Industry standard pattern (ASP.NET Core, Spring Boot).

### Breaking Change Tolerance
- **Break freely**: Pre-release, no external consumers. Fix everything for correctness now. All callers fixed in-tree.
- **Full cascade for infrastructure methods**: Fix 19 domain base classes AND scan ALL 900+ concrete strategies for duplicate counter/retry/health patterns. Replace with StrategyBase methods everywhere.
- **Naming standardization**: `StrategyId` (unique machine identifier) + `DisplayName` (human-readable label). Remove `StrategyName` and bare `Name` from strategy hierarchy entirely. Full rename across solution.

### Tenant Isolation (KS6+10)
- **Layered cache + persistence**: In-memory ConcurrentDictionary as hot cache. Every write persists via message bus (storage.write topic). Reads check cache first, then fall back to storage. Works single-node (cache only) and distributed (cache + remote storage).
- **No default tenant — fail loudly**: `InvalidOperationException` if no SecurityContext.TenantId is set. Every operation must have tenant context. No implicit defaults (security hole).
- **Cross-tenant access via explicit API**: Separate methods: `GetDataAsync` (tenant-scoped) vs `GetDataAcrossTenantsAsync` (requires admin claim, audited). No accidental cross-tenant access.
- **Cache eviction: bounded LRU + TTL**: Max entries per tenant (bounded) AND TTL on each entry. Configurable via options pattern. Prevents memory exhaustion and stale data.

### Claude's Discretion
- Exact TTL and LRU size defaults (reasonable production defaults)
- Internal implementation details of Paxos/PBFT/ZAB consensus protocols
- Specific file organization within UltimateConsensus plugin
- Cache implementation details (e.g., MemoryCache vs custom ConcurrentDictionary wrapper)

</decisions>

<specifics>
## Specific Ideas

- "100% production ready for ANY environment" — the overriding principle for all decisions
- Rule 13 compliance: zero stubs, mocks, placeholders except with explicit justifying comments
- All decisions favor correctness and security over backward compatibility
- Naming convention: StrategyId + DisplayName replaces all previous Name/StrategyName/DisplayName inconsistencies

</specifics>

<deferred>
## Deferred Ideas

None — all discussion items resolved.

</deferred>

---

*Phase: 41.1-architecture-kill-shots-10-critical-fixes-from-hostile-audit*
*Context gathered: 2026-02-17*
