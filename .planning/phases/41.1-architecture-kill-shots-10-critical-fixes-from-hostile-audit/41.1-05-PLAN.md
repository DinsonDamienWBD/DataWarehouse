---
plan: 05
wave: 2
depends_on: ["41.1-01", "41.1-04"]
autonomous: true
model_profile: balanced
estimated_tokens: 15000
---

# Plan 41.1-05: KS5 (NativeKeyHandle) + KS3 (Typed Message Handlers)

## Context

**Wave 2 Critical Fixes** — depends on plan 41.1-01 (SDK foundation) and 41.1-04 (EncryptionPluginBase hierarchy port).

Two kill shots from hostile audit:

**KS5: NativeKeyHandle** — Current key management uses byte[] arrays that can be copied/leaked. Need native memory handles with secure wipe guarantees. Uses `NativeMemory.AllocZeroed` for unmanaged allocation, exposes `Span<byte>` for zero-copy access, and guarantees secure wipe on Dispose.

**KS3: Typed Message Handlers** — Current message bus integration requires manual topic subscription and type casting in every intelligence plugin. Need strongly-typed registration API with automatic topic mapping and deferred subscription support (handlers registered before message bus injection).

Both fixes target the new SDK hierarchy established in plan 01 and cleaned by plan 04. All changes production-ready, zero stubs.

## Must Haves

1. **NativeKeyHandle.cs** in `DataWarehouse.SDK/Security/` with:
   - Unmanaged memory allocation via `NativeMemory.AllocZeroed`
   - `Span<byte> KeySpan { get; }` property for zero-copy access
   - Secure wipe on Dispose (zero memory before `NativeMemory.Free`)
   - `FromBytes(byte[])` static factory
   - `FromBytes(ReadOnlySpan<byte>)` static factory
   - XML docs with security notes

2. **SDK .csproj AllowUnsafeBlocks** — Enable `<AllowUnsafeBlocks>true</AllowUnsafeBlocks>` in `DataWarehouse.SDK/DataWarehouse.SDK.csproj`

3. **IKeyStore DIM** — Add `GetKeyNativeAsync(string keyId, CancellationToken ct)` to `IKeyStore` via default interface method that wraps `GetKeyAsync` and converts byte[] to NativeKeyHandle

4. **KeyStoreStrategyBase Update** — Add virtual `GetKeyNativeAsync` method that calls base IKeyStore DIM (allows override for native-first implementations)

5. **EncryptionPluginBase Update** — Add protected `GetKeyNativeAsync` helper that delegates to KeyStore.GetKeyNativeAsync

6. **SecurityPluginBase Update** — Add protected `GetKeyNativeAsync` helper that delegates to KeyStore.GetKeyNativeAsync

7. **UltimateKeyManagement Plugin Update** — Implement native-first key retrieval (override GetKeyNativeAsync to skip byte[] intermediate)

8. **UltimateEncryption Plugin Update** — Use NativeKeyHandle in encryption/decryption operations where applicable

9. **Typed Message Handler Registration** — Add to `IntelligenceAwarePluginBase`:
   - `RegisterHandler<TRequest, TResponse>(Func<TRequest, CancellationToken, Task<TResponse>>)` — request/response pattern
   - `RegisterHandler<TNotification>(Func<TNotification, CancellationToken, Task>)` — fire-and-forget pattern
   - Auto-subscribe to message bus using `typeof(T).FullName` as topic
   - Deferred subscription support (store handlers if message bus not yet injected, subscribe on InjectKernelServices)
   - `GetRegisteredHandlers()` for discovery

10. **Intelligence Plugin Examples** — Update 2-3 intelligence plugins to use typed handlers (e.g., `Plugins.Intelligence.EnhancedAnomalyDetection`, `Plugins.Intelligence.KnowledgeGraphLinking`)

## Tasks

### Phase 1: NativeKeyHandle Implementation

- [ ] **1.1: Create NativeKeyHandle.cs**
  - File: `DataWarehouse.SDK/Security/NativeKeyHandle.cs`
  - Implement IDisposable
  - Use `NativeMemory.AllocZeroed` for allocation
  - `Span<byte> KeySpan { get; }` property (unsafe pointer to span)
  - `int Length { get; }` property
  - Secure wipe on Dispose: zero memory via `NativeMemory.Clear`, then `NativeMemory.Free`
  - `FromBytes(byte[] key)` static factory
  - `FromBytes(ReadOnlySpan<byte> key)` static factory
  - XML docs with security warnings
  - **Verify**: Build succeeds, no warnings
  - **Done**: File committed, NativeKeyHandle class complete

- [ ] **1.2: Enable AllowUnsafeBlocks in SDK**
  - File: `DataWarehouse.SDK/DataWarehouse.SDK.csproj`
  - Add `<AllowUnsafeBlocks>true</AllowUnsafeBlocks>` in PropertyGroup
  - **Verify**: SDK builds without errors
  - **Done**: .csproj updated, unsafe code allowed

### Phase 2: IKeyStore and Strategy Updates

- [ ] **2.1: Add GetKeyNativeAsync to IKeyStore**
  - File: `DataWarehouse.SDK/Plugins/Bases/IKeyStore.cs`
  - Add default interface method: `Task<NativeKeyHandle> GetKeyNativeAsync(string keyId, CancellationToken ct)`
  - Implementation: call GetKeyAsync, wrap result in NativeKeyHandle.FromBytes
  - XML docs
  - **Verify**: SDK builds, IKeyStore contract extended
  - **Done**: DIM added and documented

- [ ] **2.2: Update KeyStoreStrategyBase**
  - File: `DataWarehouse.SDK/Strategies/KeyStoreStrategyBase.cs`
  - Add virtual `GetKeyNativeAsync(string keyId, CancellationToken ct)` method
  - Default implementation delegates to IKeyStore DIM
  - XML docs noting override opportunity for native-first implementations
  - **Verify**: SDK builds, KeyStoreStrategyBase compiles
  - **Done**: Virtual method added

### Phase 3: Plugin Base Class Updates

- [ ] **3.1: Update EncryptionPluginBase**
  - File: `DataWarehouse.SDK/Plugins/Bases/EncryptionPluginBase.cs`
  - Add protected `Task<NativeKeyHandle> GetKeyNativeAsync(string keyId, CancellationToken ct)` helper
  - Implementation: `return KeyStore.GetKeyNativeAsync(keyId, ct);`
  - XML docs
  - **Verify**: SDK builds, EncryptionPluginBase compiles
  - **Done**: Helper method added

- [ ] **3.2: Update SecurityPluginBase**
  - File: `DataWarehouse.SDK/Plugins/Bases/SecurityPluginBase.cs`
  - Add protected `Task<NativeKeyHandle> GetKeyNativeAsync(string keyId, CancellationToken ct)` helper
  - Implementation: `return KeyStore.GetKeyNativeAsync(keyId, ct);`
  - XML docs
  - **Verify**: SDK builds, SecurityPluginBase compiles
  - **Done**: Helper method added

### Phase 4: Plugin Updates (UltimateKeyManagement, UltimateEncryption)

- [ ] **4.1: Update UltimateKeyManagement Plugin**
  - File: `Plugins/DataWarehouse.Plugins.Security.UltimateKeyManagement/UltimateKeyManagementPlugin.cs`
  - Override `GetKeyNativeAsync` for native-first key retrieval
  - Allocate NativeKeyHandle directly from key storage, skip byte[] intermediate
  - Update any internal key operations to use NativeKeyHandle where applicable
  - **Verify**: Plugin builds, no warnings
  - **Done**: Native-first key retrieval implemented

- [ ] **4.2: Update UltimateEncryption Plugin**
  - File: `Plugins/DataWarehouse.Plugins.Security.UltimateEncryption/UltimateEncryptionPlugin.cs`
  - Use `GetKeyNativeAsync` in encryption/decryption operations
  - Update crypto operations to accept Span<byte> from NativeKeyHandle.KeySpan
  - Ensure proper Dispose of NativeKeyHandle after use
  - **Verify**: Plugin builds, crypto tests pass (if any exist)
  - **Done**: NativeKeyHandle integrated in crypto operations

### Phase 5: Typed Message Handler Registration

- [ ] **5.1: Add RegisterHandler Methods to IntelligenceAwarePluginBase**
  - File: `DataWarehouse.SDK/Plugins/Bases/IntelligenceAwarePluginBase.cs`
  - Add private list to track pending handlers (for deferred subscription)
  - Add `RegisterHandler<TRequest, TResponse>(Func<TRequest, CancellationToken, Task<TResponse>> handler)`
    - Auto-subscribe to topic: `typeof(TRequest).FullName`
    - Wrapper: deserialize message payload to TRequest, invoke handler, serialize TResponse, send reply
    - Store handler if message bus not yet injected
  - Add `RegisterHandler<TNotification>(Func<TNotification, CancellationToken, Task> handler)`
    - Auto-subscribe to topic: `typeof(TNotification).FullName`
    - Wrapper: deserialize message payload to TNotification, invoke handler
    - Store handler if message bus not yet injected
  - Update `InjectKernelServices` to subscribe pending handlers when message bus becomes available
  - Add `IReadOnlyList<(Type RequestType, Type? ResponseType)> GetRegisteredHandlers()` for discovery
  - XML docs with usage examples
  - **Verify**: SDK builds, IntelligenceAwarePluginBase compiles
  - **Done**: Typed handler registration API complete

### Phase 6: Intelligence Plugin Examples

- [ ] **6.1: Update EnhancedAnomalyDetection Plugin**
  - File: `Plugins/DataWarehouse.Plugins.Intelligence.EnhancedAnomalyDetection/EnhancedAnomalyDetectionPlugin.cs`
  - Replace manual message bus subscription with `RegisterHandler<AnomalyDetectionRequest, AnomalyDetectionResponse>`
  - Define request/response DTOs if not already present
  - Remove manual topic subscription and type casting boilerplate
  - **Verify**: Plugin builds, message handling still functional
  - **Done**: Typed handlers integrated

- [ ] **6.2: Update KnowledgeGraphLinking Plugin**
  - File: `Plugins/DataWarehouse.Plugins.Intelligence.KnowledgeGraphLinking/KnowledgeGraphLinkingPlugin.cs`
  - Replace manual message bus subscription with `RegisterHandler<GraphLinkingRequest, GraphLinkingResponse>`
  - Define request/response DTOs if not already present
  - Remove manual topic subscription and type casting boilerplate
  - **Verify**: Plugin builds, message handling still functional
  - **Done**: Typed handlers integrated

- [ ] **6.3: Update One More Intelligence Plugin (Optional)**
  - File: Choose from `Plugins/DataWarehouse.Plugins.Intelligence.*` (e.g., PredictiveLoadBalancer, AutoScalingIntelligence)
  - Apply same pattern: RegisterHandler<TRequest, TResponse>
  - Remove manual subscription boilerplate
  - **Verify**: Plugin builds
  - **Done**: Third example complete

### Phase 7: Build and Verification

- [ ] **7.1: Full Solution Build**
  - Run: `dotnet build DataWarehouse.sln`
  - **Verify**: Zero errors, zero warnings
  - **Done**: Solution builds cleanly

- [ ] **7.2: LSP Diagnostics Check**
  - Run: `lsp_diagnostics_directory` on SDK and updated plugin directories
  - **Verify**: No errors, no warnings
  - **Done**: LSP clean

- [ ] **7.3: Security Review of NativeKeyHandle**
  - Review: NativeKeyHandle disposal guarantees secure wipe
  - Review: No byte[] leakage in crypto operations
  - Review: Span<byte> usage prevents accidental copies
  - **Verify**: Security patterns correct
  - **Done**: Security review complete

- [ ] **7.4: Message Handler Registration Review**
  - Review: Deferred subscription works (handlers registered before message bus injection)
  - Review: Topic names match expected pattern (Type.FullName)
  - Review: Request/response and fire-and-forget patterns both supported
  - **Verify**: API design correct
  - **Done**: Handler registration review complete

- [ ] **7.5: Update Living Documentation (DOC-21)**
  - File: `.planning/PLUGIN-CATALOG.md`
  - Update NativeKeyHandle in security section: document unmanaged memory allocation, secure wipe on Dispose, Span<byte> access pattern
  - Update IKeyStore interface documentation: document GetKeyNativeAsync DIM
  - Update KeyStoreStrategyBase: document virtual GetKeyNativeAsync for native-first implementations
  - Update EncryptionPluginBase and SecurityPluginBase: document protected GetKeyNativeAsync helpers
  - Update typed message handler section in IntelligenceAwarePluginBase: document RegisterHandler<TRequest, TResponse> and RegisterHandler<TNotification>, deferred subscription pattern, GetRegisteredHandlers()
  - Update UltimateKeyManagement entry: note native-first key retrieval override
  - Update UltimateEncryption entry: note NativeKeyHandle integration in crypto operations
  - Update intelligence plugin entries (EnhancedAnomalyDetection, KnowledgeGraphLinking): note typed handler usage
  - **Verify**: PLUGIN-CATALOG.md reflects all KS5 and KS3 changes
  - **Done**: PLUGIN-CATALOG.md updated with all changes from this plan

## Verification

1. **Build**: `dotnet build DataWarehouse.sln` — zero errors, zero warnings
2. **LSP**: `lsp_diagnostics_directory` on SDK and plugin directories — all clean
3. **Code Review**: NativeKeyHandle secure wipe verified, no byte[] leakage
4. **API Review**: Typed message handler registration API complete, deferred subscription supported
5. **Plugin Examples**: 2-3 intelligence plugins updated to use typed handlers

## Success Criteria

- [ ] NativeKeyHandle.cs implemented with NativeMemory.AllocZeroed and secure wipe
- [ ] SDK .csproj has AllowUnsafeBlocks enabled
- [ ] IKeyStore extended with GetKeyNativeAsync DIM
- [ ] KeyStoreStrategyBase, EncryptionPluginBase, SecurityPluginBase updated with GetKeyNativeAsync helpers
- [ ] UltimateKeyManagement and UltimateEncryption plugins use NativeKeyHandle
- [ ] IntelligenceAwarePluginBase has RegisterHandler<TRequest, TResponse> and RegisterHandler<TNotification>
- [ ] Deferred subscription supported (handlers registered before message bus injection)
- [ ] GetRegisteredHandlers() discovery method present
- [ ] 2-3 intelligence plugins updated to use typed handlers
- [ ] Full solution builds with zero errors and zero warnings
- [ ] LSP diagnostics clean on all changed directories
- [ ] Security review confirms no key leakage paths
- [ ] DOC-21: PLUGIN-CATALOG.md updated to reflect all changes from this plan

## Output

**Artifacts**:
- `DataWarehouse.SDK/Security/NativeKeyHandle.cs` — native memory key handle
- `DataWarehouse.SDK/DataWarehouse.SDK.csproj` — AllowUnsafeBlocks enabled
- `DataWarehouse.SDK/Plugins/Bases/IKeyStore.cs` — GetKeyNativeAsync DIM
- `DataWarehouse.SDK/Strategies/KeyStoreStrategyBase.cs` — virtual GetKeyNativeAsync
- `DataWarehouse.SDK/Plugins/Bases/EncryptionPluginBase.cs` — GetKeyNativeAsync helper
- `DataWarehouse.SDK/Plugins/Bases/SecurityPluginBase.cs` — GetKeyNativeAsync helper
- `DataWarehouse.SDK/Plugins/Bases/IntelligenceAwarePluginBase.cs` — typed message handler registration
- `Plugins/DataWarehouse.Plugins.Security.UltimateKeyManagement/UltimateKeyManagementPlugin.cs` — native-first key retrieval
- `Plugins/DataWarehouse.Plugins.Security.UltimateEncryption/UltimateEncryptionPlugin.cs` — NativeKeyHandle integration
- `Plugins/DataWarehouse.Plugins.Intelligence.EnhancedAnomalyDetection/*` — typed handler example
- `Plugins/DataWarehouse.Plugins.Intelligence.KnowledgeGraphLinking/*` — typed handler example
- Updated plugin (optional third example)

**Completion Evidence**:
- Build log showing zero errors/warnings
- LSP diagnostics output showing clean state
- Security review notes confirming no key leakage
- Handler registration review notes confirming deferred subscription support

**Dependencies**: None blocking (depends on 41.1-01 and 41.1-04, both Wave 1)

**KS Resolution**:
- KS5 (NativeKeyHandle): RESOLVED — native memory allocation with secure wipe
- KS3 (Typed Message Handlers): RESOLVED — strongly-typed registration API with deferred subscription
