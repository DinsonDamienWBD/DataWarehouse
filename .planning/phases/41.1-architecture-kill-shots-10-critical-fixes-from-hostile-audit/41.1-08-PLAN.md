---
phase: 41.1-architecture-kill-shots
plan: 08
type: execute
wave: 3
depends_on: []
files_modified:
  - DataWarehouse.Launcher/Program.cs
  - DataWarehouse.Launcher/PluginProfileLoader.cs
  - DataWarehouse.SDK/Hosting/PluginProfileAttribute.cs
  - DataWarehouse.SDK/Hosting/ServiceProfileType.cs
  - DataWarehouse.CLI/Commands/Service/ServiceCommandHandler.cs
  - DataWarehouse.Shared/Services/PlatformServiceManager.cs
  - .planning/PLUGIN-CATALOG.md
autonomous: true
model_profile: balanced
estimated_tokens: 12000
---

# Plan 41.1-08: Unified Service Binary with Profile-Based Plugin Loading

## Context

**Architecture Decision**: The DataWarehouse.Launcher is a single cross-platform binary that runs as a daemon on BOTH server and client machines. Plugin loading is profile-based:
- `--profile server`: Loads full plugin set (ServerDispatcher, control plane, storage, intelligence, etc.)
- `--profile client`: Loads minimal client set (ClientCourier, control plane subscriber, watchdog)
- `--profile auto`: Auto-detects from config or available plugins

This ensures AEDS server/client architecture works as a production service without needing separate binaries.

## Must Haves

1. **ServiceProfileType enum** in SDK — `Server`, `Client`, `Both`, `None`
2. **PluginProfileAttribute** in SDK — marks each plugin with its profile type
3. **PluginProfileLoader** in Launcher — filters plugins by active profile before loading
4. **ServiceOptions update** — `--profile server|client|auto` flag
5. **PlatformServiceManager update** — install with profile name in service name
6. **CLI service commands** — `dw service install --profile server|client`
7. **Plugin profile annotations** — annotate key AEDS plugins with correct profile

## Tasks

### Phase 1: SDK Profile Infrastructure

- [ ] **1.1: Create ServiceProfileType enum**
  - File: `DataWarehouse.SDK/Hosting/ServiceProfileType.cs`
  - Enum: `Server`, `Client`, `Both`, `None` (default = Both)
  - XML docs
  - **Done**: Enum created

- [ ] **1.2: Create PluginProfileAttribute**
  - File: `DataWarehouse.SDK/Hosting/PluginProfileAttribute.cs`
  - `[AttributeUsage(AttributeTargets.Class, Inherited = true)]`
  - `public ServiceProfileType Profile { get; }`
  - Constructor takes `ServiceProfileType`
  - Static helper: `GetProfile(Type pluginType)` returns profile or `Both` if no attribute
  - XML docs with usage examples
  - **Done**: Attribute created

### Phase 2: Launcher Profile Loading

- [ ] **2.1: Update ServiceOptions**
  - File: `DataWarehouse.Launcher/Program.cs`
  - Add `ServiceProfileType Profile` property (default: `Auto` — add Auto to enum if needed)
  - Parse `--profile server|client|auto` from command line
  - Parse from config: `"Profile": "server"` in appsettings.json
  - Parse from env: `DW_PROFILE=server`
  - Update help text
  - **Done**: Profile option added

- [ ] **2.2: Create PluginProfileLoader**
  - File: `DataWarehouse.Launcher/PluginProfileLoader.cs`
  - `FilterPluginsByProfile(IReadOnlyList<Type> discoveredPlugins, ServiceProfileType activeProfile) -> IReadOnlyList<Type>`
  - If profile is `Auto`: detect from available plugin types (has ServerDispatcher → server, has ClientCourier → client, has both → both)
  - If profile is `Server`: include plugins with `Server` or `Both` profile
  - If profile is `Client`: include plugins with `Client` or `Both` profile
  - Log which plugins were filtered out and why
  - **Done**: Profile loader created

- [ ] **2.3: Wire PluginProfileLoader into Launcher startup**
  - File: `DataWarehouse.Launcher/Program.cs` or `DataWarehouse.Launcher/Integration/DataWarehouseHost.cs`
  - After plugin discovery, before plugin loading, call `PluginProfileLoader.FilterPluginsByProfile`
  - Log active profile and plugin count
  - **Done**: Profile filtering wired into startup

### Phase 3: Plugin Annotations

- [ ] **3.1: Annotate AEDS server-side plugins**
  - `[PluginProfile(ServiceProfileType.Server)]` on:
    - `AedsCore.ServerDispatcherPlugin`
    - `AedsCore.GrpcControlPlanePlugin` (server listener)
    - `AedsCore.MqttControlPlanePlugin` (server listener)
    - `AedsCore.WebSocketControlPlanePlugin` (server listener)
  - **Done**: Server plugins annotated

- [ ] **3.2: Annotate AEDS client-side plugins**
  - `[PluginProfile(ServiceProfileType.Client)]` on:
    - `AedsCore.ClientCourierPlugin`
  - Data plane plugins are `Both` (both server and client need data transfer)
  - **Done**: Client plugins annotated

- [ ] **3.3: Annotate shared plugins as Both (selective)**
  - Most plugins default to `Both` (no annotation needed)
  - Annotate large server-only plugins explicitly:
    - `[PluginProfile(ServiceProfileType.Server)]` on heavy plugins that make no sense on client:
      - Storage plugins (UltimateStorage, UltimateRAID, etc.) → Server
      - Intelligence plugins → Server
      - Database plugins → Server
    - Leave lightweight plugins as Both (default)
  - **Done**: Key plugins annotated

### Phase 4: Service Management Integration

- [ ] **4.1: Update PlatformServiceManager**
  - File: `DataWarehouse.Shared/Services/PlatformServiceManager.cs`
  - Update `RegisterServiceAsync` to include profile in service name:
    - Windows: `DataWarehouse-Server` or `DataWarehouse-Client`
    - Linux: `datawarehouse-server.service` or `datawarehouse-client.service`
    - macOS: `com.datawarehouse.server` or `com.datawarehouse.client`
  - Update service description to include profile
  - **Done**: Profile-aware service registration

- [ ] **4.2: Update CLI service commands (if they exist)**
  - Check if CLI has service install/start/stop commands
  - If yes: add `--profile` flag
  - If no: add basic `dw service install --profile server|client` command
  - **Done**: CLI updated

### Phase 5: Configuration & Documentation

- [ ] **5.1: Add profile configuration to appsettings.json template**
  - Add example configuration showing profile selection
  - Add plugin whitelist/blacklist per profile (advanced override)
  - **Done**: Config template updated

- [ ] **5.2: Build verification**
  - Run: `dotnet build` on full solution
  - **Verify**: Zero errors
  - **Done**: Build clean

- [ ] **5.3: Update PLUGIN-CATALOG.md (DOC-21)**
  - Document profile-based loading architecture
  - Document ServiceProfileType enum
  - Document PluginProfileAttribute
  - Document server vs client profile plugin sets
  - Document PlatformServiceManager profile-aware registration
  - **Done**: PLUGIN-CATALOG updated

## Verification

1. **Build**: `dotnet build` — zero errors
2. **Profile enum**: ServiceProfileType has Server, Client, Both, Auto values
3. **Attribute**: PluginProfileAttribute works with reflection
4. **Loader**: PluginProfileLoader correctly filters by profile
5. **AEDS plugins**: Server/Client annotations present
6. **Service registration**: Profile name in service name

## Success Criteria

- [ ] ServiceProfileType enum in SDK
- [ ] PluginProfileAttribute in SDK with GetProfile helper
- [ ] PluginProfileLoader in Launcher with auto-detect
- [ ] ServiceOptions has --profile flag
- [ ] AEDS plugins annotated (ServerDispatcher=Server, ClientCourier=Client)
- [ ] PlatformServiceManager uses profile in service name
- [ ] Full solution builds with zero errors
- [ ] PLUGIN-CATALOG.md updated

## Output

**Artifacts**:
- `DataWarehouse.SDK/Hosting/ServiceProfileType.cs`
- `DataWarehouse.SDK/Hosting/PluginProfileAttribute.cs`
- `DataWarehouse.Launcher/PluginProfileLoader.cs`
- Updated `DataWarehouse.Launcher/Program.cs`
- Updated `DataWarehouse.Shared/Services/PlatformServiceManager.cs`
- Updated AEDS plugin files (annotations)
- Updated `.planning/PLUGIN-CATALOG.md`

**KS Resolution**: Service architecture — unified binary with profile-based daemon deployment
