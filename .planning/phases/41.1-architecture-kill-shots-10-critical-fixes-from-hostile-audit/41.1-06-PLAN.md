---
plan: "41.1-06"
title: "KS7: DVV Vector Clocks + KS8: Multi-Raft Consensus Consolidation"
wave: 2
depends_on: ["41.1-01"]
estimated_tokens: 65000
autonomous: true
status: pending
---

# Phase 41.1-06: KS7 (DVV Vector Clocks) + KS8 (Multi-Raft Consensus Consolidation)

## Overview
Wave 2 architectural hardening: replace naive VectorClock with membership-aware Dotted Version Vectors (DVV), and consolidate all consensus logic into a unified Multi-Raft plugin with proper base class hierarchy.

**Kill Shot 7 (DVV)**: Existing VectorClock lacks tombstone compaction and membership awareness. DVV uses cluster membership to prune dead node entries and support efficient causality tracking in dynamic clusters.

**Kill Shot 8 (Multi-Raft Consensus)**: Multiple Raft plugins (Raft, partial impl in UltimateReplication) create confusion. Consolidate into UltimateConsensus with Multi-Raft groups, consistent hashing, and proper base class separation (ConsensusPluginBase, ResiliencePluginBase).

## Dependencies
- **Depends on**: 41.1-01 (completed Wave 1: isolation fixes + DIM cleanup)
- **Blocked by**: none
- **Blocks**: 41.1-07 (Wave 3: stream processing + transient cache)

## Must-Haves (Non-Negotiable)
1. **DVV Implementation**: Full DVV with membership-based pruning, HappensBefore, Merge, IsConcurrent
2. **Membership Interface**: IClusterMembership.cs in SDK/Replication/ (NodeId list, add/remove callbacks)
3. **VectorClock Deprecation**: [Obsolete] on old VectorClock in IMultiMasterReplication.cs + ReplicationStrategy.cs
4. **ConsensusPluginBase**: Abstract base in SDK/Contracts/Hierarchy/ (ProposeAsync, IsLeaderAsync, GetStateAsync)
5. **ResiliencePluginBase**: Abstract base in SDK/Contracts/Hierarchy/ (ExecuteWithResilienceAsync<T>)
6. **UltimateConsensus Plugin**: Multi-Raft with ConcurrentDictionary<int, RaftGroup>, 3-5 voters per group, consistent hashing
7. **Raft Plugin Deprecation**: [Obsolete] on old Raft plugin
8. **Zero Placeholders**: All code production-ready, no TODOs/stubs/mocks
9. **Build Success**: Zero CS errors, zero warnings on affected projects
10. **Tests Pass**: All existing tests pass, new tests for DVV + Multi-Raft

## Scope
**In Scope**:
- DVV: IClusterMembership.cs, DottedVersionVector.cs (SDK/Replication/)
- DVV migration: CrdtReplicationSync, ReplicationStrategyBase, ConflictResolutionStrategies
- ConsensusPluginBase.cs, ResiliencePluginBase.cs (SDK/Contracts/Hierarchy/)
- UltimateConsensus plugin: Multi-Raft groups, leader election, log replication, snapshots
- UltimateResilience refactor: extend ResiliencePluginBase
- [Obsolete] markers: VectorClock, Raft plugin
- Solution integration: add UltimateConsensus project

**Out of Scope**:
- Cross-DC geo-replication optimizations (future)
- PBFT/ZAB full implementations (stubs OK for strategy interface)
- GUI/CLI changes (unless blocking)
- Performance tuning (functional correctness first)

## Tasks

### T1: DVV Foundation (SDK/Replication/)
**Owner**: executor (sonnet)
**Est**: 8,000 tokens

1. Create `DataWarehouse.SDK/Replication/IClusterMembership.cs`:
   ```csharp
   public interface IClusterMembership
   {
       IReadOnlySet<string> GetActiveNodes();
       void RegisterNodeAdded(Action<string> callback);
       void RegisterNodeRemoved(Action<string> callback);
   }
   ```

2. Create `DataWarehouse.SDK/Replication/DottedVersionVector.cs`:
   - Constructor: `DottedVersionVector(IClusterMembership membership)`
   - Fields: `ConcurrentDictionary<string, (long version, string dot)> _vector`, `IClusterMembership _membership`
   - Methods:
     - `Increment(string nodeId)`: bump version, update dot
     - `bool HappensBefore(DottedVersionVector other)`: check causality
     - `DottedVersionVector Merge(DottedVersionVector other)`: max(versions) per node
     - `bool IsConcurrent(DottedVersionVector other)`: neither happens-before
     - `ImmutableDictionary<string, (long, string)> ToImmutableDictionary()`
     - `static FromDictionary(ImmutableDictionary<...>, IClusterMembership)`
     - `void PruneDeadNodes()`: remove entries not in `_membership.GetActiveNodes()`
   - Wire membership callbacks to auto-prune on node removal

3. Add XML docs: causality semantics, pruning behavior, thread-safety

**Verification**:
- `lsp_diagnostics` clean on SDK/Replication/
- Unit tests: DVV causality (happens-before, merge, concurrent), pruning on membership change

---

### T2: VectorClock Deprecation
**Owner**: executor (sonnet)
**Est**: 4,000 tokens

1. Mark `VectorClock` class as `[Obsolete("Use DottedVersionVector for membership-aware causality tracking. Remove in v4.0.", false)]` in:
   - `DataWarehouse.SDK/Replication/IMultiMasterReplication.cs` (if defined there)
   - `DataWarehouse.SDK/Replication/Strategies/ReplicationStrategy.cs` (if used)

2. Update `CrdtReplicationSync` (if exists in SDK or UltimateReplication):
   - Replace `VectorClock` field with `DottedVersionVector`
   - Inject `IClusterMembership` in constructor
   - Update Sync logic to use DVV.Merge + PruneDeadNodes after sync

3. Update `ReplicationStrategyBase` and `ConflictResolutionStrategies`:
   - Replace `VectorClock` parameters with `DottedVersionVector`
   - Use `HappensBefore` for LWW/causality checks

**Verification**:
- `lsp_diagnostics` clean on SDK/Replication/, Plugins/UltimateReplication/
- Grep for remaining `VectorClock` usages (should only be [Obsolete] declarations)
- Build passes with warnings (deprecation warnings expected)

---

### T3: ConsensusPluginBase + ResiliencePluginBase (SDK/Contracts/Hierarchy/)
**Owner**: executor (sonnet)
**Est**: 10,000 tokens

1. Create `DataWarehouse.SDK/Contracts/Hierarchy/ConsensusPluginBase.cs`:
   ```csharp
   public abstract class ConsensusPluginBase : InfrastructurePluginBase
   {
       // Records
       public record ConsensusResult(bool Success, string? LeaderId, long LogIndex, string? Error);
       public record ConsensusState(string State, string? LeaderId, long CommitIndex, long LastApplied);
       public record ClusterHealthInfo(int TotalNodes, int HealthyNodes, Dictionary<string, string> NodeStates);

       // Abstract
       public abstract Task<ConsensusResult> ProposeAsync(byte[] data, CancellationToken ct);
       public abstract Task<bool> IsLeaderAsync(CancellationToken ct);
       public abstract Task<ConsensusState> GetStateAsync(CancellationToken ct);

       // Virtual
       public virtual Task<ClusterHealthInfo> GetClusterHealthAsync(CancellationToken ct)
       {
           return Task.FromResult(new ClusterHealthInfo(0, 0, new()));
       }
   }
   ```

2. Create `DataWarehouse.SDK/Contracts/Hierarchy/ResiliencePluginBase.cs`:
   ```csharp
   public abstract class ResiliencePluginBase : InfrastructurePluginBase
   {
       public record ResilienceHealthInfo(int TotalPolicies, int ActiveCircuitBreakers, Dictionary<string, string> PolicyStates);

       // Abstract
       public abstract Task<T> ExecuteWithResilienceAsync<T>(
           Func<CancellationToken, Task<T>> action,
           string policyName,
           CancellationToken ct);

       // Virtual
       public virtual Task<ResilienceHealthInfo> GetResilienceHealthAsync(CancellationToken ct)
       {
           return Task.FromResult(new ResilienceHealthInfo(0, 0, new()));
       }
   }
   ```

3. Add XML docs: consensus semantics, leader election, resilience patterns

**Verification**:
- `lsp_diagnostics` clean on SDK/Contracts/Hierarchy/
- Ensure both extend `InfrastructurePluginBase` (defined in SDK/Contracts/Hierarchy/)

---

### T4: UltimateConsensus Plugin (Multi-Raft)
**Owner**: executor (opus)
**Est**: 25,000 tokens

1. Create `Plugins/DataWarehouse.Plugins.UltimateConsensus/` project:
   - Copy .csproj template from UltimateReplication
   - Reference ONLY SDK via `<ProjectReference Include="..\..\DataWarehouse.SDK\DataWarehouse.SDK.csproj" />`
   - Add NuGet: `DotNext.Threading` (for Raft), `System.Collections.Immutable`

2. Create `UltimateConsensusPlugin.cs`:
   - Extends `ConsensusPluginBase`
   - Fields:
     - `ConcurrentDictionary<int, RaftGroup> _raftGroups`
     - `ConsistentHash<int> _groupHash` (maps keys to group IDs)
     - `IMessageBus _messageBus`
     - `ILogger _logger`
   - Constructor: inject `IMessageBus`, `ILogger`, `IConfiguration`
   - `InitializeAsync`: create 3 Raft groups (configurable), 3-5 voters each, start leader election

3. Create `RaftGroup.cs`:
   - Fields: `int GroupId`, `List<string> VoterIds`, `string? CurrentLeader`, `ConcurrentQueue<LogEntry> Log`, `long CommitIndex`, `long LastApplied`
   - `Task<bool> ElectLeaderAsync()`: simple majority vote (heartbeat timeout → election)
   - `Task<bool> AppendEntryAsync(LogEntry entry)`: replicate to majority
   - `Task ApplyCommittedEntriesAsync()`: apply log[lastApplied+1..commitIndex] to state machine
   - `Task<byte[]> TakeSnapshotAsync()`: serialize committed state
   - `Task RestoreSnapshotAsync(byte[] snapshot)`: deserialize

4. Create `LogEntry.cs` record: `(long Term, long Index, byte[] Data, DateTime Timestamp)`

5. Create `ConsistentHash.cs` (simple jump hash):
   - `int GetBucket(string key, int numBuckets)`: hash(key) % numBuckets
   - `void AddNode(int nodeId)`, `void RemoveNode(int nodeId)`

6. Implement `ProposeAsync`:
   - Route key (hash of data) to Raft group via `_groupHash`
   - Call `group.AppendEntryAsync(new LogEntry(...))`
   - Return `ConsensusResult(success, group.CurrentLeader, logIndex, error)`

7. Implement `IsLeaderAsync`:
   - Check if current node is leader in ANY group
   - Return `true` if leader in ≥1 group

8. Implement `GetStateAsync`:
   - Aggregate state from all groups
   - Return `ConsensusState(state: "multi-raft", leaderId, commitIndex, lastApplied)`

9. Implement `GetClusterHealthAsync`:
   - Collect health from all groups
   - Return `ClusterHealthInfo(totalNodes, healthyNodes, nodeStates)`

10. Add strategies (stubs for now, functional Raft only):
    - `IRaftStrategy`: `Task<ConsensusResult> ProposeAsync(...)`
    - Implementations: `RaftStrategy` (full), `PaxosStrategy` (stub), `PbftStrategy` (stub), `ZabStrategy` (stub)
    - Factory: `CreateStrategy(string strategyName)` in plugin

11. Add to solution: `dotnet sln add Plugins/DataWarehouse.Plugins.UltimateConsensus/DataWarehouse.Plugins.UltimateConsensus.csproj`

**Verification**:
- `lsp_diagnostics` clean on UltimateConsensus/
- Build passes: `dotnet build Plugins/DataWarehouse.Plugins.UltimateConsensus/`
- Unit tests: leader election, log replication, snapshot/restore
- Integration test: propose 100 entries, verify commit across groups

---

### T5: UltimateResilience Refactor
**Owner**: executor (sonnet)
**Est**: 6,000 tokens

1. Update `Plugins/DataWarehouse.Plugins.UltimateResilience/UltimateResiliencePlugin.cs`:
   - Change base class from `InfrastructurePluginBase` to `ResiliencePluginBase`
   - Implement abstract `ExecuteWithResilienceAsync<T>`:
     - Use Polly to apply retry/circuit-breaker/timeout policies
     - Return result from action
   - Implement `GetResilienceHealthAsync`:
     - Return stats from Polly circuit breakers (open/closed/half-open counts)

2. Ensure existing functionality preserved:
   - Policy registry (retry, circuit breaker, timeout, bulkhead, fallback)
   - Message bus integration for resilience events

**Verification**:
- `lsp_diagnostics` clean on UltimateResilience/
- Build passes: `dotnet build Plugins/DataWarehouse.Plugins.UltimateResilience/`
- Existing tests pass (resilience policies still work)

---

### T6: Raft Plugin Deprecation
**Owner**: executor (haiku)
**Est**: 2,000 tokens

1. Mark `Plugins/DataWarehouse.Plugins.Raft/RaftPlugin.cs` as `[Obsolete("Replaced by UltimateConsensus with Multi-Raft. Remove in v4.0.", false)]`

2. Update PLUGIN-CATALOG.md:
   - Move Raft to "Deprecated Plugins" section
   - Add UltimateConsensus to "Infrastructure" section with Multi-Raft description

**Verification**:
- Grep for Raft plugin references (should only be [Obsolete] + PLUGIN-CATALOG)
- Build passes with deprecation warnings

---

### T7: Integration Testing
**Owner**: test-engineer (sonnet)
**Est**: 8,000 tokens

1. Create `DataWarehouse.Tests/Replication/DvvTests.cs`:
   - Test cases:
     - `Increment_UpdatesVersionAndDot`
     - `HappensBefore_DetectsCausality`
     - `Merge_TakesMaxVersions`
     - `IsConcurrent_DetectsConflicts`
     - `PruneDeadNodes_RemovesInactiveEntries`
     - `MembershipCallback_TriggersAutoPrune`

2. Create `DataWarehouse.Tests/Consensus/UltimateConsensusTests.cs`:
   - Test cases:
     - `InitializeAsync_CreatesRaftGroups`
     - `ProposeAsync_RoutesToCorrectGroup`
     - `LeaderElection_ConvergesWithinTimeout`
     - `LogReplication_ReachesQuorum`
     - `Snapshot_CapturesCommittedState`
     - `GetClusterHealthAsync_ReturnsAggregateHealth`

3. Run full test suite:
   ```bash
   dotnet test DataWarehouse.Tests/ --filter "FullyQualifiedName~Dvv|FullyQualifiedName~UltimateConsensus"
   ```

**Verification**:
- All new tests pass (DVV + UltimateConsensus)
- Zero test failures in full suite
- Coverage ≥80% on new code (DVV, ConsensusPluginBase, ResiliencePluginBase, UltimateConsensus)

---

### T8: Build + Diagnostics Verification
**Owner**: build-fixer (sonnet)
**Est**: 4,000 tokens

1. Run full solution build:
   ```bash
   dotnet build DataWarehouse.sln
   ```

2. Check diagnostics on changed files:
   - `lsp_diagnostics` on SDK/Replication/, SDK/Contracts/Hierarchy/
   - `lsp_diagnostics` on Plugins/UltimateConsensus/, Plugins/UltimateResilience/

3. Fix any CS errors (expected: none)

4. Document deprecation warnings:
   - VectorClock usage warnings (expected in migration code)
   - Raft plugin warnings (expected in old plugin references)

**Verification**:
- Zero CS errors
- Deprecation warnings documented in `.planning/phases/41.1-.../41.1-06-VERIFICATION.md`
- Build output saved to `.planning/phases/41.1-.../41.1-06-build.log`

---

### T9: Update Living Documentation (DOC-21)
**Owner**: executor (haiku)
**Est**: 3,000 tokens

1. Update `.planning/PLUGIN-CATALOG.md` to reflect ALL changes:
   - **Add UltimateConsensus plugin entry**: Multi-Raft architecture, 3+ Raft groups, consistent hashing for group routing, leader election, log replication, snapshot/restore, cluster health
   - **Mark Raft plugin as deprecated/absorbed**: move to deprecated section, note "replaced by UltimateConsensus Multi-Raft"
   - **Add ConsensusPluginBase to hierarchy**: document abstract methods (ProposeAsync, IsLeaderAsync, GetStateAsync), virtual GetClusterHealthAsync, ConsensusResult/ConsensusState/ClusterHealthInfo records
   - **Add ResiliencePluginBase to hierarchy**: document abstract ExecuteWithResilienceAsync<T>, virtual GetResilienceHealthAsync, ResilienceHealthInfo record
   - **Update UltimateResilience entry**: note refactor to extend ResiliencePluginBase (was InfrastructurePluginBase)
   - **Add DVV (DottedVersionVector) section**: document IClusterMembership interface, DVV methods (Increment, HappensBefore, Merge, IsConcurrent, PruneDeadNodes), membership-aware pruning
   - **Deprecate VectorClock**: mark as [Obsolete], note migration to DVV in CrdtReplicationSync and all replication strategies
   - **Update hierarchy diagram**: add ConsensusPluginBase and ResiliencePluginBase under InfrastructurePluginBase, show UltimateConsensus and UltimateResilience as leaf plugins

2. Ensure all flow diagrams, message bus topics, and architectural notes are updated

**Verification**:
- PLUGIN-CATALOG.md contains UltimateConsensus entry with Multi-Raft details
- Raft plugin marked deprecated
- ConsensusPluginBase and ResiliencePluginBase documented in hierarchy
- DVV section added to replication documentation
- VectorClock marked deprecated
- Hierarchy diagram updated

---

## Verification Checklist
- [ ] DVV: IClusterMembership.cs exists in SDK/Replication/
- [ ] DVV: DottedVersionVector.cs with all methods (Increment, HappensBefore, Merge, IsConcurrent, PruneDeadNodes)
- [ ] DVV: Membership callbacks wired, auto-prune on node removal
- [ ] VectorClock: [Obsolete] markers added, migration complete in CrdtReplicationSync + strategies
- [ ] ConsensusPluginBase: exists in SDK/Contracts/Hierarchy/, extends InfrastructurePluginBase
- [ ] ResiliencePluginBase: exists in SDK/Contracts/Hierarchy/, extends InfrastructurePluginBase
- [ ] UltimateConsensus: plugin project created, added to solution
- [ ] UltimateConsensus: Multi-Raft with ConcurrentDictionary<int, RaftGroup>
- [ ] UltimateConsensus: Leader election, log replication, snapshots functional
- [ ] UltimateConsensus: Consistent hashing for group routing
- [ ] UltimateResilience: refactored to extend ResiliencePluginBase
- [ ] Raft plugin: [Obsolete] marker added
- [ ] PLUGIN-CATALOG.md: updated (Raft deprecated, UltimateConsensus added)
- [ ] Tests: DVV tests pass (causality, merge, pruning)
- [ ] Tests: UltimateConsensus tests pass (leader election, replication, snapshot)
- [ ] Tests: UltimateResilience tests pass (existing functionality preserved)
- [ ] Build: `dotnet build DataWarehouse.sln` succeeds with zero errors
- [ ] Diagnostics: `lsp_diagnostics` clean on all changed files
- [ ] No placeholders: all code production-ready, zero TODOs/stubs (except strategy stubs for Paxos/PBFT/ZAB)
- [ ] DOC-21: PLUGIN-CATALOG.md updated with UltimateConsensus, ConsensusPluginBase, ResiliencePluginBase, DVV, deprecated VectorClock and Raft

## Success Criteria
1. **DVV Operational**: DottedVersionVector used in all replication code, membership-aware pruning functional
2. **VectorClock Deprecated**: [Obsolete] markers in place, migration complete, zero non-deprecated usages
3. **Consensus Hierarchy**: ConsensusPluginBase + ResiliencePluginBase in SDK, proper separation of concerns
4. **Multi-Raft Functional**: UltimateConsensus plugin operational with 3+ Raft groups, leader election, log replication
5. **Raft Plugin Deprecated**: [Obsolete] marker, PLUGIN-CATALOG updated
6. **Zero Build Errors**: Full solution builds successfully
7. **Tests Pass**: All new tests (DVV + UltimateConsensus + UltimateResilience) pass
8. **No Regressions**: Existing tests still pass

## Output Artifacts
1. **SDK Files**:
   - `DataWarehouse.SDK/Replication/IClusterMembership.cs`
   - `DataWarehouse.SDK/Replication/DottedVersionVector.cs`
   - `DataWarehouse.SDK/Contracts/Hierarchy/ConsensusPluginBase.cs`
   - `DataWarehouse.SDK/Contracts/Hierarchy/ResiliencePluginBase.cs`

2. **Plugin Files**:
   - `Plugins/DataWarehouse.Plugins.UltimateConsensus/` (full project)
   - `Plugins/DataWarehouse.Plugins.UltimateConsensus/UltimateConsensusPlugin.cs`
   - `Plugins/DataWarehouse.Plugins.UltimateConsensus/RaftGroup.cs`
   - `Plugins/DataWarehouse.Plugins.UltimateConsensus/LogEntry.cs`
   - `Plugins/DataWarehouse.Plugins.UltimateConsensus/ConsistentHash.cs`
   - `Plugins/DataWarehouse.Plugins.UltimateResilience/UltimateResiliencePlugin.cs` (refactored)

3. **Test Files**:
   - `DataWarehouse.Tests/Replication/DvvTests.cs`
   - `DataWarehouse.Tests/Consensus/UltimateConsensusTests.cs`

4. **Documentation**:
   - `.planning/PLUGIN-CATALOG.md` (updated)
   - `.planning/phases/41.1-.../41.1-06-VERIFICATION.md` (verification results)
   - `.planning/phases/41.1-.../41.1-06-build.log` (build output)

5. **Deprecation Markers**:
   - VectorClock: [Obsolete] in SDK/Replication/
   - Raft plugin: [Obsolete] in Plugins/DataWarehouse.Plugins.Raft/

## Risk Assessment
**Low Risk**:
- DVV is isolated to replication layer (limited blast radius)
- ConsensusPluginBase/ResiliencePluginBase are new abstractions (no existing dependencies)
- UltimateConsensus is new plugin (can be disabled if issues arise)

**Medium Risk**:
- VectorClock migration: ensure all usages identified (grep + LSP references)
- Multi-Raft complexity: leader election race conditions, log consistency

**Mitigations**:
- Comprehensive testing (DVV causality, Raft leader election, log replication)
- [Obsolete] warnings (not errors) for VectorClock/Raft (gradual migration)
- Integration tests with realistic scenarios (100+ proposals, node failures)
- Rollback plan: revert [Obsolete] markers, disable UltimateConsensus plugin

## Notes
- **Wave 2 Focus**: Causality + consensus foundations (DVV + Multi-Raft)
- **Strategy Stubs**: Paxos/PBFT/ZAB stubs acceptable (interface compliance, not full impl)
- **Performance**: Functional correctness first, optimization in future phase
- **Cross-DC**: Out of scope (local cluster Multi-Raft only)
- **PLUGIN-CATALOG**: Must consult for UltimateConsensus flow diagrams, message bus topics
