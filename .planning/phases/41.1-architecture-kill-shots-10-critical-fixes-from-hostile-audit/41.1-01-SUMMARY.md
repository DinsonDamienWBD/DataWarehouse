---
phase: 41.1-architecture-kill-shots
plan: 01
subsystem: kernel, sdk-pipeline
tags: [kill-shot, async, di-wiring, sync-over-async, IAsyncDisposable]
dependency_graph:
  requires: []
  provides:
    - "InjectKernelServices call in RegisterPluginAsync"
    - "Async-only SDK pipeline (no sync-over-async in hot paths)"
    - "IAsyncDisposable on HsmProvider, MdnsServiceDiscovery, ZeroConfigClusterBootstrap"
    - "Async alternatives for IPlatformCapabilityRegistry"
    - "ReplicaFallbackChain.BuildAsync"
  affects:
    - "All plugins (now receive kernel services after handshake)"
    - "TransitEncryptionPluginBases (async pipeline bridge)"
    - "StorageConnectionRegistry (async dispose)"
tech_stack:
  added: []
  patterns:
    - "IAsyncDisposable pattern for classes with async cleanup"
    - "[Obsolete] on sync wrappers with async alternatives"
    - "Async alternatives on sync interface methods"
key_files:
  created: []
  modified:
    - DataWarehouse.Kernel/DataWarehouseKernel.cs
    - DataWarehouse.SDK/Contracts/PluginBase.cs
    - DataWarehouse.SDK/Contracts/TransitEncryptionPluginBases.cs
    - DataWarehouse.SDK/Hardware/PlatformCapabilityRegistry.cs
    - DataWarehouse.SDK/Hardware/IPlatformCapabilityRegistry.cs
    - DataWarehouse.SDK/Hardware/Accelerators/HsmProvider.cs
    - DataWarehouse.SDK/Infrastructure/StorageConnectionRegistry.cs
    - DataWarehouse.SDK/Infrastructure/Distributed/Discovery/MdnsServiceDiscovery.cs
    - DataWarehouse.SDK/Infrastructure/Distributed/Discovery/ZeroConfigClusterBootstrap.cs
    - DataWarehouse.SDK/Federation/Replication/ReplicaFallbackChain.cs
    - DataWarehouse.SDK/Federation/Replication/LocationAwareReplicaSelector.cs
    - DataWarehouse.SDK/Security/IKeyStore.cs
    - Plugins/DataWarehouse.Plugins.UltimateIntelligence/UltimateIntelligencePlugin.cs
    - .planning/PLUGIN-CATALOG.md
decisions:
  - "Sync OnWrite/OnRead marked [Obsolete] rather than deleted (backward compat with override hierarchy)"
  - "TransitEncryptionPluginBases converted to override OnWriteAsync/OnReadAsync (no more sync bridge)"
  - "PlatformCapabilityRegistry sync methods preserved (interface contract), async alternatives added"
  - "HsmProvider sync Dispose uses fire-and-forget ContinueWith (not .GetAwaiter().GetResult())"
  - "ReplicaFallbackChain sync Build marked [Obsolete], async BuildAsync added, caller updated"
  - "IKeyStore.GetKey marked [Obsolete] (interface backward compat, not deleted)"
metrics:
  duration: ~15 min
  completed: 2026-02-17
  tasks: 3
  files: 14
---

# Phase 41.1 Plan 01: Kernel DI Wiring + Async Pipeline Fix Summary

**One-liner:** InjectKernelServices call added to kernel plugin registration, all sync-over-async wrappers removed from SDK pipeline hot paths with IAsyncDisposable patterns and async alternatives.

## Tasks Completed

### Task 1: Fix Kernel DI Wiring (KS2)
- Added `pluginBase.InjectKernelServices(_messageBus, null, null)` in `RegisterPluginAsync` after handshake success, before registry registration
- Both kernel registration paths (direct and KernelBuilder) covered since KernelBuilder delegates to RegisterPluginAsync
- Commit: `30ebc52`

### Task 2: Delete Sync-Over-Async Wrappers (KS1)
- **PluginBase.cs:** Marked `OnWrite`/`OnRead` `[Obsolete]`, converted `CleanupExpiredAsync` to true async
- **TransitEncryptionPluginBases.cs:** Converted from `OnWrite`/`OnRead` sync overrides to `OnWriteAsync`/`OnReadAsync` async overrides with `CopyToAsync`
- **PlatformCapabilityRegistry.cs:** Added 5 async alternatives (`HasCapabilityAsync`, `GetDevicesAsync`, `GetAllDevicesAsync`, `GetCapabilitiesAsync`, `GetDeviceCountAsync`)
- **IPlatformCapabilityRegistry.cs:** Extended interface with async method signatures
- **HsmProvider.cs:** Implemented `IAsyncDisposable`, sync `Dispose` uses fire-and-forget
- **StorageConnectionRegistry.cs:** Added `DisposeConnectionAsync`, updated `DisposeAsync` to use it
- **MdnsServiceDiscovery.cs:** Implemented `IAsyncDisposable`
- **ZeroConfigClusterBootstrap.cs:** Implemented `IAsyncDisposable`
- **ReplicaFallbackChain.cs:** Added `BuildAsync`, marked sync `Build` `[Obsolete]`, updated `LocationAwareReplicaSelector` caller
- **IKeyStore.cs:** Marked `GetKey` `[Obsolete("Use GetKeyAsync")]`
- **UltimateIntelligencePlugin.cs:** Added `[Obsolete]` on sync OnWrite/OnRead overrides (CS0672 compliance)
- Commit: `f452e27`

### Task 3: Update Living Documentation (DOC-21)
- Updated PLUGIN-CATALOG.md plugin startup sequence with step 2b (InjectKernelServices)
- Documented KS1 and KS2 as COMPLETE with details of all changes
- Updated IAsyncDisposable, async alternatives, and [Obsolete] documentation
- Commit: `4c3d782`

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] HsmProvider.Dispose used .AsTask() on Task (not ValueTask)**
- **Found during:** Task 2
- **Issue:** `DisconnectAsync()` returns `Task`, not `ValueTask`, so `.AsTask()` was invalid (CS1061)
- **Fix:** Used `.ContinueWith()` directly on the Task
- **Files modified:** `DataWarehouse.SDK/Hardware/Accelerators/HsmProvider.cs`
- **Commit:** `f452e27`

**2. [Rule 1 - Bug] CS0672: Override of obsolete member requires [Obsolete] attribute**
- **Found during:** Task 2
- **Issue:** `UltimateIntelligencePlugin.OnWrite/OnRead` override the now-[Obsolete] base methods, causing CS0672 errors with TreatWarningsAsErrors
- **Fix:** Added `[Obsolete]` attribute to the plugin overrides
- **Files modified:** `Plugins/DataWarehouse.Plugins.UltimateIntelligence/UltimateIntelligencePlugin.cs`
- **Commit:** `f452e27`

## Verification Results

| Check | Result |
|-------|--------|
| `dotnet build DataWarehouse.slnx --no-restore -v q` | 0 errors, 0 warnings |
| InjectKernelServices in DataWarehouse.Kernel/ | Present in RegisterPluginAsync |
| `.GetAwaiter().GetResult()` in SDK | Only in [Obsolete] methods and sync Dispose paths |
| `.Result;` in SDK | Only in [Obsolete] ReplicaFallbackChain.Build |

## Self-Check: PASSED

- All 14 modified files exist on disk
- All 3 task commits verified (30ebc52, f452e27, 4c3d782)
- Build: 0 errors, 0 warnings
