---
phase: 56-data-consciousness
plan: 03
type: execute
wave: 2
depends_on: ["56-01"]
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Strategies/IntelligentGovernance/LiabilityScoringStrategies.cs
autonomous: true

must_haves:
  truths:
    - "Liability scoring engine produces LiabilityScore (0-100) based on PII/PHI/PCI detection, classification level, retention obligations, regulatory exposure"
    - "Each liability dimension has a dedicated strategy with production-ready detection logic"
    - "Composite liability scorer aggregates all dimension strategies with configurable weights"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Strategies/IntelligentGovernance/LiabilityScoringStrategies.cs"
      provides: "PIILiabilityStrategy, PHILiabilityStrategy, PCILiabilityStrategy, ClassificationLiabilityStrategy, RetentionLiabilityStrategy, RegulatoryExposureLiabilityStrategy, BreachRiskLiabilityStrategy, CompositeLiabilityScoringStrategy"
      min_lines: 350
  key_links:
    - from: "LiabilityScoringStrategies.cs"
      to: "DataWarehouse.SDK.Contracts.Consciousness"
      via: "using directive + implements ILiabilityScorer"
      pattern: "ILiabilityScorer"
    - from: "CompositeLiabilityScoringStrategy"
      to: "ConsciousnessStrategyBase"
      via: "inherits ConsciousnessStrategyBase"
      pattern: "class CompositeLiabilityScoringStrategy : ConsciousnessStrategyBase"
---

<objective>
Implement the liability scoring engine with 7 dimension strategies that assess the risk and regulatory exposure of a data object.

Purpose: Liability is the other half of consciousness. High-liability data (PII, PHI, PCI, regulated content) demands special handling â€” retention holds, encryption, access controls, or outright purging. This engine quantifies that exposure so the consciousness score can recommend appropriate lifecycle actions.

Output: Single strategy file with 8 strategy classes (7 dimensions + 1 composite aggregator) in UltimateDataGovernance plugin.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/PLUGIN-CATALOG.md
@.planning/phases/56-data-consciousness/56-01-SUMMARY.md
@DataWarehouse.SDK/Contracts/Consciousness/ConsciousnessScore.cs
@DataWarehouse.SDK/Contracts/Consciousness/IConsciousnessScorer.cs
@DataWarehouse.SDK/Contracts/Consciousness/ConsciousnessStrategyBase.cs
@Plugins/DataWarehouse.Plugins.UltimateDataGovernance/DataGovernanceStrategyBase.cs
@Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Strategies/DataClassification/DataClassificationStrategies.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Liability dimension scoring strategies</name>
  <files>Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Strategies/IntelligentGovernance/LiabilityScoringStrategies.cs</files>
  <action>
Create `LiabilityScoringStrategies.cs` in namespace `DataWarehouse.Plugins.UltimateDataGovernance.Strategies.IntelligentGovernance`.

Each strategy extends ConsciousnessStrategyBase with Category = ConsciousnessCategory.LiabilityScoring.

**Strategy 1: PIILiabilityStrategy**
- StrategyId: "liability-pii"
- Scans metadata keys: "detected_pii_types" (string[]), "pii_confidence" (double 0-1), "pii_field_count" (int)
- Also scans data bytes for common PII patterns using regex: email (RFC 5322 simplified), SSN (XXX-XX-XXXX), phone (international formats), credit card (Luhn-validatable 13-19 digit sequences), passport numbers
- Score: 0 if no PII detected. Each PII type adds: email=15, SSN=40, phone=10, credit_card=50, passport=30, name=5, address=10, DOB=20. Capped at 100.
- Populates DetectedPIITypes on LiabilityScore

**Strategy 2: PHILiabilityStrategy**
- StrategyId: "liability-phi"
- Scans metadata: "detected_phi_types" (string[]), "hipaa_relevant" (bool)
- Scans data for medical patterns: ICD codes (letter + 2-7 chars with dot), medication names (common drug suffixes: -mab, -nib, -ide, -ine, -ol, -pril, -sartan, -statin), diagnosis keywords, patient ID patterns
- Score: hipaa_relevant=automatic 80 minimum. Each PHI type: diagnosis=30, medication=25, lab_result=20, procedure=25, patient_id=40. Capped at 100.

**Strategy 3: PCILiabilityStrategy**
- StrategyId: "liability-pci"
- Scans metadata: "pci_scope" (bool), "card_data_present" (bool), "tokenized" (bool)
- Scans data: credit card numbers (Luhn check), CVV patterns (3-4 digits near card numbers), expiry dates (MM/YY pattern)
- Tokenized data reduces score by 60% (tokenization significantly reduces PCI liability)
- Score: card number=60, CVV=80 (CVV storage is PCI violation), expiry=30, cardholder_name=20. If tokenized, multiply total by 0.4.

**Strategy 4: ClassificationLiabilityStrategy**
- StrategyId: "liability-classification"
- Reads metadata: "classification_level" (string: "public"/"internal"/"confidential"/"restricted"/"top_secret")
- Score: public=0, internal=20, confidential=50, restricted=80, top_secret=100, unclassified=40 (unclassified data is a liability because it SHOULD be classified)

**Strategy 5: RetentionLiabilityStrategy**
- StrategyId: "liability-retention"
- Reads metadata: "retention_policy" (string), "retention_end_date" (DateTime), "legal_hold" (bool), "disposal_overdue" (bool)
- Legal hold = 90 (high liability, cannot dispose). Disposal overdue = 85 (keeping data past retention = compliance violation). Active retention = 50. No retention policy = 60 (policy absence is itself a risk). Expired retention + no hold = 30.

**Strategy 6: RegulatoryExposureLiabilityStrategy**
- StrategyId: "liability-regulatory"
- Reads metadata: "applicable_regulations" (string[]), "data_subject_jurisdictions" (string[]), "cross_border" (bool)
- Each regulation adds: GDPR=25, CCPA=20, HIPAA=30, SOX=25, PCI_DSS=30, LGPD=20, PIPL=20, PDPA=15. Cross-border multiplier: 1.3x. Capped at 100.
- Populates ApplicableRegulations on LiabilityScore

**Strategy 7: BreachRiskLiabilityStrategy**
- StrategyId: "liability-breach-risk"
- Reads metadata: "encryption_status" (string: "encrypted"/"unencrypted"/"partial"), "access_control_level" (string: "public"/"restricted"/"private"), "sharing_scope" (string: "internal"/"external"/"public"), "last_security_scan" (DateTime)
- Unencrypted sensitive data = 80. Public access = 70. External sharing = 60. No security scan in 90 days = +20. Encrypted + private + internal = 10.

**Strategy 8: CompositeLiabilityScoringStrategy**
- StrategyId: "liability-composite"
- Implements ILiabilityScorer + extends ConsciousnessStrategyBase
- Aggregates all 7 dimension strategies with ConsciousnessScoringConfig.LiabilityWeights
- Default weights: PIIPresence=0.20, PHIPresence=0.15, PCIPresence=0.15, ClassificationLevel=0.10, RetentionObligation=0.15, RegulatoryExposure=0.15, BreachRisk=0.10
- Merges DetectedPIITypes and ApplicableRegulations from dimension strategies
- Production-ready: actual regex scanning of data bytes (convert to UTF8 string for text scanning), real Luhn validation for credit cards

Important: For data byte scanning, convert to string using Encoding.UTF8.GetString with a size cap (scan first 1MB max to avoid OOM on large objects). Use compiled Regex instances (static readonly) for performance.
  </action>
  <verify>Build the governance plugin: `dotnet build Plugins/DataWarehouse.Plugins.UltimateDataGovernance/DataWarehouse.Plugins.UltimateDataGovernance.csproj --no-restore`. Zero errors.</verify>
  <done>8 liability scoring strategies compile, CompositeLiabilityScoringStrategy implements ILiabilityScorer, PII/PHI/PCI strategies use real regex scanning with Luhn validation, no stubs or placeholders.</done>
</task>

</tasks>

<verification>
- Governance plugin builds with zero errors
- All 8 strategies registered via ConsciousnessStrategyRegistry.AutoDiscover
- CompositeLiabilityScoringStrategy.ScoreLiabilityAsync returns LiabilityScore with all 7 dimension breakdowns
- Regex patterns are compiled (static readonly Regex with RegexOptions.Compiled)
- Data scanning capped at 1MB to prevent OOM
- No `Task.Delay`, no `return new byte[0]`, no `// TODO`
</verification>

<success_criteria>
Liability scoring engine produces LiabilityScore (0-100) for any data object. PII/PHI/PCI strategies perform real regex scanning of data content. Classification, retention, regulatory, and breach risk strategies use metadata. All dimensions aggregate via configurable weights.
</success_criteria>

<output>
After completion, create `.planning/phases/56-data-consciousness/56-03-SUMMARY.md`
</output>
