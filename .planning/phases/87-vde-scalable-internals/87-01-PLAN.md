---
phase: 87-vde-scalable-internals
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.SDK/VirtualDiskEngine/Allocation/AllocationGroup.cs
  - DataWarehouse.SDK/VirtualDiskEngine/Allocation/AllocationGroupDescriptorTable.cs
  - DataWarehouse.SDK/VirtualDiskEngine/Allocation/AllocationPolicy.cs
autonomous: true

must_haves:
  truths:
    - "VDE data region can be divided into configurable allocation groups (default 128MB)"
    - "Each allocation group has its own bitmap, free-space count, and per-group lock"
    - "Allocations are group-local for zero cross-group contention"
    - "Allocation group descriptor table is stored in a dedicated VDE region"
    - "Per-group allocation policy supports first-fit and best-fit strategies"
  artifacts:
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Allocation/AllocationGroup.cs"
      provides: "Single allocation group with bitmap, free count, lock, and local allocation"
      contains: "class AllocationGroup"
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Allocation/AllocationGroupDescriptorTable.cs"
      provides: "Region-backed table of all allocation group descriptors with serialize/deserialize"
      contains: "class AllocationGroupDescriptorTable"
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Allocation/AllocationPolicy.cs"
      provides: "Enum and strategy for first-fit vs best-fit allocation per group"
      contains: "enum AllocationPolicy"
  key_links:
    - from: "AllocationGroup.cs"
      to: "IBlockAllocator"
      via: "implements group-local allocation using IBlockAllocator contract"
      pattern: "IBlockAllocator"
    - from: "AllocationGroupDescriptorTable.cs"
      to: "BlockTypeTags"
      via: "uses BMAP tag for serialization"
      pattern: "BlockTypeTags\\.BMAP"
---

<objective>
Implement allocation groups (VOPT-01) and the allocation group descriptor table (VOPT-02) for the VDE scalable internals. Allocation groups partition the VDE data region into independently-managed segments with per-group bitmaps and locks, eliminating cross-group contention during parallel writes.

Purpose: Foundation for all block allocation in Phase 87 -- sub-block packing, defragmentation, and tag bloom filters all operate within allocation groups.
Output: Three files in `DataWarehouse.SDK/VirtualDiskEngine/Allocation/`.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@DataWarehouse.SDK/VirtualDiskEngine/BlockAllocation/IBlockAllocator.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/FormatConstants.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/BlockTypeTags.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/RegionDirectory.cs
@DataWarehouse.SDK/VirtualDiskEngine/IBlockDevice.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: AllocationPolicy enum and AllocationGroup class</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/Allocation/AllocationPolicy.cs
    DataWarehouse.SDK/VirtualDiskEngine/Allocation/AllocationGroup.cs
  </files>
  <action>
Create `AllocationPolicy` enum in Allocation/ with values: FirstFit (sequential scan, good for streaming writes), BestFit (smallest fitting gap, good for random writes). Add `[SdkCompatibility("6.0.0")]`.

Create `AllocationGroup` class representing a single allocation group within the VDE data region:
- Fields: `int GroupId`, `long StartBlock`, `long BlockCount`, `AllocationPolicy Policy`, `long FreeBlockCount`, `byte[] Bitmap` (one bit per block), `ReaderWriterLockSlim Lock`
- Constructor takes groupId, startBlock, blockCount, policy, initializes bitmap with all bits set (free)
- `long AllocateBlock()` -- scans bitmap using policy (first-fit or best-fit), clears bit, decrements free count, returns block number. Throws InvalidOperationException if full.
- `long[] AllocateExtent(int count)` -- finds contiguous run of `count` free bits, clears them. For first-fit: scan left-to-right. For best-fit: find smallest run >= count.
- `void FreeBlock(long blockNumber)` -- validates block is within group range, sets bit, increments free count
- `void FreeExtent(long startBlock, int blockCount)` -- frees contiguous range
- `double FragmentationRatio` -- computes ratio of free-space fragments vs total free blocks
- `void Serialize(Span<byte> buffer)` / `static AllocationGroup Deserialize(ReadOnlySpan<byte> buffer, int groupId, long startBlock, long blockCount)` -- binary serialization of bitmap + metadata
- All public methods acquire Lock appropriately (read lock for queries, write lock for mutations)
- For small VDEs (<128MB), a single group covers the entire data region with zero overhead
- Group size default constant: `DefaultGroupSizeBytes = 128 * 1024 * 1024` (128MB)
  </action>
  <verify>Build compiles: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore 2>&1 | tail -5`</verify>
  <done>AllocationGroup can allocate/free blocks within its range using per-group bitmap and lock. AllocationPolicy enum defines FirstFit and BestFit strategies.</done>
</task>

<task type="auto">
  <name>Task 2: AllocationGroupDescriptorTable with region serialization</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/Allocation/AllocationGroupDescriptorTable.cs
  </files>
  <action>
Create `AllocationGroupDescriptorTable` class that manages all allocation groups for a VDE:
- Constructor takes `long totalDataBlocks, int blockSize, long groupSizeBytes = AllocationGroup.DefaultGroupSizeBytes`
- Computes group count: `Math.Max(1, (int)Math.Ceiling((double)(totalDataBlocks * blockSize) / groupSizeBytes))`
- Creates `AllocationGroup[]` array with correct start/block ranges
- `AllocationGroup GetGroup(int groupId)` -- returns group by ID
- `AllocationGroup GetGroupForBlock(long blockNumber)` -- determines which group owns a block
- `long AllocateBlock(int preferredGroup = -1)` -- allocates from preferred group (or first non-full group)
- `long[] AllocateExtent(int blockCount, int preferredGroup = -1)` -- group-local extent allocation
- `void FreeBlock(long blockNumber)` -- routes to correct group
- `void FreeExtent(long startBlock, int blockCount)` -- routes to correct group(s)
- `int GroupCount` property
- `long TotalFreeBlocks` -- sum across all groups

Serialization to/from a dedicated VDE region:
- Each group descriptor is 32 bytes on disk: GroupId(4) + StartBlock(8) + BlockCount(8) + FreeCount(8) + Policy(1) + Reserved(3)
- `void SerializeDescriptors(Span<byte> buffer)` -- writes all group descriptors
- `static AllocationGroupDescriptorTable DeserializeDescriptors(ReadOnlySpan<byte> buffer, int groupCount, int blockSize)` -- reads descriptors
- Bitmap data serialized separately per group via `AllocationGroup.Serialize`
- Uses `BlockTypeTags.BMAP` for region type identification
- `[SdkCompatibility("6.0.0")]` on the class
  </action>
  <verify>Build compiles: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore 2>&1 | tail -5`</verify>
  <done>AllocationGroupDescriptorTable manages N groups, routes allocations to correct group, serializes/deserializes descriptor table for the BMAP region.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore` succeeds with zero errors
- AllocationGroup supports both FirstFit and BestFit allocation policies
- AllocationGroupDescriptorTable correctly partitions data region into groups
- Single-group mode works for small VDEs (<128MB)
</verification>

<success_criteria>
- VOPT-01 satisfied: Allocation groups with per-group bitmap, free count, lock, and policy
- VOPT-02 satisfied: Descriptor table in dedicated region with all group metadata
- All classes have [SdkCompatibility("6.0.0")] attribute
- No mocks, stubs, or placeholders
</success_criteria>

<output>
After completion, create `.planning/phases/87-vde-scalable-internals/87-01-SUMMARY.md`
</output>
