---
phase: 87-vde-scalable-internals
plan: 14
type: execute
wave: 5
depends_on: ["87-04", "87-06"]
files_modified:
  - DataWarehouse.SDK/VirtualDiskEngine/CopyOnWrite/ExtentAwareCowManager.cs
  - DataWarehouse.SDK/VirtualDiskEngine/Replication/ExtentDeltaReplicator.cs
autonomous: true

must_haves:
  truths:
    - "CoW snapshots mark entire extents as shared (not individual blocks)"
    - "Extent-level reference counting reduces snapshot metadata by orders of magnitude"
    - "Replication ships changed extents as delta units"
    - "Larger replication granularity with proportionally less tracking metadata"
  artifacts:
    - path: "DataWarehouse.SDK/VirtualDiskEngine/CopyOnWrite/ExtentAwareCowManager.cs"
      provides: "Extent-granularity CoW snapshots with extent-level refcounting"
      contains: "class ExtentAwareCowManager"
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Replication/ExtentDeltaReplicator.cs"
      provides: "Extent-based replication delta computation and shipping"
      contains: "class ExtentDeltaReplicator"
  key_links:
    - from: "ExtentAwareCowManager.cs"
      to: "ExtentFlags.SharedCow"
      via: "marks extents with SharedCow flag"
      pattern: "ExtentFlags\\.SharedCow"
    - from: "ExtentDeltaReplicator.cs"
      to: "MvccManager"
      via: "uses MVCC transaction IDs to identify changed extents"
      pattern: "MvccManager"
---

<objective>
Implement extent-aware CoW snapshots (VOPT-26) and extent-aware replication delta (VOPT-27). Operating at extent granularity instead of block granularity reduces snapshot and replication metadata overhead by orders of magnitude.

Purpose: A 1TB file with 256K blocks requires 256K reference counts per block. With 64 extents, only 64 reference counts are needed -- 4000x reduction.
Output: Two files in `CopyOnWrite/` and `Replication/`.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@DataWarehouse.SDK/VirtualDiskEngine/CopyOnWrite/CowBlockManager.cs
@DataWarehouse.SDK/VirtualDiskEngine/CopyOnWrite/SnapshotManager.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/InodeExtent.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: ExtentAwareCowManager</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/CopyOnWrite/ExtentAwareCowManager.cs
  </files>
  <action>
Create `ExtentAwareCowManager` class with `[SdkCompatibility("6.0.0")]`:
- Constructor: `IBlockDevice device, IBlockAllocator allocator, IWriteAheadLog wal, int blockSize`

Extent-level reference counting:
- `ConcurrentDictionary<long, int> _extentRefCounts` -- keyed by extent start block
- `void IncrementRef(InodeExtent extent)` -- bumps ref count when extent is shared by snapshot
- `void DecrementRef(InodeExtent extent)` -- decrements ref count; if 0, extent blocks can be freed
- Persistence: ref count table serialized to SNAP region, loaded on VDE open

Snapshot creation:
- `Task<long> CreateSnapshotAsync(long sourceInodeNumber, InodeV2 sourceInode, CancellationToken ct)`:
  - Creates new inode pointing to same extents as source
  - Marks all extents as SharedCow (sets `ExtentFlags.SharedCow`)
  - Increments ref count for each extent
  - WAL-journaled for crash safety
  - Returns snapshot inode number

Copy-on-Write:
- `Task<InodeExtent> CopyOnWriteAsync(InodeExtent sharedExtent, long writeOffset, ReadOnlyMemory<byte> newData, CancellationToken ct)`:
  - If extent is shared (ref count > 1):
    1. Allocate new blocks for the extent
    2. Copy existing data from shared extent to new blocks
    3. Apply the write to the new blocks
    4. Decrement ref on original extent
    5. Return new extent (without SharedCow flag)
  - If extent is not shared (ref count == 1): write directly, return same extent
- Partial extent CoW: if write only touches part of an extent, split into up to 3 extents (before, modified, after) to minimize copy

Snapshot deletion:
- `Task DeleteSnapshotAsync(long snapshotInodeNumber, InodeV2 snapshotInode, CancellationToken ct)`:
  - Decrement ref for all extents in snapshot
  - Free extent blocks where ref drops to 0
  - Delete snapshot inode
  </action>
  <verify>Build compiles: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore 2>&1 | tail -5`</verify>
  <done>ExtentAwareCowManager provides extent-granularity CoW snapshots with ref counting, reducing metadata by orders of magnitude.</done>
</task>

<task type="auto">
  <name>Task 2: ExtentDeltaReplicator</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/Replication/ExtentDeltaReplicator.cs
  </files>
  <action>
Create `ExtentDeltaReplicator` class with `[SdkCompatibility("6.0.0")]`:
- Constructor: `IBlockDevice device, MvccManager mvccManager, int blockSize`

Delta computation:
- `Task<ReplicationDelta> ComputeDeltaAsync(long sinceTransactionId, CancellationToken ct)`:
  - Queries MVCC version store for all extents modified since `sinceTransactionId`
  - Groups modifications by extent (not block) -- if any block in an extent changed, the whole extent is in the delta
  - Returns `ReplicationDelta` with list of changed extents and their data
- `ReplicationDelta` class:
  - `long SinceTransactionId` -- baseline
  - `long UntilTransactionId` -- current
  - `IReadOnlyList<ExtentDelta> ChangedExtents`
  - `long TotalBytes` -- size of delta
  - `int ExtentCount` -- number of changed extents

- `ExtentDelta` readonly struct: `InodeExtent Extent, byte[] Data, long SourceInodeNumber`

Delta application:
- `Task ApplyDeltaAsync(ReplicationDelta delta, IBlockDevice targetDevice, CancellationToken ct)`:
  - Writes each changed extent to the target device at the correct block positions
  - WAL-journaled for crash safety on the target
  - Verifies checksum after write

Delta serialization (for network transport):
- `byte[] SerializeDelta(ReplicationDelta delta)` -- compact binary format: header + extent entries + data
- `ReplicationDelta DeserializeDelta(ReadOnlySpan<byte> data)` -- parses serialized delta
- Format: MagicHeader(4, "RDLT") + Version(2) + SinceTxId(8) + UntilTxId(8) + ExtentCount(4) + [ExtentHeader(32) + Data(variable)]...

Stats:
- `ReplicationStats` struct: `long ExtentsShipped, long BytesShipped, long BlocksSkipped, double CompressionRatio`
- `double Efficiency` -- ratio of delta size to full VDE size (measures how much data was skipped)
  </action>
  <verify>Build compiles: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore 2>&1 | tail -5`</verify>
  <done>ExtentDeltaReplicator computes and ships changed extents as replication deltas, with serialization for network transport and WAL-journaled application on targets.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore` succeeds with zero errors
- Snapshot creation correctly marks extents as SharedCow
- Replication delta only includes extents with modifications since baseline
</verification>

<success_criteria>
- VOPT-26 satisfied: Extent-aware CoW snapshots with extent-level ref counting
- VOPT-27 satisfied: Extent-aware replication delta shipping changed extents
</success_criteria>

<output>
After completion, create `.planning/phases/87-vde-scalable-internals/87-14-SUMMARY.md`
</output>
