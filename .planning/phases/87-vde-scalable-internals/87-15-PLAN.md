---
phase: 87-vde-scalable-internals
plan: 15
type: execute
wave: 5
depends_on: ["87-01", "87-04"]
files_modified:
  - DataWarehouse.SDK/VirtualDiskEngine/Maintenance/OnlineDefragmenter.cs
  - DataWarehouse.SDK/VirtualDiskEngine/Maintenance/DefragmentationPolicy.cs
autonomous: true

must_haves:
  truths:
    - "Background extent compaction merges adjacent free extents within allocation groups"
    - "Defragmentation is configurable with I/O budget limits"
    - "Operations are WAL-journaled for crash safety"
    - "Runs concurrently with normal VDE operations"
  artifacts:
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Maintenance/OnlineDefragmenter.cs"
      provides: "Background defragmentation engine with I/O budgeting"
      contains: "class OnlineDefragmenter"
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Maintenance/DefragmentationPolicy.cs"
      provides: "Configurable defrag policy with thresholds and budgets"
      contains: "class DefragmentationPolicy"
  key_links:
    - from: "OnlineDefragmenter.cs"
      to: "AllocationGroup"
      via: "compacts extents within allocation group boundaries"
      pattern: "AllocationGroup"
    - from: "OnlineDefragmenter.cs"
      to: "IWriteAheadLog"
      via: "WAL-journals all block moves for crash safety"
      pattern: "IWriteAheadLog"
---

<objective>
Implement VDE online defragmentation (VOPT-28) with background extent compaction within allocation groups, configurable I/O budget, and WAL-journaled crash safety.

Purpose: Over time, allocation/deallocation creates fragmented free space. Online defrag merges adjacent free extents and compacts data extents to reduce fragmentation without taking the VDE offline.
Output: Two files in `DataWarehouse.SDK/VirtualDiskEngine/Maintenance/`.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@DataWarehouse.SDK/VirtualDiskEngine/BlockAllocation/IBlockAllocator.cs
@DataWarehouse.SDK/VirtualDiskEngine/Journal/IWriteAheadLog.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/InodeExtent.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: DefragmentationPolicy and OnlineDefragmenter</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/Maintenance/DefragmentationPolicy.cs
    DataWarehouse.SDK/VirtualDiskEngine/Maintenance/OnlineDefragmenter.cs
  </files>
  <action>
Create `DefragmentationPolicy` class with `[SdkCompatibility("6.0.0")]`:
- `double FragmentationThreshold { get; set; } = 0.3` -- trigger defrag when fragmentation ratio exceeds this (0.0 = none, 1.0 = maximum)
- `long MaxIoBudgetBytesPerSecond { get; set; } = 50 * 1024 * 1024` -- 50 MB/s max I/O for defrag operations
- `int MaxBlockMovesPerCycle { get; set; } = 256` -- limit block moves per defrag cycle
- `TimeSpan CycleInterval { get; set; } = TimeSpan.FromSeconds(30)` -- time between defrag cycles
- `bool CompactFreeExtents { get; set; } = true` -- merge adjacent free extents
- `bool RelocateFragmentedFiles { get; set; } = true` -- move data to create contiguous extents
- `int MinExtentsToDefrag { get; set; } = 4` -- only defrag files with more than this many extents
- `DefragPriority Priority { get; set; } = DefragPriority.Background`
- `enum DefragPriority { Background, Normal, Aggressive }`

Create `OnlineDefragmenter` class with `[SdkCompatibility("6.0.0")]`:
- Constructor: `IBlockDevice device, IBlockAllocator allocator, IWriteAheadLog wal, DefragmentationPolicy policy, int blockSize`

Core operations:
- `Task<DefragResult> RunCycleAsync(int allocationGroupId, CancellationToken ct)`:
  1. Analyze fragmentation in the allocation group
  2. Identify candidate files (files with > MinExtentsToDefrag extents)
  3. For each candidate (up to I/O budget):
     a. Find contiguous free space large enough for the file's total extent blocks
     b. WAL-journal the move: write "move-start" record with source/dest blocks
     c. Copy blocks from old location to new contiguous location
     d. Update inode's extent tree to point to new locations
     e. WAL-journal "move-complete"
     f. Free old blocks
  4. Merge adjacent free extents in the allocation group bitmap
  5. Return `DefragResult`

- `DefragResult` readonly struct:
  - `int FilesDefragmented, int ExtentsMerged, long BlocksMoved, long BytesMoved`
  - `double FragmentationBefore, double FragmentationAfter`
  - `TimeSpan Duration, bool BudgetExhausted`

I/O budgeting:
- Track bytes moved in current cycle
- Yield (Task.Delay) when approaching budget limit to throttle I/O
- Stop cycle when budget exhausted

Free extent merging:
- `Task<int> MergeFreeExtentsAsync(int allocationGroupId, CancellationToken ct)`:
  - Scan allocation group bitmap for adjacent free blocks
  - Merge into single free extent (update free list)
  - Returns count of merges performed

Continuous operation:
- `Task RunContinuousAsync(CancellationToken ct)`:
  - Background loop: for each allocation group, check fragmentation ratio
  - If above threshold, run defrag cycle
  - Sleep CycleInterval between cycles
  - Respects cancellation

Crash recovery:
- On startup, replay WAL for incomplete moves:
  - If "move-start" without "move-complete": blocks are in old location (move never started or partially completed), re-run the move
  - Source data is preserved until "move-complete" is journaled

Stats:
- `DefragStats` readonly struct: `long TotalBlocksMoved, long TotalBytesMoved, int TotalFilesDefragmented, double CurrentFragmentation`
  </action>
  <verify>Build compiles: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore 2>&1 | tail -5`</verify>
  <done>OnlineDefragmenter provides background extent compaction within allocation groups with I/O budgeting, WAL-journaled crash safety, and configurable policy.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore` succeeds with zero errors
- Defrag respects I/O budget limits
- WAL recovery handles incomplete moves correctly
</verification>

<success_criteria>
- VOPT-28 satisfied: Online defragmentation with extent compaction, I/O budget, WAL journaling, concurrent operation
</success_criteria>

<output>
After completion, create `.planning/phases/87-vde-scalable-internals/87-15-SUMMARY.md`
</output>
