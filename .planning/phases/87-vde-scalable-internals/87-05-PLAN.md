---
phase: 87-vde-scalable-internals
plan: 05
type: execute
wave: 2
depends_on: ["87-01"]
files_modified:
  - DataWarehouse.SDK/VirtualDiskEngine/Allocation/SubBlockPacker.cs
  - DataWarehouse.SDK/VirtualDiskEngine/Allocation/SubBlockBitmap.cs
autonomous: true

must_haves:
  truths:
    - "Multiple small objects share one block via tail-merging"
    - "Allocation group secondary bitmap tracks sub-block allocation"
    - "Internal fragmentation eliminated for small objects"
    - "Sub-block packing works alongside allocation group primary bitmap"
  artifacts:
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Allocation/SubBlockPacker.cs"
      provides: "Packs multiple small objects into shared blocks"
      contains: "class SubBlockPacker"
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Allocation/SubBlockBitmap.cs"
      provides: "Secondary bitmap tracking sub-block slot allocation within shared blocks"
      contains: "class SubBlockBitmap"
  key_links:
    - from: "SubBlockPacker.cs"
      to: "AllocationGroup"
      via: "operates within allocation group boundaries"
      pattern: "AllocationGroup"
    - from: "SubBlockBitmap.cs"
      to: "IBlockDevice"
      via: "persists sub-block bitmap to disk"
      pattern: "IBlockDevice"
---

<objective>
Implement sub-block packing (VOPT-11) for the VDE. Small objects that don't fill a full block are tail-merged into shared blocks, eliminating internal fragmentation. A secondary bitmap per allocation group tracks which sub-block slots are occupied.

Purpose: Reduces wasted space for workloads with many small objects (config files, metadata records, tags).
Output: Two files in `DataWarehouse.SDK/VirtualDiskEngine/Allocation/`.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@DataWarehouse.SDK/VirtualDiskEngine/Format/FormatConstants.cs
@DataWarehouse.SDK/VirtualDiskEngine/IBlockDevice.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: SubBlockBitmap and SubBlockPacker</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/Allocation/SubBlockBitmap.cs
    DataWarehouse.SDK/VirtualDiskEngine/Allocation/SubBlockPacker.cs
  </files>
  <action>
Create `SubBlockBitmap` class with `[SdkCompatibility("6.0.0")]`:
- Tracks sub-block slot occupancy within shared blocks in an allocation group
- Sub-block slot sizes: 64, 128, 256, 512, 1024, 2048 bytes (configurable, power-of-2)
- For a 4KB block with 64-byte slots: 64 slots per block, 1 byte per 8 slots = 8 bytes bitmap per block
- Constructor: `int blockSize, int minSlotSize = 64`
- `bool AllocateSlot(long blockNumber, int slotSize, out int slotIndex)` -- finds free slot of requested size class, marks occupied
- `void FreeSlot(long blockNumber, int slotIndex)` -- marks slot as free
- `bool IsBlockFullyFree(long blockNumber)` -- true if all slots free (block can be returned to primary bitmap)
- `bool IsBlockFullyOccupied(long blockNumber)` -- true if no free slots remain
- `int FreeSlotCount(long blockNumber)` -- count of available slots
- Serialization: `void Serialize(Span<byte> buffer)` / `static SubBlockBitmap Deserialize(ReadOnlySpan<byte> buffer, int blockSize, int minSlotSize)`
- Internal: `Dictionary<long, byte[]>` mapping block number to slot bitmap

Create `SubBlockPacker` class with `[SdkCompatibility("6.0.0")]`:
- Constructor: `IBlockDevice device, int blockSize, SubBlockBitmap bitmap`
- `Task<(long BlockNumber, int SlotIndex, int SlotOffset)> PackAsync(ReadOnlyMemory<byte> data, int allocationGroupId, CancellationToken ct)`:
  - Determines smallest slot size class that fits data.Length
  - Searches bitmap for a block with a free slot of that size class
  - If no block has space, allocates a new block from the allocation group (marks it as shared in primary bitmap)
  - Writes data to the slot offset within the block
  - Returns the block number, slot index, and byte offset within the block
- `Task UnpackAsync(long blockNumber, int slotIndex, Memory<byte> destination, CancellationToken ct)` -- reads data from a sub-block slot
- `Task FreeAsync(long blockNumber, int slotIndex, CancellationToken ct)` -- frees slot, and if block is now fully free, returns it to allocation group
- Size classes: round up to nearest power-of-2 slot size (64, 128, 256, 512, 1024, 2048)
- Objects larger than blockSize/2 are NOT sub-block packed (use normal block allocation)
  </action>
  <verify>Build compiles: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore 2>&1 | tail -5`</verify>
  <done>SubBlockPacker tail-merges small objects into shared blocks. SubBlockBitmap tracks per-slot occupancy with configurable slot sizes.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore` succeeds with zero errors
- Sub-block packing supports size classes from 64 to 2048 bytes
- Fully-freed shared blocks are returned to the allocation group
</verification>

<success_criteria>
- VOPT-11 satisfied: Multiple small objects share one block via tail-merging
- Secondary bitmap tracks sub-block allocation per allocation group
- Objects > blockSize/2 bypass sub-block packing
</success_criteria>

<output>
After completion, create `.planning/phases/87-vde-scalable-internals/87-05-SUMMARY.md`
</output>
