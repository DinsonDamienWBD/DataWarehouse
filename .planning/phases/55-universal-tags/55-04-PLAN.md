---
phase: 55-universal-tags
plan: 04
type: execute
wave: 2
depends_on: ["55-01"]
files_modified:
  - DataWarehouse.SDK/Contracts/Storage/StorageStrategy.cs
  - DataWarehouse.SDK/Storage/IObjectStorageCore.cs
  - DataWarehouse.SDK/Tags/ITagAttachmentService.cs
  - DataWarehouse.SDK/Tags/TagEvents.cs
autonomous: true

must_haves:
  truths:
    - "StorageObjectMetadata has a TagCollection property for attached tags"
    - "Tag attachment service provides CRUD operations for tags on any object"
    - "Tag mutations emit events for propagation and policy enforcement"
  artifacts:
    - path: "DataWarehouse.SDK/Contracts/Storage/StorageStrategy.cs"
      provides: "StorageObjectMetadata with Tags property"
      contains: "TagCollection"
    - path: "DataWarehouse.SDK/Tags/ITagAttachmentService.cs"
      provides: "Interface for attaching, detaching, reading tags on objects"
      min_lines: 40
    - path: "DataWarehouse.SDK/Tags/TagEvents.cs"
      provides: "TagAttached, TagDetached, TagUpdated event records"
      min_lines: 40
  key_links:
    - from: "DataWarehouse.SDK/Contracts/Storage/StorageStrategy.cs"
      to: "DataWarehouse.SDK/Tags/TagTypes.cs"
      via: "StorageObjectMetadata.Tags typed as TagCollection"
      pattern: "TagCollection.*Tags"
    - from: "DataWarehouse.SDK/Tags/ITagAttachmentService.cs"
      to: "DataWarehouse.SDK/Tags/TagEvents.cs"
      via: "Service methods produce events"
      pattern: "TagEvent"
---

<objective>
Integrate tags into StorageObjectMetadata and define the tag attachment API contract.

Purpose: Every stored object gains a typed tag collection. The attachment service is the entry point for all tag CRUD. Events enable downstream propagation and policy enforcement.
Output: StorageObjectMetadata enhanced, ITagAttachmentService contract, tag event types.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/55-universal-tags/55-01-SUMMARY.md
@DataWarehouse.SDK/Contracts/Storage/StorageStrategy.cs (StorageObjectMetadata at line ~289)
@DataWarehouse.SDK/Storage/IObjectStorageCore.cs
@DataWarehouse.SDK/Tags/TagTypes.cs (Tag, TagKey, TagCollection from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TagCollection to StorageObjectMetadata</name>
  <files>DataWarehouse.SDK/Contracts/Storage/StorageStrategy.cs, DataWarehouse.SDK/Storage/IObjectStorageCore.cs</files>
  <action>
In `StorageStrategy.cs`, modify the `StorageObjectMetadata` record (around line 289):

Add a new property:
```csharp
/// <summary>
/// Typed tag collection attached to this object.
/// Null when tags have not been loaded (lazy-load pattern).
/// Empty TagCollection when object has no tags.
/// </summary>
public TagCollection? Tags { get; init; }
```

Add `using DataWarehouse.SDK.Tags;` at the top of the file.

This is an additive change. The property defaults to null so ALL existing code that creates StorageObjectMetadata without Tags continues to work unchanged. No existing constructors or `with` expressions break.

In `StorageStrategyBase` (same file, around line 490+): no changes needed since the base class creates StorageObjectMetadata via `new StorageObjectMetadata { ... }` object initializer syntax -- the new nullable property is simply unset.

In `IObjectStorageCore.cs`: add a new overload (default interface method):
```csharp
/// <summary>Gets metadata including tags for a specific object.</summary>
Task<StorageObjectMetadata> GetMetadataWithTagsAsync(string key, CancellationToken ct = default)
    => GetMetadataAsync(key, ct); // Default: delegates to non-tag version (backward compat)
```
  </action>
  <verify>Build full solution: `dotnet build DataWarehouse.slnx` -- 0 errors (no regressions in 71 projects).</verify>
  <done>StorageObjectMetadata.Tags property exists, nullable, default null. GetMetadataWithTagsAsync has default implementation. Zero regressions.</done>
</task>

<task type="auto">
  <name>Task 2: Create tag attachment service interface and events</name>
  <files>DataWarehouse.SDK/Tags/ITagAttachmentService.cs, DataWarehouse.SDK/Tags/TagEvents.cs</files>
  <action>
**TagEvents.cs** (namespace `DataWarehouse.SDK.Tags`):
Define event records for message bus publishing:
- `abstract record TagEvent(string ObjectKey, TagKey TagKey, DateTimeOffset Timestamp, string CorrelationId)`
- `sealed record TagAttachedEvent(..., Tag Tag) : TagEvent` -- a new tag was added
- `sealed record TagDetachedEvent(..., TagSource DetachedBy) : TagEvent` -- a tag was removed
- `sealed record TagUpdatedEvent(..., Tag OldTag, Tag NewTag) : TagEvent` -- a tag value changed
- `sealed record TagsBulkUpdatedEvent(string ObjectKey, IReadOnlyList<TagEvent> Events, DateTimeOffset Timestamp, string CorrelationId)` -- batch operation

Define message bus topic constants:
```csharp
public static class TagTopics
{
    public const string TagAttached = "tags.attached";
    public const string TagDetached = "tags.detached";
    public const string TagUpdated = "tags.updated";
    public const string TagsBulkUpdated = "tags.bulk-updated";
    public const string TagPolicyViolation = "tags.policy.violation";
}
```

**ITagAttachmentService.cs** (namespace `DataWarehouse.SDK.Tags`):
```csharp
public interface ITagAttachmentService
{
    Task<Tag> AttachAsync(string objectKey, TagKey tagKey, TagValue value, TagSourceInfo source, TagAcl? acl = null, CancellationToken ct = default);
    Task DetachAsync(string objectKey, TagKey tagKey, TagSourceInfo source, CancellationToken ct = default);
    Task<Tag> UpdateAsync(string objectKey, TagKey tagKey, TagValue newValue, TagSourceInfo source, CancellationToken ct = default);
    Task<Tag?> GetAsync(string objectKey, TagKey tagKey, CancellationToken ct = default);
    Task<TagCollection> GetAllAsync(string objectKey, CancellationToken ct = default);
    Task BulkAttachAsync(string objectKey, IEnumerable<(TagKey Key, TagValue Value, TagSourceInfo Source)> tags, CancellationToken ct = default);
    Task<IReadOnlyList<string>> FindObjectsByTagAsync(TagKey tagKey, TagValue? value = null, int limit = 100, CancellationToken ct = default);
}
```

Mark all with `[SdkCompatibility("5.0.0", Notes = "Phase 55: Tag attachment")]`.
  </action>
  <verify>Build DataWarehouse.SDK project: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` -- 0 errors.</verify>
  <done>ITagAttachmentService has full CRUD + bulk + find-by-tag. TagEvents cover attached/detached/updated/bulk. TagTopics has message bus constants.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.slnx` passes with 0 errors across all projects
- StorageObjectMetadata.Tags is nullable (backward compatible)
- ITagAttachmentService covers all CRUD operations
- TagTopics constants follow existing bus topic naming conventions
</verification>

<success_criteria>
- StorageObjectMetadata.Tags property added without breaking any existing code
- GetMetadataWithTagsAsync default interface method provides backward compatibility
- Tag events are immutable records suitable for message bus publishing
- Zero build errors across the full solution
</success_criteria>

<output>
After completion, create `.planning/phases/55-universal-tags/55-04-SUMMARY.md`
</output>
