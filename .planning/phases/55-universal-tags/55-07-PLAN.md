---
phase: 55-universal-tags
plan: 07
type: execute
wave: 3
depends_on: ["55-04", "55-05"]
files_modified:
  - DataWarehouse.SDK/Tags/ITagPolicyEngine.cs
  - DataWarehouse.SDK/Tags/TagPolicy.cs
  - DataWarehouse.SDK/Tags/DefaultTagPolicyEngine.cs
autonomous: true

must_haves:
  truths:
    - "Tag policies enforce mandatory tag rules (e.g., all objects MUST have classification tag)"
    - "Policy violations are detected before write and reported via events"
    - "Policies support scope (namespace, object prefix, global) and severity levels"
  artifacts:
    - path: "DataWarehouse.SDK/Tags/TagPolicy.cs"
      provides: "TagPolicy, PolicyScope, PolicySeverity, PolicyViolation records"
      min_lines: 80
    - path: "DataWarehouse.SDK/Tags/ITagPolicyEngine.cs"
      provides: "Interface for evaluating and managing tag policies"
      min_lines: 30
    - path: "DataWarehouse.SDK/Tags/DefaultTagPolicyEngine.cs"
      provides: "Implementation that evaluates policies against tag collections"
      min_lines: 100
  key_links:
    - from: "DataWarehouse.SDK/Tags/DefaultTagPolicyEngine.cs"
      to: "DataWarehouse.SDK/Tags/TagSchemaValidator.cs"
      via: "Uses schema validation as part of policy evaluation"
      pattern: "TagSchemaValidator"
    - from: "DataWarehouse.SDK/Tags/DefaultTagPolicyEngine.cs"
      to: "DataWarehouse.SDK/Tags/TagEvents.cs"
      via: "Publishes policy violations to message bus"
      pattern: "TagTopics\\.TagPolicyViolation"
---

<objective>
Build the tag policy engine that enforces mandatory tag rules across the data warehouse.

Purpose: Compliance passports and sovereignty mesh need enforceable rules: "all PII objects MUST have data-classification tag", "EU objects MUST have sovereignty:region=EU". The policy engine validates these rules and blocks or warns on violations.
Output: Policy types, engine interface, and default implementation in DataWarehouse.SDK/Tags/.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/55-universal-tags/55-04-SUMMARY.md
@.planning/phases/55-universal-tags/55-05-SUMMARY.md
@DataWarehouse.SDK/Tags/TagTypes.cs
@DataWarehouse.SDK/Tags/TagSchemaValidator.cs
@DataWarehouse.SDK/Tags/TagEvents.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define tag policy types</name>
  <files>DataWarehouse.SDK/Tags/TagPolicy.cs</files>
  <action>
Create `DataWarehouse.SDK/Tags/TagPolicy.cs` in namespace `DataWarehouse.SDK.Tags`.

Enum `PolicySeverity { Info, Warning, Error, Critical }`:
- `Info`: logged only
- `Warning`: logged, event emitted, operation allowed
- `Error`: event emitted, operation blocked
- `Critical`: event emitted, operation blocked, alert triggered

Enum `PolicyScope { Global, Namespace, ObjectPrefix, Custom }`:
- `Global`: applies to all objects
- `Namespace`: applies to objects in a tag namespace
- `ObjectPrefix`: applies to objects whose key starts with prefix
- `Custom`: uses a predicate function

Enum `PolicyConditionType { RequireTag, ForbidTag, RequireValue, RequireSource, RequireAcl, TagCountLimit, CustomPredicate }`.

Record `PolicyCondition`:
- `PolicyConditionType Type`
- `TagKey? TagKey` -- for RequireTag, ForbidTag, RequireValue, RequireSource
- `TagValue? ExpectedValue` -- for RequireValue
- `TagSource? RequiredSource` -- for RequireSource
- `int? MaxTagCount` -- for TagCountLimit
- `Func<TagCollection, bool>? Predicate` -- for CustomPredicate
- `string Description` -- human-readable condition description

Record `TagPolicy`:
- `string PolicyId`
- `string DisplayName`
- `string? Description`
- `PolicyScope Scope`
- `string? ScopeFilter` -- namespace name, object prefix, etc.
- `IReadOnlyList<PolicyCondition> Conditions` -- all must pass (AND)
- `PolicySeverity Severity`
- `bool Enabled` (default: true)
- `DateTimeOffset CreatedUtc`
- `string? CreatedBy`

Record `PolicyViolation`:
- `string PolicyId`
- `string PolicyDisplayName`
- `string ObjectKey`
- `PolicyCondition FailedCondition`
- `PolicySeverity Severity`
- `string Message`
- `DateTimeOffset DetectedAt`

Record `PolicyEvaluationResult`:
- `bool IsCompliant` -- true if no Error or Critical violations
- `IReadOnlyList<PolicyViolation> Violations`
- `int PoliciesEvaluated`
- `TimeSpan EvaluationDuration`

Mark all with `[SdkCompatibility("5.0.0", Notes = "Phase 55: Tag policy types")]`.
  </action>
  <verify>Build DataWarehouse.SDK project: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` -- 0 errors.</verify>
  <done>TagPolicy, PolicyCondition, PolicyViolation, PolicyEvaluationResult all compile with all fields.</done>
</task>

<task type="auto">
  <name>Task 2: Implement policy engine interface and default implementation</name>
  <files>DataWarehouse.SDK/Tags/ITagPolicyEngine.cs, DataWarehouse.SDK/Tags/DefaultTagPolicyEngine.cs</files>
  <action>
**ITagPolicyEngine.cs** (namespace `DataWarehouse.SDK.Tags`):
```csharp
public interface ITagPolicyEngine
{
    Task<PolicyEvaluationResult> EvaluateAsync(string objectKey, TagCollection tags, CancellationToken ct = default);
    Task AddPolicyAsync(TagPolicy policy, CancellationToken ct = default);
    Task RemovePolicyAsync(string policyId, CancellationToken ct = default);
    Task<TagPolicy?> GetPolicyAsync(string policyId, CancellationToken ct = default);
    IAsyncEnumerable<TagPolicy> ListPoliciesAsync(PolicyScope? scope = null, CancellationToken ct = default);
    Task<bool> IsCompliantAsync(string objectKey, TagCollection tags, CancellationToken ct = default);
}
```

**DefaultTagPolicyEngine.cs** (namespace `DataWarehouse.SDK.Tags`):

Class `DefaultTagPolicyEngine : ITagPolicyEngine`:
- Constructor: `(IMessageBus? messageBus = null)`
- Internal: `ConcurrentDictionary<string, TagPolicy>` for policy storage
- `AddPolicyAsync`: validates PolicyId non-empty, stores policy
- `RemovePolicyAsync`: removes policy
- `GetPolicyAsync`/`ListPoliciesAsync`: lookups
- `EvaluateAsync`:
  1. Start Stopwatch
  2. Find applicable policies: filter by Scope/ScopeFilter matching objectKey
  3. For each enabled policy, evaluate ALL conditions:
     - `RequireTag`: check tags.ContainsKey(condition.TagKey)
     - `ForbidTag`: check !tags.ContainsKey(condition.TagKey)
     - `RequireValue`: check tag exists AND value equals ExpectedValue
     - `RequireSource`: check tag exists AND source matches
     - `RequireAcl`: check tag exists AND ACL has entries
     - `TagCountLimit`: check tags.Count <= MaxTagCount
     - `CustomPredicate`: invoke Predicate(tags)
  4. Collect PolicyViolation for each failed condition
  5. If messageBus provided and any violations with severity >= Warning, publish to `TagTopics.TagPolicyViolation`
  6. Return PolicyEvaluationResult with IsCompliant = no Error/Critical violations
- `IsCompliantAsync`: shortcut, calls EvaluateAsync and returns IsCompliant

Register built-in policies:
- "system.require-classification" (disabled by default): all objects must have tag `compliance:data-classification`
- "system.tag-count-limit" (enabled): no object may have more than 1000 tags

Mark with `[SdkCompatibility("5.0.0", Notes = "Phase 55: Default tag policy engine")]`.
  </action>
  <verify>Build DataWarehouse.SDK project: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` -- 0 errors.</verify>
  <done>DefaultTagPolicyEngine evaluates all condition types, publishes violations to bus, has built-in policies, IsCompliant shortcut works.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` passes with 0 errors
- All 7 condition types are evaluated
- Severity levels correctly determine compliance (Error/Critical = non-compliant)
- Built-in policies registered but classification policy disabled by default
</verification>

<success_criteria>
- Policy engine evaluates RequireTag, ForbidTag, RequireValue, RequireSource, RequireAcl, TagCountLimit, CustomPredicate
- Violations published to message bus with structured data
- Built-in tag count limit prevents unbounded tag accumulation
- IsCompliant is a fast path for pre-write validation
- Zero build errors
</success_criteria>

<output>
After completion, create `.planning/phases/55-universal-tags/55-07-SUMMARY.md`
</output>
