---
phase: 55-universal-tags
plan: 06
type: execute
wave: 3
depends_on: ["55-04", "55-05"]
files_modified:
  - DataWarehouse.SDK/Tags/ITagPropagationEngine.cs
  - DataWarehouse.SDK/Tags/TagPropagationRule.cs
  - DataWarehouse.SDK/Tags/DefaultTagPropagationEngine.cs
autonomous: true

must_haves:
  truths:
    - "Tags propagate automatically through the data lifecycle (ingest, process, store, replicate)"
    - "Propagation rules define which tags carry forward and how they transform"
    - "Propagation respects tag ACLs and schema constraints"
  artifacts:
    - path: "DataWarehouse.SDK/Tags/ITagPropagationEngine.cs"
      provides: "Contract for tag propagation across pipeline stages"
      min_lines: 30
    - path: "DataWarehouse.SDK/Tags/TagPropagationRule.cs"
      provides: "Rule definitions, stage enum, transform operations"
      min_lines: 60
    - path: "DataWarehouse.SDK/Tags/DefaultTagPropagationEngine.cs"
      provides: "Engine that evaluates rules and propagates tags"
      min_lines: 100
  key_links:
    - from: "DataWarehouse.SDK/Tags/DefaultTagPropagationEngine.cs"
      to: "DataWarehouse.SDK/Tags/ITagAttachmentService.cs"
      via: "Uses attachment service to apply propagated tags"
      pattern: "ITagAttachmentService"
    - from: "DataWarehouse.SDK/Tags/DefaultTagPropagationEngine.cs"
      to: "DataWarehouse.SDK/Tags/TagEvents.cs"
      via: "Subscribes to tag events via message bus"
      pattern: "TagTopics"
---

<objective>
Build the tag propagation engine that carries tags through the data lifecycle.

Purpose: When data moves through ingest->process->store->replicate stages, tags must follow. A compliance tag set at ingest must persist through encryption, compression, and replication. Without propagation, tags are dead metadata.
Output: Propagation contracts, rules, and default engine in DataWarehouse.SDK/Tags/.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/55-universal-tags/55-04-SUMMARY.md
@.planning/phases/55-universal-tags/55-05-SUMMARY.md
@DataWarehouse.SDK/Tags/ITagAttachmentService.cs
@DataWarehouse.SDK/Tags/TagEvents.cs
@DataWarehouse.SDK/Tags/TagTypes.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define propagation rules and contracts</name>
  <files>DataWarehouse.SDK/Tags/TagPropagationRule.cs, DataWarehouse.SDK/Tags/ITagPropagationEngine.cs</files>
  <action>
**TagPropagationRule.cs** (namespace `DataWarehouse.SDK.Tags`):

Enum `PipelineStage { Ingest, Validate, Transform, Encrypt, Compress, Store, Replicate, Archive, Delete }`.

Enum `PropagationAction { Copy, Drop, Transform, Merge, InheritFromParent }`:
- `Copy` -- tag carries forward unchanged
- `Drop` -- tag is removed at this stage
- `Transform` -- tag value is modified by a transform function
- `Merge` -- when multiple sources converge, merge tag values
- `InheritFromParent` -- inherit tag from container/parent object

Record `TagPropagationRule`:
- `string RuleId`
- `TagKey? TagKeyFilter` -- null = applies to all tags
- `string? NamespaceFilter` -- null = all namespaces
- `PipelineStage FromStage`
- `PipelineStage ToStage`
- `PropagationAction Action`
- `Func<Tag, Tag>? TransformFunc` -- for Transform action
- `int Priority` -- lower = higher priority (default: 100)
- `bool StopOnMatch` -- if true, no further rules evaluated for this tag

Record `TagPropagationContext`:
- `string SourceObjectKey`
- `string TargetObjectKey`
- `PipelineStage CurrentStage`
- `TagCollection SourceTags`
- `IReadOnlyDictionary<string, string>? PipelineMetadata` -- extra context from pipeline

Record `TagPropagationResult`:
- `IReadOnlyList<Tag> PropagatedTags`
- `IReadOnlyList<(TagKey Key, string Reason)> DroppedTags`
- `IReadOnlyList<(TagKey Key, string Error)> FailedTags`

**ITagPropagationEngine.cs** (namespace `DataWarehouse.SDK.Tags`):
```csharp
public interface ITagPropagationEngine
{
    Task<TagPropagationResult> PropagateAsync(TagPropagationContext context, CancellationToken ct = default);
    void AddRule(TagPropagationRule rule);
    void RemoveRule(string ruleId);
    IReadOnlyList<TagPropagationRule> GetRules(PipelineStage? stage = null);
}
```

Mark all with `[SdkCompatibility("5.0.0", Notes = "Phase 55: Tag propagation")]`.
  </action>
  <verify>Build DataWarehouse.SDK project: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` -- 0 errors.</verify>
  <done>TagPropagationRule has stage/action/filter/priority, ITagPropagationEngine has propagate/add/remove/get rules.</done>
</task>

<task type="auto">
  <name>Task 2: Implement default propagation engine</name>
  <files>DataWarehouse.SDK/Tags/DefaultTagPropagationEngine.cs</files>
  <action>
Create `DataWarehouse.SDK/Tags/DefaultTagPropagationEngine.cs` in namespace `DataWarehouse.SDK.Tags`.

Class `DefaultTagPropagationEngine : ITagPropagationEngine`:
- Constructor: `(ITagAttachmentService? attachmentService = null, ITagSchemaRegistry? schemaRegistry = null)`
- Internal: `SortedList<int, TagPropagationRule>` for priority ordering, keyed by priority, with RuleId as tiebreaker
- `AddRule`: insert into sorted list
- `RemoveRule`: remove by RuleId
- `GetRules`: filter by stage if provided
- `PropagateAsync`:
  1. For each tag in `context.SourceTags`:
     a. Find matching rules: rules where `FromStage == context.CurrentStage` AND (TagKeyFilter matches or is null) AND (NamespaceFilter matches or is null), sorted by Priority
     b. Apply first matching rule (or all until StopOnMatch):
        - `Copy`: add tag to result unchanged
        - `Drop`: add to dropped list with reason "Rule {ruleId}"
        - `Transform`: apply TransformFunc, validate result against schema if registry available, add to result
        - `Merge`: merge with existing tag on target (LWW semantics if no custom merge)
        - `InheritFromParent`: look up parent tag, copy if exists
     c. If no rules match: default is `Copy` (tags propagate by default)
  2. If attachmentService provided, bulk-attach propagated tags to target object
  3. Return TagPropagationResult with propagated, dropped, and failed lists

Register default rules for common patterns:
- System tags (namespace "system") always Copy
- Compliance tags (namespace "compliance") always Copy with Immutable check
- Temporary tags (namespace "temp") Drop on Store stage

Mark with `[SdkCompatibility("5.0.0", Notes = "Phase 55: Default tag propagation engine")]`.
  </action>
  <verify>Build DataWarehouse.SDK project: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` -- 0 errors.</verify>
  <done>DefaultTagPropagationEngine evaluates rules by priority, defaults to Copy, attaches to target via service, has built-in rules for system/compliance/temp namespaces.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` passes with 0 errors
- Propagation defaults to Copy (no silent tag loss)
- Rules are evaluated in priority order
- Built-in rules cover system, compliance, temp namespaces
</verification>

<success_criteria>
- PipelineStage enum covers ingest through delete
- Propagation rules support filter, transform, merge, drop, inherit
- Default engine applies rules in priority order with stop-on-match
- Tags propagate by default if no rules match (safe default)
- Zero build errors
</success_criteria>

<output>
After completion, create `.planning/phases/55-universal-tags/55-06-SUMMARY.md`
</output>
