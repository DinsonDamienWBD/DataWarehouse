---
phase: 55-universal-tags
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.SDK/Tags/ITagSchemaRegistry.cs
  - DataWarehouse.SDK/Tags/TagSchema.cs
  - DataWarehouse.SDK/Tags/TagSchemaValidator.cs
autonomous: true

must_haves:
  truths:
    - "Tag schemas define required type, constraints, and defaults for a tag key"
    - "Schemas are versioned with semver and can evolve without breaking existing tags"
    - "Validation rejects tags that violate their schema constraints"
  artifacts:
    - path: "DataWarehouse.SDK/Tags/TagSchema.cs"
      provides: "TagSchema, TagSchemaVersion, TagConstraint records"
      min_lines: 80
    - path: "DataWarehouse.SDK/Tags/ITagSchemaRegistry.cs"
      provides: "Interface for registering, querying, versioning schemas"
      min_lines: 40
    - path: "DataWarehouse.SDK/Tags/TagSchemaValidator.cs"
      provides: "Validates TagValue against TagSchema constraints"
      min_lines: 60
  key_links:
    - from: "DataWarehouse.SDK/Tags/TagSchema.cs"
      to: "DataWarehouse.SDK/Tags/TagValueTypes.cs"
      via: "RequiredKind references TagValueKind"
      pattern: "TagValueKind"
    - from: "DataWarehouse.SDK/Tags/TagSchemaValidator.cs"
      to: "DataWarehouse.SDK/Tags/TagSchema.cs"
      via: "Validates against schema constraints"
      pattern: "TagSchema"
---

<objective>
Define the tag schema registry contracts and validation logic in the SDK.

Purpose: Schemas govern what tags can exist, what types they must be, and what constraints apply. This is the governance layer that compliance passports, sovereignty mesh, and policy engines will use.
Output: Schema types, registry interface, and validator in DataWarehouse.SDK/Tags/.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@DataWarehouse.SDK/Tags/TagValueTypes.cs (from Plan 01 -- TagValueKind, TagValue hierarchy)
@DataWarehouse.SDK/Tags/TagTypes.cs (from Plan 01 -- TagKey, Tag)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tag schema types</name>
  <files>DataWarehouse.SDK/Tags/TagSchema.cs</files>
  <action>
Create `DataWarehouse.SDK/Tags/TagSchema.cs` in namespace `DataWarehouse.SDK.Tags`.

**TagConstraint** record:
- `decimal? MinValue` / `decimal? MaxValue` -- for NumberTagValue
- `int? MinLength` / `int? MaxLength` -- for StringTagValue/ParagraphTagValue
- `string? Pattern` -- regex for string validation
- `IReadOnlySet<string>? AllowedValues` -- enum-style restriction for string
- `IReadOnlySet<TagValueKind>? AllowedItemKinds` -- for ListTagValue items
- `int? MaxItems` -- for ListTagValue/ObjectTagValue
- `int? MaxDepth` -- for TreeTagValue
- `bool Required` -- tag is mandatory on objects matching scope
- `TagValue? DefaultValue` -- default if not provided

**TagSchemaVersion** record:
- `string Version` (semver string, e.g., "1.0.0")
- `DateTimeOffset CreatedUtc`
- `string? ChangeDescription`
- `TagConstraint Constraints`
- `TagValueKind RequiredKind`

**TagSchema** record:
- `string SchemaId` -- unique identifier (e.g., "compliance.data-classification")
- `TagKey TagKey` -- which tag this schema governs
- `string DisplayName`
- `string? Description`
- `IReadOnlyList<TagSchemaVersion> Versions` -- ordered oldest to newest
- `TagSchemaVersion CurrentVersion => Versions[^1]`
- `TagSource AllowedSources` -- flags-style: which sources can set this tag (default: all)
- `bool Immutable` -- once set, cannot be modified
- `bool SystemOnly` -- only System source can write

Add `TagSchemaEvolutionRule` enum: `{ None, Additive, Compatible, Breaking }` -- governs what schema version changes are permitted.

Mark all with `[SdkCompatibility("5.0.0", Notes = "Phase 55: Tag schema types")]`.
  </action>
  <verify>Build DataWarehouse.SDK project: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` -- 0 errors.</verify>
  <done>TagSchema, TagSchemaVersion, TagConstraint records compile with all fields.</done>
</task>

<task type="auto">
  <name>Task 2: Create schema registry interface and validator</name>
  <files>DataWarehouse.SDK/Tags/ITagSchemaRegistry.cs, DataWarehouse.SDK/Tags/TagSchemaValidator.cs</files>
  <action>
**ITagSchemaRegistry.cs** (namespace `DataWarehouse.SDK.Tags`):
```csharp
public interface ITagSchemaRegistry
{
    Task RegisterAsync(TagSchema schema, CancellationToken ct = default);
    Task<TagSchema?> GetAsync(string schemaId, CancellationToken ct = default);
    Task<TagSchema?> GetByTagKeyAsync(TagKey tagKey, CancellationToken ct = default);
    IAsyncEnumerable<TagSchema> ListAsync(string? namespaceFilter = null, CancellationToken ct = default);
    Task<bool> AddVersionAsync(string schemaId, TagSchemaVersion version, TagSchemaEvolutionRule rule = TagSchemaEvolutionRule.Compatible, CancellationToken ct = default);
    Task<bool> DeleteAsync(string schemaId, CancellationToken ct = default);
    Task<int> CountAsync(CancellationToken ct = default);
}
```

**TagSchemaValidator.cs** (namespace `DataWarehouse.SDK.Tags`):
Static class `TagSchemaValidator` with:
- `static TagValidationResult Validate(Tag tag, TagSchema schema)` -- validates a tag against its schema
- Checks: Value kind matches `RequiredKind`, string length/pattern/allowed values, number range, list item count/kinds, tree depth, source allowed, immutability
- `static TagValidationResult ValidateCollection(TagCollection tags, IEnumerable<TagSchema> schemas)` -- validates all tags, checks Required constraint

**TagValidationResult** record:
- `bool IsValid`
- `IReadOnlyList<TagValidationError> Errors`
- `static TagValidationResult Success { get; }`

**TagValidationError** record:
- `TagKey TagKey`
- `string ErrorCode` (e.g., "TYPE_MISMATCH", "VALUE_OUT_OF_RANGE", "REQUIRED_TAG_MISSING")
- `string Message`

Mark with `[SdkCompatibility("5.0.0", Notes = "Phase 55: Tag schema validation")]`.
  </action>
  <verify>Build DataWarehouse.SDK project: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` -- 0 errors.</verify>
  <done>ITagSchemaRegistry interface compiles, TagSchemaValidator validates kind/constraints/required/source, TagValidationResult captures errors.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` passes with 0 errors
- Schema types reference TagValueKind from Plan 01 types
- Validator covers: type mismatch, range, length, pattern, required, source
</verification>

<success_criteria>
- 3 files created in DataWarehouse.SDK/Tags/
- TagSchema has versioned schema evolution
- ITagSchemaRegistry supports register, get, list, version, delete
- TagSchemaValidator validates all constraint types
- Zero build errors
</success_criteria>

<output>
After completion, create `.planning/phases/55-universal-tags/55-02-SUMMARY.md`
</output>
