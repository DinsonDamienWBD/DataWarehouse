---
phase: 55-universal-tags
plan: 11
type: execute
wave: 6
depends_on: ["55-06", "55-07", "55-08", "55-09", "55-10"]
files_modified:
  - DataWarehouse.SDK/Tags/TagServiceRegistration.cs
  - DataWarehouse.SDK/Tags/TagSystemHealthCheck.cs
autonomous: true

must_haves:
  truths:
    - "All tag services register with the kernel via a single registration entry point"
    - "Full solution builds with zero errors across all 71+ projects"
    - "Tag system health check validates all subsystems are wired"
  artifacts:
    - path: "DataWarehouse.SDK/Tags/TagServiceRegistration.cs"
      provides: "Service registration for all tag components"
      min_lines: 40
    - path: "DataWarehouse.SDK/Tags/TagSystemHealthCheck.cs"
      provides: "Health check that validates tag subsystem integrity"
      min_lines: 50
  key_links:
    - from: "DataWarehouse.SDK/Tags/TagServiceRegistration.cs"
      to: "DataWarehouse.SDK/Tags/DefaultTagAttachmentService.cs"
      via: "Registers attachment service"
      pattern: "DefaultTagAttachmentService"
    - from: "DataWarehouse.SDK/Tags/TagServiceRegistration.cs"
      to: "DataWarehouse.SDK/Tags/DefaultTagPolicyEngine.cs"
      via: "Registers policy engine"
      pattern: "DefaultTagPolicyEngine"
    - from: "DataWarehouse.SDK/Tags/TagServiceRegistration.cs"
      to: "DataWarehouse.SDK/Tags/DefaultTagPropagationEngine.cs"
      via: "Registers propagation engine"
      pattern: "DefaultTagPropagationEngine"
---

<objective>
Wire all tag subsystems together, verify full-solution build, and add health checks.

Purpose: Plans 01-10 created individual subsystems. This plan wires them together via service registration and verifies the complete solution builds without regressions.
Output: Service registration, health checks, verified build.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/55-universal-tags/55-06-SUMMARY.md
@.planning/phases/55-universal-tags/55-07-SUMMARY.md
@.planning/phases/55-universal-tags/55-08-SUMMARY.md
@.planning/phases/55-universal-tags/55-09-SUMMARY.md
@.planning/phases/55-universal-tags/55-10-SUMMARY.md
@DataWarehouse.SDK/Tags/ (all files from Plans 01-10)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create service registration and health check</name>
  <files>DataWarehouse.SDK/Tags/TagServiceRegistration.cs, DataWarehouse.SDK/Tags/TagSystemHealthCheck.cs</files>
  <action>
**TagServiceRegistration.cs** (namespace `DataWarehouse.SDK.Tags`):

Static class `TagServiceRegistration` with a single entry point:
```csharp
public static class TagServiceRegistration
{
    public static TagServiceCollection CreateDefault(IMessageBus? messageBus = null)
    {
        var schemaRegistry = new InMemoryTagSchemaRegistry();
        var tagStore = new InMemoryTagStore();
        var tagIndex = new InvertedTagIndex();
        var attachmentService = new DefaultTagAttachmentService(tagStore, schemaRegistry, messageBus);
        var propagationEngine = new DefaultTagPropagationEngine(attachmentService, schemaRegistry);
        var policyEngine = new DefaultTagPolicyEngine(messageBus);
        var queryApi = new DefaultTagQueryApi(tagIndex, tagStore);

        return new TagServiceCollection(
            SchemaRegistry: schemaRegistry,
            TagStore: tagStore,
            TagIndex: tagIndex,
            AttachmentService: attachmentService,
            PropagationEngine: propagationEngine,
            PolicyEngine: policyEngine,
            QueryApi: queryApi
        );
    }
}

public record TagServiceCollection(
    ITagSchemaRegistry SchemaRegistry,
    ITagStore TagStore,
    ITagIndex TagIndex,
    ITagAttachmentService AttachmentService,
    ITagPropagationEngine PropagationEngine,
    ITagPolicyEngine PolicyEngine,
    ITagQueryApi QueryApi);
```

**TagSystemHealthCheck.cs** (namespace `DataWarehouse.SDK.Tags`):

Class `TagSystemHealthCheck`:
```csharp
public sealed class TagSystemHealthCheck
{
    private readonly TagServiceCollection _services;

    public TagSystemHealthCheck(TagServiceCollection services) => _services = services;

    public async Task<TagHealthReport> CheckAsync(CancellationToken ct = default)
    {
        var checks = new List<TagHealthCheckItem>();

        // 1. Schema registry reachable
        checks.Add(await CheckSchemaRegistry(ct));

        // 2. Tag store read/write
        checks.Add(await CheckTagStore(ct));

        // 3. Tag index operational
        checks.Add(await CheckTagIndex(ct));

        // 4. Policy engine loaded
        checks.Add(await CheckPolicyEngine(ct));

        // 5. Propagation engine has default rules
        checks.Add(CheckPropagationEngine());

        // 6. Query API functional
        checks.Add(await CheckQueryApi(ct));

        return new TagHealthReport(
            IsHealthy: checks.All(c => c.IsHealthy),
            Checks: checks,
            CheckedAt: DateTimeOffset.UtcNow
        );
    }
}

public record TagHealthReport(bool IsHealthy, IReadOnlyList<TagHealthCheckItem> Checks, DateTimeOffset CheckedAt);
public record TagHealthCheckItem(string ComponentName, bool IsHealthy, string? Message = null, TimeSpan? Latency = null);
```

Each check method: creates a test tag, performs an operation, verifies result, measures latency, catches exceptions. If any check throws, IsHealthy=false with exception message.

Mark all with `[SdkCompatibility("5.0.0", Notes = "Phase 55: Tag service registration")]`.
  </action>
  <verify>Build DataWarehouse.SDK project: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` -- 0 errors.</verify>
  <done>TagServiceRegistration.CreateDefault() wires all 7 subsystems. TagSystemHealthCheck validates all components.</done>
</task>

<task type="auto">
  <name>Task 2: Full solution build verification and fix any issues</name>
  <files></files>
  <action>
Run full solution build: `dotnet build DataWarehouse.slnx --configuration Release`

If ANY errors appear:
1. Read each error carefully
2. Fix the root cause (likely missing usings, namespace conflicts, or type mismatches between plan artifacts)
3. Common issues to watch for:
   - `TagCollection` conflicts with existing types -- use full namespace qualification if needed
   - `using DataWarehouse.SDK.Tags` missing in StorageStrategy.cs (Plan 04 should have added it)
   - Nullable reference type warnings -- ensure all nullable properties use `?`
4. Re-build until 0 errors

Run tests: `dotnet test DataWarehouse.slnx --no-build --configuration Release`
- All existing tests must pass (0 regressions)
- The tag system is SDK-only, no plugin changes, so existing plugin tests should be unaffected

If any test regressions, investigate and fix. The only change to existing code is the additive Tags property on StorageObjectMetadata (nullable, default null).

Verify file count: there should be ~20 files in DataWarehouse.SDK/Tags/ directory.
  </action>
  <verify>`dotnet build DataWarehouse.slnx --configuration Release` -- 0 errors. `dotnet test DataWarehouse.slnx --no-build --configuration Release` -- all tests pass. `ls DataWarehouse.SDK/Tags/ | wc -l` shows ~20 files.</verify>
  <done>Full solution builds with 0 errors in Release mode. All existing tests pass. ~20 tag system files in DataWarehouse.SDK/Tags/.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.slnx --configuration Release` -- 0 errors, 0 warnings in SDK
- `dotnet test DataWarehouse.slnx --no-build --configuration Release` -- all pass
- TagServiceRegistration.CreateDefault() creates all 7 subsystems
- TagSystemHealthCheck validates all subsystems
</verification>

<success_criteria>
- Full solution build: 0 errors across all 71+ projects
- All existing tests pass (0 regressions)
- Service registration provides single entry point for all tag services
- Health check covers all 6 subsystems
- ~20 files in DataWarehouse.SDK/Tags/
</success_criteria>

<output>
After completion, create `.planning/phases/55-universal-tags/55-11-SUMMARY.md`
</output>
