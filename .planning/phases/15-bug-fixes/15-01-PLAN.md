---
phase: 15-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Plugins/DataWarehouse.Plugins.Raft/**/*.cs
  - Plugins/DataWarehouse.Plugins.UltimateStorage/**/*.cs
  - Metadata/TODO.md
autonomous: true

must_haves:
  truths:
    - "T26 Raft silent exception swallowing fix is verified present in codebase"
    - "T28 Raft log persistence fix is verified present in codebase"
    - "T30 S3 fragile XML parsing fix is verified migrated to UltimateStorage"
    - "T31 S3 fire-and-forget async fix is verified migrated to UltimateStorage"
    - "Deferred unit tests from T26, T28, T30, T31 are implemented"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.Raft/"
      provides: "Raft plugin with exception handling and log persistence fixes"
      contains: "catch.*Exception"
    - path: "Metadata/TODO.md"
      provides: "Updated task tracking with test completion"
  key_links:
    - from: "Raft plugin"
      to: "Exception handling"
      via: "try/catch blocks with proper logging"
      pattern: "catch.*(?:Exception|IOException)"
    - from: "UltimateStorage"
      to: "XML parsing"
      via: "Safe XML deserialization"
      pattern: "XmlSerializer|XDocument|XElement"
---

<objective>
Verify critical bug fixes T26-T31 and implement deferred unit tests.

Purpose: All 4 critical bug tasks (T26, T28, T30, T31) were completed on 2026-01-25 per TODO.md. This plan verifies the fixes are present in the codebase and implements the deferred unit tests that were noted during the original fixes. The S3 plugin no longer exists (consolidated into UltimateStorage T97), so S3-related fixes (T30, T31) need verification in UltimateStorage.

Output: Verified bug fixes with test coverage; updated TODO.md with deferred test items marked complete.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-bug-fixes/15-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify T26-T31 bug fixes in codebase</name>
  <files>
    Plugins/DataWarehouse.Plugins.Raft/
    Plugins/DataWarehouse.Plugins.UltimateStorage/
  </files>
  <action>
    Verify each critical bug fix is present:

    **T26 - Raft silent exception swallowing:**
    - Search Raft plugin for catch blocks -- verify exceptions are logged or re-thrown, NOT silently swallowed
    - Confirm pattern: `catch (Exception ex) { _logger.Log...(ex) ... }` or re-throw, NOT empty catch blocks
    - If any empty catch blocks remain, fix them by adding proper logging via the plugin's logger

    **T28 - Raft no log persistence:**
    - Search Raft plugin for log/state persistence -- verify Raft log entries are persisted to storage (not just in-memory)
    - Confirm pattern: writes to disk/storage/stream for Raft consensus log entries
    - If persistence is missing, this is a deeper issue -- document it

    **T30 - S3 fragile XML parsing (now in UltimateStorage):**
    - S3Storage plugin was consolidated into UltimateStorage (T97)
    - Search UltimateStorage S3-compatible strategies for XML parsing
    - Verify XML parsing uses safe patterns (XDocument.Parse with try/catch, NOT raw string manipulation)
    - If fragile XML parsing patterns exist (e.g., IndexOf/Substring on XML), replace with XDocument or XElement

    **T31 - S3 fire-and-forget async (now in UltimateStorage):**
    - Search UltimateStorage S3-compatible strategies for async patterns
    - Verify NO fire-and-forget async calls (no `_ = SomeAsync()` or `Task.Run(() => SomeAsync())` without await)
    - All async calls should be properly awaited
    - If fire-and-forget patterns found, add proper await

    Document findings for each task (present/fixed/not-applicable).
  </action>
  <verify>
    Run `dotnet build DataWarehouse.slnx` to confirm zero build errors after any fixes.
    Grep for empty catch blocks in Raft: search for `catch.*\{[\s]*\}` patterns.
  </verify>
  <done>
    All 4 bug fix areas verified: T26 (exception handling), T28 (log persistence), T30 (XML parsing safety), T31 (async await correctness). Any remaining issues documented or fixed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement deferred unit tests for T26, T28, T30, T31</name>
  <files>
    DataWarehouse.Tests/Plugins/RaftBugFixTests.cs
    DataWarehouse.Tests/Plugins/StorageBugFixTests.cs
    Metadata/TODO.md
  </files>
  <action>
    Create focused test files for the deferred test items:

    **RaftBugFixTests.cs** (for T26 + T28):
    - Test that Raft exception handling logs exceptions (not swallows them) -- verify via mock logger or by checking exception flow
    - Test that Raft log persistence writes and reads back log entries correctly
    - Use real implementations, no mocks per Rule 13. Test against in-memory or file-based storage if available.
    - If Raft plugin requires complex setup, write contract-level tests that verify the expected behavior patterns

    **StorageBugFixTests.cs** (for T30 + T31):
    - Test that S3-compatible XML response parsing handles malformed XML gracefully (returns error, not crash)
    - Test that S3-compatible XML parsing handles common S3 response formats (ListBucket, GetObject, Error)
    - Test that async operations in S3-compatible strategies are properly awaited (no fire-and-forget)
    - Since S3 plugin was consolidated into UltimateStorage, test against UltimateStorage's S3-compatible strategies

    After tests are created and pass, update Metadata/TODO.md:
    - Find T26, T28, T30, T31 entries
    - Mark any deferred test sub-items as [x] Complete
  </action>
  <verify>
    Run `dotnet test DataWarehouse.Tests/ --filter "RaftBugFix|StorageBugFix"` -- all tests pass.
    Run `dotnet build DataWarehouse.slnx` -- zero errors.
  </verify>
  <done>
    Deferred tests for T26 (Raft exception handling), T28 (Raft log persistence), T30 (S3 XML parsing), T31 (S3 async patterns) are implemented and passing. TODO.md updated with deferred items marked complete.
  </done>
</task>

</tasks>

<verification>
- All 4 critical bug areas verified in codebase
- Unit tests cover each bug fix area
- `dotnet build DataWarehouse.slnx` passes with zero errors
- TODO.md deferred items for T26, T28, T30, T31 marked complete
</verification>

<success_criteria>
- T26-T31 bug fixes confirmed present and working
- Deferred unit tests created and passing
- Zero build errors
- TODO.md updated
</success_criteria>

<output>
After completion, create `.planning/phases/15-bug-fixes/15-01-SUMMARY.md`
</output>
