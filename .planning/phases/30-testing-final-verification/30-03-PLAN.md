---
phase: 30-testing-final-verification
plan: 03
type: execute
wave: 2
depends_on: ["30-01"]
files_modified:
  - DataWarehouse.Tests/Infrastructure/DistributedContractTests.cs
  - DataWarehouse.Tests/Infrastructure/ResilienceContractTests.cs
  - DataWarehouse.Tests/Infrastructure/ObservabilityContractTests.cs
  - DataWarehouse.Tests/Infrastructure/InMemoryImplementationTests.cs
autonomous: true

must_haves:
  truths:
    - "All 7 distributed contract interfaces are testable via their in-memory implementations"
    - "All 5 resilience contract interfaces (circuit breaker, bulkhead, timeout, dead letter, graceful shutdown) are tested"
    - "All 4 observability contracts (activity source, correlated logger, resource meter, audit trail) are tested"
    - "All 13 in-memory implementations exercise their full API surface (not just instantiation)"
    - "FederatedMessageBusBase delegates correctly to local message bus"
  artifacts:
    - path: "DataWarehouse.Tests/Infrastructure/DistributedContractTests.cs"
      provides: "Tests for 7 distributed contracts via in-memory implementations"
      min_lines: 150
    - path: "DataWarehouse.Tests/Infrastructure/ResilienceContractTests.cs"
      provides: "Tests for circuit breaker state machine, bulkhead limits, timeout, dead letter, shutdown"
      min_lines: 100
    - path: "DataWarehouse.Tests/Infrastructure/ObservabilityContractTests.cs"
      provides: "Tests for activity source, logger, meter, audit trail implementations"
      min_lines: 80
    - path: "DataWarehouse.Tests/Infrastructure/InMemoryImplementationTests.cs"
      provides: "Integration tests exercising all 13 in-memory implementations end-to-end"
      min_lines: 200
  key_links:
    - from: "DataWarehouse.Tests/Infrastructure/InMemoryImplementationTests.cs"
      to: "DataWarehouse.SDK/Infrastructure/InMemory/"
      via: "Direct instantiation of InMemory* classes"
      pattern: "new InMemory"
    - from: "DataWarehouse.Tests/Infrastructure/DistributedContractTests.cs"
      to: "DataWarehouse.SDK/Contracts/Distributed/"
      via: "Interface type verification"
      pattern: "typeof\\(I(ClusterMembership|LoadBalancer|P2PNetwork|AutoScaler|ReplicationSync|AutoTier|AutoGovernance)\\)"
    - from: "DataWarehouse.Tests/Infrastructure/ResilienceContractTests.cs"
      to: "DataWarehouse.SDK/Contracts/Resilience/"
      via: "InMemory implementations of resilience interfaces"
      pattern: "InMemory(CircuitBreaker|Bulkhead|DeadLetter)"
---

<objective>
Write integration tests for all Phase 26 distributed infrastructure: 7 distributed contracts, 5 resilience contracts, 4 observability contracts, and all 13 in-memory implementations.

Purpose: TEST-05 (distributed infrastructure integration tests with in-memory implementations). These are brand new in v2.0 and have zero existing test coverage. The in-memory implementations are production-ready (Rule 13) and need proper verification before the milestone ships.

Output: 4 new test files with ~80-120 new test methods covering every distributed, resilience, and observability contract.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-testing-final-verification/30-RESEARCH.md
@.planning/phases/30-testing-final-verification/30-01-SUMMARY.md
@.planning/phases/26-distributed-contracts-resilience/26-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Distributed and resilience contract reflection tests</name>
  <files>
    DataWarehouse.Tests/Infrastructure/DistributedContractTests.cs
    DataWarehouse.Tests/Infrastructure/ResilienceContractTests.cs
    DataWarehouse.Tests/Infrastructure/ObservabilityContractTests.cs
  </files>
  <action>
    Create 3 test files that verify the SDK contracts exist with correct structure. Use `[Trait("Category", "Unit")]`. All tests reference SDK types only (no plugin references needed).

    **File 1: DistributedContractTests.cs** (~25 tests)
    Test the 7 distributed contract interfaces from Phase 26 (DataWarehouse.SDK.Contracts.Distributed):
    - `IClusterMembership_ShouldExist` -- verify interface exists, has GetMembers/GetLeader/JoinAsync/LeaveAsync methods
    - `ILoadBalancerStrategy_ShouldExist` -- verify interface, has SelectNode/UpdateWeights methods
    - `IP2PNetwork_ShouldExist` -- verify interface, has peer discovery/data transfer methods
    - `IAutoScaler_ShouldExist` -- verify interface, has ScaleOut/ScaleIn/GetMetrics methods
    - `IReplicationSync_ShouldExist` -- verify interface, has Sync/GetStatus methods
    - `IAutoTier_ShouldExist` -- verify interface, has ClassifyData/MoveData methods
    - `IAutoGovernance_ShouldExist` -- verify interface, has EnforcePolicy/Audit methods
    - `IFederatedMessageBus_ShouldExtendIMessageBus` -- verify inheritance
    - `FederatedMessageBusBase_ShouldBeAbstract` -- verify abstract class
    - `FederatedMessageBusBase_ShouldDelegateToLocalBus` -- instantiate with TestMessageBus, verify publish/subscribe delegates correctly
    - For each contract: verify it has `[SdkCompatibility]` attribute if applicable

    **File 2: ResilienceContractTests.cs** (~20 tests)
    Test 5 resilience contract interfaces (DataWarehouse.SDK.Contracts.Resilience):
    - `ICircuitBreaker_ShouldExist` -- verify interface with State, ExecuteAsync, Reset methods
    - `IBulkheadIsolation_ShouldExist` -- verify interface with ExecuteAsync, GetAvailableSlots
    - `ITimeoutPolicy_ShouldExist` -- verify interface with ExecuteAsync accepting TimeSpan
    - `IDeadLetterQueue_ShouldExist` -- verify interface with Enqueue/Dequeue/GetCount
    - `IGracefulShutdown_ShouldExist` -- verify interface with ShutdownAsync, RegisterShutdownHandler
    - For each: verify the interface is in the correct namespace

    **File 3: ObservabilityContractTests.cs** (~15 tests)
    Test 4 observability contracts (DataWarehouse.SDK.Contracts.Observability):
    - `ISdkActivitySource_ShouldExist` -- verify interface, has StartActivity method
    - `ICorrelatedLogger_ShouldExist` -- verify interface, has Log methods with correlation ID
    - `IResourceMeter_ShouldExist` -- verify interface, has RecordMetric/GetMetrics methods
    - `IAuditTrail_ShouldExist` -- verify interface, has RecordEntry/QueryEntries methods
    - Test ObservabilityStrategyBase inheritance (should extend StrategyBase per AD-05)
    - Verify PluginBase.CheckHealthAsync exists and returns a health status

    Use reflection for existence/method checks: `typeof(I...).GetMethod("MethodName").Should().NotBeNull()`.
  </action>
  <verify>
    `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter "FullyQualifiedName~DistributedContractTests|FullyQualifiedName~ResilienceContractTests|FullyQualifiedName~ObservabilityContractTests"` -- all pass.
    Count: ~60 new contract verification tests.
  </verify>
  <done>
    All distributed, resilience, and observability contracts verified via reflection tests. Contract structure matches Phase 26 design. Interface methods confirmed present.
  </done>
</task>

<task type="auto">
  <name>Task 2: In-memory implementation integration tests</name>
  <files>
    DataWarehouse.Tests/Infrastructure/InMemoryImplementationTests.cs
  </files>
  <action>
    Create `DataWarehouse.Tests/Infrastructure/InMemoryImplementationTests.cs` with integration tests for all 13 in-memory implementations from Phase 26 (DataWarehouse.SDK.Infrastructure.InMemory).

    Use `[Trait("Category", "Integration")]` for tests that exercise async behavior. All 13 implementations should be tested by direct instantiation (they are in the SDK, no plugin reference needed).

    **InMemoryClusterMembership tests** (~5 tests):
    - Constructor creates single-node cluster with self as member
    - GetLeader returns self
    - GetMembers returns list containing self
    - IsHealthyAsync returns true for self, false for unknown node
    - JoinAsync/LeaveAsync work correctly

    **InMemoryLoadBalancerStrategy tests** (~4 tests):
    - SelectNode returns available node
    - Round-robin distributes across nodes
    - Empty node list handles gracefully

    **InMemoryCircuitBreaker tests** (~6 tests -- state machine is critical):
    - Starts in Closed state
    - Transitions to Open after failure threshold
    - ExecuteAsync in Open state throws/rejects
    - Transitions to HalfOpen after break duration (use small duration like 100ms)
    - Successful execution in HalfOpen returns to Closed
    - Reset forces return to Closed
    - Use `CircuitBreakerOptions` with `FailureThreshold = 2` and `BreakDuration = TimeSpan.FromMilliseconds(100)` for fast tests

    **InMemoryBulkheadIsolation tests** (~4 tests):
    - Allows execution within slot limit
    - Rejects when all slots are in use
    - Releases slot after execution completes
    - GetAvailableSlots reflects current state

    **InMemoryDeadLetterQueue tests** (~4 tests):
    - Enqueue adds message, GetCount reflects
    - Dequeue returns messages in FIFO order
    - Dequeue on empty returns null/empty
    - Queue respects bounded size (per Rule 13 bounded collections)

    **InMemoryP2PNetwork tests** (~3 tests):
    - Can register peers
    - Can discover registered peers
    - Data transfer between peers works

    **InMemoryAutoScaler tests** (~3 tests):
    - GetMetrics returns current metrics
    - ScaleOut/ScaleIn modify node count or state
    - Scaling respects limits

    **InMemoryReplicationSync tests** (~3 tests):
    - Sync between in-memory nodes works
    - GetStatus returns sync state

    **InMemoryAutoTier tests** (~3 tests):
    - ClassifyData assigns tier based on access pattern
    - MoveData between tiers works

    **InMemoryAutoGovernance tests** (~3 tests):
    - EnforcePolicy evaluates rules
    - Audit records policy enforcement events

    **InMemoryFederatedMessageBus tests** (~4 tests):
    - PublishAsync delegates to local bus
    - SubscribeAsync delegates to local bus
    - Round-trip: publish -> subscriber receives message
    - Uses TestMessageBus as the local bus delegate

    **InMemoryAuditTrail tests** (~3 tests):
    - RecordEntry adds audit entry
    - QueryEntries returns matching entries
    - Entries are immutable/append-only

    **InMemoryResourceMeter tests** (~3 tests):
    - RecordMetric stores metric
    - GetMetrics returns recorded metrics
    - Metrics include timestamp

    **IMPORTANT:** Read each InMemory*.cs file before writing tests to understand the actual API surface. The method names and parameters above are based on research -- verify against actual code. Adapt test method calls to match the real implementation signatures.

    Target: 45-55 integration tests covering all 13 implementations.
  </action>
  <verify>
    `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter "FullyQualifiedName~InMemoryImplementationTests"` -- all pass.
    Count: 45-55 new integration tests.
  </verify>
  <done>
    All 13 in-memory distributed implementations have integration tests exercising their core functionality. Circuit breaker state machine fully verified. FederatedMessageBus delegation confirmed. TEST-05 is satisfied.
  </done>
</task>

</tasks>

<verification>
- All 4 test files compile and pass
- Total new test count from this plan: 100-120
- Every Phase 26 SDK type has at least one test
- Circuit breaker state machine has comprehensive state transition coverage
- FederatedMessageBus delegation verified via TestMessageBus
</verification>

<success_criteria>
- TEST-05: Distributed infrastructure contracts have integration tests with in-memory implementations
- All 7 distributed contracts verified (interface existence + method signatures)
- All 5 resilience contracts verified (interface existence + in-memory behavior)
- All 4 observability contracts verified (interface existence + in-memory behavior)
- All 13 in-memory implementations tested with actual behavior (not just instantiation)
- All new tests pass with zero failures
</success_criteria>

<output>
After completion, create `.planning/phases/30-testing-final-verification/30-03-SUMMARY.md`
</output>
