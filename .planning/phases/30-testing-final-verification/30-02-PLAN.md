---
phase: 30-testing-final-verification
plan: 02
type: execute
wave: 2
depends_on: ["30-01"]
files_modified:
  - DataWarehouse.Tests/Infrastructure/StrategyBaseTests.cs
  - DataWarehouse.Tests/Infrastructure/PluginHierarchyTests.cs
  - DataWarehouse.Tests/Infrastructure/DomainStrategyBaseTests.cs
  - DataWarehouse.Tests/Infrastructure/ComposableServicesTests.cs
  - DataWarehouse.Tests/Infrastructure/InputValidationTests.cs
  - DataWarehouse.Tests/Infrastructure/BehavioralEquivalenceTests.cs
autonomous: true

must_haves:
  truths:
    - "StrategyBase lifecycle (Initialize, Shutdown, Dispose) is tested with idempotency and error cases"
    - "Plugin hierarchy two-branch structure (DataPipeline + Feature) is verified by reflection tests"
    - "Domain strategy bases (Encryption, Compression, Storage, etc.) contract methods are tested"
    - "Representative strategies from each domain produce identical results after hierarchy migration"
    - "Composable services (ITierManager, ICacheManager, etc.) and input validation (Guards, SizeLimitOptions) are tested"
  artifacts:
    - path: "DataWarehouse.Tests/Infrastructure/StrategyBaseTests.cs"
      provides: "StrategyBase root class lifecycle and metadata tests"
      min_lines: 80
    - path: "DataWarehouse.Tests/Infrastructure/PluginHierarchyTests.cs"
      provides: "Plugin hierarchy reflection tests (two-branch, domain bases)"
      min_lines: 100
    - path: "DataWarehouse.Tests/Infrastructure/DomainStrategyBaseTests.cs"
      provides: "Domain strategy base contract and reflection tests"
      min_lines: 80
    - path: "DataWarehouse.Tests/Infrastructure/ComposableServicesTests.cs"
      provides: "Composable service interface and input validation tests"
      min_lines: 60
    - path: "DataWarehouse.Tests/Infrastructure/BehavioralEquivalenceTests.cs"
      provides: "Behavioral verification for migrated strategies"
      min_lines: 120
  key_links:
    - from: "DataWarehouse.Tests/Infrastructure/StrategyBaseTests.cs"
      to: "DataWarehouse.SDK/Contracts/StrategyBase.cs"
      via: "typeof and instantiation"
      pattern: "typeof\\(StrategyBase\\)"
    - from: "DataWarehouse.Tests/Infrastructure/PluginHierarchyTests.cs"
      to: "DataWarehouse.SDK/Contracts/Hierarchy/"
      via: "reflection IsSubclassOf checks"
      pattern: "IsSubclassOf"
    - from: "DataWarehouse.Tests/Infrastructure/BehavioralEquivalenceTests.cs"
      to: "Plugin strategy implementations"
      via: "Encrypt/Decrypt, Compress/Decompress round-trip"
      pattern: "(Encrypt|Compress|Store).*Decrypt|Decompress|Retrieve"
---

<objective>
Write new unit tests covering all v2.0 SDK additions: StrategyBase root, plugin hierarchy, domain strategy bases, composable services, input validation, and behavioral equivalence verification for migrated strategies.

Purpose: TEST-02 (new unit tests for base classes) and TEST-03 (behavioral verification) are the two requirements that prove the v2.0 refactoring is correct -- not just compiling, but functioning correctly. These tests are the lasting regression gate.

Output: 6 new test files with ~100-150 new test methods covering all Phase 24-25 SDK additions and representative behavioral verification.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-testing-final-verification/30-RESEARCH.md
@.planning/phases/30-testing-final-verification/30-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unit tests for StrategyBase, plugin hierarchy, domain strategy bases, and composable services</name>
  <files>
    DataWarehouse.Tests/Infrastructure/StrategyBaseTests.cs
    DataWarehouse.Tests/Infrastructure/PluginHierarchyTests.cs
    DataWarehouse.Tests/Infrastructure/DomainStrategyBaseTests.cs
    DataWarehouse.Tests/Infrastructure/ComposableServicesTests.cs
    DataWarehouse.Tests/Infrastructure/InputValidationTests.cs
  </files>
  <action>
    Create 5 new test files in `DataWarehouse.Tests/Infrastructure/`. Use existing test patterns: xUnit v3 `[Fact]`/`[Theory]`, FluentAssertions `.Should()`, `[Trait("Category", "Unit")]` on all tests. Reference SDK types directly (no new plugin references needed).

    **File 1: StrategyBaseTests.cs** (~20 tests)
    Test the StrategyBase root class (DataWarehouse.SDK.Contracts.StrategyBase):
    - `StrategyBase_ShouldBeAbstract` -- verify abstract class
    - `StrategyBase_ShouldImplementIDisposable` and `IAsyncDisposable`
    - `StrategyBase_Initialize_ShouldBeIdempotent` -- create a test concrete subclass, call InitializeAsync twice, verify single init
    - `StrategyBase_Shutdown_BeforeInit_ShouldBeNoOp` -- should not throw
    - `StrategyBase_Dispose_ShouldPreventFurtherUse` -- disposed strategy should throw ObjectDisposedException
    - `StrategyBase_Metadata_ShouldHaveNameAndDescription` -- verify Name, Description properties exist and work
    - `StrategyBase_ShouldNotHaveIntelligenceMethods` -- verify GetStrategyKnowledge, GetStrategyCapability are NOT on the type (AD-05)
    - `StrategyBase_ShouldHaveCancellationTokenSupport` -- verify InitializeAsync/ShutdownAsync accept CancellationToken
    - Create a minimal `TestConcreteStrategy : StrategyBase` helper class within the test file for lifecycle testing (override abstract members minimally)

    **File 2: PluginHierarchyTests.cs** (~25 tests)
    Test the two-branch plugin hierarchy structure (Phase 24 AD-01):
    - `PluginBase_ShouldBeAbstract` and have lifecycle methods
    - `IntelligenceAwarePluginBase_ShouldExtendPluginBase`
    - `DataPipelinePluginBase_ShouldExtendIntelligenceAware`
    - `FeaturePluginBase_ShouldExtendIntelligenceAware` (or NewFeaturePluginBase)
    - `DataPipelinePluginBase_And_FeaturePluginBase_ShouldBeSiblings` -- same parent, different branches
    - For each of the 18 domain plugin bases (7 DataPipeline + 11 Feature), verify correct parent:
      - DataPipeline: EncryptionPluginBase, CompressionPluginBase, StoragePluginBase, ReplicationPluginBase, DataTransitPluginBase, IntegrityPluginBase, DataTransformationPluginBase
      - Feature: SecurityPluginBase, InterfacePluginBase, ComputePluginBase, DataManagementPluginBase, ObservabilityPluginBase, StreamingPluginBase, FormatPluginBase, MediaPluginBase, InfrastructurePluginBase, OrchestrationPluginBase, PlatformPluginBase
    - `PluginBase_ShouldHaveDisposablePattern` -- verify IDisposable + IAsyncDisposable
    - `PluginBase_ShouldHaveCapabilityRegistry` -- verify RegisterCapability/QueryCapability methods
    - `PluginBase_ShouldHaveKnowledgeRegistry` -- verify knowledge cache methods
    - `PluginBase_ShouldHaveThreePhaseInit` -- verify InitializeAsync + ActivateAsync exist
    - `PluginBase_ShouldHaveCheckHealthAsync` -- verify health check method from OBS-03

    **File 3: DomainStrategyBaseTests.cs** (~20 tests)
    Test the domain strategy base classes (Phase 25a):
    - For each of the ~15-20 domain strategy bases, verify:
      - Inherits from StrategyBase (flat two-level per AD-05)
      - Is abstract
      - Has correct domain contract methods (e.g., EncryptionStrategyBase has Encrypt/Decrypt, CompressionStrategyBase has Compress/Decompress)
    - Use reflection: `typeof(X).IsSubclassOf(typeof(StrategyBase)).Should().BeTrue()`
    - Test representative domain bases in detail (at least Encryption, Compression, Storage, Security, Observability)
    - Verify NO domain base has intelligence methods (AD-05 compliance)

    **File 4: ComposableServicesTests.cs** (~12 tests)
    Test composable service interfaces (Phase 24 AD-03):
    - Verify ITierManager, ICacheManager, IStorageIndex, IConnectionRegistry exist as interfaces
    - Verify IObjectStorageCore exists with Store/Retrieve/Delete/List methods (AD-04)
    - Verify PathStorageAdapter implements IObjectStorageCore or correct adapter pattern
    - Verify SdkCompatibilityAttribute exists and can be instantiated with version info

    **File 5: InputValidationTests.cs** (~15 tests)
    Test input validation types (Phase 24 VALID-01 through VALID-05):
    - Guards class: test null checks throw ArgumentNullException, range checks throw ArgumentOutOfRangeException
    - SizeLimitOptions: verify default limits (10MB messages, 1MB knowledge objects per research)
    - Test that Guards methods have clear error messages
    - Verify PluginIdentity type exists with RSA key properties

    All test classes must use `[Trait("Category", "Unit")]`. Use FluentAssertions exclusively (no Assert.X).
  </action>
  <verify>
    `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter "Category=Unit&(FullyQualifiedName~StrategyBaseTests|FullyQualifiedName~PluginHierarchyTests|FullyQualifiedName~DomainStrategyBaseTests|FullyQualifiedName~ComposableServicesTests|FullyQualifiedName~InputValidationTests)"` -- all new tests pass.
    Count new test methods: should be 80-100 new tests.
  </verify>
  <done>
    All 5 test files created. 80+ new unit tests pass. TEST-02 is satisfied: every new/modified base class from Phases 24-25a has test coverage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Behavioral equivalence verification for migrated strategies</name>
  <files>
    DataWarehouse.Tests/Infrastructure/BehavioralEquivalenceTests.cs
  </files>
  <action>
    Create `DataWarehouse.Tests/Infrastructure/BehavioralEquivalenceTests.cs` to verify TEST-03 (REGR-02): migrated strategies produce identical results.

    **Strategy:** Do NOT test all ~1,500 strategies individually (pitfall 3 from research). Instead, test 2-3 representative strategies from each major domain that the test project CAN reference (has ProjectReference). Focus on round-trip correctness.

    **Domains with available ProjectReferences:**
    1. **Encryption** (UltimateEncryption referenced): Test 2-3 encryption strategies
       - Pick concrete strategies (e.g., AesGcmEncryptionStrategy or similar)
       - Test: encrypt(plaintext) -> ciphertext -> decrypt(ciphertext) == plaintext
       - Use a known key and test data
    2. **Storage** (UltimateStorage referenced): Test 2-3 storage strategies
       - Use InMemoryTestStorage helper for backend
       - Test: store(key, data) -> retrieve(key) == data
    3. **RAID** (UltimateRAID referenced): Test 1-2 RAID strategies
       - Test: basic stripe/mirror round-trip if applicable
    4. **Replication** (UltimateReplication referenced): Test 1-2 replication strategies
       - Test: basic replicate/retrieve round-trip
    5. **KeyManagement** (UltimateKeyManagement referenced): Test 1-2 key management strategies
       - Test: key generation, storage, retrieval round-trip
    6. **AccessControl** (UltimateAccessControl referenced): Test 1-2 access control strategies
       - Test: permission grant, check returns true; deny, check returns false
    7. **Compliance** (UltimateCompliance referenced): Test 1-2 compliance strategies
       - Test: policy evaluation round-trip

    For each test:
    - Instantiate the concrete strategy
    - Call InitializeAsync if needed (provide TestMessageBus from Helpers)
    - Execute the core domain operation (encrypt/store/replicate/etc.)
    - Verify the output is correct and round-trips successfully
    - Call Dispose/ShutdownAsync

    Use `[Trait("Category", "Unit")]` for pure in-memory tests. Use `[Trait("Category", "Integration")]` if they need infrastructure (message bus, storage backend).

    **Key constraint:** Do NOT import plugin internals. Instantiate concrete strategies through their public constructors or use TestPluginFactory if applicable. If a strategy's constructor requires complex setup (intelligence socket, etc.), pick a simpler strategy from that domain instead.

    Target: 30-50 behavioral tests across 7 domains.
  </action>
  <verify>
    `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter "FullyQualifiedName~BehavioralEquivalenceTests"` -- all behavioral tests pass.
    Count: should be 30-50 new test methods.
  </verify>
  <done>
    Behavioral equivalence verified for representative strategies across all testable domains. TEST-03 is satisfied: strategies produce identical results after hierarchy migration. Round-trip correctness confirmed for encryption, storage, RAID, replication, key management, access control, and compliance domains.
  </done>
</task>

</tasks>

<verification>
- All new test files compile and pass
- Total new test count from this plan: 100-150
- Combined with 30-01 baseline, total test count significantly exceeds 1,039
- Coverage spans all Phase 24-25 SDK additions (plugin hierarchy, strategy hierarchy, composable services, input validation)
- Behavioral verification covers 7 domains with round-trip tests
</verification>

<success_criteria>
- TEST-02: New unit tests cover all new/modified base classes (StrategyBase, PluginBase hierarchy, domain bases, composable services, input validation)
- TEST-03: Behavioral verification tests confirm representative strategies produce identical results after hierarchy migration across 7 domains
- All new tests pass with zero failures
- Tests follow existing project conventions (xUnit v3, FluentAssertions, Trait categories)
</success_criteria>

<output>
After completion, create `.planning/phases/30-testing-final-verification/30-02-SUMMARY.md`
</output>
