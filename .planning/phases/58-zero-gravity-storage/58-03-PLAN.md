---
phase: 58-zero-gravity-storage
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.SDK/VirtualDiskEngine/VirtualDiskEngine.cs
  - DataWarehouse.SDK/VirtualDiskEngine/Concurrency/StripedWriteLock.cs
  - DataWarehouse.SDK/VirtualDiskEngine/Concurrency/WriteRegion.cs
autonomous: true

must_haves:
  truths:
    - "VDE supports parallel writes to different key ranges"
    - "Single-key writes remain serialized (no corruption)"
    - "SemaphoreSlim(1,1) global lock is replaced with striped locking"
    - "Existing single-threaded correctness is preserved"
  artifacts:
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Concurrency/StripedWriteLock.cs"
      provides: "Lock striping with configurable stripe count"
      exports: ["StripedWriteLock"]
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Concurrency/WriteRegion.cs"
      provides: "IAsyncDisposable region guard for scoped lock"
      exports: ["WriteRegion"]
    - path: "DataWarehouse.SDK/VirtualDiskEngine/VirtualDiskEngine.cs"
      provides: "Updated VDE using StripedWriteLock instead of global SemaphoreSlim(1,1)"
      contains: "StripedWriteLock"
  key_links:
    - from: "VirtualDiskEngine.StoreAsync"
      to: "StripedWriteLock"
      via: "acquires stripe by key hash"
      pattern: "_stripedLock\\.AcquireAsync"
    - from: "StripedWriteLock"
      to: "WriteRegion"
      via: "returns WriteRegion as IAsyncDisposable"
      pattern: "new WriteRegion"
---

<objective>
Replace the global SemaphoreSlim(1,1) write lock in VirtualDiskEngine with a striped lock that allows parallel writes to different key ranges while serializing writes to the same key.

Purpose: The current _writeLock (line 30 in VirtualDiskEngine.cs) is a global mutex that prevents ALL concurrent writes. For a storage engine handling thousands of objects, this is a severe bottleneck. Striped locking allows N concurrent writers (one per stripe) while preserving per-key serialization.
Output: StripedWriteLock class + updated VirtualDiskEngine.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@DataWarehouse.SDK/VirtualDiskEngine/VirtualDiskEngine.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StripedWriteLock and WriteRegion</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/Concurrency/StripedWriteLock.cs
    DataWarehouse.SDK/VirtualDiskEngine/Concurrency/WriteRegion.cs
  </files>
  <action>
Create `DataWarehouse.SDK/VirtualDiskEngine/Concurrency/` directory with 2 files:

**WriteRegion.cs** — namespace `DataWarehouse.SDK.VirtualDiskEngine.Concurrency`:
```csharp
/// Scoped async write region that releases the stripe lock on disposal.
[SdkCompatibility("5.0.0", Notes = "Phase 58: VDE write-path parallelism")]
public readonly struct WriteRegion : IAsyncDisposable
{
    private readonly SemaphoreSlim _semaphore;

    internal WriteRegion(SemaphoreSlim semaphore)
    {
        _semaphore = semaphore;
    }

    public ValueTask DisposeAsync()
    {
        _semaphore.Release();
        return ValueTask.CompletedTask;
    }
}
```

**StripedWriteLock.cs** — namespace `DataWarehouse.SDK.VirtualDiskEngine.Concurrency`:
```csharp
/// Lock striping for VDE write parallelism.
/// Keys are hashed to one of N stripes. Writes to different stripes proceed in parallel.
/// Writes to the same stripe (and therefore same key hash bucket) are serialized.
///
/// Stripe count should be a power of 2 for fast modulo (bitwise AND).
/// Default: 64 stripes, allowing up to 64 concurrent writers.
[SdkCompatibility("5.0.0", Notes = "Phase 58: VDE write-path parallelism")]
public sealed class StripedWriteLock : IAsyncDisposable
{
    private readonly SemaphoreSlim[] _stripes;
    private readonly int _stripeMask;
    private bool _disposed;

    public StripedWriteLock(int stripeCount = 64)
    {
        // Ensure power of 2
        if (stripeCount <= 0 || (stripeCount & (stripeCount - 1)) != 0)
            throw new ArgumentException("Stripe count must be a positive power of 2.", nameof(stripeCount));

        _stripes = new SemaphoreSlim[stripeCount];
        _stripeMask = stripeCount - 1;

        for (int i = 0; i < stripeCount; i++)
            _stripes[i] = new SemaphoreSlim(1, 1);
    }

    public int StripeCount => _stripes.Length;

    /// Acquires the stripe lock for the given key. Returns a WriteRegion that releases on dispose.
    public async ValueTask<WriteRegion> AcquireAsync(string key, CancellationToken ct = default)
    {
        ObjectDisposedException.ThrowIf(_disposed, this);
        int stripe = GetStripe(key);
        await _stripes[stripe].WaitAsync(ct);
        return new WriteRegion(_stripes[stripe]);
    }

    /// Gets the stripe index for a key using FNV-1a hash.
    [MethodImpl(MethodImplOptions.AggressiveInlining)]
    private int GetStripe(string key)
    {
        // FNV-1a hash for good distribution
        uint hash = 2166136261u;
        foreach (char c in key)
        {
            hash ^= (uint)c;
            hash *= 16777619u;
        }
        return (int)(hash & (uint)_stripeMask);
    }

    public ValueTask DisposeAsync()
    {
        if (!_disposed)
        {
            _disposed = true;
            foreach (var s in _stripes)
                s.Dispose();
        }
        return ValueTask.CompletedTask;
    }
}
```

Add `using System.Runtime.CompilerServices;` and `using System.Threading;`.
  </action>
  <verify>dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore --verbosity quiet 2>&1 | tail -3</verify>
  <done>StripedWriteLock and WriteRegion compile. StripedWriteLock has AcquireAsync(string key), FNV-1a hash, configurable stripe count (power-of-2 enforced).</done>
</task>

<task type="auto">
  <name>Task 2: Replace VDE Global Write Lock with Striped Lock</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/VirtualDiskEngine.cs
  </files>
  <action>
Modify VirtualDiskEngine.cs to use StripedWriteLock:

1. Add `using DataWarehouse.SDK.VirtualDiskEngine.Concurrency;` import.

2. Replace field declaration (line 30):
   - OLD: `private readonly SemaphoreSlim _writeLock = new(1, 1);`
   - NEW: `private readonly StripedWriteLock _stripedLock = new(64);`

3. In `StoreAsync` method (around line 206-317): Replace the lock pattern:
   - OLD:
     ```csharp
     await _writeLock.WaitAsync(ct);
     try
     {
         // ... store logic ...
     }
     finally
     {
         _writeLock.Release();
     }
     ```
   - NEW:
     ```csharp
     await using var writeRegion = await _stripedLock.AcquireAsync(key, ct);
     // ... store logic (same as before, just remove the outer try/finally for the lock) ...
     ```
     Keep the inner try/finally for ArrayPool buffer return. Only remove the lock try/finally wrapper.

4. Find ALL other methods that use `_writeLock` (DeleteAsync, any other write methods) and apply the same pattern. For methods that don't have a key parameter (like CheckpointAsync), use a well-known constant key like `"__checkpoint__"` to serialize checkpoints.

5. In `DisposeAsync`, add `await _stripedLock.DisposeAsync();` alongside existing cleanup.

6. The allocator lock inside FreeSpaceManager already serializes block allocation, so the striped lock only needs to protect the WAL transaction + inode + B-tree updates per key. This is safe because:
   - Block allocation has its own lock in FreeSpaceManager
   - WAL transactions are independent per key
   - Inode updates are per-file (different keys = different inodes)
   - B-Tree insertions already handle concurrent access via their internal locking

IMPORTANT: If there is a method-level snapshot or checkpoint that needs global serialization, keep a separate `_globalLock = new SemaphoreSlim(1,1)` for that specific operation only. Do NOT use the global lock for normal writes.
  </action>
  <verify>
dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore --verbosity quiet 2>&1 | tail -3
grep -n "StripedWriteLock\|_stripedLock" DataWarehouse.SDK/VirtualDiskEngine/VirtualDiskEngine.cs
  </verify>
  <done>VirtualDiskEngine uses StripedWriteLock with 64 stripes. StoreAsync acquires per-key stripe. No global SemaphoreSlim(1,1) on the write path. Checkpoint/snapshot operations use separate global lock if needed.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` succeeds
- `grep -c "SemaphoreSlim(1, 1)" DataWarehouse.SDK/VirtualDiskEngine/VirtualDiskEngine.cs` returns 0 or 1 (only for checkpoint, not writes)
- `grep "StripedWriteLock" DataWarehouse.SDK/VirtualDiskEngine/VirtualDiskEngine.cs` returns match
- `dotnet test DataWarehouse.Tests/ --filter VDE --verbosity quiet` passes
</verification>

<success_criteria>
VDE write path uses striped locking. Parallel writes to different keys proceed concurrently. Same-key writes are serialized. Checkpoints/snapshots use separate global lock.
</success_criteria>

<output>
After completion, create `.planning/phases/58-zero-gravity-storage/58-03-SUMMARY.md`
</output>
