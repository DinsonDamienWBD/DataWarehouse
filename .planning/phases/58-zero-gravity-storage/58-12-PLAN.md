---
phase: 58-zero-gravity-storage
plan: 12
type: tdd
wave: 4
depends_on: ["58-02", "58-03", "58-04", "58-05", "58-07", "58-08", "58-09"]
files_modified:
  - DataWarehouse.Tests/Storage/ZeroGravity/CrushPlacementAlgorithmTests.cs
  - DataWarehouse.Tests/Storage/ZeroGravity/SimdBitmapScannerTests.cs
  - DataWarehouse.Tests/Storage/ZeroGravity/StripedWriteLockTests.cs
  - DataWarehouse.Tests/Storage/ZeroGravity/GravityOptimizerTests.cs
  - DataWarehouse.Tests/Storage/ZeroGravity/MigrationEngineTests.cs
  - DataWarehouse.Tests/Storage/ZeroGravity/CostOptimizerTests.cs
autonomous: true

must_haves:
  truths:
    - "CRUSH placement is deterministic (same inputs = same outputs)"
    - "SIMD bitmap scanner finds free blocks correctly"
    - "Striped write lock allows parallel writes to different keys"
    - "Gravity scoring produces expected composite scores"
    - "Migration engine lifecycle (start/pause/resume/cancel) works"
    - "Cost optimizer generates valid recommendations"
  artifacts:
    - path: "DataWarehouse.Tests/Storage/ZeroGravity/CrushPlacementAlgorithmTests.cs"
      provides: "Tests for CRUSH determinism, failure domain separation, constraint filtering"
    - path: "DataWarehouse.Tests/Storage/ZeroGravity/SimdBitmapScannerTests.cs"
      provides: "Tests for SIMD bitmap scanning correctness"
    - path: "DataWarehouse.Tests/Storage/ZeroGravity/StripedWriteLockTests.cs"
      provides: "Tests for concurrent lock acquisition and per-key isolation"
    - path: "DataWarehouse.Tests/Storage/ZeroGravity/GravityOptimizerTests.cs"
      provides: "Tests for gravity scoring dimensions and composite calculation"
    - path: "DataWarehouse.Tests/Storage/ZeroGravity/MigrationEngineTests.cs"
      provides: "Tests for migration lifecycle and read forwarding"
    - path: "DataWarehouse.Tests/Storage/ZeroGravity/CostOptimizerTests.cs"
      provides: "Tests for cost optimization recommendation generation"
  key_links:
    - from: "CrushPlacementAlgorithmTests"
      to: "CrushPlacementAlgorithm"
      via: "tests determinism property"
      pattern: "Assert\\.Equal.*ComputePlacement"
---

<objective>
Comprehensive test suite for all zero-gravity storage components. Tests verify correctness properties: CRUSH determinism, SIMD scanner accuracy, lock isolation, gravity scoring, migration lifecycle, and cost optimization.

Purpose: Zero-gravity storage has critical correctness requirements (determinism, data safety during migration, accurate cost calculations). Tests prove these properties hold.
Output: 6 test files covering all Phase 58 components.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@DataWarehouse.SDK/Storage/Placement/CrushPlacementAlgorithm.cs
@DataWarehouse.SDK/Storage/Placement/GravityAwarePlacementOptimizer.cs
@DataWarehouse.SDK/VirtualDiskEngine/BlockAllocation/SimdBitmapScanner.cs
@DataWarehouse.SDK/VirtualDiskEngine/Concurrency/StripedWriteLock.cs
@DataWarehouse.SDK/Storage/Migration/BackgroundMigrationEngine.cs
@DataWarehouse.SDK/Storage/Billing/StorageCostOptimizer.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: CRUSH, SIMD, and Lock Tests</name>
  <files>
    DataWarehouse.Tests/Storage/ZeroGravity/CrushPlacementAlgorithmTests.cs
    DataWarehouse.Tests/Storage/ZeroGravity/SimdBitmapScannerTests.cs
    DataWarehouse.Tests/Storage/ZeroGravity/StripedWriteLockTests.cs
  </files>
  <action>
Create `DataWarehouse.Tests/Storage/ZeroGravity/` directory with 3 test files.

**CrushPlacementAlgorithmTests.cs** — Tests:
1. `Determinism_SameInputs_ProduceSameOutput` — Call ComputePlacement twice with identical key+map, assert equal node selection
2. `Determinism_DifferentKeys_ProduceDifferentOutput` — Different keys should generally select different primaries (probabilistic, test with 100 keys)
3. `FailureDomainSeparation_ReplicasOnDifferentZones` — 3 replicas across 3 zones should never share a zone
4. `FailureDomainSeparation_ReplicasOnDifferentRacks` — 3 replicas should prefer different racks
5. `ConstraintFiltering_RequiredStorageClass_FiltersNodes` — Require NVMe, only NVMe nodes selected
6. `ConstraintFiltering_RequiredZone_FiltersNodes` — Require zone-eu, only EU nodes selected
7. `MinimalMovement_AddNode_LimitedRedistribution` — Add 1 node to 10-node cluster, verify <20% objects move
8. `MinimalMovement_RemoveNode_OnlyAffectedObjectsMove` — Remove 1 node, verify only its objects relocate
9. `WeightedDistribution_HigherWeightNode_GetsMoreObjects` — 10x weight node should get ~10x objects (test with 1000 objects)

Helper: Create test NodeDescriptor lists with configurable zone/rack/host/weight.

**SimdBitmapScannerTests.cs** — Tests:
1. `FindFirstZeroBit_AllFree_ReturnsZero` — Empty bitmap returns 0
2. `FindFirstZeroBit_AllAllocated_ReturnsNegativeOne` — Full bitmap returns -1
3. `FindFirstZeroBit_MidwayFree_ReturnsCorrectIndex` — First 100 allocated, bit 100 free, returns 100
4. `FindFirstZeroBit_StartOffset_SkipsPrevious` — Free at 50, start from 60, finds next after 60
5. `FindFirstZeroBit_LargeBitmap_Performance` — 10M blocks, verify correct result (not a perf test, just correctness at scale)
6. `FindContiguousZeroBits_ExactMatch_ReturnsStart` — Find 8 contiguous free in mixed bitmap
7. `FindContiguousZeroBits_NoMatch_ReturnsNegativeOne` — Fragmented bitmap with no 8-contiguous run
8. `CountZeroBits_MixedBitmap_ReturnsCorrectCount` — Known bitmap with 50% allocation

**StripedWriteLockTests.cs** — Tests:
1. `AcquireAsync_DifferentKeys_RunConcurrently` — 2 keys acquired simultaneously, both succeed without blocking
2. `AcquireAsync_SameKey_Serialized` — Same key, second acquire blocks until first released
3. `StripeCount_MustBePowerOfTwo` — Constructor with 7 throws ArgumentException
4. `Dispose_ReleasesAllStripes` — Dispose, then verify resources released
5. `WriteRegion_DisposalReleasesLock` — Acquire, dispose region, acquire again succeeds

Use xUnit [Fact] and [Theory] with InlineData. Follow existing test patterns in DataWarehouse.Tests.
  </action>
  <verify>dotnet test DataWarehouse.Tests/ --filter "ZeroGravity" --verbosity quiet 2>&1 | tail -5</verify>
  <done>All CRUSH, SIMD, and lock tests pass. CRUSH determinism verified. SIMD scanner accuracy confirmed. Striped lock concurrency isolation proven.</done>
</task>

<task type="auto">
  <name>Task 2: Gravity, Migration, and Cost Tests</name>
  <files>
    DataWarehouse.Tests/Storage/ZeroGravity/GravityOptimizerTests.cs
    DataWarehouse.Tests/Storage/ZeroGravity/MigrationEngineTests.cs
    DataWarehouse.Tests/Storage/ZeroGravity/CostOptimizerTests.cs
  </files>
  <action>
**GravityOptimizerTests.cs** — Tests:
1. `ComputeGravity_HighAccess_HighScore` — Object with 1000 reads/hr should have high composite score
2. `ComputeGravity_NoAccess_LowScore` — Object with 0 access, no colocation, should have near-zero score
3. `ComputeGravity_ComplianceRegion_FullWeight` — Object in compliance region gets compliance component = 1.0
4. `ComputeGravity_NoProviders_ReturnsDefaultScore` — No metric providers configured, returns mid-range defaults
5. `BatchScoring_ProcessesInParallel` — 100 objects scored in batch, all results returned
6. `OptimizePlacement_HighGravity_PrefersCurrentNode` — Gravity > 0.7, current node promoted to primary
7. `ScoringWeights_Normalization_SumsToOne` — Custom weights normalized correctly
8. `ScoringWeights_Presets_AreValid` — All 4 presets pass IsValid()

**MigrationEngineTests.cs** — Tests:
1. `StartMigration_ReturnsJobWithId` — Start migration, verify job created with valid ID
2. `PauseResume_SetsCorrectStatus` — Pause sets Paused, resume sets InProgress
3. `Cancel_StopsExecution` — Cancel stops migration, status = Cancelled
4. `ReadForwarding_RegisteredDuringMigration` — After object migrated, forwarding table has entry
5. `ReadForwarding_LookupReturnsEntry` — Register forwarding, lookup returns correct target
6. `ReadForwarding_ExpiredEntry_ReturnsNull` — Expired TTL, lookup returns null
7. `Checkpoint_SaveAndRestore` — Save checkpoint, load, verify match
8. `Throttling_RespectsLimit` — Set 1MB/s limit, verify migration doesn't exceed (approximate)

Provide mock data operation delegates for ReadObjectAsync/WriteObjectAsync/DeleteObjectAsync using in-memory dictionaries.

**CostOptimizerTests.cs** — Tests:
1. `GeneratePlan_NoProviders_EmptyRecommendations` — Empty provider list, no recommendations
2. `SpotRecommendations_HighSavings_Included` — Spot pricing with 50% savings generates recommendation
3. `SpotRecommendations_HighRisk_Excluded` — Spot with 50% interruption risk excluded
4. `TierRecommendations_LowAccess_SuggestsCold` — Low access frequency suggests cold tier
5. `ArbitrageRecommendations_SignificantDiff_Included` — 2 providers with 50% price diff generates recommendation
6. `SavingsSummary_CalculatedCorrectly` — Total savings = sum of all recommendation types
7. `BreakEven_ComputedFromImplementationCost` — Break-even days matches implementation cost / daily savings

Create mock IBillingProvider implementations that return predictable test data. Use in-memory data, no actual API calls.
  </action>
  <verify>dotnet test DataWarehouse.Tests/ --filter "ZeroGravity" --verbosity quiet 2>&1 | tail -5</verify>
  <done>All gravity, migration, and cost optimizer tests pass. Full Phase 58 test suite validates correctness of all components.</done>
</task>

</tasks>

<verification>
- `dotnet test DataWarehouse.Tests/ --filter "ZeroGravity" --verbosity quiet` — all tests pass
- Test count >= 40 across 6 test files
- No skipped or failing tests
</verification>

<success_criteria>
Complete test suite validates: CRUSH determinism, SIMD correctness, lock isolation, gravity scoring, migration lifecycle, and cost optimization. All tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/58-zero-gravity-storage/58-12-SUMMARY.md`
</output>
