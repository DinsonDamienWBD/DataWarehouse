---
phase: 67-certification
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/67-certification/67-02-SECURITY-AUDIT.md
autonomous: true

must_haves:
  truths:
    - "All 50 v4.5 pentest findings have been re-verified as resolved"
    - "AccessEnforcementInterceptor is wired and enforcing on the message bus"
    - "All distributed protocols (Raft, SWIM, CRDT) require authentication"
    - "No TLS certificate validation bypasses exist in production code paths"
    - "No path traversal vulnerabilities exist in storage strategies"
    - "JWT secrets are not hardcoded and env detection is robust"
    - "Plugin loading validates signatures before execution"
    - "Security score is assessed against 100/100 target"
  artifacts:
    - path: ".planning/phases/67-certification/67-02-SECURITY-AUDIT.md"
      provides: "Complete security re-assessment with score"
      contains: "Security Score"
  key_links:
    - from: "AccessEnforcementInterceptor"
      to: "DataWarehouseKernel message bus"
      via: "Bus subscription/enforcement"
      pattern: "AccessEnforcement"
    - from: "Raft/SWIM/CRDT strategies"
      to: "IAuthenticatedMessageBus"
      via: "Authenticated message channels"
      pattern: "IAuthenticated"
---

<objective>
Hostile security re-assessment of the entire v5.0 codebase against the v4.5 pentest baseline.

Purpose: Verify ALL 50 penetration test findings from v4.5 are resolved, discover any NEW vulnerabilities introduced by v5.0 phases (55-66), and produce a security score targeting 100/100.
Output: `.planning/phases/67-certification/67-02-SECURITY-AUDIT.md`
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/51-certification-authority/v4.5-CERTIFICATION.md
@.planning/phases/53-security-wiring/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Re-verify All 50 v4.5 Pentest Findings</name>
  <files>.planning/phases/67-certification/67-02-SECURITY-AUDIT.md</files>
  <action>
    Perform a hostile re-assessment of every security finding from the v4.5 certification:

    **A. Re-verify all 13 P0 items:**

    P0-1: AccessEnforcementInterceptor -- search for its registration in DataWarehouseKernel, verify it subscribes to bus topics and enforces ACL. Check it is NOT dead code. Trace call path from message publish -> interceptor -> enforcement decision.

    P0-2/3/4: Distributed protocol auth -- verify Raft, SWIM, and CRDT implementations require IAuthenticatedMessageBus. Search for unauthenticated Accept/Connect patterns. Check each protocol for: (a) connection authentication, (b) message signing, (c) replay protection.

    P0-5: GrpcStorageStrategy TLS -- verify the `return true` ServerCertificateValidationCallback is removed or replaced with proper validation. Search for `ServerCertificateCustomValidationCallback` across entire codebase.

    P0-6: FtpTransitStrategy TLS -- verify `ValidateAnyCertificate=true` is removed. Search for `ValidateAnyCertificate` and `ValidateCertificate` patterns.

    P0-7/8: SMB/WebDAV path traversal -- verify Path.GetFullPath prefix checks exist. Search for `..` traversal prevention in all storage strategies (not just SMB/WebDAV).

    P0-9: JWT hardcoded secret -- verify development secret detection is robust. Search for hardcoded keys, "development", "changeme", default secrets across all auth code.

    P0-10: Plugin loading security -- verify PluginLoader validates assemblies before loading. Search for signature verification, hash checking, or allowlist patterns.

    P0-11: Brotli Q11 -- verify compression quality is configurable (not security, but was P0).

    P0-12: ORSet tag pruning -- verify GC/pruning mechanism exists (was P0).

    P0-13: Placeholder tests -- count remaining `Assert.True(true)` or equivalent placeholder patterns.

    **B. New vulnerability scan for v5.0 code (Phases 55-66):**

    Scan ALL new code added in v5.0 moonshot phases for:
    - Hardcoded secrets, API keys, passwords
    - SQL injection (if any raw SQL)
    - Command injection (Process.Start, Runtime.exec patterns)
    - Deserialization vulnerabilities (BinaryFormatter, TypeNameHandling)
    - Unsafe cryptography (MD5/SHA1 for security, ECB mode, static IVs)
    - Missing input validation on public APIs
    - Unvalidated redirects
    - SSRF in any URL-accepting code
    - Race conditions in security-critical paths
    - Certificate pinning bypasses

    **C. Produce security score:**

    Score methodology (100 points max):
    - Access Control wired and enforcing: 20 pts
    - Distributed protocol authentication: 15 pts
    - TLS validation correct everywhere: 10 pts
    - Path traversal prevention: 10 pts
    - Secret management: 10 pts
    - Plugin security: 5 pts
    - No new vulnerabilities in v5.0 code: 15 pts
    - Input validation coverage: 10 pts
    - Crypto hygiene (no weak algorithms): 5 pts

    Write `.planning/phases/67-certification/67-02-SECURITY-AUDIT.md` with:
    - Executive summary with security score (/100)
    - Table re-verifying all 50 findings (Finding ID | Original | Status | Evidence)
    - New findings from v5.0 scan (if any)
    - Score breakdown
    - Comparison to v4.5 baseline (38/100)
    - PASS/FAIL verdict
    - If any CRITICAL/HIGH findings remain: remediation plan
  </action>
  <verify>
    Grep for known vulnerability patterns (ValidateAnyCertificate, return true.*Certificate, Assert.True(true)) confirms fixes are in place. Audit document contains score and per-finding verdicts.
  </verify>
  <done>
    67-02-SECURITY-AUDIT.md exists with: security score, all 50 findings re-verified, v5.0 new code scanned, PASS/FAIL verdict. Score reflects actual code state, not aspirational claims.
  </done>
</task>

</tasks>

<verification>
- All 50 v4.5 findings have a re-verification status
- Security score is calculated from actual evidence
- New v5.0 code has been scanned for vulnerabilities
- Document contains remediation plan if any FAIL items found
</verification>

<success_criteria>
Security re-assessment produces an evidence-based score. Every finding is verified by searching actual source code, not by trusting phase summaries. New v5.0 code is scanned with the same rigor as the original pentest.
</success_criteria>

<output>
After completion, create `.planning/phases/67-certification/67-02-SUMMARY.md`
</output>
