---
phase: 03-security-infrastructure
plan: 07
type: execute
wave: 2
depends_on: ["03-03"]
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/ThreatDetection/*.cs
  - Metadata/TODO.md
autonomous: true

must_haves:
  truths:
    - "All 9 threat detection strategies detect and respond to security threats"
    - "UebaStrategy sends message bus request to 'intelligence.analyze' topic and falls back to rule-based Z-score anomaly detection on timeout/failure"
    - "ThreatIntelStrategy sends message bus request to 'intelligence.enrich' topic and falls back to STIX/TAXII feed consumption on timeout/failure"
    - "All 9 strategy classes compile with zero forbidden patterns"
    - "T95 B7 items in TODO.md are marked [x]"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/ThreatDetection/"
      provides: "9 threat detection strategies"
  key_links:
    - from: "UebaStrategy"
      to: "Intelligence plugin (T90)"
      via: "Message bus request to 'intelligence.analyze' topic"
      pattern: "_messageBus\\.RequestAsync.*intelligence\\.analyze"
    - from: "UebaStrategy"
      to: "Rule-based fallback"
      via: "Fallback when message bus response fails (Success==false or timeout)"
      pattern: "if.*!.*Success|catch.*TimeoutException"
    - from: "ThreatIntelStrategy"
      to: "Intelligence plugin (T90)"
      via: "Message bus request to 'intelligence.enrich' topic"
      pattern: "_messageBus\\.RequestAsync.*intelligence\\.enrich"
    - from: "ThreatIntelStrategy"
      to: "Rule-based fallback"
      via: "Fallback to STIX/TAXII feed + IoC matching when AI unavailable"
      pattern: "if.*!.*Success|catch.*TimeoutException"
---

<objective>
Implement all 9 threat detection strategies (T95.B7) for UltimateAccessControl, with explicit message bus wiring and rule-based fallbacks for AI-dependent strategies.

Purpose: Threat detection is the runtime security monitoring layer. Two strategies (B7.4 UEBA, B7.9 ThreatIntel) delegate ML workloads to the Intelligence plugin (T90) via message bus and MUST have rule-based fallbacks when T90 is unavailable.
Output: 9 threat detection strategy implementations with verified AI delegation + fallback patterns.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-security-infrastructure/03-RESEARCH.md
@Metadata/CLAUDE.md
@.planning/phases/03-security-infrastructure/03-03-SUMMARY.md
@Plugins/DataWarehouse.Plugins.UltimateAccessControl/IAccessControlStrategy.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement 9 threat detection strategies with AI wiring (T95.B7)</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/ThreatDetection/ThreatDetectionStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/ThreatDetection/SiemIntegrationStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/ThreatDetection/SoarStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/ThreatDetection/UebaStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/ThreatDetection/NdRStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/ThreatDetection/EdRStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/ThreatDetection/XdRStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/ThreatDetection/HoneypotStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/ThreatDetection/ThreatIntelStrategy.cs
    Metadata/TODO.md
  </files>
  <action>
CRITICAL: B7 strategies that delegate to AI MUST use explicit message bus wiring with rule-based fallbacks.

1. Check existing: Strategies/Honeypot/ already has CanaryStrategy.cs and DeceptionNetworkStrategy.cs. These may overlap with B7.8. Read and decide whether to reuse or create separate.

2. Create Strategies/ThreatDetection/ directory.

3. Implement standard B7 strategies (no AI dependency):

   **B7.1 ThreatDetectionStrategy** - Generic threat detection engine:
   - Anomaly scoring based on configurable rules
   - Threat level escalation (Low, Medium, High, Critical)
   - Alert generation and routing

   **B7.2 SiemIntegrationStrategy** - SIEM integration:
   - Syslog (CEF, LEEF) event forwarding
   - REST API integration for Splunk/Sentinel
   - Structured log formatting

   **B7.3 SoarStrategy** - Security orchestration and response:
   - Playbook-based incident response
   - Automated containment actions
   - Integration with ticketing systems

   **B7.5 NdRStrategy** - Network Detection and Response:
   - Network traffic pattern analysis
   - Protocol anomaly detection
   - Lateral movement detection

   **B7.6 EdRStrategy** - Endpoint Detection and Response:
   - Process monitoring patterns
   - File integrity monitoring
   - Registry/config change detection

   **B7.7 XdRStrategy** - Extended Detection and Response:
   - Cross-domain correlation (network + endpoint + identity)
   - Unified threat timeline
   - Automated investigation workflows

   **B7.8 HoneypotStrategy** - Deception technology:
   - Check existing Honeypot/CanaryStrategy.cs -- may already cover this
   - If not: decoy resource deployment, access monitoring, attacker profiling

4. Implement AI-DEPENDENT B7 strategies WITH EXPLICIT WIRING:

   **B7.4 UebaStrategy** - User/Entity Behavior Analytics:
   MUST implement the following message bus wiring pattern:
   ```
   // Step 1: Send request to Intelligence plugin via message bus
   var aiResponse = await _messageBus.RequestAsync<AnalysisResult>(
       topic: "intelligence.analyze",
       request: new AnalysisRequest
       {
           DataType = "user-behavior",
           Payload = behaviorProfile,
           AnalysisType = "anomaly-detection"
       },
       timeout: TimeSpan.FromSeconds(10),
       ct: cancellationToken
   );

   // Step 2: Fallback when AI unavailable
   if (!aiResponse.Success)
   {
       _logger.LogWarning("Intelligence plugin unavailable for UEBA, using rule-based fallback");
       return await RuleBasedAnomalyDetectionAsync(behaviorProfile, ct);
   }
   ```
   - Rule-based fallback: Z-score anomaly detection on login time, location, frequency
   - Baseline behavior profiling using in-memory sliding window
   - Deviation scoring with configurable thresholds

   **B7.9 ThreatIntelStrategy** - Threat intelligence feeds:
   MUST implement the following message bus wiring pattern:
   ```
   // Step 1: Send request to Intelligence plugin for AI enrichment
   var aiResponse = await _messageBus.RequestAsync<EnrichmentResult>(
       topic: "intelligence.enrich",
       request: new EnrichmentRequest
       {
           DataType = "threat-indicator",
           Indicators = indicators,
           EnrichmentType = "threat-correlation"
       },
       timeout: TimeSpan.FromSeconds(10),
       ct: cancellationToken
   );

   // Step 2: Fallback when AI unavailable
   if (!aiResponse.Success)
   {
       _logger.LogWarning("Intelligence plugin unavailable for threat enrichment, using rule-based fallback");
       return await RuleBasedThreatMatchingAsync(indicators, ct);
   }
   ```
   - Rule-based fallback: STIX/TAXII feed consumption, IoC hash/IP/domain matching
   - Threat feed management and correlation

5. Build project.

6. Update Metadata/TODO.md:
   - Mark T95.B7.1 through B7.9 as [x]
  </action>
  <verify>
`dotnet build` succeeds.
9 threat detection strategy files exist in Strategies/ThreatDetection/.
Grep UebaStrategy.cs for "intelligence.analyze" -- MUST find a match.
Grep UebaStrategy.cs for fallback pattern (Success check or catch) -- MUST find a match.
Grep ThreatIntelStrategy.cs for "intelligence.enrich" -- MUST find a match.
Grep ThreatIntelStrategy.cs for fallback pattern -- MUST find a match.
TODO.md T95.B7 items all marked [x].
  </verify>
  <done>
9 threat detection strategies implemented with verified AI delegation + fallback patterns.
T95 B7 (9 items) marked [x] in TODO.md.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` succeeds for UltimateAccessControl project
2. 9 threat detection strategy files in Strategies/ThreatDetection/
3. UebaStrategy has message bus call to "intelligence.analyze" with rule-based fallback
4. ThreatIntelStrategy has message bus call to "intelligence.enrich" with rule-based fallback
5. No forbidden patterns in any file
6. TODO.md B7 items all [x]
</verification>

<success_criteria>
- All 9 strategies implemented and building
- AI-dependent strategies (B7.4, B7.9) have explicit message bus wiring + rule-based fallback
- Plugin builds cleanly
- TODO.md T95 B7 fully synced
</success_criteria>

<output>
After completion, create `.planning/phases/03-security-infrastructure/03-07-SUMMARY.md`
</output>
