---
phase: 03-security-infrastructure
plan: 04
type: execute
wave: 2
depends_on: ["03-03"]
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Identity/*.cs
  - Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Mfa/*.cs
  - Metadata/TODO.md
autonomous: true

must_haves:
  truths:
    - "All 10 identity strategies authenticate users via their respective protocols"
    - "All 8 MFA strategies provide second-factor verification"
    - "Identity strategies degrade gracefully when external services are unavailable"
    - "T95 B3 and B4 items in TODO.md are marked [x]"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Identity/"
      provides: "10 identity provider strategy implementations"
    - path: "Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Mfa/"
      provides: "8 MFA strategy implementations"
  key_links:
    - from: "Identity strategies"
      to: "UltimateAccessControlPlugin orchestrator"
      via: "IAccessControlStrategy auto-discovery"
      pattern: "IIdentityStrategy|IAccessControlStrategy"
    - from: "MFA strategies"
      to: "Identity strategies"
      via: "Post-authentication MFA challenge"
      pattern: "IMfaStrategy"
---

<objective>
Implement all 10 identity strategies (T95.B3) and all 8 MFA strategies (T95.B4) for UltimateAccessControl.

Purpose: Identity and MFA are core to access control. This plan implements IAM, LDAP, OAuth2, OIDC, SAML, Kerberos, RADIUS, TACACS+, SCIM, FIDO2 identity providers plus TOTP, HOTP, SMS OTP, Email OTP, Push, Biometric, HardwareToken, SmartCard MFA strategies.
Output: 18 new strategy implementations covering identity and MFA.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-security-infrastructure/03-RESEARCH.md
@Metadata/CLAUDE.md
@.planning/phases/03-security-infrastructure/03-03-SUMMARY.md
@Plugins/DataWarehouse.Plugins.UltimateAccessControl/IAccessControlStrategy.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement 10 identity strategies (T95.B3)</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Identity/IamStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Identity/LdapStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Identity/OAuth2Strategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Identity/OidcStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Identity/SamlStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Identity/KerberosStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Identity/RadiusStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Identity/TacacsStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Identity/ScimStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Identity/Fido2Strategy.cs
  </files>
  <action>
CRITICAL WORKFLOW RULES:
- Rule 13: No simulations, mocks, stubs, placeholders -- everything production-ready
- Plugin isolation: plugins reference ONLY SDK via ProjectReference
- All communication via message bus (no direct plugin references)
- Base classes mandatory: use appropriate strategy base class
- Verify before implementing: check if FederatedIdentityStrategy.cs already covers some

1. First check what exists: FederatedIdentityStrategy.cs is in Core/ -- read it to see if it covers OAuth2/OIDC/SAML.

2. Create Strategies/Identity/ directory if it does not exist.

3. Implement each strategy. All must:
   - Implement IAccessControlStrategy (or IIdentityStrategy if defined in SDK)
   - Have StrategyId matching the pattern (e.g., "identity-oauth2")
   - Include IsAvailableAsync() to detect if the protocol's infrastructure is reachable
   - Provide real protocol integration (not stubs)
   - Handle timeouts and connection failures gracefully
   - Include XML documentation

   **B3.1 IamStrategy** - Generic IAM framework with configurable user/role stores
   **B3.2 LdapStrategy** - LDAP/Active Directory using System.DirectoryServices.Protocols
   **B3.3 OAuth2Strategy** - OAuth 2.0 token validation (see research code example)
   **B3.4 OidcStrategy** - OpenID Connect discovery + token validation
   **B3.5 SamlStrategy** - SAML 2.0 assertion parsing and validation
   **B3.6 KerberosStrategy** - Kerberos ticket validation (SPNEGO/GSSAPI)
   **B3.7 RadiusStrategy** - RADIUS authentication (Access-Request/Accept/Reject)
   **B3.8 TacacsStrategy** - TACACS+ authentication protocol
   **B3.9 ScimStrategy** - SCIM 2.0 user provisioning and identity sync
   **B3.10 Fido2Strategy** - FIDO2/WebAuthn credential verification

4. Build: `dotnet build` on UltimateAccessControl project.
  </action>
  <verify>
`dotnet build` succeeds. All 10 identity strategy .cs files exist in Strategies/Identity/.
No forbidden patterns (grep for NotImplementedException, simulation, mock, stub).
  </verify>
  <done>
All 10 identity strategies (IAM, LDAP, OAuth2, OIDC, SAML, Kerberos, RADIUS, TACACS+, SCIM, FIDO2) implemented and compiling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement 8 MFA strategies (T95.B4) and sync TODO.md</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Mfa/TotpStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Mfa/HotpStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Mfa/SmsOtpStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Mfa/EmailOtpStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Mfa/PushNotificationStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Mfa/BiometricStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Mfa/HardwareTokenStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Mfa/SmartCardStrategy.cs
    Metadata/TODO.md
  </files>
  <action>
CRITICAL: Rule 13 applies -- these must be real MFA implementations, not simulations.

1. Create Strategies/Mfa/ directory if it does not exist.

2. Implement each MFA strategy:

   **B4.1 TotpStrategy** - Time-based OTP (RFC 6238):
   - HMAC-SHA1/SHA256/SHA512 with configurable period (default 30s)
   - Time window tolerance (1 step drift)
   - Replay protection (store last used time step)
   - QR code URI generation for authenticator apps
   - See research code example for pattern

   **B4.2 HotpStrategy** - HMAC-based OTP (RFC 4226):
   - Counter-based OTP generation and validation
   - Counter synchronization with look-ahead window
   - Resynchronization protocol

   **B4.3 SmsOtpStrategy** - SMS-based OTP:
   - Code generation (6-8 digits, cryptographically random)
   - Rate limiting (max attempts, cooldown period)
   - Expiration (configurable TTL, default 5 min)
   - Message bus integration to send SMS via notification plugin

   **B4.4 EmailOtpStrategy** - Email-based OTP:
   - Same pattern as SMS but via email channel
   - HTML and plaintext templates
   - Rate limiting and expiration

   **B4.5 PushNotificationStrategy** - Push MFA:
   - Challenge creation with context (IP, location, device)
   - Approve/deny response handling
   - Timeout with automatic deny
   - Message bus integration for push delivery

   **B4.6 BiometricStrategy** - Biometric auth:
   - Template comparison interface (fingerprint, face, iris)
   - Fuzzy matching with configurable threshold
   - Hardware detection (IsAvailableAsync)
   - Privacy: never store raw biometric data, only templates

   **B4.7 HardwareTokenStrategy** - Hardware tokens (YubiKey):
   - FIDO2/U2F challenge-response
   - OTP validation (Yubico OTP mode)
   - Hardware detection via USB/NFC

   **B4.8 SmartCardStrategy** - Smart card/PIV:
   - X.509 certificate extraction from smart card
   - Certificate chain validation
   - PIN verification interface
   - PKCS#11 session management

3. Build: `dotnet build` on UltimateAccessControl project.

4. Update Metadata/TODO.md:
   - Mark T95.B3.1 through B3.10 as [x] (lines ~8098-8107)
   - Mark T95.B4.1 through B4.8 as [x] (lines ~8109-8116)
  </action>
  <verify>
`dotnet build` succeeds. All 8 MFA strategy .cs files exist in Strategies/Mfa/.
TODO.md T95.B3 and B4 items all marked [x].
  </verify>
  <done>
All 8 MFA strategies implemented and compiling.
T95 B3 (10 items) and B4 (8 items) = 18 items marked [x] in TODO.md.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` succeeds for UltimateAccessControl project
2. 10 identity strategy files in Strategies/Identity/
3. 8 MFA strategy files in Strategies/Mfa/
4. No forbidden patterns in any strategy file
5. TODO.md B3+B4 items all [x]
</verification>

<success_criteria>
- All 10 identity strategies are production-ready implementations
- All 8 MFA strategies are production-ready implementations
- Plugin builds cleanly
- TODO.md T95 B3+B4 fully synced
</success_criteria>

<output>
After completion, create `.planning/phases/03-security-infrastructure/03-04-SUMMARY.md`
</output>
