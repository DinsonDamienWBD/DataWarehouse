---
phase: 03-security-infrastructure
plan: 05
type: execute
wave: 2
depends_on: ["03-03"]
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Mfa/*.cs
  - Metadata/TODO.md
autonomous: true

must_haves:
  truths:
    - "All 8 MFA strategies provide second-factor verification with real cryptographic implementations"
    - "TOTP strategy implements RFC 6238 with time-window tolerance and replay protection"
    - "All 8 MFA strategy classes compile with zero forbidden patterns"
    - "T95 B4 items in TODO.md are marked [x]"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Mfa/"
      provides: "8 MFA strategy implementations"
  key_links:
    - from: "MFA strategies"
      to: "Identity strategies"
      via: "Post-authentication MFA challenge"
      pattern: "IMfaStrategy"
    - from: "MFA strategies"
      to: "UltimateAccessControlPlugin orchestrator"
      via: "IAccessControlStrategy auto-discovery"
      pattern: "IAccessControlStrategy"
---

<objective>
Implement all 8 MFA strategies (T95.B4) for UltimateAccessControl.

Purpose: MFA strategies provide second-factor authentication. This plan implements TOTP, HOTP, SMS OTP, Email OTP, Push, Biometric, HardwareToken, SmartCard MFA strategies.
Output: 8 MFA strategy implementations.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-security-infrastructure/03-RESEARCH.md
@Metadata/CLAUDE.md
@.planning/phases/03-security-infrastructure/03-03-SUMMARY.md
@Plugins/DataWarehouse.Plugins.UltimateAccessControl/IAccessControlStrategy.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement 8 MFA strategies (T95.B4) and sync TODO.md</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Mfa/TotpStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Mfa/HotpStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Mfa/SmsOtpStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Mfa/EmailOtpStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Mfa/PushNotificationStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Mfa/BiometricStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Mfa/HardwareTokenStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Mfa/SmartCardStrategy.cs
    Metadata/TODO.md
  </files>
  <action>
CRITICAL: Rule 13 applies -- these must be real MFA implementations, not simulations.

1. Create Strategies/Mfa/ directory if it does not exist.

2. Implement each MFA strategy:

   **B4.1 TotpStrategy** - Time-based OTP (RFC 6238):
   - HMAC-SHA1/SHA256/SHA512 with configurable period (default 30s)
   - Time window tolerance (1 step drift)
   - Replay protection (store last used time step)
   - QR code URI generation for authenticator apps
   - See research code example for pattern

   **B4.2 HotpStrategy** - HMAC-based OTP (RFC 4226):
   - Counter-based OTP generation and validation
   - Counter synchronization with look-ahead window
   - Resynchronization protocol

   **B4.3 SmsOtpStrategy** - SMS-based OTP:
   - Code generation (6-8 digits, cryptographically random)
   - Rate limiting (max attempts, cooldown period)
   - Expiration (configurable TTL, default 5 min)
   - Message bus integration to send SMS via notification plugin

   **B4.4 EmailOtpStrategy** - Email-based OTP:
   - Same pattern as SMS but via email channel
   - HTML and plaintext templates
   - Rate limiting and expiration

   **B4.5 PushNotificationStrategy** - Push MFA:
   - Challenge creation with context (IP, location, device)
   - Approve/deny response handling
   - Timeout with automatic deny
   - Message bus integration for push delivery

   **B4.6 BiometricStrategy** - Biometric auth:
   - Template comparison interface (fingerprint, face, iris)
   - Fuzzy matching with configurable threshold
   - Hardware detection (IsAvailableAsync)
   - Privacy: never store raw biometric data, only templates

   **B4.7 HardwareTokenStrategy** - Hardware tokens (YubiKey):
   - FIDO2/U2F challenge-response
   - OTP validation (Yubico OTP mode)
   - Hardware detection via USB/NFC

   **B4.8 SmartCardStrategy** - Smart card/PIV:
   - X.509 certificate extraction from smart card
   - Certificate chain validation
   - PIN verification interface
   - PKCS#11 session management

3. Build: `dotnet build` on UltimateAccessControl project.

4. Update Metadata/TODO.md:
   - Mark T95.B4.1 through B4.8 as [x]
  </action>
  <verify>
`dotnet build` succeeds. All 8 MFA strategy .cs files exist in Strategies/Mfa/.
TODO.md T95.B4 items all marked [x].
  </verify>
  <done>
All 8 MFA strategies implemented, compiling, and synced in TODO.md.
T95 B4 (8 items) marked [x] in TODO.md.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` succeeds for UltimateAccessControl project
2. 8 MFA strategy files in Strategies/Mfa/
3. No forbidden patterns in any strategy file
4. TODO.md B4 items all [x]
</verification>

<success_criteria>
- All 8 MFA strategies are production-ready implementations
- Plugin builds cleanly
- TODO.md T95 B4 fully synced
</success_criteria>

<output>
After completion, create `.planning/phases/03-security-infrastructure/03-05-SUMMARY.md`
</output>
