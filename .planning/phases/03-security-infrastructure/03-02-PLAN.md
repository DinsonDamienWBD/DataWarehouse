---
phase: 03-security-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateKeyManagement/**/*.cs
  - Tests/**/*KeyManagement*.cs
  - Metadata/TODO.md
autonomous: true

must_haves:
  truths:
    - "Unit tests for key management SDK extensions compile and pass"
    - "Envelope mode integration tests verify WrapKey/UnwrapKey roundtrip succeeds"
    - "Envelope mode benchmarks produce timing data comparing Direct vs Envelope performance"
    - "TamperProof encryption integration tests compile and pass"
    - "UltimateKeyManagement plugin builds with zero errors and zero forbidden patterns"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateKeyManagement/UltimateKeyManagementPlugin.cs"
      provides: "Key management orchestrator"
      contains: "UltimateKeyManagementPlugin"
    - path: "Tests/"
      provides: "Key management unit and integration tests"
  key_links:
    - from: "UltimateKeyManagementPlugin.cs"
      to: "IEnvelopeKeyStore"
      via: "Strategy implementations"
      pattern: "IEnvelopeKeyStore"
---

<objective>
Verify UltimateKeyManagement plugin (T94) and complete the 4 remaining test/benchmark items: 94.A5 (SDK extension tests), 94.D2 (envelope integration tests), 94.D4 (envelope benchmarks), 94.E7 (TamperProof integration tests).

Purpose: T94 has all 65 strategies implemented and production-ready. Only tests and benchmarks remain. This plan completes those and fully closes T94.
Output: Complete T94 with all tests passing and TODO.md synced.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@Metadata/CLAUDE.md
@Plugins/DataWarehouse.Plugins.UltimateKeyManagement/UltimateKeyManagementPlugin.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify T94 strategies and implement remaining tests</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateKeyManagement/**/*.cs
    Tests/DataWarehouse.Tests/UltimateKeyManagement/KeyManagementTests.cs
  </files>
  <action>
CRITICAL WORKFLOW RULES:
- Primary task source: Metadata/Incomplete Tasks.txt (all [ ]/[~] items already extracted)
- Only use Metadata/TODO.md for MARKING tasks complete (search exact line, change [ ] to [x])
- Rule 13: No simulations, mocks, stubs, placeholders -- everything production-ready
- Plugin isolation: plugins reference ONLY SDK via ProjectReference
- Base classes mandatory: never implement interfaces directly, always use *StrategyBase
- Verify before implementing: Many tasks may already be done but TODO.md is out of sync

1. Verify UltimateKeyManagement plugin builds: `dotnet build` on the project.

2. Scan ALL strategy files for forbidden patterns (same list as T93):
   - NotImplementedException, simulation/mock/stub, empty bodies, Console.Write, TODO comments
   - Fix any found.

3. Implement the 4 incomplete items:

   **94.A5 - Unit tests for key management extensions:**
   - Find the test project (look in Tests/ directory for existing key management test files)
   - Add unit tests for IKeyStoreStrategy extensions from T94.A3-A4
   - Test key migration utilities, strategy-specific extensions
   - Use Stopwatch-based benchmarks (not BenchmarkDotNet -- per STATE.md decision)

   **94.D2 - Envelope mode integration tests:**
   - Write integration tests that verify WrapKeyAsync/UnwrapKeyAsync roundtrip
   - Test with at least FileKeyStoreStrategy (local, always available)
   - Test the envelope encryption flow: generate DEK -> wrap with KEK -> unwrap -> verify match
   - Use AES-GCM for key wrapping in tests (per STATE.md decision)

   **94.D4 - Envelope mode benchmarks:**
   - Write Stopwatch-based benchmarks comparing Direct key mode vs Envelope key mode
   - Measure: key retrieval time, encryption time with each mode, total roundtrip
   - Output benchmark results to test output / console

   **94.E7 - TamperProof encryption integration tests:**
   - Write tests that verify encryption works through the TamperProof manifest flow
   - Test EncryptionMetadata in TamperProofManifest (verify E1-E6 items work)
   - Test write-time config resolution and read-time config from manifest

4. Run all new tests and confirm they pass.
  </action>
  <verify>
Run: `dotnet build` on UltimateKeyManagement project -- succeeds.
Run: `dotnet test` on the test project containing key management tests -- all pass.
  </verify>
  <done>
All 4 remaining T94 items (A5, D2, D4, E7) are implemented with passing tests.
  </done>
</task>

<task type="auto">
  <name>Task 2: Sync T94 status in TODO.md</name>
  <files>Metadata/TODO.md</files>
  <action>
1. Open Metadata/TODO.md and navigate to the T94 EXPANDED section (around lines 9437-9629).
2. Find lines for 94.A5, 94.D2, 94.D4, 94.E7 -- currently marked [ ].
3. Change each to [x] now that tests are implemented.
4. Update the Task 94 Summary table:
   - Phase A: change from "[~] 4/5" to "[x] 5/5 Complete"
   - Phase D: change from "[~] 6/8" to "[x] 8/8 Complete"
   - Phase E: change from "[~] 6/7" to "[x] 7/7 Complete"
5. Verify the overall Task 94 status line says "[x] COMPLETE"
  </action>
  <verify>
Grep T94 section of TODO.md for remaining `[ ]` items -- should find zero.
Task 94 summary shows all phases as [x] Complete.
  </verify>
  <done>
T94 fully complete in TODO.md: all phases marked [x] Complete, zero [ ] items remain.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` succeeds for UltimateKeyManagement project
2. All new tests pass (A5, D2, D4, E7)
3. TODO.md T94 section fully synced with zero [ ] items
</verification>

<success_criteria>
- UltimateKeyManagement plugin builds cleanly
- 4 new test/benchmark items implemented and passing
- TODO.md T94 section is 100% [x]
</success_criteria>

<output>
After completion, create `.planning/phases/03-security-infrastructure/03-02-SUMMARY.md`
</output>
