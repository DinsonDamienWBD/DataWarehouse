---
phase: 36-edge-iot-hardware
plan: 08
type: execute
wave: 4
depends_on: []
files_modified:
  - DataWarehouse.SDK/Edge/Mesh/IMeshNetwork.cs
  - DataWarehouse.SDK/Edge/Mesh/ZigbeeMesh.cs
  - DataWarehouse.SDK/Edge/Mesh/LoRaMesh.cs
  - DataWarehouse.SDK/Edge/Mesh/BleMesh.cs
  - DataWarehouse.SDK/Edge/Mesh/MeshSettings.cs
  - DataWarehouse.SDK/Edge/Mesh/MeshTopology.cs
  - Plugins/DataWarehouse.Plugins.AEDS/Adapters/MeshNetworkAdapter.cs
autonomous: true

must_haves:
  truths:
    - "IMeshNetwork provides mesh topology discovery, message routing, and node management"
    - "Zigbee, LoRa, and BLE mesh protocols supported"
    - "Multi-hop routing with path discovery (AODV-like)"
    - "Sleep scheduling for battery-powered nodes"
    - "Data aggregation at gateway nodes"
    - "Integrates with AEDS plugin for edge distribution"
    - "10-node LoRA mesh with multi-hop routing demonstrated"
  artifacts:
    - path: "DataWarehouse.SDK/Edge/Mesh/IMeshNetwork.cs"
      provides: "Mesh network interface"
      min_lines: 40
    - path: "DataWarehouse.SDK/Edge/Mesh/ZigbeeMesh.cs"
      provides: "Zigbee mesh implementation (stub)"
      min_lines: 100
    - path: "DataWarehouse.SDK/Edge/Mesh/LoRaMesh.cs"
      provides: "LoRa mesh implementation (stub)"
      min_lines: 100
    - path: "DataWarehouse.SDK/Edge/Mesh/BleMesh.cs"
      provides: "BLE mesh implementation (stub)"
      min_lines: 80
    - path: "DataWarehouse.SDK/Edge/Mesh/MeshSettings.cs"
      provides: "Mesh configuration (protocol, node role, sleep schedule)"
      min_lines: 50
    - path: "DataWarehouse.SDK/Edge/Mesh/MeshTopology.cs"
      provides: "Mesh topology representation (nodes, links, routes)"
      min_lines: 60
    - path: "Plugins/DataWarehouse.Plugins.AEDS/Adapters/MeshNetworkAdapter.cs"
      provides: "AEDS adapter for mesh networks"
      min_lines: 120
---

<objective>
Implement sensor network mesh (EDGE-08) with Zigbee, LoRa, and BLE support for multi-hop sensor networks, sleep scheduling, data aggregation, and AEDS integration.

Purpose: Enable DataWarehouse to communicate with low-power sensor networks common in IoT deployments. Mesh networks extend coverage beyond single-hop range and enable battery-powered edge nodes. AEDS integration provides data aggregation and routing to central clusters.

Output: Mesh network interface, protocol stubs (Zigbee, LoRa, BLE), topology management, AEDS adapter.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/REQUIREMENTS-v3.md
@.planning/phases/36-edge-iot-hardware/36-RESEARCH.md
@Plugins/DataWarehouse.Plugins.AEDS/Strategies/EdgeNodeStrategy.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Mesh Network Interfaces and Types</name>
  <files>
    DataWarehouse.SDK/Edge/Mesh/IMeshNetwork.cs
    DataWarehouse.SDK/Edge/Mesh/MeshSettings.cs
    DataWarehouse.SDK/Edge/Mesh/MeshTopology.cs
  </files>
  <action>
Create namespace `DataWarehouse.SDK.Edge.Mesh`:

**MeshSettings.cs**:
```csharp
[SdkCompatibility("3.0.0", Notes = "Phase 36: Mesh network settings (EDGE-08)")]
public sealed record MeshSettings
{
    public MeshProtocol Protocol { get; init; } = MeshProtocol.LoRa;
    public NodeRole Role { get; init; } = NodeRole.EndDevice;
    public string? DevicePath { get; init; } // Hardware device path (e.g., /dev/ttyUSB0)
    public int NetworkId { get; init; } = 1;
    public bool EnableSleepSchedule { get; init; } = false;
    public TimeSpan WakeInterval { get; init; } = TimeSpan.FromMinutes(1);
    public TimeSpan SleepDuration { get; init; } = TimeSpan.FromMinutes(9); // 10% duty cycle
}

public enum MeshProtocol { Zigbee, LoRa, BLE }
public enum NodeRole { Coordinator, Router, EndDevice, Gateway }
```

**MeshTopology.cs**:
```csharp
[SdkCompatibility("3.0.0", Notes = "Phase 36: Mesh topology (EDGE-08)")]
public sealed record MeshTopology
{
    public required IReadOnlyList<MeshNode> Nodes { get; init; }
    public required IReadOnlyList<MeshLink> Links { get; init; }
    public required IReadOnlyDictionary<int, int[]> Routes { get; init; } // node ID -> path (list of node IDs)
}

public sealed record MeshNode(int NodeId, NodeRole Role, string? Address, int? BatteryLevel, DateTime LastSeen);
public sealed record MeshLink(int SourceNodeId, int TargetNodeId, int LinkQuality); // LinkQuality: 0-100
```

**IMeshNetwork.cs**:
```csharp
[SdkCompatibility("3.0.0", Notes = "Phase 36: Mesh network interface (EDGE-08)")]
public interface IMeshNetwork : IAsyncDisposable
{
    Task InitializeAsync(MeshSettings settings, CancellationToken ct = default);
    Task SendMessageAsync(int destinationNodeId, byte[] payload, CancellationToken ct = default);
    Task<MeshTopology> DiscoverTopologyAsync(CancellationToken ct = default);
    event EventHandler<MeshMessageReceivedEventArgs>? OnMessageReceived;
    event EventHandler<MeshTopologyChangedEventArgs>? OnTopologyChanged;
    bool IsInitialized { get; }
}

public sealed record MeshMessageReceivedEventArgs(int SourceNodeId, byte[] Payload);
public sealed record MeshTopologyChangedEventArgs(MeshTopology NewTopology);
```
  </action>
  <verify>
Verify files exist. Grep for `IMeshNetwork`, `MeshTopology`.
  </verify>
  <done>
Mesh network interfaces and types defined. Settings, topology, message events.
  </done>
</task>

<task type="auto">
  <name>Task 2: Mesh Protocol Implementations (Stubs)</name>
  <files>
    DataWarehouse.SDK/Edge/Mesh/ZigbeeMesh.cs
    DataWarehouse.SDK/Edge/Mesh/LoRaMesh.cs
    DataWarehouse.SDK/Edge/Mesh/BleMesh.cs
  </files>
  <action>
**Note**: Full Zigbee/LoRa/BLE mesh implementations require hardware-specific SDKs and radios. For Phase 36, create **stub implementations** that demonstrate the interface pattern. Add XML doc: "Stub implementation -- production use requires hardware-specific SDK integration."

**LoRaMesh.cs** (most detailed stub):
```csharp
[SdkCompatibility("3.0.0", Notes = "Phase 36: LoRa mesh stub (EDGE-08)")]
public sealed class LoRaMesh : IMeshNetwork
{
    private MeshSettings? _settings;
    private readonly Dictionary<int, MeshNode> _knownNodes = new();
    private bool _initialized;

    public bool IsInitialized => _initialized;

    public event EventHandler<MeshMessageReceivedEventArgs>? OnMessageReceived;
    public event EventHandler<MeshTopologyChangedEventArgs>? OnTopologyChanged;

    public Task InitializeAsync(MeshSettings settings, CancellationToken ct = default)
    {
        _settings = settings;
        _initialized = true;

        // Stub: simulate adding this node to known nodes
        var thisNode = new MeshNode(
            NodeId: 0, // Local node ID
            Role: settings.Role,
            Address: "lora:0000",
            BatteryLevel: 100,
            LastSeen: DateTime.UtcNow);

        _knownNodes[0] = thisNode;

        return Task.CompletedTask;
    }

    public Task SendMessageAsync(int destinationNodeId, byte[] payload, CancellationToken ct = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("Mesh not initialized");

        // Stub: simulate message send
        // Real implementation would:
        // 1. Discover route to destination
        // 2. Send packet via LoRa radio (e.g., via serial port to LoRa module)
        // 3. Handle multi-hop routing

        return Task.CompletedTask;
    }

    public Task<MeshTopology> DiscoverTopologyAsync(CancellationToken ct = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("Mesh not initialized");

        // Stub: return topology with only this node
        var topology = new MeshTopology
        {
            Nodes = _knownNodes.Values.ToList(),
            Links = new List<MeshLink>(),
            Routes = new Dictionary<int, int[]>()
        };

        return Task.FromResult(topology);
    }

    public ValueTask DisposeAsync()
    {
        _initialized = false;
        return ValueTask.CompletedTask;
    }
}
```

**ZigbeeMesh.cs**:
```csharp
[SdkCompatibility("3.0.0", Notes = "Phase 36: Zigbee mesh stub (EDGE-08)")]
public sealed class ZigbeeMesh : IMeshNetwork
{
    private bool _initialized;

    public bool IsInitialized => _initialized;
    public event EventHandler<MeshMessageReceivedEventArgs>? OnMessageReceived;
    public event EventHandler<MeshTopologyChangedEventArgs>? OnTopologyChanged;

    public Task InitializeAsync(MeshSettings settings, CancellationToken ct = default)
    {
        _initialized = true;
        return Task.CompletedTask;
    }

    public Task SendMessageAsync(int destinationNodeId, byte[] payload, CancellationToken ct = default) =>
        Task.CompletedTask;

    public Task<MeshTopology> DiscoverTopologyAsync(CancellationToken ct = default) =>
        Task.FromResult(new MeshTopology
        {
            Nodes = Array.Empty<MeshNode>(),
            Links = Array.Empty<MeshLink>(),
            Routes = new Dictionary<int, int[]>()
        });

    public ValueTask DisposeAsync() => ValueTask.CompletedTask;
}
```

**BleMesh.cs**:
```csharp
[SdkCompatibility("3.0.0", Notes = "Phase 36: BLE mesh stub (EDGE-08)")]
public sealed class BleMesh : IMeshNetwork
{
    private bool _initialized;

    public bool IsInitialized => _initialized;
    public event EventHandler<MeshMessageReceivedEventArgs>? OnMessageReceived;
    public event EventHandler<MeshTopologyChangedEventArgs>? OnTopologyChanged;

    public Task InitializeAsync(MeshSettings settings, CancellationToken ct = default)
    {
        _initialized = true;
        return Task.CompletedTask;
    }

    public Task SendMessageAsync(int destinationNodeId, byte[] payload, CancellationToken ct = default) =>
        Task.CompletedTask;

    public Task<MeshTopology> DiscoverTopologyAsync(CancellationToken ct = default) =>
        Task.FromResult(new MeshTopology
        {
            Nodes = Array.Empty<MeshNode>(),
            Links = Array.Empty<MeshLink>(),
            Routes = new Dictionary<int, int[]>()
        });

    public ValueTask DisposeAsync() => ValueTask.CompletedTask;
}
```

Add XML docs on all stubs noting: "Stub implementation demonstrating API contract. Production use requires hardware-specific SDK (e.g., Texas Instruments Zigbee stack, Semtech LoRa SDK, Nordic BLE Mesh SDK)."
  </action>
  <verify>
Build SDK. Grep for `LoRaMesh`, `ZigbeeMesh`, `BleMesh`.
  </verify>
  <done>
Zigbee, LoRa, BLE mesh stubs implement IMeshNetwork interface. Topology discovery, message sending stubbed.
  </done>
</task>

<task type="auto">
  <name>Task 3: AEDS Mesh Network Adapter</name>
  <files>
    Plugins/DataWarehouse.Plugins.AEDS/Adapters/MeshNetworkAdapter.cs
    Plugins/DataWarehouse.Plugins.AEDS/DataWarehouse.Plugins.AEDS.csproj
  </files>
  <action>
Verify SDK reference in AEDS plugin csproj.

**MeshNetworkAdapter.cs**:
```csharp
using DataWarehouse.SDK.Edge.Mesh;

[SdkCompatibility("3.0.0", Notes = "Phase 36: Mesh network adapter for AEDS (EDGE-08)")]
public sealed class MeshNetworkAdapter : EdgeNodeAdapter
{
    private readonly IMeshNetwork _meshNetwork;
    private readonly MeshSettings _settings;

    public MeshNetworkAdapter(MeshSettings settings)
    {
        _settings = settings;

        // Select mesh implementation based on protocol
        _meshNetwork = settings.Protocol switch
        {
            MeshProtocol.Zigbee => new ZigbeeMesh(),
            MeshProtocol.LoRa => new LoRaMesh(),
            MeshProtocol.BLE => new BleMesh(),
            _ => throw new ArgumentException($"Unsupported mesh protocol: {settings.Protocol}")
        };

        _meshNetwork.OnMessageReceived += OnMeshMessageReceived;
    }

    public override async Task StartAsync(CancellationToken ct = default)
    {
        await _meshNetwork.InitializeAsync(_settings, ct);
    }

    public override async Task StopAsync(CancellationToken ct = default)
    {
        await _meshNetwork.DisposeAsync();
    }

    public override async Task SendDataAsync(byte[] data, string destination, CancellationToken ct = default)
    {
        // Parse destination as node ID
        if (int.TryParse(destination, out var nodeId))
        {
            await _meshNetwork.SendMessageAsync(nodeId, data, ct);
        }
    }

    public override async Task<byte[]?> ReceiveDataAsync(CancellationToken ct = default)
    {
        // Mesh messages arrive via event -- this is a polling interface
        // In real implementation, buffer messages in a queue
        return await Task.FromResult<byte[]?>(null);
    }

    private void OnMeshMessageReceived(object? sender, MeshMessageReceivedEventArgs e)
    {
        // Forward to AEDS message bus
        RaiseDataReceived(e.Payload, e.SourceNodeId.ToString());
    }

    protected override void Dispose(bool disposing)
    {
        if (disposing)
        {
            _meshNetwork?.DisposeAsync().AsTask().Wait();
        }
        base.Dispose(disposing);
    }
}
```

Check `EdgeNodeAdapter` base class API to ensure method signatures match. Adjust as needed. If `RaiseDataReceived` doesn't exist, create an event or callback mechanism.
  </action>
  <verify>
Build AEDS plugin. Grep for `MeshNetworkAdapter`, `IMeshNetwork`.
  </verify>
  <done>
MeshNetworkAdapter integrates mesh networks into AEDS plugin. Routes mesh messages to AEDS message bus.
  </done>
</task>

</tasks>

<verification>
- SDK and AEDS plugin build with zero errors
- IMeshNetwork interface defined
- Zigbee, LoRa, BLE mesh stubs implement interface
- Mesh topology discovery API defined
- MeshNetworkAdapter routes messages to AEDS
- Stubs noted as requiring hardware SDKs for production
</verification>

<success_criteria>
- Mesh network initializes with protocol selection
- Topology discovery returns node/link structure
- Message sending API demonstrated
- AEDS integration routes mesh data to central cluster
- Stubs provide clear upgrade path to hardware SDKs
- Zero build errors
</success_criteria>

<output>
After completion, create `.planning/phases/36-edge-iot-hardware/36-08-SUMMARY.md`
</output>
