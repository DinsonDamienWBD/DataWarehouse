---
phase: 36-edge-iot-hardware
plan: 07
type: execute
wave: 4
depends_on: []
files_modified:
  - DataWarehouse.SDK/Edge/Camera/ICameraDevice.cs
  - DataWarehouse.SDK/Edge/Camera/CameraFrameGrabber.cs
  - DataWarehouse.SDK/Edge/Camera/FrameBuffer.cs
  - DataWarehouse.SDK/Edge/Camera/CameraSettings.cs
  - Plugins/DataWarehouse.Plugins.UltimateMedia/Strategies/CameraFrameSource.cs
  - DataWarehouse.SDK/DataWarehouse.SDK.csproj
autonomous: true

must_haves:
  truths:
    - "ICameraDevice abstracts USB, CSI, and IP cameras"
    - "CameraFrameGrabber captures frames with configurable resolution, pixel format, frame rate"
    - "FrameBuffer provides zero-copy access to captured frames"
    - "Integrates with UltimateMedia plugin as frame source"
    - "Resolution/format change without device reopen"
    - "Capture 30fps 1080p from USB camera"
  artifacts:
    - path: "DataWarehouse.SDK/Edge/Camera/ICameraDevice.cs"
      provides: "Camera device interface"
      min_lines: 30
    - path: "DataWarehouse.SDK/Edge/Camera/CameraFrameGrabber.cs"
      provides: "Frame capture with V4L2/DirectShow/OpenCV"
      min_lines: 200
    - path: "DataWarehouse.SDK/Edge/Camera/FrameBuffer.cs"
      provides: "Zero-copy frame buffer"
      min_lines: 60
    - path: "DataWarehouse.SDK/Edge/Camera/CameraSettings.cs"
      provides: "Camera configuration (resolution, pixel format, fps)"
      min_lines: 40
    - path: "Plugins/DataWarehouse.Plugins.UltimateMedia/Strategies/CameraFrameSource.cs"
      provides: "UltimateMedia strategy for camera frames"
      min_lines: 100
---

<objective>
Implement camera/media frame grabber (EDGE-07) with USB/CSI/IP camera support, zero-copy frame access, and UltimateMedia plugin integration for on-device video processing.

Purpose: Enable DataWarehouse to capture video frames from connected cameras for surveillance, object detection, and media processing on edge devices.

Output: Camera device abstraction, frame grabber, zero-copy buffer, UltimateMedia integration.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/REQUIREMENTS-v3.md
@.planning/phases/36-edge-iot-hardware/36-RESEARCH.md
@Plugins/DataWarehouse.Plugins.UltimateMedia/Strategies/VideoStreamStrategy.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Camera Interfaces and Types</name>
  <files>
    DataWarehouse.SDK/Edge/Camera/ICameraDevice.cs
    DataWarehouse.SDK/Edge/Camera/CameraSettings.cs
    DataWarehouse.SDK/Edge/Camera/FrameBuffer.cs
  </files>
  <action>
Create namespace `DataWarehouse.SDK.Edge.Camera`:

**CameraSettings.cs**:
```csharp
[SdkCompatibility("3.0.0", Notes = "Phase 36: Camera settings (EDGE-07)")]
public sealed record CameraSettings
{
    public int Width { get; init; } = 1920;
    public int Height { get; init; } = 1080;
    public PixelFormat PixelFormat { get; init; } = PixelFormat.RGB24;
    public int FrameRate { get; init; } = 30;
    public string? DevicePath { get; init; } // /dev/video0 on Linux, device index on Windows
}

public enum PixelFormat { RGB24, RGBA32, YUV420, MJPEG }
```

**FrameBuffer.cs**:
```csharp
[SdkCompatibility("3.0.0", Notes = "Phase 36: Camera frame buffer (EDGE-07)")]
public sealed class FrameBuffer : IDisposable
{
    private readonly byte[] _data;
    private readonly int _width;
    private readonly int _height;
    private readonly PixelFormat _format;

    public FrameBuffer(byte[] data, int width, int height, PixelFormat format)
    {
        _data = data;
        _width = width;
        _height = height;
        _format = format;
    }

    public ReadOnlySpan<byte> Data => _data;
    public int Width => _width;
    public int Height => _height;
    public PixelFormat Format => _format;
    public long Timestamp { get; init; }

    public void Dispose() { /* No-op -- caller owns buffer */ }
}
```

**ICameraDevice.cs**:
```csharp
[SdkCompatibility("3.0.0", Notes = "Phase 36: Camera device interface (EDGE-07)")]
public interface ICameraDevice : IAsyncDisposable
{
    Task OpenAsync(CameraSettings settings, CancellationToken ct = default);
    Task CloseAsync(CancellationToken ct = default);
    Task<FrameBuffer?> CaptureFrameAsync(CancellationToken ct = default);
    Task UpdateSettingsAsync(CameraSettings settings, CancellationToken ct = default);
    bool IsOpen { get; }
    CameraSettings CurrentSettings { get; }
}
```
  </action>
  <verify>
Verify files exist. Grep for `ICameraDevice`, `FrameBuffer`.
  </verify>
  <done>
Camera interfaces and types defined. Zero-copy frame buffer, configurable settings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Camera Frame Grabber Implementation</name>
  <files>
    DataWarehouse.SDK/Edge/Camera/CameraFrameGrabber.cs
    DataWarehouse.SDK/DataWarehouse.SDK.csproj
  </files>
  <action>
**Decision**: Use OpenCvSharp4 NuGet package for cross-platform camera access (wraps OpenCV VideoCapture). This avoids platform-specific V4L2/DirectShow P/Invoke.

Add NuGet: `<PackageReference Include="OpenCvSharp4" Version="4.10.0" />` and `<PackageReference Include="OpenCvSharp4.runtime.linux" Version="4.10.0" />` (or runtime.win for Windows).

**CameraFrameGrabber.cs**:
```csharp
using OpenCvSharp;

[SdkCompatibility("3.0.0", Notes = "Phase 36: Camera frame grabber (EDGE-07)")]
public sealed class CameraFrameGrabber : ICameraDevice
{
    private VideoCapture? _capture;
    private CameraSettings? _currentSettings;
    private Mat? _frameMat;

    public bool IsOpen => _capture?.IsOpened() ?? false;
    public CameraSettings CurrentSettings => _currentSettings ?? throw new InvalidOperationException("Camera not open");

    public Task OpenAsync(CameraSettings settings, CancellationToken ct = default)
    {
        // Parse device path as integer index (0, 1, 2, etc.) or use 0 as default
        var deviceIndex = int.TryParse(settings.DevicePath, out var idx) ? idx : 0;

        _capture = new VideoCapture(deviceIndex);
        if (!_capture.IsOpened())
        {
            throw new InvalidOperationException($"Failed to open camera device {deviceIndex}");
        }

        _capture.Set(VideoCaptureProperties.FrameWidth, settings.Width);
        _capture.Set(VideoCaptureProperties.FrameHeight, settings.Height);
        _capture.Set(VideoCaptureProperties.Fps, settings.FrameRate);

        _currentSettings = settings;
        _frameMat = new Mat();

        return Task.CompletedTask;
    }

    public Task CloseAsync(CancellationToken ct = default)
    {
        _capture?.Release();
        _capture?.Dispose();
        _frameMat?.Dispose();
        _capture = null;
        _frameMat = null;
        _currentSettings = null;
        return Task.CompletedTask;
    }

    public Task<FrameBuffer?> CaptureFrameAsync(CancellationToken ct = default)
    {
        if (_capture is null || _frameMat is null)
            throw new InvalidOperationException("Camera not open");

        var success = _capture.Read(_frameMat);
        if (!success || _frameMat.Empty())
            return Task.FromResult<FrameBuffer?>(null);

        // Convert Mat to byte array (zero-copy if possible, otherwise copy)
        var data = new byte[_frameMat.Total() * _frameMat.ElemSize()];
        System.Runtime.InteropServices.Marshal.Copy(_frameMat.Data, data, 0, data.Length);

        var frameBuffer = new FrameBuffer(
            data,
            _frameMat.Width,
            _frameMat.Height,
            _currentSettings!.PixelFormat)
        {
            Timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds()
        };

        return Task.FromResult<FrameBuffer?>(frameBuffer);
    }

    public Task UpdateSettingsAsync(CameraSettings settings, CancellationToken ct = default)
    {
        if (_capture is null)
            throw new InvalidOperationException("Camera not open");

        _capture.Set(VideoCaptureProperties.FrameWidth, settings.Width);
        _capture.Set(VideoCaptureProperties.FrameHeight, settings.Height);
        _capture.Set(VideoCaptureProperties.Fps, settings.FrameRate);

        _currentSettings = settings;
        return Task.CompletedTask;
    }

    public async ValueTask DisposeAsync()
    {
        await CloseAsync();
    }
}
```

Add XML docs. Note: OpenCvSharp4 provides cross-platform camera access. For production, consider platform-specific optimizations (V4L2 on Linux, DirectShow on Windows).
  </action>
  <verify>
Build SDK. Grep for `OpenCvSharp`, `VideoCapture`.
  </verify>
  <done>
Camera frame grabber using OpenCvSharp4. Captures frames, updates settings, zero-copy buffer access.
  </done>
</task>

<task type="auto">
  <name>Task 3: UltimateMedia Integration</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateMedia/Strategies/CameraFrameSource.cs
    Plugins/DataWarehouse.Plugins.UltimateMedia/DataWarehouse.Plugins.UltimateMedia.csproj
  </files>
  <action>
Verify SDK reference in UltimateMedia plugin csproj.

**CameraFrameSource.cs**:
```csharp
using DataWarehouse.SDK.Edge.Camera;

[SdkCompatibility("3.0.0", Notes = "Phase 36: Camera frame source strategy (EDGE-07)")]
public sealed class CameraFrameSource : MediaStrategy
{
    private readonly ICameraDevice _camera;
    private readonly CameraSettings _settings;

    public CameraFrameSource(CameraSettings settings)
    {
        _settings = settings;
        _camera = new CameraFrameGrabber();
    }

    public override async Task StartAsync(CancellationToken ct = default)
    {
        await _camera.OpenAsync(_settings, ct);
    }

    public override async Task StopAsync(CancellationToken ct = default)
    {
        await _camera.CloseAsync(ct);
    }

    public override async Task<byte[]?> CaptureFrameAsync(CancellationToken ct = default)
    {
        var frameBuffer = await _camera.CaptureFrameAsync(ct);
        return frameBuffer?.Data.ToArray();
    }

    protected override void Dispose(bool disposing)
    {
        if (disposing)
        {
            _camera?.DisposeAsync().AsTask().Wait();
        }
        base.Dispose(disposing);
    }
}
```

Check `MediaStrategy` base class API to ensure method signatures match. Adjust as needed.
  </action>
  <verify>
Build UltimateMedia plugin. Grep for `CameraFrameGrabber`.
  </verify>
  <done>
CameraFrameSource integrates camera into UltimateMedia plugin. Start/stop camera, capture frames.
  </done>
</task>

</tasks>

<verification>
- SDK and UltimateMedia plugin build with zero errors
- OpenCvSharp4 NuGet package referenced
- Camera opens, captures frames, updates settings
- Zero-copy frame buffer access
- CameraFrameSource extends MediaStrategy
</verification>

<success_criteria>
- Capture 30fps 1080p from USB camera
- Zero-copy frame buffer access
- Resolution/format change without device reopen
- Frames saved to VDE container via UltimateMedia
- Zero build errors
</success_criteria>

<output>
After completion, create `.planning/phases/36-edge-iot-hardware/36-07-SUMMARY.md`
</output>
