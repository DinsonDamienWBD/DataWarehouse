---
phase: 79-file-extension-os-integration
plan: 02
type: execute
wave: 2
depends_on: ["79-01"]
files_modified:
  - DataWarehouse.SDK/VirtualDiskEngine/FileExtension/OsIntegration/WindowsProgId.cs
  - DataWarehouse.SDK/VirtualDiskEngine/FileExtension/OsIntegration/WindowsShellHandler.cs
  - DataWarehouse.SDK/VirtualDiskEngine/FileExtension/OsIntegration/WindowsRegistryBuilder.cs
autonomous: true

must_haves:
  truths:
    - "Windows ProgID 'DataWarehouse.DwvdFile' is generated with Open, Inspect, and Verify shell verbs pointing to dw CLI"
    - "Registry .reg file can be exported for manual or automated installation"
    - "Shell handlers produce correct command lines: 'dw open \"%1\"', 'dw inspect \"%1\"', 'dw verify \"%1\"'"
    - "All secondary extensions get their own ProgID entries referencing the primary handler"
  artifacts:
    - path: "DataWarehouse.SDK/VirtualDiskEngine/FileExtension/OsIntegration/WindowsProgId.cs"
      provides: "ProgID model with FriendlyTypeName, icon, verbs, MIME association"
      contains: "DataWarehouse.DwvdFile"
    - path: "DataWarehouse.SDK/VirtualDiskEngine/FileExtension/OsIntegration/WindowsShellHandler.cs"
      provides: "Shell verb definitions (open, inspect, verify) with dw CLI command templates"
      exports: ["GetShellVerbs", "GetCommandLine"]
    - path: "DataWarehouse.SDK/VirtualDiskEngine/FileExtension/OsIntegration/WindowsRegistryBuilder.cs"
      provides: "Builds .reg file content and PowerShell registration script"
      exports: ["BuildRegFile", "BuildPowerShellScript"]
  key_links:
    - from: "WindowsProgId"
      to: "DwvdMimeType"
      via: "References MimeType and PrimaryExtension constants"
      pattern: "DwvdMimeType\\.MimeType"
    - from: "WindowsRegistryBuilder"
      to: "SecondaryExtensions"
      via: "Iterates all secondary extensions for registry entries"
      pattern: "SecondaryExtensions\\."
---

<objective>
Create Windows ProgID registration model with shell handlers for Open, Inspect, and Verify commands via the `dw` CLI tool.

Purpose: Enables Windows users to double-click .dwvd files to open them, right-click to inspect (display metadata) or verify (integrity check) via the DataWarehouse CLI. Generates both .reg files for manual import and PowerShell scripts for automated deployment.

Output: Three files in `OsIntegration` sub-namespace handling ProgID modeling, shell verb definitions, and registry file generation.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@DataWarehouse.SDK/VirtualDiskEngine/FileExtension/DwvdMimeType.cs
@DataWarehouse.SDK/VirtualDiskEngine/FileExtension/SecondaryExtension.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: ProgID model and shell verb definitions</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/FileExtension/OsIntegration/WindowsProgId.cs
    DataWarehouse.SDK/VirtualDiskEngine/FileExtension/OsIntegration/WindowsShellHandler.cs
  </files>
  <action>
Create new directory `DataWarehouse.SDK/VirtualDiskEngine/FileExtension/OsIntegration/`.

**WindowsProgId.cs**: Class in namespace `DataWarehouse.SDK.VirtualDiskEngine.FileExtension.OsIntegration`. Add `[SdkCompatibility("6.0.0", Notes = "Phase 79: Windows ProgID (FEXT-02)")]`. Readonly struct `WindowsProgId` with:
- `ProgId` string constant = "DataWarehouse.DwvdFile"
- `FriendlyTypeName` = "DataWarehouse Virtual Disk"
- `ContentType` referencing `DwvdMimeType.MimeType`
- `PerceivedType` = "document"
- `DefaultIcon` = "%ProgramFiles%\\DataWarehouse\\dw.exe,0" (configurable via property)
- `static WindowsProgId CreatePrimary()` -- creates ProgID for .dwvd
- `static WindowsProgId CreateForSecondary(SecondaryExtensionKind kind)` -- creates ProgID for secondary extensions (e.g., "DataWarehouse.DwvdSnapshot" for .dwvd.snap)
- `string Extension` property -- the file extension this ProgID maps to
- `IReadOnlyList<WindowsShellVerb> ShellVerbs` property -- verbs for this ProgID

**WindowsShellHandler.cs**: Readonly struct `WindowsShellVerb` with `Name` (string), `DisplayName` (string), `CommandTemplate` (string), `IsDefault` (bool). Static class `WindowsShellHandler` with:
- `GetPrimaryVerbs()` returning 3 verbs:
  1. Open (default): `"dw open \"%1\""` with display name "&Open with DataWarehouse"
  2. Inspect: `"dw inspect \"%1\""` with display name "&Inspect Metadata"
  3. Verify: `"dw verify \"%1\""` with display name "&Verify Integrity"
- `GetSecondaryVerbs(SecondaryExtensionKind kind)` returning appropriate verbs per secondary type:
  - .snap: Open + Inspect (no verify -- snapshots are read-only)
  - .delta: Open + Inspect
  - .meta: Inspect only
  - .lock: Inspect only
- `GetCommandLine(string verb, string dwCliPath)` -- resolves command template with actual CLI path
- All command templates use `\"%1\"` for the file path argument (Windows shell convention)
  </action>
  <verify>Build with `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore` -- no errors.</verify>
  <done>WindowsProgId.CreatePrimary() returns ProgID "DataWarehouse.DwvdFile" with 3 shell verbs (Open/Inspect/Verify). Secondary extensions have their own ProgIDs with appropriate verb subsets.</done>
</task>

<task type="auto">
  <name>Task 2: Registry file and PowerShell script builder</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/FileExtension/OsIntegration/WindowsRegistryBuilder.cs
  </files>
  <action>
**WindowsRegistryBuilder.cs**: Static class in namespace `DataWarehouse.SDK.VirtualDiskEngine.FileExtension.OsIntegration`. Add `[SdkCompatibility("6.0.0", Notes = "Phase 79: Windows registry builder (FEXT-02)")]`.

Methods:
- `string BuildRegFile(string dwCliPath = "dw")` -- generates a complete Windows .reg file (UTF-16LE with BOM, Windows Registry Editor Version 5.00 header) containing:
  - HKCR\.dwvd -> "DataWarehouse.DwvdFile" (default value), ContentType, PerceivedType
  - HKCR\DataWarehouse.DwvdFile -> FriendlyTypeName, shell verbs with command lines
  - HKCR\DataWarehouse.DwvdFile\DefaultIcon -> icon path
  - Secondary extensions: HKCR\.dwvd.snap, HKCR\.dwvd.delta, HKCR\.dwvd.meta, HKCR\.dwvd.lock each pointing to their ProgIDs
  - MIME association: HKCR\MIME\Database\Content Type\application/vnd.datawarehouse.dwvd -> Extension=".dwvd"
  - Uses `WindowsProgId.CreatePrimary()` and `WindowsProgId.CreateForSecondary()` to generate all entries

- `string BuildPowerShellScript(string dwCliPath = "dw")` -- generates a PowerShell script using `New-Item`/`Set-ItemProperty` on HKCU:\Software\Classes\ (no admin required for current user) with equivalent registration. Includes `-ErrorAction SilentlyContinue` for idempotent re-runs.

- `string BuildUninstallRegFile()` -- generates .reg file with `[-HKCR\...]` entries to remove all registrations.

- `string BuildUninstallPowerShellScript()` -- PowerShell removal script.

Use `StringBuilder` for building .reg and .ps1 content. All paths use backslash escaping appropriate for .reg format (doubled backslashes). Include comments in generated scripts explaining each section.

Iterate `SecondaryExtensions.All` to generate entries for all secondary extensions -- no hardcoded extension list in the builder itself.
  </action>
  <verify>Build with `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore` -- no errors. Grep for "BuildRegFile" and "BuildPowerShellScript" to confirm both methods exist.</verify>
  <done>BuildRegFile() produces valid .reg format with all ProgIDs, shell verbs, MIME association, and secondary extensions. BuildPowerShellScript() produces equivalent HKCU registration. Both install and uninstall scripts are available.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore` passes with zero errors
- WindowsProgId references DwvdMimeType constants (not hardcoded MIME strings)
- Registry builder iterates SecondaryExtensions.All (no hardcoded secondary extension list)
- Shell verbs use "dw open", "dw inspect", "dw verify" command patterns
- ProgID constant is "DataWarehouse.DwvdFile"
</verification>

<success_criteria>
- FEXT-02 (Windows ProgID): ProgID "DataWarehouse.DwvdFile" with Open/Inspect/Verify shell verbs
- Double-click opens via `dw open "%1"`, right-click provides Inspect and Verify options
- .reg file and PowerShell script both generate correct registry entries
- Secondary extensions (.dwvd.snap, .dwvd.delta, .dwvd.meta, .dwvd.lock) all registered
</success_criteria>

<output>
After completion, create `.planning/phases/79-file-extension-os-integration/79-02-SUMMARY.md`
</output>
