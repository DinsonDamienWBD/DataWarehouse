---
phase: 79-file-extension-os-integration
plan: 03
type: execute
wave: 2
depends_on: ["79-01"]
files_modified:
  - DataWarehouse.SDK/VirtualDiskEngine/FileExtension/OsIntegration/LinuxMimeInfo.cs
  - DataWarehouse.SDK/VirtualDiskEngine/FileExtension/OsIntegration/LinuxMagicRule.cs
  - DataWarehouse.SDK/VirtualDiskEngine/FileExtension/OsIntegration/MacOsUti.cs
autonomous: true

must_haves:
  truths:
    - "freedesktop.org shared-mime-info XML is generated with correct glob and magic match for .dwvd"
    - "/etc/magic rule detects DWVD files using the 4-byte magic 'DWVD' at offset 0"
    - "macOS UTI com.datawarehouse.dwvd is declared with conforming-to public.data and public.disk-image"
    - "file(1) command magic rule format is correct: offset 0, string DWVD, output message"
    - "All secondary extensions are included in both Linux and macOS registrations"
  artifacts:
    - path: "DataWarehouse.SDK/VirtualDiskEngine/FileExtension/OsIntegration/LinuxMimeInfo.cs"
      provides: "freedesktop.org shared-mime-info XML generation"
      contains: "shared-mime-info"
    - path: "DataWarehouse.SDK/VirtualDiskEngine/FileExtension/OsIntegration/LinuxMagicRule.cs"
      provides: "/etc/magic and file(1) magic rule generation"
      contains: "etc/magic"
    - path: "DataWarehouse.SDK/VirtualDiskEngine/FileExtension/OsIntegration/MacOsUti.cs"
      provides: "macOS UTI declaration, Info.plist entries, Quick Look support"
      contains: "com.datawarehouse.dwvd"
  key_links:
    - from: "LinuxMimeInfo"
      to: "DwvdMimeType"
      via: "Uses MimeType constant for XML mime-type attribute"
      pattern: "DwvdMimeType\\.MimeType"
    - from: "LinuxMimeInfo"
      to: "FormatConstants"
      via: "Uses DwvdAsciiBytes for magic match bytes"
      pattern: "FormatConstants\\.DwvdAsciiBytes|0x44.*0x57.*0x56.*0x44"
    - from: "MacOsUti"
      to: "DwvdMimeType"
      via: "Uses MimeType for UTExportedTypeDeclarations MIME conformance"
      pattern: "DwvdMimeType\\.MimeType"
---

<objective>
Create Linux freedesktop.org shared-mime-info XML, /etc/magic rules, and macOS UTI (Uniform Type Identifier) declaration generators.

Purpose: Enables Linux `file` command detection of .dwvd files, GNOME/KDE file managers to show correct icons/associations, and macOS Finder/Quick Look to recognize .dwvd as a disk image format. Covers FEXT-03 (Linux) and FEXT-04 (macOS).

Output: Three files providing platform-specific OS integration metadata generators for Linux and macOS.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@DataWarehouse.SDK/VirtualDiskEngine/FileExtension/DwvdMimeType.cs
@DataWarehouse.SDK/VirtualDiskEngine/FileExtension/SecondaryExtension.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/FormatConstants.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/MagicSignature.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Linux freedesktop.org shared-mime-info and /etc/magic rule generators</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/FileExtension/OsIntegration/LinuxMimeInfo.cs
    DataWarehouse.SDK/VirtualDiskEngine/FileExtension/OsIntegration/LinuxMagicRule.cs
  </files>
  <action>
**LinuxMimeInfo.cs**: Static class in namespace `DataWarehouse.SDK.VirtualDiskEngine.FileExtension.OsIntegration`. Add `[SdkCompatibility("6.0.0", Notes = "Phase 79: Linux MIME info (FEXT-03)")]`.

Methods:
- `string BuildSharedMimeInfoXml()` -- generates valid freedesktop.org shared-mime-info XML:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<mime-info xmlns="http://www.freedesktop.org/standards/shared-mime-info">
  <mime-type type="application/vnd.datawarehouse.dwvd">
    <comment>DataWarehouse Virtual Disk</comment>
    <comment xml:lang="en">DataWarehouse Virtual Disk</comment>
    <acronym>DWVD</acronym>
    <expanded-acronym>DataWarehouse Virtual Disk</expanded-acronym>
    <glob pattern="*.dwvd"/>
    <glob pattern="*.dwvd.snap"/>
    <glob pattern="*.dwvd.delta"/>
    <glob pattern="*.dwvd.meta"/>
    <glob pattern="*.dwvd.lock"/>
    <magic priority="60">
      <match type="string" value="DWVD" offset="0"/>
    </magic>
    <sub-class-of type="application/octet-stream"/>
  </mime-type>
</mime-info>
```
  Use `XDocument`/`XElement` (System.Xml.Linq) to build XML programmatically, not string concatenation. Reference `DwvdMimeType.MimeType` for the type attribute. Iterate `SecondaryExtensions.All` for glob patterns.

- `string BuildDesktopFileEntry(string dwCliPath = "dw")` -- generates a .desktop file entry for the dw CLI:
```ini
[Desktop Entry]
Type=Application
Name=DataWarehouse
Comment=Open DataWarehouse Virtual Disk files
Exec=dw open %f
MimeType=application/vnd.datawarehouse.dwvd;
Terminal=false
NoDisplay=true
```

- `string BuildInstallScript()` -- generates a bash script that:
  1. Copies the shared-mime-info XML to `~/.local/share/mime/packages/datawarehouse-dwvd.xml`
  2. Runs `update-mime-database ~/.local/share/mime`
  3. Copies the .desktop file to `~/.local/share/applications/datawarehouse.desktop`
  4. Runs `update-desktop-database ~/.local/share/applications`
  Script is idempotent (mkdir -p, overwrites existing).

**LinuxMagicRule.cs**: Static class. Add `[SdkCompatibility("6.0.0", Notes = "Phase 79: Linux magic rule (FEXT-03)")]`.

Methods:
- `string BuildEtcMagicRule()` -- generates /etc/magic format rule:
```
# DataWarehouse Virtual Disk (DWVD v2.0)
0       string  DWVD    DataWarehouse Virtual Disk (DWVD)
!:mime  application/vnd.datawarehouse.dwvd
!:ext   dwvd
>4      byte    x       \b, version %d
>5      byte    x       \b.%d
```
  The rule: offset 0, type "string", value "DWVD", description. Sub-rules extract version bytes at offsets 4 and 5. MIME type annotation via `!:mime`. Extension annotation via `!:ext`.

- `string BuildFileMagicRule()` -- generates the same rule in `file(1)` magic format (may differ slightly from /etc/magic in some systems -- provide both).

- `string BuildMagicInstallScript()` -- bash script that appends the rule to `~/.magic` (user-level, no root) if not already present (grep guard).

- `byte[] GetMagicBytes()` -- returns the 4-byte magic "DWVD" as byte array (convenience for testing).
  </action>
  <verify>Build with `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore` -- no errors. Grep for "shared-mime-info" in LinuxMimeInfo.cs to confirm XML namespace present.</verify>
  <done>BuildSharedMimeInfoXml() produces valid freedesktop XML with magic match at offset 0 and glob patterns for all extensions. BuildEtcMagicRule() produces valid /etc/magic format with MIME annotation. Install scripts are idempotent.</done>
</task>

<task type="auto">
  <name>Task 2: macOS UTI declaration and Quick Look support</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/FileExtension/OsIntegration/MacOsUti.cs
  </files>
  <action>
**MacOsUti.cs**: Static class in namespace `DataWarehouse.SDK.VirtualDiskEngine.FileExtension.OsIntegration`. Add `[SdkCompatibility("6.0.0", Notes = "Phase 79: macOS UTI (FEXT-04)")]`.

Constants:
- `PrimaryUti = "com.datawarehouse.dwvd"` -- main UTI identifier
- `SnapshotUti = "com.datawarehouse.dwvd.snapshot"`
- `DeltaUti = "com.datawarehouse.dwvd.delta"`
- `MetadataUti = "com.datawarehouse.dwvd.metadata"`
- `LockUti = "com.datawarehouse.dwvd.lock"`

Methods:
- `string BuildInfoPlistFragment()` -- generates the UTExportedTypeDeclarations array for Info.plist (XML plist format):
```xml
<key>UTExportedTypeDeclarations</key>
<array>
  <dict>
    <key>UTTypeIdentifier</key>
    <string>com.datawarehouse.dwvd</string>
    <key>UTTypeDescription</key>
    <string>DataWarehouse Virtual Disk</string>
    <key>UTTypeConformsTo</key>
    <array>
      <string>public.data</string>
      <string>public.disk-image</string>
    </array>
    <key>UTTypeTagSpecification</key>
    <dict>
      <key>public.filename-extension</key>
      <array><string>dwvd</string></array>
      <key>public.mime-type</key>
      <string>application/vnd.datawarehouse.dwvd</string>
    </dict>
  </dict>
  <!-- Secondary UTIs for .dwvd.snap, .dwvd.delta, .dwvd.meta, .dwvd.lock -->
</array>
```
  Include UTI declarations for all secondary extensions, each conforming to `com.datawarehouse.dwvd` (parent UTI) and `public.data`. Iterate `SecondaryExtensions.All`.

- `string BuildQuickLookGeneratorPlist()` -- generates a Quick Look generator Info.plist fragment with:
  - `QLSupportedContentTypes` array containing all UTIs
  - `QLNeedsApplicationBundleIdentifier` = false
  - `QLPreviewWidth`/`QLPreviewHeight` defaults (800x600)

- `string BuildMdImporterPlist()` -- generates a Spotlight metadata importer plist fragment with:
  - `CFBundleDocumentTypes` containing all UTIs
  - Maps .dwvd metadata fields (volume label, UUID, block count) to Spotlight attributes

- `string GetUtiForExtension(string extension)` -- maps file extension to UTI string, returns null if unrecognized.

- `static string BuildLaunchServicesRegistrationScript()` -- generates a bash script using `/System/Library/Frameworks/CoreServices.framework/Frameworks/LaunchServices.framework/Support/lsregister` to register the UTIs from a .app bundle path.

Use `XDocument` for all XML generation (not string concatenation). Reference `DwvdMimeType` for MIME constants and `SecondaryExtensions` for extension iteration.
  </action>
  <verify>Build with `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore` -- no errors. Grep for "com.datawarehouse.dwvd" in MacOsUti.cs to confirm UTI present.</verify>
  <done>PrimaryUti is "com.datawarehouse.dwvd" with conforming-to public.data and public.disk-image. Info.plist fragment includes all secondary UTIs. Quick Look plist supports all UTIs. Spotlight metadata importer maps VDE fields.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore` passes with zero errors
- LinuxMimeInfo references DwvdMimeType.MimeType (not hardcoded)
- /etc/magic rule starts with `0  string  DWVD` for offset 0 magic match
- macOS UTI conforms to public.data and public.disk-image
- All secondary extensions appear in Linux globs, macOS UTI declarations, and magic rules
</verification>

<success_criteria>
- FEXT-03 (Linux): freedesktop.org XML with magic + glob, /etc/magic rule with !:mime annotation, install scripts
- FEXT-04 (macOS): UTI com.datawarehouse.dwvd registered, Quick Look generator plist, Spotlight importer plist
- FEXT-08 (Secondary extensions): All 4 secondary extensions registered on both platforms
- All generated scripts are idempotent and work without root/admin privileges where possible
</success_criteria>

<output>
After completion, create `.planning/phases/79-file-extension-os-integration/79-03-SUMMARY.md`
</output>
