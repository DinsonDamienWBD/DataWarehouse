---
phase: 79-file-extension-os-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.SDK/VirtualDiskEngine/FileExtension/DwvdMimeType.cs
  - DataWarehouse.SDK/VirtualDiskEngine/FileExtension/DwvdContentDetector.cs
  - DataWarehouse.SDK/VirtualDiskEngine/FileExtension/ContentDetectionResult.cs
  - DataWarehouse.SDK/VirtualDiskEngine/FileExtension/SecondaryExtension.cs
autonomous: true

must_haves:
  truths:
    - "DWVD MIME type constant 'application/vnd.datawarehouse.dwvd' is available via DwvdMimeType.MimeType"
    - "Content detection reads first 16 bytes of a file and identifies DWVD format via 5-step priority chain (magic -> version -> namespace -> flags -> seal)"
    - "Files without .dwvd extension are correctly identified by content detection if they contain valid DWVD magic bytes"
    - "Secondary extensions (.dwvd.snap, .dwvd.delta, .dwvd.meta, .dwvd.lock) are enumerated with their MIME type variants"
  artifacts:
    - path: "DataWarehouse.SDK/VirtualDiskEngine/FileExtension/DwvdMimeType.cs"
      provides: "MIME type constants, extension constants, IANA registration XML template"
      contains: "application/vnd.datawarehouse.dwvd"
    - path: "DataWarehouse.SDK/VirtualDiskEngine/FileExtension/DwvdContentDetector.cs"
      provides: "5-step content detection priority chain"
      exports: ["DetectAsync", "DetectFromStream", "DetectFromBytes"]
    - path: "DataWarehouse.SDK/VirtualDiskEngine/FileExtension/ContentDetectionResult.cs"
      provides: "Detection result with confidence, format version, detection steps"
    - path: "DataWarehouse.SDK/VirtualDiskEngine/FileExtension/SecondaryExtension.cs"
      provides: "Enum and metadata for secondary extensions"
  key_links:
    - from: "DwvdContentDetector"
      to: "MagicSignature"
      via: "MagicSignature.Deserialize + Validate"
      pattern: "MagicSignature\\.Deserialize"
    - from: "DwvdContentDetector"
      to: "FormatVersionInfo"
      via: "FormatVersionInfo.Deserialize for version check"
      pattern: "FormatVersionInfo\\.Deserialize"
    - from: "DwvdContentDetector"
      to: "SuperblockV2"
      via: "Optional deeper detection for flags + seal"
      pattern: "SuperblockV2\\.Deserialize"
---

<objective>
Create the IANA MIME type registration model and the 5-step content detection engine for DWVD files.

Purpose: Provides the foundational MIME type constants and binary content detection that all OS integration plans (Windows, Linux, macOS) and the import engine depend on. The content detector implements FEXT-05's priority chain: magic bytes -> version -> namespace anchor -> feature flags -> integrity seal.

Output: Four files in a new `FileExtension` namespace providing MIME types, content detection, detection results, and secondary extension definitions.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@DataWarehouse.SDK/VirtualDiskEngine/Format/MagicSignature.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/FormatConstants.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/SuperblockV2.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/FeatureFlags.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/VdeCreator.cs
@DataWarehouse.SDK/VirtualDiskEngine/Identity/FormatFingerprintValidator.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: MIME type constants and secondary extension definitions</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/FileExtension/DwvdMimeType.cs
    DataWarehouse.SDK/VirtualDiskEngine/FileExtension/SecondaryExtension.cs
  </files>
  <action>
Create new directory `DataWarehouse.SDK/VirtualDiskEngine/FileExtension/`.

**DwvdMimeType.cs**: Static class in namespace `DataWarehouse.SDK.VirtualDiskEngine.FileExtension`. Add `[SdkCompatibility("6.0.0", Notes = "Phase 79: File extension MIME type (FEXT-01)")]`. Constants:
- `MimeType = "application/vnd.datawarehouse.dwvd"` (primary MIME type)
- `PrimaryExtension = ".dwvd"` (primary file extension)
- `FormatName = "DataWarehouse Virtual Disk"` (human-readable name)
- `IanaRegistrationXml` property that returns a string containing the IANA MIME type registration XML template (media-type, subtype, file extension, magic number "0x44575644" at offset 0, reference to DataWarehouse spec)
- `GetMimeTypeForExtension(string extension)` method that returns the appropriate MIME type string for primary and all secondary extensions, or null if unrecognized
- `IsRecognizedExtension(string extension)` that returns bool for any .dwvd or .dwvd.* secondary extension
- `AllExtensions` static readonly array of all recognized extensions (primary + secondary)

**SecondaryExtension.cs**: Enum `SecondaryExtensionKind` with values: `Snapshot`, `Delta`, `Metadata`, `Lock`. Static class `SecondaryExtensions` with:
- `GetExtension(SecondaryExtensionKind kind)` returning ".dwvd.snap", ".dwvd.delta", ".dwvd.meta", ".dwvd.lock"
- `GetMimeType(SecondaryExtensionKind kind)` returning "application/vnd.datawarehouse.dwvd.snapshot", etc.
- `GetDescription(SecondaryExtensionKind kind)` returning human-readable descriptions
- `TryParse(string extension, out SecondaryExtensionKind kind)` for parsing file extensions back to enum
- `All` property returning all SecondaryExtensionKind values

Both classes use `using DataWarehouse.SDK.Contracts;` for SdkCompatibility.
  </action>
  <verify>Build with `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore` -- no errors in new files.</verify>
  <done>DwvdMimeType.MimeType returns "application/vnd.datawarehouse.dwvd", all 4 secondary extensions are enumerated with correct MIME types, GetMimeTypeForExtension handles all 5 extensions.</done>
</task>

<task type="auto">
  <name>Task 2: Content detection engine with 5-step priority chain</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/FileExtension/ContentDetectionResult.cs
    DataWarehouse.SDK/VirtualDiskEngine/FileExtension/DwvdContentDetector.cs
  </files>
  <action>
**ContentDetectionResult.cs**: Readonly struct `ContentDetectionResult` with:
- `bool IsDwvd` -- overall detection result
- `float Confidence` -- 0.0 to 1.0 confidence score (each step adds ~0.2)
- `byte MajorVersion`, `byte MinorVersion` -- detected format version (0 if not detected)
- `ushort SpecRevision` -- detected spec revision
- `string? DetectedMimeType` -- resolved MIME type (null if not DWVD)
- `ContentDetectionStep HighestStep` -- enum of how far detection progressed
- `string Summary` -- human-readable summary string
- `bool HasValidMagic`, `bool HasValidVersion`, `bool HasValidNamespace`, `bool HasValidFlags`, `bool HasValidSeal` -- per-step booleans
- Enum `ContentDetectionStep { None, Magic, Version, Namespace, Flags, Seal }` (nested or separate)

Add `[SdkCompatibility("6.0.0", Notes = "Phase 79: Content detection result (FEXT-05)")]`.

**DwvdContentDetector.cs**: Static class implementing the 5-step priority chain. Add `[SdkCompatibility("6.0.0", Notes = "Phase 79: DWVD content detector (FEXT-05)")]`.

Methods:
- `static ContentDetectionResult DetectFromBytes(ReadOnlySpan<byte> data)` -- primary detection entry point. Reads up to one block (max 64KB). Steps:
  1. **Magic** (bytes 0-3): Check for "DWVD" (0x44575644) via `MagicSignature.Deserialize` + `Validate()`. If fail, return immediately with IsDwvd=false, Confidence=0.
  2. **Version** (bytes 4-7): Check MajorVersion >= 1 and <= 255, MinorVersion valid, SpecRevision > 0. Adds 0.2 confidence.
  3. **Namespace** (bytes 8-15): Check "dw://" anchor via MagicSignature.NamespaceAnchor match against expected value. Adds 0.2 confidence.
  4. **Flags** (bytes 16-31): Deserialize FormatVersionInfo, check that feature flag bits are within known enum ranges (no unknown bits set in incompatible flags for current version). Adds 0.2 confidence.
  5. **Seal** (requires full superblock, ~4KB minimum): If data.Length >= blockSize (read blockSize from offset 0x34), deserialize SuperblockV2 and check HeaderIntegritySeal is non-zero. Adds 0.2 confidence.

  Base confidence for valid magic alone = 0.2 (enough for "probably DWVD").

- `static ContentDetectionResult DetectFromStream(Stream stream)` -- reads first MaxBlockSize (64KB) bytes from stream (respects stream.Length), delegates to DetectFromBytes.
- `static async Task<ContentDetectionResult> DetectAsync(string filePath, CancellationToken ct = default)` -- opens file, reads header, delegates to DetectFromStream.
- `static bool IsLikelyDwvd(ReadOnlySpan<byte> first16Bytes)` -- quick check: magic only (for use in file(1) / magic rules). Just checks bytes 0-3 = "DWVD".
- `static bool IsLikelyDwvd(string filePath)` -- convenience overload opening file and reading 16 bytes.

All methods are pure except the file I/O overloads. No allocations on the hot path (DetectFromBytes). Use `BinaryPrimitives` for all reads.
  </action>
  <verify>Build with `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore` -- no errors. Grep for "DetectFromBytes" in new file to confirm method exists.</verify>
  <done>DetectFromBytes implements 5-step chain returning ContentDetectionResult with per-step booleans and cumulative confidence. DetectAsync opens files by path. IsLikelyDwvd provides quick 4-byte magic check.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore` passes with zero errors in new files
- New namespace `DataWarehouse.SDK.VirtualDiskEngine.FileExtension` contains exactly 4 files
- DwvdMimeType.MimeType is "application/vnd.datawarehouse.dwvd"
- Content detection references MagicSignature, FormatVersionInfo, SuperblockV2 from Format namespace
- All 4 secondary extensions (.snap, .delta, .meta, .lock) are defined
</verification>

<success_criteria>
- FEXT-01 (MIME type): application/vnd.datawarehouse.dwvd constant + IANA XML template available
- FEXT-05 (Content detection): 5-step priority chain (magic -> version -> namespace -> flags -> seal) implemented with cumulative confidence scoring
- FEXT-08 (Secondary extensions): All 4 secondary extensions defined with MIME type variants
- Foundation: DwvdContentDetector and DwvdMimeType are importable by Plans 02, 03, 04
</success_criteria>

<output>
After completion, create `.planning/phases/79-file-extension-os-integration/79-01-SUMMARY.md`
</output>
