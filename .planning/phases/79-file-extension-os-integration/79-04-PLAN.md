---
phase: 79-file-extension-os-integration
plan: 04
type: execute
wave: 2
depends_on: ["79-01"]
files_modified:
  - DataWarehouse.SDK/VirtualDiskEngine/FileExtension/Import/VirtualDiskFormat.cs
  - DataWarehouse.SDK/VirtualDiskEngine/FileExtension/Import/FormatDetector.cs
  - DataWarehouse.SDK/VirtualDiskEngine/FileExtension/Import/DwvdImporter.cs
  - DataWarehouse.SDK/VirtualDiskEngine/FileExtension/Import/ImportResult.cs
  - DataWarehouse.SDK/VirtualDiskEngine/FileExtension/Import/ImportSuggestion.cs
autonomous: true

must_haves:
  truths:
    - "VHD, VHDX, VMDK, QCOW2, VDI, RAW, and IMG formats are detected by their magic bytes"
    - "Non-DWVD files presented to dw tools receive an ImportSuggestion with format name, estimated size, and dw import command"
    - "Import reads source format header, creates a new DWVD via VdeCreator, copies data blocks, producing a valid .dwvd file"
    - "Import reports progress via IProgress<ImportProgress> callback"
    - "RAW/IMG import has no magic detection -- uses file size heuristic (>512 bytes, sector-aligned) and requires explicit format parameter"
  artifacts:
    - path: "DataWarehouse.SDK/VirtualDiskEngine/FileExtension/Import/VirtualDiskFormat.cs"
      provides: "Enum of 7 supported import formats with magic byte definitions"
      contains: "Vhd|Vhdx|Vmdk|Qcow2|Vdi|Raw|Img"
    - path: "DataWarehouse.SDK/VirtualDiskEngine/FileExtension/Import/FormatDetector.cs"
      provides: "Detects source format from magic bytes"
      exports: ["DetectFormat", "DetectFormatAsync"]
    - path: "DataWarehouse.SDK/VirtualDiskEngine/FileExtension/Import/DwvdImporter.cs"
      provides: "Imports from foreign formats to .dwvd"
      exports: ["ImportAsync"]
    - path: "DataWarehouse.SDK/VirtualDiskEngine/FileExtension/Import/ImportSuggestion.cs"
      provides: "Suggestion model for non-DWVD files with migration command"
      exports: ["CreateSuggestion"]
  key_links:
    - from: "DwvdImporter"
      to: "VdeCreator"
      via: "Creates target DWVD file via VdeCreator.CreateVdeAsync"
      pattern: "VdeCreator\\.CreateVdeAsync"
    - from: "DwvdImporter"
      to: "DwvdContentDetector"
      via: "First checks if file is already DWVD (skip import)"
      pattern: "DwvdContentDetector\\.DetectAsync"
    - from: "ImportSuggestion"
      to: "FormatDetector"
      via: "Uses detected format to build suggestion message"
      pattern: "FormatDetector\\.DetectFormat"
---

<objective>
Create the virtual disk import engine supporting 7 foreign formats (VHD, VHDX, VMDK, QCOW2, VDI, RAW, IMG) and the non-DWVD import suggestion system.

Purpose: When users encounter non-DWVD virtual disk files, the system detects the source format, offers a clear migration path with an import command, and can convert the file to a valid .dwvd. This closes the ecosystem by making DWVD the convergence format for all virtual disk workflows.

Output: Five files in an `Import` sub-namespace handling format detection, import execution, progress reporting, and import suggestion.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@DataWarehouse.SDK/VirtualDiskEngine/FileExtension/DwvdMimeType.cs
@DataWarehouse.SDK/VirtualDiskEngine/FileExtension/DwvdContentDetector.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/VdeCreator.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/VdeCreationProfile.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/FormatConstants.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Virtual disk format enum and magic-based format detector</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/FileExtension/Import/VirtualDiskFormat.cs
    DataWarehouse.SDK/VirtualDiskEngine/FileExtension/Import/FormatDetector.cs
  </files>
  <action>
Create new directory `DataWarehouse.SDK/VirtualDiskEngine/FileExtension/Import/`.

**VirtualDiskFormat.cs**: Enum `VirtualDiskFormat` in namespace `DataWarehouse.SDK.VirtualDiskEngine.FileExtension.Import`. Add `[SdkCompatibility("6.0.0", Notes = "Phase 79: Virtual disk formats (FEXT-07)")]`. Values:
- `Unknown = 0`
- `Dwvd = 1` -- native format (already DWVD, no import needed)
- `Vhd = 2` -- Microsoft VHD (magic: "conectix" at offset 0 for fixed, or at end-512 for dynamic)
- `Vhdx = 3` -- Microsoft VHDX (magic: "vhdxfile" at offset 0)
- `Vmdk = 4` -- VMware VMDK (magic: "KDMV" at offset 0, or "# Disk DescriptorFile" text header)
- `Qcow2 = 5` -- QEMU QCOW2 (magic: 0x514649FB big-endian at offset 0)
- `Vdi = 6` -- VirtualBox VDI (magic: "<<< Oracle VM VirtualBox Disk Image >>>" at offset 0, or signature 0xBEDA107F at offset 64)
- `Raw = 7` -- Raw disk image (no magic, sector-aligned size)
- `Img = 8` -- Generic disk image (alias for Raw, distinguished by extension)

Static class `VirtualDiskFormatInfo` with:
- `GetExtension(VirtualDiskFormat fmt)` -- returns canonical extension (.vhd, .vhdx, .vmdk, .qcow2, .vdi, .raw, .img)
- `GetDescription(VirtualDiskFormat fmt)` -- human-readable name
- `GetMagicBytes(VirtualDiskFormat fmt)` -- returns ReadOnlyMemory<byte> of magic bytes (empty for Raw/Img)
- `GetMagicOffset(VirtualDiskFormat fmt)` -- returns offset where magic appears
- `SupportsContentDetection(VirtualDiskFormat fmt)` -- false for Raw/Img

**FormatDetector.cs**: Static class. Add `[SdkCompatibility("6.0.0", Notes = "Phase 79: Format detector (FEXT-06, FEXT-07)")]`.

Methods:
- `VirtualDiskFormat DetectFormat(ReadOnlySpan<byte> headerBytes)` -- checks magic bytes in priority order:
  1. DWVD (0x44575644 at offset 0) -> Dwvd
  2. VHDX ("vhdxfile" at offset 0) -> Vhdx
  3. QCOW2 (0x514649FB at offset 0, big-endian) -> Qcow2
  4. VMDK ("KDMV" at offset 0, or starts with "# Disk DescriptorFile") -> Vmdk
  5. VDI (0xBEDA107F at offset 64) -> Vdi
  6. VHD ("conectix" at offset 0) -> Vhd
  7. Otherwise -> Unknown (caller may try Raw/Img heuristic)

  Order matters: check most specific magic first. Uses `BinaryPrimitives` and `SequenceEqual` for comparisons. No allocations.

- `VirtualDiskFormat DetectFormat(ReadOnlySpan<byte> headerBytes, string? fileExtension, long fileSize)` -- enhanced overload that also checks extension for Raw/Img when magic is Unknown:
  - If extension is ".raw" or ".img" and fileSize > 512 and fileSize % 512 == 0 -> Raw or Img respectively
  - Otherwise Unknown

- `async Task<VirtualDiskFormat> DetectFormatAsync(string filePath, CancellationToken ct = default)` -- opens file, reads first 512 bytes (enough for all magic checks), calls DetectFormat with extension and size.

- `bool IsImportable(VirtualDiskFormat fmt)` -- true for all formats except Unknown and Dwvd.
  </action>
  <verify>Build with `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore` -- no errors.</verify>
  <done>FormatDetector.DetectFormat correctly identifies all 7 foreign formats by magic bytes. VHD "conectix", VHDX "vhdxfile", VMDK "KDMV", QCOW2 0x514649FB, VDI 0xBEDA107F magic patterns implemented. Raw/Img use extension+size heuristic.</done>
</task>

<task type="auto">
  <name>Task 2: Import engine, progress reporting, and import suggestion</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/FileExtension/Import/ImportResult.cs
    DataWarehouse.SDK/VirtualDiskEngine/FileExtension/Import/ImportSuggestion.cs
    DataWarehouse.SDK/VirtualDiskEngine/FileExtension/Import/DwvdImporter.cs
  </files>
  <action>
**ImportResult.cs**: Readonly struct in namespace `DataWarehouse.SDK.VirtualDiskEngine.FileExtension.Import`. Add `[SdkCompatibility("6.0.0", Notes = "Phase 79: Import result (FEXT-07)")]`.
- `bool Success`
- `string OutputPath` -- path to created .dwvd file
- `VirtualDiskFormat SourceFormat` -- detected source format
- `long SourceSizeBytes` -- original file size
- `long DwvdSizeBytes` -- resulting .dwvd file size
- `TimeSpan Duration` -- import duration
- `string? ErrorMessage` -- null on success
- Readonly struct `ImportProgress` with: `double PercentComplete` (0-100), `long BytesProcessed`, `long TotalBytes`, `string Phase` ("detecting", "creating", "copying", "finalizing")

**ImportSuggestion.cs**: Readonly struct. Add `[SdkCompatibility("6.0.0", Notes = "Phase 79: Import suggestion (FEXT-06)")]`.
- `VirtualDiskFormat DetectedFormat`
- `string FormatName` -- human-readable (e.g., "VMware VMDK")
- `string SourcePath`
- `long EstimatedDwvdSizeBytes`
- `string SuggestedCommand` -- e.g., `dw import --from vmdk "source.vmdk" --output "source.dwvd"`
- `string Message` -- full human-readable message: "The file 'source.vmdk' appears to be a VMware VMDK virtual disk. To convert it to DWVD format, run:\n  dw import --from vmdk \"source.vmdk\" --output \"source.dwvd\""

Static method:
- `ImportSuggestion CreateSuggestion(string filePath, VirtualDiskFormat format)` -- builds suggestion from detected format
- `ImportSuggestion? TryCreateSuggestion(string filePath)` -- convenience: detect format, return suggestion if importable, null if DWVD or unknown

**DwvdImporter.cs**: Static class. Add `[SdkCompatibility("6.0.0", Notes = "Phase 79: DWVD importer (FEXT-07)")]`.

Methods:
- `async Task<ImportResult> ImportAsync(string sourcePath, string? outputPath = null, VdeCreationProfile? profile = null, IProgress<ImportProgress>? progress = null, CancellationToken ct = default)`:
  1. Detect source format via `FormatDetector.DetectFormatAsync`. If already DWVD, return success with source path as output (no-op).
  2. If Unknown, throw `NotSupportedException` with message listing supported formats.
  3. Determine output path: if null, replace source extension with ".dwvd".
  4. Read source format header to determine logical disk size:
     - VHD: read footer at end-512, extract "Current Size" field (8 bytes at offset 40, big-endian)
     - VHDX: read first metadata region to find virtual disk size
     - VMDK: parse descriptor for "createType" and "RW" extent sizes
     - QCOW2: read header size field (8 bytes at offset 24, big-endian)
     - VDI: read header "Disk Size" (8 bytes at offset 368, little-endian)
     - Raw/Img: use file size directly
  5. Create VDE profile: `profile ?? new VdeCreationProfile { BlockSize = FormatConstants.DefaultBlockSize, TotalBlocks = ceilingDiv(logicalSize, blockSize), ThinProvisioned = true }`.
  6. Create target DWVD via `VdeCreator.CreateVdeAsync`.
  7. Copy data blocks: open source, read data in 1MB chunks, write to DWVD data region. Report progress via `IProgress<ImportProgress>`.
     - For structured formats (VHD/VHDX/VMDK/QCOW2/VDI): read allocation table, only copy allocated blocks (sparse-aware).
     - For Raw/Img: sequential copy of all data.
  8. Return ImportResult with timing and size info.

  IMPORTANT: The actual data-copy step reads raw bytes from the source and writes them as data blocks in the DWVD. This is a byte-level copy, NOT a filesystem-aware conversion. The imported DWVD contains the same raw data as the source, just in DWVD container format.

  For structured format header parsing: implement helper methods `ReadVhdLogicalSize`, `ReadVhdxLogicalSize`, `ReadVmdkLogicalSize`, `ReadQcow2LogicalSize`, `ReadVdiLogicalSize` -- each reads the minimum required bytes from the source to determine the logical disk size. These are private methods, each ~10-30 lines. Use `BinaryPrimitives` for all binary reads. Handle invalid headers by throwing `InvalidDataException` with descriptive message.

- `bool CanImport(string filePath)` -- convenience: detect format, return true if importable.
  </action>
  <verify>Build with `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore` -- no errors. Grep for "ImportAsync" and "CreateSuggestion" to confirm methods exist.</verify>
  <done>ImportAsync reads 7 foreign formats and produces valid .dwvd files via VdeCreator. ImportSuggestion.CreateSuggestion provides clear migration path with CLI command. FormatDetector identifies all formats by magic bytes. Progress reporting works via IProgress callback.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore` passes with zero errors
- All 7 formats (VHD, VHDX, VMDK, QCOW2, VDI, RAW, IMG) enumerated in VirtualDiskFormat
- FormatDetector checks DWVD magic first (prevent importing already-DWVD files)
- ImportSuggestion.SuggestedCommand matches `dw import --from {format} "{source}" --output "{output}"` pattern
- DwvdImporter uses VdeCreator.CreateVdeAsync (not custom file creation)
- Magic bytes match official format specifications
</verification>

<success_criteria>
- FEXT-06 (Non-DWVD suggestion): Non-DWVD files get ImportSuggestion with format name, estimated size, and dw import command
- FEXT-07 (Import from 7 formats): VHD, VHDX, VMDK, QCOW2, VDI, RAW, IMG all supported with magic detection and logical-size extraction
- Import produces valid .dwvd files by creating via VdeCreator and copying raw data blocks
- Progress reporting via IProgress<ImportProgress> with percentage and phase info
</success_criteria>

<output>
After completion, create `.planning/phases/79-file-extension-os-integration/79-04-SUMMARY.md`
</output>
