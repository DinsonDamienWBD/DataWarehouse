---
phase: 66-integration
plan: 04
type: execute
wave: 2
depends_on: ["66-01"]
files_modified:
  - DataWarehouse.Tests/Integration/ConfigurationHierarchyTests.cs
  - .planning/phases/66-integration/CONFIGURATION-AUDIT-REPORT.md
autonomous: true

must_haves:
  truths:
    - "Every v5.0 feature is configurable via the Instance->Tenant->User hierarchy"
    - "AllowUserToOverride is explicitly set for every configuration item"
    - "Configuration presets (Individual through Hyperscale) include v5.0 feature settings"
  artifacts:
    - path: "DataWarehouse.Tests/Integration/ConfigurationHierarchyTests.cs"
      provides: "Configuration hierarchy coverage tests"
      min_lines: 100
    - path: ".planning/phases/66-integration/CONFIGURATION-AUDIT-REPORT.md"
      provides: "Configuration coverage report"
      min_lines: 40
  key_links:
    - from: "v5.0 features (Tags, Passports, Carbon, Chaos, etc.)"
      to: "ConfigurationItem definitions"
      via: "ConfigurationPresets or plugin config"
      pattern: "ConfigurationItem|AllowUserToOverride|ConfigurationScope"
---

<objective>
Verify that all v5.0 features are fully configurable through the Instance->Tenant->User configuration hierarchy with proper AllowUserToOverride flags.

Purpose: Features that cannot be configured per-tenant or per-user are not production-ready for multi-tenant deployments. The configuration hierarchy is the mechanism for environment-specific behavior without separate codepaths.
Output: Configuration hierarchy tests and audit report.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@DataWarehouse.SDK/Primitives/Configuration/ConfigurationItem.cs
@DataWarehouse.SDK/Primitives/Configuration/ConfigurationPresets.cs
@DataWarehouse.SDK/Primitives/Configuration/ConfigurationChangeApi.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configuration coverage audit for v5.0 features</name>
  <files>.planning/phases/66-integration/CONFIGURATION-AUDIT-REPORT.md</files>
  <action>
  Audit every v5.0 feature's configuration integration:

  1. Scan ConfigurationPresets.cs and any other configuration definition files for existing configuration items. Build a map of: config key -> scope -> AllowUserToOverride -> default value
  2. For each v5.0 feature domain, check if configuration items exist:
     - Universal Tags (Phase 55): tag.schema.validation.enabled, tag.policy.enforcement.level, tag.propagation.enabled, tag.index.shard.count
     - Data Consciousness (Phase 56): consciousness.value.scoring.enabled, consciousness.auto.archive.threshold, consciousness.dark.data.discovery.interval
     - Compliance Passports (Phase 57): passport.issuance.auto.enabled, sovereignty.zone.enforcement, passport.zk.verification.enabled
     - Zero-Gravity Storage (Phase 58): placement.crush.enabled, vde.parallelism.degree, rebalancer.auto.enabled
     - Crypto Time-Locks (Phase 59): timelock.default.duration, pqc.migration.enabled, ransomware.vaccination.enabled
     - Semantic Sync (Phase 60): semantic.sync.enabled, sync.fidelity.minimum, semantic.conflict.resolution.mode
     - Chaos Vaccination (Phase 61): chaos.vaccination.enabled, chaos.schedule.cron, blast.radius.max.percentage
     - Carbon-Aware (Phase 62): carbon.budget.enabled, carbon.budget.monthly.kg, green.placement.enabled
     - Universal Fabric (Phase 63): fabric.s3.server.enabled, fabric.s3.server.port, fabric.placement.optimizer.enabled
  3. For each missing configuration item, note what needs to be added

  Write CONFIGURATION-AUDIT-REPORT.md with:
  - Summary table: feature domain | config items found | config items expected | coverage %
  - Detailed list of existing configuration items with scope and override settings
  - Gap list: missing configuration items per feature
  - Recommendations for remediation
  </action>
  <verify>Report exists with coverage assessment for all v5.0 features</verify>
  <done>Complete configuration audit with per-feature coverage and gap identification</done>
</task>

<task type="auto">
  <name>Task 2: Configuration hierarchy integration tests</name>
  <files>DataWarehouse.Tests/Integration/ConfigurationHierarchyTests.cs</files>
  <action>
  Create ConfigurationHierarchyTests.cs with:

  1. AllConfigurationItemsHaveExplicitScope: scan all ConfigurationItem definitions and verify each has an explicit ConfigurationScope (Instance, Tenant, or User)
  2. AllConfigurationItemsHaveAllowUserToOverride: verify every ConfigurationItem explicitly sets AllowUserToOverride (true or false, not missing)
  3. PresetsIncludeAllDomains: verify that ConfigurationPresets (Individual, SMB, Enterprise, Regulated, Military, Hyperscale, or however they are defined) include settings for all major feature domains, not just legacy features
  4. ConfigurationDefaultsAreReasonable: verify no configuration item has a null or empty default value unless explicitly nullable
  5. ConfigurationKeysFollowNamingConvention: verify all configuration keys follow the dot-separated lowercase naming convention (e.g., "domain.feature.setting")
  6. NoHardcodedConfigurationValues: scan v5.0 plugin source files for hardcoded values that should be configurable (magic numbers in feature logic like thresholds, timeouts, limits). Report as warnings.

  Use xUnit. Parse configuration source files and plugin source files statically.
  </action>
  <verify>Run `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter "FullyQualifiedName~ConfigurationHierarchy"` -- all tests pass</verify>
  <done>All configuration items have explicit scope, override flags, and reasonable defaults</done>
</task>

</tasks>

<verification>
- CONFIGURATION-AUDIT-REPORT.md covers all 9 v5.0 feature domains
- All ConfigurationHierarchy tests pass
- Zero configuration items missing scope or override flags
</verification>

<success_criteria>
Every v5.0 feature is configurable via Instance->Tenant->User hierarchy. AllowUserToOverride explicitly set. Presets updated for all features.
</success_criteria>

<output>
After completion, create `.planning/phases/66-integration/66-04-SUMMARY.md`
</output>
