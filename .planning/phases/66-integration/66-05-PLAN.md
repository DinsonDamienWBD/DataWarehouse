---
phase: 66-integration
plan: 05
type: execute
wave: 2
depends_on: ["66-01"]
files_modified:
  - DataWarehouse.Tests/Integration/SecurityRegressionTests.cs
  - .planning/phases/66-integration/SECURITY-REGRESSION-REPORT.md
autonomous: true

must_haves:
  truths:
    - "All 50 pentest findings from Phase 53 are still resolved after phases 54-65"
    - "No v5.0 feature introduces new security regressions"
    - "All new plugins enforce authentication and authorization via message bus"
  artifacts:
    - path: "DataWarehouse.Tests/Integration/SecurityRegressionTests.cs"
      provides: "Security regression verification tests"
      min_lines: 150
    - path: ".planning/phases/66-integration/SECURITY-REGRESSION-REPORT.md"
      provides: "Security posture report post-v5.0"
      min_lines: 60
  key_links:
    - from: "AccessEnforcementInterceptor"
      to: "All new v5.0 plugins"
      via: "Message bus authentication"
      pattern: "IAuthenticatedMessageBus|AccessEnforcement|Authorize"
---

<objective>
Verify that all 50 penetration test findings fixed in Phase 53 remain resolved after the feature work of phases 54-65, and that new v5.0 features do not introduce security regressions.

Purpose: Each new phase adds code that could re-introduce security vulnerabilities. This plan systematically verifies every pentest finding is still resolved and new features follow security patterns.
Output: Security regression tests and posture report.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/53-security-wiring/53-11-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pentest finding regression check</name>
  <files>.planning/phases/66-integration/SECURITY-REGRESSION-REPORT.md</files>
  <action>
  Re-verify each category of the 50 pentest findings from Phase 53:

  1. AUTH findings (AUTH-01 through AUTH-13): Verify AccessEnforcementInterceptor is still wired, no new unauthenticated endpoints, dashboard auth intact, API key validation present
  2. BUS findings (BUS-01 through BUS-06): Verify IAuthenticatedMessageBus usage, rate limiting on bus, no unsigned messages
  3. DIST findings (DIST-01 through DIST-09): Verify Raft mTLS, SWIM authentication, CRDT signing, mDNS authentication, Federation auth
  4. NET findings (NET-01 through NET-08): Verify TLS certificate validation enabled (no ServicePointManager.ServerCertificateValidationCallback = (s,c,ch,e) => true patterns), MQTT/WebSocket/GraphQL/CoAP hardened
  5. ISO findings (ISO-01 through ISO-06): Verify plugin isolation, secure loading, no Code.Compile or Assembly.Load from untrusted paths
  6. INFRA findings (INFRA-01 through INFRA-06): Verify audit logging, PBKDF2 iterations >= 600000, identity hardening
  7. D findings (D01-D04): Verify path traversal protection, VDE symlink protection
  8. RECON findings: Verify no version disclosure, error message sanitization

  For each finding, grep for the specific anti-pattern that was fixed. If the anti-pattern reappears in new v5.0 code, flag it.

  Also scan all new v5.0 plugin code for:
  - `ServerCertificateValidationCallback` (TLS bypass)
  - `Assembly.Load` without validation
  - Path.Combine without sanitization on user input
  - `new HttpClient()` without timeout
  - Hardcoded credentials or API keys
  - Missing CancellationToken on async methods

  Write SECURITY-REGRESSION-REPORT.md with:
  - Summary: X/50 findings still resolved, Y new regressions found
  - Per-category status table
  - New v5.0 security concerns if any
  - Remediation actions needed
  </action>
  <verify>Report exists with status for all 50 findings</verify>
  <done>All 50 pentest findings verified as still resolved, new regressions documented if any</done>
</task>

<task type="auto">
  <name>Task 2: Security pattern enforcement tests for v5.0 plugins</name>
  <files>DataWarehouse.Tests/Integration/SecurityRegressionTests.cs</files>
  <action>
  Create SecurityRegressionTests.cs with:

  1. NoTlsBypasses: scan all .cs files for `ServerCertificateValidationCallback` returning true unconditionally, `ServicePointManager.ServerCertificateValidationCallback`, `HttpClientHandler.ServerCertificateCustomValidationCallback` returning true. Assert zero matches.
  2. NoHardcodedSecrets: scan for patterns like `password = "`, `apiKey = "`, `secret = "`, `token = "` with literal string values (not configuration lookups). Exclude test files. Assert zero matches.
  3. AllAsyncMethodsHaveCancellation: for v5.0 plugin .cs files, scan async method signatures and verify they include CancellationToken parameter. Report violations as warnings (not hard failures, as some internal methods legitimately skip it).
  4. NoUnsafeAssemblyLoading: scan for `Assembly.LoadFrom`, `Assembly.Load(byte[])`, `Activator.CreateInstance` with user-controlled type names. Assert zero matches outside of the plugin marketplace's verified loading path.
  5. PathTraversalProtection: scan for `Path.Combine` usage where the second argument could be user input (heuristic: method parameters named path, filePath, name, key). Verify nearby code includes path sanitization (Path.GetFileName, Contains("..") check, or Guards.ValidatePath).
  6. MessageBusAuthenticationUsed: verify new v5.0 plugins that publish/subscribe use IAuthenticatedMessageBus (not raw IMessageBus). Check constructor parameters and field types.

  Use xUnit. All tests parse source files statically.
  </action>
  <verify>Run `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter "FullyQualifiedName~SecurityRegression"` -- all tests pass</verify>
  <done>Zero security regressions detected, all new plugins follow security patterns</done>
</task>

</tasks>

<verification>
- SECURITY-REGRESSION-REPORT.md confirms all 50 findings resolved
- All SecurityRegression tests pass
- No new TLS bypasses, hardcoded secrets, or unsafe patterns
</verification>

<success_criteria>
50/50 pentest findings still resolved. Zero new security regressions from v5.0 features. All new plugins use authenticated message bus.
</success_criteria>

<output>
After completion, create `.planning/phases/66-integration/66-05-SUMMARY.md`
</output>
