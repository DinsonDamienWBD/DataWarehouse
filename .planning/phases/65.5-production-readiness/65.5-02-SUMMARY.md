---
phase: 65.5-production-readiness
plan: 02
subsystem: plugins
tags: [lifecycle, DataPipeline, OnStartCoreAsync, OnStopCoreAsync, SaveStateAsync, persistence]

requires:
  - phase: 65.4-strategy-dispatch
    provides: Strategy-aware plugin base infrastructure
provides:
  - All 6 DataPipeline-branch plugins using correct SDK lifecycle hooks
  - UltimateReplication node identity persisted across restarts
  - UltimateDataLake catalog/lineage/policies persisted via SaveStateAsync
  - UltimateDatabaseStorage properly calling base.OnHandshakeAsync
  - UltimateStorageProcessing accurate error statistics
affects: [65.5-production-readiness, 66-integration, 67-certification]

tech-stack:
  added: []
  patterns:
    - "OnStartCoreAsync/OnStopCoreAsync lifecycle pattern for DataPipeline plugins"
    - "SaveStateAsync/LoadStateAsync for plugin state persistence"

key-files:
  modified:
    - Plugins/DataWarehouse.Plugins.UltimateDataTransit/UltimateDataTransitPlugin.cs
    - Plugins/DataWarehouse.Plugins.UltimateFilesystem/UltimateFilesystemPlugin.cs
    - Plugins/DataWarehouse.Plugins.UltimateReplication/UltimateReplicationPlugin.cs
    - Plugins/DataWarehouse.Plugins.UltimateDatabaseStorage/UltimateDatabaseStoragePlugin.cs
    - Plugins/DataWarehouse.Plugins.UltimateDataLake/UltimateDataLakePlugin.cs
    - Plugins/DataWarehouse.Plugins.UltimateStorageProcessing/UltimateStorageProcessingPlugin.cs

key-decisions:
  - "DataTransit/Filesystem: Replace direct StartAsync/StopAsync overrides with OnStartCoreAsync/OnStopCoreAsync to preserve IntelligenceAwarePluginBase lifecycle orchestration"
  - "UltimateReplication: Persist nodeId via SaveStateAsync to maintain identity across restarts"
  - "UltimateDataLake: Persist catalog/lineage/policies via JSON serialization through SaveStateAsync/LoadStateAsync"
  - "UltimateStorageProcessing: Remove _totalProcessed increment from error catch path to avoid double-counting"

patterns-established:
  - "DataPipeline plugins must never override StartAsync/StopAsync directly; use OnStartCoreAsync/OnStopCoreAsync"
  - "OnHandshakeAsync overrides must call base.OnHandshakeAsync for capability/knowledge registration"

duration: 4min
completed: 2026-02-23
---

# Phase 65.5 Plan 02: Fix Lifecycle Bypasses in 6 DataPipeline Plugins Summary

**Fixed SDK lifecycle hook usage (OnStartCoreAsync/OnStopCoreAsync) in 6 DataPipeline-branch plugins with node identity persistence and error stats correction**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-23T07:53:40Z
- **Completed:** 2026-02-23T07:58:09Z
- **Tasks:** 1
- **Files modified:** 6

## Accomplishments
- UltimateDataTransit and UltimateFilesystem now use OnStartCoreAsync/OnStopCoreAsync instead of directly overriding StartAsync/StopAsync, preserving Intelligence discovery, subscription management, and pending request cleanup
- UltimateReplication persists _nodeId via SaveStateAsync/LoadStateAsync so node identity survives restarts; OnHandshakeAsync now calls base
- UltimateDatabaseStorage OnHandshakeAsync now calls base.OnHandshakeAsync for proper capability and knowledge registration
- UltimateDataLake adds full state persistence for catalog, lineage, and access policies via SaveStateAsync/LoadStateAsync with JSON serialization
- UltimateStorageProcessing no longer double-counts errors in _totalProcessed (error path only increments _totalFailures)

## Task Commits

1. **Task 1: Fix lifecycle bypasses in 6 DataPipeline plugins** - `08535cd4` (fix)

## Files Created/Modified
- `Plugins/DataWarehouse.Plugins.UltimateDataTransit/UltimateDataTransitPlugin.cs` - StartAsync/StopAsync replaced with OnStartCoreAsync/OnStopCoreAsync
- `Plugins/DataWarehouse.Plugins.UltimateFilesystem/UltimateFilesystemPlugin.cs` - StartAsync/StopAsync replaced with OnStartCoreAsync/OnStopCoreAsync
- `Plugins/DataWarehouse.Plugins.UltimateReplication/UltimateReplicationPlugin.cs` - _nodeId persisted via SaveStateAsync, base.OnHandshakeAsync called
- `Plugins/DataWarehouse.Plugins.UltimateDatabaseStorage/UltimateDatabaseStoragePlugin.cs` - OnHandshakeAsync calls base.OnHandshakeAsync
- `Plugins/DataWarehouse.Plugins.UltimateDataLake/UltimateDataLakePlugin.cs` - OnStartCoreAsync loads persisted state, OnStopCoreAsync saves state
- `Plugins/DataWarehouse.Plugins.UltimateStorageProcessing/UltimateStorageProcessingPlugin.cs` - Removed _totalProcessed increment from catch block

## Decisions Made
- DataTransit/Filesystem StartAsync/StopAsync overrides were bypassing the full IntelligenceAwarePluginBase lifecycle (Intelligence discovery, topic subscription, pending request cleanup). Replacing with OnStartCoreAsync/OnStopCoreAsync preserves all base class orchestration.
- UltimateReplication nodeId was regenerated on every handshake, meaning node identity changed on restart. Now persisted via SaveStateAsync with UTF-8 encoding.
- UltimateDatabaseStorage was building its own HandshakeResponse without calling base, bypassing capability and knowledge registration. Now delegates to base.OnHandshakeAsync.
- UltimateDataLake used BoundedDictionary for catalog/lineage/policies but never persisted them. Added JSON-based persistence on stop and restoration on start with graceful degradation on deserialization failure.
- UltimateStorageProcessing catch block incremented both _totalProcessed and _totalFailures. Since _totalProcessed is meant to track successful operations, removed the duplicate increment from the error path.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- All 6 DataPipeline-branch plugins now correctly participate in SDK lifecycle
- Ready for remaining 65.5 production readiness plans

---
*Phase: 65.5-production-readiness*
*Completed: 2026-02-23*
