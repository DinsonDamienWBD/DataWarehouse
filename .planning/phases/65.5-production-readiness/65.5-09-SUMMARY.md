---
phase: 65.5-production-readiness
plan: 09
subsystem: plugins
tags: [p0-fix, functional-breakage, visibility, persistence, key-mismatch, state-management]
dependency_graph:
  requires: [65.5-05, 65.5-06, 65.5-07, 65.5-08]
  provides: [p0-fixes-complete, plugin-functional-correctness]
  affects: [UltimateDataTransit, UltimateRAID, UltimateWorkflow, UltimateDataIntegrity, UltimateCompression, AirGapBridge, UltimateEncryption]
tech_stack:
  patterns: [state-persistence, SaveStateAsync/LoadStateAsync, message-bus-subscription]
key_files:
  modified:
    - Plugins/DataWarehouse.Plugins.UltimateDataTransit/UltimateDataTransitPlugin.cs
    - Plugins/DataWarehouse.Plugins.UltimateRAID/RaidTopics.cs
    - Plugins/DataWarehouse.Plugins.UltimateRAID/UltimateRaidPlugin.cs
    - Plugins/DataWarehouse.Plugins.UltimateWorkflow/UltimateWorkflowPlugin.cs
    - Plugins/DataWarehouse.Plugins.UltimateWorkflow/Strategies/AIEnhanced/AIEnhancedStrategies.cs
    - Plugins/DataWarehouse.Plugins.UltimateDataIntegrity/UltimateDataIntegrityPlugin.cs
    - Plugins/DataWarehouse.Plugins.UltimateCompression/UltimateCompressionPlugin.cs
    - Plugins/DataWarehouse.Plugins.AirGapBridge/AirGapBridgePlugin.cs
    - Plugins/DataWarehouse.Plugins.UltimateEncryption/UltimateEncryptionPlugin.cs
decisions:
  - "HMAC algorithms removed from SupportedAlgorithms (span-based API has no key parameter; callers use async keyed API instead)"
  - "AirGapBridge _masterKey changed from readonly to mutable to allow loading persisted key on restart"
  - "UltimateWorkflow strategy key aligned to class name convention: AIOptimized -> AIOptimizedWorkflow"
metrics:
  duration: 5min
  completed: 2026-02-23T08:23:00Z
---

# Phase 65.5 Plan 09: Fix P0/P1/P2 Functional Breakage Summary

Fix critical functional breakage across 7 plugins: visibility, subscription, key mismatch, advertised-but-throwing algorithms, empty handlers, and state persistence.

## Changes

### 1. UltimateDataTransit (P0: Invisible to Kernel)
- **Issue:** Class declared `internal sealed` -- kernel assembly scanning cannot discover it
- **Fix:** Changed to `public sealed class`
- **Impact:** Plugin now visible to kernel discovery and can be loaded at runtime

### 2. UltimateRAID (P0: Init Unreachable)
- **Issue:** `HandleInitializeAsync` method existed but `RaidTopics.Initialize` constant was missing, and no subscription was registered in `OnStartCoreAsync`
- **Fix:** Added `RaidTopics.Initialize = "raid.ultimate.initialize"` constant and `MessageBus.Subscribe(RaidTopics.Initialize, HandleInitializeAsync)` in OnStartCoreAsync
- **Impact:** RAID array initialization now reachable via message bus

### 3. UltimateWorkflow (P0: Runtime Exception)
- **Issue:** `AIOptimizedWorkflowStrategy` class had StrategyName `"AIOptimized"` but plugin lookup used `"AIOptimized"` -- mismatch with class name convention. StrategyId derived as `StrategyName.Replace(" ", "")` = `"AIOptimized"`, but the expected convention is `"AIOptimizedWorkflow"` matching the class name prefix
- **Fix:** Changed StrategyName from `"AIOptimized"` to `"AIOptimizedWorkflow"` and updated lookup in `HandleOptimizeWorkflowAsync`
- **Impact:** AI optimization workflow strategy now correctly resolved

### 4. UltimateDataIntegrity (P2: Advertised But Throws)
- **Issue:** 6 HMAC algorithms listed in `SupportedAlgorithms` but `ComputeHashCore` (span-based API) throws `NotSupportedException` for them because the method signature has no key parameter
- **Fix:** Removed HMAC entries from `SupportedAlgorithms`. Added XML remarks documenting that HMAC is available via the keyed async API
- **Impact:** Callers iterating SupportedAlgorithms no longer hit NotSupportedException

### 5. UltimateCompression (Empty List Handler)
- **Issue:** `compression.ultimate.list` message handler had an empty body with only a comment
- **Fix:** Populated handler to return strategy list with algorithm name, streaming/parallel support, compression ratio, and speeds
- **Impact:** Strategy enumeration via message bus now returns actual data

### 6. AirGapBridge (P1: Key Lost on Restart)
- **Issue:** `_masterKey` generated randomly in constructor, never persisted. After restart, new key generated, making previously exported packages unreadable
- **Fix:** Changed `_masterKey` from `readonly` to mutable. In `StartAsync`, load persisted key via `LoadStateAsync("masterKey")`. On first run, persist via `SaveStateAsync`. Re-initialize dependent components when loading persisted key
- **Impact:** Exported packages remain readable across plugin restarts

### 7. UltimateEncryption (State Lost on Restart)
- **Issue:** FIPS mode and default strategy settings were volatile in-memory only, lost on restart
- **Fix:** Added `LoadStateAsync` in `OnStartCoreAsync` to restore fipsMode and defaultStrategy. Added `SaveStateAsync` calls in `HandleSetDefaultAsync` and `HandleSetFipsAsync` to persist changes
- **Impact:** User configuration survives plugin restarts

## Verification

All 7 projects build with zero errors, zero warnings:
- `dotnet build` on each of the 7 affected `.csproj` files: all PASS

## Deviations from Plan

None -- plan executed exactly as written.

## Commits

| Task | Commit | Description |
|------|--------|-------------|
| 1 | 76d04a17 | fix(65.5-09): fix P0/P1/P2 functional breakage across 7 plugins |
