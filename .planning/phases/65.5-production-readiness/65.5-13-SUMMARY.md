---
phase: 65.5-production-readiness
plan: 13
subsystem: plugins
tags: [plugin-consolidation, strategy-pattern, kubernetes-csi, sql-over-object, app-platform]

requires:
  - phase: 65.5-09
    provides: Plugin consolidation wave 3 groundwork
  - phase: 65.5-10
    provides: Plugin consolidation wave 3 continued
provides:
  - KubernetesCsiStorageStrategy in UltimateStorage
  - SqlOverObjectProtocolStrategy in UltimateDatabaseProtocol
  - AppHostingStrategy and AppRuntimeStrategy in UltimateDeployment
  - Net reduction of 3 plugin projects from solution
affects: [UltimateStorage, UltimateDatabaseProtocol, UltimateDeployment, solution-structure]

tech-stack:
  added: []
  patterns: [plugin-to-strategy-conversion, assembly-scanning-auto-discovery]

key-files:
  created:
    - Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Kubernetes/KubernetesCsiStorageStrategy.cs
    - Plugins/DataWarehouse.Plugins.UltimateDatabaseProtocol/Strategies/Virtualization/SqlOverObjectProtocolStrategy.cs
    - Plugins/DataWarehouse.Plugins.UltimateDeployment/Strategies/AppPlatform/AppHostingStrategy.cs
    - Plugins/DataWarehouse.Plugins.UltimateDeployment/Strategies/AppPlatform/AppRuntimeStrategy.cs
  modified:
    - DataWarehouse.slnx
    - DataWarehouse.Tests/DataWarehouse.Tests.csproj
    - DataWarehouse.Tests/Plugins/KubernetesCsiTests.cs
    - DataWarehouse.Tests/Plugins/VirtualizationSqlOverObjectTests.cs
    - DataWarehouse.Tests/Plugins/AppPlatformTests.cs

key-decisions:
  - "KubernetesCsi converted from InterfacePluginBase to UltimateStorageStrategyBase with CSI volume/snapshot operations as public methods"
  - "SqlOverObject converted from DataVirtualizationPluginBase to DatabaseProtocolStrategyBase with SQL parsing and virtual table management"
  - "AppPlatform split into two DeploymentStrategyBase strategies: AppHostingStrategy (registration, tokens, policies) and AppRuntimeStrategy (AI workflows, observability, budget enforcement)"
  - "All strategies auto-discovered via assembly scanning â€” no manual registration needed"

patterns-established:
  - "Plugin-to-strategy conversion: preserve domain-specific operations as public methods while implementing the strategy base abstract members"

duration: 32min
completed: 2026-02-23
---

# Phase 65.5 Plan 13: Consolidate Storage + Protocol + Deployment Plugins Summary

**3 standalone plugins merged into existing Ultimate* targets as strategy classes, reducing solution project count by 3 with zero build errors.**

## What Was Done

### Task 1: Consolidate 3 plugins into existing targets

Merged three standalone plugins into their natural parent plugins as strategy classes:

1. **KubernetesCsi -> UltimateStorage** (`KubernetesCsiStorageStrategy`)
   - Converted from `InterfacePluginBase` to `UltimateStorageStrategyBase`
   - Implements `StoreAsyncCore`, `RetrieveAsyncCore`, `DeleteAsyncCore`, `ListAsyncCore`, `GetMetadataAsyncCore`, `GetHealthAsyncCore`, `GetAvailableCapacityAsyncCore`
   - Preserves full CSI specification: volume create/delete/expand, snapshot create/delete, node stage/unstage/publish, storage classes, topology constraints
   - All internal types (CsiVolume, CsiSnapshot, NodeStageInfo, NodePublishInfo, StorageClassConfig, TopologySegment) moved as nested private classes

2. **SqlOverObject -> UltimateDatabaseProtocol** (`SqlOverObjectProtocolStrategy`)
   - Converted from `DataVirtualizationPluginBase` to `DatabaseProtocolStrategyBase`
   - Implements `ExecuteQueryCoreAsync`, `ExecuteNonQueryCoreAsync`, `PerformHandshakeAsync`, `AuthenticateAsync`
   - Preserves SQL-over-Object capabilities: schema inference (CSV/JSON), virtual table registry, predicate pushdown, columnar projection, aggregation engine, query caching, partition pruning
   - Read-only strategy (non-query returns error as virtual tables are immutable)

3. **AppPlatform -> UltimateDeployment** (2 strategies)
   - `AppHostingStrategy`: Application registration, service tokens, access policy binding, service endpoint catalog
   - `AppRuntimeStrategy`: Per-app AI workflow management with budget/concurrency enforcement, observability with app_id isolation, telemetry routing
   - Both extend `DeploymentStrategyBase` with proper `DeployCoreAsync`, `RollbackCoreAsync`, `ScaleCoreAsync`, `HealthCheckCoreAsync`, `GetStateCoreAsync`

### Cleanup
- Deleted 3 plugin project directories (KubernetesCsi, SqlOverObject, AppPlatform) with all source files
- Removed 3 project references from `DataWarehouse.slnx`
- Removed 3 project references from `DataWarehouse.Tests.csproj`
- Updated 3 test files to verify new strategy classes instead of deleted plugin classes

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] SDK interface mismatch for StorageStrategyBase**
- **Found during:** Task 1 (KubernetesCsi merge)
- **Issue:** Initial implementation used incorrect method signatures (RetrieveAsyncCore returning StorageRetrieveResult, DeleteAsyncCore returning bool, ListKeysAsyncCore, CheckHealthAsyncCore) that don't match the actual SDK StorageStrategyBase abstract members
- **Fix:** Corrected all method signatures to match SDK: RetrieveAsyncCore returns Stream, DeleteAsyncCore returns Task, ListAsyncCore returns IAsyncEnumerable<StorageObjectMetadata>, GetHealthAsyncCore, GetAvailableCapacityAsyncCore, and StorageObjectMetadata uses Modified/Created/CustomMetadata fields
- **Files modified:** KubernetesCsiStorageStrategy.cs

**2. [Rule 1 - Bug] SDK interface mismatch for DatabaseProtocolStrategyBase**
- **Found during:** Task 1 (SqlOverObject merge)
- **Issue:** Initial implementation used IDictionary<string, object> parameters instead of IReadOnlyDictionary<string, object?>, and included non-existent abstract methods (DisconnectCoreAsync, BeginTransactionCoreAsync, etc.)
- **Fix:** Corrected ExecuteQueryCoreAsync and ExecuteNonQueryCoreAsync signatures, removed non-existent overrides, used ColumnMetadata instead of ColumnInfo
- **Files modified:** SqlOverObjectProtocolStrategy.cs

**3. [Rule 3 - Blocking] Test project references to deleted plugins**
- **Found during:** Build verification
- **Issue:** DataWarehouse.Tests referenced the 3 deleted plugin projects, causing CS0234 namespace errors
- **Fix:** Removed project references from Tests.csproj, rewrote test files to test new strategy classes
- **Files modified:** DataWarehouse.Tests.csproj, KubernetesCsiTests.cs, VirtualizationSqlOverObjectTests.cs, AppPlatformTests.cs

**4. [Rule 1 - Bug] Nullability mismatches in CSI operations**
- **Found during:** Build verification
- **Issue:** CreateErrorResponse and CreateSnapshotResponse returned Dictionary<string, object> but callers expected Dictionary<string, object?>
- **Fix:** Updated return types to Dictionary<string, object?> throughout CSI operations
- **Files modified:** KubernetesCsiStorageStrategy.cs

## Verification

- `dotnet build DataWarehouse.slnx` -- Build succeeded, zero errors
- 3 plugin directories confirmed deleted
- 3 project references confirmed removed from .slnx
- 4 new strategy files confirmed created in target plugin directories

## Commits

| Task | Commit | Description |
|------|--------|-------------|
| 1    | 67b590d2 | feat(65.5-13): consolidate 3 plugins into existing targets (net -3) |

## Self-Check: PASSED

- [x] KubernetesCsiStorageStrategy.cs exists
- [x] SqlOverObjectProtocolStrategy.cs exists
- [x] AppHostingStrategy.cs exists
- [x] AppRuntimeStrategy.cs exists
- [x] KubernetesCsi directory deleted
- [x] SqlOverObject directory deleted
- [x] AppPlatform directory deleted
- [x] SUMMARY.md exists
- [x] Commit 67b590d2 exists
