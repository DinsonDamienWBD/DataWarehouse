---
phase: 63-universal-fabric
plan: 14
type: execute
wave: 4
depends_on: ["63-06", "63-07"]
files_modified:
  - Clients/java/pom.xml
  - Clients/java/src/main/java/com/datawarehouse/client/DataWarehouseClient.java
  - Clients/java/src/main/java/com/datawarehouse/client/S3CompatClient.java
  - Clients/java/src/main/java/com/datawarehouse/client/DwUri.java
autonomous: true

must_haves:
  truths:
    - "Java client connects to DataWarehouse S3-compatible endpoint using AWS SDK for Java v2"
    - "Java client supports get, put, delete, list operations"
    - "Java package builds with Maven"
  artifacts:
    - path: "Clients/java/src/main/java/com/datawarehouse/client/DataWarehouseClient.java"
      provides: "Main DataWarehouse Java client"
      contains: "public class DataWarehouseClient"
    - path: "Clients/java/src/main/java/com/datawarehouse/client/S3CompatClient.java"
      provides: "S3-compatible operations"
      contains: "public class S3CompatClient"
    - path: "Clients/java/pom.xml"
      provides: "Maven project definition"
      contains: "<artifactId>dw-client</artifactId>"
  key_links:
    - from: "Clients/java/src/main/java/com/datawarehouse/client/S3CompatClient.java"
      to: "Plugins/DataWarehouse.Plugins.UniversalFabric/S3Server/S3HttpServer.cs"
      via: "S3 HTTP protocol"
      pattern: "S3Client"
---

<objective>
Create the Java cross-language client SDK for DataWarehouse.

Purpose: Java is the dominant enterprise language. This client SDK allows Java and JVM-based applications to interact with DataWarehouse via the S3-compatible API.

Output: Maven-buildable Java package with S3-compatible and native dw:// clients.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/63-universal-fabric/63-06-SUMMARY.md
@DataWarehouse.SDK/Storage/Fabric/S3Types.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Maven project and S3-compatible Java client</name>
  <files>Clients/java/pom.xml, Clients/java/src/main/java/com/datawarehouse/client/S3CompatClient.java</files>
  <action>
1. Create directory: Clients/java/src/main/java/com/datawarehouse/client/

2. pom.xml:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0">
    <modelVersion>4.0.0</modelVersion>
    <groupId>com.datawarehouse</groupId>
    <artifactId>dw-client</artifactId>
    <version>5.0.0</version>
    <properties>
        <maven.compiler.source>17</maven.compiler.source>
        <maven.compiler.target>17</maven.compiler.target>
        <aws.sdk.version>2.24.0</aws.sdk.version>
    </properties>
    <dependencies>
        <dependency>
            <groupId>software.amazon.awssdk</groupId>
            <artifactId>s3</artifactId>
            <version>${aws.sdk.version}</version>
        </dependency>
        <dependency>
            <groupId>software.amazon.awssdk</groupId>
            <artifactId>s3-transfer-manager</artifactId>
            <version>${aws.sdk.version}</version>
        </dependency>
    </dependencies>
</project>
```

3. S3CompatClient.java:
```java
package com.datawarehouse.client;

import software.amazon.awssdk.auth.credentials.StaticCredentialsProvider;
import software.amazon.awssdk.auth.credentials.AwsBasicCredentials;
import software.amazon.awssdk.core.sync.RequestBody;
import software.amazon.awssdk.regions.Region;
import software.amazon.awssdk.services.s3.S3Client;
import software.amazon.awssdk.services.s3.S3Configuration;
import software.amazon.awssdk.services.s3.model.*;
import software.amazon.awssdk.services.s3.presigner.S3Presigner;
import java.io.*;
import java.net.URI;
import java.time.Duration;
import java.util.*;
import java.util.stream.Collectors;

public class S3CompatClient implements AutoCloseable {
    private final S3Client s3;
    private final S3Presigner presigner;

    public S3CompatClient(String endpoint, String accessKey, String secretKey, String region) {
        // Create S3Client with custom endpoint, path-style addressing, static credentials
    }

    // Bucket operations
    public List<Bucket> listBuckets() { ... }
    public void createBucket(String name) { ... }
    public void deleteBucket(String name) { ... }
    public boolean bucketExists(String name) { ... }

    // Object operations
    public String putObject(String bucket, String key, InputStream body, long contentLength,
                           String contentType, Map<String, String> metadata) { ... }
    public InputStream getObject(String bucket, String key) { ... }
    public void deleteObject(String bucket, String key) { ... }
    public ObjectInfo headObject(String bucket, String key) { ... }
    public List<ObjectInfo> listObjects(String bucket, String prefix, int maxKeys) { ... }
    public boolean objectExists(String bucket, String key) { ... }

    // Copy
    public void copyObject(String srcBucket, String srcKey, String dstBucket, String dstKey) { ... }

    // Presigned URLs
    public String presignGet(String bucket, String key, Duration expiry) { ... }
    public String presignPut(String bucket, String key, Duration expiry) { ... }

    @Override
    public void close() { s3.close(); presigner.close(); }
}
```

ObjectInfo record class:
```java
public record ObjectInfo(String key, long size, java.time.Instant lastModified,
                          String etag, String contentType, Map<String, String> metadata) {}
```

All methods fully implemented using AWS SDK for Java v2 (not stubs).
  </action>
  <verify>cd Clients/java && mvn compile -q 2>&1 | tail -5</verify>
  <done>Java S3 client compiles with Maven and wraps all S3 operations via AWS SDK</done>
</task>

<task type="auto">
  <name>Task 2: Create native Java DataWarehouse client with dw:// addressing</name>
  <files>Clients/java/src/main/java/com/datawarehouse/client/DataWarehouseClient.java, Clients/java/src/main/java/com/datawarehouse/client/DwUri.java</files>
  <action>
1. DwUri.java -- URI parser:
```java
package com.datawarehouse.client;

public record DwUri(String bucket, String key) {
    public static DwUri parse(String uri) {
        String cleaned = uri;
        if (cleaned.startsWith("dw://")) cleaned = cleaned.substring(5);
        else if (cleaned.startsWith("s3://")) cleaned = cleaned.substring(5);
        else throw new IllegalArgumentException("URI must start with dw:// or s3://: " + uri);

        int slashIdx = cleaned.indexOf('/');
        if (slashIdx < 0) return new DwUri(cleaned, "");
        String bucket = cleaned.substring(0, slashIdx);
        String key = cleaned.substring(slashIdx + 1);
        if (bucket.isEmpty()) throw new IllegalArgumentException("Missing bucket name: " + uri);
        return new DwUri(bucket, key);
    }

    @Override
    public String toString() { return "dw://" + bucket + "/" + key; }
}
```

2. DataWarehouseClient.java:
```java
package com.datawarehouse.client;

import java.io.*;
import java.time.Duration;
import java.util.*;

public class DataWarehouseClient implements AutoCloseable {
    private final S3CompatClient s3;

    public DataWarehouseClient(String endpoint, String accessKey, String secretKey) {
        this(endpoint, accessKey, secretKey, "us-east-1");
    }

    public DataWarehouseClient(String endpoint, String accessKey, String secretKey, String region) {
        this.s3 = new S3CompatClient(endpoint, accessKey, secretKey, region);
    }

    // dw:// operations
    public void store(String dwUri, byte[] data) { ... }
    public void store(String dwUri, InputStream data, long contentLength) { ... }
    public byte[] retrieve(String dwUri) { ... }
    public InputStream retrieveStream(String dwUri) { ... }
    public void delete(String dwUri) { ... }
    public boolean exists(String dwUri) { ... }
    public List<ObjectInfo> list(String dwUri) { ... }
    public void copy(String srcUri, String dstUri) { ... }

    // Bucket management
    public void createBucket(String name) { s3.createBucket(name); }
    public void deleteBucket(String name) { s3.deleteBucket(name); }
    public List<software.amazon.awssdk.services.s3.model.Bucket> listBuckets() { return s3.listBuckets(); }

    // Presigned URLs
    public String presignGet(String dwUri, Duration expiry) { ... }
    public String presignPut(String dwUri, Duration expiry) { ... }

    // Access underlying S3 client
    public S3CompatClient s3() { return s3; }

    @Override
    public void close() { s3.close(); }
}
```

All methods fully implemented by parsing dw:// URI and delegating to S3CompatClient.
  </action>
  <verify>cd Clients/java && mvn compile -q 2>&1 | tail -5</verify>
  <done>Java DataWarehouse client compiles with dw:// addressing and all methods implemented</done>
</task>

</tasks>

<verification>
- `mvn compile` succeeds
- All public methods have Javadoc comments
- dw:// URI parsing handles edge cases
</verification>

<success_criteria>
- Java client connects to DataWarehouse S3 endpoint via AWS SDK v2
- dw:// URIs parsed correctly
- AutoCloseable for resource management
</success_criteria>

<output>
After completion, create `.planning/phases/63-universal-fabric/63-14-SUMMARY.md`
</output>
