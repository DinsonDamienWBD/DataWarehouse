---
phase: 63-universal-fabric
plan: 10
type: execute
wave: 2
depends_on: ["63-02"]
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateStorage/DataWarehouse.Plugins.UltimateStorage.csproj
  - Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Cloud/S3Strategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Cloud/AzureBlobStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Cloud/GcsStrategy.cs
autonomous: true

must_haves:
  truths:
    - "AWSSDK.S3 NuGet package is referenced and S3Strategy uses real SDK calls"
    - "Azure.Storage.Blobs NuGet package is referenced and AzureBlobStrategy uses real SDK calls"
    - "Google.Cloud.Storage.V1 NuGet package is referenced and GcsStrategy uses real SDK calls"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateStorage/DataWarehouse.Plugins.UltimateStorage.csproj"
      provides: "NuGet package references for cloud SDKs"
      contains: "AWSSDK.S3"
    - path: "Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Cloud/S3Strategy.cs"
      provides: "S3Strategy using AWSSDK.S3"
      contains: "AmazonS3Client"
    - path: "Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Cloud/AzureBlobStrategy.cs"
      provides: "AzureBlobStrategy using Azure.Storage.Blobs"
      contains: "BlobServiceClient"
  key_links:
    - from: "Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Cloud/S3Strategy.cs"
      to: "AWSSDK.S3"
      via: "NuGet package reference"
      pattern: "Amazon.S3"
---

<objective>
Wire real cloud SDK NuGet dependencies into UltimateStorage cloud strategies.

Purpose: The existing S3Strategy, AzureBlobStrategy, and GcsStrategy use raw HttpClient with manual signature generation. While functional, using official SDKs provides better reliability, automatic retry, credential management, and keeps up with API changes. This plan adds AWSSDK.S3, Azure.Storage.Blobs, and Google.Cloud.Storage.V1 as real dependencies and refactors the strategies to use them.

Output: Three cloud strategies using official SDKs instead of raw HTTP.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/PLUGIN-CATALOG.md
@Plugins/DataWarehouse.Plugins.UltimateStorage/DataWarehouse.Plugins.UltimateStorage.csproj
@Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Cloud/S3Strategy.cs
@Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Cloud/AzureBlobStrategy.cs
@Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Cloud/GcsStrategy.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cloud SDK NuGet references and refactor S3Strategy to use AWSSDK.S3</name>
  <files>Plugins/DataWarehouse.Plugins.UltimateStorage/DataWarehouse.Plugins.UltimateStorage.csproj, Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Cloud/S3Strategy.cs</files>
  <action>
1. Add NuGet packages to .csproj:
   - AWSSDK.S3 (latest stable)
   - Azure.Storage.Blobs (latest stable)
   - Google.Cloud.Storage.V1 (latest stable)

   Use `dotnet add package` commands to add with pinned versions.

2. Refactor S3Strategy to use Amazon.S3.AmazonS3Client:

   Replace the manual HttpClient + Signature V4 implementation with:
   - Use `AmazonS3Client` from AWSSDK.S3
   - InitializeCoreAsync: create AmazonS3Client with AmazonS3Config (endpoint, region, path-style, timeout)
   - StoreAsyncCore: use PutObjectRequest or TransferUtility for multipart (threshold-based automatic)
   - RetrieveAsyncCore: use GetObjectRequest, return response.ResponseStream
   - DeleteAsyncCore: use DeleteObjectRequest
   - ExistsAsyncCore: use GetObjectMetadataRequest, catch AmazonS3Exception with "NotFound"
   - ListAsyncCore: use ListObjectsV2Request with ContinuationToken pagination
   - GetMetadataAsyncCore: use GetObjectMetadataRequest, map to StorageObjectMetadata
   - GetHealthAsyncCore: use ListBucketsAsync as health check, measure latency
   - GetAvailableCapacityAsyncCore: return null (S3 has no capacity concept)

   Preserve existing features:
   - Server-side encryption config (SSE-S3, SSE-KMS, SSE-C) -> SSEAlgorithm in PutObjectRequest
   - Storage class management -> StorageClass property
   - Versioning support -> VersionId in responses
   - S3-compatible endpoint support (MinIO etc.) via ServiceURL config
   - Path-style addressing via ForcePathStyle config

   Keep the manual Signature V4 code as a fallback option (configurable) for environments where AWSSDK.S3 cannot be used (embedded, air-gapped without NuGet). Guard with: `if (_useNativeClient) { /* AWSSDK path */ } else { /* manual HTTP path */ }`.

   Remove the raw HttpClient code paths that are fully covered by the SDK. Keep multipart upload if TransferUtility handles it.
  </action>
  <verify>dotnet build Plugins/DataWarehouse.Plugins.UltimateStorage/DataWarehouse.Plugins.UltimateStorage.csproj 2>&1 | tail -5</verify>
  <done>S3Strategy uses AmazonS3Client for all operations with manual HTTP as fallback; AWSSDK.S3 NuGet reference in csproj</done>
</task>

<task type="auto">
  <name>Task 2: Refactor AzureBlobStrategy and GcsStrategy to use official SDKs</name>
  <files>Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Cloud/AzureBlobStrategy.cs, Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Cloud/GcsStrategy.cs</files>
  <action>
1. AzureBlobStrategy -- refactor to use Azure.Storage.Blobs:

   Replace manual REST API calls with:
   - Use `BlobServiceClient` for service-level operations
   - Use `BlobContainerClient` for container (bucket) operations
   - Use `BlobClient` for blob operations
   - InitializeCoreAsync: create BlobServiceClient from connection string or DefaultAzureCredential
   - StoreAsyncCore: BlobClient.UploadAsync with BlobUploadOptions (metadata, access tier, overwrite)
   - RetrieveAsyncCore: BlobClient.DownloadStreamingAsync, return Content stream
   - DeleteAsyncCore: BlobClient.DeleteIfExistsAsync
   - ExistsAsyncCore: BlobClient.ExistsAsync
   - ListAsyncCore: BlobContainerClient.GetBlobsAsync with prefix
   - GetMetadataAsyncCore: BlobClient.GetPropertiesAsync, map BlobProperties to StorageObjectMetadata
   - GetHealthAsyncCore: BlobServiceClient.GetAccountInfoAsync as health check
   - Handle access tiers: Hot, Cool, Cold, Archive mapping to StorageTier

   Keep manual REST fallback option guarded by config flag.

2. GcsStrategy -- refactor to use Google.Cloud.Storage.V1:

   Replace manual REST API calls with:
   - Use `StorageClient` from Google.Cloud.Storage.V1
   - InitializeCoreAsync: StorageClient.Create() (uses default credentials) or from JSON key file
   - StoreAsyncCore: StorageClient.UploadObjectAsync
   - RetrieveAsyncCore: StorageClient.DownloadObjectAsync to a MemoryStream (or use MediaDownloader for streaming)
   - DeleteAsyncCore: StorageClient.DeleteObjectAsync
   - ExistsAsyncCore: try GetObjectAsync, catch Google.GoogleApiException with 404
   - ListAsyncCore: StorageClient.ListObjectsAsync with prefix
   - GetMetadataAsyncCore: StorageClient.GetObjectAsync, map Google.Apis.Storage.v1.Data.Object to StorageObjectMetadata
   - GetHealthAsyncCore: StorageClient.ListBucketsAsync as health check
   - Handle storage classes: STANDARD, NEARLINE, COLDLINE, ARCHIVE

   Keep manual REST fallback option guarded by config flag.

For both strategies, preserve the same StrategyId, Name, Tier, Capabilities values. The public API (IStorageStrategy) must remain identical.
  </action>
  <verify>dotnet build Plugins/DataWarehouse.Plugins.UltimateStorage/DataWarehouse.Plugins.UltimateStorage.csproj 2>&1 | tail -5</verify>
  <done>AzureBlobStrategy uses BlobServiceClient; GcsStrategy uses Google StorageClient; both with manual REST fallback; all three cloud SDKs wired as real NuGet dependencies</done>
</task>

</tasks>

<verification>
- `dotnet build Plugins/DataWarehouse.Plugins.UltimateStorage/` compiles with zero errors
- .csproj has PackageReference for AWSSDK.S3, Azure.Storage.Blobs, Google.Cloud.Storage.V1
- All three strategies preserve existing StrategyId and Capabilities
</verification>

<success_criteria>
- Official cloud SDKs are real NuGet dependencies (not stubs)
- Strategies use SDK clients for all operations
- Manual HTTP fallback preserved for air-gapped environments
- No breaking changes to IStorageStrategy contract
</success_criteria>

<output>
After completion, create `.planning/phases/63-universal-fabric/63-10-SUMMARY.md`
</output>
