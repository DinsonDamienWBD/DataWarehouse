---
phase: 63-universal-fabric
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.SDK/Storage/Fabric/IS3CompatibleServer.cs
  - DataWarehouse.SDK/Storage/Fabric/S3Types.cs
  - DataWarehouse.SDK/Storage/Fabric/IS3AuthProvider.cs
autonomous: true

must_haves:
  truths:
    - "IS3CompatibleServer defines the contract for an S3-compatible HTTP endpoint"
    - "S3 request/response types cover ListBuckets, GetObject, PutObject, DeleteObject, multipart, presigned URLs"
    - "IS3AuthProvider handles AWS Signature V4 authentication verification"
  artifacts:
    - path: "DataWarehouse.SDK/Storage/Fabric/IS3CompatibleServer.cs"
      provides: "S3 server contract"
      contains: "interface IS3CompatibleServer"
    - path: "DataWarehouse.SDK/Storage/Fabric/S3Types.cs"
      provides: "S3 API request/response DTOs"
      contains: "record S3Object"
    - path: "DataWarehouse.SDK/Storage/Fabric/IS3AuthProvider.cs"
      provides: "S3 auth verification contract"
      contains: "interface IS3AuthProvider"
  key_links:
    - from: "DataWarehouse.SDK/Storage/Fabric/IS3CompatibleServer.cs"
      to: "DataWarehouse.SDK/Storage/Fabric/IStorageFabric.cs"
      via: "uses IStorageFabric for backend operations"
      pattern: "IStorageFabric"
---

<objective>
Define SDK contracts for the S3-Compatible Server endpoint.

Purpose: DataWarehouse will expose an S3-compatible HTTP endpoint making it a drop-in replacement for MinIO/S3. This plan creates the interfaces and DTOs needed. The actual HTTP server implementation comes in plan 06.

Output: IS3CompatibleServer interface, S3 request/response DTOs, IS3AuthProvider for signature verification.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/PLUGIN-CATALOG.md
@DataWarehouse.SDK/Storage/Fabric/IStorageFabric.cs
@DataWarehouse.SDK/Contracts/Storage/StorageStrategy.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define IS3CompatibleServer and S3 operation contracts</name>
  <files>DataWarehouse.SDK/Storage/Fabric/IS3CompatibleServer.cs</files>
  <action>
Create IS3CompatibleServer in DataWarehouse.SDK.Storage.Fabric namespace:

```csharp
public interface IS3CompatibleServer : IDisposable, IAsyncDisposable
{
    // Server lifecycle
    Task StartAsync(S3ServerOptions options, CancellationToken ct = default);
    Task StopAsync(CancellationToken ct = default);
    bool IsRunning { get; }
    string? ListenUrl { get; }

    // Bucket operations
    Task<S3ListBucketsResponse> ListBucketsAsync(S3ListBucketsRequest request, CancellationToken ct = default);
    Task<S3CreateBucketResponse> CreateBucketAsync(S3CreateBucketRequest request, CancellationToken ct = default);
    Task DeleteBucketAsync(string bucketName, CancellationToken ct = default);
    Task<bool> BucketExistsAsync(string bucketName, CancellationToken ct = default);

    // Object operations
    Task<S3GetObjectResponse> GetObjectAsync(S3GetObjectRequest request, CancellationToken ct = default);
    Task<S3PutObjectResponse> PutObjectAsync(S3PutObjectRequest request, CancellationToken ct = default);
    Task DeleteObjectAsync(string bucketName, string key, CancellationToken ct = default);
    Task<S3HeadObjectResponse> HeadObjectAsync(string bucketName, string key, CancellationToken ct = default);
    Task<S3ListObjectsResponse> ListObjectsV2Async(S3ListObjectsRequest request, CancellationToken ct = default);

    // Multipart upload
    Task<S3InitiateMultipartResponse> InitiateMultipartUploadAsync(S3InitiateMultipartRequest request, CancellationToken ct = default);
    Task<S3UploadPartResponse> UploadPartAsync(S3UploadPartRequest request, CancellationToken ct = default);
    Task<S3CompleteMultipartResponse> CompleteMultipartUploadAsync(S3CompleteMultipartRequest request, CancellationToken ct = default);
    Task AbortMultipartUploadAsync(string bucketName, string key, string uploadId, CancellationToken ct = default);

    // Presigned URLs
    Task<string> GeneratePresignedUrlAsync(S3PresignedUrlRequest request, CancellationToken ct = default);

    // Copy
    Task<S3CopyObjectResponse> CopyObjectAsync(S3CopyObjectRequest request, CancellationToken ct = default);
}

public record S3ServerOptions
{
    public string Host { get; init; } = "0.0.0.0";
    public int Port { get; init; } = 9000;
    public bool UseTls { get; init; }
    public string? TlsCertPath { get; init; }
    public string? TlsKeyPath { get; init; }
    public string DefaultRegion { get; init; } = "us-east-1";
    public int MaxRequestBodyBytes { get; init; } = 5 * 1024 * 1024 * 1024; // 5GB
    public int MultipartChunkSize { get; init; } = 5 * 1024 * 1024; // 5MB minimum
    public TimeSpan RequestTimeout { get; init; } = TimeSpan.FromMinutes(30);
    public IS3AuthProvider? AuthProvider { get; init; }
}
```

Add [SdkCompatibility("5.0.0", Notes = "Phase 63: S3-Compatible Server")].
  </action>
  <verify>dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore 2>&1 | tail -5</verify>
  <done>IS3CompatibleServer interface and S3ServerOptions compile</done>
</task>

<task type="auto">
  <name>Task 2: Define S3 DTOs and IS3AuthProvider</name>
  <files>DataWarehouse.SDK/Storage/Fabric/S3Types.cs, DataWarehouse.SDK/Storage/Fabric/IS3AuthProvider.cs</files>
  <action>
1. S3Types.cs -- all S3 request/response records in DataWarehouse.SDK.Storage.Fabric:

Bucket types:
- S3ListBucketsRequest (empty for now -- auth handled separately)
- S3ListBucketsResponse { IReadOnlyList<S3Bucket> Buckets, string Owner }
- S3Bucket { string Name, DateTime CreationDate }
- S3CreateBucketRequest { string BucketName, string? Region }
- S3CreateBucketResponse { string BucketName, string Location }

Object types:
- S3Object { string Key, long Size, DateTime LastModified, string ETag, string StorageClass }
- S3GetObjectRequest { string BucketName, string Key, string? VersionId, string? Range }
- S3GetObjectResponse { Stream Body, string ContentType, long ContentLength, string ETag, IDictionary<string, string> Metadata, DateTime LastModified }
- S3PutObjectRequest { string BucketName, string Key, Stream Body, string? ContentType, IDictionary<string, string>? Metadata, string? StorageClass }
- S3PutObjectResponse { string ETag, string? VersionId }
- S3HeadObjectResponse { long ContentLength, string ContentType, string ETag, DateTime LastModified, IDictionary<string, string> Metadata }
- S3ListObjectsRequest { string BucketName, string? Prefix, string? Delimiter, int MaxKeys = 1000, string? ContinuationToken }
- S3ListObjectsResponse { IReadOnlyList<S3Object> Contents, IReadOnlyList<string> CommonPrefixes, bool IsTruncated, string? NextContinuationToken, int KeyCount }

Multipart types:
- S3InitiateMultipartRequest { string BucketName, string Key, string? ContentType, IDictionary<string, string>? Metadata }
- S3InitiateMultipartResponse { string UploadId, string BucketName, string Key }
- S3UploadPartRequest { string BucketName, string Key, string UploadId, int PartNumber, Stream Body }
- S3UploadPartResponse { string ETag, int PartNumber }
- S3CompletedPart { int PartNumber, string ETag }
- S3CompleteMultipartRequest { string BucketName, string Key, string UploadId, IReadOnlyList<S3CompletedPart> Parts }
- S3CompleteMultipartResponse { string ETag, string Key, string BucketName }

Other types:
- S3PresignedUrlRequest { string BucketName, string Key, S3PresignedMethod Method, TimeSpan Expiration }
- S3PresignedMethod enum { GET, PUT, DELETE }
- S3CopyObjectRequest { string SourceBucket, string SourceKey, string DestBucket, string DestKey }
- S3CopyObjectResponse { string ETag, DateTime LastModified }

All records, all with init-only setters. Use `required` for mandatory fields.

2. IS3AuthProvider.cs:
```csharp
public interface IS3AuthProvider
{
    // Validate an incoming S3 request's authorization header (AWS Signature V4)
    Task<S3AuthResult> AuthenticateAsync(S3AuthContext context, CancellationToken ct = default);

    // Generate credentials for a user/access key
    Task<S3Credentials> GetCredentialsAsync(string accessKeyId, CancellationToken ct = default);
}

public record S3AuthContext
{
    public required string HttpMethod { get; init; }
    public required string Path { get; init; }
    public required string QueryString { get; init; }
    public required IDictionary<string, string> Headers { get; init; }
    public string? AuthorizationHeader { get; init; }
    public byte[]? PayloadHash { get; init; }
}

public record S3AuthResult
{
    public bool IsAuthenticated { get; init; }
    public string? AccessKeyId { get; init; }
    public string? ErrorMessage { get; init; }
    public string? UserId { get; init; }
}

public record S3Credentials
{
    public required string AccessKeyId { get; init; }
    public required string SecretAccessKey { get; init; }
    public string? UserId { get; init; }
    public IReadOnlySet<string>? AllowedBuckets { get; init; }
    public bool IsAdmin { get; init; }
}
```
  </action>
  <verify>dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore 2>&1 | tail -5</verify>
  <done>All S3 DTOs and auth types compile; complete coverage of ListBuckets, Get/Put/Delete/Head/List objects, multipart, presigned URLs, copy</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` compiles with zero errors
- All S3 operation types are records with init-only setters
</verification>

<success_criteria>
- Complete S3 API coverage in SDK types
- Auth contract supports AWS Signature V4 verification
- All types immutable (records)
</success_criteria>

<output>
After completion, create `.planning/phases/63-universal-fabric/63-03-SUMMARY.md`
</output>
