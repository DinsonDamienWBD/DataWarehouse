---
phase: 63-universal-fabric
plan: 07
type: execute
wave: 3
depends_on: ["63-03"]
files_modified:
  - Plugins/DataWarehouse.Plugins.UniversalFabric/S3Server/S3SignatureV4.cs
  - Plugins/DataWarehouse.Plugins.UniversalFabric/S3Server/S3CredentialStore.cs
  - Plugins/DataWarehouse.Plugins.UniversalFabric/S3Server/S3BucketManager.cs
autonomous: true

must_haves:
  truths:
    - "S3SignatureV4 correctly verifies AWS Signature V4 authorization headers"
    - "S3CredentialStore manages access key/secret key pairs persistently"
    - "S3BucketManager tracks bucket-to-backend mappings and bucket metadata"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UniversalFabric/S3Server/S3SignatureV4.cs"
      provides: "AWS Signature V4 verification implementation"
      contains: "class S3SignatureV4"
    - path: "Plugins/DataWarehouse.Plugins.UniversalFabric/S3Server/S3CredentialStore.cs"
      provides: "Access key credential management"
      contains: "class S3CredentialStore"
    - path: "Plugins/DataWarehouse.Plugins.UniversalFabric/S3Server/S3BucketManager.cs"
      provides: "Bucket lifecycle and mapping management"
      contains: "class S3BucketManager"
  key_links:
    - from: "Plugins/DataWarehouse.Plugins.UniversalFabric/S3Server/S3SignatureV4.cs"
      to: "DataWarehouse.SDK/Storage/Fabric/IS3AuthProvider.cs"
      via: "implements IS3AuthProvider"
      pattern: "IS3AuthProvider"
---

<objective>
Implement S3 authentication (AWS Signature V4) and bucket management for the S3-compatible server.

Purpose: For DataWarehouse to be a true S3 drop-in replacement, it must verify AWS Signature V4 auth headers and manage bucket lifecycle (create, delete, list, map to backends). This plan adds the security and management layer.

Output: Working Sig V4 verification, credential store, and bucket manager.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/63-universal-fabric/63-03-SUMMARY.md
@DataWarehouse.SDK/Storage/Fabric/IS3AuthProvider.cs
@DataWarehouse.SDK/Storage/Fabric/S3Types.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement AWS Signature V4 verification</name>
  <files>Plugins/DataWarehouse.Plugins.UniversalFabric/S3Server/S3SignatureV4.cs</files>
  <action>
Implement S3SignatureV4 class that verifies AWS Signature V4 authorization headers per AWS spec.

IS3AuthProvider implementation:
- AuthenticateAsync(S3AuthContext context, CancellationToken ct):
  1. Parse the Authorization header: `AWS4-HMAC-SHA256 Credential=ACCESS_KEY/DATE/REGION/s3/aws4_request, SignedHeaders=HEADERS, Signature=SIG`
  2. Extract access key ID from Credential
  3. Look up secret key from credential store
  4. Reconstruct the canonical request:
     - HTTP method
     - Canonical URI (URL-encoded path)
     - Canonical query string (sorted)
     - Canonical headers (lowercase, trimmed, sorted)
     - Signed headers list
     - Payload hash (x-amz-content-sha256 header or "UNSIGNED-PAYLOAD")
  5. Create string to sign: `AWS4-HMAC-SHA256\n{timestamp}\n{scope}\n{hash(canonical_request)}`
  6. Derive signing key: HMAC-SHA256 chain: key = "AWS4" + secretKey, date, region, "s3", "aws4_request"
  7. Calculate signature: HMAC-SHA256(signingKey, stringToSign)
  8. Compare calculated signature with provided signature using constant-time comparison (CryptographicOperations.FixedTimeEquals)
  9. Return S3AuthResult with IsAuthenticated, AccessKeyId, UserId

Also handle:
- Query string auth (presigned URLs): X-Amz-Algorithm, X-Amz-Credential, X-Amz-Signature params
- Check X-Amz-Date or Date header for timestamp (reject if >15 min skew)
- Support "UNSIGNED-PAYLOAD" for chunked uploads

Use System.Security.Cryptography.HMACSHA256 for HMAC operations.
Use System.Security.Cryptography.SHA256 for hashing.
No external dependencies -- pure .NET crypto.
  </action>
  <verify>dotnet build Plugins/DataWarehouse.Plugins.UniversalFabric/DataWarehouse.Plugins.UniversalFabric.csproj 2>&1 | tail -5</verify>
  <done>S3SignatureV4 compiles and implements full AWS Sig V4 verification with constant-time comparison</done>
</task>

<task type="auto">
  <name>Task 2: Implement S3CredentialStore and S3BucketManager</name>
  <files>Plugins/DataWarehouse.Plugins.UniversalFabric/S3Server/S3CredentialStore.cs, Plugins/DataWarehouse.Plugins.UniversalFabric/S3Server/S3BucketManager.cs</files>
  <action>
1. S3CredentialStore.cs -- manages access key / secret key pairs:

```csharp
public class S3CredentialStore
{
    private readonly ConcurrentDictionary<string, S3Credentials> _credentials = new();
    private readonly string _storagePath; // persist to disk

    public S3CredentialStore(string storagePath)

    // Create new credentials (generates random 20-char access key, 40-char secret key)
    public S3Credentials CreateCredentials(string? userId = null, IReadOnlySet<string>? allowedBuckets = null, bool isAdmin = false)

    // Get credentials by access key ID
    public S3Credentials? GetCredentials(string accessKeyId)

    // Delete credentials
    public bool DeleteCredentials(string accessKeyId)

    // List all credentials (secrets redacted)
    public IReadOnlyList<S3Credentials> ListCredentials()

    // Save/load from JSON file
    private void PersistToDisk()
    private void LoadFromDisk()
}
```

Key generation: Use RandomNumberGenerator to generate cryptographically random bytes, encode as base62 (alphanumeric).

2. S3BucketManager.cs -- manages bucket metadata and backend mappings:

```csharp
public class S3BucketManager
{
    private readonly ConcurrentDictionary<string, S3BucketInfo> _buckets = new();
    private readonly IBackendRegistry _registry;
    private readonly string _storagePath;

    public S3BucketManager(IBackendRegistry registry, string storagePath)

    // Create bucket (optionally mapped to specific backend)
    public S3BucketInfo CreateBucket(string name, string? backendId = null, string? region = null)

    // Delete bucket (only if empty)
    public void DeleteBucket(string name)

    // Check existence
    public bool BucketExists(string name)

    // List all buckets
    public IReadOnlyList<S3BucketInfo> ListBuckets()

    // Get bucket info
    public S3BucketInfo? GetBucket(string name)

    // Get the backend ID for a bucket
    public string? GetBackendId(string bucketName)

    // Validate bucket name (S3 naming rules)
    public static bool IsValidBucketName(string name)

    // Persistence
    private void PersistToDisk()
    private void LoadFromDisk()
}

public record S3BucketInfo
{
    public required string Name { get; init; }
    public required DateTime CreationDate { get; init; }
    public string? BackendId { get; init; }
    public string? Region { get; init; }
    public bool VersioningEnabled { get; init; }
    public long ObjectCount { get; init; }
    public long TotalSizeBytes { get; init; }
}
```

Bucket naming validation per S3 spec: 3-63 chars, lowercase letters/numbers/hyphens, no leading/trailing hyphen, no periods adjacent to hyphens, must start with letter or number.
  </action>
  <verify>dotnet build Plugins/DataWarehouse.Plugins.UniversalFabric/DataWarehouse.Plugins.UniversalFabric.csproj 2>&1 | tail -5</verify>
  <done>S3CredentialStore generates/stores credentials securely; S3BucketManager manages bucket lifecycle with backend mapping</done>
</task>

</tasks>

<verification>
- `dotnet build Plugins/DataWarehouse.Plugins.UniversalFabric/` compiles
- Signature V4 uses constant-time comparison (CryptographicOperations.FixedTimeEquals)
- Credential generation uses RandomNumberGenerator (not System.Random)
</verification>

<success_criteria>
- AWS Signature V4 verification follows the exact AWS signing algorithm
- Credentials persist across server restarts
- Bucket names validated per S3 naming rules
</success_criteria>

<output>
After completion, create `.planning/phases/63-universal-fabric/63-07-SUMMARY.md`
</output>
