---
phase: 10-advanced-storage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Plugins/DataWarehouse.Plugins.AirGapBridge/AirGapBridgePlugin.cs
  - Metadata/TODO.md
autonomous: true

must_haves:
  truths:
    - "USB/removable devices are detected and classified by mode (Transport/StorageExtension/PocketInstance)"
    - "Transport mode creates and imports encrypted .dwpack packages"
    - "Storage Extension mode dynamically registers removable drives as capacity tiers"
    - "Pocket Instance mode runs isolated DataWarehouse instances on removable media"
    - "Security features (encryption, PIN, keyfile auth, TTL kill switch) protect air-gap data"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.AirGapBridge/AirGapBridgePlugin.cs"
      provides: "Tri-mode orchestrator with device detection and mode switching"
      min_lines: 600
    - path: "Plugins/DataWarehouse.Plugins.AirGapBridge/Detection/DeviceSentinel.cs"
      provides: "USB/removable device detection service"
      exists: true
    - path: "Plugins/DataWarehouse.Plugins.AirGapBridge/Transport/PackageManager.cs"
      provides: "Package creation and import for Transport mode"
      exists: true
    - path: "Plugins/DataWarehouse.Plugins.AirGapBridge/PocketInstance/PocketInstanceManager.cs"
      provides: "Isolated instance management for Pocket mode"
      exists: true
  key_links:
    - from: "AirGapBridgePlugin"
      to: "DeviceSentinel"
      via: "device detection events"
      pattern: "DeviceDetected.*EventHandler"
    - from: "AirGapBridgePlugin"
      to: "message bus"
      via: "package import/export operations"
      pattern: "PublishAsync.*airgap\\."
---

<objective>
Verify and complete tri-mode USB / air-gap bridge (T79) implementation.

Purpose: Enable secure offline data transfer via removable media with three operational modes - Transport (encrypted blob container), Storage Extension (capacity tier), and Pocket Instance (full portable DataWarehouse).
Output: Production-ready AirGapBridgePlugin with all 35 sub-tasks verified or implemented.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-advanced-storage/10-RESEARCH.md
@Plugins/DataWarehouse.Plugins.AirGapBridge/AirGapBridgePlugin.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify AirGapBridge tri-mode implementation</name>
  <files>
Plugins/DataWarehouse.Plugins.AirGapBridge/AirGapBridgePlugin.cs
Plugins/DataWarehouse.Plugins.AirGapBridge/Core/AirGapTypes.cs
Plugins/DataWarehouse.Plugins.AirGapBridge/Detection/DeviceSentinel.cs
Plugins/DataWarehouse.Plugins.AirGapBridge/Transport/PackageManager.cs
Plugins/DataWarehouse.Plugins.AirGapBridge/Storage/StorageExtensionProvider.cs
Plugins/DataWarehouse.Plugins.AirGapBridge/PocketInstance/PocketInstanceManager.cs
Plugins/DataWarehouse.Plugins.AirGapBridge/Security/SecurityManager.cs
Plugins/DataWarehouse.Plugins.AirGapBridge/Management/SetupWizard.cs
Plugins/DataWarehouse.Plugins.AirGapBridge/Convergence/ConvergenceManager.cs
  </files>
  <action>
**Verification approach:** Research indicates AirGapBridgePlugin exists with 683 lines implementing tri-mode support. Verify all 35 T79 sub-tasks (79.1-79.35) are implemented or stubbed.

**Step 1: Read plugin files**
- Read AirGapBridgePlugin.cs - verify main orchestrator implements IFeaturePlugin with tri-mode switching
- Read Core/AirGapTypes.cs - verify AirGapMode enum (Transport, StorageExtension, PocketInstance)
- Read all sub-component files (Detection, Transport, Storage, PocketInstance, Security, Management, Convergence)

**Step 2: Map sub-tasks to implementations**
For each T79 category, verify implementations exist:
- **Detection & Handshake (79.1-79.4):** DeviceSentinel service, config scanner, mode detection, signature verification
- **Transport Mode (79.5-79.10):** PackageManager with .dwpack creation, auto-ingest, shard unpacking, secure wipe
- **Storage Extension (79.11-79.15):** StorageExtensionProvider for dynamic tier registration, safe removal, offline index
- **Pocket Instance (79.16-79.20):** PocketInstanceManager for isolated instances, portable DB, cross-instance sync
- **Security (79.21-79.25):** SecurityManager with encryption, PIN/keyfile auth, TTL kill switch
- **Setup & Management (79.26-79.28):** SetupWizard for device formatting and instance ID generation
- **Convergence Support (79.29-79.35):** ConvergenceManager for multi-instance detection and metadata extraction

**Step 3: Identify gaps**
- Check for NotImplementedException, TODO, STUB patterns
- Identify missing sub-tasks from T79 list
- Verify message bus integration for encryption (topic: `encryption.*`), storage (topic: `storage.*`)

**Step 4: Build verification**
```bash
dotnet build Plugins/DataWarehouse.Plugins.AirGapBridge/DataWarehouse.Plugins.AirGapBridge.csproj --no-incremental
```
- Expect: 0 errors (warnings acceptable)
- If errors exist: List them for Task 2 implementation

**Step 5: Document findings**
Create gap analysis table:
| Sub-Task | Status | File | Notes |
|----------|--------|------|-------|
| 79.1 USB Sentinel | ✅/❌ | DeviceSentinel.cs | ... |
| ... | ... | ... | ... |
  </action>
  <verify>
- All 9 component files exist and compile without errors
- Gap analysis table created listing all 35 sub-tasks with status
- Build output shows 0 errors
  </verify>
  <done>
T79 implementation status is fully documented with clear list of completed vs missing sub-tasks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement missing T79 sub-tasks</name>
  <files>
Plugins/DataWarehouse.Plugins.AirGapBridge/[affected files from gap analysis]
Metadata/TODO.md
  </files>
  <action>
**Based on Task 1 gap analysis**, implement any missing sub-tasks. Research indicates most functionality exists - focus on wiring and integration.

**If all 35 sub-tasks are already implemented:**
- Verify message bus integration for cross-plugin communication
- Ensure no direct plugin references (SDK-only pattern)
- Mark all T79.1-79.35 sub-tasks as [x] in Metadata/TODO.md
- Skip to verification

**If gaps exist (implement only what's missing):**

**For each missing sub-task:**
1. Add implementation to appropriate component file
2. Follow existing patterns (e.g., DeviceSentinel for detection, PackageManager for transport)
3. Use message bus for cross-plugin communication:
   - Encryption: `await messageBus.PublishAsync(new PluginMessage("encryption.encrypt", payload))`
   - Storage: `await messageBus.PublishAsync(new PluginMessage("storage.write", payload))`
   - Key management: `await messageBus.PublishAsync(new PluginMessage("keys.get", payload))`
4. No simulations, mocks, or stubs - real implementations only
5. Add XML documentation to public methods

**Common implementation patterns:**
- **Device detection (79.1):** FileSystemWatcher for Windows, platform-specific detection for Linux/macOS
- **Package creation (79.5):** Serialize shards + manifest to .dwpack file with encryption
- **Auto-ingest (79.6):** Scan for .dwpack files on device mount, parse manifest, import if AutoIngest=true
- **Security (79.21-79.25):** Delegate to SecurityManager, use existing encryption strategies
- **Convergence (79.29-79.35):** Use ConvergenceManager for instance detection and metadata sync

**Update TODO.md:**
Mark implemented sub-tasks as [x] in Task 79 section. Update plugin status from [ ] Not Started to [x] Complete if all sub-tasks done.

**Build verification:**
```bash
dotnet build Plugins/DataWarehouse.Plugins.AirGapBridge/DataWarehouse.Plugins.AirGapBridge.csproj --no-incremental
```
- Must pass with 0 errors after implementation
  </action>
  <verify>
- Build passes with 0 errors
- All implemented sub-tasks marked [x] in Metadata/TODO.md
- No forbidden patterns (NotImplementedException, TODO, STUB, MOCK) in modified files
- Message bus integration verified (no direct plugin references)
  </verify>
  <done>
All T79 sub-tasks are either verified complete or newly implemented. AirGapBridgePlugin is production-ready with tri-mode support.
  </done>
</task>

</tasks>

<verification>
**Build verification:**
```bash
dotnet build Plugins/DataWarehouse.Plugins.AirGapBridge/DataWarehouse.Plugins.AirGapBridge.csproj --no-incremental
```
Expected: 0 errors (warnings acceptable)

**Forbidden pattern scan:**
```bash
grep -r "NotImplementedException\|TODO\|STUB\|MOCK\|SIMULATION" Plugins/DataWarehouse.Plugins.AirGapBridge/ --include="*.cs" | grep -v "obj/"
```
Expected: 0 matches

**TODO.md verification:**
```bash
grep "Task 79:" Metadata/TODO.md -A 50
```
Expected: All 35 sub-tasks marked [x], plugin status [x] Complete
</verification>

<success_criteria>
1. AirGapBridgePlugin compiles without errors
2. All 35 T79 sub-tasks verified implemented (no stubs, mocks, or placeholders)
3. Tri-mode switching (Transport/StorageExtension/PocketInstance) works via mode detection
4. Message bus integration verified for encryption, storage, and key management
5. Zero forbidden patterns in codebase
6. Metadata/TODO.md updated with accurate completion status
</success_criteria>

<output>
After completion, create `.planning/phases/10-advanced-storage/10-01-SUMMARY.md`
</output>
