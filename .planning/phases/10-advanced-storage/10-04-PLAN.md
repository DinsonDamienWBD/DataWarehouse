---
phase: 10-advanced-storage
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateDataManagement/Strategies/Branching/GitForDataBranchingStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateDataManagement/Strategies/Branching/BranchingStrategyBase.cs
  - Metadata/TODO.md
autonomous: true

must_haves:
  truths:
    - "Data branches support instant fork via pointer arithmetic (copy block references, not data)"
    - "Copy-on-write ensures zero-cost branching until modifications occur"
    - "Diff operations show changes between branches at block granularity"
    - "Merge operations combine branches with conflict resolution"
    - "Branch-level permissions control who can create, merge, or delete branches"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateDataManagement/Strategies/Branching/GitForDataBranchingStrategy.cs"
      provides: "Git-like branching for data objects with instant fork and CoW merge"
      min_lines: 200
    - path: "Plugins/DataWarehouse.Plugins.UltimateDataManagement/Strategies/Branching/BranchingStrategyBase.cs"
      provides: "Base class for branching strategies"
      exports: ["CreateBranchCoreAsync", "MergeBranchCoreAsync", "DiffBranchCoreAsync"]
  key_links:
    - from: "GitForDataBranchingStrategy"
      to: "message bus"
      via: "branch operations via data management topics"
      pattern: "PublishAsync.*data\\.branch"
    - from: "GitForDataBranchingStrategy"
      to: "block-level storage"
      via: "block reference tracking for CoW"
      pattern: "BlockReferences"
---

<objective>
Verify and complete data branching (T82) with Git-like operations for data objects.

Purpose: Enable instant branching, diffing, and merging of data objects using copy-on-write techniques, allowing experimental data transformations without duplicating storage.
Output: Production-ready GitForDataBranchingStrategy with all T82 sub-tasks verified or implemented.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-advanced-storage/10-RESEARCH.md
@Plugins/DataWarehouse.Plugins.UltimateDataManagement/Strategies/Branching/GitForDataBranchingStrategy.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify GitForDataBranchingStrategy implementation</name>
  <files>
Plugins/DataWarehouse.Plugins.UltimateDataManagement/Strategies/Branching/GitForDataBranchingStrategy.cs
Plugins/DataWarehouse.Plugins.UltimateDataManagement/Strategies/Branching/BranchingStrategyBase.cs
Plugins/DataWarehouse.Plugins.UltimateDataManagement/UltimateDataManagementPlugin.cs
  </files>
  <action>
**Verification approach:** Research indicates GitForDataBranchingStrategy.cs exists. Verify T82 Git-for-Data operations are implemented.

**Step 1: Read GitForDataBranchingStrategy.cs**
Verify file exists and check for all T82 sub-tasks:

**T82 Sub-Tasks (from TODO.md):**
- **82.1 Instant Fork:** Create branch via pointer arithmetic (copy block references, not data)
- **82.2 Copy-on-Write:** Track modified blocks per branch
- **82.3 Diff Engine:** Show changes between branches
- **82.4 Merge Engine:** Combine branches with conflict detection
- **82.5 Conflict Resolution:** UI for resolving merge conflicts
- **82.6 Branch Metadata:** Track branch name, parent, creation time, author
- **82.7 Branch-Level Permissions:** Access control per branch
- **82.8 Lightweight Tags:** Snapshots of branch state
- **82.9 Cherry-Pick:** Apply specific commits across branches
- **82.10 Rebase:** Reapply commits on new base

**Step 2: Verify key methods from research**
Check for instant fork implementation (lines 124-150 from research):
```csharp
protected override Task<BranchInfo> CreateBranchCoreAsync(
    string objectId, string branchName, string fromBranch,
    string? fromVersion, CreateBranchOptions options, CancellationToken ct)
{
    // 82.1: Instant fork via pointer arithmetic
    var newBranch = new DataBranch
    {
        BlockReferences = new List<string>(sourceBranch.BlockReferences)  // Shallow copy
    };
}
```

**Step 3: Verify CoW mechanism**
Check for copy-on-write tracking:
- Modified blocks tracked per branch
- Original blocks remain referenced by parent branch
- Write operations create new blocks instead of modifying shared blocks

**Step 4: Verify diff and merge operations**
Search for:
```csharp
protected override Task<BranchDiff> DiffBranchCoreAsync(...)  // 82.3
protected override Task<MergeResult> MergeBranchCoreAsync(...)  // 82.4
private ConflictResolution ResolveConflict(...)  // 82.5
```

**Step 5: Verify branch metadata**
Check for `DataBranch` class with:
- BranchId, Name, ObjectId
- ParentBranchId, BranchPoint
- Status (Active, Merged, Deleted)
- CreatedAt, CreatedBy
- BlockReferences (list of block IDs)

**Step 6: Verify branch permissions**
Check for branch-level access control integration:
```csharp
private bool CanCreateBranch(string userId, string objectId)
private bool CanMergeBranch(string userId, string branchId)
private bool CanDeleteBranch(string userId, string branchId)
```

**Step 7: Build verification**
```bash
dotnet build Plugins/DataWarehouse.Plugins.UltimateDataManagement/ --no-incremental
```
Expected: 0 errors

**Step 8: Document findings**
Create sub-task verification table:
| Sub-Task | Feature | Status | Notes |
|----------|---------|--------|-------|
| 82.1 Instant Fork | CreateBranchCoreAsync | ✅/❌ | ... |
| 82.2 Copy-on-Write | Block tracking | ✅/❌ | ... |
| ... | ... | ... | ... |
  </action>
  <verify>
- GitForDataBranchingStrategy.cs exists and compiles
- All T82 sub-tasks verified present in code
- Build passes with 0 errors
- Sub-task verification table completed
  </verify>
  <done>
T82 data branching implementation status is fully documented. All Git-like operations are verified production-ready or gaps are identified for Task 2.
  </done>
</task>

<task type="auto">
  <name>Task 2: Complete missing branching features and update TODO.md</name>
  <files>
Plugins/DataWarehouse.Plugins.UltimateDataManagement/Strategies/Branching/GitForDataBranchingStrategy.cs
Plugins/DataWarehouse.Plugins.UltimateDataManagement/UltimateDataManagementPlugin.cs
Metadata/TODO.md
  </files>
  <action>
**Based on Task 1 verification**, implement missing sub-tasks if any.

**If all 10 sub-tasks are verified complete:**
- Verify GitForDataBranchingStrategy is registered in UltimateDataManagementPlugin
- Mark all T82.1-82.10 sub-tasks as [x] in Metadata/TODO.md
- Update T82 status from [ ] Not Started to [x] Complete
- Skip to verification

**If gaps exist (implement only what's missing):**

**Instant Fork (82.1):**
```csharp
protected override Task<BranchInfo> CreateBranchCoreAsync(
    string objectId, string branchName, string fromBranch,
    string? fromVersion, CreateBranchOptions options, CancellationToken ct)
{
    var store = _stores.GetOrAdd(objectId, id => new ObjectStore(id));

    lock (store.Lock)
    {
        if (!store.Branches.TryGetValue(fromBranch, out var sourceBranch))
            throw new InvalidOperationException($"Source branch '{fromBranch}' does not exist.");

        // Instant fork - copy block references only, not data
        var newBranch = new DataBranch
        {
            BranchId = GenerateId(),
            Name = branchName,
            ObjectId = objectId,
            ParentBranchId = sourceBranch.BranchId,
            BranchPoint = fromVersion ?? $"commit-{sourceBranch.CommitCount}",
            Status = BranchStatus.Active,
            CreatedAt = DateTime.UtcNow,
            BlockReferences = new List<string>(sourceBranch.BlockReferences)  // Shallow copy
        };

        store.Branches[branchName] = newBranch;
        return Task.FromResult(MapToBranchInfo(newBranch));
    }
}
```

**Diff Engine (82.3):**
```csharp
protected override Task<BranchDiff> DiffBranchCoreAsync(
    string objectId, string branchA, string branchB, CancellationToken ct)
{
    var store = _stores[objectId];
    var branch1 = store.Branches[branchA];
    var branch2 = store.Branches[branchB];

    var addedBlocks = branch2.BlockReferences.Except(branch1.BlockReferences).ToList();
    var removedBlocks = branch1.BlockReferences.Except(branch2.BlockReferences).ToList();
    var modifiedBlocks = FindModifiedBlocks(branch1, branch2);

    return Task.FromResult(new BranchDiff
    {
        AddedBlocks = addedBlocks,
        RemovedBlocks = removedBlocks,
        ModifiedBlocks = modifiedBlocks,
        TotalChanges = addedBlocks.Count + removedBlocks.Count + modifiedBlocks.Count
    });
}
```

**Merge Engine (82.4):**
```csharp
protected override async Task<MergeResult> MergeBranchCoreAsync(
    string objectId, string sourceBranch, string targetBranch,
    MergeOptions options, CancellationToken ct)
{
    var diff = await DiffBranchCoreAsync(objectId, targetBranch, sourceBranch, ct);
    var conflicts = DetectConflicts(diff);

    if (conflicts.Any() && options.ConflictResolution == ConflictResolutionMode.Abort)
        return new MergeResult { Success = false, Conflicts = conflicts };

    // Apply changes
    var targetBlocks = new List<string>(target.BlockReferences);
    foreach (var added in diff.AddedBlocks)
        targetBlocks.Add(added);
    foreach (var removed in diff.RemovedBlocks)
        targetBlocks.Remove(removed);

    target.BlockReferences = targetBlocks;
    target.CommitCount++;

    return new MergeResult { Success = true, MergedBlocks = diff.TotalChanges };
}
```

**Branch-Level Permissions (82.7):**
```csharp
private async Task<bool> CanPerformBranchOperationAsync(
    string userId, string branchId, BranchOperation operation)
{
    var response = await _messageBus.PublishAsync(new PluginMessage
    {
        Type = "access.check",
        Payload = new Dictionary<string, object>
        {
            ["userId"] = userId,
            ["resourceType"] = "branch",
            ["resourceId"] = branchId,
            ["operation"] = operation.ToString()
        }
    });

    return response?.Payload.TryGetValue("allowed", out var allowed) == true &&
           (bool)allowed;
}
```

**Update TODO.md:**
Mark all implemented T82 sub-tasks as [x]. Update status to [x] Complete.

**Build verification:**
```bash
dotnet build Plugins/DataWarehouse.Plugins.UltimateDataManagement/ --no-incremental
```
Must pass with 0 errors.
  </action>
  <verify>
- Build passes with 0 errors
- All 10 T82 sub-tasks marked [x] in Metadata/TODO.md
- GitForDataBranchingStrategy registered in plugin orchestrator
- No forbidden patterns in modified files
- Branch operations integrated via message bus
  </verify>
  <done>
All T82 data branching sub-tasks are production-ready. Git-like branching with instant fork, CoW, diff, merge, and permissions works for data objects.
  </done>
</task>

</tasks>

<verification>
**Build verification:**
```bash
dotnet build Plugins/DataWarehouse.Plugins.UltimateDataManagement/ --no-incremental
```
Expected: 0 errors

**Forbidden pattern scan:**
```bash
grep -r "NotImplementedException\|TODO.*implement\|STUB\|MOCK" Plugins/DataWarehouse.Plugins.UltimateDataManagement/Strategies/Branching/ --include="*.cs" | grep -v obj/
```
Expected: 0 matches

**Sub-task coverage:**
```bash
grep "82\\.[0-9]" Plugins/DataWarehouse.Plugins.UltimateDataManagement/Strategies/Branching/GitForDataBranchingStrategy.cs | wc -l
```
Expected: ≥10 (all sub-tasks referenced)
</verification>

<success_criteria>
1. GitForDataBranchingStrategy compiles without errors
2. All 10 T82 sub-tasks verified implemented (instant fork, CoW, diff, merge, conflict resolution, metadata, permissions, tags, cherry-pick, rebase)
3. Branch creation is instant (pointer copy, not data copy)
4. Merge operations detect and resolve conflicts
5. Branch-level permissions enforced via access control plugin
6. Zero forbidden patterns in codebase
7. Metadata/TODO.md updated with T82 completion status
</success_criteria>

<output>
After completion, create `.planning/phases/10-advanced-storage/10-04-SUMMARY.md`
</output>
