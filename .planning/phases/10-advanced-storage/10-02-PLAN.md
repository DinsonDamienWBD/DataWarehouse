---
phase: 10-advanced-storage
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateDataProtection/UltimateDataProtectionPlugin.cs
  - Plugins/DataWarehouse.Plugins.UltimateDataProtection/Strategies/Snapshot/SnapshotStrategies.cs
  - Metadata/TODO.md
autonomous: true

must_haves:
  truths:
    - "Point-in-time snapshots capture data state at specific timestamps"
    - "Copy-on-write snapshots create instant snapshots with minimal storage overhead"
    - "Continuous data protection (CDP) journals every write operation for microsecond-level recovery"
    - "Legacy backup plugins are deprecated with migration notices pointing to UltimateDataProtection"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateDataProtection/UltimateDataProtectionPlugin.cs"
      provides: "Orchestrator with strategy registry and CDP support"
      min_lines: 200
    - path: "Plugins/DataWarehouse.Plugins.UltimateDataProtection/Strategies/Snapshot/SnapshotStrategies.cs"
      provides: "COW, ROW, VSS, LVM, ZFS, Cloud snapshot strategies"
      exists: true
    - path: "Plugins/DataWarehouse.Plugins.UltimateDataProtection/Strategies/CDP/ContinuousDataProtectionStrategy.cs"
      provides: "CDP journal-based continuous protection"
      pattern: "ContinuousDataProtectionStrategy.*IDataProtectionStrategy"
  key_links:
    - from: "UltimateDataProtectionPlugin"
      to: "DataProtectionStrategyRegistry"
      via: "strategy discovery and registration"
      pattern: "DiscoverAndRegisterStrategies"
    - from: "ContinuousDataProtectionStrategy"
      to: "message bus"
      via: "journal write operations"
      pattern: "PublishAsync.*protection\\."
---

<objective>
Verify and complete continuous data protection (T80) implementation with CDP and snapshot strategies.

Purpose: Provide point-in-time recovery capabilities via snapshot strategies (COW, ROW, VSS, LVM, ZFS, Cloud) and continuous data protection for microsecond-level time travel.
Output: Production-ready UltimateDataProtectionPlugin with verified CDP and snapshot infrastructure, deprecated legacy backup plugins with migration notices.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-advanced-storage/10-RESEARCH.md
@Plugins/DataWarehouse.Plugins.UltimateDataProtection/UltimateDataProtectionPlugin.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify UltimateDataProtection snapshot and CDP strategies</name>
  <files>
Plugins/DataWarehouse.Plugins.UltimateDataProtection/UltimateDataProtectionPlugin.cs
Plugins/DataWarehouse.Plugins.UltimateDataProtection/DataProtectionStrategyRegistry.cs
Plugins/DataWarehouse.Plugins.UltimateDataProtection/Strategies/Snapshot/SnapshotStrategies.cs
Plugins/DataWarehouse.Plugins.UltimateDataProtection/Strategies/CDP/ContinuousDataProtectionStrategy.cs
Plugins/DataWarehouse.Plugins.UltimateDataProtection/Strategies/CDP/JournalBasedCdpStrategy.cs
Plugins/DataWarehouse.Plugins.UltimateDataProtection/Strategies/CDP/ReplicationBasedCdpStrategy.cs
Plugins/DataWarehouse.Plugins.UltimateDataProtection/Strategies/CDP/SnapshotBasedCdpStrategy.cs
Plugins/DataWarehouse.Plugins.UltimateDataProtection/Strategies/CDP/HybridCdpStrategy.cs
  </files>
  <action>
**Verification approach:** Research indicates UltimateDataProtectionPlugin exists with Phase A-H complete. Verify T80 CDP and snapshot strategies are implemented.

**Step 1: Read orchestrator**
- Read UltimateDataProtectionPlugin.cs - verify it extends IntelligenceAwarePluginBase
- Check DiscoverAndRegisterStrategies() method for snapshot and CDP strategy discovery
- Verify message bus subscriptions for protection.* topics

**Step 2: Verify snapshot strategies (T80 Phase B - Snapshots)**
Read Strategies/Snapshot/SnapshotStrategies.cs and verify all 6 strategies exist:
1. **CopyOnWriteSnapshotStrategy** - COW snapshot (instant fork, copy-on-modify)
2. **RedirectOnWriteSnapshotStrategy** - ROW snapshot (instant fork, redirect writes)
3. **VssSnapshotStrategy** - Windows VSS integration
4. **LvmSnapshotStrategy** - Linux LVM thin provisioning
5. **ZfsSnapshotStrategy** - ZFS snapshot clones
6. **CloudSnapshotStrategy** - Cloud provider snapshots (S3 Glacier, Azure Immutable Blob)

Each strategy must:
- Extend `DataProtectionStrategyBase`
- Implement `CreateBackupCoreAsync`, `RestoreCoreAsync`
- Have `Category = DataProtectionCategory.Snapshot`
- Have production-ready implementations (no NotImplementedException)

**Step 3: Verify CDP strategies (T80 Phase C - Continuous Data Protection)**
Check for CDP strategy files and verify 4 CDP modes:
1. **JournalBasedCdpStrategy** (80.C2.1) - Write-ahead log capturing every operation
2. **ReplicationBasedCdpStrategy** (80.C2.2) - Real-time replication with lag monitoring
3. **SnapshotBasedCdpStrategy** (80.C2.3) - Frequent automated snapshots
4. **HybridCdpStrategy** (80.C2.4) - Combination of journal + snapshots

Verify CDP capabilities:
- Point-in-time recovery (80.D3) - reconstruct state at any microsecond
- CDP journal write operations integrated via message bus
- Versioning mode supports `VersioningMode.Continuous`

**Step 4: Check T80 Phase status in TODO.md**
```bash
grep "Task 80:" Metadata/TODO.md -A 200 | grep "Phase [A-H]"
```
Expected: Phases A-H marked [x] Complete

**Step 5: Build verification**
```bash
dotnet build Plugins/DataWarehouse.Plugins.UltimateDataProtection/DataWarehouse.Plugins.UltimateDataProtection.csproj --no-incremental
```
Expected: 0 errors

**Step 6: Document findings**
Create verification table:
| Strategy | File | Status | Notes |
|----------|------|--------|-------|
| COW Snapshot | SnapshotStrategies.cs | ✅/❌ | ... |
| CDP Journal | CdpStrategies.cs | ✅/❌ | ... |
  </action>
  <verify>
- All snapshot strategy files exist and compile
- All CDP strategy files exist and compile
- Build passes with 0 errors
- Verification table lists all strategies with status
  </verify>
  <done>
T80 CDP and snapshot implementation status is fully documented. All strategies are verified production-ready or gaps are identified for Task 2.
  </done>
</task>

<task type="auto">
  <name>Task 2: Complete missing strategies and update deprecation notices</name>
  <files>
Plugins/DataWarehouse.Plugins.UltimateDataProtection/Strategies/[affected files]
Plugins/DataWarehouse.Plugins.UltimateDataProtection/UltimateDataProtectionPlugin.cs
Metadata/TODO.md
  </files>
  <action>
**Based on Task 1 verification**, implement missing strategies or update documentation.

**If all strategies are verified complete:**
- Verify legacy plugin deprecation notices exist (T80.H - migration from BackupPlugin, DifferentialBackupPlugin, SyntheticFullBackupPlugin)
- Ensure UltimateDataProtectionPlugin.cs has XML documentation with migration guide
- Mark T80 phases as [x] in TODO.md if not already marked
- Skip to verification

**If gaps exist:**

**For missing snapshot strategies:**
Each snapshot strategy follows this pattern (from research):
```csharp
public sealed class CopyOnWriteSnapshotStrategy : DataProtectionStrategyBase
{
    public override string StrategyId => "cow-snapshot";
    public override string StrategyName => "Copy-on-Write Snapshot";
    public override DataProtectionCategory Category => DataProtectionCategory.Snapshot;
    public override DataProtectionCapabilities Capabilities =>
        DataProtectionCapabilities.PointInTimeRecovery |
        DataProtectionCapabilities.InstantRecovery;

    protected override Task<BackupResult> CreateBackupCoreAsync(
        BackupRequest request,
        Action<BackupProgress> progressCallback,
        CancellationToken ct)
    {
        // COW snapshot implementation:
        // 1. Create snapshot metadata
        // 2. Fork current state (pointer copy, not data copy)
        // 3. Track modified blocks via COW mechanism
        // 4. Return success with minimal storage overhead
        return Task.FromResult(new BackupResult
        {
            Success = true,
            BackupId = Guid.NewGuid().ToString("N"),
            TotalBytes = request.TotalSize,
            StoredBytes = request.TotalSize / 100  // Only store deltas
        });
    }
}
```

**For missing CDP strategies:**
CDP journal-based pattern:
```csharp
public sealed class JournalBasedCdpStrategy : DataProtectionStrategyBase
{
    public override DataProtectionCategory Category => DataProtectionCategory.ContinuousDataProtection;
    public override DataProtectionCapabilities Capabilities =>
        DataProtectionCapabilities.PointInTimeRecovery |
        DataProtectionCapabilities.ContinuousProtection |
        DataProtectionCapabilities.MicrosecondRecovery;

    protected override async Task<BackupResult> CreateBackupCoreAsync(...)
    {
        // Journal every write operation via message bus
        await _messageBus.PublishAsync(new PluginMessage
        {
            Type = "protection.journal.write",
            Payload = new Dictionary<string, object>
            {
                ["operation"] = "write",
                ["objectId"] = request.ObjectId,
                ["timestamp"] = DateTime.UtcNow.Ticks,
                ["data"] = request.Data
            }
        });
    }
}
```

**Add deprecation notices to legacy plugins (if not already present):**
Search for old backup plugins:
```bash
find Plugins/ -name "*Backup*Plugin.cs" | grep -v UltimateDataProtection
```

For each legacy plugin, add [Obsolete] attribute:
```csharp
[Obsolete("Migrated to UltimateDataProtection plugin. Use DataProtectionCategory.Full for full backups.")]
public sealed class BackupPlugin : IPlugin { }
```

**Update TODO.md:**
Mark all implemented T80 phases as [x]. Update plugin status to [x] Complete if all phases done.

**Build verification:**
```bash
dotnet build Plugins/DataWarehouse.Plugins.UltimateDataProtection/ --no-incremental
```
Must pass with 0 errors.
  </action>
  <verify>
- Build passes with 0 errors
- All snapshot and CDP strategies registered in DataProtectionStrategyRegistry
- Legacy backup plugins have [Obsolete] deprecation notices
- No forbidden patterns in modified files
- Metadata/TODO.md updated with completion status
  </verify>
  <done>
All T80 snapshot and CDP strategies are production-ready. Legacy backup plugins are deprecated with clear migration paths. Point-in-time recovery capabilities are verified working.
  </done>
</task>

</tasks>

<verification>
**Build verification:**
```bash
dotnet build Plugins/DataWarehouse.Plugins.UltimateDataProtection/ --no-incremental
```
Expected: 0 errors

**Forbidden pattern scan:**
```bash
grep -r "NotImplementedException\|TODO.*implement\|STUB\|MOCK" Plugins/DataWarehouse.Plugins.UltimateDataProtection/Strategies/ --include="*.cs" | grep -v obj/
```
Expected: 0 matches

**Strategy count verification:**
```bash
grep -r "class.*Snapshot.*Strategy.*:" Plugins/DataWarehouse.Plugins.UltimateDataProtection/Strategies/Snapshot/ --include="*.cs" | wc -l
```
Expected: ≥6 (COW, ROW, VSS, LVM, ZFS, Cloud)

```bash
grep -r "class.*Cdp.*Strategy.*:" Plugins/DataWarehouse.Plugins.UltimateDataProtection/Strategies/CDP/ --include="*.cs" | wc -l
```
Expected: ≥4 (Journal, Replication, Snapshot, Hybrid)
</verification>

<success_criteria>
1. UltimateDataProtectionPlugin compiles without errors
2. All 6 snapshot strategies (COW, ROW, VSS, LVM, ZFS, Cloud) verified production-ready
3. All 4 CDP strategies (Journal, Replication, Snapshot, Hybrid) verified production-ready
4. Point-in-time recovery works at microsecond granularity via CDP journal
5. Legacy backup plugins deprecated with [Obsolete] attributes and migration notices
6. Zero forbidden patterns in codebase
7. Metadata/TODO.md reflects accurate T80 completion status
</success_criteria>

<output>
After completion, create `.planning/phases/10-advanced-storage/10-02-SUMMARY.md`
</output>
