---
phase: 69-policy-persistence
plan: 05
type: execute
wave: 3
depends_on: ["69-01"]
files_modified:
  - DataWarehouse.SDK/Infrastructure/Policy/PolicyMarketplace.cs
  - DataWarehouse.SDK/Infrastructure/Policy/PolicyTemplate.cs
autonomous: true

must_haves:
  truths:
    - "Policy templates can be exported from an IPolicyPersistence instance as a portable JSON package"
    - "Policy templates can be imported into any IPolicyPersistence instance with version compatibility checking"
    - "Templates carry metadata (author, version, description, target compliance frameworks) for community sharing"
  artifacts:
    - path: "DataWarehouse.SDK/Infrastructure/Policy/PolicyTemplate.cs"
      provides: "Policy template model with versioning and metadata"
      contains: "record PolicyTemplate"
    - path: "DataWarehouse.SDK/Infrastructure/Policy/PolicyMarketplace.cs"
      provides: "Import/export operations for policy templates"
      contains: "class PolicyMarketplace"
  key_links:
    - from: "PolicyMarketplace"
      to: "IPolicyPersistence"
      via: "reads/writes policies for export/import"
      pattern: "IPolicyPersistence.*persistence|LoadAllAsync|SaveAsync"
    - from: "PolicyMarketplace"
      to: "PolicySerializationHelper"
      via: "serializes templates"
      pattern: "PolicySerializationHelper"
---

<objective>
Implement the policy marketplace: import/export of policy templates and community-shared profiles with template versioning and compatibility validation.

Purpose: Enables users to share policy configurations across deployments. A compliance officer can export a "HIPAA-compliant" policy template and import it into any DataWarehouse instance.
Output: PolicyTemplate model and PolicyMarketplace import/export service.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@DataWarehouse.SDK/Contracts/Policy/IPolicyPersistence.cs
@DataWarehouse.SDK/Contracts/Policy/PolicyTypes.cs
@DataWarehouse.SDK/Contracts/Policy/PolicyEnums.cs
@.planning/phases/69-policy-persistence/69-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: PolicyTemplate model with versioning</name>
  <files>DataWarehouse.SDK/Infrastructure/Policy/PolicyTemplate.cs</files>
  <action>
Create policy template types in `PolicyTemplate.cs`:
- Namespace: `DataWarehouse.SDK.Infrastructure.Policy`
- `[SdkCompatibility("6.0.0", Notes = "Phase 69: Policy marketplace (PADV-01)")]`

**PolicyTemplate** -- sealed record representing a shareable policy package:
```csharp
public sealed record PolicyTemplate
{
    public required string Id { get; init; }                    // GUID
    public required string Name { get; init; }                  // e.g., "HIPAA-Compliant-Standard"
    public required string Description { get; init; }           // Human-readable
    public required string Author { get; init; }                // Creator identity
    public required Version TemplateVersion { get; init; }      // Semantic version of this template
    public required Version MinEngineVersion { get; init; }     // Minimum PolicyEngine version required (e.g., 6.0.0)
    public DateTimeOffset CreatedAt { get; init; }
    public DateTimeOffset? UpdatedAt { get; init; }
    public string[] Tags { get; init; } = Array.Empty<string>();                // e.g., ["hipaa", "healthcare", "strict"]
    public string[] TargetComplianceFrameworks { get; init; } = Array.Empty<string>(); // e.g., ["HIPAA", "SOC2"]
    public required IReadOnlyList<FeaturePolicy> Policies { get; init; }        // The actual policies
    public OperationalProfile? Profile { get; init; }                           // Optional profile preset
    public string? Checksum { get; init; }                                      // SHA256 of serialized policies for integrity
}
```

**PolicyTemplateCompatibility** -- result of compatibility check:
```csharp
public sealed record PolicyTemplateCompatibility
{
    public bool IsCompatible { get; init; }
    public string? IncompatibilityReason { get; init; }
    public Version? RequiredVersion { get; init; }
    public Version? CurrentVersion { get; init; }
}
```

**PolicyTemplateImportResult** -- result of import operation:
```csharp
public sealed record PolicyTemplateImportResult
{
    public bool Success { get; init; }
    public int PoliciesImported { get; init; }
    public bool ProfileImported { get; init; }
    public IReadOnlyList<string> Warnings { get; init; } = Array.Empty<string>();
    public string? Error { get; init; }
}
```

Full XML documentation on every type and property.
  </action>
  <verify>
`dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` -- 0 errors, 0 warnings.
  </verify>
  <done>PolicyTemplate, PolicyTemplateCompatibility, and PolicyTemplateImportResult records compile cleanly with full metadata support.</done>
</task>

<task type="auto">
  <name>Task 2: PolicyMarketplace import/export service</name>
  <files>DataWarehouse.SDK/Infrastructure/Policy/PolicyMarketplace.cs</files>
  <action>
Create `PolicyMarketplace`:
- Namespace: `DataWarehouse.SDK.Infrastructure.Policy`
- `[SdkCompatibility("6.0.0", Notes = "Phase 69: Policy marketplace (PADV-01)")]`
- `public sealed class PolicyMarketplace`

Constructor: `public PolicyMarketplace(Version currentEngineVersion)` -- the running engine version for compatibility checks. Default to `new Version(6, 0, 0)`.

**Export operations:**

`public async Task<PolicyTemplate> ExportTemplateAsync(IPolicyPersistence persistence, string name, string description, string author, Version templateVersion, string[]? tags = null, string[]? targetFrameworks = null, CancellationToken ct = default)`
- Calls `persistence.LoadAllAsync(ct)` to get all policies
- Calls `persistence.LoadProfileAsync(ct)` to get active profile
- Extracts `FeaturePolicy` objects from the loaded tuples
- Computes checksum: `SHA256(PolicySerializationHelper.SerializePolicies(policies))` as hex string
- Returns new `PolicyTemplate` with all metadata filled in, `CreatedAt = DateTimeOffset.UtcNow`

`public byte[] SerializeTemplate(PolicyTemplate template)` -- Serializes to JSON bytes using System.Text.Json with `JsonStringEnumConverter`, `WriteIndented = true` for human readability.

`public PolicyTemplate DeserializeTemplate(byte[] data)` -- Deserializes from JSON bytes. Validates checksum if present: recomputes from policies and compares. Throws `InvalidOperationException` if checksum mismatch ("Template integrity check failed: checksum mismatch").

**Compatibility checking:**

`public PolicyTemplateCompatibility CheckCompatibility(PolicyTemplate template)`
- Checks `template.MinEngineVersion <= _currentEngineVersion`. If not, returns incompatible with reason.
- Checks policies are not empty. If empty, returns incompatible with "Template contains no policies".
- Returns compatible if all checks pass.

**Import operations:**

`public async Task<PolicyTemplateImportResult> ImportTemplateAsync(IPolicyPersistence persistence, PolicyTemplate template, bool overwriteExisting = false, CancellationToken ct = default)`
- First runs `CheckCompatibility` -- if incompatible, return failure result with reason.
- For each policy in `template.Policies`: call `persistence.SaveAsync(policy.FeatureId, policy.Level, "/", policy, ct)`. If `!overwriteExisting`, first check via LoadAll if a policy with same featureId+level exists -- skip with warning.
- If `template.Profile != null`: call `persistence.SaveProfileAsync(template.Profile, ct)`.
- Collect warnings for skipped policies.
- Return result with counts and warnings.

`public async Task<PolicyTemplateImportResult> ImportFromBytesAsync(IPolicyPersistence persistence, byte[] templateData, bool overwriteExisting = false, CancellationToken ct = default)`
- Deserialize, check compatibility, import. Convenience method combining all steps.

**Built-in templates (static factory methods):**

`public static PolicyTemplate HipaaTemplate()` -- returns a template with:
- Strict encryption (IntensityLevel=90, Cascade=Enforce, AI=ManualOnly)
- MostRestrictive compression, AI=Suggest
- High replication (IntensityLevel=80, Cascade=MostRestrictive)
- TargetComplianceFrameworks = ["HIPAA"]
- Profile = OperationalProfile.Strict()

`public static PolicyTemplate GdprTemplate()` -- returns a template with:
- Strong encryption (IntensityLevel=80, Cascade=Enforce)
- Standard compression
- Moderate replication
- TargetComplianceFrameworks = ["GDPR"]

`public static PolicyTemplate HighPerformanceTemplate()` -- returns a template with:
- Light encryption (IntensityLevel=30)
- Light compression (IntensityLevel=30)
- Minimal replication
- Profile = OperationalProfile.Speed()

Full XML documentation with usage examples in remarks.
  </action>
  <verify>
`dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` -- 0 errors, 0 warnings.
  </verify>
  <done>PolicyMarketplace exports policies from any IPolicyPersistence to a portable template, imports templates with compatibility validation, and provides built-in HIPAA/GDPR/HighPerformance templates.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` passes with 0 errors
- PolicyMarketplace.ExportTemplateAsync reads from IPolicyPersistence and produces PolicyTemplate
- PolicyMarketplace.ImportTemplateAsync writes to IPolicyPersistence with compatibility check
- SerializeTemplate/DeserializeTemplate round-trip with checksum verification
- Built-in HipaaTemplate/GdprTemplate/HighPerformanceTemplate return valid templates
</verification>

<success_criteria>
- Templates are portable JSON packages with metadata, versioning, and integrity checksums
- Import validates compatibility before writing
- Export reads all policies from any persistence backend
- Built-in templates provide starting points for common compliance scenarios
- Success criterion 8 from phase definition is met
</success_criteria>

<output>
After completion, create `.planning/phases/69-policy-persistence/69-05-SUMMARY.md`
</output>
