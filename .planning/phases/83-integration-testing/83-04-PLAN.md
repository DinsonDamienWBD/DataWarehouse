---
phase: 83-integration-testing
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.Tests/Performance/PolicyPerformanceBenchmarks.cs
autonomous: true

must_haves:
  truths:
    - "FastPathPolicyEngine resolves Critical features within 1ms per resolution"
    - "BloomFilterSkipIndex queries complete within microseconds"
    - "MaterializedPolicyCache hit latency is sub-millisecond"
    - "PolicyResolutionEngine handles 1000 concurrent resolutions without deadlock or corruption"
    - "Three-tier timing claims verified: Tier 1 < Tier 2 < Tier 3 in resolution latency"
    - "VersionedPolicyCache double-buffer swap does not block readers"
  artifacts:
    - path: "DataWarehouse.Tests/Performance/PolicyPerformanceBenchmarks.cs"
      provides: "30+ performance benchmarks for policy engine, bloom filter, cache, concurrency, and three-tier timing"
      min_lines: 400
  key_links:
    - from: "DataWarehouse.Tests/Performance/PolicyPerformanceBenchmarks.cs"
      to: "DataWarehouse.SDK/Infrastructure/Policy/Performance/FastPathPolicyEngine.cs"
      via: "Stopwatch-measured resolution timing"
      pattern: "Stopwatch.*FastPathPolicyEngine"
    - from: "DataWarehouse.Tests/Performance/PolicyPerformanceBenchmarks.cs"
      to: "DataWarehouse.SDK/Infrastructure/Policy/Performance/BloomFilterSkipIndex.cs"
      via: "bloom filter query timing"
      pattern: "BloomFilterSkipIndex"
---

<objective>
Performance benchmark suite (~30 tests)

Purpose: Confirm three-tier fast-path timing claims and verify that PolicyEngine performance meets production requirements under load. This is INTG-05 coverage.

Output: One test file with 30+ performance benchmarks covering resolution timing, bloom filter, cache, concurrency, and three-tier verification.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@DataWarehouse.Tests/Performance/PerformanceBaselineTests.cs
@DataWarehouse.SDK/Infrastructure/Policy/Performance/FastPathPolicyEngine.cs
@DataWarehouse.SDK/Infrastructure/Policy/Performance/BloomFilterSkipIndex.cs
@DataWarehouse.SDK/Infrastructure/Policy/Performance/MaterializedPolicyCache.cs
@DataWarehouse.SDK/Infrastructure/Policy/Performance/PolicyDelegateCache.cs
@DataWarehouse.SDK/Infrastructure/Policy/Performance/PolicyMaterializationEngine.cs
@DataWarehouse.SDK/Infrastructure/Policy/Performance/CompiledPolicyDelegate.cs
@DataWarehouse.SDK/Infrastructure/Policy/Performance/PolicySimulationSandbox.cs
@DataWarehouse.SDK/Infrastructure/Policy/Performance/PolicySimulator.cs
@DataWarehouse.SDK/Infrastructure/Policy/VersionedPolicyCache.cs
@DataWarehouse.SDK/Infrastructure/Policy/PolicyResolutionEngine.cs
@DataWarehouse.SDK/Infrastructure/Policy/InMemoryPolicyStore.cs
@DataWarehouse.SDK/VirtualDiskEngine/Verification/TierPerformanceBenchmark.cs
@DataWarehouse.SDK/VirtualDiskEngine/Verification/ThreeTierVerificationSuite.cs
@DataWarehouse.SDK/VirtualDiskEngine/Verification/TierFeatureMap.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Performance benchmarks for policy engine and three-tier verification</name>
  <files>
    DataWarehouse.Tests/Performance/PolicyPerformanceBenchmarks.cs
  </files>
  <action>
Create PolicyPerformanceBenchmarks.cs (~35 tests) following existing PerformanceBaselineTests.cs pattern: use Stopwatch timing with generous thresholds (5-10x expected) to avoid CI flakiness. Use [Trait("Category", "Performance")].

1. **PolicyResolutionEngine timing** (~8 tests):
   - Single ResolveAsync call completes within 10ms (generous)
   - ResolveAllAsync for 10 features completes within 100ms
   - 100 sequential ResolveAsync calls complete within 500ms
   - Resolution with 5-level chain (VDE->Container->Object->Chunk->Block) completes within 20ms
   - Resolution with Override cascade completes within 10ms
   - Resolution with MostRestrictive (scans all levels) completes within 15ms
   - SimulateAsync completes within 10ms
   - SetActiveProfileAsync + subsequent resolve within 20ms

2. **FastPathPolicyEngine timing** (~5 tests):
   - Critical feature resolution via fast path within 5ms
   - PerOperation feature with bloom filter skip within 2ms
   - Background feature from materialized cache within 1ms
   - 1000 fast-path resolutions within 2000ms (< 2ms average)
   - Fast path vs full path: fast path at least 2x faster (measure both)

3. **BloomFilterSkipIndex timing** (~5 tests):
   - Single query completes within 100 microseconds (0.1ms)
   - 10000 queries complete within 100ms
   - Add 1000 entries, query performance remains sub-millisecond
   - False positive rate below 5% for 1000 entries with 8192-bit filter
   - XxHash64 double-hashing deterministic (same input = same result)

4. **MaterializedPolicyCache timing** (~4 tests):
   - Cache hit returns within 0.5ms
   - Cache miss + populate within 10ms
   - 1000 cache hits within 100ms
   - Double-buffered swap does not block concurrent reads (verify no deadlock with parallel tasks)

5. **Concurrency benchmarks** (~5 tests):
   - 100 parallel ResolveAsync calls complete within 2000ms with no deadlock
   - 50 parallel SetAsync + 50 parallel ResolveAsync: no corruption, all complete within 3000ms
   - VersionedPolicyCache Interlocked.Exchange swap during parallel reads: no exception, consistent results
   - ConcurrentDictionary-backed store: 100 parallel writes + reads complete within 1000ms
   - InMemoryPolicyStore concurrent access: no ConcurrentModificationException

6. **Three-tier timing verification** (~5 tests):
   - Tier 1 (full module verification) timing measurement (just measure, generous threshold)
   - Tier 2 (pipeline verification) timing measurement
   - Tier 3 (basic fallback) timing measurement
   - Verify relative ordering: Tier 3 < Tier 2 < Tier 1 in elapsed time
   - TierPerformanceBenchmark 100+1000 iteration Stopwatch measurements complete within 30s

7. **CompiledPolicyDelegate timing** (~3 tests):
   - Closure-captured delegate invocation within microseconds
   - Compiled delegate matches full resolution result
   - _compiledForVersion (Interlocked.Read) safe under contention

All thresholds set generously (5-10x expected) per project convention. Use Stopwatch.StartNew() pattern from existing PerformanceBaselineTests.cs. Do NOT use BenchmarkDotNet (not in project dependencies). Use Task.WhenAll for parallel benchmarks.
  </action>
  <verify>
    Run `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter "FullyQualifiedName~PolicyPerformanceBenchmark" --no-build` after building. All tests pass. Count: 30+.
  </verify>
  <done>
    PolicyPerformanceBenchmarks.cs has 35+ performance tests covering policy resolution timing, fast-path engine, bloom filter, materialized cache, concurrency, three-tier verification timing, and compiled delegates. All thresholds generous. All tests pass. Zero deadlocks under concurrent load.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build DataWarehouse.Tests/DataWarehouse.Tests.csproj` completes with 0 errors
2. `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter "FullyQualifiedName~PolicyPerformanceBenchmark" --no-build` â€” all pass
3. Performance test count: 30+
4. No test takes longer than 30 seconds individually
</verification>

<success_criteria>
- 30+ performance benchmarks covering all three tiers, fast-path, bloom filter, cache, and concurrency
- All benchmarks pass with generous thresholds (no CI flakiness)
- Three-tier relative ordering verified: Tier 3 faster than Tier 2 faster than Tier 1
- Concurrent resolution (100 parallel) completes without deadlock
- Zero test failures
</success_criteria>

<output>
After completion, create `.planning/phases/83-integration-testing/83-04-SUMMARY.md`
</output>
