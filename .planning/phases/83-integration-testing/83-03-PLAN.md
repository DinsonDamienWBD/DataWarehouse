---
phase: 83-integration-testing
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.Tests/Policy/CrossFeatureInteractionTests.cs
  - DataWarehouse.Tests/Policy/AiBehaviorTests.cs
autonomous: true

must_haves:
  truths:
    - "Policies for different features interact correctly when resolved in the same context"
    - "Operational profile presets produce coherent cross-feature policy sets"
    - "AI autonomy level enforcement prevents AutoSilent in Paranoid profile"
    - "AiSelfModificationGuard blocks ai:/system:ai prefixed requesters"
    - "OverheadThrottle respects CPU hysteresis bounds"
    - "HybridAutonomyProfile presets (Paranoid/Balanced/Performance) produce correct per-category configurations"
    - "AiPolicyIntelligenceFactory wires all components correctly"
  artifacts:
    - path: "DataWarehouse.Tests/Policy/CrossFeatureInteractionTests.cs"
      provides: "50+ cross-feature interaction tests"
      min_lines: 400
    - path: "DataWarehouse.Tests/Policy/AiBehaviorTests.cs"
      provides: "100+ AI behavior tests covering autonomy, self-modification, overhead, threat detection"
      min_lines: 600
  key_links:
    - from: "DataWarehouse.Tests/Policy/AiBehaviorTests.cs"
      to: "DataWarehouse.SDK/Infrastructure/Intelligence/AiSelfModificationGuard.cs"
      via: "direct instantiation"
      pattern: "AiSelfModificationGuard"
    - from: "DataWarehouse.Tests/Policy/AiBehaviorTests.cs"
      to: "DataWarehouse.SDK/Infrastructure/Intelligence/OverheadThrottle.cs"
      via: "throttle behavior verification"
      pattern: "OverheadThrottle"
    - from: "DataWarehouse.Tests/Policy/CrossFeatureInteractionTests.cs"
      to: "DataWarehouse.SDK/Infrastructure/Policy/PolicyResolutionEngine.cs"
      via: "ResolveAllAsync multi-feature"
      pattern: "ResolveAllAsync"
---

<objective>
Cross-feature interaction tests (~50) + AI behavior tests (~100)

Purpose: Verify that policies for different features interact correctly (INTG-03) and that all AI behavior enforcement works correctly including autonomy levels, self-modification prevention, overhead throttling, and recommendation generation (INTG-04).

Output: Two test files covering cross-feature interactions and comprehensive AI behavior verification.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@DataWarehouse.Tests/Policy/CascadeResolutionTests.cs
@DataWarehouse.SDK/Contracts/Policy/IPolicyEngine.cs
@DataWarehouse.SDK/Contracts/Policy/PolicyEnums.cs
@DataWarehouse.SDK/Infrastructure/Policy/PolicyResolutionEngine.cs
@DataWarehouse.SDK/Infrastructure/Policy/InMemoryPolicyStore.cs
@DataWarehouse.SDK/Infrastructure/Policy/InMemoryPolicyPersistence.cs
@DataWarehouse.SDK/Infrastructure/Intelligence/AiSelfModificationGuard.cs
@DataWarehouse.SDK/Infrastructure/Intelligence/AiAutonomyConfiguration.cs
@DataWarehouse.SDK/Infrastructure/Intelligence/AiAutonomyDefaults.cs
@DataWarehouse.SDK/Infrastructure/Intelligence/AiObservationRingBuffer.cs
@DataWarehouse.SDK/Infrastructure/Intelligence/AiPolicyIntelligenceFactory.cs
@DataWarehouse.SDK/Infrastructure/Intelligence/OverheadThrottle.cs
@DataWarehouse.SDK/Infrastructure/Intelligence/HybridAutonomyProfile.cs
@DataWarehouse.SDK/Infrastructure/Intelligence/ThreatDetector.cs
@DataWarehouse.SDK/Infrastructure/Intelligence/CostAnalyzer.cs
@DataWarehouse.SDK/Infrastructure/Intelligence/DataSensitivityAnalyzer.cs
@DataWarehouse.SDK/Infrastructure/Intelligence/WorkloadAnalyzer.cs
@DataWarehouse.SDK/Infrastructure/Intelligence/HardwareProbe.cs
@DataWarehouse.SDK/Infrastructure/Intelligence/PolicyAdvisor.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Cross-feature interaction tests</name>
  <files>
    DataWarehouse.Tests/Policy/CrossFeatureInteractionTests.cs
  </files>
  <action>
Create CrossFeatureInteractionTests.cs (~55 tests) verifying correct multi-feature behavior:

1. **Profile coherence** (~15 tests):
   - Speed profile: encryption intensity LOW, compression intensity HIGH, ai_autonomy AutoSilent — verify coherent set
   - Paranoid profile: encryption HIGH, ai_autonomy ManualOnly, compliance HIGH — verify all features align
   - Each of 6 presets: ResolveAllAsync returns coherent feature set (no contradictions)
   - Custom profile with mixed settings resolves each feature independently

2. **Cross-feature cascade independence** (~10 tests):
   - Override encryption at Block level does NOT affect compression at same Block level
   - Enforce on access_control at VDE does NOT enforce unrelated ai_autonomy
   - MostRestrictive on encryption picks tightest encryption without affecting storage features
   - Setting Merge on one feature doesn't contaminate another feature's resolution

3. **Multi-feature override scenarios** (~15 tests):
   - Override 3 features at Container level, resolve at Object — all 3 overridden correctly
   - Different cascade strategies on different features in same ResolveAllAsync call
   - Remove override for one feature, verify other overrides unaffected
   - Bulk set: 10 features overridden at various levels, ResolveAllAsync returns correct effective policy for each

4. **Security-AI interaction** (~10 tests):
   - High security policy (Paranoid) forces AI to ManualOnly even if AI feature set to AutoSilent
   - Enforce on access_control + Inherit on ai_autonomy: security enforced, AI inherits
   - Threat level elevation (simulated) should affect AI autonomy resolution
   - Compliance features and AI features resolved independently but profile creates coherent set

5. **Edge cases** (~5 tests):
   - Empty store: ResolveAllAsync returns all profile defaults
   - Single feature overridden: all others return profile defaults
   - Profile switch: all feature resolutions update atomically
   - Concurrent ResolveAllAsync calls return consistent snapshots
  </action>
  <verify>
    Run `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter "FullyQualifiedName~CrossFeatureInteraction" --no-build` after building. All tests pass. Count: 50+.
  </verify>
  <done>
    CrossFeatureInteractionTests.cs has 55+ tests verifying cross-feature policy interaction, profile coherence, cascade independence, multi-feature overrides, security-AI interaction, and edge cases. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: AI behavior tests</name>
  <files>
    DataWarehouse.Tests/Policy/AiBehaviorTests.cs
  </files>
  <action>
Create AiBehaviorTests.cs (~100 tests) covering all AI behavior requirements:

1. **AiAutonomyLevel enforcement** (~20 tests):
   - Each of 5 AiAutonomyLevel values (ManualOnly through AutoSilent) correctly restricts/allows actions
   - ManualOnly: no AI actions permitted
   - Suggest: AI produces suggestions but cannot execute
   - SuggestExplain: suggestions include reasoning
   - AutoNotify: AI executes + notification generated
   - AutoSilent: AI executes silently
   - Level enforcement at each PolicyLevel (VDE through Block)
   - Higher-level Enforce on ManualOnly prevents child AutoSilent

2. **AiSelfModificationGuard** (~20 tests):
   - Requests with "ai:" prefix rejected when AllowSelfModification=false
   - Requests with "system:ai" prefix rejected when AllowSelfModification=false
   - Requests with "user:" prefix allowed
   - Requests with "admin:" prefix allowed
   - AllowSelfModification=true permits ai: prefixed requests
   - ModificationRequiresQuorum=true + no quorum service → fails gracefully
   - MinimumQuorumSize respected (3 default)
   - Read operations (GetAutonomy) always allowed without guard intervention
   - Case sensitivity of prefix matching (ai: vs AI:)
   - Empty/null requester ID handled gracefully

3. **AiObservationRingBuffer** (~12 tests):
   - Power-of-two size (8192 default)
   - CAS (Interlocked.CompareExchange) ring buffer behavior
   - Buffer wraps around correctly at capacity
   - Concurrent writes from multiple threads don't corrupt
   - Read during write returns consistent data
   - AttachRingBuffer wiring

4. **OverheadThrottle** (~12 tests):
   - CPU hysteresis at 80% lower bound triggers throttle
   - Below 80%: no throttle applied
   - Process.TotalProcessorTime delta calculation (mock via elapsed time)
   - Throttle reduces AI operation frequency
   - Throttle release when CPU drops below threshold

5. **HybridAutonomyProfile** (~12 tests):
   - Paranoid preset: all categories ManualOnly or Suggest
   - Balanced preset: mixed autonomy levels per category
   - Performance preset: high autonomy, low overhead checks
   - Per-category preset overrides work correctly
   - Custom profile creation with per-feature autonomy

6. **ThreatDetector** (~10 tests):
   - 4-signal sliding window (anomaly/auth_fail/access/exfil)
   - Signal weights: auth_fail=0.30, exfil=0.40, anomaly=0.25, access=0.20
   - Composite score exceeds threshold → threat detected
   - Window slides: old signals expire
   - No signals → score 0

7. **CostAnalyzer** (~6 tests):
   - Parses algorithm_*/encryption_*/compression_* metrics
   - enc_/cmp_ prefix parsing
   - Missing metrics → graceful default

8. **DataSensitivityAnalyzer** (~5 tests):
   - Auto-elevates to Confidential when PII detected
   - Non-PII data stays at default sensitivity
   - Multiple PII fields increase confidence

9. **AiPolicyIntelligenceFactory** (~5 tests):
   - Wires all 10+ components (AIPI-01 through AIPI-11)
   - Factory produces functional AiPolicyIntelligence instance
   - All sub-components accessible via factory output
  </action>
  <verify>
    Run `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter "FullyQualifiedName~AiBehavior" --no-build` after building. All tests pass. Count: 100+.
  </verify>
  <done>
    AiBehaviorTests.cs has 100+ tests covering autonomy level enforcement, self-modification guard, ring buffer, overhead throttle, hybrid profiles, threat detection, cost analysis, data sensitivity, and factory wiring. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build DataWarehouse.Tests/DataWarehouse.Tests.csproj` completes with 0 errors
2. `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter "FullyQualifiedName~CrossFeatureInteraction|FullyQualifiedName~AiBehavior" --no-build` — all pass
3. Cross-feature interaction count: 50+
4. AI behavior test count: 100+
</verification>

<success_criteria>
- 50+ cross-feature interaction tests verifying policy independence and profile coherence
- 100+ AI behavior tests verifying autonomy enforcement, self-modification prevention, overhead throttling, and threat detection
- AiSelfModificationGuard blocks ai:/system:ai prefix requests
- OverheadThrottle respects 80% CPU hysteresis
- All ThreatDetector signal weights verified
- Zero test failures
</success_criteria>

<output>
After completion, create `.planning/phases/83-integration-testing/83-03-SUMMARY.md`
</output>
