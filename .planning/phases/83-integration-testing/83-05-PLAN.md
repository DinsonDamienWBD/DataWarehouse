---
phase: 83-integration-testing
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.Tests/VdeFormat/VdeFormatModuleTests.cs
  - DataWarehouse.Tests/VdeFormat/TamperDetectionTests.cs
  - DataWarehouse.Tests/VdeFormat/MigrationTests.cs
autonomous: true

must_haves:
  truths:
    - "All 19 VDE modules serialize, deserialize, and verify correctly"
    - "All 7 VDE creation profiles (Minimal through Custom) produce valid superblock, manifest, and region directory"
    - "All 5 TamperResponse levels (Log/Alert/ReadOnly/Quarantine/Reject) triggered and produce correct TamperResponseAction"
    - "TamperDetectionResult correctly aggregates 5 check results (Namespace/Fingerprint/Seal/Chain/FileSize)"
    - "v1.0 to v2.0 migration round-trip preserves data for at least 10 configurations"
    - "VdeFormatDetector detects v1.0 and v2.0 formats correctly"
    - "V1CompatibilityLayer provides degraded-feature access to v1.0 VDEs"
  artifacts:
    - path: "DataWarehouse.Tests/VdeFormat/VdeFormatModuleTests.cs"
      provides: "19-module serialization/deserialization tests + 7-profile creation tests"
      min_lines: 500
    - path: "DataWarehouse.Tests/VdeFormat/TamperDetectionTests.cs"
      provides: "5-level tamper response + detection orchestrator + response executor tests"
      min_lines: 300
    - path: "DataWarehouse.Tests/VdeFormat/MigrationTests.cs"
      provides: "v1.0-to-v2.0 migration tests for 10+ configurations"
      min_lines: 400
  key_links:
    - from: "DataWarehouse.Tests/VdeFormat/VdeFormatModuleTests.cs"
      to: "DataWarehouse.SDK/VirtualDiskEngine/Format/VdeCreator.cs"
      via: "VdeCreationProfile factory + VdeCreator"
      pattern: "VdeCreationProfile|VdeCreator"
    - from: "DataWarehouse.Tests/VdeFormat/TamperDetectionTests.cs"
      to: "DataWarehouse.SDK/VirtualDiskEngine/Identity/TamperResponse.cs"
      via: "TamperResponseExecutor.Execute"
      pattern: "TamperResponseExecutor"
    - from: "DataWarehouse.Tests/VdeFormat/MigrationTests.cs"
      to: "DataWarehouse.SDK/VirtualDiskEngine/Compatibility/VdeMigrationEngine.cs"
      via: "MigrateAsync round-trip"
      pattern: "VdeMigrationEngine|MigrateAsync"
---

<objective>
VDE format tests + tamper detection tests + migration tests

Purpose: Verify all 19 VDE modules serialize/deserialize correctly across all 7 creation profiles (INTG-06), all 5 TamperResponse levels are triggered and verified (INTG-07), and v1.0-to-v2.0 migration round-trips for 10+ configurations (INTG-08, MRES-12).

Output: Three test files covering VDE format modules, tamper detection/response, and migration.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@DataWarehouse.SDK/VirtualDiskEngine/Format/ModuleDefinitions.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/VdeCreationProfile.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/VdeCreator.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/SuperblockV2.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/ModuleManifest.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/RegionDirectory.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/RegionPointerTable.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/BlockTypeTags.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/UniversalBlockTrailer.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/InodeV2.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/MagicSignature.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/FormatConstants.cs
@DataWarehouse.SDK/VirtualDiskEngine/Identity/TamperResponse.cs
@DataWarehouse.SDK/VirtualDiskEngine/Identity/TamperDetectionOrchestrator.cs
@DataWarehouse.SDK/VirtualDiskEngine/Identity/FormatFingerprintValidator.cs
@DataWarehouse.SDK/VirtualDiskEngine/Identity/HeaderIntegritySeal.cs
@DataWarehouse.SDK/VirtualDiskEngine/Identity/MetadataChainHasher.cs
@DataWarehouse.SDK/VirtualDiskEngine/Identity/FileSizeSentinel.cs
@DataWarehouse.SDK/VirtualDiskEngine/Identity/NamespaceAuthority.cs
@DataWarehouse.SDK/VirtualDiskEngine/Compatibility/VdeMigrationEngine.cs
@DataWarehouse.SDK/VirtualDiskEngine/Compatibility/VdeFormatDetector.cs
@DataWarehouse.SDK/VirtualDiskEngine/Compatibility/V1CompatibilityLayer.cs
@DataWarehouse.SDK/VirtualDiskEngine/Compatibility/CompatibilityModeContext.cs
@DataWarehouse.SDK/VirtualDiskEngine/Compatibility/MigrationModuleSelector.cs
@DataWarehouse.SDK/VirtualDiskEngine/Regions/EncryptionHeaderRegion.cs
@DataWarehouse.SDK/VirtualDiskEngine/Regions/PolicyVaultRegion.cs
@DataWarehouse.SDK/VirtualDiskEngine/Regions/ComplianceVaultRegion.cs
@DataWarehouse.SDK/VirtualDiskEngine/Regions/IntelligenceCacheRegion.cs
@DataWarehouse.SDK/VirtualDiskEngine/Regions/TagIndexRegion.cs
@DataWarehouse.SDK/VirtualDiskEngine/Regions/ReplicationStateRegion.cs
@DataWarehouse.SDK/VirtualDiskEngine/Regions/RaidMetadataRegion.cs
@DataWarehouse.SDK/VirtualDiskEngine/Regions/StreamingAppendRegion.cs
@DataWarehouse.SDK/VirtualDiskEngine/Regions/ComputeCodeCacheRegion.cs
@DataWarehouse.SDK/VirtualDiskEngine/Regions/CrossVdeReferenceRegion.cs
@DataWarehouse.SDK/VirtualDiskEngine/Regions/ConsensusLogRegion.cs
@DataWarehouse.SDK/VirtualDiskEngine/Regions/CompressionDictionaryRegion.cs
@DataWarehouse.SDK/VirtualDiskEngine/Regions/IntegrityTreeRegion.cs
@DataWarehouse.SDK/VirtualDiskEngine/Regions/SnapshotTableRegion.cs
@DataWarehouse.SDK/VirtualDiskEngine/Regions/AnonymizationTableRegion.cs
@DataWarehouse.SDK/VirtualDiskEngine/Regions/MetricsLogRegion.cs
@DataWarehouse.SDK/VirtualDiskEngine/Regions/AuditLogRegion.cs
@DataWarehouse.SDK/VirtualDiskEngine/Regions/WormImmutableRegion.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: VDE format module serialization and creation profile tests</name>
  <files>
    DataWarehouse.Tests/VdeFormat/VdeFormatModuleTests.cs
  </files>
  <action>
Create new directory DataWarehouse.Tests/VdeFormat/ and VdeFormatModuleTests.cs (~80 tests):

1. **Module manifest tests** (~19 tests, one per module):
   For each of the 19 ModuleId values (Security=0 through AuditLog=18):
   - Verify module bit position in manifest: (1u << (byte)moduleId) sets correct bit
   - Verify module has valid VdeModule metadata (Name, Abbreviation, BlockTypeTags, RegionNames, InodeExtensionBytes)
   - Use [Theory] + [InlineData(ModuleId.Security)] through [InlineData(ModuleId.AuditLog)]

2. **Region serialization round-trip** (~19 tests, one per region-equipped module):
   For each region type (EncryptionHeaderRegion, PolicyVaultRegion, ComplianceVaultRegion, IntelligenceCacheRegion, TagIndexRegion, ReplicationStateRegion, RaidMetadataRegion, StreamingAppendRegion, ComputeCodeCacheRegion, CrossVdeReferenceRegion, ConsensusLogRegion, CompressionDictionaryRegion, IntegrityTreeRegion, SnapshotTableRegion, AnonymizationTableRegion, MetricsLogRegion, AuditLogRegion):
   - Create region with test data
   - Serialize to byte[] (write to MemoryStream)
   - Deserialize from byte[] (read from MemoryStream)
   - Verify deserialized equals original (field-by-field)
   - Note: Sustainability (bit 15) and Transit (bit 16) have no dedicated region — test their inode-only path instead

3. **VdeCreationProfile factory tests** (~7 tests, one per profile type):
   - VdeCreationProfile.Minimal(1024): manifest=0x00000000, blockSize=4096, tamperResponse=0x00
   - VdeCreationProfile.Standard(1024): manifest has SEC+CMPR+INTG+SNAP bits
   - VdeCreationProfile.Enterprise(1024): manifest includes compliance, intelligence, tags, audit
   - VdeCreationProfile.MaxSecurity(1024): all 19 bits set (manifest=0x7FFFF)
   - VdeCreationProfile.EdgeIoT(1024): blockSize=512, streaming+integrity
   - VdeCreationProfile.Analytics(1024): blockSize=65536, intelligence+compression+snapshot+query
   - Custom profile with explicit module selection: verify only specified bits set

4. **SuperblockV2 structure tests** (~10 tests):
   - Constructor-based immutability: all properties set at creation
   - FormatVersionInfo 16 bytes (2+2+4+4+4) correct layout
   - MagicSignature.Validate() checks DWVD magic bytes
   - NamespaceAnchor stored as ulong (zero-alloc)
   - RegionPointerTable mutable slots assignment

5. **UniversalBlockTrailer** (~5 tests):
   - StructLayout Sequential Pack=1 produces 16-byte layout
   - XxHash64 checksum verification
   - Block type tag big-endian (first ASCII char in MSB)
   - Trailer at end of block: blockSize - 16

6. **InodeV2** (~5 tests):
   - Class (not struct) due to variable size
   - Module fields as raw byte[] blob
   - InodeLayoutDescriptor offsets correct for active modules
   - ModuleFieldEntry includes FieldVersion

7. **BlockTypeTags** (~5 tests):
   - 28 tags defined (22 core + 6 module extensions)
   - Each tag is unique ulong value
   - Big-endian encoding correct

8. **Cross-profile module verification** (~10 tests via [Theory]):
   - [Theory] with all 7 VdeProfileType values: each produces valid profile
   - Verify ModuleManifest bit count matches expected module count per profile
   - Verify ModuleConfigLevels has entry for each active module
   - Verify ThinProvisioned flag set correctly per profile
  </action>
  <verify>
    Run `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter "FullyQualifiedName~VdeFormatModule" --no-build` after building. All tests pass.
  </verify>
  <done>
    VdeFormatModuleTests.cs has 80+ tests covering all 19 modules (manifest, region serialization), all 7 creation profiles, superblock structure, block trailer, inode, block type tags, and cross-profile verification. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Tamper detection tests + migration tests</name>
  <files>
    DataWarehouse.Tests/VdeFormat/TamperDetectionTests.cs
    DataWarehouse.Tests/VdeFormat/MigrationTests.cs
  </files>
  <action>
Create TamperDetectionTests.cs (~40 tests):

1. **TamperResponseExecutor** (~15 tests):
   - Clean result + each of 5 TamperResponse levels → AllowOpen=true, ReadOnlyMode=false, Quarantined=false
   - Tampered result + TamperResponse.Log → AllowOpen=true, ReadOnlyMode=false, message contains "logged"
   - Tampered result + TamperResponse.Alert → AllowOpen=true, message contains "ALERT"
   - Tampered result + TamperResponse.ReadOnly → AllowOpen=true, ReadOnlyMode=true
   - Tampered result + TamperResponse.Quarantine → AllowOpen=false, Quarantined=true
   - Tampered result + TamperResponse.Reject → throws VdeTamperDetectedException
   - Invalid TamperResponse enum value → throws ArgumentOutOfRangeException
   - Null result → throws ArgumentNullException

2. **TamperDetectionResult** (~10 tests):
   - All 5 checks pass → IsClean=true, Summary="All 5 integrity checks passed"
   - 1 check fails → IsClean=false, FailedChecks.Count=1
   - All 5 checks fail → FailedChecks.Count=5
   - Summary includes names of failed checks
   - CheckNames match constants: NamespaceSignature, FormatFingerprint, HeaderIntegritySeal, MetadataChainHash, FileSizeSentinel
   - Null checks array → throws ArgumentNullException
   - Empty checks array → IsClean=true

3. **TamperResponsePolicy** (~10 tests):
   - Serialize: single byte containing TamperResponse enum value
   - Deserialize: recovers correct TamperResponse from byte
   - ToPolicyDefinition: produces PolicyDefinition with PolicyTypeId=0x0074
   - FromPolicyDefinition: round-trips through PolicyDefinition
   - Wrong PolicyType throws ArgumentException
   - Null/empty data throws ArgumentException
   - Default property returns TamperResponse.Reject
   - All 5 TamperResponse values survive Serialize → Deserialize round-trip

4. **TamperCheckResult** (~5 tests):
   - Record struct with CheckName, Passed, FailureReason
   - Passed=true → FailureReason typically null
   - Passed=false → FailureReason describes what failed
   - Equality comparison works (record struct)

Create MigrationTests.cs (~50 tests):

1. **VdeFormatDetector** (~10 tests):
   - Detect v2.0 VDE from magic bytes + version field
   - Detect v1.0 VDE from magic bytes + version field
   - Non-VDE file returns unknown format
   - Truncated file handled gracefully (not crash)
   - Empty stream handled gracefully
   - Both DwvdContentDetector + VdeFormatDetector agree on format (double verification per Phase 81 decision)

2. **V1CompatibilityLayer** (~10 tests):
   - v1.0 VDE opens with 18 degraded features and 6 available features
   - Cached parsed superblock (no re-parse on subsequent access)
   - Namespace anchor validation skipped for v1.0
   - VdeFormatException thrown for genuinely corrupt v1.0 data

3. **MigrationModuleSelector** (~5 tests):
   - Standard profile selected for default migration
   - Custom module selection respects user preferences
   - Security module always included in migration

4. **VdeMigrationEngine round-trip** (~15 tests):
   For at least 10 different configurations:
   - Config 1: Minimal v1.0 (empty container) → v2.0 Minimal
   - Config 2: v1.0 with data blocks → v2.0 Standard (data preserved)
   - Config 3: v1.0 → v2.0 Enterprise profile
   - Config 4: v1.0 → v2.0 MaxSecurity profile
   - Config 5: v1.0 → v2.0 EdgeIoT (512-byte blocks)
   - Config 6: v1.0 → v2.0 Analytics (64K blocks)
   - Config 7: v1.0 with 1000 blocks → v2.0 (verify data block count preserved)
   - Config 8: v1.0 → v2.0 Custom (3 modules only)
   - Config 9: v1.0 → v2.0 → verify v2.0 format detection succeeds
   - Config 10: Migration progress callback fires all phases (Detecting through Complete)

   For each: create v1.0 in MemoryStream, migrate, verify v2.0 structure.
   Sequential block copy (not ExtentAwareVdeCopy) per Phase 81 decision.
   Skip metadata blocks 0-9 per Phase 81 decision.

5. **MigrationPhase tracking** (~5 tests):
   - Progress reports all phases: Detecting → ReadingSource → CreatingDestination → CopyingData → VerifyingResult → Complete
   - Failed migration reports Failed phase
   - PercentComplete monotonically increases
   - BytesCopied <= TotalEstimatedBytes

6. **CompatibilityModeContext** (~5 tests):
   - Context captures source version and target profile
   - V5ConfigMigrator maps 23 v5.0 config keys correctly
   - AiAutonomyDefaults provides pure static defaults
   - PolicyCompatibilityGate enforces version compatibility rules
  </action>
  <verify>
    Run `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter "FullyQualifiedName~TamperDetection|FullyQualifiedName~Migration" --no-build` after building. All tests pass.
  </verify>
  <done>
    TamperDetectionTests.cs has 40+ tests covering all 5 TamperResponse levels, TamperDetectionResult aggregation, TamperResponsePolicy serialization, and TamperCheckResult structure. MigrationTests.cs has 50+ tests covering VdeFormatDetector, V1CompatibilityLayer, MigrationModuleSelector, 10+ migration configurations round-trip, phase tracking, and CompatibilityModeContext. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build DataWarehouse.Tests/DataWarehouse.Tests.csproj` completes with 0 errors
2. `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter "FullyQualifiedName~VdeFormat|FullyQualifiedName~TamperDetection|FullyQualifiedName~Migration" --no-build` — all pass
3. VDE format tests cover all 19 modules and all 7 creation profiles
4. All 5 TamperResponse levels tested and verified
5. 10+ migration configurations round-tripped
</verification>

<success_criteria>
- All 19 VDE modules serialize/deserialize/verify correctly
- All 7 creation profiles produce valid structures
- All 5 TamperResponse levels produce correct TamperResponseAction
- TamperResponse.Reject throws VdeTamperDetectedException
- 10+ migration configurations verified round-trip
- VdeFormatDetector correctly identifies v1.0 and v2.0
- Zero test failures
</success_criteria>

<output>
After completion, create `.planning/phases/83-integration-testing/83-05-SUMMARY.md`
</output>
