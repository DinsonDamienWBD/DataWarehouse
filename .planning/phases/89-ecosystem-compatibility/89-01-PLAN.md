---
phase: 89-ecosystem-compatibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.SDK/Contracts/Ecosystem/DataWarehouseService.proto
  - DataWarehouse.SDK/Contracts/Ecosystem/ProtoServiceDefinitions.cs
  - DataWarehouse.SDK/Contracts/Ecosystem/ProtoVersioningStrategy.cs
autonomous: true
must_haves:
  truths:
    - "All DW operations (Store, Retrieve, Query, Tag, Search, Stream, Admin) have protobuf service definitions"
    - "Proto files use proper versioning (package datawarehouse.v1) with reserved fields for evolution"
    - "C# mirror types exist for each proto message enabling runtime proto-less gRPC serving"
  artifacts:
    - path: "DataWarehouse.SDK/Contracts/Ecosystem/DataWarehouseService.proto"
      provides: "Canonical .proto definitions for all DW operations"
      contains: "service DataWarehouseService"
    - path: "DataWarehouse.SDK/Contracts/Ecosystem/ProtoServiceDefinitions.cs"
      provides: "C# message types mirroring proto definitions"
      exports: ["StoreRequest", "StoreResponse", "RetrieveRequest", "RetrieveResponse", "QueryRequest", "QueryResponse", "TagRequest", "SearchRequest", "SearchResponse", "StreamRequest", "AdminRequest"]
    - path: "DataWarehouse.SDK/Contracts/Ecosystem/ProtoVersioningStrategy.cs"
      provides: "Proto versioning and compatibility checking"
      exports: ["ProtoVersioningStrategy"]
  key_links:
    - from: "DataWarehouse.SDK/Contracts/Ecosystem/ProtoServiceDefinitions.cs"
      to: "DataWarehouse.SDK/Contracts/Interface/GrpcServiceGenerator.cs"
      via: "GrpcServiceDescriptor integration"
      pattern: "GrpcServiceDescriptor"
---

<objective>
Define canonical protobuf service definitions for all DataWarehouse operations (ECOS-12).

Purpose: The .proto files serve as the single source of truth from which all multi-language SDKs are generated. The C# mirror types enable runtime gRPC serving without build-time protoc codegen. Proto versioning strategy ensures backward compatibility as the API evolves.

Output: .proto file with full service definitions, C# message mirror types, versioning strategy
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@DataWarehouse.SDK/Contracts/Interface/GrpcServiceGenerator.cs
@DataWarehouse.SDK/Hardware/Interop/GrpcServiceContracts.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create .proto service definitions for all DW operations</name>
  <files>DataWarehouse.SDK/Contracts/Ecosystem/DataWarehouseService.proto</files>
  <action>
Create a comprehensive protobuf3 service definition file covering all DW operations. Use `package datawarehouse.v1;` with `option csharp_namespace = "DataWarehouse.SDK.Contracts.Ecosystem.Proto";`.

Define these services and their messages:

1. **StorageService**: `Store(StoreRequest) returns (StoreResponse)`, `Retrieve(RetrieveRequest) returns (stream RetrieveChunk)`, `Delete(DeleteRequest) returns (DeleteResponse)`, `Exists(ExistsRequest) returns (ExistsResponse)`, `GetMetadata(GetMetadataRequest) returns (MetadataResponse)`, `List(ListRequest) returns (stream ListEntry)`

2. **QueryService**: `Execute(QueryRequest) returns (stream QueryResultBatch)`, `Prepare(PrepareRequest) returns (PrepareResponse)`, `ExecutePrepared(ExecutePreparedRequest) returns (stream QueryResultBatch)`

3. **TagService**: `SetTags(SetTagsRequest) returns (TagResponse)`, `GetTags(GetTagsRequest) returns (TagResponse)`, `RemoveTags(RemoveTagsRequest) returns (TagResponse)`

4. **SearchService**: `Search(SearchRequest) returns (stream SearchResult)`, `SearchByTags(TagSearchRequest) returns (stream SearchResult)`

5. **StreamService**: `StreamStore(stream StoreChunk) returns (StoreResponse)`, `StreamRetrieve(RetrieveRequest) returns (stream RetrieveChunk)`, `Subscribe(SubscribeRequest) returns (stream Event)`

6. **AdminService**: `GetHealth(HealthRequest) returns (HealthResponse)`, `GetCapabilities(CapabilitiesRequest) returns (CapabilitiesResponse)`, `ManagePlugin(PluginRequest) returns (PluginResponse)`, `GetMetrics(MetricsRequest) returns (MetricsResponse)`

Each message type should have proper field numbering with reserved ranges (100-199) for future extension. Use `google.protobuf.Timestamp` for time fields, `bytes` for binary data, `map<string, string>` for metadata. Include proper field-level comments.

Mark this as a documentation/specification file (not compiled by C# build) with a header comment explaining it's the source of truth for SDK code generation.
  </action>
  <verify>File exists and is valid protobuf3 syntax (check for `syntax = "proto3";`, proper message nesting, field numbers, no duplicate field numbers)</verify>
  <done>Complete .proto file with 6 services, all RPC methods, all message types, reserved field ranges, and versioning comments</done>
</task>

<task type="auto">
  <name>Task 2: Create C# proto mirror types and versioning strategy</name>
  <files>DataWarehouse.SDK/Contracts/Ecosystem/ProtoServiceDefinitions.cs, DataWarehouse.SDK/Contracts/Ecosystem/ProtoVersioningStrategy.cs</files>
  <action>
**ProtoServiceDefinitions.cs**: Create C# record types that mirror every proto message from Task 1. These enable runtime gRPC serving via the existing `GrpcServiceDescriptor` system without needing protoc-generated code. Each record should have:
- `[SdkCompatibility("6.0.0", Notes = "Phase 89: Ecosystem proto definitions (ECOS-12)")]` attribute
- Proper nullable annotations
- Conversion methods `ToBytes()` and `static FromBytes()` using simple binary serialization (length-prefixed fields matching proto wire format field numbers)

Key types: `ProtoStoreRequest`, `ProtoStoreResponse`, `ProtoRetrieveRequest`, `ProtoRetrieveChunk`, `ProtoQueryRequest`, `ProtoQueryResultBatch` (with `ColumnDescriptor` containing name + `ProtoColumnType` enum mapping to `ColumnDataType`), `ProtoSearchRequest`, `ProtoSearchResult`, `ProtoHealthResponse`, `ProtoCapabilitiesResponse`.

Include a `ProtoColumnType` enum that maps 1:1 to `ColumnDataType` from `DataWarehouse.SDK.Contracts.Query.ColumnarBatch`.

**ProtoVersioningStrategy.cs**: Create a versioning strategy class with:
- `CurrentVersion` property returning "1.0.0"
- `IsCompatible(string clientVersion)` method checking major version match
- `GetDeprecatedFields(string service, string method)` returning deprecated field numbers
- `MigrateRequest(string service, string method, ReadOnlyMemory<byte> oldPayload, string fromVersion)` for forward-migrating old client requests
- `[SdkCompatibility("6.0.0")]` attribute

Wire the proto types into `GrpcServiceDescriptor` by creating a static `DataWarehouseGrpcServices.GetServiceDescriptors()` method that returns descriptors for all 6 services.
  </action>
  <verify>`dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` compiles without errors</verify>
  <done>All proto mirror types compile, versioning strategy handles version checking and migration, service descriptors registered for all 6 services</done>
</task>

</tasks>

<verification>
- .proto file contains 6 services with all RPC methods
- C# mirror types compile and map to proto field numbers
- ProtoVersioningStrategy.IsCompatible returns true for "1.0.0", false for "2.0.0"
- GrpcServiceDescriptor list contains all 6 services
</verification>

<success_criteria>
All DW operations have protobuf service definitions. C# mirror types enable runtime serving. Versioning strategy provides backward compatibility checking.
</success_criteria>

<output>
After completion, create `.planning/phases/89-ecosystem-compatibility/89-01-SUMMARY.md`
</output>
