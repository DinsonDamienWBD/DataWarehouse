---
phase: 89-ecosystem-compatibility
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateDatabaseProtocol/Strategies/Relational/PostgreSqlProtocolStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateDatabaseProtocol/Strategies/Relational/PostgreSqlWireVerification.cs
autonomous: true
must_haves:
  truths:
    - "PostgreSQL wire protocol handles startup handshake, all auth methods, simple query, extended query, COPY, and error responses correctly"
    - "Missing message types (CopyBothResponse, NegotiateProtocolVersion, PortalSuspended) are fully handled"
    - "Verification class documents all protocol message coverage with test scenarios"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateDatabaseProtocol/Strategies/Relational/PostgreSqlProtocolStrategy.cs"
      provides: "Complete PostgreSQL v3 wire protocol implementation"
      contains: "class PostgreSqlProtocolStrategy"
    - path: "Plugins/DataWarehouse.Plugins.UltimateDatabaseProtocol/Strategies/Relational/PostgreSqlWireVerification.cs"
      provides: "Protocol completeness verification and gap-fix documentation"
      exports: ["PostgreSqlWireVerification"]
  key_links:
    - from: "Plugins/DataWarehouse.Plugins.UltimateDatabaseProtocol/Strategies/Relational/PostgreSqlProtocolStrategy.cs"
      to: "Plugins/DataWarehouse.Plugins.UltimateDatabaseProtocol/DatabaseProtocolStrategyBase.cs"
      via: "extends DatabaseProtocolStrategyBase"
      pattern: "class PostgreSqlProtocolStrategy : DatabaseProtocolStrategyBase"
---

<objective>
Verify and complete the PostgreSQL wire protocol implementation (ECOS-01).

Purpose: The existing `PostgreSqlProtocolStrategy.cs` (964 lines) implements PostgreSQL Frontend/Backend Protocol v3.0. This plan audits for completeness against the PostgreSQL wire protocol specification, fixes any gaps in startup handshake, authentication (cleartext/MD5/SCRAM-SHA-256), simple query protocol, extended query protocol (Parse/Bind/Describe/Execute/Sync), COPY protocol, error/notice handling, SSL negotiation, and cancel request handling.

Output: Verified and gap-filled PostgreSQL wire protocol, verification documentation
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@Plugins/DataWarehouse.Plugins.UltimateDatabaseProtocol/Strategies/Relational/PostgreSqlProtocolStrategy.cs
@Plugins/DataWarehouse.Plugins.UltimateDatabaseProtocol/DatabaseProtocolStrategyBase.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit and fix PostgreSQL wire protocol gaps</name>
  <files>Plugins/DataWarehouse.Plugins.UltimateDatabaseProtocol/Strategies/Relational/PostgreSqlProtocolStrategy.cs</files>
  <action>
Read the full `PostgreSqlProtocolStrategy.cs` (964 lines) and audit against the PostgreSQL v3.0 wire protocol specification. For each protocol area, verify implementation exists and fix gaps:

**Startup Phase:**
- Verify startup message sends protocol version (3.0), database, user, application_name, client_encoding
- Verify server parameter handling (stores all ParameterStatus messages)
- Verify BackendKeyData (process ID + secret key) stored for cancel support
- Verify ReadyForQuery handling with transaction status byte ('I', 'T', 'E')

**Authentication:**
- Verify AuthenticationOk (type 0)
- Verify AuthenticationCleartextPassword (type 3) — sends password in cleartext
- Verify AuthenticationMD5Password (type 5) — MD5(MD5(password + user) + salt)
- Verify AuthenticationSASL (type 10) — SCRAM-SHA-256 with proper nonce, SaltedPassword, ClientKey, StoredKey, AuthMessage, ClientProof, ServerSignature verification
- Fix if any auth type is stubbed or has incorrect crypto

**Simple Query Protocol:**
- Verify Query message ('Q') sends SQL string
- Verify handling of RowDescription ('T'), DataRow ('D'), CommandComplete ('C'), EmptyQueryResponse ('I'), ErrorResponse ('E')
- Verify multi-statement query handling (multiple result sets in one query)

**Extended Query Protocol:**
- Verify Parse ('P') with destination name, SQL, parameter OIDs
- Verify Bind ('B') with portal name, statement name, format codes, parameter values, result format codes
- Verify Describe ('D') for both statements ('S') and portals ('P')
- Verify Execute ('E') with portal name and max rows
- Verify Sync ('S') for transaction sync
- Verify Close ('C') for closing named statements/portals
- Verify Flush ('H')

**COPY Protocol:**
- Verify CopyInResponse ('G') handling with format and per-column formats
- Verify CopyOutResponse ('H') handling
- Verify CopyData ('d') for data transfer
- Verify CopyDone ('c') for completion
- Verify CopyFail ('f') for client-initiated failure

**Error Handling:**
- Verify ErrorResponse ('E') parsing of field types: 'S' (severity), 'V' (severity non-localized), 'C' (SQLSTATE code), 'M' (message), 'D' (detail), 'H' (hint), 'P' (position), 'p' (internal position), 'q' (internal query), 'W' (where), 's' (schema), 't' (table), 'c' (column), 'd' (data type), 'n' (constraint), 'F' (file), 'L' (line), 'R' (routine)
- Verify NoticeResponse ('N') with same field parsing

**Cancel Request:**
- Verify CancelRequest message format (16-byte: length=16, code=80877102, processId, secretKey)

For each gap found: implement the missing functionality with production-ready code. Do NOT add stubs. Mark fixed sections with `// ECOS-01: Fixed [description]` comment.
  </action>
  <verify>`dotnet build Plugins/DataWarehouse.Plugins.UltimateDatabaseProtocol/DataWarehouse.Plugins.UltimateDatabaseProtocol.csproj` compiles</verify>
  <done>All PostgreSQL v3.0 wire protocol message types are implemented. No stubbed or placeholder handlers remain.</done>
</task>

<task type="auto">
  <name>Task 2: Create wire protocol verification documentation</name>
  <files>Plugins/DataWarehouse.Plugins.UltimateDatabaseProtocol/Strategies/Relational/PostgreSqlWireVerification.cs</files>
  <action>
Create a verification class `PostgreSqlWireVerification` with `[SdkCompatibility("6.0.0", Notes = "Phase 89: PostgreSQL wire verification (ECOS-01)")]` that documents protocol coverage and provides self-test capability.

The class should contain:
1. A `GetProtocolCoverage()` method returning `PostgreSqlProtocolCoverage` record with:
   - `IReadOnlyList<ProtocolMessageCoverage> BackendMessages` — all backend message types with implementation status
   - `IReadOnlyList<ProtocolMessageCoverage> FrontendMessages` — all frontend message types with implementation status
   - `IReadOnlyList<AuthMethodCoverage> AuthMethods` — each auth method with implementation status
   - `double CoveragePercent` — overall coverage percentage

2. A `VerifyStartupSequence(Stream mockStream)` method that writes a mock startup handshake and verifies the expected response sequence: StartupMessage -> AuthenticationRequest -> (auth exchange) -> ParameterStatus* -> BackendKeyData -> ReadyForQuery

3. A `VerifyExtendedQuerySequence(Stream mockStream)` method that writes Parse/Bind/Describe/Execute/Sync and verifies ParseComplete/BindComplete/RowDescription/DataRow/CommandComplete/ReadyForQuery

4. A `GetCompatibilityMatrix()` method returning a dictionary of client tool names (psql, pgAdmin, DBeaver, npgsql, JDBC, SQLAlchemy) to expected compatibility notes.

Record types: `ProtocolMessageCoverage(char MessageType, string Name, bool Implemented, string Notes)`, `AuthMethodCoverage(string Method, bool Implemented, string Notes)`.
  </action>
  <verify>`dotnet build Plugins/DataWarehouse.Plugins.UltimateDatabaseProtocol/DataWarehouse.Plugins.UltimateDatabaseProtocol.csproj` compiles</verify>
  <done>Verification class documents 100% backend/frontend message coverage, auth method coverage, and client compatibility matrix</done>
</task>

</tasks>

<verification>
- PostgreSqlProtocolStrategy handles all 15+ backend message types and 10+ frontend message types
- SCRAM-SHA-256 auth follows RFC 5802 with proper crypto
- Extended query protocol supports Parse/Bind/Describe/Execute/Sync/Close/Flush
- Verification class reports 100% protocol coverage
- Build succeeds
</verification>

<success_criteria>
PostgreSQL wire protocol is complete and verified against the v3.0 specification. No gaps in startup, auth, simple query, extended query, COPY, or error handling.
</success_criteria>

<output>
After completion, create `.planning/phases/89-ecosystem-compatibility/89-03-SUMMARY.md`
</output>
