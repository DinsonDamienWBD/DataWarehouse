---
phase: 89-ecosystem-compatibility
plan: 10
type: execute
wave: 4
depends_on: ["89-09"]
files_modified:
  - DataWarehouse.SDK/Contracts/Ecosystem/JepsenTestScenarios.cs
  - DataWarehouse.SDK/Contracts/Ecosystem/JepsenReportGenerator.cs
autonomous: true
must_haves:
  truths:
    - "Linearizability test scenarios run under network partitions and process kills"
    - "Raft correctness verified under leader loss and partition healing"
    - "MVCC snapshot isolation verified against write skew anomalies"
    - "Jepsen report generator produces structured results with pass/fail per scenario"
  artifacts:
    - path: "DataWarehouse.SDK/Contracts/Ecosystem/JepsenTestScenarios.cs"
      provides: "Complete Jepsen test scenario definitions for all consistency properties"
      exports: ["JepsenTestScenarios"]
    - path: "DataWarehouse.SDK/Contracts/Ecosystem/JepsenReportGenerator.cs"
      provides: "Jepsen report generation in HTML and JSON formats"
      exports: ["JepsenReportGenerator"]
  key_links:
    - from: "DataWarehouse.SDK/Contracts/Ecosystem/JepsenTestScenarios.cs"
      to: "DataWarehouse.SDK/Contracts/Ecosystem/JepsenTestHarness.cs"
      via: "Scenarios define test plans executed by harness"
      pattern: "JepsenTestPlan"
    - from: "DataWarehouse.SDK/Contracts/Ecosystem/JepsenTestScenarios.cs"
      to: "DataWarehouse.SDK/Contracts/Ecosystem/JepsenFaultInjection.cs"
      via: "Scenarios use fault injectors in their schedules"
      pattern: "IFaultInjector"
---

<objective>
Define Jepsen test scenarios and report generator (ECOS-17).

Purpose: This plan creates the specific test scenarios that prove distributed correctness of DW under failure conditions: linearizability under partition, Raft leader election correctness, CRDT convergence, WAL crash recovery, MVCC snapshot isolation, DVV replication consistency, and split-brain prevention. A report generator produces human-readable results.

Output: Complete test scenario definitions, report generator
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/89-ecosystem-compatibility/89-09-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Jepsen test scenarios</name>
  <files>DataWarehouse.SDK/Contracts/Ecosystem/JepsenTestScenarios.cs</files>
  <action>
Create `JepsenTestScenarios` with `[SdkCompatibility("6.0.0", Notes = "Phase 89: Jepsen test scenarios (ECOS-17)")]`.

This class provides factory methods for each required test scenario, returning `JepsenTestPlan` instances:

1. **`LinearizabilityUnderPartition()`** — 5-node cluster, RegisterWorkload, NetworkPartitionFault (MajorityMinority) at T+10s for 30s, total duration 60s, 10 concurrent clients. Expected: ConsistencyModel.Linearizable. Verifies that majority partition accepts writes and minority rejects them.

2. **`RaftLeaderElectionUnderPartition()`** — 5-node cluster, RegisterWorkload, ProcessKillFault targeting current leader node at T+15s, partition healing at T+30s, total 60s, 5 clients. Expected: Linearizable. Verifies new leader elected within election timeout, no split-brain, old leader steps down on rejoin.

3. **`CrdtConvergenceUnderDelay()`** — 5-node cluster, SetWorkload, ClockSkewFault (500ms-2s skew on 2 nodes) at T+5s for 40s, total 60s, 10 clients. Expected: CausalConsistency. Verifies CRDT sets converge to same state after clock skew heals.

4. **`WalCrashRecovery()`** — 3-node cluster, ListAppendWorkload, ProcessKillFault (kill-9 on 1 node during active writes) at T+10s, restart at T+20s, total 45s, 5 clients. Expected: Serializable. Verifies no data loss after WAL replay on restart, all committed operations durable.

5. **`MvccSnapshotIsolation()`** — 3-node cluster, BankWorkload, no faults (testing isolation under concurrency), total 30s, 20 concurrent clients. Expected: SnapshotIsolation. Verifies no write skew, total balance conserved, no dirty reads.

6. **`DvvReplicationConsistency()`** — 5-node cluster, RegisterWorkload with CAS operations, NetworkPartitionFault (HalfAndHalf) at T+10s for 20s, total 60s, 10 clients. Expected: CausalConsistency. Verifies DVV (Dotted Version Vector) resolves conflicts correctly after partition heals.

7. **`SplitBrainPrevention()`** — 5-node cluster, RegisterWorkload, NetworkPartitionFault isolating 2 nodes from 3-node majority at T+5s for 45s, total 60s, 10 clients targeting both partitions. Expected: Linearizable. Verifies minority partition rejects writes (fences itself), majority continues serving.

Each scenario method includes:
- Documentation comment explaining what it tests and what passing means
- Appropriate `JepsenTestPlan` with faults, workloads, timing, and expected consistency model
- `Tags` property for categorization (e.g., "raft", "partition", "recovery", "isolation")

Also provide `static IReadOnlyList<JepsenTestPlan> GetAllScenarios()` returning all 7 scenarios.
  </action>
  <verify>`dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` compiles without errors</verify>
  <done>All 7 Jepsen test scenarios defined with proper fault schedules, workload configurations, and expected consistency models</done>
</task>

<task type="auto">
  <name>Task 2: Create Jepsen report generator</name>
  <files>DataWarehouse.SDK/Contracts/Ecosystem/JepsenReportGenerator.cs</files>
  <action>
Create `JepsenReportGenerator` with `[SdkCompatibility("6.0.0", Notes = "Phase 89: Jepsen report generator (ECOS-17)")]`.

Generates comprehensive Jepsen test reports:

1. **`GenerateReport(IReadOnlyList<JepsenTestResult> results)`** returns `JepsenReport`:
   - `JepsenReport` record: `DateTimeOffset GeneratedAt`, `int TotalScenarios`, `int Passed`, `int Failed`, `IReadOnlyList<ScenarioResult> Scenarios`, `string OverallVerdict` ("PASS"/"FAIL")

2. **`ScenarioResult`** record:
   - `string ScenarioName`, `bool Passed`, `ConsistencyModel TestedModel`
   - `long TotalOperations`, `long AnomaliesDetected`
   - `TimeSpan Duration`, `string Summary`
   - `IReadOnlyList<ConsistencyViolation> Violations`
   - `OperationTimeline Timeline` — aggregated operation counts per second

3. **`GenerateHtmlReport(JepsenReport report)`** returns `string`:
   - HTML page with summary table (green/red per scenario)
   - Per-scenario sections with operation counts, timing, violations
   - Operation timeline showing reads/writes per second
   - Cluster topology diagram (text-based)
   - Fault injection timeline showing when faults were active

4. **`GenerateJsonReport(JepsenReport report)`** returns `string`:
   - Structured JSON with all result data
   - Machine-parseable for CI/CD integration
   - Includes full operation history (can be large, optionally truncated)

5. **`GenerateMarkdownSummary(JepsenReport report)`** returns `string`:
   - Concise markdown summary for inclusion in release notes
   - Table: Scenario | Result | Operations | Anomalies
   - Overall verdict with confidence statement

6. **`OperationTimeline`** record:
   - `IReadOnlyList<TimelineEntry> Entries` — per-second buckets
   - `TimelineEntry` record: `int SecondOffset`, `int Reads`, `int Writes`, `int Failures`, `bool FaultActive`

Use `StringBuilder` for HTML generation. No external template engines.
  </action>
  <verify>`dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` compiles without errors</verify>
  <done>Report generator produces HTML, JSON, and Markdown reports with per-scenario results, operation timelines, and fault injection timelines</done>
</task>

</tasks>

<verification>
- GetAllScenarios() returns 7 test plans
- Each scenario has proper fault schedules and workload configurations
- Report generator produces valid HTML with scenario pass/fail table
- JSON report is machine-parseable
- Markdown summary provides concise results table
- Build succeeds
</verification>

<success_criteria>
Seven Jepsen test scenarios cover linearizability, Raft correctness, CRDT convergence, WAL crash recovery, MVCC snapshot isolation, DVV replication, and split-brain prevention. Report generator produces publishable HTML/JSON/Markdown reports.
</success_criteria>

<output>
After completion, create `.planning/phases/89-ecosystem-compatibility/89-10-SUMMARY.md`
</output>
