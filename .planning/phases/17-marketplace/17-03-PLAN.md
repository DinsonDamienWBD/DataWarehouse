---
phase: 17-marketplace
plan: 03
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - Plugins/DataWarehouse.Plugins.PluginMarketplace/PluginMarketplacePlugin.cs
  - Metadata/TODO.md
autonomous: true
must_haves:
  truths:
    - "Usage analytics track plugin install counts, active usage, and popularity over time"
    - "Analytics data is aggregated by month and persisted"
    - "marketplace.analytics message handler returns usage data for a plugin"
    - "T57 and all 7 sub-features are marked complete in TODO.md"
    - "Final build verification passes for the complete plugin"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.PluginMarketplace/PluginMarketplacePlugin.cs"
      provides: "Usage analytics system added to existing plugin"
      contains: "UsageAnalytics"
    - path: "Metadata/TODO.md"
      provides: "T57 marked complete with all 7 features"
      contains: "[x] Plugin Discovery"
  key_links:
    - from: "Plugins/DataWarehouse.Plugins.PluginMarketplace/PluginMarketplacePlugin.cs"
      to: "Metadata/TODO.md"
      via: "Task completion marking"
      pattern: "T57.*COMPLETE"
---

<objective>
Add usage analytics tracking to the PluginMarketplace plugin and mark T57 complete in TODO.md.

Purpose: T57 requires usage analytics (telemetry for developers) as one of its 7 features. This plan adds event-based analytics with monthly aggregation, then performs final build verification and marks all T57 features complete in the task tracker.

Output: Complete PluginMarketplace plugin with all 7 T57 features implemented. TODO.md updated.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-marketplace/17-RESEARCH.md
@.planning/phases/17-marketplace/17-01-SUMMARY.md
@Metadata/TODO.md (lines 579-597 for T57)
@Metadata/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add usage analytics system with event tracking and monthly aggregation</name>
  <files>Plugins/DataWarehouse.Plugins.PluginMarketplace/PluginMarketplacePlugin.cs</files>
  <action>
  Add usage analytics to PluginMarketplacePlugin.cs. This tracks plugin lifecycle events and aggregates usage data for developer insights.

  **A) Analytics Record Types:**

  `PluginUsageEvent`:
  - EventId (string, generated), PluginId, EventType (UsageEventType enum), Timestamp (DateTime), UserId (string?), Metadata (Dictionary<string, object>?)

  `UsageEventType` enum: Installed, Uninstalled, Updated, Activated, Deactivated, ErrorOccurred, MessageHandled

  `PluginUsageAnalytics`:
  - PluginId, Period (string, "yyyy-MM"), InstallCount (int), UninstallCount (int), UpdateCount (int), ActiveUserCount (int), ErrorCount (int), MessageCount (long), PopularityScore (double), TrendDirection (TrendDirection enum)

  `TrendDirection` enum: Rising, Stable, Declining

  `PluginAnalyticsSummary`:
  - PluginId, TotalInstalls (long), TotalUninstalls (long), CurrentActiveInstalls (int), AverageSessionDuration (TimeSpan), MostActiveMonth (string), MonthlyData (PluginUsageAnalytics[])

  `MarketplaceAnalyticsSummary`:
  - TotalPlugins (int), TotalInstalls (long), MostPopularPlugins (string[], top 10), MostActiveCategory (string), GrowthRate (double, month-over-month), GeneratedAt (DateTime)

  **B) Analytics Implementation:**

  Add fields:
  - `ConcurrentDictionary<string, List<PluginUsageEvent>> _usageEvents`
  - `ConcurrentDictionary<string, PluginUsageAnalytics> _monthlyAnalytics`
  - `Timer _analyticsAggregationTimer` (runs hourly to aggregate)

  `RecordUsageEventAsync(PluginUsageEvent usageEvent, CancellationToken ct)`:
  - Validate EventType is defined
  - Add event to _usageEvents for the plugin
  - Append to event log file: `{storagePath}/analytics/events-{yyyy-MM-dd}.json` (daily event files)
  - Keep in-memory events bounded (max 10000 per plugin, evict oldest when exceeded)

  `AggregateAnalyticsAsync(CancellationToken ct)`:
  - Called periodically by _analyticsAggregationTimer (every hour)
  - For each plugin, compute monthly analytics from events:
    - InstallCount = count of Installed events in period
    - UninstallCount = count of Uninstalled events in period
    - UpdateCount = count of Updated events in period
    - ActiveUserCount = distinct UserIds with any event in period
    - ErrorCount = count of ErrorOccurred events in period
    - MessageCount = count of MessageHandled events in period
    - PopularityScore = (InstallCount * 10 + ActiveUserCount * 5 - UninstallCount * 3 - ErrorCount * 2) clamped to 0-100
    - TrendDirection: compare this month's PopularityScore vs last month's
  - Persist monthly analytics to `{storagePath}/analytics/usage-{yyyy-MM}.json`

  `GetPluginAnalyticsAsync(string pluginId, int monthsBack, CancellationToken ct)`:
  - Return PluginAnalyticsSummary with monthly data for the past N months
  - TotalInstalls from catalog entry InstallCount
  - MostActiveMonth from highest ActiveUserCount month

  `GetMarketplaceAnalyticsAsync(CancellationToken ct)`:
  - Return MarketplaceAnalyticsSummary with aggregate marketplace stats
  - MostPopularPlugins sorted by PopularityScore
  - GrowthRate = (this month installs - last month installs) / max(last month installs, 1)

  **C) Wire analytics into existing handlers:**

  In `marketplace.install` handler (already exists from Plan 01):
  - After successful install, call `RecordUsageEventAsync` with EventType.Installed

  In `marketplace.uninstall` handler:
  - After successful uninstall, call `RecordUsageEventAsync` with EventType.Uninstalled

  In `marketplace.update` handler:
  - After successful update, call `RecordUsageEventAsync` with EventType.Updated

  **D) Message handler for `marketplace.analytics`:**
  Add case in OnMessageAsync:
  - Extract pluginId (optional) and monthsBack (optional, default 12) from payload
  - If pluginId provided: return GetPluginAnalyticsAsync result
  - If no pluginId: return GetMarketplaceAnalyticsAsync result (marketplace-wide summary)

  **E) Timer lifecycle:**
  - In `StartAsync`: start _analyticsAggregationTimer with 1-hour interval (initial delay: 5 minutes)
  - In `StopAsync`: stop timer, run one final aggregation, save state
  - In constructor: initialize timer with Timeout.Infinite (disabled until StartAsync)

  **F) Persistence:**
  - `SaveAnalyticsAsync()` writes monthly analytics files
  - `LoadAnalyticsAsync()` reads analytics files on startup (called from LoadStateAsync)
  - Event files are append-only daily logs (not loaded fully into memory on startup, just referenced for aggregation)

  **CRITICAL:**
  - PopularityScore formula must use real event counts, not hardcoded values
  - Timer must be properly disposed in StopAsync
  - Event log files must be bounded (rotate daily, keep last 90 days)
  - Thread-safe event recording with ConcurrentDictionary
  - All types have XML documentation
  </action>
  <verify>
  Run: `dotnet build Plugins/DataWarehouse.Plugins.PluginMarketplace/DataWarehouse.Plugins.PluginMarketplace.csproj`
  Must compile with zero errors.
  Verify: grep for "RecordUsageEventAsync" shows event recording method.
  Verify: grep for "AggregateAnalyticsAsync" shows aggregation method.
  Verify: grep for "marketplace.analytics" shows message handler.
  Verify: grep for "PopularityScore" shows real formula (not hardcoded value).
  </verify>
  <done>
  - Usage analytics tracks install, uninstall, update, error events
  - Monthly aggregation computes popularity scores with trend direction
  - Analytics data persists to JSON files
  - marketplace.analytics message handler returns per-plugin and marketplace-wide data
  - Analytics events wired into install/uninstall/update handlers
  - Timer-based periodic aggregation with proper lifecycle
  - Build passes with zero errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Final build verification and mark T57 complete in TODO.md</name>
  <files>Metadata/TODO.md</files>
  <action>
  Perform final verification and update TODO.md.

  **Step 1: Full build verification**
  Run `dotnet build Plugins/DataWarehouse.Plugins.PluginMarketplace/DataWarehouse.Plugins.PluginMarketplace.csproj` and confirm zero errors.

  **Step 2: Verify all 7 T57 features are implemented** by checking PluginMarketplacePlugin.cs:
  1. Plugin Discovery -- marketplace.list handler with search/filter/sort
  2. One-Click Install -- marketplace.install handler with dependency resolution
  3. Version Management -- marketplace.update handler with archive/rollback
  4. Certification Program -- marketplace.certify handler with 5-stage pipeline
  5. Revenue Sharing -- RecordInstallRevenueAsync with commission calculation
  6. Rating and Reviews -- marketplace.review handler with multi-dimensional ratings
  7. Usage Analytics -- marketplace.analytics handler with monthly aggregation

  **Step 3: Verify no forbidden patterns** in PluginMarketplacePlugin.cs:
  - grep for: `NotImplementedException`, `throw new NotImplementedException`, `// TODO`, `// HACK`, `// FIXME`, `Task.Delay`, `Thread.Sleep`, `Simulation`, `Mock`, `Stub`, `Fake`, `Placeholder`
  - If any found, fix them before marking complete.

  **Step 4: Update Metadata/TODO.md** at lines 579-597:
  Change T57 status from `[ ] Not Started` to `[x] COMPLETE`
  Change all 7 feature statuses from `[ ]` to `[x]`:

  Replace the feature table:
  ```
  | Plugin Discovery | Search, filter, recommend | [x] |
  | One-Click Install | Automatic deployment | [x] |
  | Version Management | Upgrade, rollback | [x] |
  | Certification Program | Security review, testing | [x] |
  | Revenue Sharing | Monetization for developers | [x] |
  | Rating & Reviews | Community feedback | [x] |
  | Usage Analytics | Telemetry for developers | [x] |
  ```

  Also update the T57 status line to: `**Status:** [x] COMPLETE`

  Add implementation location: `**Implementation Location:** Plugins/DataWarehouse.Plugins.PluginMarketplace/PluginMarketplacePlugin.cs`

  Also update the tier 10.1 row in the tier summary table (around line 352) to mark T57 as [x].

  **Step 5: Verify the tier 10.1 line** (around line 352 in TODO.md):
  Change `| **10.1** | T57 | Plugin Marketplace | Plugin certification ecosystem | All Tier 1-9 tasks | [ ] |`
  To: `| **10.1** | T57 | Plugin Marketplace | Plugin certification ecosystem | All Tier 1-9 tasks | [x] |`
  </action>
  <verify>
  Run: `dotnet build Plugins/DataWarehouse.Plugins.PluginMarketplace/DataWarehouse.Plugins.PluginMarketplace.csproj` -- zero errors.
  grep for `NotImplementedException` in PluginMarketplacePlugin.cs -- zero matches.
  grep for `\[ \]` in TODO.md T57 section (lines 579-597) -- zero matches (all should be [x]).
  grep for `T57.*COMPLETE` in TODO.md -- should match.
  </verify>
  <done>
  - Full build passes with zero errors
  - All 7 T57 features verified present with real implementations
  - No forbidden patterns in plugin file
  - T57 marked [x] COMPLETE in TODO.md
  - All 7 feature rows marked [x] in TODO.md
  - Tier 10.1 row updated to [x]
  </done>
</task>

</tasks>

<verification>
1. `dotnet build Plugins/DataWarehouse.Plugins.PluginMarketplace/DataWarehouse.Plugins.PluginMarketplace.csproj` succeeds
2. All 7 T57 features have corresponding code in PluginMarketplacePlugin.cs
3. Zero forbidden patterns (NotImplementedException, TODO, HACK, Task.Delay, Mock, Stub, Simulation)
4. TODO.md T57 section shows all [x] complete
5. No build errors across the solution for this plugin
</verification>

<success_criteria>
- Usage analytics system tracks all plugin lifecycle events
- Monthly aggregation produces popularity scores and trends
- All 7 T57 features (discovery, install, versioning, certification, revenue, reviews, analytics) are implemented
- T57 marked complete in TODO.md with all 7 sub-features
- Plugin builds successfully with zero errors
- No forbidden patterns remain
</success_criteria>

<output>
After completion, create `.planning/phases/17-marketplace/17-03-SUMMARY.md`
</output>
