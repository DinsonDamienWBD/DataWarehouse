---
phase: 64-moonshot-wiring
plan: 03
type: execute
wave: 2
depends_on: ["64-01"]
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/MoonshotOrchestrator.cs
  - Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/MoonshotPipelineStages.cs
  - Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/DefaultPipelineDefinition.cs
  - Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/MoonshotRegistryImpl.cs
autonomous: true

must_haves:
  truths:
    - "Data ingest triggers the full moonshot pipeline: consciousness -> tags -> compliance -> sovereignty -> placement -> sync -> lifecycle"
    - "Each pipeline stage delegates to its moonshot's bus topics (not direct plugin calls)"
    - "Disabled moonshots are skipped gracefully without breaking the pipeline"
    - "Stage failures are captured but do not halt the pipeline (fail-open with logging)"
    - "Pipeline execution publishes events for observability"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/MoonshotOrchestrator.cs"
      provides: "MoonshotOrchestrator implementing IMoonshotOrchestrator"
      min_lines: 150
    - path: "Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/MoonshotPipelineStages.cs"
      provides: "10 IMoonshotPipelineStage implementations, one per moonshot"
      min_lines: 300
    - path: "Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/DefaultPipelineDefinition.cs"
      provides: "Standard ingest-to-lifecycle pipeline ordering"
      min_lines: 60
    - path: "Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/MoonshotRegistryImpl.cs"
      provides: "In-memory IMoonshotRegistry implementation with ConcurrentDictionary"
      min_lines: 80
  key_links:
    - from: "MoonshotOrchestrator"
      to: "IMoonshotOrchestrator"
      via: "implements SDK contract"
      pattern: "class MoonshotOrchestrator : IMoonshotOrchestrator"
    - from: "MoonshotPipelineStages"
      to: "IMessageBus"
      via: "each stage publishes/requests via message bus topics"
      pattern: "MessageBus\\.RequestAsync|MessageBus\\.PublishAsync"
    - from: "DefaultPipelineDefinition"
      to: "MoonshotPipelineTypes"
      via: "defines stage execution order using MoonshotId"
      pattern: "MoonshotId\\."
---

<objective>
Implement the cross-moonshot orchestration pipeline that wires all 10 moonshots into end-to-end data flows.

Purpose: This is the core value of Phase 64 -- connecting independently-built moonshot features into a coherent system. When data is ingested, it flows through consciousness scoring, tag attachment, compliance passport issuance, sovereignty checking, placement optimization, sync configuration, and lifecycle tiering in a defined order.

Output: Pipeline orchestrator, 10 stage adapters, default pipeline definition, and in-memory registry -- all in UltimateDataGovernance plugin (the natural owner of cross-cutting governance orchestration).
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/PLUGIN-CATALOG.md
@.planning/phases/64-moonshot-wiring/64-01-SUMMARY.md
@DataWarehouse.SDK/Moonshots/IMoonshotOrchestrator.cs
@DataWarehouse.SDK/Moonshots/MoonshotPipelineTypes.cs
@DataWarehouse.SDK/Moonshots/MoonshotRegistry.cs
@DataWarehouse.SDK/MessageBus/IMessageBus.cs
@Plugins/DataWarehouse.Plugins.UltimateDataGovernance/UltimateDataGovernancePlugin.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: MoonshotOrchestrator, registry, and default pipeline</name>
  <files>Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/MoonshotOrchestrator.cs, Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/DefaultPipelineDefinition.cs, Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/MoonshotRegistryImpl.cs</files>
  <action>
Create `Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/` directory.

**MoonshotRegistryImpl.cs** -- `MoonshotRegistryImpl : IMoonshotRegistry`:
- Internal `ConcurrentDictionary<MoonshotId, MoonshotRegistration>` for thread-safe storage
- `Register()` adds or updates entry
- `UpdateStatus()` fires `StatusChanged` event
- `UpdateHealthReport()` updates last health report and last health check timestamp
- All public methods are thread-safe

**DefaultPipelineDefinition.cs** -- `DefaultPipelineDefinition`:
- `static MoonshotPipelineDefinition IngestToLifecycle` property returns the standard pipeline:
  1. DataConsciousness (score the data first -- value/liability determines everything else)
  2. UniversalTags (attach tags based on consciousness score + content analysis)
  3. CompliancePassports (issue passport using tags for regulation matching)
  4. SovereigntyMesh (check sovereignty zone constraints using passport)
  5. ZeroGravityStorage (compute placement using tags, passport, sovereignty)
  6. CryptoTimeLocks (apply time-lock policy based on compliance requirements)
  7. SemanticSync (configure sync fidelity based on consciousness score)
  8. ChaosVaccination (register object in chaos vaccination scope if applicable)
  9. CarbonAwareLifecycle (assign lifecycle tier based on consciousness + carbon budget)
  10. UniversalFabric (register in dw:// namespace for universal addressing)
- All 10 moonshots enabled by default in the feature flags

**MoonshotOrchestrator.cs** -- `MoonshotOrchestrator : IMoonshotOrchestrator`:
- Constructor: `(IMoonshotRegistry registry, MoonshotConfiguration configuration, ILogger<MoonshotOrchestrator> logger)`
- Internal `Dictionary<MoonshotId, IMoonshotPipelineStage>` for registered stages
- `RegisterStage(stage)` -- adds stage to internal dictionary
- `ExecutePipelineAsync(context, pipeline, ct)`:
  1. For each MoonshotId in `pipeline.StageOrder`:
     a. Check if stage registered. If not, log warning and skip.
     b. Check if moonshot enabled in configuration. If disabled, log info and skip.
     c. Check `CanExecuteAsync` precondition. If false, log info and skip.
     d. Try `ExecuteAsync` with a `Stopwatch` for duration.
     e. On success: add `MoonshotStageResult` to context.
     f. On exception: log error, add failed `MoonshotStageResult`, continue (fail-open).
     g. Publish `moonshot.pipeline.stage.completed` bus topic with stage result.
  2. After all stages: build and return `MoonshotPipelineResult`.
  3. Publish `moonshot.pipeline.completed` bus topic with full result.
- `ExecuteDefaultPipelineAsync(context, ct)` -- calls `ExecutePipelineAsync` with `DefaultPipelineDefinition.IngestToLifecycle`
- `GetRegisteredStages()` -- returns keys of registered stages

All bus communication via `IMessageBus` (injected into context). Plugin references ONLY SDK.
  </action>
  <verify>`dotnet build Plugins/DataWarehouse.Plugins.UltimateDataGovernance/DataWarehouse.Plugins.UltimateDataGovernance.csproj` -- zero errors.</verify>
  <done>MoonshotOrchestrator executes 10-stage pipeline in defined order, skipping disabled moonshots, handling failures gracefully.</done>
</task>

<task type="auto">
  <name>Task 2: Pipeline stage adapters for all 10 moonshots</name>
  <files>Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/MoonshotPipelineStages.cs</files>
  <action>
Create 10 `IMoonshotPipelineStage` implementations in a single file. Each stage delegates to its moonshot's bus topics -- NO direct plugin references. Each stage:
- Reads relevant data from `MoonshotPipelineContext.Properties`
- Sends request via `context.MessageBus.RequestAsync` to the appropriate bus topic
- Writes results back into `context.Properties` for downstream stages to consume

**1. DataConsciousnessStage** (MoonshotId.DataConsciousness):
- CanExecute: always true (no preconditions)
- Execute: Request `consciousness.score` with objectId. Write result as `ConsciousnessScore` property.

**2. UniversalTagsStage** (MoonshotId.UniversalTags):
- CanExecute: true
- Execute: If ConsciousnessScore in context, include in tag suggestion. Request `tags.auto.attach` with objectId + metadata. Write result as `AttachedTags` property.

**3. CompliancePassportsStage** (MoonshotId.CompliancePassports):
- CanExecute: true
- Execute: Request `compliance.passport.issue` with objectId + tags (from context). Write result as `CompliancePassport` property.

**4. SovereigntyMeshStage** (MoonshotId.SovereigntyMesh):
- CanExecute: CompliancePassport in context
- Execute: Request `sovereignty.zone.check` with objectId + passport. Write result as `SovereigntyDecision` property.

**5. ZeroGravityStorageStage** (MoonshotId.ZeroGravityStorage):
- CanExecute: true
- Execute: Request `storage.placement.compute` with objectId + tags + sovereignty constraints. Write result as `PlacementDecision` property.

**6. CryptoTimeLocksStage** (MoonshotId.CryptoTimeLocks):
- CanExecute: true
- Execute: If CompliancePassport requires retention, request `tamperproof.timelock.apply` with objectId + lock duration. Write result as `TimeLockResult` property.

**7. SemanticSyncStage** (MoonshotId.SemanticSync):
- CanExecute: true
- Execute: Request `semanticsync.classify` with objectId + consciousness score. Write result as `SyncFidelityLevel` property.

**8. ChaosVaccinationStage** (MoonshotId.ChaosVaccination):
- CanExecute: true
- Execute: Request `chaos.vaccination.register` with objectId to register in vaccination scope. Write result as `VaccinationRegistered` boolean property.

**9. CarbonAwareLifecycleStage** (MoonshotId.CarbonAwareLifecycle):
- CanExecute: true
- Execute: Request `carbon.lifecycle.assign` with objectId + consciousness score + placement. Write result as `LifecycleTier` property.

**10. UniversalFabricStage** (MoonshotId.UniversalFabric):
- CanExecute: true
- Execute: Request `fabric.namespace.register` with objectId + placement. Write result as `DwAddress` property.

Each stage wraps bus calls in try/catch. If bus call fails (moonshot plugin not loaded), return failed MoonshotStageResult with descriptive error. ALL bus topic strings should be `const` fields at the top of the class for easy maintenance.
  </action>
  <verify>`dotnet build Plugins/DataWarehouse.Plugins.UltimateDataGovernance/DataWarehouse.Plugins.UltimateDataGovernance.csproj` -- zero errors. File contains 10 classes each implementing IMoonshotPipelineStage.</verify>
  <done>All 10 pipeline stages delegate to moonshot bus topics. Each stage reads from context, calls bus, writes results for downstream stages.</done>
</task>

</tasks>

<verification>
- `dotnet build Plugins/DataWarehouse.Plugins.UltimateDataGovernance/DataWarehouse.Plugins.UltimateDataGovernance.csproj` -- zero errors
- All 4 files exist in the Moonshots/ subdirectory
- MoonshotOrchestrator registers and executes all 10 stages
- All inter-stage data passes through MoonshotPipelineContext properties (no direct coupling)
</verification>

<success_criteria>
Data ingest triggers the full moonshot pipeline. Each stage communicates via message bus. Disabled moonshots are skipped. Failures are captured without halting the pipeline.
</success_criteria>

<output>
After completion, create `.planning/phases/64-moonshot-wiring/64-03-SUMMARY.md`
</output>
