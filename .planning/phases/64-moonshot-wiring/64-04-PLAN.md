---
phase: 64-moonshot-wiring
plan: 04
type: execute
wave: 2
depends_on: ["64-01"]
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/HealthProbes/TagsHealthProbe.cs
  - Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/HealthProbes/ConsciousnessHealthProbe.cs
  - Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/HealthProbes/ComplianceHealthProbe.cs
  - Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/HealthProbes/SovereigntyHealthProbe.cs
  - Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/HealthProbes/PlacementHealthProbe.cs
  - Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/HealthProbes/TimeLockHealthProbe.cs
  - Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/HealthProbes/SemanticSyncHealthProbe.cs
  - Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/HealthProbes/ChaosHealthProbe.cs
  - Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/HealthProbes/CarbonHealthProbe.cs
  - Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/HealthProbes/FabricHealthProbe.cs
  - Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/HealthProbes/MoonshotHealthAggregator.cs
autonomous: true

must_haves:
  truths:
    - "Each of the 10 moonshots has an independent health probe"
    - "Health probes check moonshot readiness via message bus ping"
    - "Health aggregator collects all 10 probes into a single report"
    - "Probes detect: plugin loaded, bus responsive, strategy registered, config valid"
    - "Degraded vs Faulted distinction: degraded = partial capability, faulted = no capability"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/HealthProbes/MoonshotHealthAggregator.cs"
      provides: "Aggregates all 10 health probes into unified report"
      min_lines: 80
    - path: "Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/HealthProbes/TagsHealthProbe.cs"
      provides: "Health probe for Universal Tags moonshot"
      min_lines: 40
  key_links:
    - from: "MoonshotHealthAggregator"
      to: "IMoonshotHealthProbe"
      via: "iterates all registered probes"
      pattern: "IMoonshotHealthProbe"
    - from: "Each health probe"
      to: "IMessageBus"
      via: "sends health ping via bus topic"
      pattern: "MessageBus\\.RequestAsync"
---

<objective>
Implement independent health/readiness probes for each of the 10 moonshot features, plus an aggregator.

Purpose: Each moonshot must be independently monitorable. Health probes verify that the moonshot's plugin is loaded, its bus topics are responsive, required strategies are registered, and configuration is valid. The aggregator provides a single endpoint for the dashboard.

Output: 10 health probes + 1 aggregator in the HealthProbes/ subdirectory.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/PLUGIN-CATALOG.md
@.planning/phases/64-moonshot-wiring/64-01-SUMMARY.md
@DataWarehouse.SDK/Moonshots/IMoonshotHealthProbe.cs
@DataWarehouse.SDK/Moonshots/MoonshotPipelineTypes.cs
@DataWarehouse.SDK/MessageBus/IMessageBus.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: 10 moonshot health probes</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/HealthProbes/TagsHealthProbe.cs,
    Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/HealthProbes/ConsciousnessHealthProbe.cs,
    Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/HealthProbes/ComplianceHealthProbe.cs,
    Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/HealthProbes/SovereigntyHealthProbe.cs,
    Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/HealthProbes/PlacementHealthProbe.cs,
    Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/HealthProbes/TimeLockHealthProbe.cs,
    Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/HealthProbes/SemanticSyncHealthProbe.cs,
    Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/HealthProbes/ChaosHealthProbe.cs,
    Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/HealthProbes/CarbonHealthProbe.cs,
    Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/HealthProbes/FabricHealthProbe.cs
  </files>
  <action>
Create `Moonshots/HealthProbes/` directory. Each health probe implements `IMoonshotHealthProbe` with a common pattern:

Each probe constructor takes `(IMessageBus messageBus, MoonshotConfiguration config, ILogger logger)`.

Common health check logic (extract into a private helper method or base pattern):
1. **Plugin Check**: Send a bus ping to the moonshot's health topic (e.g., `tags.health.ping`). If response within 5s, plugin is loaded. If timeout, mark component as NotReady.
2. **Strategy Check**: Request strategy list from bus topic (e.g., `tags.strategies.list`). If at least 1 strategy registered, mark Ready. If zero, mark Degraded.
3. **Config Check**: Validate this moonshot's MoonshotFeatureConfig from configuration. If valid, Ready. If disabled, NotReady with reason.
4. **Bus Check**: Verify the primary bus topic is responsive (e.g., send echo request to `tags.echo`).

Per-moonshot specifics:

1. **TagsHealthProbe** (MoonshotId.UniversalTags): ping `tags.health.ping`, check `tags.schema.list` returns at least the default schema, check `tags.index.status` for index readiness. HealthCheckInterval: 30s.

2. **ConsciousnessHealthProbe** (MoonshotId.DataConsciousness): ping `consciousness.health.ping`, check `consciousness.scorers.list` for at least value + liability scorers. HealthCheckInterval: 60s.

3. **ComplianceHealthProbe** (MoonshotId.CompliancePassports): ping `compliance.passport.health.ping`, check `compliance.regulations.list` for loaded regulations. HealthCheckInterval: 60s.

4. **SovereigntyHealthProbe** (MoonshotId.SovereigntyMesh): ping `sovereignty.health.ping`, check `sovereignty.zones.list` for configured zones. Mark Degraded if 0 zones configured (sovereignty without zones is useless). HealthCheckInterval: 60s.

5. **PlacementHealthProbe** (MoonshotId.ZeroGravityStorage): ping `storage.placement.health.ping`, check `storage.nodes.list` for available storage nodes. Mark Degraded if <3 nodes (CRUSH needs distribution). HealthCheckInterval: 30s.

6. **TimeLockHealthProbe** (MoonshotId.CryptoTimeLocks): ping `tamperproof.timelock.health.ping`, check `tamperproof.timelock.providers.list` for at least one provider. HealthCheckInterval: 60s.

7. **SemanticSyncHealthProbe** (MoonshotId.SemanticSync): ping `semanticsync.health.ping`, check `semanticsync.classifiers.list` for at least one classifier. HealthCheckInterval: 60s.

8. **ChaosHealthProbe** (MoonshotId.ChaosVaccination): ping `chaos.health.ping`, check `chaos.schedule.status` for vaccination schedule state. HealthCheckInterval: 120s (chaos runs infrequently).

9. **CarbonHealthProbe** (MoonshotId.CarbonAwareLifecycle): ping `carbon.health.ping`, check `carbon.intensity.current` for carbon data availability. Mark Degraded if carbon intensity data is stale (>1 hour old). HealthCheckInterval: 300s.

10. **FabricHealthProbe** (MoonshotId.UniversalFabric): ping `fabric.health.ping`, check `fabric.namespace.status` for dw:// resolver readiness. HealthCheckInterval: 30s.

Each probe returns `MoonshotHealthReport` with components map: `{"Plugin": ..., "Strategy": ..., "Config": ..., "Bus": ...}`. Overall Readiness: Ready if all components Ready, Degraded if any Degraded, NotReady if any critical component NotReady.

All bus requests use 5-second timeout. Timeout = component NotReady.
  </action>
  <verify>`dotnet build Plugins/DataWarehouse.Plugins.UltimateDataGovernance/DataWarehouse.Plugins.UltimateDataGovernance.csproj` -- zero errors. All 10 probe files exist.</verify>
  <done>Each moonshot has an independent health probe checking plugin, strategy, config, and bus responsiveness.</done>
</task>

<task type="auto">
  <name>Task 2: Health aggregator</name>
  <files>Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Moonshots/HealthProbes/MoonshotHealthAggregator.cs</files>
  <action>
**MoonshotHealthAggregator.cs**:
- Constructor: `(IEnumerable<IMoonshotHealthProbe> probes, IMoonshotRegistry registry, ILogger<MoonshotHealthAggregator> logger)`
- Stores probes in `IReadOnlyDictionary<MoonshotId, IMoonshotHealthProbe>`
- `async Task<IReadOnlyList<MoonshotHealthReport>> CheckAllAsync(CancellationToken ct)`:
  1. Run all 10 probes in parallel using `Task.WhenAll` (independent -- no dependency between probes)
  2. Collect all 10 `MoonshotHealthReport` results
  3. Update `IMoonshotRegistry` with each report via `UpdateHealthReport`
  4. Update registry status: Ready->MoonshotStatus.Ready, Degraded->MoonshotStatus.Degraded, NotReady->MoonshotStatus.Faulted
  5. Return all reports
  6. Log summary: "{readyCount}/10 moonshots ready, {degradedCount} degraded, {faultedCount} faulted"
- `async Task RunPeriodicHealthChecksAsync(CancellationToken ct)`:
  1. Loop until cancellation
  2. For each probe, check if enough time has passed since last check (based on probe.HealthCheckInterval)
  3. Run due probes in parallel
  4. Update registry
  5. Await shortest remaining interval
  </action>
  <verify>`dotnet build Plugins/DataWarehouse.Plugins.UltimateDataGovernance/DataWarehouse.Plugins.UltimateDataGovernance.csproj` -- zero errors.</verify>
  <done>Aggregator runs all 10 probes in parallel, updates registry, supports periodic background health checks.</done>
</task>

</tasks>

<verification>
- `dotnet build Plugins/DataWarehouse.Plugins.UltimateDataGovernance/DataWarehouse.Plugins.UltimateDataGovernance.csproj` -- zero errors
- 11 files exist in HealthProbes/
- Each probe implements IMoonshotHealthProbe with correct MoonshotId
- Aggregator runs all probes in parallel
</verification>

<success_criteria>
All 10 moonshots have independent health probes. Aggregator provides unified health status. Registry is updated with health reports.
</success_criteria>

<output>
After completion, create `.planning/phases/64-moonshot-wiring/64-04-SUMMARY.md`
</output>
