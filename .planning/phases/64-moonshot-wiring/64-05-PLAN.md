---
phase: 64-moonshot-wiring
plan: 05
type: execute
wave: 3
depends_on: ["64-03", "64-04"]
files_modified:
  - Plugins/DataWarehouse.Plugins.UniversalDashboards/Moonshots/MoonshotDashboardProvider.cs
  - Plugins/DataWarehouse.Plugins.UniversalDashboards/Moonshots/MoonshotMetricsCollector.cs
  - Plugins/DataWarehouse.Plugins.UniversalDashboards/Moonshots/MoonshotDashboardStrategy.cs
autonomous: true

must_haves:
  truths:
    - "Unified dashboard shows all 10 moonshot statuses, metrics, and health in one view"
    - "Metrics collector subscribes to pipeline completion events for real-time metrics"
    - "Dashboard strategy integrates with existing UniversalDashboards plugin patterns"
    - "Trend data is available for latency, throughput, and success rate per moonshot"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UniversalDashboards/Moonshots/MoonshotDashboardProvider.cs"
      provides: "IMoonshotDashboardProvider implementation"
      min_lines: 120
    - path: "Plugins/DataWarehouse.Plugins.UniversalDashboards/Moonshots/MoonshotMetricsCollector.cs"
      provides: "Subscribes to bus events and aggregates moonshot metrics"
      min_lines: 100
    - path: "Plugins/DataWarehouse.Plugins.UniversalDashboards/Moonshots/MoonshotDashboardStrategy.cs"
      provides: "Dashboard strategy for rendering moonshot overview"
      min_lines: 80
  key_links:
    - from: "MoonshotDashboardProvider"
      to: "IMoonshotDashboardProvider"
      via: "implements SDK contract"
      pattern: "class MoonshotDashboardProvider : IMoonshotDashboardProvider"
    - from: "MoonshotMetricsCollector"
      to: "IMessageBus"
      via: "subscribes to moonshot.pipeline.stage.completed and moonshot.pipeline.completed"
      pattern: "SubscribeAsync.*moonshot\\.pipeline"
    - from: "MoonshotDashboardStrategy"
      to: "MoonshotDashboardProvider"
      via: "reads snapshot for rendering"
      pattern: "GetSnapshotAsync"
---

<objective>
Implement the unified moonshot dashboard: metrics collection, trend tracking, and dashboard strategy for rendering.

Purpose: Operators need a single view showing all 10 moonshot features -- their status (Ready/Degraded/Faulted), throughput, latency, success rates, and trends over time. This plan wires the metrics collection to pipeline events and provides the dashboard data layer.

Output: Dashboard provider, metrics collector, and dashboard strategy in UniversalDashboards plugin.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/PLUGIN-CATALOG.md
@.planning/phases/64-moonshot-wiring/64-03-SUMMARY.md
@.planning/phases/64-moonshot-wiring/64-04-SUMMARY.md
@DataWarehouse.SDK/Moonshots/MoonshotDashboardTypes.cs
@DataWarehouse.SDK/Moonshots/MoonshotRegistry.cs
@DataWarehouse.SDK/Moonshots/IMoonshotHealthProbe.cs
@Plugins/DataWarehouse.Plugins.UniversalDashboards/UniversalDashboardsPlugin.cs
@Plugins/DataWarehouse.Plugins.UniversalDashboards/Strategies/Export/ExportStrategies.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Metrics collector with bus event subscription</name>
  <files>Plugins/DataWarehouse.Plugins.UniversalDashboards/Moonshots/MoonshotMetricsCollector.cs</files>
  <action>
Create `Plugins/DataWarehouse.Plugins.UniversalDashboards/Moonshots/` directory.

**MoonshotMetricsCollector.cs**:
- Constructor: `(IMessageBus messageBus, ILogger<MoonshotMetricsCollector> logger)`
- Internal state per moonshot (keyed by `MoonshotId`):
  - `long TotalInvocations` (Interlocked.Increment for thread safety)
  - `long SuccessCount`
  - `long FailureCount`
  - Rolling window of latency samples (`ConcurrentQueue<double>` with max 1000 entries)
  - `DateTimeOffset WindowStart` (reset every 5 minutes)
- `Task StartCollectingAsync(CancellationToken ct)`:
  1. Subscribe to `moonshot.pipeline.stage.completed` bus topic
  2. On each event, deserialize `MoonshotStageResult`
  3. Update per-moonshot counters: increment TotalInvocations, increment SuccessCount or FailureCount, add latency sample
  4. Subscribe to `moonshot.pipeline.completed` for aggregate pipeline metrics
- `MoonshotMetrics GetMetrics(MoonshotId id)`:
  1. Read counters for this moonshot
  2. Compute AverageLatencyMs from rolling window
  3. Compute P99LatencyMs from sorted rolling window (99th percentile)
  4. Return MoonshotMetrics record
- `IReadOnlyList<MoonshotMetrics> GetAllMetrics()` -- returns metrics for all 10 moonshots
- Internal trend buffer: `ConcurrentDictionary<(MoonshotId, string), ConcurrentQueue<MoonshotTrendPoint>>` with max 1440 points per metric (24 hours at 1-minute resolution). Supported metric names: "latency_ms", "throughput_per_min", "success_rate".
- `IReadOnlyList<MoonshotTrendPoint> GetTrends(MoonshotId id, string metricName, DateTimeOffset from, DateTimeOffset to)` -- filter trend buffer by time range
- Every 60 seconds, snapshot current metrics into trend buffer (background timer)

All collections bounded per MEM-03. Use `Interlocked` for counters, `ConcurrentQueue` for samples.
  </action>
  <verify>`dotnet build Plugins/DataWarehouse.Plugins.UniversalDashboards/DataWarehouse.Plugins.UniversalDashboards.csproj` -- zero errors.</verify>
  <done>Metrics collector subscribes to pipeline events and maintains per-moonshot counters, latency percentiles, and trend data.</done>
</task>

<task type="auto">
  <name>Task 2: Dashboard provider and rendering strategy</name>
  <files>Plugins/DataWarehouse.Plugins.UniversalDashboards/Moonshots/MoonshotDashboardProvider.cs, Plugins/DataWarehouse.Plugins.UniversalDashboards/Moonshots/MoonshotDashboardStrategy.cs</files>
  <action>
**MoonshotDashboardProvider.cs** -- `MoonshotDashboardProvider : IMoonshotDashboardProvider`:
- Constructor: `(IMoonshotRegistry registry, MoonshotMetricsCollector metricsCollector, ILogger<MoonshotDashboardProvider> logger)`
- `async Task<MoonshotDashboardSnapshot> GetSnapshotAsync(CancellationToken ct)`:
  1. Get all registrations from `registry.GetAll()`
  2. Get all metrics from `metricsCollector.GetAllMetrics()`
  3. Get latest health reports from each registration's `LastHealthReport`
  4. Compute summary counts: TotalMoonshots, ReadyCount, DegradedCount, FaultedCount
  5. Return `MoonshotDashboardSnapshot`
- `async Task<IReadOnlyList<MoonshotTrendPoint>> GetTrendsAsync(MoonshotId id, string metricName, DateTimeOffset from, DateTimeOffset to, CancellationToken ct)`:
  - Delegate to `metricsCollector.GetTrends`
- `async Task<MoonshotMetrics> GetMetricsAsync(MoonshotId id, CancellationToken ct)`:
  - Delegate to `metricsCollector.GetMetrics`

**MoonshotDashboardStrategy.cs** -- Follow existing dashboard strategy patterns in UniversalDashboards:
- Class: `MoonshotDashboardStrategy` extending appropriate dashboard strategy base (check existing patterns in the plugin)
- Strategy metadata: Name = "MoonshotOverview", Description = "Unified view of all 10 moonshot features", Category = "Moonshots"
- `async Task<DashboardRenderResult> RenderAsync(DashboardRenderContext context, CancellationToken ct)`:
  1. Get snapshot from MoonshotDashboardProvider
  2. Build dashboard panels:
     a. **Status Grid**: 10 cards, one per moonshot -- MoonshotId, status (color-coded: green=Ready, yellow=Degraded, red=Faulted), last health check time
     b. **Metrics Table**: 10 rows -- MoonshotId, TotalInvocations, SuccessRate%, AvgLatencyMs, P99LatencyMs
     c. **Pipeline Flow**: Visual representation of the 10-stage pipeline with stage-level success/failure counts
     d. **Health Summary**: ReadyCount/TotalMoonshots, list of degraded/faulted moonshots with reasons
  3. Return as structured dashboard data (follow existing rendering patterns -- likely JSON/dictionary based)

Register strategy in plugin's strategy collection following existing patterns.
  </action>
  <verify>`dotnet build Plugins/DataWarehouse.Plugins.UniversalDashboards/DataWarehouse.Plugins.UniversalDashboards.csproj` -- zero errors.</verify>
  <done>Dashboard shows status grid, metrics table, pipeline flow, and health summary for all 10 moonshots.</done>
</task>

</tasks>

<verification>
- `dotnet build Plugins/DataWarehouse.Plugins.UniversalDashboards/DataWarehouse.Plugins.UniversalDashboards.csproj` -- zero errors
- 3 files exist in Moonshots/
- MoonshotDashboardProvider returns snapshot with all 10 moonshots
- MoonshotMetricsCollector tracks latency, throughput, success rate
</verification>

<success_criteria>
Unified moonshot dashboard provides real-time status, metrics, trends, and health for all 10 moonshot features.
</success_criteria>

<output>
After completion, create `.planning/phases/64-moonshot-wiring/64-05-SUMMARY.md`
</output>
