---
phase: 64-moonshot-wiring
plan: 07
type: execute
wave: 4
depends_on: ["64-03", "64-04", "64-05", "64-06"]
files_modified:
  - Tests/DataWarehouse.Tests/Moonshots/MoonshotPipelineTests.cs
  - Tests/DataWarehouse.Tests/Moonshots/MoonshotConfigurationTests.cs
  - Tests/DataWarehouse.Tests/Moonshots/MoonshotHealthProbeTests.cs
  - Tests/DataWarehouse.Tests/Moonshots/CrossMoonshotWiringTests.cs
autonomous: true

must_haves:
  truths:
    - "10 end-to-end tests exist, one validating each moonshot's pipeline stage"
    - "Configuration validation tests cover dependency chains and override policies"
    - "Health probe tests verify Ready/Degraded/Faulted detection"
    - "Cross-moonshot wiring tests verify event propagation between moonshot pairs"
    - "All tests pass with zero failures"
  artifacts:
    - path: "Tests/DataWarehouse.Tests/Moonshots/MoonshotPipelineTests.cs"
      provides: "10 end-to-end pipeline stage tests + full pipeline test"
      min_lines: 250
    - path: "Tests/DataWarehouse.Tests/Moonshots/MoonshotConfigurationTests.cs"
      provides: "Configuration validation, hierarchy merge, override policy tests"
      min_lines: 150
    - path: "Tests/DataWarehouse.Tests/Moonshots/MoonshotHealthProbeTests.cs"
      provides: "Health probe status detection tests"
      min_lines: 100
    - path: "Tests/DataWarehouse.Tests/Moonshots/CrossMoonshotWiringTests.cs"
      provides: "Cross-moonshot event propagation tests"
      min_lines: 150
  key_links:
    - from: "MoonshotPipelineTests"
      to: "MoonshotOrchestrator"
      via: "tests exercise full pipeline execution"
      pattern: "ExecuteDefaultPipelineAsync|ExecutePipelineAsync"
    - from: "MoonshotConfigurationTests"
      to: "MoonshotConfigurationValidator"
      via: "tests verify validation rules"
      pattern: "Validate|DEP_MISSING|OVERRIDE_VIOLATION"
---

<objective>
Write integration tests for the entire moonshot wiring system: pipeline execution, configuration, health probes, and cross-moonshot interactions.

Purpose: 10 end-to-end tests (one per moonshot) prove each moonshot integrates correctly into the pipeline. Additional tests cover configuration validation, health probes, and cross-moonshot event wiring. This is the final verification gate for Phase 64.

Output: 4 test files covering all moonshot wiring scenarios.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/64-moonshot-wiring/64-03-SUMMARY.md
@.planning/phases/64-moonshot-wiring/64-04-SUMMARY.md
@.planning/phases/64-moonshot-wiring/64-05-SUMMARY.md
@.planning/phases/64-moonshot-wiring/64-06-SUMMARY.md
@DataWarehouse.SDK/Moonshots/IMoonshotOrchestrator.cs
@DataWarehouse.SDK/Moonshots/MoonshotPipelineTypes.cs
@DataWarehouse.SDK/Moonshots/MoonshotConfiguration.cs
@DataWarehouse.SDK/Moonshots/IMoonshotHealthProbe.cs
@Tests/DataWarehouse.Tests/DataWarehouse.Tests.csproj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pipeline and configuration tests</name>
  <files>Tests/DataWarehouse.Tests/Moonshots/MoonshotPipelineTests.cs, Tests/DataWarehouse.Tests/Moonshots/MoonshotConfigurationTests.cs</files>
  <action>
Create `Tests/DataWarehouse.Tests/Moonshots/` directory.

**MoonshotPipelineTests.cs** -- Using xUnit (match existing test patterns):

```
[Fact] MoonshotPipeline_ExecuteDefaultPipeline_RunsAllStagesInOrder
```
- Create MoonshotOrchestrator with all 10 mock stages (each records call order)
- Execute default pipeline
- Assert: all 10 stages called in defined order (Consciousness first, Fabric last)
- Assert: MoonshotPipelineResult.AllSucceeded == true
- Assert: 10 stage results returned

```
[Fact] MoonshotPipeline_DisabledMoonshot_SkipsStage
```
- Create config with DataConsciousness disabled
- Execute pipeline
- Assert: only 9 stages executed (DataConsciousness skipped)
- Assert: pipeline still succeeds

```
[Fact] MoonshotPipeline_StageFailure_ContinuesRemaining
```
- Create mock ConsciousnessStage that throws exception
- Execute pipeline
- Assert: ConsciousnessStage marked as failed in results
- Assert: remaining 9 stages still executed (fail-open)
- Assert: MoonshotPipelineResult.AllSucceeded == false

```
[Fact] MoonshotPipeline_ContextFlowsData_BetweenStages
```
- Create ConsciousnessStage that writes "ConsciousnessScore" = 85 to context
- Create TagsStage that reads "ConsciousnessScore" from context
- Execute pipeline
- Assert: TagsStage received score of 85

Then 10 individual stage tests (one per moonshot):
```
[Theory]
[InlineData(MoonshotId.UniversalTags)]
[InlineData(MoonshotId.DataConsciousness)]
[InlineData(MoonshotId.CompliancePassports)]
[InlineData(MoonshotId.SovereigntyMesh)]
[InlineData(MoonshotId.ZeroGravityStorage)]
[InlineData(MoonshotId.CryptoTimeLocks)]
[InlineData(MoonshotId.SemanticSync)]
[InlineData(MoonshotId.ChaosVaccination)]
[InlineData(MoonshotId.CarbonAwareLifecycle)]
[InlineData(MoonshotId.UniversalFabric)]
public void MoonshotStage_Executes_ReturnsResult(MoonshotId id)
```
- Create the specific stage with mock IMessageBus
- Execute with context containing required properties
- Assert: returns MoonshotStageResult with correct Id and Success

**MoonshotConfigurationTests.cs**:

```
[Fact] ProductionDefaults_AllMoonshotsEnabled
```
- Assert `CreateProductionDefaults()` returns 10 enabled moonshots

```
[Fact] MergeConfig_LockedMoonshot_ParentWins
```
- Parent: CompliancePassports Locked + Enabled
- Child (User): CompliancePassports Enabled = false
- Merge: Assert CompliancePassports still Enabled (Locked overrides user)

```
[Fact] MergeConfig_UserOverridable_ChildWins
```
- Parent: UniversalTags UserOverridable + Enabled
- Child (User): UniversalTags Enabled = false
- Merge: Assert UniversalTags Disabled (user allowed to override)

```
[Fact] MergeConfig_TenantOverridable_TenantCanOverride
```
- Parent: ChaosVaccination TenantOverridable
- Child at Tenant level: ChaosVaccination disabled
- Merge: Assert disabled

```
[Fact] MergeConfig_TenantOverridable_UserCannotOverride
```
- Parent: ChaosVaccination TenantOverridable, Tenant leaves enabled
- Child at User level: ChaosVaccination disabled
- Merge: Assert still enabled (User cannot override TenantOverridable)

```
[Fact] Validator_DependencyViolation_ReportsError
```
- Config: SovereigntyMesh enabled, CompliancePassports disabled
- Validate: Assert error code "DEP_MISSING"

```
[Fact] Validator_ValidConfig_NoErrors
```
- Use production defaults
- Validate: Assert IsValid == true, zero errors

```
[Fact] Validator_InvalidBlastRadius_ReportsError
```
- Config: ChaosVaccination MaxBlastRadius = "200"
- Validate: Assert error code "INVALID_RANGE"

Use NullMessageBus (from SDK) for bus mocking. Follow existing test patterns in the test project.
  </action>
  <verify>`dotnet test Tests/DataWarehouse.Tests/ --filter "FullyQualifiedName~Moonshots" --no-build` (after build) -- all tests pass.</verify>
  <done>14+ pipeline tests and 8+ configuration tests pass with zero failures.</done>
</task>

<task type="auto">
  <name>Task 2: Health probe and cross-wiring tests</name>
  <files>Tests/DataWarehouse.Tests/Moonshots/MoonshotHealthProbeTests.cs, Tests/DataWarehouse.Tests/Moonshots/CrossMoonshotWiringTests.cs</files>
  <action>
**MoonshotHealthProbeTests.cs**:

```
[Fact] HealthAggregator_AllProbesReady_ReturnsAllReady
```
- Create 10 mock probes that all return Ready
- Run aggregator.CheckAllAsync
- Assert: 10 reports, all Ready

```
[Fact] HealthAggregator_OneProbeNotReady_ReportsDegraded
```
- Create 9 Ready probes + 1 NotReady probe
- Run aggregator.CheckAllAsync
- Assert: 9 Ready + 1 NotReady

```
[Fact] HealthAggregator_UpdatesRegistry
```
- Create mock registry + mock probes
- Run aggregator.CheckAllAsync
- Assert: registry.UpdateHealthReport called 10 times

```
[Theory]
[InlineData(MoonshotId.UniversalTags)]
... (all 10)
public void HealthProbe_HasCorrectId(MoonshotId id)
```
- Create the probe
- Assert: probe.MoonshotId == id

```
[Fact] HealthProbe_BusTimeout_ReportsNotReady
```
- Create TagsHealthProbe with mock bus that always times out
- Run CheckHealthAsync
- Assert: Readiness == NotReady

**CrossMoonshotWiringTests.cs**:

```
[Fact] TagConsciousnessWiring_ScoreCompleted_AttachesTags
```
- Create TagConsciousnessWiring with mock bus
- Simulate `consciousness.score.completed` event with score=85
- Assert: `tags.system.attach` was called with consciousness tags

```
[Fact] ComplianceSovereigntyWiring_ZoneCheckCompleted_AddsEvidence
```
- Create wiring with mock bus
- Simulate `sovereignty.zone.check.completed`
- Assert: `compliance.passport.add-evidence` was called

```
[Fact] PlacementCarbonWiring_IntensityChanged_TriggersRecalculation
```
- Create wiring with mock bus
- Simulate `carbon.intensity.updated` with >20% delta
- Assert: `storage.placement.recalculate-batch` was published

```
[Fact] TimeLockComplianceWiring_PassportIssued_AppliesLock
```
- Create wiring with mock bus
- Simulate `compliance.passport.issued` with SOX regulation (7-year retention)
- Assert: `tamperproof.timelock.apply` was called with 7-year duration

```
[Fact] FabricPlacementWiring_PlacementCompleted_RegistersAddress
```
- Create wiring with mock bus
- Simulate `storage.placement.completed` with nodeId=node-1, objectId=obj-1
- Assert: `fabric.namespace.register` was called with `dw://node@node-1/obj-1`

```
[Fact] CrossMoonshotRegistrar_DisabledMoonshot_SkipsWiring
```
- Create config with CarbonAwareLifecycle disabled
- Create registrar
- RegisterAllAsync
- Assert: PlacementCarbonWiring NOT registered (one side disabled)

```
[Fact] CrossMoonshotRegistrar_AllEnabled_RegistersAllWirings
```
- Create production default config (all enabled)
- Create registrar
- RegisterAllAsync
- Assert: GetActiveWirings() returns 7 wirings

Use NullMessageBus or a simple in-memory mock bus that records calls. Follow xUnit patterns from existing test files.
  </action>
  <verify>`dotnet test Tests/DataWarehouse.Tests/ --filter "FullyQualifiedName~Moonshots" --no-build` -- all tests pass.</verify>
  <done>Health probe tests verify all status states. Cross-wiring tests verify event propagation and conditional registration. All tests pass.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.slnx` -- zero errors across entire solution
- `dotnet test Tests/DataWarehouse.Tests/ --filter "FullyQualifiedName~Moonshots"` -- all tests pass, zero failures
- 4 test files exist in Tests/DataWarehouse.Tests/Moonshots/
- At least 30 test methods covering pipeline, config, health, and wiring
</verification>

<success_criteria>
10 end-to-end moonshot pipeline tests pass. Configuration validation catches invalid configs. Health probes detect all status states. Cross-moonshot wiring tests verify event propagation. Zero test failures.
</success_criteria>

<output>
After completion, create `.planning/phases/64-moonshot-wiring/64-07-SUMMARY.md`
</output>
