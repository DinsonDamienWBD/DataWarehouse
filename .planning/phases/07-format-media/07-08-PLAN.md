---
phase: 07-format-media
plan: 08
type: execute
wave: 3
depends_on: []
files_modified:
  - Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/Image/JpegImageStrategy.cs
  - Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/Image/PngImageStrategy.cs
  - Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/Image/WebPImageStrategy.cs
  - Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/Image/AvifImageStrategy.cs
  - Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/RAW/Cr2RawStrategy.cs
  - Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/RAW/NefRawStrategy.cs
  - Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/RAW/ArwRawStrategy.cs
  - Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/RAW/DngRawStrategy.cs
  - Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/GPUTexture/DdsTextureStrategy.cs
  - Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/GPUTexture/KtxTextureStrategy.cs
  - Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/3D/GltfModelStrategy.cs
  - Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/3D/UsdModelStrategy.cs
  - Metadata/TODO.md
autonomous: true

must_haves:
  truths:
    - "Image strategies (JPEG, PNG, WebP, AVIF) process and convert image formats"
    - "RAW camera strategies (CR2, NEF, ARW, DNG) decode proprietary camera formats"
    - "GPU texture strategies (DDS, KTX) handle compressed GPU textures"
    - "3D model strategies (glTF, USD) process 3D asset formats"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/Image/JpegImageStrategy.cs"
      provides: "JPEG image processing with quality control"
      exports: ["JpegImageStrategy"]
    - path: "Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/RAW/Cr2RawStrategy.cs"
      provides: "Canon CR2 RAW image decoding"
      exports: ["Cr2RawStrategy"]
    - path: "Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/3D/GltfModelStrategy.cs"
      provides: "glTF 3D model format conversion"
      exports: ["GltfModelStrategy"]
  key_links:
    - from: "JpegImageStrategy"
      to: "SixLabors.ImageSharp"
      via: "library for image processing"
      pattern: "SixLabors\\.ImageSharp"
    - from: "GltfModelStrategy"
      to: "MediaStrategyBase"
      via: "inheritance with 3D model capabilities"
      pattern: "MediaType = MediaType\\.Model3D"
---

<objective>
Complete Transcoding.Media with image, RAW camera, GPU texture, and 3D model strategies (T118.B4-B7).

Purpose: Add remaining media format categories: image processing, camera RAW decoding, GPU textures for game engines, and 3D model formats.

Output: 12 production-ready media strategies completing Phase 7 media domain.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-format-media/07-RESEARCH.md
@DataWarehouse.SDK/Contracts/Media/IMediaStrategy.cs
@DataWarehouse.SDK/Contracts/Media/MediaStrategyBase.cs
@Plugins/DataWarehouse.Plugins.Transcoding.Media/MediaTranscodingPlugin.cs
@.planning/phases/07-format-media/07-07-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement image and RAW camera strategies</name>
  <files>
    Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/Image/JpegImageStrategy.cs
    Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/Image/PngImageStrategy.cs
    Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/Image/WebPImageStrategy.cs
    Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/Image/AvifImageStrategy.cs
    Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/RAW/Cr2RawStrategy.cs
    Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/RAW/NefRawStrategy.cs
    Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/RAW/ArwRawStrategy.cs
    Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/RAW/DngRawStrategy.cs
  </files>
  <action>
**Image Strategies (4):**

**JpegImageStrategy** (jpeg): JPEG lossy compression with quality 0-100, EXIF metadata preservation, progressive encoding. Use SixLabors.ImageSharp.

**PngImageStrategy** (png): PNG lossless compression with alpha channel support, compression levels 0-9. Use SixLabors.ImageSharp.

**WebPImageStrategy** (webp): Google WebP format (lossy/lossless) with better compression than JPEG. Use SixLabors.ImageSharp.

**AvifImageStrategy** (avif): AVIF next-gen format using AV1 compression, superior to WebP. Use SixLabors.ImageSharp.Formats.Avif.

**RAW Camera Strategies (4):**

**Cr2RawStrategy** (cr2): Canon CR2 RAW format with demosaicing, white balance, exposure adjustment. Stub - requires LibRaw or similar.

**NefRawStrategy** (nef): Nikon NEF RAW format. Stub - requires LibRaw.

**ArwRawStrategy** (arw): Sony ARW RAW format. Stub - requires LibRaw.

**DngRawStrategy** (dng): Adobe DNG (Digital Negative) universal RAW format. Stub - requires LibRaw or DNG SDK.

**Pattern for ImageSharp:**
```csharp
protected override async Task<Stream> TranscodeAsyncCore(
    Stream inputStream, TranscodeOptions options, CancellationToken ct)
{
    using var image = await Image.LoadAsync(inputStream, ct);

    // Apply transformations
    if (options.Width.HasValue || options.Height.HasValue)
        image.Mutate(x => x.Resize(options.Width ?? 0, options.Height ?? 0));

    var outputStream = new MemoryStream();
    await image.SaveAsJpegAsync(outputStream, new JpegEncoder
    {
        Quality = options.Quality ?? 85
    }, ct);

    outputStream.Position = 0;
    return outputStream;
}
```

**Research note:** Use SixLabors.ImageSharp (research don't-hand-roll: hardware-accelerated, memory-efficient). RAW formats require specialized libraries (LibRaw) - stubs acceptable.
  </action>
  <verify>
```bash
cd Plugins/DataWarehouse.Plugins.Transcoding.Media && dotnet build
ls Strategies/Image/*.cs | wc -l  # Expect: 4
ls Strategies/RAW/*.cs | wc -l    # Expect: 4

# Verify ImageSharp usage:
grep -r "SixLabors.ImageSharp" Strategies/Image/
```
  </verify>
  <done>
- [ ] 8 strategies implemented (4 image + 4 RAW)
- [ ] Image strategies use SixLabors.ImageSharp
- [ ] RAW strategies have format detection stubs
- [ ] Builds without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement GPU texture and 3D model strategies</name>
  <files>
    Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/GPUTexture/DdsTextureStrategy.cs
    Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/GPUTexture/KtxTextureStrategy.cs
    Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/3D/GltfModelStrategy.cs
    Plugins/DataWarehouse.Plugins.Transcoding.Media/Strategies/3D/UsdModelStrategy.cs
    Metadata/TODO.md
  </files>
  <action>
**GPU Texture Strategies (2):**

**DdsTextureStrategy** (dds): DirectDraw Surface format with BC1-BC7 compression, mipmap levels, cube maps. Stub - requires DDS library.

**KtxTextureStrategy** (ktx): Khronos Texture format (KTX2) for OpenGL/Vulkan with Basis Universal compression. Stub - requires KTX library.

**3D Model Strategies (2):**

**GltfModelStrategy** (gltf/glb): glTF 2.0 3D format (JSON + binary buffers) with PBR materials, animations, skinning. Parse JSON structure, extract meshes/textures.

**UsdModelStrategy** (usd/usda/usdc): Pixar USD (Universal Scene Description) for film/VFX pipelines. Stub - requires USD library.

**Pattern for glTF:**
```csharp
// glTF is JSON-based, parse with System.Text.Json
var gltf = await JsonSerializer.DeserializeAsync<GltfRoot>(inputStream, ct);

// Extract scene graph
foreach (var node in gltf.Nodes)
{
    // Process meshes, materials, textures
}

// Convert to target format
return ConvertToTargetFormat(gltf, options);
```

Mark complete in TODO.md: T118.B4 (image processing), T118.B5 (RAW camera files), T118.B6 (GPU texture formats), T118.B7 (3D model formats).

**Research note:** GPU textures and 3D models are specialized. glTF has full implementation (JSON-based). DDS, KTX, USD require domain-specific libraries - stubs acceptable.
  </action>
  <verify>
```bash
cd Plugins/DataWarehouse.Plugins.Transcoding.Media && dotnet build
ls Strategies/GPUTexture/*.cs | wc -l  # Expect: 2
ls Strategies/3D/*.cs | wc -l          # Expect: 2

# Total media strategy count:
find Strategies -name "*.cs" | wc -l
# Expect: 20 (3 streaming + 5 video + 4 image + 4 RAW + 2 GPU + 2 3D)
```
  </verify>
  <done>
- [ ] 4 strategies implemented (2 GPU texture + 2 3D model)
- [ ] GltfModelStrategy has full JSON parsing
- [ ] DDS, KTX, USD have format detection stubs
- [ ] TODO.md updated for T118.B4-B7
- [ ] Builds without errors
  </done>
</task>

</tasks>

<verification>
1. Build: `cd Plugins/DataWarehouse.Plugins.Transcoding.Media && dotnet build`
2. Strategy count: 20 total media strategies
3. Image processing: SixLabors.ImageSharp library usage
4. Format detection: All strategies implement DetectFormatAsync
5. Phase completion: All T118 sub-tasks marked complete
</verification>

<success_criteria>
- [ ] 12 media strategies implemented (4 image + 4 RAW + 2 GPU + 2 3D)
- [ ] Image strategies use SixLabors.ImageSharp library
- [ ] RAW camera strategies detect format headers
- [ ] GPU texture strategies handle compressed formats
- [ ] 3D model strategies parse glTF and USD
- [ ] All extend MediaStrategyBase from SDK
- [ ] Build passes with zero errors
- [ ] TODO.md updated for T118.B4-B7
- [ ] Phase 7 complete: UltimateDataFormat (29 strategies), UltimateStreamingData (verified + extended), Transcoding.Media (20 strategies)
</success_criteria>

<output>
After completion, create `.planning/phases/07-format-media/07-08-SUMMARY.md`
</output>
