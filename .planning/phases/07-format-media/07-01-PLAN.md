---
phase: 07-format-media
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateDataFormat/UltimateDataFormatPlugin.cs
  - Plugins/DataWarehouse.Plugins.UltimateDataFormat/DataWarehouse.Plugins.UltimateDataFormat.csproj
  - Plugins/DataWarehouse.Plugins.UltimateDataFormat/Strategies/Text/JsonStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateDataFormat/Strategies/Text/XmlStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateDataFormat/Strategies/Text/CsvStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateDataFormat/Strategies/Text/YamlStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateDataFormat/Strategies/Text/TomlStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateDataFormat/Strategies/Binary/ProtobufStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateDataFormat/Strategies/Binary/MessagePackStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateDataFormat/Strategies/Schema/AvroStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateDataFormat/Strategies/Schema/ThriftStrategy.cs
  - DataWarehouse.slnx
  - Metadata/TODO.md
autonomous: true

must_haves:
  truths:
    - "UltimateDataFormat plugin project exists and compiles without errors"
    - "Plugin orchestrator discovers and registers format strategies automatically"
    - "Text format strategies (JSON, XML, CSV, YAML, TOML) can parse and serialize data"
    - "Binary format strategies (Protobuf, MessagePack) handle binary data"
    - "Schema format strategies (Avro, Thrift) extract schema information"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateDataFormat/UltimateDataFormatPlugin.cs"
      provides: "Plugin orchestrator with auto-discovery and registry"
      min_lines: 150
    - path: "Plugins/DataWarehouse.Plugins.UltimateDataFormat/DataWarehouse.Plugins.UltimateDataFormat.csproj"
      provides: "Project file with SDK-only ProjectReference"
      contains: "DataWarehouse.SDK"
    - path: "Plugins/DataWarehouse.Plugins.UltimateDataFormat/Strategies/Text/JsonStrategy.cs"
      provides: "JSON format strategy extending DataFormatStrategyBase"
      exports: ["JsonStrategy"]
  key_links:
    - from: "UltimateDataFormatPlugin.cs"
      to: "DataFormatStrategyBase implementations"
      via: "reflection-based auto-discovery"
      pattern: "typeof\\(IDataFormatStrategy\\)\\.IsAssignableFrom"
    - from: "JsonStrategy.cs"
      to: "SDK.Contracts.DataFormat.DataFormatStrategyBase"
      via: "inheritance"
      pattern: ": DataFormatStrategyBase"
    - from: ".csproj"
      to: "DataWarehouse.SDK"
      via: "ProjectReference (SDK-only isolation)"
      pattern: "<ProjectReference.*DataWarehouse\\.SDK"
---

<objective>
Create UltimateDataFormat plugin from scratch with orchestrator and initial text, binary, and schema format strategies.

Purpose: Research confirmed UltimateDataFormat plugin does not exist. SDK contracts (IDataFormatStrategy, DataFormatStrategyBase) are complete in DataWarehouse.SDK/Contracts/DataFormat. This plan creates the missing plugin following established patterns from UltimateStreamingData and UltimateInterface.

Output: Production-ready plugin project with 10 format strategies across 3 domains (text, binary, schema).
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-format-media/07-RESEARCH.md
@DataWarehouse.SDK/Contracts/DataFormat/DataFormatStrategy.cs
@Plugins/DataWarehouse.Plugins.UltimateStreamingData/UltimateStreamingDataPlugin.cs
@.planning/phases/06-interface-layer/06-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UltimateDataFormat plugin project and orchestrator</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateDataFormat/UltimateDataFormatPlugin.cs
    Plugins/DataWarehouse.Plugins.UltimateDataFormat/DataWarehouse.Plugins.UltimateDataFormat.csproj
    DataWarehouse.slnx
  </files>
  <action>
**1. Create plugin project directory:**
```bash
mkdir -p Plugins/DataWarehouse.Plugins.UltimateDataFormat/Strategies/{Text,Binary,Schema}
```

**2. Create .csproj file:**
- TargetFramework: net10.0
- SDK-only isolation: ProjectReference to DataWarehouse.SDK (NOT Kernel or Shared)
- NuGet packages: System.Text.Json, Newtonsoft.Json, YamlDotNet, MessagePack
- Follow pattern from UltimateStreamingData.csproj

**3. Implement UltimateDataFormatPlugin.cs:**
- Extend `IntelligenceAwarePluginBase` (NOT IPlugin directly)
- Plugin ID: "com.datawarehouse.dataformat.ultimate"
- Name: "Ultimate Data Format"
- Category: PluginCategory.OrchestrationProvider
- Auto-discovery pattern: Use reflection to scan assembly for IDataFormatStrategy implementations
- Registry: `ConcurrentDictionary<string, IDataFormatStrategy>` keyed by StrategyId
- Methods:
  - `DiscoverAndRegisterStrategies()` - reflection scan in ctor
  - `GetStrategy(string strategyId)` - lookup by ID
  - `GetStrategiesByDomain(DomainFamily domain)` - filter by domain
  - `DetectFormat(Stream stream)` - iterate strategies calling DetectFormatAsync
  - Message bus wiring for Intelligence integration
- Handle handshake, message subscriptions, disposal
- Pattern reference: UltimateStreamingDataPlugin.cs (lines 1-200)

**4. Add to solution:**
```bash
dotnet sln DataWarehouse.slnx add Plugins/DataWarehouse.Plugins.UltimateDataFormat/DataWarehouse.Plugins.UltimateDataFormat.csproj
```

**Why this approach:** SDK contracts are complete (897 lines). Research shows existing plugins use IntelligenceAwarePluginBase + reflection-based auto-discovery. Plugin isolation requires SDK-only references (no direct plugin-to-plugin references).
  </action>
  <verify>
```bash
cd Plugins/DataWarehouse.Plugins.UltimateDataFormat && dotnet build
# Expect: Build succeeded with 0 errors
```
  </verify>
  <done>
- [ ] Plugin project compiles with zero errors
- [ ] .csproj references SDK only (not Kernel or other plugins)
- [ ] Orchestrator has auto-discovery logic via reflection
- [ ] Registry stores strategies by StrategyId
- [ ] Plugin added to DataWarehouse.slnx
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement 10 format strategies (text, binary, schema)</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateDataFormat/Strategies/Text/JsonStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateDataFormat/Strategies/Text/XmlStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateDataFormat/Strategies/Text/CsvStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateDataFormat/Strategies/Text/YamlStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateDataFormat/Strategies/Text/TomlStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateDataFormat/Strategies/Binary/ProtobufStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateDataFormat/Strategies/Binary/MessagePackStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateDataFormat/Strategies/Schema/AvroStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateDataFormat/Strategies/Schema/ThriftStrategy.cs
    Metadata/TODO.md
  </files>
  <action>
**Implement 10 strategies extending DataFormatStrategyBase:**

**Text Strategies (5):**

1. **JsonStrategy** (strategyId: "json")
   - Extensions: .json, .geojson
   - MIME: application/json
   - DomainFamily: General
   - DetectFormatCoreAsync: Check for `{` or `[` first byte
   - ParseAsync: Use System.Text.Json.JsonSerializer.Deserialize
   - SerializeAsync: Use System.Text.Json.JsonSerializer.Serialize
   - Capabilities: Bidirectional, SelfDescribing, SupportsHierarchicalData (not SchemaAware)
   - ValidateCoreAsync: Parse with JsonDocument, catch JsonException

2. **XmlStrategy** (strategyId: "xml")
   - Extensions: .xml, .xsd
   - MIME: application/xml, text/xml
   - DomainFamily: General
   - DetectFormatCoreAsync: Check for `<` first byte or `<?xml`
   - ParseAsync: Use XDocument.Load
   - SerializeAsync: Use XDocument.Save
   - Capabilities: Bidirectional, SchemaAware (XSD support), SupportsHierarchicalData

3. **CsvStrategy** (strategyId: "csv")
   - Extensions: .csv, .tsv
   - MIME: text/csv
   - DomainFamily: General
   - DetectFormatCoreAsync: Read first line, check for comma/tab delimiters
   - ParseAsync: Manual CSV parsing or use library (NOT CsvHelper - prefer System code)
   - SerializeAsync: Write comma-delimited lines
   - Capabilities: Bidirectional, Streaming (not SchemaAware, not SupportsHierarchicalData)

4. **YamlStrategy** (strategyId: "yaml")
   - Extensions: .yaml, .yml
   - MIME: application/x-yaml
   - DomainFamily: General
   - DetectFormatCoreAsync: Check for YAML markers (---, key:)
   - ParseAsync: Use YamlDotNet.Serialization.Deserializer
   - SerializeAsync: Use YamlDotNet.Serialization.Serializer
   - Capabilities: Bidirectional, SelfDescribing, SupportsHierarchicalData

5. **TomlStrategy** (strategyId: "toml")
   - Extensions: .toml
   - MIME: application/toml
   - DomainFamily: General
   - DetectFormatCoreAsync: Check for [section] or key=value pattern
   - ParseAsync: Manual TOML parsing (basic key=value, [sections])
   - SerializeAsync: Write TOML format
   - Capabilities: Bidirectional, SelfDescribing (not SupportsHierarchicalData)

**Binary Strategies (2):**

6. **ProtobufStrategy** (strategyId: "protobuf")
   - Extensions: .proto, .pb
   - MIME: application/protobuf
   - DomainFamily: General
   - DetectFormatCoreAsync: Check for protobuf magic bytes (field tags with wire types)
   - ParseAsync: Stub (requires schema definition)
   - SerializeAsync: Stub (requires schema definition)
   - Capabilities: Bidirectional, SchemaAware, SupportsBinaryData, CompressionAware

7. **MessagePackStrategy** (strategyId: "msgpack")
   - Extensions: .msgpack, .mp
   - MIME: application/msgpack
   - DomainFamily: General
   - DetectFormatCoreAsync: Check MessagePack format byte markers (0x80-0x8f, 0xdc, 0xdd)
   - ParseAsync: Use MessagePack.MessagePackSerializer.Deserialize
   - SerializeAsync: Use MessagePack.MessagePackSerializer.Serialize
   - Capabilities: Bidirectional, SupportsBinaryData, Streaming

**Schema Strategies (2):**

8. **AvroStrategy** (strategyId: "avro")
   - Extensions: .avro
   - MIME: application/avro
   - DomainFamily: General
   - DetectFormatCoreAsync: Check for Avro Object Container File magic bytes: Obj\x01
   - ParseAsync: Stub (requires Apache.Avro library - defer full implementation)
   - SerializeAsync: Stub
   - ExtractSchemaCoreAsync: Return embedded Avro schema
   - Capabilities: Bidirectional, SchemaAware, Streaming, CompressionAware, SupportsBinaryData

9. **ThriftStrategy** (strategyId: "thrift")
   - Extensions: .thrift
   - MIME: application/x-thrift
   - DomainFamily: General
   - DetectFormatCoreAsync: Check for Thrift protocol markers
   - ParseAsync: Stub (requires Thrift library)
   - SerializeAsync: Stub
   - Capabilities: Bidirectional, SchemaAware, SupportsBinaryData

**Pattern for all strategies:**
- Extend DataFormatStrategyBase
- Override abstract properties: StrategyId, DisplayName, Capabilities, FormatInfo
- Override abstract methods: DetectFormatCoreAsync, ParseAsync, SerializeAsync, ValidateCoreAsync
- Call base.ConfigureIntelligence(messageBus) in orchestrator registration
- Use SDK types only (no Kernel or plugin references)

**Mark complete in TODO.md:** T110.B2 (text formats), T110.B3 (binary formats), T110.B4 (schema formats partial - 2 of 5 strategies).

**Why this scope:** 10 strategies demonstrate the pattern. Research recommends starting with common formats per domain. Stubs for Protobuf/Avro/Thrift are acceptable - full implementations require external libraries (Apache.Avro, Google.Protobuf, Apache.Thrift) which can be added in later plans.
  </action>
  <verify>
```bash
cd Plugins/DataWarehouse.Plugins.UltimateDataFormat && dotnet build
# Expect: Build succeeded, 10 strategies compiled

# Verify auto-discovery finds all 10 strategies:
grep -r "class.*Strategy.*:.*DataFormatStrategyBase" Strategies/ | wc -l
# Expect: 10
```
  </verify>
  <done>
- [ ] All 10 strategy files compile without errors
- [ ] Each strategy extends DataFormatStrategyBase
- [ ] Each strategy has unique StrategyId
- [ ] DetectFormatCoreAsync implemented for all strategies
- [ ] ParseAsync/SerializeAsync implemented (stubs OK for Protobuf/Avro/Thrift)
- [ ] ValidateCoreAsync implemented for all strategies
- [ ] TODO.md updated with completed items
  </done>
</task>

</tasks>

<verification>
1. Solution builds cleanly: `dotnet build DataWarehouse.slnx`
2. Plugin project compiles: `cd Plugins/DataWarehouse.Plugins.UltimateDataFormat && dotnet build`
3. Auto-discovery works: Check orchestrator instantiates all 10 strategies in registry
4. SDK-only isolation: Verify .csproj has no references to Kernel or other plugins
5. Pattern compliance: Strategies follow DataFormatStrategyBase contract
</verification>

<success_criteria>
- [ ] UltimateDataFormat plugin project exists in Plugins/ directory
- [ ] Plugin added to DataWarehouse.slnx and compiles with zero errors
- [ ] Orchestrator discovers and registers 10 format strategies automatically
- [ ] All strategies extend DataFormatStrategyBase from SDK
- [ ] Plugin isolated: only references DataWarehouse.SDK
- [ ] Text strategies (JSON, XML, CSV, YAML, TOML) parse and serialize correctly
- [ ] Binary strategies (Protobuf, MessagePack) handle format detection
- [ ] Schema strategies (Avro, Thrift) have ExtractSchemaAsync implementations
- [ ] Build verification passes: no CS errors, no nullable warnings
</success_criteria>

<output>
After completion, create `.planning/phases/07-format-media/07-01-SUMMARY.md`
</output>
