---
phase: 09-advanced-security
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.Tests/Security/EphemeralSharingStrategyTests.cs
  - Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/EphemeralSharing/EphemeralSharingStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Duress/DuressDeadDropStrategy.cs
autonomous: true

must_haves:
  truths:
    - "Ephemeral shares can be created with TTL, access count limits, and password protection"
    - "Shares expire automatically after TTL or max accesses reached"
    - "Burn-after-reading destroys shares after first access"
    - "Destruction proof provides cryptographic evidence of share deletion"
    - "Dead drop exfiltration supports duress scenarios"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/EphemeralSharing/EphemeralSharingStrategy.cs"
      provides: "Ephemeral sharing with TTL and burn-after-reading"
      min_lines: 300
    - path: "Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Duress/DuressDeadDropStrategy.cs"
      provides: "Dead drop exfiltration for duress scenarios"
      min_lines: 200
    - path: "DataWarehouse.Tests/Security/EphemeralSharingStrategyTests.cs"
      provides: "Test suite covering ephemeral shares and dead drops"
      min_lines: 250
  key_links:
    - from: "EphemeralSharingStrategy.cs"
      to: "AccessControlStrategyBase"
      via: "inheritance"
      pattern: "class EphemeralSharingStrategy : AccessControlStrategyBase"
    - from: "DuressDeadDropStrategy.cs"
      to: "AccessControlStrategyBase"
      via: "inheritance"
      pattern: "class DuressDeadDropStrategy : AccessControlStrategyBase"
---

<objective>
Verify and test digital dead drops with ephemeral sharing (T76). EphemeralSharingStrategy.cs implements time-limited shares with burn-after-reading. DuressDeadDropStrategy.cs handles duress exfiltration scenarios. Create comprehensive test suite validating TTL, access limits, destruction proof.

Purpose: Confirm ephemeral access and dead drop exfiltration work for secure temporary sharing
Output: Complete test suite validating all T76 requirements
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-advanced-security/09-RESEARCH.md

# Existing implementations
@Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/EphemeralSharing/EphemeralSharingStrategy.cs
@Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Duress/DuressDeadDropStrategy.cs

# SDK contracts
@DataWarehouse.SDK/Security/AccessControlStrategyBase.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify ephemeral sharing and dead drop implementation</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/EphemeralSharing/EphemeralSharingStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Duress/DuressDeadDropStrategy.cs
  </files>
  <action>
    Read both strategy files and verify T76 sub-tasks:

    **EphemeralSharingStrategy.cs:**
    - CreateShareAsync creates ephemeral shares with configuration:
      - ResourceId, ExpiresAt (TTL)
      - MaxAccesses (optional access count limit)
      - BurnAfterReading flag
      - RequirePassword flag with password validation
      - NotifyOnAccess email notification
    - ValidateAndAccessShareAsync validates TTL, access count, password
    - EvaluateAccessCoreAsync checks expiration and destroys expired shares
    - DestroyShareAsync deletes share immediately
    - GetDestructionProofAsync returns cryptographic proof (timestamp, access log, hash)
    - GenerateShareUrl creates shareable URL from token
    - Access count tracking with thread safety

    **DuressDeadDropStrategy.cs:**
    - Dead drop creation for duress scenarios
    - Exfiltration with decoy data support
    - Duress signal detection
    - Alternative data delivery on duress trigger

    Research notes:
    - TTL enforcement via DateTime.UtcNow comparison
    - Burn-after-reading increments access count and destroys at MaxAccesses
    - Destruction proof includes access log and cryptographic proof
    - TOCTOU race condition handling via atomic operations

    Verify build passes with zero errors.
  </action>
  <verify>
    Grep for "CreateShareAsync", "ValidateAndAccessShareAsync", "DestroyShareAsync", "GetDestructionProofAsync", "GenerateShareUrl" confirms all methods exist in EphemeralSharingStrategy.cs.

    Grep for "NotImplementedException" returns zero.

    Build passes with zero errors.
  </verify>
  <done>
    Ephemeral sharing and dead drop strategies verified complete with TTL enforcement, access limits, burn-after-reading, destruction proof, duress detection. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ephemeral sharing test suite</name>
  <files>
    DataWarehouse.Tests/Security/EphemeralSharingStrategyTests.cs
  </files>
  <action>
    Create comprehensive xUnit test suite for ephemeral sharing and dead drops:

    **Ephemeral share creation tests:**
    - CreateShareAsync generates share with unique token
    - Share has TTL (ExpiresAt), MaxAccesses, BurnAfterReading flags
    - GenerateShareUrl produces valid shareable URL

    **TTL enforcement tests:**
    - ValidateAndAccessShareAsync allows access before expiration
    - ValidateAndAccessShareAsync denies access after expiration
    - Expired shares automatically destroyed
    - EvaluateAccessCoreAsync checks TTL on every access

    **Access count tests:**
    - MaxAccesses limits enforced (1 access works, 2nd denied if MaxAccesses=1)
    - AccessCount increments on each access
    - Share destroyed when AccessCount exceeds MaxAccesses

    **Burn-after-reading tests:**
    - BurnAfterReading=true destroys share after first access
    - Second access attempt returns "Share not found"
    - DestroyShareAsync called automatically

    **Password protection tests:**
    - RequirePassword=true enforces password validation
    - Correct password grants access
    - Incorrect password denies access
    - Constant-time password comparison prevents timing attacks

    **Notification tests:**
    - NotifyOnAccess=true triggers email notification
    - Notification includes access timestamp, IP address (if available)

    **Destruction proof tests:**
    - GetDestructionProofAsync returns proof with timestamp, access log
    - Proof includes cryptographic hash for integrity
    - Proof persists after share deletion

    **Dead drop exfiltration tests (DuressDeadDropStrategy):**
    - Dead drop creation with decoy data
    - Duress signal detection triggers alternative data delivery
    - Exfiltration works without exposing real data

    **Race condition tests:**
    - Concurrent access to same share handled atomically
    - No double-access when MaxAccesses=1 with concurrent requests
    - Share destruction synchronized

    Use synthetic test data. Mock time (DateTime.UtcNow) for TTL testing. Use FluentAssertions for assertions.
  </action>
  <verify>
    `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter FullyQualifiedName~EphemeralSharingStrategyTests` passes with 100% success rate.

    Test count >= 15 methods covering creation, TTL, access limits, burn-after-reading, password protection, notifications, destruction proof, dead drops, race conditions.

    Build passes with zero errors.
  </verify>
  <done>
    EphemeralSharingStrategyTests.cs exists with comprehensive test coverage. All tests pass. Zero build errors. Test coverage validates: creation, TTL enforcement, access limits, burn-after-reading, password protection, destruction proof, dead drop exfiltration.
  </done>
</task>

</tasks>

<verification>
Build verification:
```bash
dotnet build Plugins/DataWarehouse.Plugins.UltimateAccessControl/DataWarehouse.Plugins.UltimateAccessControl.csproj --no-restore
```

Test execution:
```bash
dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter FullyQualifiedName~EphemeralSharingStrategyTests --no-build
```

Implementation check:
```bash
grep -c "CreateShareAsync\|ValidateAndAccessShareAsync\|DestroyShareAsync\|GetDestructionProofAsync" Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/EphemeralSharing/EphemeralSharingStrategy.cs
# Should return 4 (one per method)
```
</verification>

<success_criteria>
1. EphemeralSharingStrategy.cs verified complete with TTL, access limits, burn-after-reading, destruction proof
2. DuressDeadDropStrategy.cs verified complete with duress detection and exfiltration
3. EphemeralSharingStrategyTests.cs created with comprehensive test coverage
4. All tests pass with 100% success rate
5. Build succeeds with zero errors
6. Test coverage validates: creation, TTL, access limits, burn-after-reading, password protection, notifications, destruction proof, dead drops
</success_criteria>

<output>
After completion, create `.planning/phases/09-advanced-security/09-04-SUMMARY.md`
</output>
