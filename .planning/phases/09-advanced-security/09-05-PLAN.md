---
phase: 09-advanced-security
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.Tests/Compliance/DataSovereigntyEnforcerTests.cs
  - Plugins/DataWarehouse.Plugins.UltimateCompliance/Features/DataSovereigntyEnforcer.cs
autonomous: true

must_haves:
  truths:
    - "Regional policies define allowed destinations and required transfer mechanisms"
    - "Data transfers validate source/destination regions against policies"
    - "Prohibited transfers blocked with clear violation reasons"
    - "Transfer mechanisms (SCCs, Adequacy Decisions, Consent) enforced"
    - "Sovereignty geofencing integrates with replication engine"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateCompliance/Features/DataSovereigntyEnforcer.cs"
      provides: "Data sovereignty geofencing with regional policies"
      min_lines: 300
    - path: "DataWarehouse.Tests/Compliance/DataSovereigntyEnforcerTests.cs"
      provides: "Test suite covering regional policies and transfer validation"
      min_lines: 200
  key_links:
    - from: "DataSovereigntyEnforcer.cs"
      to: "UltimateCompliance plugin"
      via: "feature service"
      pattern: "namespace.*UltimateCompliance"
    - from: "DataSovereigntyEnforcerTests.cs"
      to: "DataSovereigntyEnforcer"
      via: "test instantiation"
      pattern: "new DataSovereigntyEnforcer\\(\\)"
---

<objective>
Verify and test data sovereignty geofencing (T77). DataSovereigntyEnforcer.cs implements regional policy enforcement with transfer validation. Create comprehensive test suite validating GDPR, CCPA, and other regulatory framework compliance.

Purpose: Confirm sovereignty geofencing prevents unauthorized cross-border data transfers
Output: Complete test suite validating all T77 requirements
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-advanced-security/09-RESEARCH.md

# Existing implementation
@Plugins/DataWarehouse.Plugins.UltimateCompliance/Features/DataSovereigntyEnforcer.cs

# Related compliance infrastructure
@Plugins/DataWarehouse.Plugins.UltimateCompliance/UltimateCompliancePlugin.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify sovereignty geofencing implementation</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateCompliance/Features/DataSovereigntyEnforcer.cs
  </files>
  <action>
    Read DataSovereigntyEnforcer.cs and verify T77 sub-tasks:

    **Regional policy management:**
    - AddRegionPolicy defines policies per region (EU, US, CN, etc.)
    - RegionPolicy contains:
      - Region identifier
      - RegulatoryFramework (GDPR, CCPA, PIPL, etc.)
      - ProhibitedDestinations list
      - RequiredMechanisms (SCCs, Adequacy Decisions, Consent)
      - AllowedClassifications (Public, Internal, Confidential, Secret)
      - RequiresLocalProcessing flag
      - AllowsCloudStorage flag

    **Transfer validation:**
    - ValidateTransfer checks source → destination against policies
    - Returns ValidationResult with IsAllowed flag, Message, RequiredMechanisms
    - Prohibited destinations blocked
    - Missing mechanisms flagged
    - Data classification checked

    **Transfer mechanism management:**
    - AllowTransfer enables specific region-to-region transfers with mechanisms
    - Transfer mechanisms enum: StandardContractualClauses, AdequacyDecision, ConsentBased, BindingCorporateRules, DerogationsUnderGDPR

    **Destination queries:**
    - GetAllowedDestinations returns valid destinations for source region
    - GetProhibitedDestinations returns blocked destinations

    **Replication fence integration (T77.3):**
    - Check if integration with storage replication engine exists
    - Enforcement at storage layer prevents background replication violations
    - Message bus integration for "compliance.geofence.check" topic

    Research notes:
    - GDPR Chapter V transfer requirements
    - CCPA cross-border transfer restrictions
    - PIPL (China) data localization

    Verify build passes with zero errors.
  </action>
  <verify>
    Grep for "AddRegionPolicy", "ValidateTransfer", "AllowTransfer", "GetAllowedDestinations" confirms all methods exist.

    Grep for "NotImplementedException" returns zero.

    Build passes with zero errors.
  </verify>
  <done>
    Data sovereignty enforcer verified complete with regional policies, transfer validation, mechanism enforcement, destination queries. Replication fence integration status documented. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create sovereignty geofencing test suite</name>
  <files>
    DataWarehouse.Tests/Compliance/DataSovereigntyEnforcerTests.cs
  </files>
  <action>
    Create comprehensive xUnit test suite for data sovereignty:

    **Regional policy tests:**
    - AddRegionPolicy adds EU policy with GDPR framework
    - AddRegionPolicy adds US policy with CCPA framework
    - AddRegionPolicy adds CN policy with PIPL framework
    - Policies contain correct prohibited destinations, required mechanisms

    **Transfer validation tests (EU → destinations):**
    - EU → US transfer DENIED without Standard Contractual Clauses
    - EU → US transfer ALLOWED with SCCs
    - EU → US transfer ALLOWED with Adequacy Decision
    - EU → CN transfer DENIED (China in prohibited list)
    - EU → UK transfer ALLOWED (Adequacy Decision post-Brexit)

    **Transfer validation tests (US → destinations):**
    - US → EU transfer requires mechanism
    - US → CN transfer DENIED (China in prohibited list)
    - US → CA transfer ALLOWED (domestic)

    **Data classification tests:**
    - EU policy allows Public, Internal, Confidential
    - Secret classification blocked for EU cloud storage
    - Classification enforcement integrated with transfer validation

    **Required mechanisms tests:**
    - Missing required mechanism returns validation failure
    - Message lists required mechanisms for user guidance
    - Multiple mechanisms can apply (SCCs OR Adequacy Decision)

    **Destination queries tests:**
    - GetAllowedDestinations("EU") returns [US, UK] with mechanisms
    - GetAllowedDestinations("EU") excludes [CN, RU]
    - GetProhibitedDestinations("EU") returns [CN, RU, ...]

    **Local processing tests:**
    - RequiresLocalProcessing=true enforces in-region processing
    - AllowsCloudStorage=false blocks cloud providers

    **Real-world regulatory scenarios:**
    - GDPR Article 46 SCCs scenario
    - CCPA CPRA cross-border provisions
    - PIPL Article 38 data localization
    - EU-US Data Privacy Framework (Adequacy Decision)

    Use synthetic policy configurations. Test real regulatory frameworks (GDPR, CCPA, PIPL). Use FluentAssertions for assertions.
  </action>
  <verify>
    `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter FullyQualifiedName~DataSovereigntyEnforcerTests` passes with 100% success rate.

    Test count >= 15 methods covering regional policies, transfer validation, mechanisms, classification, destination queries, real-world scenarios.

    Build passes with zero errors.
  </verify>
  <done>
    DataSovereigntyEnforcerTests.cs exists with comprehensive test coverage for GDPR, CCPA, PIPL compliance. All tests pass. Zero build errors. Test coverage validates: regional policies, transfer validation, mechanisms, classification enforcement, destination queries.
  </done>
</task>

</tasks>

<verification>
Build verification:
```bash
dotnet build Plugins/DataWarehouse.Plugins.UltimateCompliance/DataWarehouse.Plugins.UltimateCompliance.csproj --no-restore
```

Test execution:
```bash
dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter FullyQualifiedName~DataSovereigntyEnforcerTests --no-build
```

Implementation check:
```bash
grep -c "AddRegionPolicy\|ValidateTransfer\|AllowTransfer\|GetAllowedDestinations" Plugins/DataWarehouse.Plugins.UltimateCompliance/Features/DataSovereigntyEnforcer.cs
# Should return 4 (one per method)
```
</verification>

<success_criteria>
1. DataSovereigntyEnforcer.cs verified complete with regional policies and transfer validation
2. Transfer mechanisms (SCCs, Adequacy Decisions, Consent) enforced
3. DataSovereigntyEnforcerTests.cs created with comprehensive test coverage
4. All tests pass with 100% success rate validating GDPR, CCPA, PIPL compliance
5. Build succeeds with zero errors
6. Test coverage validates: regional policies, transfer validation, mechanisms, classification, destination queries
</success_criteria>

<output>
After completion, create `.planning/phases/09-advanced-security/09-05-SUMMARY.md`
</output>
