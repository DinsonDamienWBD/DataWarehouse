---
phase: 09-advanced-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.Tests/Security/CanaryStrategyTests.cs
  - Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Honeypot/CanaryStrategy.cs
autonomous: true

must_haves:
  truths:
    - "Canary objects (files, API tokens, database honeytokens) can be generated with realistic content"
    - "Canaries are placed intelligently (admin areas, sensitive shares) and monitored for access"
    - "Canary access triggers forensic capture, multi-channel alerts, and optional lockdown"
    - "Canaries rotate automatically on schedule with exclusion rules for backup software"
    - "Effectiveness metrics (triggers, false positive rate, MTTD) are available"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Honeypot/CanaryStrategy.cs"
      provides: "Complete canary implementation with all T73 sub-tasks"
      min_lines: 800
    - path: "DataWarehouse.Tests/Security/CanaryStrategyTests.cs"
      provides: "Test suite covering all 10 T73 sub-tasks"
      min_lines: 400
  key_links:
    - from: "CanaryStrategy.cs"
      to: "AccessControlStrategyBase"
      via: "inheritance"
      pattern: "class CanaryStrategy : AccessControlStrategyBase"
    - from: "CanaryStrategyTests.cs"
      to: "CanaryStrategy"
      via: "test instantiation and API calls"
      pattern: "new CanaryStrategy\\(\\)"
---

<objective>
Verify and test the production-ready canary objects implementation (T73). All 10 sub-tasks are already implemented in CanaryStrategy.cs — create comprehensive test suite to validate generation, placement, monitoring, alerting, forensics, rotation, exclusions, auto-deployment, effectiveness metrics, and lockdown.

Purpose: Confirm honeypot canary system works end-to-end for intrusion detection
Output: Complete test suite validating all T73 requirements
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-advanced-security/09-RESEARCH.md

# Existing implementation
@Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Honeypot/CanaryStrategy.cs

# SDK contracts
@DataWarehouse.SDK/Security/AccessControlStrategyBase.cs
@DataWarehouse.SDK/Security/IAccessControlStrategy.cs

# Test patterns from prior phases
@DataWarehouse.Tests/Security/AccessControlStrategyTests.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify CanaryStrategy implementation completeness</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Honeypot/CanaryStrategy.cs
  </files>
  <action>
    Read CanaryStrategy.cs and verify all T73 sub-tasks are implemented:
    - T73.1: Canary generator (CreateCanaryFile, CreateApiHoneytoken, CreateDatabaseHoneytoken)
    - T73.2: Smart placement engine with CanaryPlacementHint support
    - T73.3: Access monitoring via EvaluateAccessCoreAsync
    - T73.4: Forensic capture (CaptureForensics with IP, process, stack trace)
    - T73.5: Multi-channel alerts (RegisterAlertChannel, SendAlertsAsync)
    - T73.6: Automatic rotation (StartRotation timer-based)
    - T73.7: Exclusion rules (IsExcludedAccess with process patterns)
    - T73.8: Auto-deployment (AutoDeployCanariesAsync with intelligent placement)
    - T73.9: Effectiveness metrics (GetEffectivenessReport with false positive rate, MTTD)
    - T73.10: Lockdown automation (SetLockdownHandler, TriggerLockdownAsync)

    Document any gaps or NotImplementedException patterns. Per research, implementation is complete — validation only.
  </action>
  <verify>
    Grep for "NotImplementedException" in CanaryStrategy.cs returns zero results. Grep for all method names (CreateCanaryFile, CreateApiHoneytoken, etc.) confirms presence. Build passes with zero errors.
  </verify>
  <done>
    All 10 T73 sub-task methods exist in CanaryStrategy.cs with real implementations. Zero NotImplementedException. Build passes. Documentation confirms completeness.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create comprehensive CanaryStrategy test suite</name>
  <files>
    DataWarehouse.Tests/Security/CanaryStrategyTests.cs
  </files>
  <action>
    Create comprehensive xUnit test suite for CanaryStrategy covering:

    **T73.1 Generation tests:**
    - CreateCanaryFile generates files with realistic content for PasswordsExcel, WalletDat, CredentialsJson types
    - CreateApiHoneytoken generates API tokens with resource metadata
    - CreateDatabaseHoneytoken generates DB honeytokens with table metadata
    - All canaries have unique IDs, tokens, timestamps

    **T73.2 Placement tests:**
    - PlacementEngine.SuggestPlacement returns paths based on hints (AdminArea, SensitiveShare, BackupLocation)
    - Placement hints influence suggested file locations

    **T73.3 Monitoring tests:**
    - EvaluateAccessCoreAsync detects canary access and triggers alerts
    - Access to non-canary resources returns normal decisions

    **T73.4 Forensics tests:**
    - CaptureForensics captures IP, process name, user agent, timestamp
    - Forensic snapshots contain actionable investigation data

    **T73.5 Alerting tests:**
    - RegisterAlertChannel adds email, SIEM, webhook channels
    - SendAlertsAsync delivers to all registered channels
    - Alert queue respects MaxAlertsInQueue limit

    **T73.6 Rotation tests:**
    - StartRotation enables automatic canary rotation
    - Rotation interval configurable via initialization
    - Rotated canaries get new IDs and tokens

    **T73.7 Exclusion tests:**
    - IsExcludedAccess filters backup software (veeam*, backup*, msmpeng*)
    - Excluded processes don't trigger alerts

    **T73.8 Auto-deployment tests:**
    - AutoDeployCanariesAsync creates multiple canaries with intelligent distribution
    - MaxCanaries limit respected
    - Placement covers admin areas, sensitive shares, backup locations

    **T73.9 Effectiveness tests:**
    - GetEffectivenessReport returns metrics (total canaries, triggers, false positive rate, MTTD)
    - False positive rate calculated from exclusion hits

    **T73.10 Lockdown tests:**
    - SetLockdownHandler registers callback
    - TriggerLockdownAsync invokes handler on canary access
    - Lockdown handler receives subject ID

    Use FluentAssertions for assertions, Moq for mock dependencies if needed. Follow SDK contract-level testing pattern (no actual storage/network I/O).
  </action>
  <verify>
    `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter FullyQualifiedName~CanaryStrategyTests` passes with 100% success rate. All 10 T73 sub-tasks have corresponding test methods. Build passes with zero errors.
  </verify>
  <done>
    CanaryStrategyTests.cs exists with comprehensive test coverage for all T73 sub-tasks. All tests pass. Zero build errors. Test count >= 15 test methods covering generation, placement, monitoring, forensics, alerts, rotation, exclusions, deployment, metrics, lockdown.
  </done>
</task>

</tasks>

<verification>
Build verification:
```bash
dotnet build Plugins/DataWarehouse.Plugins.UltimateAccessControl/DataWarehouse.Plugins.UltimateAccessControl.csproj --no-restore
```

Test execution:
```bash
dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter FullyQualifiedName~CanaryStrategyTests --no-build
```

Implementation check:
```bash
grep -c "CreateCanaryFile\|CreateApiHoneytoken\|CreateDatabaseHoneytoken\|AutoDeployCanariesAsync\|GetEffectivenessReport\|TriggerLockdownAsync" Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Honeypot/CanaryStrategy.cs
# Should return 6+ (one per key method)
```
</verification>

<success_criteria>
1. CanaryStrategy.cs verified complete with all 10 T73 methods implemented
2. CanaryStrategyTests.cs created with comprehensive test coverage
3. All tests pass with 100% success rate
4. Build succeeds with zero errors
5. Test coverage validates: generation, placement, monitoring, forensics, alerts, rotation, exclusions, deployment, metrics, lockdown
</success_criteria>

<output>
After completion, create `.planning/phases/09-advanced-security/09-01-SUMMARY.md`
</output>
