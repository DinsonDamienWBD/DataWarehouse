---
phase: 09-advanced-security
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.Tests/Security/WatermarkingStrategyTests.cs
  - Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Watermarking/WatermarkingStrategy.cs
autonomous: true

must_haves:
  truths:
    - "Unique watermarks can be generated per user with signed metadata"
    - "Watermarks can be embedded in binary data (PDFs, images, documents)"
    - "Watermarks can be embedded in text using whitespace encoding"
    - "Watermarks can be extracted from leaked data"
    - "Traitor tracing identifies the user who leaked watermarked data"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Watermarking/WatermarkingStrategy.cs"
      provides: "Forensic watermarking with traitor tracing"
      min_lines: 400
    - path: "DataWarehouse.Tests/Security/WatermarkingStrategyTests.cs"
      provides: "Test suite covering generation, embedding, extraction, tracing"
      min_lines: 250
  key_links:
    - from: "WatermarkingStrategy.cs"
      to: "AccessControlStrategyBase"
      via: "inheritance"
      pattern: "class WatermarkingStrategy : AccessControlStrategyBase"
    - from: "WatermarkingStrategyTests.cs"
      to: "WatermarkingStrategy"
      via: "test instantiation"
      pattern: "new WatermarkingStrategy\\(\\)"
---

<objective>
Verify and test forensic watermarking with traitor tracing (T89). WatermarkingStrategy.cs implements per-user watermark generation, embedding in binary/text, extraction, and leak source identification. Create comprehensive test suite validating end-to-end watermarking workflow.

Purpose: Confirm forensic watermarking enables leak detection and attribution
Output: Complete test suite validating all T89 requirements
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-advanced-security/09-RESEARCH.md

# Existing implementation
@Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Watermarking/WatermarkingStrategy.cs

# SDK contracts
@DataWarehouse.SDK/Security/AccessControlStrategyBase.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify watermarking implementation completeness</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Watermarking/WatermarkingStrategy.cs
  </files>
  <action>
    Read WatermarkingStrategy.cs and verify T89 sub-tasks:

    **Watermark generation:**
    - GenerateWatermark creates unique watermark per user/resource
    - WatermarkPayload contains: WatermarkId, UserId, ResourceId, Timestamp
    - Payload signed with HMAC-SHA256 for integrity
    - WatermarkData (32 bytes) derived from payload + signature
    - Watermark records stored in _watermarks dictionary

    **Binary embedding:**
    - EmbedInBinary embeds watermark in binary data (PDFs, images, documents)
    - Spread-spectrum embedding at pseudo-random positions
    - Watermark survives format conversions and minor transformations
    - ExtractFromBinary recovers watermark from binary data

    **Text embedding:**
    - EmbedInText embeds watermark in text using whitespace encoding or zero-width characters
    - Preserves visible text content
    - ExtractFromText recovers watermark from text

    **Traitor tracing:**
    - TraceWatermark finds matching watermark record
    - Returns TraitorInfo with UserId, ResourceId, AccessTimestamp, Metadata
    - Watermark registry enables fast lookup
    - Collision resistance via SHA256 (2^256 space)

    **Watermark record management:**
    - WatermarkRecord persistence (in-memory or durable storage)
    - Load all records during initialization
    - Multi-node registry synchronization (if distributed)

    Research notes:
    - Spread-spectrum embedding more robust than LSB
    - Survives JPEG compression, format conversion, minor edits
    - Cryptographic watermarks for evidence admissibility
    - False positive rate < 0.01% for traitor tracing

    Verify build passes with zero errors.
  </action>
  <verify>
    Grep for "GenerateWatermark", "EmbedInBinary", "EmbedInText", "ExtractFromBinary", "ExtractFromText", "TraceWatermark" confirms all methods exist.

    Grep for "NotImplementedException" returns zero.

    Grep for "HMAC-SHA256" or "HMACSHA256" confirms cryptographic signing.

    Build passes with zero errors.
  </verify>
  <done>
    Watermarking strategy verified complete with generation, binary/text embedding, extraction, traitor tracing. Registry management documented. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create forensic watermarking test suite</name>
  <files>
    DataWarehouse.Tests/Security/WatermarkingStrategyTests.cs
  </files>
  <action>
    Create comprehensive xUnit test suite for forensic watermarking:

    **Watermark generation tests:**
    - GenerateWatermark creates unique watermark with WatermarkId, UserId, ResourceId
    - Watermark payload signed with HMAC-SHA256
    - WatermarkData is 32 bytes
    - Multiple watermarks for same user have distinct WatermarkIds
    - Watermark records stored for later tracing

    **Binary embedding tests:**
    - EmbedInBinary embeds watermark in PDF data
    - EmbedInBinary embeds watermark in PNG image data
    - EmbedInBinary embeds watermark in generic binary data
    - Embedded watermark doesn't visibly alter content (file size increase < 1%)
    - ExtractFromBinary recovers exact watermark byte-for-byte

    **Text embedding tests:**
    - EmbedInText embeds watermark using whitespace encoding
    - EmbedInText preserves visible text (strcmp identical)
    - ExtractFromText recovers exact watermark
    - Text watermark survives copy-paste operations

    **Watermark robustness tests:**
    - Watermark survives JPEG compression (quality 85%)
    - Watermark survives format conversion (PNG → JPEG → PNG)
    - Watermark survives minor text edits (1-2 character changes)
    - ExtractFromBinary returns null if watermark corrupted beyond recovery

    **Traitor tracing tests:**
    - TraceWatermark identifies user from extracted watermark
    - Returns correct UserId, ResourceId, AccessTimestamp
    - Metadata includes original access context (IP, client)
    - TraceWatermark returns null for unregistered watermarks

    **Collision resistance tests:**
    - Two watermarks for different users have different WatermarkData (SHA256 collision resistance)
    - Watermark registry lookup handles large numbers of watermarks (10k+)

    **Registry management tests:**
    - Watermark records persist across strategy re-initialization
    - Record storage path configurable
    - Registry load/save operations

    **False positive tests:**
    - Random data doesn't produce false watermark extraction
    - Non-watermarked files return null from ExtractFromBinary/ExtractFromText
    - False positive rate < 0.01% over 10k random samples

    **End-to-end leak scenario:**
    - Generate watermark for user "alice@company.com"
    - Embed in confidential PDF document
    - Distribute watermarked document
    - Simulate leak: extract watermark from leaked document
    - Trace watermark back to alice@company.com
    - Retrieve access metadata (timestamp, IP, etc.)

    Use synthetic test data (small PDF/PNG/text). Use SHA256 for watermark hashing. Use HMAC-SHA256 for signing. FluentAssertions for assertions.
  </action>
  <verify>
    `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter FullyQualifiedName~WatermarkingStrategyTests` passes with 100% success rate.

    Test count >= 15 methods covering generation, binary embedding, text embedding, extraction, traitor tracing, robustness, false positives, end-to-end scenario.

    Build passes with zero errors.
  </verify>
  <done>
    WatermarkingStrategyTests.cs exists with comprehensive test coverage. All tests pass. Zero build errors. Test coverage validates: generation, binary/text embedding, extraction, traitor tracing, robustness, false positive rate, end-to-end leak scenario.
  </done>
</task>

</tasks>

<verification>
Build verification:
```bash
dotnet build Plugins/DataWarehouse.Plugins.UltimateAccessControl/DataWarehouse.Plugins.UltimateAccessControl.csproj --no-restore
```

Test execution:
```bash
dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter FullyQualifiedName~WatermarkingStrategyTests --no-build
```

Implementation check:
```bash
grep -c "GenerateWatermark\|EmbedInBinary\|EmbedInText\|ExtractFromBinary\|ExtractFromText\|TraceWatermark" Plugins/DataWarehouse.Plugins.UltimateAccessControl/Strategies/Watermarking/WatermarkingStrategy.cs
# Should return 6 (one per method)
```
</verification>

<success_criteria>
1. WatermarkingStrategy.cs verified complete with generation, embedding, extraction, traitor tracing
2. Cryptographic signing (HMAC-SHA256) and spread-spectrum embedding confirmed
3. WatermarkingStrategyTests.cs created with comprehensive test coverage
4. All tests pass with 100% success rate including robustness and false positive checks
5. Build succeeds with zero errors
6. Test coverage validates: generation, binary/text embedding, extraction, traitor tracing, robustness, false positives, end-to-end leak scenario
</success_criteria>

<output>
After completion, create `.planning/phases/09-advanced-security/09-06-SUMMARY.md`
</output>
