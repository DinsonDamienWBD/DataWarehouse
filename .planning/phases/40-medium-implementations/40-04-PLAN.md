---
phase: 40-medium-implementations
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateConnector/Strategies/Healthcare/DicomConnectionStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateConnector/Strategies/Healthcare/Hl7v2ConnectionStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateConnector/Strategies/Healthcare/FhirR4ConnectionStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateConnector/Strategies/Healthcare/HealthcareDataTypes.cs
  - Plugins/DataWarehouse.Plugins.UltimateConnector/DataWarehouse.Plugins.UltimateConnector.csproj
autonomous: true

must_haves:
  truths:
    - "DICOM files can be parsed into structured DicomStudy/DicomImage objects with pixel data access"
    - "HL7 v2 messages can be parsed into structured segments (MSH, PID, PV1, OBR, OBX)"
    - "FHIR R4 resources can be deserialized into typed objects (Patient, Observation, etc.)"
    - "All three parsers produce first-class objects, not binary blobs"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateConnector/Strategies/Healthcare/HealthcareDataTypes.cs"
      provides: "DicomStudy, DicomImage, Hl7ParsedMessage, Hl7Segment, FhirResourceWrapper types"
      min_lines: 80
    - path: "Plugins/DataWarehouse.Plugins.UltimateConnector/Strategies/Healthcare/DicomConnectionStrategy.cs"
      provides: "ParseDicomFileAsync method returning structured DicomStudy"
      contains: "ParseDicomFileAsync"
    - path: "Plugins/DataWarehouse.Plugins.UltimateConnector/Strategies/Healthcare/Hl7v2ConnectionStrategy.cs"
      provides: "ParseHl7MessageAsync method returning structured Hl7ParsedMessage"
      contains: "ParseHl7MessageAsync"
    - path: "Plugins/DataWarehouse.Plugins.UltimateConnector/Strategies/Healthcare/FhirR4ConnectionStrategy.cs"
      provides: "DeserializeResourceAsync method returning structured FHIR resources"
      contains: "DeserializeResourceAsync"
  key_links:
    - from: "DicomConnectionStrategy"
      to: "HealthcareDataTypes"
      via: "returns DicomStudy from ParseDicomFileAsync"
      pattern: "DicomStudy"
---

<objective>
Add format-level parsing to existing DICOM, HL7 v2, and FHIR R4 connector strategies. Currently these strategies handle connections only -- they cannot parse medical data formats into structured objects.

Purpose: IMPL-04 requires parsing DICOM pixel data, HL7 message segments, and FHIR resource deserialization into first-class queryable objects (not binary blobs).

Output: Parse methods added to all three healthcare strategies plus supporting data types. Uses fo-dicom NuGet for DICOM, manual parsing for HL7 v2 (standard delimiters), and System.Text.Json for FHIR R4 (conformant JSON representation).
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS-v3.md
@Plugins/DataWarehouse.Plugins.UltimateConnector/Strategies/Healthcare/DicomConnectionStrategy.cs
@Plugins/DataWarehouse.Plugins.UltimateConnector/Strategies/Healthcare/Hl7v2ConnectionStrategy.cs
@Plugins/DataWarehouse.Plugins.UltimateConnector/Strategies/Healthcare/FhirR4ConnectionStrategy.cs
@Plugins/DataWarehouse.Plugins.UltimateConnector/DataWarehouse.Plugins.UltimateConnector.csproj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create healthcare data types and add DICOM parsing</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateConnector/Strategies/Healthcare/HealthcareDataTypes.cs
    Plugins/DataWarehouse.Plugins.UltimateConnector/Strategies/Healthcare/DicomConnectionStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateConnector/DataWarehouse.Plugins.UltimateConnector.csproj
  </files>
  <action>
**Step 1: Create healthcare data types** in `HealthcareDataTypes.cs`:

```
namespace DataWarehouse.Plugins.UltimateConnector.Strategies.Healthcare;
```

DICOM types:
- `DicomStudy` record: StudyInstanceUid, PatientId, PatientName, Modality, StudyDate, StudyDescription, Series (List of DicomSeries)
- `DicomSeries` record: SeriesInstanceUid, SeriesNumber, Modality, SeriesDescription, Images (List of DicomImage)
- `DicomImage` record: SopInstanceUid, InstanceNumber, Rows, Columns, BitsAllocated, PhotometricInterpretation, PixelDataLength, Metadata (Dictionary of string,string)

HL7 v2 types:
- `Hl7ParsedMessage` record: MessageType, MessageControlId, Timestamp, SendingApplication, SendingFacility, Segments (List of Hl7Segment), RawMessage
- `Hl7Segment` record: SegmentId, Fields (List of Hl7Field)
- `Hl7Field` record: Index, Value, Components (List of string -- for component-separated values)

FHIR R4 types:
- `FhirResourceWrapper` record: ResourceType, Id, Meta (FhirMeta), RawJson (string), ParsedFields (Dictionary of string,object)
- `FhirMeta` record: VersionId, LastUpdated, Profile (List of string)
- `FhirPatient` record: Id, Active, Name (List of FhirHumanName), Gender, BirthDate, Address, Telecom
- `FhirHumanName` record: Use, Family, Given (List of string), Text
- `FhirObservation` record: Id, Status, Code, Subject, EffectiveDateTime, ValueQuantity (FhirQuantity)
- `FhirQuantity` record: Value (decimal?), Unit, System, Code

**Step 2: Add NuGet package for DICOM to UltimateConnector.csproj:**
Add `<PackageReference Include="fo-dicom" Version="5.1.4" />` to the csproj file. fo-dicom is the standard .NET DICOM library.

**Step 3: Add DICOM parsing to DicomConnectionStrategy:**
Add method to `DicomConnectionStrategy`:

`public async Task<DicomStudy> ParseDicomFileAsync(Stream stream, CancellationToken ct = default)`:
1. Use `FellowOakDicom.DicomFile.OpenAsync(stream)` to load the DICOM file
2. Extract dataset from the DicomFile
3. Read patient demographics: PatientID (0010,0020), PatientName (0010,0010)
4. Read study info: StudyInstanceUID (0020,000D), Modality (0008,0060), StudyDate (0008,0020), StudyDescription (0008,1030)
5. Read image info: Rows (0028,0010), Columns (0028,0011), BitsAllocated (0028,0100), PhotometricInterpretation (0028,0004)
6. Check if PixelData (7FE0,0010) exists -- report its length
7. Build and return DicomStudy with nested DicomSeries and DicomImage

Also add `public async Task<DicomImage> ParseDicomImageAsync(Stream stream, CancellationToken ct = default)` for single-image parsing.

Keep ALL existing methods (ConnectCoreAsync, TestCoreAsync, DisconnectCoreAsync, GetHealthCoreAsync, ValidateHl7Async, QueryFhirAsync) completely unchanged. Only ADD new methods.
  </action>
  <verify>Build: `dotnet build Plugins/DataWarehouse.Plugins.UltimateConnector/DataWarehouse.Plugins.UltimateConnector.csproj`</verify>
  <done>DICOM parsing works via fo-dicom. DicomStudy/DicomImage types exist. ParseDicomFileAsync extracts structured metadata and pixel data info from DICOM streams.</done>
</task>

<task type="auto">
  <name>Task 2: Add HL7 v2 and FHIR R4 parsing</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateConnector/Strategies/Healthcare/Hl7v2ConnectionStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateConnector/Strategies/Healthcare/FhirR4ConnectionStrategy.cs
  </files>
  <action>
**HL7 v2 Parsing (manual, no NuGet):**

Add to `Hl7v2ConnectionStrategy`:

`public Task<Hl7ParsedMessage> ParseHl7MessageAsync(string hl7Message, CancellationToken ct = default)`:
1. Split message on `\r` (CR) or `\r\n` (CR+LF) to get segments
2. For each segment:
   - Extract segment ID (first 3 chars, e.g., "MSH", "PID", "PV1")
   - Split on field separator `|` (from MSH-1)
   - For each field, split on component separator `^` (from MSH-2 first char)
   - Build Hl7Segment with Hl7Field entries
3. Extract header info from MSH segment:
   - MSH-3: Sending Application
   - MSH-4: Sending Facility
   - MSH-7: Timestamp
   - MSH-9: Message Type (e.g., ADT^A01)
   - MSH-10: Message Control ID
4. Return Hl7ParsedMessage with all segments and header info

Also add `public Task<Hl7Segment?> GetSegmentAsync(Hl7ParsedMessage message, string segmentId, CancellationToken ct = default)`:
- Find first segment matching segmentId
- Return null if not found

Also add `public Task<string?> GetFieldValueAsync(Hl7ParsedMessage message, string segmentId, int fieldIndex, CancellationToken ct = default)`:
- Find segment, return field value at index
- Return null if segment or field not found

HL7 v2 is a pipe-delimited format -- no NuGet needed for parsing. The encoding characters (field separator, component separator, repetition separator, escape char, subcomponent separator) are defined in MSH-1 and MSH-2.

Keep ALL existing methods unchanged. Only ADD new methods.

**FHIR R4 Parsing (System.Text.Json, no NuGet):**

Add to `FhirR4ConnectionStrategy`:

`public Task<FhirResourceWrapper> DeserializeResourceAsync(string json, CancellationToken ct = default)`:
1. Parse JSON using System.Text.Json.JsonDocument
2. Extract resourceType from root
3. Extract id, meta.versionId, meta.lastUpdated, meta.profile
4. Store raw JSON for full fidelity
5. Extract common fields into ParsedFields dictionary
6. Return FhirResourceWrapper

`public Task<FhirPatient?> DeserializePatientAsync(string json, CancellationToken ct = default)`:
1. Parse JSON, verify resourceType == "Patient"
2. Extract: id, active, name (array of HumanName), gender, birthDate
3. For each name: extract use, family, given (array), text
4. Return FhirPatient or null if not a Patient resource

`public Task<FhirObservation?> DeserializeObservationAsync(string json, CancellationToken ct = default)`:
1. Parse JSON, verify resourceType == "Observation"
2. Extract: id, status, code, subject.reference, effectiveDateTime
3. Extract valueQuantity if present: value, unit, system, code
4. Return FhirObservation or null

FHIR R4 JSON format is well-defined. Use System.Text.Json (already the project standard per STATE.md decisions). Do NOT add Hl7.Fhir.R4 NuGet (heavy dependency, pulls in many transitive packages). Manual JSON parsing is sufficient for the core resource types.

Keep ALL existing methods unchanged. Only ADD new methods.
  </action>
  <verify>Build: `dotnet build Plugins/DataWarehouse.Plugins.UltimateConnector/DataWarehouse.Plugins.UltimateConnector.csproj`</verify>
  <done>HL7 v2 parsing produces structured Hl7ParsedMessage with segments and fields. FHIR R4 parsing produces typed Patient/Observation resources. All existing connection methods unchanged.</done>
</task>

</tasks>

<verification>
1. `dotnet build Plugins/DataWarehouse.Plugins.UltimateConnector/DataWarehouse.Plugins.UltimateConnector.csproj` -- zero new errors
2. Grep confirms DICOM parsing: `grep -r "ParseDicomFileAsync" Plugins/DataWarehouse.Plugins.UltimateConnector/`
3. Grep confirms HL7 parsing: `grep -r "ParseHl7MessageAsync" Plugins/DataWarehouse.Plugins.UltimateConnector/`
4. Grep confirms FHIR parsing: `grep -r "DeserializeResourceAsync" Plugins/DataWarehouse.Plugins.UltimateConnector/`
5. All existing ConnectCoreAsync/TestCoreAsync/etc. methods unchanged (verify via diff)
</verification>

<success_criteria>
- DICOM parsing extracts patient info, study metadata, image dimensions, and pixel data length from DICOM files using fo-dicom
- HL7 v2 parsing splits pipe-delimited messages into structured segments and fields (MSH, PID, PV1, OBR, OBX)
- FHIR R4 parsing deserializes Patient and Observation resources from JSON into typed objects
- All existing connection-level methods completely unchanged
- Only one new NuGet package (fo-dicom) added
- Plugin project builds with zero new errors
</success_criteria>

<output>
After completion, create `.planning/phases/40-medium-implementations/40-04-SUMMARY.md`
</output>
