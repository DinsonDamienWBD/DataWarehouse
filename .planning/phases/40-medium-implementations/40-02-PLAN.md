---
phase: 40-medium-implementations
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.SDK/Infrastructure/Distributed/Discovery/MdnsServiceDiscovery.cs
  - DataWarehouse.SDK/Infrastructure/Distributed/Discovery/ZeroConfigClusterBootstrap.cs
  - DataWarehouse.SDK/DataWarehouse.SDK.csproj
autonomous: true

must_haves:
  truths:
    - "DataWarehouse instances announce themselves on the local network via mDNS"
    - "DataWarehouse instances discover other instances on the network without configuration"
    - "Discovered instances auto-join the SWIM cluster within 30 seconds"
    - "Zero configuration files are needed for cluster formation"
  artifacts:
    - path: "DataWarehouse.SDK/Infrastructure/Distributed/Discovery/MdnsServiceDiscovery.cs"
      provides: "mDNS service announcer and listener for _datawarehouse._tcp.local"
      min_lines: 120
    - path: "DataWarehouse.SDK/Infrastructure/Distributed/Discovery/ZeroConfigClusterBootstrap.cs"
      provides: "Wires mDNS discovery to SwimClusterMembership.JoinAsync"
      min_lines: 80
  key_links:
    - from: "ZeroConfigClusterBootstrap"
      to: "SwimClusterMembership"
      via: "calls JoinAsync with discovered seed nodes"
      pattern: "JoinAsync"
    - from: "ZeroConfigClusterBootstrap"
      to: "MdnsServiceDiscovery"
      via: "subscribes to OnServiceDiscovered event"
      pattern: "OnServiceDiscovered"
---

<objective>
Implement zero-configuration cluster discovery using mDNS/DNS-SD so DataWarehouse instances automatically find each other on the local network and form clusters without any configuration files.

Purpose: IMPL-02 requires zero-config clustering with <30s join time. Currently SwimClusterMembership (Phase 29) requires explicit seed nodes via JoinAsync(seedNodes). This plan adds automatic service announcement and discovery via mDNS multicast DNS.

Output: MdnsServiceDiscovery (announce/discover) and ZeroConfigClusterBootstrap (wire discovery to SWIM membership), both in SDK.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS-v3.md
@DataWarehouse.SDK/Infrastructure/Distributed/Membership/SwimClusterMembership.cs
@DataWarehouse.SDK/Contracts/Distributed/IClusterMembership.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement mDNS service discovery</name>
  <files>
    DataWarehouse.SDK/Infrastructure/Distributed/Discovery/MdnsServiceDiscovery.cs
    DataWarehouse.SDK/DataWarehouse.SDK.csproj
  </files>
  <action>
Create `DataWarehouse.SDK/Infrastructure/Distributed/Discovery/` directory.

Create `MdnsServiceDiscovery` class implementing mDNS/DNS-SD service announcement and discovery using raw UDP multicast (no NuGet dependency -- build on System.Net.Sockets).

**Why no NuGet:** The Makaretu.Dns package targets older .NET versions and may have compatibility issues with .NET 10. mDNS is a simple protocol (RFC 6762) -- a minimal implementation is more reliable than a full library.

**mDNS Protocol Essentials:**
- Multicast address: 224.0.0.251 (IPv4) / ff02::fb (IPv6), port 5353
- Service type: `_datawarehouse._tcp.local`
- TXT record: `nodeId={nodeId}&port={port}&version={version}`

**Class: `MdnsServiceDiscovery : IDisposable`**

Constructor: `(string nodeId, string address, int port, MdnsConfiguration? config = null)`

Public methods:
1. `StartAnnouncingAsync(CancellationToken ct)`: Join multicast group, send mDNS announcement (SRV + TXT record) every `announceIntervalMs` (default 10_000ms). Send 3 rapid announcements at startup (0ms, 1000ms, 2000ms) per RFC 6762 probing.
2. `StartListeningAsync(CancellationToken ct)`: Join multicast group, listen for mDNS responses matching `_datawarehouse._tcp.local`. Parse SRV + TXT records to extract nodeId, address, port.
3. `StopAsync()`: Leave multicast group, stop announcing and listening.
4. `GetDiscoveredServices()`: returns `IReadOnlyList<DiscoveredService>` -- bounded to 100 entries (MEM-03).

Events:
- `event Action<DiscoveredService>? OnServiceDiscovered` -- fires when a new DataWarehouse instance is found
- `event Action<string>? OnServiceLost` -- fires when an instance stops announcing (TTL expiry)

Supporting types:
- `DiscoveredService` record: NodeId, Address, Port, Version, DiscoveredAt
- `MdnsConfiguration` record: AnnounceIntervalMs (default 10_000), MulticastAddress (default "224.0.0.251"), Port (default 5353), Ttl (default 120s), MaxDiscoveredServices (default 100)

**mDNS Packet Format (minimal implementation):**
Build DNS packet manually using BinaryWriter:
- Header (12 bytes): Transaction ID (0 for mDNS), Flags (0x8400 for response), QDCOUNT, ANCOUNT, NSCOUNT, ARCOUNT
- Answer section: name (`_datawarehouse._tcp.local`), type (SRV=33), class (IN=1), TTL, RDATA (priority, weight, port, target)
- Additional section: TXT record with key-value pairs

Parse incoming packets using BinaryReader with the same format.

Use `UdpClient` with `JoinMulticastGroup`. Handle `SocketException` gracefully when multicast is not available (e.g., no network interface). Log but do not throw.

Mark with `[SdkCompatibility("3.0.0", Notes = "Phase 40: Zero-config mDNS discovery")]`.

Do NOT add any NuGet packages to SDK.csproj. Use only System.Net.Sockets and System.Net primitives.
  </action>
  <verify>Build: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj`</verify>
  <done>MdnsServiceDiscovery compiles, implements mDNS announcement and listening via raw UDP multicast, fires OnServiceDiscovered events when peers are found.</done>
</task>

<task type="auto">
  <name>Task 2: Wire mDNS discovery to SWIM cluster membership</name>
  <files>DataWarehouse.SDK/Infrastructure/Distributed/Discovery/ZeroConfigClusterBootstrap.cs</files>
  <action>
Create `ZeroConfigClusterBootstrap` class that wires mDNS discovery to SwimClusterMembership auto-join.

**Class: `ZeroConfigClusterBootstrap : IDisposable`**

Constructor: `(IClusterMembership membership, MdnsServiceDiscovery discovery, ZeroConfigOptions? options = null)`

Public methods:
1. `StartAsync(CancellationToken ct)`:
   - Start mDNS announcing (makes this node visible)
   - Start mDNS listening (discovers other nodes)
   - Subscribe to `discovery.OnServiceDiscovered`
   - When a new service is discovered: check if already a known member (call `membership.GetMembers()` to check), if not, call `membership.JoinAsync()` with the discovered node as seed
   - Use a debounce mechanism: if multiple discoveries happen within 2 seconds, batch them into a single JoinAsync call
   - Log discovery events

2. `StopAsync()`:
   - Stop mDNS discovery
   - Optionally call `membership.LeaveAsync("Shutting down")` (configurable via options)

Supporting types:
- `ZeroConfigOptions` record: AutoLeaveOnStop (default true), DiscoveryDebounceMs (default 2000), MaxJoinAttempts (default 3), JoinRetryDelayMs (default 5000)

Thread safety: Use SemaphoreSlim for join serialization (only one join operation at a time).

Error handling: If JoinAsync fails (network error, node unreachable), retry up to MaxJoinAttempts with exponential backoff. Log failures but do not throw.

Mark with `[SdkCompatibility("3.0.0", Notes = "Phase 40: Zero-config cluster bootstrap")]`.
  </action>
  <verify>Build: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj`</verify>
  <done>ZeroConfigClusterBootstrap wires mDNS discovery to SwimClusterMembership.JoinAsync. New nodes auto-join the cluster within 30 seconds of discovery. Zero configuration files needed.</done>
</task>

</tasks>

<verification>
1. `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` -- zero new errors
2. Grep confirms mDNS implementation: `grep -r "_datawarehouse._tcp.local" DataWarehouse.SDK/`
3. Grep confirms bootstrap wires to SWIM: `grep -r "JoinAsync" DataWarehouse.SDK/Infrastructure/Distributed/Discovery/`
4. Both files have [SdkCompatibility] attribute
</verification>

<success_criteria>
- MdnsServiceDiscovery announces and discovers DataWarehouse instances via mDNS multicast
- ZeroConfigClusterBootstrap auto-joins discovered instances to SWIM cluster
- No new NuGet packages added to SDK
- Zero configuration files needed for cluster formation
- SDK project builds with zero new errors
</success_criteria>

<output>
After completion, create `.planning/phases/40-medium-implementations/40-02-SUMMARY.md`
</output>
