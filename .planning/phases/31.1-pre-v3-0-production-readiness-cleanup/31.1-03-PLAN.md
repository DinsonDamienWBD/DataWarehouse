# Plan 31.1-03: Interface Bus Calls + Format Strategies + Scattered Fixes

## Goal
Replace UltimateInterface placeholder bus calls with real message bus integration, implement UltimateDataFormat stub strategies (including Parquet/Arrow/HDF5 pulled forward from Phase 40-05), and fix all remaining scattered placeholders.

## Tasks

### Task 1: UltimateInterface Message Bus Integration (30+ methods)
**TARGET:** `Plugins/DataWarehouse.Plugins.UltimateInterface/`
**Why here:** Interface strategies are UltimateInterface's domain — they expose the system's data via REST/WebSocket/GraphQL/etc. The placeholder bus calls return mock data instead of delegating to the storage/pipeline layer. Each strategy should use `MessageBus.RequestAsync` to reach the appropriate backend plugin (e.g., `storage.read` → UltimateStorage, `pipeline.execute` → pipeline orchestrator).

**Pattern:** Replace `await Task.CompletedTask; // Placeholder for actual bus call` + mock data return with real `MessageBus.RequestAsync<TRequest, TResponse>()` calls.

**REST Strategies (5 strategies, ~23 bus calls):**
1. RestInterfaceStrategy — 6 placeholder bus calls → real CRUD via `storage.read/write/delete` topics
2. ODataStrategy — 5 placeholder bus calls → real query/filter via `storage.query` topic
3. JsonApiStrategy — 4 placeholder bus calls → real resource operations via `storage.read/write` topics
4. HateoasStrategy — 5 placeholder bus calls → real hypermedia operations via `storage.read` + link resolution
5. FalcorStrategy — 3 placeholder bus calls → real JSON graph operations via `storage.graph.query` topic

**RealTime Strategies (5 strategies, ~14 bus calls):**
6. WebSocketInterfaceStrategy — 3 placeholder bus calls → `streaming.subscribe/publish` topics
7. SocketIoStrategy — 3 placeholder bus calls → `streaming.subscribe/publish` topics
8. SignalRStrategy — 4 placeholder bus calls → `streaming.subscribe/publish/group` topics
9. ServerSentEventsStrategy — 2 placeholder bus calls → `streaming.subscribe` topic
10. LongPollingStrategy — 2 placeholder bus calls → `storage.poll` topic

**Security Strategies (2 strategies):**
11. EdgeCachedApiStrategy — 1 placeholder service call → `cache.read` topic
12. CostAwareApiStrategy — 1 placeholder service call → `metering.estimate` topic

**Query Strategy:**
13. GraphQLInterfaceStrategy — mock data structure → real `storage.query.graphql` topic

**Implementation Pattern:**
```csharp
// Before (placeholder):
await Task.CompletedTask; // Placeholder for actual bus call
return new { id = 1, name = "Sample Resource" };

// After (real):
var response = await MessageBus.RequestAsync<StorageRequest, StorageResponse>(
    "storage.read", new StorageRequest { Key = key }, cancellationToken);
return response?.Data ?? throw new InvalidOperationException("No storage response");
```

### Task 2: UltimateDataFormat Strategy Implementations (14 strategies)
**TARGET:** `Plugins/DataWarehouse.Plugins.UltimateDataFormat/`
**Why here:** Format parsing/serialization is UltimateDataFormat's domain. Each format strategy detects and parses a specific data format. These are self-contained — no cross-plugin delegation needed.

**PULLED FORWARD FROM PHASE 40-05:** Parquet, Arrow, and HDF5 implementations are pulled into Phase 31.1 to avoid leaving stubs. Phase 40-05 plan will be updated with a pre-completion note.

**Option A — Implement with NuGet packages (pulled from Phase 40-05):**
- **Parquet** — Add `Parquet.Net` NuGet package. Real ParseAsync using `ParquetReader`, SerializeAsync using `ParquetWriter`, ExtractSchemaCoreAsync with real column definitions. Keep DetectFormatCoreAsync unchanged.
- **Arrow** — Add `Apache.Arrow` NuGet package. New ArrowStrategy with `ArrowFileReader`/`ArrowFileWriter` for Apache Arrow IPC format. Detection via "ARROW1" magic bytes.
- **HDF5** — Managed binary parser (NO native PInvoke dependency). Read superblock, symbol tables, object headers to extract hierarchical group/dataset structure with dimensions and types. Metadata parser sufficient for catalog/discovery.

**Option B — Implement with .NET BCL APIs (no NuGet needed):**
- Protobuf: Implement basic protobuf wire format parsing (varint + length-delimited)
- MessagePack: Implement basic msgpack binary parsing (type codes + payloads)
- Avro: Implement basic Avro container format reading (sync markers + schema header)
- Shapefile: Read .shp header + record structure (simple binary format)

**Option C — Convert to "driver required" pattern (for native/Java-only libraries):**
For formats that genuinely need native libraries (NetCDF, VTK, CGNS, GeoTIFF, FITS, STEP, DICOM, OpenEXR):
- Keep detection working (magic bytes)
- Replace stub with proper `DataFormatResult.Fail(DataFormatErrorCode.DriverRequired, "Format detected as X. Install NuGet package Y to enable parsing.")`
- This is a LEGITIMATE production pattern — format detection works, parsing requires driver installation

### Task 3: Scattered Fixes (~10 methods across 7 plugins)

1. **UltimateKeyManagement** (3 fixes)
   **TARGET:** `Plugins/DataWarehouse.Plugins.UltimateKeyManagement/`
   **Why here:** Key management strategies are KeyManagement's domain. Threshold ECDSA, key rotation, and FIDO2 are all cryptographic key operations — not encryption (UltimateEncryption) or access control (UltimateAccessControl).
   - ThresholdEcdsaStrategy: Real MtA protocol scalar computation
   - ZeroDowntimeRotation: Real rotation work (not Task.Delay)
   - SoloKeyStrategy: Real FIDO2 key generation pattern

2. **UltimateSustainability** (4 fixes)
   **TARGET:** `Plugins/DataWarehouse.Plugins.UltimateSustainability/`
   **Why here:** Power management and energy efficiency are Sustainability's domain. These use OS-level APIs (WMI/ACPI) — no cross-plugin delegation needed.
   - WorkloadConsolidation, SleepStates, PowerCapping: Use real OS power APIs (Win32 `PowerSetActiveScheme`, Linux sysfs)
   - UpsIntegration: Real UPS status query via WMI `Win32_Battery` / ACPI

3. **UltimateCompliance** (3 fixes)
   **TARGET:** `Plugins/DataWarehouse.Plugins.UltimateCompliance/`
   **Why here:** Compliance enforcement is UltimateCompliance's domain. Data retention DELEGATES deletion to storage via message bus. Geolocation and TPM attestation are local compliance checks.
   - DataRetentionPolicy: Real deletion via MessageBus.PublishAsync to `storage.delete.retention` topic (delegated to UltimateStorage)
   - GeolocationService: Real geo lookup (IP-based, no external API — use IP range tables)
   - Attestation: Real TPM query via TBS API on Windows / `/sys/class/tpm` on Linux

4. **Others** (1 fix each, various plugins)
   - **AirGapBridge** (`Plugins/DataWarehouse.Plugins.AirGapBridge/`): Load real blob from storage via MessageBus.RequestAsync to `storage.read.blob` topic
   - **UltimateIntelligence** (`Plugins/DataWarehouse.Plugins.UltimateIntelligence/`): AutoML schema extraction — real implementations (not NotImplementedException)
   - **UltimateDatabaseProtocol** (`Plugins/DataWarehouse.Plugins.UltimateDatabaseProtocol/`): Fix compression providers — use `System.IO.Compression` APIs (DeflateStream, GZipStream, BrotliStream)
   - **DataMarketplace** (`Plugins/DataWarehouse.Plugins.DataMarketplace/`): Real deployment via MessageBus.PublishAsync to `deployment.marketplace.publish` topic
   - **Transcoding.Media** (`Plugins/DataWarehouse.Plugins.Transcoding.Media/`): Real file length calculation using stream position/length
   - **UltimateServerless** (`Plugins/DataWarehouse.Plugins.UltimateServerless/`): Real invocation via MessageBus.RequestAsync to `serverless.invoke` topic

### Task 4: Update PLUGIN-CATALOG.md

Update completeness status for all 17 affected plugins to reflect post-fix state.

## Placement Audit Summary
- UltimateInterface: owns API exposure strategies, DELEGATES to storage/streaming/pipeline via message bus
- UltimateDataFormat: owns format parsing — self-contained, no cross-plugin delegation
- UltimateKeyManagement: owns key lifecycle — crypto key ops, not encryption or access control
- UltimateSustainability: owns power management — OS-level APIs, no cross-plugin delegation
- UltimateCompliance: owns compliance — DELEGATES deletion to storage via message bus
- Scattered fixes: each targets the plugin that OWNS the functionality

## Success Criteria
- [ ] UltimateInterface strategies use real MessageBus for all data operations
- [ ] UltimateDataFormat: Parquet/Arrow/HDF5 have real parsing, common formats implemented, rare formats have clear driver-required messages
- [ ] All scattered placeholders replaced with real implementations
- [ ] PLUGIN-CATALOG.md reflects current state
- [ ] Full solution builds with 0 new errors
- [ ] Zero instances of "Placeholder", "Simulated", "mock data" in strategy method bodies
