---
phase: 04-compliance-storage-replication
plan: 04
type: execute
wave: 2
depends_on: ["04-03"]
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateReplication/UltimateReplicationPlugin.cs
  - Plugins/DataWarehouse.Plugins.UltimateReplication/ReplicationStrategyBase.cs
  - Plugins/DataWarehouse.Plugins.UltimateReplication/Strategies/**/*.cs
  - Plugins/DataWarehouse.Plugins.UltimateReplication/Features/*.cs
  - Metadata/TODO.md
autonomous: true

must_haves:
  truths:
    - "UltimateReplication plugin orchestrator discovers and registers all 63+ replication strategies"
    - "Phase C advanced features (global transaction coordination, ML conflict resolution, bandwidth-aware scheduling, cross-cloud replication, RAID/storage integration) are implemented"
    - "Phase D migration (references updated, migration guide, deprecation) is complete"
    - "Geo-dispersed WORM replication (T5.5) enables cross-region WORM replication via message bus integration with storage and compliance"
    - "Geo-distributed sharding (T5.6) enables cross-continent shard distribution with compliance-aware geo-routing"
    - "AI-dependent strategies use message bus with rule-based fallbacks"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateReplication/UltimateReplicationPlugin.cs"
      provides: "Replication plugin orchestrator with auto-discovery and conflict resolution engine"
    - path: "Plugins/DataWarehouse.Plugins.UltimateReplication/Features/GeoWormReplicationFeature.cs"
      provides: "Geo-dispersed WORM replication (T5.5)"
    - path: "Plugins/DataWarehouse.Plugins.UltimateReplication/Features/GeoDistributedShardingFeature.cs"
      provides: "Geo-distributed sharding (T5.6)"
  key_links:
    - from: "UltimateReplicationPlugin.cs"
      to: "ReplicationStrategyRegistry"
      via: "auto-discovery"
      pattern: "DiscoverStrategies|Assembly.GetExecutingAssembly"
    - from: "GeoWormReplicationFeature"
      to: "UltimateStorage"
      via: "message bus"
      pattern: "storage\\.write.*worm|storage\\.worm"
    - from: "GeoDistributedShardingFeature"
      to: "UltimateCompliance geofencing"
      via: "message bus"
      pattern: "compliance\\.geofence\\.check"
---

<objective>
Verify existing UltimateReplication strategies (T98), implement remaining Phase C advanced features, Phase D migration, and add geo-dispersed WORM replication (T5.5) and geo-distributed sharding (T5.6).

Purpose: UltimateReplication enables data durability and availability across regions. Geo-dispersed WORM and sharding are critical for compliance-driven organizations that must maintain tamper-proof copies across jurisdictions.

Output: Complete UltimateReplication plugin with 63+ strategies, advanced features, migration, and geo-dispersed capabilities. TODO.md T98, T5.5, T5.6 synced.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-compliance-storage-replication/04-RESEARCH.md
@.planning/phases/04-compliance-storage-replication/04-03-SUMMARY.md
@Plugins/DataWarehouse.Plugins.UltimateReplication/UltimateReplicationPlugin.cs
@Plugins/DataWarehouse.Plugins.UltimateReplication/ReplicationStrategyBase.cs
@Metadata/TODO.md (T98 section, lines ~8770-8953; T5.5-T5.6, lines ~3488-3493)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify UltimateReplication strategies and implement Phase C advanced features</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateReplication/UltimateReplicationPlugin.cs
    Plugins/DataWarehouse.Plugins.UltimateReplication/ReplicationStrategyBase.cs
    Plugins/DataWarehouse.Plugins.UltimateReplication/ReplicationStrategyRegistry.cs
    Plugins/DataWarehouse.Plugins.UltimateReplication/Strategies/**/*.cs
    Plugins/DataWarehouse.Plugins.UltimateReplication/Features/*.cs
  </files>
  <action>
    T98 Phase B is marked "[x] Complete (63 strategies)" but Phase C (C1-C10) is all unchecked. Verify and complete:

    1. **Verify existing strategies**: Count strategy classes across all Strategies/ subdirectories. Confirm 63+ exist. Spot-check 6 strategies (one from Core, Geo, Cloud, ActiveActive, Conflict, Topology):
       - Verify extends ReplicationStrategyBase or implements IReplicationStrategy
       - Verify real implementation (no NotImplementedException)
       - Verify XML docs

    2. **Verify orchestrator** (UltimateReplicationPlugin.cs):
       - Auto-discovery via ReplicationStrategyRegistry
       - Intelligence-aware hooks
       - Message bus handlers for replication topics (ReplicationTopics.*)
       - Conflict resolution engine wiring

    3. **Implement Phase C advanced features** (C1-C10). Create Features/ subfolder if it doesn't exist:
       - C1: GlobalTransactionCoordinationFeature — 2PC/3PC coordination across replication nodes via message bus
       - C2: SmartConflictResolutionFeature — ML-based conflict resolution using "intelligence.semantic.compare" with LWW fallback
       - C3: BandwidthAwareSchedulingFeature — schedule replication based on available bandwidth, defer large transfers to low-traffic windows
       - C4: PriorityBasedQueueFeature — replication queue with priority levels (critical, high, normal, low, background)
       - C5: PartialReplicationFeature — selective replication of data subsets based on filters/tags
       - C6: ReplicationLagMonitoringFeature — real-time lag monitoring, publish "replication.lag.alert" when threshold exceeded
       - C7: CrossCloudReplicationFeature — AWS <-> Azure <-> GCP replication via message bus to UltimateStorage
       - C8: RaidIntegrationFeature — integrate with UltimateRAID via "raid.parity.check" message bus topic
       - C9: StorageIntegrationFeature — integrate with UltimateStorage via "storage.read/write" topics
       - C10: IntelligenceIntegrationFeature — integrate with UniversalIntelligence via "intelligence.predict.conflict" with rule-based fallback

    All cross-plugin integrations MUST use message bus only. No direct plugin references.
  </action>
  <verify>
    dotnet build Plugins/DataWarehouse.Plugins.UltimateReplication/ --no-restore 2>&1 | Select-String -Pattern "error" | Select-Object -First 20
    Count strategies: Get-ChildItem -Recurse -Filter "*Strategy*.cs" Plugins/DataWarehouse.Plugins.UltimateReplication/Strategies/ | Where-Object { $_.FullName -notlike "*\obj\*" } | Measure-Object
    ls Plugins/DataWarehouse.Plugins.UltimateReplication/Features/
  </verify>
  <done>
    63+ replication strategies verified production-ready. 10 Phase C advanced features implemented with message bus integration. Build passes. TODO.md T98 Phase C sub-tasks marked [x].
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement geo-dispersed WORM replication (T5.5), geo-distributed sharding (T5.6), and Phase D migration</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateReplication/Features/GeoWormReplicationFeature.cs
    Plugins/DataWarehouse.Plugins.UltimateReplication/Features/GeoDistributedShardingFeature.cs
    Plugins/DataWarehouse.Plugins.UltimateReplication/UltimateReplicationPlugin.cs
    Metadata/TODO.md
  </files>
  <action>
    Implement T5.5 and T5.6 as features within UltimateReplication:

    1. **GeoWormReplicationFeature** (T5.5 — Geo-Dispersed WORM Replication):
       - ReplicateToWormAsync(ReplicationRequest request, GeoWormOptions options)
       - Selects target regions based on compliance requirements (check via "compliance.geofence.check" message bus topic)
       - Writes to WORM-capable storage via "storage.write" with WormMode=Compliance/Enterprise
       - Supports retention period configuration per region
       - Verifies successful WORM write via read-back and integrity check
       - Handles cross-region latency with async replication + confirmation tracking
       - Research says: interpret WORM replication as "replicate TO WORM storage" (not immutable transfer)
       - WORM mode selection: Compliance (true immutability for HIPAA/SEC/FINRA) vs Enterprise (allows privileged deletion)

    2. **GeoDistributedShardingFeature** (T5.6 — Geo-Distributed Sharding):
       - ShardAcrossContinentsAsync(ShardRequest request, GeoShardOptions options)
       - Shard distribution algorithm: hash-based with geo-awareness (prefer local region, balance across continents)
       - Compliance-aware: check geofencing via "compliance.geofence.check" before placing shard in region
       - Shard metadata tracking: which shard in which region, shard health, recovery info
       - Support erasure coding across geo-shards for fault tolerance
       - Rebuild shard from parity if region fails (via "raid.erasure.rebuild" topic)

    3. **Phase D Migration** (D1-D5):
       - D1: Wire UltimateReplicationPlugin as the canonical replication handler — subscribe to all replication.* message bus topics
       - D2: Create migration guide as XML doc comments on plugin class
       - D3: Mark old replication plugins deprecated (add [Obsolete] in doc comments noting migration)
       - D4: Defer file deletion to Phase 18 (per project convention)
       - D5: Ensure all documentation references UltimateReplication

    Wire GeoWormReplicationFeature and GeoDistributedShardingFeature into UltimateReplicationPlugin orchestrator.

    Update TODO.md: Mark T5.5, T5.6 as [x]. Mark T98 Phase D (D1-D5) as [x].
  </action>
  <verify>
    dotnet build Plugins/DataWarehouse.Plugins.UltimateReplication/ --no-restore 2>&1 | Select-String -Pattern "error" | Select-Object -First 20
    Verify GeoWormReplicationFeature.cs and GeoDistributedShardingFeature.cs exist
    Grep for "compliance.geofence" in Feature files to confirm geofencing integration
    Grep for "storage.write" in GeoWormReplicationFeature to confirm WORM storage integration
  </verify>
  <done>
    GeoWormReplicationFeature enables cross-region WORM replication with compliance-mode selection. GeoDistributedShardingFeature distributes shards across continents with geofencing checks. Phase D migration complete. TODO.md T98 Phase C-D, T5.5, T5.6 all marked [x]. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build Plugins/DataWarehouse.Plugins.UltimateReplication/` passes with zero errors
2. 63+ replication strategies confirmed
3. 12 feature files exist (10 Phase C + GeoWormReplication + GeoDistributedSharding)
4. WORM replication integrates with storage and compliance via message bus
5. Geo-sharding integrates with compliance geofencing and RAID erasure coding via message bus
6. TODO.md T98 Phases A-D, T5.5, T5.6 all marked [x]
7. No direct plugin references — all cross-plugin communication via message bus
</verification>

<success_criteria>
UltimateReplication plugin is fully production-ready with 63+ strategies, 12 advanced features including geo-dispersed WORM and geo-distributed sharding, and complete migration. Geo-dispersed capabilities enforce compliance requirements during cross-region replication.
</success_criteria>

<output>
After completion, create `.planning/phases/04-compliance-storage-replication/04-04-SUMMARY.md`
</output>
