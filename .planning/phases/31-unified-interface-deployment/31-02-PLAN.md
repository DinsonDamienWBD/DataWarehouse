---
phase: 31-unified-interface-deployment
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.Shared/Services/NaturalLanguageProcessor.cs
  - DataWarehouse.Shared/Services/NlpMessageBusRouter.cs
autonomous: true

must_haves:
  truths:
    - "NLP queries with low pattern-match confidence route through MessageBridge to UltimateInterfacePlugin when connected"
    - "When Intelligence/MessageBridge is unavailable, NLP gracefully degrades to keyword-based CapabilityRegistry lookup"
    - "Pattern matching runs first (fast, free), AI routing only triggers on low confidence AND active connection"
  artifacts:
    - path: "DataWarehouse.Shared/Services/NlpMessageBusRouter.cs"
      provides: "Message bus routing bridge between NLP and UltimateInterfacePlugin"
      min_lines: 60
    - path: "DataWarehouse.Shared/Services/NaturalLanguageProcessor.cs"
      provides: "NLP processor with message bus fallback path"
      contains: "NlpMessageBusRouter"
  key_links:
    - from: "DataWarehouse.Shared/Services/NaturalLanguageProcessor.cs"
      to: "DataWarehouse.Shared/Services/NlpMessageBusRouter.cs"
      via: "calls router when confidence is low and connection exists"
      pattern: "NlpMessageBusRouter"
    - from: "DataWarehouse.Shared/Services/NlpMessageBusRouter.cs"
      to: "DataWarehouse.Shared/MessageBridge.cs"
      via: "sends nlp.parse-intent message through bridge"
      pattern: "MessageBridge.*SendAsync|nlp\\.parse-intent"
---

<objective>
Connect NaturalLanguageProcessor to UltimateInterfacePlugin's NLP capabilities via the message bus. When pattern matching has low confidence AND a DW instance is connected, route the query through MessageBridge to the server-side intelligence stack.

Purpose: CLI-03, DEPLOY-09 -- NLP queries should leverage the server-side UltimateInterfacePlugin's AI socket and Knowledge Bank for accurate answers, with graceful degradation when intelligence is unavailable.
Output: NlpMessageBusRouter.cs, updated NaturalLanguageProcessor.cs
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-unified-interface-deployment/31-RESEARCH.md

@DataWarehouse.Shared/Services/NaturalLanguageProcessor.cs
@DataWarehouse.Shared/MessageBridge.cs
@DataWarehouse.Shared/InstanceManager.cs
@DataWarehouse.Shared/Models/Message.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NlpMessageBusRouter for intelligence-backed query routing</name>
  <files>
    DataWarehouse.Shared/Services/NlpMessageBusRouter.cs
  </files>
  <action>
Create `DataWarehouse.Shared/Services/NlpMessageBusRouter.cs`:

1. Class `NlpMessageBusRouter`:
   - Constructor takes `MessageBridge` and optional `InstanceManager`
   - `IsAvailable` property: returns true when MessageBridge.IsConnected is true
   - `RouteQueryAsync(string query, CancellationToken ct)` method:
     a. Creates a Message with Command = "nlp.parse-intent", Data containing ["query"] = query, ["source"] = "cli-nlp"
     b. Sends via MessageBridge.SendAsync
     c. Parses response: expects Data with ["command"] (string), ["parameters"] (dict), ["confidence"] (double), ["explanation"] (string)
     d. Returns a CommandIntent record with ProcessedByAI = true
     e. Timeout: 10 seconds (wrap in Task.WaitAsync)
     f. If response is null or error, return null (caller falls back to local processing)

   - `RouteKnowledgeQueryAsync(string query, CancellationToken ct)` method:
     a. Creates Message with Command = "knowledge.query", Data containing ["query"] = query, ["topic"] = "*"
     b. Sends via MessageBridge.SendAsync
     c. Returns structured response with answer text and related capabilities
     d. Used for "What encryption algorithms are available?" style queries

   - `RouteCapabilityLookupAsync(string keyword, CancellationToken ct)` method:
     a. Fallback when intelligence is unavailable
     b. Creates Message with Command = "capability.search", Data containing ["keyword"] = keyword
     c. Returns list of matching capability names from the server's capability registry
     d. This is the "graceful degradation" path -- keyword matching against live capabilities

All methods: XML documentation, CancellationToken, try/catch returning null on failure (caller handles fallback). No mocks or stubs.
  </action>
  <verify>
Run `dotnet build DataWarehouse.Shared/DataWarehouse.Shared.csproj` -- zero errors. Verify NlpMessageBusRouter.cs exists with RouteQueryAsync, RouteKnowledgeQueryAsync, RouteCapabilityLookupAsync methods.
  </verify>
  <done>NlpMessageBusRouter exists with three routing methods that send real messages via MessageBridge to server-side intelligence stack.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate NlpMessageBusRouter into NaturalLanguageProcessor</name>
  <files>
    DataWarehouse.Shared/Services/NaturalLanguageProcessor.cs
  </files>
  <action>
Modify `DataWarehouse.Shared/Services/NaturalLanguageProcessor.cs`:

1. Add field `private readonly NlpMessageBusRouter? _messageBusRouter`
2. Add constructor parameter `NlpMessageBusRouter? messageBusRouter = null` (after existing parameters, preserving backward compat)
3. Store in _messageBusRouter field

4. Modify `ProcessWithAIFallbackAsync`:
   - EXISTING flow: pattern match -> if low confidence -> try local AI provider
   - NEW flow: pattern match -> if low confidence -> try message bus router FIRST -> if unavailable/failed -> try local AI provider -> return best result
   - After pattern matching, if confidence < _aiConfidenceThreshold:
     a. Check if _messageBusRouter?.IsAvailable == true
     b. If yes: call _messageBusRouter.RouteQueryAsync(input, ct)
     c. If router returns a valid CommandIntent with confidence >= _aiConfidenceThreshold, return it
     d. If router returns null or low confidence: fall through to existing local AI fallback path
   - This preserves the entire existing code path -- message bus routing is a NEW fallback layer inserted between pattern matching and local AI

5. Modify `GetAIHelpAsync`:
   - Before the existing AI help path, try _messageBusRouter?.RouteKnowledgeQueryAsync
   - If knowledge query returns results, incorporate them into the AIHelpResult answer
   - If router unavailable, try _messageBusRouter?.RouteCapabilityLookupAsync as degraded fallback
   - Only then fall through to existing local AI or basic help

6. Add method `ProcessWithMessageBusAsync(string input, CancellationToken ct)`:
   - Convenience method that always routes through message bus (bypasses pattern matching)
   - For use when caller explicitly wants server-side processing
   - Falls back to ProcessWithAIFallbackAsync if router unavailable

CRITICAL: Preserve ALL existing pattern matching, AI fallback, conversational context, learning, and completion functionality. The message bus router is an ADDITIONAL layer, not a replacement. All existing constructor signatures must continue to work (new parameter is optional with default null).
  </action>
  <verify>
Run `dotnet build DataWarehouse.Shared/DataWarehouse.Shared.csproj` -- zero errors. Verify NaturalLanguageProcessor has _messageBusRouter field and modified ProcessWithAIFallbackAsync. Verify all existing methods still present.
  </verify>
  <done>NaturalLanguageProcessor routes low-confidence queries through MessageBridge to UltimateInterfacePlugin when connected, degrades to capability keyword lookup when intelligence unavailable, falls back to local AI when disconnected. CLI-03 requirement met.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.Shared/DataWarehouse.Shared.csproj` passes with zero errors
- NlpMessageBusRouter.cs exists with three routing methods
- NaturalLanguageProcessor.cs has message bus routing integrated into ProcessWithAIFallbackAsync
- Graceful degradation chain: pattern match -> message bus intelligence -> message bus capability lookup -> local AI -> basic help
- All existing NLP functionality preserved (patterns, learning, sessions, completions)
</verification>

<success_criteria>
- CLI-03: NLP queries route through MessageBridge to UltimateInterfacePlugin with Knowledge Bank
- CLI-03: Graceful degradation to direct Capability Registry lookup when Intelligence unavailable
- DEPLOY-09: Integration path for server-side NLP established via message bus
- Zero regression: all existing NLP patterns, AI fallback, learning, and sessions work unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/31-unified-interface-deployment/31-02-SUMMARY.md`
</output>
