---
phase: 31-unified-interface-deployment
plan: 05
type: execute
wave: 3
depends_on: ["31-03", "31-04"]
files_modified:
  - DataWarehouse.Shared/Commands/LiveModeCommands.cs
  - DataWarehouse.Shared/Services/PortableMediaDetector.cs
  - DataWarehouse.CLI/Program.cs
autonomous: true

must_haves:
  truths:
    - "CLI command 'dw live' starts an in-memory DW instance with PersistData=false and all data vanishes on shutdown"
    - "'dw live --port 9090' starts on the specified port; default port is 8080"
    - "'dw live --memory 512' limits memory to 512MB"
    - "USB/portable media detection identifies when CLI is running from removable media"
    - "When running from USB, paths adapt to avoid writes to host filesystem"
  artifacts:
    - path: "DataWarehouse.Shared/Commands/LiveModeCommands.cs"
      provides: "LiveStartCommand and LiveStopCommand for in-memory DW"
      min_lines: 50
    - path: "DataWarehouse.Shared/Services/PortableMediaDetector.cs"
      provides: "USB/removable media detection and local instance discovery"
      min_lines: 30
  key_links:
    - from: "DataWarehouse.Shared/Commands/LiveModeCommands.cs"
      to: "DataWarehouse.Shared/Commands/IServerHost.cs"
      via: "starts embedded instance via IServerHost"
      pattern: "IServerHost|RunEmbeddedAsync|EmbeddedConfiguration"
    - from: "DataWarehouse.Shared/Services/PortableMediaDetector.cs"
      to: "System.IO.DriveInfo"
      via: "detects removable drives"
      pattern: "DriveInfo|DriveType\\.Removable"
---

<objective>
Implement the 'dw live' CLI command that starts an in-memory DW instance with PersistData=false (like a Linux Live CD). Add USB/portable media detection so the CLI adapts paths when running from removable media.

Purpose: DEPLOY-03 (live mode), DEPLOY-04 (USB detection) -- portable, ephemeral DW instances for demos, evaluation, and USB operation.
Output: LiveModeCommands.cs, PortableMediaDetector.cs, CLI wiring
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-unified-interface-deployment/31-RESEARCH.md

@DataWarehouse.Shared/Commands/ServerCommands.cs
@DataWarehouse.Shared/Commands/ICommand.cs
@DataWarehouse.Shared/Commands/CommandBase.cs
@DataWarehouse.SDK/Hosting/EmbeddedConfiguration.cs
@DataWarehouse.CLI/Program.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PortableMediaDetector and LiveModeCommands</name>
  <files>
    DataWarehouse.Shared/Services/PortableMediaDetector.cs
    DataWarehouse.Shared/Commands/LiveModeCommands.cs
  </files>
  <action>
1. Create `DataWarehouse.Shared/Services/PortableMediaDetector.cs`:
   - Static class `PortableMediaDetector`
   - `static bool IsRunningFromRemovableMedia()`:
     a. Get exePath via AppContext.BaseDirectory
     b. Enumerate DriveInfo.GetDrives()
     c. Find any drive with DriveType.Removable where exePath starts with drive.RootDirectory.FullName (case-insensitive)
     d. Return true if found
   - `static string? FindLocalLiveInstance(int[] portsToCheck)`:
     a. For each port in portsToCheck (default: 8080, 8081, 9090)
     b. Try HTTP GET to http://localhost:{port}/api/v1/info with 2-second timeout
     c. If 200 OK response, return the URL string
     d. On failure, continue to next port
     e. Return null if no running instance found
   - `static string GetPortableDataPath()`:
     a. If running from removable media: return Path.Combine(AppContext.BaseDirectory, "data")
     b. Otherwise: return Path.Combine(Environment.GetFolderPath(SpecialFolder.ApplicationData), "DataWarehouse", "data")
   - `static string GetPortableTempPath()`:
     a. If running from removable media: return Path.Combine(Path.GetTempPath(), "DataWarehouse-Live")
     b. Otherwise: return Path.Combine(Path.GetTempPath(), "DataWarehouse-Live")

2. Create `DataWarehouse.Shared/Commands/LiveModeCommands.cs`:
   - `LiveStartCommand : ICommand`:
     - Name = "live.start"
     - Description = "Start DataWarehouse in live mode (in-memory, no persistence)"
     - Category = "deployment"
     - RequiredFeatures = empty (always available)
     - ExecuteAsync:
       a. Extract parameters: port (int, default 8080), memory (int MB, default 256), plugins (string list, optional)
       b. Check if a live instance is already running (via PortableMediaDetector.FindLocalLiveInstance)
       c. If already running, return error with the URL of the existing instance
       d. Determine data path: use PortableMediaDetector.GetPortableTempPath() (ephemeral)
       e. Create EmbeddedConfiguration:
          - PersistData = false (this is the key "live CD" behavior)
          - ExposeHttp = true
          - HttpPort = port
          - MaxMemoryMb = memory
          - DataPath = temp path
          - Plugins = plugins list or default set
       f. Get IServerHost from CommandContext (or static registry) and call StartAsync with embedded config
       g. Auto-connect: after startup, connect the local InstanceManager to the live instance via InProcess connection
       h. Return success with: URL, port, memory limit, "Data will NOT be persisted"

   - `LiveStopCommand : ICommand`:
     - Name = "live.stop"
     - Description = "Stop the live DataWarehouse instance"
     - Category = "deployment"
     - RequiredFeatures = empty
     - ExecuteAsync:
       a. Get IServerHost and call StopAsync
       b. Clean up temp data directory
       c. Return success with "Live instance stopped. All data has been discarded."

   - `LiveStatusCommand : ICommand`:
     - Name = "live.status"
     - Description = "Show live instance status"
     - Category = "deployment"
     - RequiredFeatures = empty
     - ExecuteAsync:
       a. Check if running via IServerHost.IsRunning or PortableMediaDetector.FindLocalLiveInstance
       b. Return status info or "No live instance running"

All code: XML docs, CancellationToken support, no mocks/stubs.
  </action>
  <verify>
Run `dotnet build DataWarehouse.Shared/DataWarehouse.Shared.csproj` -- zero errors. Verify LiveModeCommands.cs has LiveStartCommand, LiveStopCommand, LiveStatusCommand. Verify PortableMediaDetector.cs has IsRunningFromRemovableMedia, FindLocalLiveInstance.
  </verify>
  <done>Live mode commands and portable media detection implemented. LiveStartCommand creates ephemeral embedded instance with PersistData=false. PortableMediaDetector detects USB drives and finds running instances.</done>
</task>

<task type="auto">
  <name>Task 2: Register live commands in CommandExecutor and wire CLI</name>
  <files>
    DataWarehouse.Shared/Commands/CommandExecutor.cs
    DataWarehouse.CLI/Program.cs
  </files>
  <action>
1. Modify `DataWarehouse.Shared/Commands/CommandExecutor.cs`:
   - In RegisterBuiltInCommands(), add:
     ```csharp
     // Live mode commands
     Register(new LiveStartCommand());
     Register(new LiveStopCommand());
     Register(new LiveStatusCommand());
     ```

2. Modify `DataWarehouse.CLI/Program.cs` (read it first to understand the System.CommandLine structure):
   - Add a `live` command group under the root command:
     ```
     var liveCommand = new Command("live", "Live mode commands (in-memory, no persistence)");
     var liveStartCommand = new Command("start", "Start a live DataWarehouse instance") { ... options ... };
     var liveStopCommand = new Command("stop", "Stop the live instance");
     var liveStatusCommand = new Command("status", "Show live instance status");
     ```
   - Add options to liveStartCommand:
     - `--port` (int, default 8080)
     - `--memory` (int, default 256, description "Maximum memory in MB")
   - Wire SetAction handlers that delegate to CommandExecutor with appropriate parameters
   - Add liveCommand to the root command

3. Add USB/portable awareness to CLI startup:
   - At CLI startup (early in Program.cs):
     a. Call PortableMediaDetector.IsRunningFromRemovableMedia()
     b. If true, log a message: "Running from portable media. Data paths adapted."
     c. Check PortableMediaDetector.FindLocalLiveInstance() for an existing instance
     d. If found, auto-connect to it and log: "Auto-connected to live instance at {url}"
   - This implements DEPLOY-04 auto-discovery

NOTE: Read Program.cs thoroughly first to understand the existing System.CommandLine setup. Follow the exact same patterns used for existing commands (SetAction, option definitions, etc.). Use the Phase 22 System.CommandLine 2.0.3 stable API (SetAction pattern, not deprecated NamingConventionBinder).
  </action>
  <verify>
Run `dotnet build DataWarehouse.CLI/DataWarehouse.CLI.csproj` -- zero errors. Verify `dw live start`, `dw live stop`, `dw live status` commands are registered. Verify USB detection runs at startup.
  </verify>
  <done>'dw live' command group registered with start/stop/status subcommands. CLI detects USB/portable media at startup and auto-discovers live instances. DEPLOY-03 and DEPLOY-04 fully implemented.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.CLI/DataWarehouse.CLI.csproj` passes with zero errors
- `dotnet build DataWarehouse.Shared/DataWarehouse.Shared.csproj` passes with zero errors
- LiveStartCommand creates EmbeddedConfiguration with PersistData=false
- PortableMediaDetector detects DriveType.Removable and scans ports for live instances
- CLI has `dw live start [--port] [--memory]`, `dw live stop`, `dw live status` commands
- USB auto-detection at CLI startup
</verification>

<success_criteria>
- DEPLOY-03: `dw live [--port] [--memory]` starts embedded DW with PersistData=false, in-memory storage, HTTP endpoint
- DEPLOY-04: USB/portable media auto-detection, path adaptation, auto-discovery of local live instances
- Live instance data vanishes on shutdown
- CLI/GUI can connect to live instance
</success_criteria>

<output>
After completion, create `.planning/phases/31-unified-interface-deployment/31-05-SUMMARY.md`
</output>
