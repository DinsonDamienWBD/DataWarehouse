---
phase: 31-unified-interface-deployment
plan: 07
type: execute
wave: 3
depends_on: ["31-06"]
files_modified:
  - DataWarehouse.Shared/Commands/InstallFromUsbCommand.cs
  - DataWarehouse.Shared/Services/UsbInstaller.cs
  - DataWarehouse.CLI/Program.cs
autonomous: true

must_haves:
  truths:
    - "'dw install --from-usb <source> --path <target>' copies a portable DW instance from USB to local disk"
    - "USB source is validated: must be a directory containing DW binaries and config"
    - "All config paths are remapped from source to target after copy"
    - "Post-install verification confirms the installation is functional"
    - "Service registration and autostart work after USB install"
  artifacts:
    - path: "DataWarehouse.Shared/Services/UsbInstaller.cs"
      provides: "USB source validation, tree copy, path remapping, post-install verification"
      min_lines: 80
    - path: "DataWarehouse.Shared/Commands/InstallFromUsbCommand.cs"
      provides: "InstallFromUsbCommand wiring the USB install flow"
      min_lines: 40
  key_links:
    - from: "DataWarehouse.Shared/Commands/InstallFromUsbCommand.cs"
      to: "DataWarehouse.Shared/Services/UsbInstaller.cs"
      via: "delegates to UsbInstaller for validation, copy, remap, verify"
      pattern: "UsbInstaller"
    - from: "DataWarehouse.Shared/Services/UsbInstaller.cs"
      to: "DataWarehouse.Launcher/Integration/DataWarehouseHost.cs"
      via: "calls RegisterServiceAsync after copy completes"
      pattern: "RegisterServiceAsync|IServerHost"
---

<objective>
Implement the 'dw install --from-usb' command that clones a portable DataWarehouse instance from USB media to a local disk, remaps paths in configuration files, and optionally registers as a service.

Purpose: DEPLOY-06 -- clone a portable DW from USB to local disk with tree copy, path remapping, data copy option, service registration, and post-install verification.
Output: UsbInstaller.cs, InstallFromUsbCommand.cs, CLI wiring
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-unified-interface-deployment/31-RESEARCH.md

@DataWarehouse.Shared/Commands/ICommand.cs
@DataWarehouse.Shared/Services/PortableMediaDetector.cs
@DataWarehouse.SDK/Hosting/InstallConfiguration.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UsbInstaller with validation, copy, remap, and verification</name>
  <files>
    DataWarehouse.Shared/Services/UsbInstaller.cs
  </files>
  <action>
Create `DataWarehouse.Shared/Services/UsbInstaller.cs`:

1. Class `UsbInstaller`:

   - `ValidateUsbSource(string sourcePath)` method:
     a. Check directory exists
     b. Check for required files: at least one .exe or .dll matching "DataWarehouse.*"
     c. Check for config directory with at least one .json file
     d. Return `UsbValidationResult` record: IsValid (bool), Errors (List of string), SourceVersion (string), PluginCount (int), HasData (bool), TotalSizeBytes (long)

   - `async Task<UsbInstallResult> InstallFromUsbAsync(UsbInstallConfiguration config, IProgress<InstallProgress>? progress, CancellationToken ct)`:
     a. Validate source: call ValidateUsbSource(config.SourcePath)
     b. If not valid: return failure with validation errors
     c. Create target directories: install root, data, config, plugins, logs
     d. Step 1 - Copy binaries: copy all .exe, .dll, .pdb, .json from source root to target root
     e. Step 2 - Copy config: copy source/config/* to target/config/*, then remap paths
     f. Step 3 - Copy plugins: copy source/plugins/* to target/plugins/
     g. Step 4 - Copy data (optional): if config.CopyData=true, copy source/data/* to target/data/
     h. Step 5 - Remap paths: call RemapConfigurationPaths
     i. Step 6 - Register service (optional): if config.CreateService=true, delegate to IServerHost
     j. Step 7 - Verify: call VerifyInstallation
     k. Report progress at each step
     l. Return UsbInstallResult with success status, file count, size, warnings

   - `RemapConfigurationPaths(string configDir, string oldBasePath, string newBasePath)`:
     a. Find all .json files in configDir
     b. For each file: read content, replace all occurrences of oldBasePath with newBasePath (case-insensitive on Windows)
     c. Handle forward/backward slash normalization
     d. Write back the modified content
     e. Log each remapped file

   - `UsbInstallVerification VerifyInstallation(string installPath)`:
     a. Check: directories exist (data, config, plugins, logs)
     b. Check: main executable exists and is not zero bytes
     c. Check: config file exists and parses as valid JSON
     d. Check: at least one plugin exists in plugins/
     e. Check: no paths in config reference the old source path (remapping complete)
     f. Return verification report: AllPassed (bool), Checks (List of (Name, Passed, Details))

   - Helper: `CopyDirectoryRecursive(string sourceDir, string targetDir, CancellationToken ct)`:
     a. Recursively copy all files and subdirectories
     b. Preserve relative directory structure
     c. Skip obj/, bin/, .git/ directories
     d. Use File.Copy with overwrite=true
     e. Return total file count and total bytes copied

2. Supporting records:
   - `UsbInstallConfiguration`: SourcePath, TargetPath, CopyData (bool, default true), CreateService (bool), AutoStart (bool), AdminPassword (string?)
   - `UsbInstallResult`: Success (bool), Message (string), FilesCopied (int), BytesCopied (long), Warnings (List of string), Verification (UsbInstallVerification)
   - `UsbValidationResult`: IsValid, Errors, SourceVersion, PluginCount, HasData, TotalSizeBytes
   - `UsbInstallVerification`: AllPassed, Checks (List of VerificationCheck record)

All methods: XML documentation, CancellationToken where async, proper error handling with descriptive messages.
  </action>
  <verify>
Run `dotnet build DataWarehouse.Shared/DataWarehouse.Shared.csproj` -- zero errors. Verify UsbInstaller.cs exists with ValidateUsbSource, InstallFromUsbAsync, RemapConfigurationPaths, VerifyInstallation methods.
  </verify>
  <done>UsbInstaller implements full USB-to-local install pipeline: source validation, recursive tree copy, path remapping in config files, optional data copy, and post-install verification.</done>
</task>

<task type="auto">
  <name>Task 2: Create InstallFromUsbCommand and wire into CLI</name>
  <files>
    DataWarehouse.Shared/Commands/InstallFromUsbCommand.cs
    DataWarehouse.Shared/Commands/CommandExecutor.cs
    DataWarehouse.CLI/Program.cs
  </files>
  <action>
1. Create `DataWarehouse.Shared/Commands/InstallFromUsbCommand.cs`:
   - `InstallFromUsbCommand : ICommand`:
     - Name = "install.from-usb"
     - Description = "Install DataWarehouse from a USB/portable source"
     - Category = "deployment"
     - RequiredFeatures = empty
     - ExecuteAsync:
       a. Extract parameters: source (string, required), path (string, required), copyData (bool, default true), service (bool, default false), autostart (bool, default false), adminPassword (string, optional)
       b. Create UsbInstallConfiguration from parameters
       c. Create UsbInstaller instance
       d. Validate source first: call ValidateUsbSource, if invalid return error with details
       e. Call InstallFromUsbAsync with progress callback that logs each step
       f. If service registration requested: delegate to IServerHost
       g. Return result with file count, size, verification status

2. Modify `DataWarehouse.Shared/Commands/CommandExecutor.cs`:
   - In RegisterBuiltInCommands(), add:
     ```csharp
     Register(new InstallFromUsbCommand());
     ```

3. Modify `DataWarehouse.CLI/Program.cs`:
   - The `install` command (from plan 31-06) should already exist
   - Add `--from-usb <source>` option to the install command
   - When --from-usb is provided, route to InstallFromUsbCommand instead of regular InstallCommand
   - Add `--copy-data` flag (bool, default true, "Copy data files from USB source")
   - The full command: `dw install --from-usb /media/usb/dw --path C:/DataWarehouse --service --autostart --copy-data`
   - SetAction handler checks if --from-usb is set: if yes, execute "install.from-usb" command; if no, execute "install" command

Follow existing CLI patterns. Use System.CommandLine 2.0.3 SetAction.
  </action>
  <verify>
Run `dotnet build DataWarehouse.CLI/DataWarehouse.CLI.csproj` -- zero errors. Verify InstallFromUsbCommand.cs exists. Verify CLI supports `dw install --from-usb <source> --path <target>`.
  </verify>
  <done>'dw install --from-usb <source> --path <target>' command fully wired with source validation, tree copy, path remapping, and post-install verification. DEPLOY-06 fully implemented.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.CLI/DataWarehouse.CLI.csproj` passes with zero errors
- `dotnet build DataWarehouse.Shared/DataWarehouse.Shared.csproj` passes with zero errors
- UsbInstaller validates USB source, copies tree, remaps paths, verifies installation
- CLI supports `dw install --from-usb <source> --path <target> [--copy-data] [--service] [--autostart]`
- Path remapping replaces all old source paths with new target paths in config files
</verification>

<success_criteria>
- DEPLOY-06: `dw install --from-usb <source> --path <target>` clones portable DW to local disk
- DEPLOY-06: Tree copy, path remapping, data copy, service registration, post-install verification
- USB source validation prevents installing from invalid sources
- Post-install verification confirms functional installation
</success_criteria>

<output>
After completion, create `.planning/phases/31-unified-interface-deployment/31-07-SUMMARY.md`
</output>
