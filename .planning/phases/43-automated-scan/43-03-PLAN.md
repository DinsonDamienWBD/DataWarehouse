---
phase: 43
plan: 43-03
title: "Automated Pattern Scan: Build & Test Verification"
depends_on: []
---

# Plan 43-03: Automated Pattern Scan: Build & Test Verification

## Goal
Verify build integrity, test coverage, and eliminate dead code across all 71 projects. Ensure the solution builds cleanly with warnings-as-errors, has comprehensive test coverage, and contains no unreachable or orphaned code.

## Approach

### 1. Build Verification with Warnings-as-Errors

**Clean Build Baseline**
- Restore all NuGet packages: `dotnet restore DataWarehouse.sln`
- Build Release configuration: `dotnet build DataWarehouse.sln -c Release --no-restore --warnaserror`
- Capture all warnings promoted to errors
- Re-run per project to isolate failures

**Warning Categories to Enforce**
- CS0168: Variable declared but never used
- CS0219: Variable assigned but value never used
- CS0414: Private field assigned but never used
- CS0618: Obsolete member usage
- CS0649: Field never assigned (always null)
- CS8600-CS8625: Nullable reference type warnings
- CS1998: Async method lacks await
- IDE0051: Private member is unused (Roslyn analyzer)

**Build Output Analysis**
- Parse MSBuild log for error/warning counts per project
- Identify projects with highest warning density
- Categorize warnings: nullability, unused code, obsolete API, async/await

### 2. Test Execution & Coverage Analysis

**Test Discovery**
- List all test projects: `dotnet sln list | grep -i test`
- Verify test project structure (xUnit/NUnit/MSTest detection)
- Count test methods per project

**Test Execution**
- Run all tests: `dotnet test DataWarehouse.sln -c Release --no-build --logger "trx;LogFileName=test-results.trx"`
- Capture results: passed/failed/skipped counts
- Identify flaky tests (re-run failures 3x)
- Check for test timeouts or hangs

**Coverage Collection**
- Use coverlet: `dotnet test --collect:"XPlat Code Coverage"`
- Generate coverage report: `reportgenerator -reports:**/coverage.cobertura.xml -targetdir:coverage-report`
- Calculate coverage metrics:
  - Line coverage %
  - Branch coverage %
  - Method coverage %
- Per-project coverage breakdown

**Coverage Gap Analysis**
- Identify plugins with 0 test files: `ls Plugins/**/Tests || echo "No tests"`
- List public API methods without test coverage (LSP symbols + coverage intersection)
- Prioritize gaps: domain plugins > infrastructure > utilities

### 3. Dead Code Detection

**Unreferenced Private Members**
- Use Roslyn analyzers (IDE0051, IDE0052)
- Cross-reference with LSP: `lsp_find_references` for private methods
- Identify private methods with zero call sites
- Exclude: Main, serialization callbacks, reflection targets

**Unused Public API**
- Find public methods never called internally
- Cross-check against plugin contract interfaces (may be external usage)
- Flag candidates for deprecation (mark [Obsolete] vs delete)

**Orphaned Files**
- List .cs files not included in any .csproj
- Find .csproj files not in solution
- Detect duplicate implementations (same class name in multiple projects)

**Commented-Out Code**
- Large blocks of commented code (>10 consecutive lines)
- Commented using/import statements
- Differentiate: documentation comments vs code graveyard

### 4. Dependency Health Check

**Package Vulnerabilities**
- Run: `dotnet list package --vulnerable --include-transitive`
- Report all HIGH/CRITICAL vulnerabilities
- Check for available updates

**Deprecated Dependencies**
- Scan for packages with [Obsolete] attributes
- Check for .NET Framework dependencies (should be .NET 6+)
- Identify abandoned NuGet packages (no updates in 3+ years)

**Circular References**
- Verify no project reference cycles
- Check for namespace conflicts across projects
- Validate plugin isolation (SDK-only references)

### 5. Output Format

Generate `AUDIT-FINDINGS-01-build.md` with structure:
```
# Build & Test Verification Audit - Phase 43-03
Generated: [timestamp]
Solution: DataWarehouse.sln (71 projects)

## Executive Summary
- Build Status: [PASS/FAIL]
- Total Warnings-as-Errors: [N]
- Test Pass Rate: [N/N] ([%])
- Code Coverage: [%] line coverage
- Dead Code Findings: [N] private methods, [N] files
- Vulnerabilities: [N] HIGH, [N] CRITICAL

## Part 1: Build Verification

### Build Results
| Project | Status | Errors | Warnings | Config |
|---------|--------|--------|----------|--------|
| DataWarehouse.Kernel | ✓ | 0 | 0 | Release |
| [Project] | ✗ | 3 | 12 | Release |

### P0 Build Failures
**P0-001: CS1729 in UltimateCompression**
**Location**: `Plugins/DataWarehouse.Plugins.UltimateCompression/CompressionStrategy.cs:45`
**Error**: No constructor match for SharpCompress.Compressors.Deflate.DeflateStream(Stream, CompressionMode)
**Impact**: Project does not compile
**Resolution**: Update SharpCompress API usage per v0.35+ docs

[... repeat for all build errors ...]

### Warnings-as-Errors Report
**Category Breakdown**:
- Nullable warnings (CS8600-series): [N]
- Unused variables (CS0168, CS0219): [N]
- Async without await (CS1998): [N]
- Obsolete usage (CS0618): [N]

**Top 5 Projects by Warning Count**:
1. [Project]: [N] warnings
2. [Project]: [N] warnings
[...]

## Part 2: Test Verification

### Test Execution Results
- Total Tests: [N]
- Passed: [N] ([%])
- Failed: [N] ([%])
- Skipped: [N] ([%])
- Duration: [HH:MM:SS]

### Failed Tests
**FAIL-001: [TestName] in [Project].Tests**
**Location**: `Tests/[Project].Tests/[File].cs:[Line]`
**Failure**: Expected [X], Actual [Y]
**Stack Trace**: [First 5 lines]
**Flaky**: [Y/N] (failed 2/3 re-runs)

### Coverage Analysis
**Overall Coverage**: [%] line, [%] branch

**Coverage by Category**:
| Category | Line % | Branch % | Methods % |
|----------|--------|----------|-----------|
| Domain Plugins | [%] | [%] | [%] |
| Infrastructure | [%] | [%] | [%] |
| SDK | [%] | [%] | [%] |
| Kernel | [%] | [%] | [%] |

**Coverage Gaps (0% coverage)**:
1. DataWarehouse.Plugins.[X] - 0 test files
2. [Project] - [N] public methods untested
[...]

**Recommendation**: Minimum 70% line coverage for v4.0 certification

## Part 3: Dead Code Detection

### Unreferenced Private Members
**DEAD-001: Private method never called**
**Location**: `[Project]/[File].cs:[Line]`
**Method**: `private void [MethodName]([params])`
**References**: 0 (verified via LSP)
**Recommendation**: Delete or mark for deprecation

[... repeat for [N] findings ...]

### Orphaned Files
- `[Path]/OldImplementation.cs` - not in any .csproj
- [N] total orphaned files

### Commented-Out Code
- [N] blocks of >10 consecutive commented lines
- [N] commented using statements
**Recommendation**: Remove code graveyard, preserve in git history

## Part 4: Dependency Health

### Vulnerabilities (CRITICAL)
**CVE-2024-XXXXX in [Package] v[X.Y.Z]**
- Severity: CRITICAL
- Affected Projects: [N]
- Fixed In: [X.Y.Z+1]
- **Action Required**: Update immediately

### Deprecated Packages
- [Package] v[X] - last updated 2020, consider migration to [Alternative]

### Circular Reference Check
- ✓ No circular references detected
- ✓ All plugins reference SDK only

## Appendix A: Test Coverage by Project
[Table: Project | Line % | Branch % | Test Files | Test Methods]

## Appendix B: Full Warning List
[CSV export of all warnings with project, file, line, code, message]

## Appendix C: Build Performance
- Clean build time: [MM:SS]
- Incremental build time: [MM:SS]
- Restore time: [MM:SS]

## Success Criteria Status
- [ ] Zero build errors in Release configuration
- [ ] All tests passing (100% pass rate)
- [ ] Coverage ≥70% line coverage overall
- [ ] Zero CRITICAL vulnerabilities
- [ ] Dead code < 5% of total codebase
```

## Scope

**In Scope**:
- All 71 projects in DataWarehouse.sln
- Release configuration build (warnings-as-errors)
- Full test suite execution
- Code coverage collection (coverlet/ReportGenerator)
- Dead code detection (Roslyn analyzers + LSP)
- Dependency vulnerability scan (dotnet list package)

**Out of Scope**:
- Performance benchmarking (Phase 42)
- Security pattern scanning (Plan 43-02)
- Code quality patterns (Plan 43-01)
- Fixing issues (Plan 43-04)

**Known Build Errors to Document**:
- CS1729 in UltimateCompression (SharpCompress API mismatch)
- CS0234 in AedsCore (MQTTnet namespace issue)
- Any Phase 31.1/41.1 carryover issues

## Success Criteria

1. **Build Health**: Document current build state, all errors cataloged
2. **Test Completeness**: All test projects execute, no infinite loops/deadlocks
3. **Coverage Baseline**: Establish coverage % for each project as v4.0 baseline
4. **Dead Code Inventory**: Complete list of unused private members
5. **Vulnerability Awareness**: All CRITICAL/HIGH CVEs documented
6. **Actionable Output**: Each finding has location, impact, recommendation
7. **Gap Identification**: Plugins with 0 tests flagged for 44-0X domain audits

**Validation Steps**:
- Verify build runs to completion (no hang)
- Confirm test count matches expected range (1000+ tests across 71 projects)
- Validate coverage report generation succeeds
- Spot-check 5 dead code findings for accuracy

## Output

**Primary Artifact**:
- `.planning/phases/43-automated-scan/AUDIT-FINDINGS-01-build.md`

**Supporting Data**:
- `.planning/phases/43-automated-scan/build.log` (MSBuild verbose output)
- `.planning/phases/43-automated-scan/test-results.trx` (VSTest results)
- `.planning/phases/43-automated-scan/coverage-report/index.html` (ReportGenerator output)
- `.planning/phases/43-automated-scan/dead-code.json` (structured list)
- `.planning/phases/43-automated-scan/vulnerabilities.csv` (NuGet audit)

**Metrics to Track**:
- Warnings/Errors per project (CSV)
- Test pass rate trend (track over time)
- Coverage delta vs Phase 31.1 baseline
- Dead code % of total LOC

**Handoff to 43-04**:
- Build errors MUST be fixed (P0)
- CRITICAL vulnerabilities MUST be patched (P0)
- Test failures MUST be resolved or skipped with justification (P1)
- Coverage gaps inform domain audit depth in Phase 44
- Dead code cleanup in 43-04 (P2, low priority)
