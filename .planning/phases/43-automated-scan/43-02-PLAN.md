---
phase: 43
plan: 43-02
title: "Automated Pattern Scan: Security"
depends_on: []
---

# Plan 43-02: Automated Pattern Scan: Security

## Goal
Scan ALL 71 projects for security anti-patterns and vulnerabilities that could compromise data integrity, confidentiality, or availability. Generate a security-focused audit report with CVSS-aligned severity scoring.

## Approach

### 1. Define Security Anti-Pattern Signatures

**Fake Crypto (Insecure Randomness)**
- `Random.Shared` in security/crypto contexts
- `new Random()` for key generation, IV, salt, nonce
- `Guid.NewGuid()` used for secrets/tokens
- Context: Usage in classes containing "Crypto", "Encryption", "Security", "Auth"

**Key Material Leak**
- `new byte[]` for key storage in non-secure contexts
- Hardcoded byte arrays in crypto initialization
- Key material in string literals
- Symmetric keys without SecureString or protected memory
- Context: Variable lifetime, scope, disposal pattern

**Hardcoded Secrets**
- `password=`, `Password=`, `pwd=` in connection strings/config
- `apikey=`, `ApiKey=`, `api_key=` in literals
- `secret=`, `Secret=`, `token=`, `Token=` in literals
- `connectionString = "` with credentials
- Context: Configuration vs code, test vs production

**Nullable Violations (Null Suppression)**
- `null!` suppression operator abuse
- `!` null-forgiving operator in security paths
- `.Value` on nullable without null check in security methods
- Context: Call stack, trust boundary crossing

**Error Swallowing**
- `catch (Exception)` without logging or rethrow
- `catch (Exception ex)` with empty block or comment-only
- `catch` with swallow in security/crypto paths
- Context: Exception type, surrounding logic, impact radius

**Additional Security Patterns**

**SQL Injection Risk**
- String concatenation in SQL queries: `$"SELECT * FROM {table}"`
- `CommandText = ` with string interpolation
- Context: User input flow, parameterization usage

**Path Traversal Risk**
- `Path.Combine(basePath, userInput)` without validation
- File operations with unvalidated user input
- Context: Input source, validation presence

**Deserialization Risk**
- `BinaryFormatter` usage (known CVE)
- `JsonConvert.DeserializeObject<object>` without type constraints
- `XmlSerializer` with unvalidated type
- Context: Data source (trusted vs untrusted)

**Missing Input Validation**
- Public API methods without argument validation
- Missing null checks on reference parameters
- Unchecked numeric ranges in security-sensitive code
- Context: API surface, trust boundary

### 2. Scan Execution Strategy

**Phase 1: Security-Focused Grep**
- Search for each pattern across all .cs files
- Prioritize files in plugins: UltimateSecurity, UltimateCrypto, UltimateTamperProof
- Collect context with -B 3 -A 3 for flow analysis

**Phase 2: Control Flow Analysis**
- Trace user input paths to sensitive operations
- Identify trust boundaries (public API → internal logic)
- Map authentication/authorization checks
- Use LSP references to track data flow

**Phase 3: Crypto Library Audit**
- Inventory all System.Security.Cryptography usage
- Verify algorithm choices (AES-256-GCM, SHA-256, ECDSA P-256)
- Check for deprecated algorithms (MD5, SHA1, 3DES, RC4)
- Validate key sizes, IV handling, salt generation

**Phase 4: Secret Management Review**
- Scan for IConfiguration usage patterns
- Verify secret storage (Azure Key Vault, environment variables)
- Check for secrets in version control (.git history via git log -S)
- Validate test fixtures don't leak production secrets

### 3. Severity Classification (CVSS-Aligned)

**P0 (Critical - CVSS 9.0-10.0)** - Immediate exploitation risk:
- Hardcoded production credentials in code
- Known vulnerable deserialization (BinaryFormatter)
- SQL injection in authenticated endpoints
- Key material in plaintext without protection

**P1 (High - CVSS 7.0-8.9)** - Significant risk requiring patch:
- Insecure randomness in crypto (Random vs RNG)
- Missing authentication on sensitive operations
- Path traversal in file operations
- Error swallowing in security checks

**P2 (Medium - CVSS 4.0-6.9)** - Defense-in-depth improvement:
- Nullable violations in non-critical paths
- Missing input validation on internal APIs
- Weak logging of security events
- Deprecated algorithms in test code only

### 4. Output Format

Generate `AUDIT-FINDINGS-01-security.md` with structure:
```
# Security Audit Findings - Phase 43-02
Generated: [timestamp]
Scan Coverage: 71 projects, [N] .cs files
Methodology: OWASP Top 10 + CWE Top 25 pattern matching

## Executive Summary
- Total Findings: [N]
- P0 Critical (CVSS 9.0+): [N] - IMMEDIATE ACTION REQUIRED
- P1 High (CVSS 7.0-8.9): [N] - Patch before v4.0
- P2 Medium (CVSS 4.0-6.9): [N] - Defense-in-depth

## CRITICAL: P0 Findings Require Immediate Remediation

### P0-001: Hardcoded Secret in [PluginName]
**Location**: `Path/To/File.cs:123`
**CWE**: CWE-798 (Use of Hard-coded Credentials)
**CVSS Score**: 9.8 (Critical)
**Pattern**: `apikey="[REDACTED]"` in source code
**Impact**: Full compromise of external service authentication
**Code**:
```csharp
[context with secret REDACTED]
```
**Remediation**:
1. Revoke exposed credential immediately
2. Generate new secret via secure channel
3. Store in Azure Key Vault / environment variable
4. Update code to load via IConfiguration
5. Scan git history for exposure: `git log -S "apikey="`
**Verification**: Confirm secret rotation + secure storage

[... repeat for each P0 ...]

## P1 High Findings

### P1-001: Insecure Randomness in Crypto
**Location**: `Plugins/UltimateCrypto/KeyGenerator.cs:45`
**CWE**: CWE-338 (Use of Cryptographically Weak PRNG)
**CVSS Score**: 7.5 (High)
**Pattern**: `Random.Shared.Next()` for IV generation
**Impact**: Predictable initialization vectors enable ciphertext attacks
**Code**:
```csharp
var iv = new byte[16];
Random.Shared.NextBytes(iv); // INSECURE
```
**Remediation**:
```csharp
var iv = new byte[16];
RandomNumberGenerator.Fill(iv); // SECURE
```
**Verification**: All crypto randomness uses RNG API

[... repeat ...]

## P2 Medium Findings
[... same format ...]

## Appendix A: Crypto Inventory
| Plugin | Algorithm | Key Size | Mode | Status |
|--------|-----------|----------|------|--------|
| UltimateCrypto | AES | 256 | GCM | ✓ Secure |
| UltimateSecurity | SHA | 256 | - | ✓ Secure |
| [Plugin] | MD5 | 128 | - | ✗ DEPRECATED |

## Appendix B: Secret Storage Audit
- Azure Key Vault: [Y/N]
- Environment Variables: [Y/N]
- appsettings.json (encrypted): [Y/N]
- Hardcoded: [N] instances found

## Appendix C: Statistics by CWE
- CWE-798 (Hardcoded Credentials): [N]
- CWE-338 (Weak PRNG): [N]
- CWE-89 (SQL Injection): [N]
- CWE-502 (Deserialization): [N]
- CWE-22 (Path Traversal): [N]
- CWE-209 (Error Message Exposure): [N]

## Appendix D: Findings by Project
[Table with P0/P1/P2 breakdown]
```

## Scope

**In Scope**:
- All 71 projects (focus on security-related plugins)
- Source code + configuration files (appsettings.json, connection strings)
- Git history scan for exposed secrets (last 100 commits)
- Test code (separate section - ensure test secrets != production)

**Priority Plugins** (scan first):
- DataWarehouse.Plugins.UltimateSecurity
- DataWarehouse.Plugins.UltimateCrypto
- DataWarehouse.Plugins.UltimateTamperProof
- DataWarehouse.Plugins.UltimateAccessControl
- DataWarehouse.Plugins.AedsCore (service daemon, elevated privileges)

**Out of Scope**:
- Penetration testing (runtime exploitation)
- Dependency vulnerability scanning (use `dotnet list package --vulnerable` separately)
- Network security (firewall rules, TLS config)
- Physical security considerations

## Success Criteria

1. **Zero Hardcoded Secrets**: P0 finding count for CWE-798 must be 0 after 43-04 fixes
2. **Crypto Compliance**: All crypto uses approved algorithms (AES-256, SHA-256, RSA-2048+, ECDSA P-256)
3. **No Insecure RNG**: Zero usage of Random/Guid in security contexts
4. **Input Validation**: All public API methods have argument validation
5. **Error Handling**: No exception swallowing in security paths
6. **Secret Rotation Plan**: Any exposed secrets have documented rotation procedure
7. **CWE Coverage**: Scan covers OWASP Top 10 + CWE Top 25 patterns

## Output

**Primary Artifact**:
- `.planning/phases/43-automated-scan/AUDIT-FINDINGS-01-security.md`

**Supporting Data**:
- `.planning/phases/43-automated-scan/scan-results-security.json`
- `.planning/phases/43-automated-scan/crypto-inventory.csv` (algorithm usage matrix)
- `.planning/phases/43-automated-scan/secret-scan-git.log` (git history findings)

**Validation**:
- Cross-reference with Phase 41.1-02 (Crypto Audit) findings
- Verify no regression on previous security fixes
- Compare against OWASP ASVS 4.0 Level 2 requirements

**Handoff to 43-04**:
- All P0 findings MUST be fixed before v4.0 certification
- P0 secret exposure requires immediate rotation (out-of-band emergency process)
- Security findings block release if unfixed
