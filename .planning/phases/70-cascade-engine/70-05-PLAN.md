---
phase: 70-cascade-engine
plan: 05
type: tdd
wave: 4
depends_on: ["70-01", "70-02", "70-03", "70-04"]
files_modified:
  - DataWarehouse.Tests/Policy/CascadeResolutionTests.cs
  - DataWarehouse.Tests/Policy/CascadeStrategyTests.cs
  - DataWarehouse.Tests/Policy/CascadeSafetyTests.cs
autonomous: true

must_haves:
  truths:
    - "60+ tests verify all cascade strategies, edge cases, and adversarial scenarios"
    - "Enforce-at-higher-level vs Override-at-lower-level adversarial test passes"
    - "Empty-level skip test passes for all level combinations"
    - "Circular reference detection test rejects cycles"
    - "Snapshot isolation test proves in-flight operations see stale-but-consistent data"
  artifacts:
    - path: "DataWarehouse.Tests/Policy/CascadeResolutionTests.cs"
      provides: "Core resolution tests: path parsing, level walk, empty skip, profile fallback"
      min_lines: 200
    - path: "DataWarehouse.Tests/Policy/CascadeStrategyTests.cs"
      provides: "Per-strategy tests: MostRestrictive, Enforce, Inherit, Override, Merge"
      min_lines: 200
    - path: "DataWarehouse.Tests/Policy/CascadeSafetyTests.cs"
      provides: "Safety tests: snapshot isolation, circular detection, merge conflicts, overrides"
      min_lines: 150
  key_links:
    - from: "CascadeResolutionTests"
      to: "PolicyResolutionEngine"
      via: "Direct instantiation with InMemoryPolicyStore"
      pattern: "new PolicyResolutionEngine"
    - from: "CascadeStrategyTests"
      to: "CascadeStrategies"
      via: "Direct static method calls"
      pattern: "CascadeStrategies\\."
---

<objective>
Comprehensive test suite for the cascade resolution engine covering all strategies, edge cases, and adversarial scenarios.

Purpose: Verify that CASC-01 through CASC-08 all work correctly, including the critical adversarial case where Enforce at a higher level must override Override at a lower level.
Output: 60+ passing tests across 3 test files.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/70-cascade-engine/70-01-SUMMARY.md
@.planning/phases/70-cascade-engine/70-02-SUMMARY.md
@.planning/phases/70-cascade-engine/70-03-SUMMARY.md
@.planning/phases/70-cascade-engine/70-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Core resolution and strategy tests</name>
  <files>
    DataWarehouse.Tests/Policy/CascadeResolutionTests.cs
    DataWarehouse.Tests/Policy/CascadeStrategyTests.cs
  </files>
  <action>
First check how the test project is structured:
- Find the test project csproj and its existing test patterns (xUnit vs NUnit vs MSTest, assertion style)
- Match the existing conventions exactly

**CascadeResolutionTests.cs** (~25 tests):
- ResolveAsync_VdeLevelPath_ReturnsVdePolicy
- ResolveAsync_ContainerLevelPath_ReturnsContainerPolicy
- ResolveAsync_ObjectLevelPath_ReturnsObjectPolicy
- ResolveAsync_ChunkLevelPath_ReturnsChunkPolicy
- ResolveAsync_BlockLevelPath_ReturnsBlockPolicy
- ResolveAsync_EmptyContainer_SkipsToVde (CASC-04: Object inherits from VDE when Container has no override)
- ResolveAsync_EmptyChunkAndObject_SkipsToContainer
- ResolveAsync_AllLevelsEmpty_FallsBackToProfile
- ResolveAsync_NoProfileNoStore_ReturnsDefault
- ResolveAsync_ResolutionChain_OrderedMostSpecificFirst
- ResolveAsync_SnapshotTimestamp_IsPopulated
- ResolveAllAsync_ReturnsAllFeatures
- SimulateAsync_DoesNotPersist
- GetSetActiveProfile_RoundTrips
- ResolveAsync_PathParsing_SingleSegment_VdeLevel
- ResolveAsync_PathParsing_FiveSegments_BlockLevel
- ResolveAsync_MergedParameters_CombinedFromChain

**CascadeStrategyTests.cs** (~25 tests):
- Inherit_SingleEntry_ReturnsEntry
- Inherit_MultipleEntries_ReturnsMostSpecific
- Override_IgnoresParentValues
- Override_SingleEntry_ReturnsEntry
- MostRestrictive_PicksLowestIntensity
- MostRestrictive_PicksMostRestrictiveAiAutonomy
- MostRestrictive_MultipleEntries_ReturnsCorrectDecidedAtLevel
- Enforce_HigherLevelWinsOverLowerOverride (CASC-05 adversarial test)
- Enforce_VdeEnforce_OverridesContainerOverride (CASC-05 key scenario)
- Enforce_NoEnforceInChain_FallsBackToOverride
- Enforce_BlockLevelEnforce_StillApplied
- Merge_CombinesCustomParameters
- Merge_ChildOverwritesParentKeys
- Merge_EmptyParameters_NoError
- CategoryDefaults_Security_MostRestrictive (CASC-02)
- CategoryDefaults_Performance_Override (CASC-02)
- CategoryDefaults_Governance_Merge (CASC-02)
- CategoryDefaults_Compliance_Enforce (CASC-02)
- CategoryDefaults_Unknown_DefaultsToInherit
- CategoryDefaults_UserOverride_TakesPrecedence

Use RED-GREEN approach: write each test first verifying it fails (referencing the implementation classes), then confirm it passes against the implementation. Since implementation already exists from Plans 01-04, focus on ensuring tests accurately verify behavior.

For the CASC-05 adversarial test specifically:
- Set VDE-level policy with Cascade=Enforce, intensity=100
- Set Container-level policy with Cascade=Override, intensity=30
- Resolve at Object level
- Assert: effective intensity is 100 (VDE Enforce wins), NOT 30
  </action>
  <verify>dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter "FullyQualifiedName~Policy.Cascade" --no-restore 2>&1 | tail -20</verify>
  <done>~50 tests pass covering core resolution (CASC-01, CASC-04), all 5 strategies (CASC-02, CASC-05), and category defaults.</done>
</task>

<task type="auto">
  <name>Task 2: Safety mechanism tests</name>
  <files>
    DataWarehouse.Tests/Policy/CascadeSafetyTests.cs
  </files>
  <action>
**CascadeSafetyTests.cs** (~15 tests):

Snapshot Isolation (CASC-06):
- SnapshotIsolation_InFlightOperation_SeesOldPolicy: Get snapshot, modify store, resolve with snapshot still returns old value
- SnapshotIsolation_NewOperation_SeesNewPolicy: Modify store, get new snapshot, resolve returns new value
- VersionedCache_VersionIncrements_OnUpdate
- VersionedCache_PreviousSnapshot_StillValid

Circular Reference Detection (CASC-07):
- CircularReference_DirectCycle_Rejected: Policy A redirects to B, B redirects to A -> throws PolicyCircularReferenceException
- CircularReference_TransitiveCycle_Rejected: A->B->C->A
- CircularReference_NoCycle_Accepted
- CircularReference_MaxDepthExceeded_Rejected
- CircularReference_ErrorMessage_ContainsPathChain

Merge Conflict Resolution (CASC-08):
- MergeConflict_MostRestrictive_PicksLowest
- MergeConflict_Closest_PicksChild
- MergeConflict_Union_CombinesAll
- MergeConflict_PerKeyConfig_DifferentModesPerKey
- MergeConflict_UnknownKey_DefaultsToClosest

User Cascade Overrides (CASC-03):
- CascadeOverride_SetAndRetrieve
- CascadeOverride_OverrideRespectedInResolution
- CascadeOverride_Remove_FallsBackToDefault
- CascadeOverride_PersistAndReload

Instantiate PolicyResolutionEngine with InMemoryPolicyStore and InMemoryPolicyPersistence for each test. No external dependencies.
  </action>
  <verify>dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter "FullyQualifiedName~Policy.Cascade" --no-restore 2>&1 | tail -20</verify>
  <done>60+ total tests pass across all 3 files. All CASC requirements verified including adversarial Enforce-vs-Override scenario.</done>
</task>

</tasks>

<verification>
- `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter "FullyQualifiedName~Policy.Cascade"` shows 60+ tests passing, 0 failures
- CASC-05 adversarial test explicitly verifies Enforce overrides Override
- CASC-06 snapshot isolation test proves in-flight consistency
- CASC-07 circular detection test rejects cycles with clear error message
</verification>

<success_criteria>
- 60+ tests passing across CascadeResolutionTests, CascadeStrategyTests, CascadeSafetyTests
- Zero test failures
- Every CASC requirement (01-08) has at least one dedicated test
</success_criteria>

<output>
After completion, create `.planning/phases/70-cascade-engine/70-05-SUMMARY.md`
</output>
