---
phase: 70-cascade-engine
plan: 06
type: execute
wave: 2
depends_on: []
files_modified:
  - DataWarehouse.SDK/Infrastructure/Policy/PolicyComplianceScorer.cs
  - DataWarehouse.SDK/Infrastructure/Policy/RegulatoryTemplate.cs
autonomous: true

must_haves:
  truths:
    - "Compliance scorer evaluates a set of policies against HIPAA, GDPR, SOC2, and FedRAMP templates"
    - "Gap analysis report lists each requirement, pass/fail status, and remediation for failures"
    - "Scoring produces a numeric score (0-100) per framework and an overall composite score"
  artifacts:
    - path: "DataWarehouse.SDK/Infrastructure/Policy/PolicyComplianceScorer.cs"
      provides: "Compliance scoring engine with gap analysis and remediation"
      contains: "class PolicyComplianceScorer"
    - path: "DataWarehouse.SDK/Infrastructure/Policy/RegulatoryTemplate.cs"
      provides: "Regulatory requirement templates for HIPAA/GDPR/SOC2/FedRAMP"
      contains: "class RegulatoryTemplate"
  key_links:
    - from: "PolicyComplianceScorer"
      to: "RegulatoryTemplate"
      via: "Evaluates policies against template requirements"
      pattern: "RegulatoryTemplate|_template"
    - from: "PolicyComplianceScorer"
      to: "FeaturePolicy"
      via: "Reads policy intensity and parameters for scoring"
      pattern: "FeaturePolicy|IntensityLevel"
---

<objective>
Build the policy compliance scoring system that evaluates deployments against regulatory templates (HIPAA, GDPR, SOC2, FedRAMP) and produces a gap analysis report with remediation suggestions.

Purpose: PADV-03 requires compliance scoring to give operators actionable visibility into how their policy configuration stacks up against regulatory requirements. This is standalone from the cascade engine -- it reads policies but doesn't modify resolution.
Output: RegulatoryTemplate definitions and PolicyComplianceScorer that produces scored gap analysis reports.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@DataWarehouse.SDK/Contracts/Policy/PolicyTypes.cs
@DataWarehouse.SDK/Contracts/Policy/PolicyEnums.cs
@DataWarehouse.SDK/Infrastructure/Policy/PolicyPersistenceComplianceValidator.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: RegulatoryTemplate definitions</name>
  <files>
    DataWarehouse.SDK/Infrastructure/Policy/RegulatoryTemplate.cs
  </files>
  <action>
Create RegulatoryTemplate and supporting types in DataWarehouse.SDK.Infrastructure.Policy:

**RegulatoryRequirement** sealed record:
- RequirementId (string, e.g., "HIPAA-ENC-01")
- Description (string, human-readable)
- Category (string, e.g., "encryption", "access_control", "audit")
- FeatureId (string, the policy feature this requirement maps to)
- MinimumIntensity (int, minimum acceptable intensity level 0-100)
- RequiredCascade (CascadeStrategy?, if the framework mandates a specific cascade strategy, null if any)
- MaxAiAutonomy (AiAutonomyLevel?, max AI autonomy permitted, null if unrestricted)
- RequiredParameters (Dictionary&lt;string, string&gt;?, custom parameters that must be present and match)
- Weight (double, 0.0-1.0, relative importance for scoring)
- Remediation (string, what to do if this requirement fails)

**RegulatoryTemplate** sealed record:
- FrameworkName (string, e.g., "HIPAA", "GDPR")
- FrameworkVersion (string, e.g., "2024")
- Description (string)
- Requirements (IReadOnlyList&lt;RegulatoryRequirement&gt;)

**Built-in static factory methods** on RegulatoryTemplate:

RegulatoryTemplate.Hipaa() -- ~10 requirements:
- HIPAA-ENC-01: encryption intensity >= 80, cascade MostRestrictive
- HIPAA-ENC-02: encryption AiAutonomy <= Suggest
- HIPAA-AUD-01: audit intensity >= 90, cascade Enforce
- HIPAA-ACC-01: access_control intensity >= 80
- HIPAA-ACC-02: access_control cascade MostRestrictive
- HIPAA-REP-01: replication intensity >= 60
- HIPAA-GOV-01: governance intensity >= 70, cascade Merge
- HIPAA-RET-01: retention intensity >= 80
- HIPAA-BAK-01: backup intensity >= 70
- HIPAA-MON-01: monitoring intensity >= 60

RegulatoryTemplate.Gdpr() -- ~8 requirements:
- GDPR-PRI-01: data_privacy intensity >= 80
- GDPR-ENC-01: encryption intensity >= 70
- GDPR-RET-01: retention configurable (parameter "retention_policy" must exist)
- GDPR-AUD-01: audit intensity >= 70
- GDPR-ACC-01: access_control intensity >= 70
- GDPR-GOV-01: governance intensity >= 80, cascade Merge
- GDPR-DEL-01: deletion intensity >= 80 (right to be forgotten)
- GDPR-PORT-01: portability parameter "export_format" must exist

RegulatoryTemplate.Soc2() -- ~8 requirements:
- SOC2-SEC-01: security intensity >= 70
- SOC2-AV-01: availability intensity >= 70
- SOC2-INT-01: integrity intensity >= 70
- SOC2-CON-01: confidentiality intensity >= 70
- SOC2-PRI-01: privacy intensity >= 70
- SOC2-AUD-01: audit intensity >= 80
- SOC2-CHG-01: change_management intensity >= 60
- SOC2-MON-01: monitoring intensity >= 70

RegulatoryTemplate.FedRamp() -- ~8 requirements:
- FEDRAMP-ENC-01: encryption intensity >= 90, cascade Enforce
- FEDRAMP-ENC-02: encryption AiAutonomy = ManualOnly
- FEDRAMP-AUD-01: audit intensity >= 95, cascade Enforce
- FEDRAMP-ACC-01: access_control intensity >= 90, cascade MostRestrictive
- FEDRAMP-ACC-02: access_control AiAutonomy <= Suggest
- FEDRAMP-MON-01: monitoring intensity >= 80
- FEDRAMP-INC-01: incident_response intensity >= 80
- FEDRAMP-BAK-01: backup intensity >= 80

All requirements have meaningful Weight values (0.5-1.0) and actionable Remediation strings.
[SdkCompatibility("6.0.0", Notes = "Phase 70: Compliance scoring (PADV-03)")]
  </action>
  <verify>dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore 2>&1 | tail -5</verify>
  <done>RegulatoryTemplate with 4 built-in frameworks (HIPAA ~10, GDPR ~8, SOC2 ~8, FedRAMP ~8 requirements) compiles successfully.</done>
</task>

<task type="auto">
  <name>Task 2: PolicyComplianceScorer</name>
  <files>
    DataWarehouse.SDK/Infrastructure/Policy/PolicyComplianceScorer.cs
  </files>
  <action>
Create PolicyComplianceScorer in DataWarehouse.SDK.Infrastructure.Policy:

**ComplianceGapItem** sealed record:
- Requirement (RegulatoryRequirement)
- Passed (bool)
- ActualIntensity (int?, null if feature not found in policies)
- ActualCascade (CascadeStrategy?, null if not evaluated)
- ActualAiAutonomy (AiAutonomyLevel?, null if not evaluated)
- MissingParameters (IReadOnlyList&lt;string&gt;, parameter keys required but absent)
- GapDescription (string, human-readable description of the gap)
- Remediation (string, from the requirement)

**ComplianceScoreReport** sealed record:
- FrameworkName (string)
- FrameworkVersion (string)
- Score (int, 0-100 weighted score)
- TotalRequirements (int)
- PassedRequirements (int)
- FailedRequirements (int)
- Gaps (IReadOnlyList&lt;ComplianceGapItem&gt;, only failed items)
- AllItems (IReadOnlyList&lt;ComplianceGapItem&gt;, all items including passed)
- ScoredAt (DateTimeOffset)
- Grade (string, derived: A=90+, B=80+, C=70+, D=60+, F=below 60)

**PolicyComplianceScorer** sealed class:
- Constructor takes IReadOnlyDictionary&lt;string, FeaturePolicy&gt; (the policies to score -- typically from the active OperationalProfile.FeaturePolicies or resolved effective policies).
- Method ScoreAgainst(RegulatoryTemplate template) returns ComplianceScoreReport:
  1. For each RegulatoryRequirement in template:
     a. Find the matching FeaturePolicy by FeatureId. If not found, mark as failed with "Feature not configured."
     b. Check MinimumIntensity: if policy.IntensityLevel < req.MinimumIntensity, fail
     c. Check RequiredCascade: if req has one and policy.Cascade != req.RequiredCascade, fail
     d. Check MaxAiAutonomy: if req has one and (int)policy.AiAutonomy > (int)req.MaxAiAutonomy, fail
     e. Check RequiredParameters: for each required param key, check policy.CustomParameters contains it and value matches
     f. Build ComplianceGapItem with all details
  2. Calculate weighted score: sum(passed_req.Weight) / sum(all_req.Weight) * 100, rounded to int
  3. Build ComplianceScoreReport

- Method ScoreAll(params RegulatoryTemplate[] templates) returns IReadOnlyList&lt;ComplianceScoreReport&gt;.
- Static convenience: ScoreAll(IReadOnlyDictionary&lt;string, FeaturePolicy&gt; policies) that runs against all 4 built-in templates.

Follow the pattern of PolicyPersistenceComplianceValidator (Phase 69) for consistency -- static-friendly, no external dependencies, production-ready hardcoded rules.
[SdkCompatibility("6.0.0", Notes = "Phase 70: Compliance scoring (PADV-03)")]
  </action>
  <verify>dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore 2>&1 | tail -5</verify>
  <done>PolicyComplianceScorer evaluates policies against regulatory templates, produces scored gap analysis reports with per-requirement pass/fail, weighted score (0-100), grade (A-F), and remediation suggestions.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` succeeds with zero errors
- RegulatoryTemplate has factory methods for HIPAA, GDPR, SOC2, FedRAMP
- PolicyComplianceScorer produces ComplianceScoreReport with score, grade, gaps, and remediation
</verification>

<success_criteria>
- PADV-03 satisfied: compliance scoring against HIPAA/GDPR/SOC2/FedRAMP templates with gap analysis report
- Each gap item includes requirement ID, actual vs required values, and remediation suggestion
- Scoring produces 0-100 score with letter grade per framework
</success_criteria>

<output>
After completion, create `.planning/phases/70-cascade-engine/70-06-SUMMARY.md`
</output>
