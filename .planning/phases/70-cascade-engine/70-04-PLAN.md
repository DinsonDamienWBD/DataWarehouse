---
phase: 70-cascade-engine
plan: 04
type: execute
wave: 3
depends_on: ["70-01", "70-02"]
files_modified:
  - DataWarehouse.SDK/Infrastructure/Policy/VersionedPolicyCache.cs
  - DataWarehouse.SDK/Infrastructure/Policy/CircularReferenceDetector.cs
  - DataWarehouse.SDK/Infrastructure/Policy/MergeConflictResolver.cs
  - DataWarehouse.SDK/Infrastructure/Policy/PolicyResolutionEngine.cs
autonomous: true

must_haves:
  truths:
    - "In-flight operations see their start-time policy snapshot; new policy takes effect for next operation only"
    - "Circular policy references are detected during store validation and rejected with a clear error"
    - "Merge conflict resolution is configurable per tag key (MostRestrictive, Closest, Union)"
  artifacts:
    - path: "DataWarehouse.SDK/Infrastructure/Policy/VersionedPolicyCache.cs"
      provides: "Double-buffered versioned cache for CASC-06 snapshot isolation"
      contains: "class VersionedPolicyCache"
    - path: "DataWarehouse.SDK/Infrastructure/Policy/CircularReferenceDetector.cs"
      provides: "Circular reference detection for policy store validation"
      contains: "class CircularReferenceDetector"
    - path: "DataWarehouse.SDK/Infrastructure/Policy/MergeConflictResolver.cs"
      provides: "Per-tag-key configurable merge conflict resolution"
      contains: "class MergeConflictResolver"
  key_links:
    - from: "PolicyResolutionEngine"
      to: "VersionedPolicyCache"
      via: "Resolution reads from versioned snapshot"
      pattern: "VersionedPolicyCache|_cache"
    - from: "PolicyResolutionEngine"
      to: "MergeConflictResolver"
      via: "Merge strategy delegates conflict resolution"
      pattern: "MergeConflictResolver|_conflictResolver"
    - from: "IPolicyStore.SetAsync"
      to: "CircularReferenceDetector"
      via: "Validation before store write"
      pattern: "CircularReferenceDetector|DetectCircular"
---

<objective>
Add safety mechanisms: double-buffered versioned cache for in-flight snapshot isolation, circular reference detection on policy writes, and configurable merge conflict resolution per tag key.

Purpose: CASC-06 (snapshot isolation), CASC-07 (circular detection), and CASC-08 (merge conflict config) are the safety rails that prevent policy resolution from producing inconsistent, circular, or ambiguous results.
Output: Three focused safety components + engine integration.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@DataWarehouse.SDK/Contracts/Policy/PolicyEnums.cs
@DataWarehouse.SDK/Contracts/Policy/PolicyTypes.cs
@.planning/phases/70-cascade-engine/70-01-SUMMARY.md
@.planning/phases/70-cascade-engine/70-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: VersionedPolicyCache, CircularReferenceDetector, MergeConflictResolver</name>
  <files>
    DataWarehouse.SDK/Infrastructure/Policy/VersionedPolicyCache.cs
    DataWarehouse.SDK/Infrastructure/Policy/CircularReferenceDetector.cs
    DataWarehouse.SDK/Infrastructure/Policy/MergeConflictResolver.cs
  </files>
  <action>
**VersionedPolicyCache** (CASC-06):
- Double-buffered design: maintains two snapshots (current + previous). Each snapshot has a monotonically increasing version number (long).
- GetSnapshot() returns a PolicyCacheSnapshot (a readonly struct or sealed record containing: version number, DateTimeOffset timestamp, and a reference to the immutable dictionary of policies at that version).
- When policies are modified (via SetAsync on the store), the cache increments version and swaps the buffers using Interlocked.Exchange. The previous snapshot remains valid for any in-flight operations still referencing it.
- PolicyCacheSnapshot wraps IReadOnlyDictionary&lt;string, FeaturePolicy&gt; keyed by "featureId:level:path".
- Thread-safe via immutable snapshots + Interlocked operations (no locks).
- In-flight operations call GetSnapshot() at start time and use that snapshot throughout, even if policies change mid-operation. New operations get the latest snapshot.

**CircularReferenceDetector** (CASC-07):
- Static method Validate(string featureId, PolicyLevel level, string path, FeaturePolicy policy, IPolicyStore store) that checks for circular policy references.
- A circular reference occurs when a policy's CustomParameters contain a "redirect" or "inherit_from" key that points back to a path that eventually references the original. Walk the redirect chain up to a max depth of 20 hops (configurable). If a cycle is detected, throw PolicyCircularReferenceException (custom exception inheriting InvalidOperationException) with a clear message: "Circular policy reference detected: {path chain}".
- Also validate that Enforce policies don't exist at Block level (enforce only makes sense at Container or higher where there are descendants to enforce upon). Warn but don't reject -- add to a warnings list.
- Return a ValidationResult with IsValid, Errors (blocking), Warnings (informational).

**MergeConflictResolver** (CASC-08):
- Resolves merge conflicts for the Merge cascade strategy on a per-tag-key basis.
- Three resolution modes as an enum MergeConflictMode: MostRestrictive, Closest, Union.
- Constructor takes Dictionary&lt;string, MergeConflictMode&gt; mapping tag keys to their resolution mode. Unmatched keys default to Closest (child wins).
- Method Resolve(string tagKey, IReadOnlyList&lt;string&gt; values) where values are ordered most-specific-first:
  - MostRestrictive: if values are numeric, take Math.Min. If values are string, take the lexicographically smallest.
  - Closest: return values[0] (most specific wins).
  - Union: return all distinct values joined by ";" separator.
- [SdkCompatibility("6.0.0")] on all three classes.
  </action>
  <verify>dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore 2>&1 | tail -5</verify>
  <done>VersionedPolicyCache provides immutable snapshots. CircularReferenceDetector validates redirect chains. MergeConflictResolver supports MostRestrictive/Closest/Union per tag key.</done>
</task>

<task type="auto">
  <name>Task 2: Wire safety mechanisms into PolicyResolutionEngine</name>
  <files>
    DataWarehouse.SDK/Infrastructure/Policy/PolicyResolutionEngine.cs
  </files>
  <action>
Update PolicyResolutionEngine to integrate the three safety mechanisms:

1. **VersionedPolicyCache (CASC-06)**:
   - Add optional VersionedPolicyCache as constructor parameter.
   - In ResolveAsync, if cache is available: call cache.GetSnapshot() at the start of resolution. Use the snapshot's policy data instead of live store queries. The SnapshotTimestamp on the returned EffectivePolicy comes from the cache snapshot timestamp.
   - If cache is null, fall back to direct IPolicyStore queries (backward compatible).
   - When policies are set/removed on the store, bump the cache version. Add a method NotifyCacheUpdate() that the store can call or that wraps SetAsync.

2. **CircularReferenceDetector (CASC-07)**:
   - Add a public method ValidatePolicy(string featureId, PolicyLevel level, string path, FeaturePolicy policy, CancellationToken ct) that runs CircularReferenceDetector.Validate before accepting a policy into the store. This is a pre-write validation hook.
   - If validation fails (circular reference detected), throw the PolicyCircularReferenceException -- do NOT store the policy.
   - Log warnings from the validation result.

3. **MergeConflictResolver (CASC-08)**:
   - Add optional MergeConflictResolver as constructor parameter.
   - In the Merge strategy path (from Plan 02 CascadeStrategies.Merge), when merging custom parameters: for each conflicting key, delegate to _conflictResolver.Resolve(key, conflictingValues) instead of always taking the child value.
   - If no resolver configured, fall back to child-wins (Closest) for backward compatibility.

Keep changes minimal. Do NOT refactor existing method signatures. Add parameters to the constructor as optional with null defaults.
  </action>
  <verify>dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore 2>&1 | tail -5</verify>
  <done>Engine uses versioned cache for snapshot isolation (CASC-06), validates policy writes for circular references (CASC-07), and delegates merge conflicts to configurable resolver (CASC-08).</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` succeeds with zero errors
- VersionedPolicyCache provides immutable snapshots with version numbers
- CircularReferenceDetector throws PolicyCircularReferenceException on cycles
- MergeConflictResolver supports 3 modes per tag key
- PolicyResolutionEngine integrates all three mechanisms
</verification>

<success_criteria>
- CASC-06 satisfied: in-flight operations use start-time snapshot, new policy effective for next operation
- CASC-07 satisfied: circular references detected and rejected with clear error
- CASC-08 satisfied: merge conflict resolution configurable per tag key
</success_criteria>

<output>
After completion, create `.planning/phases/70-cascade-engine/70-04-SUMMARY.md`
</output>
