---
phase: 19-app-platform
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Plugins/DataWarehouse.Plugins.AppPlatform/DataWarehouse.Plugins.AppPlatform.csproj
  - Plugins/DataWarehouse.Plugins.AppPlatform/AppPlatformPlugin.cs
  - Plugins/DataWarehouse.Plugins.AppPlatform/Models/AppRegistration.cs
  - Plugins/DataWarehouse.Plugins.AppPlatform/Models/ServiceToken.cs
  - Plugins/DataWarehouse.Plugins.AppPlatform/Models/PlatformTopics.cs
  - Plugins/DataWarehouse.Plugins.AppPlatform/Services/AppRegistrationService.cs
  - Plugins/DataWarehouse.Plugins.AppPlatform/Services/ServiceTokenService.cs
  - DataWarehouse.slnx
autonomous: true
must_haves:
  truths:
    - "An application can register with DW and receive a unique AppId"
    - "A registered app can create service tokens scoped to specific services"
    - "Service tokens are validated by hash comparison (raw key never stored)"
    - "Tokens can be rotated and revoked with immediate effect"
    - "App registration creates a corresponding tenant in UltimateAccessControl via message bus"
    - "All platform operations use message bus topics with 'platform.' prefix"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.AppPlatform/DataWarehouse.Plugins.AppPlatform.csproj"
      provides: "Project file with SDK-only reference"
      contains: "DataWarehouse.SDK.csproj"
    - path: "Plugins/DataWarehouse.Plugins.AppPlatform/AppPlatformPlugin.cs"
      provides: "Main plugin extending IntelligenceAwarePluginBase"
      contains: "IntelligenceAwarePluginBase"
    - path: "Plugins/DataWarehouse.Plugins.AppPlatform/Models/AppRegistration.cs"
      provides: "App registration sealed records (AppRegistration, AppStatus, AppServiceConfig)"
      contains: "sealed record AppRegistration"
    - path: "Plugins/DataWarehouse.Plugins.AppPlatform/Models/ServiceToken.cs"
      provides: "Service token sealed record with hash-based storage"
      contains: "sealed record ServiceToken"
    - path: "Plugins/DataWarehouse.Plugins.AppPlatform/Models/PlatformTopics.cs"
      provides: "Message bus topic constants for all platform operations"
      contains: "static class PlatformTopics"
    - path: "Plugins/DataWarehouse.Plugins.AppPlatform/Services/AppRegistrationService.cs"
      provides: "Registration CRUD with tenant provisioning via message bus"
      contains: "sealed class AppRegistrationService"
    - path: "Plugins/DataWarehouse.Plugins.AppPlatform/Services/ServiceTokenService.cs"
      provides: "Token generation, validation, rotation, revocation with HMAC-SHA256"
      contains: "sealed class ServiceTokenService"
  key_links:
    - from: "AppPlatformPlugin.cs"
      to: "AppRegistrationService.cs"
      via: "private field instantiation and message handler delegation"
      pattern: "_registrationService"
    - from: "AppPlatformPlugin.cs"
      to: "ServiceTokenService.cs"
      via: "private field instantiation and message handler delegation"
      pattern: "_tokenService"
    - from: "AppRegistrationService.cs"
      to: "accesscontrol.tenant.register"
      via: "message bus SendAsync to UltimateAccessControl"
      pattern: "SendAsync.*accesscontrol\\.tenant"
    - from: "ServiceTokenService.cs"
      to: "SHA256"
      via: "System.Security.Cryptography for token hashing"
      pattern: "SHA256\\.HashData"
---

<objective>
Create the AppPlatform plugin foundation with app registration and service token management.

Purpose: This is the core of the platform -- apps register, get IDs, and receive service tokens to authenticate against DW services. Registration maps apps to tenants in the existing multi-tenancy system via message bus.

Output: New `DataWarehouse.Plugins.AppPlatform` plugin with registration CRUD and token lifecycle.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-app-platform/19-RESEARCH.md
@Plugins/DataWarehouse.Plugins.DataMarketplace/DataWarehouse.Plugins.DataMarketplace.csproj
@Plugins/DataWarehouse.Plugins.DataMarketplace/DataMarketplacePlugin.cs
@DataWarehouse.SDK/Contracts/IntelligenceAware/IntelligenceAwarePluginBase.cs
@DataWarehouse.SDK/Contracts/IMessageBus.cs
@DataWarehouse.SDK/Contracts/PluginBase.cs
@DataWarehouse.SDK/Utilities/PluginDetails.cs
@DataWarehouse.SDK/Primitives/Enums.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AppPlatform plugin project with models and topic constants</name>
  <files>
    Plugins/DataWarehouse.Plugins.AppPlatform/DataWarehouse.Plugins.AppPlatform.csproj
    Plugins/DataWarehouse.Plugins.AppPlatform/Models/AppRegistration.cs
    Plugins/DataWarehouse.Plugins.AppPlatform/Models/ServiceToken.cs
    Plugins/DataWarehouse.Plugins.AppPlatform/Models/PlatformTopics.cs
    DataWarehouse.slnx
  </files>
  <action>
1. Create directory `Plugins/DataWarehouse.Plugins.AppPlatform/` with `Models/` and `Services/` subdirectories.

2. Create `.csproj` following DataMarketplace pattern exactly:
   - `net10.0`, `ImplicitUsings enable`, `Nullable enable`, `TreatWarningsAsErrors true`, `LangVersion latest`
   - `GenerateDocumentationFile true`, `NoWarn $(NoWarn);CS1591`
   - Single `ProjectReference` to `..\..\DataWarehouse.SDK\DataWarehouse.SDK.csproj`
   - Description: "Application Platform Services plugin for DataWarehouse. Enables registered applications to consume DW services with per-app isolation, service tokens, AI workflows, access control policies, and observability."

3. Create `Models/AppRegistration.cs` in namespace `DataWarehouse.Plugins.AppPlatform.Models`:
   - `sealed record AppRegistration` with: `required string AppId`, `required string AppName`, `string? DisplayName`, `string? Description`, `required string OwnerUserId`, `required string[] CallbackUrls`, `AppStatus Status` (default Active), `required DateTime CreatedAt`, `DateTime? UpdatedAt`, `DateTime? SuspendedAt`, `string? SuspensionReason`, `AppServiceConfig ServiceConfig` (default new()), `Dictionary<string, object> Metadata` (default new())
   - `enum AppStatus` with: Pending, Active, Suspended, Deactivated, Deleted
   - `sealed record AppServiceConfig` with: `int MaxUsers` (default 100), `int MaxResources` (default 10000), `long MaxStorageBytes` (default 1_073_741_824), `string[] EnabledServices` (default ["storage", "accesscontrol", "intelligence", "observability"])
   - All with XML docs on every type and property.

4. Create `Models/ServiceToken.cs` in same namespace:
   - `sealed record ServiceToken` with: `required string TokenId`, `required string AppId`, `required string TokenHash` (HMAC-SHA256 of raw key), `required DateTime CreatedAt`, `required DateTime ExpiresAt`, `required string[] AllowedScopes`, `bool IsRevoked` (default false), `DateTime? RevokedAt`, `string? RevocationReason`
   - `sealed record TokenValidationResult` with: `bool IsValid`, `string? AppId`, `string? TokenId`, `string[] AllowedScopes` (default []), `string? FailureReason`
   - All with XML docs.

5. Create `Models/PlatformTopics.cs` in same namespace:
   - `internal static class PlatformTopics` with const string fields:
     - Prefix = "platform"
     - App lifecycle: AppRegister, AppDeregister, AppUpdate, AppGet, AppList
     - Token management: TokenCreate, TokenRotate, TokenRevoke, TokenValidate
     - Service routing: ServiceStorage, ServiceAccessControl, ServiceIntelligence, ServiceObservability, ServiceReplication, ServiceCompliance
   - Each const uses string interpolation with Prefix: `$"{Prefix}.register"`, etc.
   - XML docs on each field.

6. Add the new project to `DataWarehouse.slnx` in the `/Plugins/` folder section, alphabetically among existing plugins:
   `<Project Path="Plugins/DataWarehouse.Plugins.AppPlatform/DataWarehouse.Plugins.AppPlatform.csproj" />`
  </action>
  <verify>
Run `dotnet build Plugins/DataWarehouse.Plugins.AppPlatform/DataWarehouse.Plugins.AppPlatform.csproj` -- must compile with zero errors and zero warnings (other than CS1591).
  </verify>
  <done>
AppPlatform project exists in solution with all model types compiling. AppRegistration, ServiceToken, PlatformTopics all defined with full XML docs. Project references only the SDK.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement AppRegistrationService, ServiceTokenService, and AppPlatformPlugin</name>
  <files>
    Plugins/DataWarehouse.Plugins.AppPlatform/Services/AppRegistrationService.cs
    Plugins/DataWarehouse.Plugins.AppPlatform/Services/ServiceTokenService.cs
    Plugins/DataWarehouse.Plugins.AppPlatform/AppPlatformPlugin.cs
  </files>
  <action>
1. Create `Services/AppRegistrationService.cs` in namespace `DataWarehouse.Plugins.AppPlatform.Services`:
   - `internal sealed class AppRegistrationService` with XML docs.
   - Constructor takes `IMessageBus messageBus, string pluginId`.
   - `ConcurrentDictionary<string, AppRegistration> _registrations` for in-memory storage.
   - `RegisterAppAsync(string appName, string ownerUserId, string[] callbackUrls, AppServiceConfig? config)` method:
     * Generates AppId via `Guid.NewGuid().ToString("N")`.
     * Creates `AppRegistration` record with `CreatedAt = DateTime.UtcNow`.
     * Stores in `_registrations`.
     * Sends tenant registration to UltimateAccessControl via message bus: `_messageBus.SendAsync("accesscontrol.tenant.register", new PluginMessage { Type = "accesscontrol.tenant.register", SourcePluginId = _pluginId, Payload = { ["TenantId"] = appId, ["TenantName"] = appName, ["MaxUsers"] = config.MaxUsers, ["MaxResources"] = config.MaxResources, ["MaxStorageBytes"] = config.MaxStorageBytes, ["IsolationLevel"] = "Strict" } })`.
     * Returns the AppRegistration.
   - `DeregisterAppAsync(string appId)` method:
     * Sets status to Deleted, records UpdatedAt.
     * Sends tenant deregistration via message bus: `_messageBus.SendAsync("accesscontrol.tenant.deregister", ...)`.
     * Returns bool success.
   - `GetAppAsync(string appId)` -- lookup by ID, return AppRegistration or null.
   - `ListAppsAsync()` -- return all active registrations.
   - `UpdateAppAsync(string appId, string? displayName, string? description, AppServiceConfig? config)` -- update mutable fields.
   - `SuspendAppAsync(string appId, string reason)` -- set Suspended status with reason and SuspendedAt.
   - `ReactivateAppAsync(string appId)` -- set Active status, clear suspension fields.
   - All methods must be thread-safe using ConcurrentDictionary operations.

2. Create `Services/ServiceTokenService.cs` in same namespace:
   - `internal sealed class ServiceTokenService` with XML docs.
   - `ConcurrentDictionary<string, ServiceToken> _tokens` for storage.
   - `ConcurrentDictionary<string, TokenValidationResult> _validationCache` with 30-second TTL for performance.
   - `CreateTokenAsync(string appId, string[] scopes, TimeSpan validity)`:
     * Generate 32 random bytes via `RandomNumberGenerator.GetBytes(32)`.
     * Convert to Base64 as rawKey.
     * Compute SHA256 hash of rawKey via `SHA256.HashData(Encoding.UTF8.GetBytes(rawKey))` and Base64-encode.
     * Create `ServiceToken` record with `TokenId = Guid.NewGuid().ToString("N")`.
     * Store in `_tokens`.
     * Return tuple `(string RawKey, ServiceToken Token)` -- raw key returned exactly once.
   - `ValidateTokenAsync(string rawKey)`:
     * Check validation cache first (key = hash, TTL 30s).
     * Compute hash of rawKey.
     * Find token in `_tokens.Values` where `TokenHash` matches, `!IsRevoked`, and `ExpiresAt > DateTime.UtcNow`.
     * Return `TokenValidationResult` with IsValid, AppId, TokenId, AllowedScopes, or FailureReason.
     * Cache the result.
   - `RotateTokenAsync(string appId, string oldRawKey, string[] scopes, TimeSpan validity)`:
     * Validate old token. If invalid, return null.
     * Revoke old token (set IsRevoked, RevokedAt, RevocationReason = "Rotated").
     * Create new token with same appId and scopes.
     * Invalidate validation cache for old hash.
     * Return new (rawKey, token) tuple.
   - `RevokeTokenAsync(string tokenId, string reason)`:
     * Find token by ID. Update with `IsRevoked = true, RevokedAt = DateTime.UtcNow, RevocationReason = reason`.
     * Invalidate cache entry.
     * Return bool success.
   - `RevokeAllTokensForAppAsync(string appId)`:
     * Revoke all tokens matching appId.
     * Return count of revoked tokens.
   - Private helper `ComputeHash(string input)` using SHA256.HashData + Base64.

3. Create `AppPlatformPlugin.cs` in namespace `DataWarehouse.Plugins.AppPlatform`:
   - `public sealed class AppPlatformPlugin : IntelligenceAwarePluginBase, IDisposable`
   - Override: `Id => "com.datawarehouse.platform.app"`, `Name => "Application Platform Services"`, `Version => "1.0.0"`, `Category => PluginCategory.FeatureProvider`
   - Private fields: `AppRegistrationService? _registrationService`, `ServiceTokenService? _tokenService`, `List<IDisposable> _subscriptions = new()`, `bool _disposed`.
   - Override `OnStartWithIntelligenceAsync` and `OnStartWithoutIntelligenceAsync` -- both call `InitializeServices()`
     * `InitializeServices()`:
       - Create `_registrationService = new AppRegistrationService(MessageBus!, Id)`
       - Create `_tokenService = new ServiceTokenService()`
       - Call `SubscribeToPlatformTopics()`
   - `SubscribeToPlatformTopics()` subscribes to all PlatformTopics constants via `MessageBus!.Subscribe(topic, handler)` using the response-capable overload. Store each IDisposable in `_subscriptions`.
     * PlatformTopics.AppRegister -> HandleAppRegisterAsync
     * PlatformTopics.AppDeregister -> HandleAppDeregisterAsync
     * PlatformTopics.AppGet -> HandleAppGetAsync
     * PlatformTopics.AppList -> HandleAppListAsync
     * PlatformTopics.AppUpdate -> HandleAppUpdateAsync
     * PlatformTopics.TokenCreate -> HandleTokenCreateAsync
     * PlatformTopics.TokenRotate -> HandleTokenRotateAsync
     * PlatformTopics.TokenRevoke -> HandleTokenRevokeAsync
     * PlatformTopics.TokenValidate -> HandleTokenValidateAsync
   - Each handler extracts Payload fields from PluginMessage, delegates to service, returns `MessageResponse.Ok(result)` or `MessageResponse.Error(message)`.
   - `HandleAppRegisterAsync`: extracts AppName, OwnerUserId, CallbackUrls, ServiceConfig from Payload. Calls `_registrationService.RegisterAppAsync(...)`. Returns MessageResponse.Ok with the AppRegistration.
   - `HandleTokenCreateAsync`: extracts AppId, Scopes, ValidityMinutes from Payload. Calls `_tokenService.CreateTokenAsync(...)`. Returns MessageResponse.Ok with new object containing RawKey and Token (raw key returned to caller exactly once).
   - `HandleTokenValidateAsync`: extracts RawKey from Payload. Returns MessageResponse.Ok with TokenValidationResult.
   - Override `StopAsync()`: Dispose all subscriptions, call `base.StopAsync()`.
   - `Dispose()`: Dispose subscriptions, set `_disposed = true`.
   - XML docs on plugin class, all handler methods, and public members.
  </action>
  <verify>
Run `dotnet build Plugins/DataWarehouse.Plugins.AppPlatform/DataWarehouse.Plugins.AppPlatform.csproj` -- must compile with zero errors. Verify: (1) AppPlatformPlugin extends IntelligenceAwarePluginBase, (2) no direct references to any other plugin project, (3) message bus topics used for tenant registration in AccessControl, (4) ServiceTokenService uses SHA256.HashData (not HMAC), (5) raw key never stored in ServiceToken record.
  </verify>
  <done>
AppPlatformPlugin subscribes to all platform topics and delegates to AppRegistrationService and ServiceTokenService. Registration creates tenant via message bus. Token creation returns raw key exactly once and stores only the SHA256 hash. Token validation uses hash comparison with caching. Full plugin lifecycle management with IDisposable.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build Plugins/DataWarehouse.Plugins.AppPlatform/DataWarehouse.Plugins.AppPlatform.csproj` compiles with zero errors
2. Plugin project references ONLY `DataWarehouse.SDK.csproj` -- no other plugin references
3. `AppPlatformPlugin` extends `IntelligenceAwarePluginBase` and implements `IDisposable`
4. All model types are `sealed record` with `required` properties
5. `ServiceTokenService.ComputeHash` uses `SHA256.HashData` from System.Security.Cryptography
6. `AppRegistrationService.RegisterAppAsync` sends message to `accesscontrol.tenant.register` topic
7. All classes have XML documentation comments
8. Plugin added to DataWarehouse.slnx
</verification>

<success_criteria>
- AppPlatform plugin builds cleanly with SDK-only dependency
- App registration creates tenant in access control via message bus
- Service tokens use SHA256 hash storage; raw key returned once on creation
- Token validation, rotation, and revocation all functional
- All 9 message bus topic handlers wired in the plugin
</success_criteria>

<output>
After completion, create `.planning/phases/19-app-platform/19-01-SUMMARY.md`
</output>
