---
phase: 12-aeds-system
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - Plugins/DataWarehouse.Plugins.AedsCore/DataPlane/QuicDataPlanePlugin.cs
  - Plugins/DataWarehouse.Plugins.AedsCore/DataPlane/Http3DataPlanePlugin.cs
  - Plugins/DataWarehouse.Plugins.AedsCore/DataPlane/WebTransportDataPlanePlugin.cs
autonomous: true

must_haves:
  truths:
    - "QUIC data plane multiplexes streams with 0-RTT connection resumption"
    - "HTTP/3 data plane leverages QUIC for multiplexed chunk downloads"
    - "WebTransport data plane is stubbed with NotSupportedException (awaiting .NET API support)"
    - "All data plane transports verify ContentHash and ChunkHashes for integrity"
    - "Progress reporting works via IProgress<TransferProgress> with bytes/second calculation"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.AedsCore/DataPlane/QuicDataPlanePlugin.cs"
      provides: "Raw QUIC streams, multiplexed chunk downloads, connection pooling"
      min_lines: 200
    - path: "Plugins/DataWarehouse.Plugins.AedsCore/DataPlane/Http3DataPlanePlugin.cs"
      provides: "HTTP/3 over QUIC, standard HTTP semantics, chunk integrity"
      min_lines: 200
    - path: "Plugins/DataWarehouse.Plugins.AedsCore/DataPlane/WebTransportDataPlanePlugin.cs"
      provides: "WebTransport stub (future support)"
      min_lines: 50
  key_links:
    - from: "QuicDataPlanePlugin.FetchPayloadAsync"
      to: "System.Net.Quic.QuicConnection"
      via: ".NET 9 native QUIC"
      pattern: "QuicConnection.*ConnectAsync"
    - from: "Http3DataPlanePlugin.FetchPayloadAsync"
      to: "HttpClient with HttpVersion.Version30"
      via: "HTTP/3 over QUIC"
      pattern: "HttpVersion.Version30"
    - from: "All data planes"
      to: "SHA-256 verification"
      via: "System.Security.Cryptography.SHA256"
      pattern: "SHA256.HashData|ComputeHash"
---

<objective>
Implement 3 Data Plane transport plugins (QUIC, HTTP/3, WebTransport) for high-bandwidth payload transfers in AEDS, with chunked downloads, integrity verification, and progress reporting.

Purpose: Provide high-performance bulk transfer options optimized for different network conditions
Output: 2 production-ready data plane transports (QUIC, HTTP/3) + 1 stub (WebTransport awaiting .NET API support)
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-aeds-system/12-RESEARCH.md

# AEDS SDK contracts
@DataWarehouse.SDK/Distribution/IAedsCore.cs
@DataWarehouse.SDK/Contracts/AedsPluginBases.cs

# Reference existing HTTP/2 data plane
@Plugins/DataWarehouse.Plugins.AedsCore/Http2DataPlanePlugin.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement QuicDataPlanePlugin</name>
  <files>Plugins/DataWarehouse.Plugins.AedsCore/DataPlane/QuicDataPlanePlugin.cs</files>
  <action>
Create `Plugins/DataWarehouse.Plugins.AedsCore/DataPlane/QuicDataPlanePlugin.cs` with production-ready raw QUIC transport for multiplexed stream-based transfers.

**Inherit from:** `DataPlaneTransportPluginBase` (from AedsPluginBases.cs)

**TransportId:** `"quic"`

**Package:** System.Net.Quic (built-in to .NET 9, no external package needed)

**Implementation requirements:**

1. **FetchPayloadAsync:**
   - Parse `config.ServerUrl` to extract host/port (QUIC uses UDP, not HTTP URL scheme)
   - Create `QuicClientConnectionOptions` with TLS (required for QUIC)
   - Connect: `QuicConnection.ConnectAsync(options, ct)`
   - Open bidirectional stream: `connection.OpenOutboundStreamAsync(QuicStreamType.Bidirectional, ct)`
   - Send request on stream: write payloadId as UTF-8 bytes
   - Read response: payload chunks streamed over QUIC stream
   - Wrap in `ProgressReportingStream` (copy pattern from Http2DataPlanePlugin.cs line 349)
   - Calculate transfer rate: bytes transferred / elapsed seconds
   - Report progress via `progress?.Report(new TransferProgress(...))`
   - After download, verify SHA-256 hash matches `PayloadDescriptor.ContentHash`
   - Return stream to caller

2. **FetchDeltaAsync:**
   - Similar to FetchPayloadAsync, but send request: `{payloadId}:{baseVersion}` to signal delta download
   - Server responds with binary diff
   - Verify delta hash if provided

3. **PushPayloadAsync:**
   - Open outbound stream
   - Write metadata JSON followed by payload stream
   - Read server response with assigned PayloadId
   - Return PayloadId string

4. **CheckExistsAsync:**
   - Open stream, send HEAD request with payloadId
   - Read boolean response (exists = true/false)

5. **FetchInfoAsync:**
   - Open stream, send INFO request with payloadId
   - Read PayloadDescriptor JSON response
   - Deserialize and return

**Connection pooling:**
- Maintain `ConcurrentDictionary<string, QuicConnection>` keyed by `serverUrl`
- Reuse connections for multiple payload downloads (QUIC multiplexing)
- Implement connection lifetime: close after 60 seconds idle or 100 streams opened

**Integrity verification:**
- After download, compute SHA-256 of downloaded stream
- Compare to `PayloadDescriptor.ContentHash`
- If mismatch → throw `InvalidDataException("Content hash mismatch")`
- If `ChunkHashes` provided → verify per-chunk hashes during streaming (advanced)

**Error handling:**
- Catch `QuicException` → log and rethrow with context
- Implement retry on transient failures: connection refused, timeout (max 3 retries with exponential backoff)

**No forbidden patterns:** Zero TODOs, zero NotImplementedException.
  </action>
  <verify>
Build plugin: `dotnet build Plugins/DataWarehouse.Plugins.AedsCore/DataWarehouse.Plugins.AedsCore.csproj`
- Expect: 0 errors
Grep for violations: `rg "TODO|NotImplementedException|simulate|placeholder" Plugins/DataWarehouse.Plugins.AedsCore/DataPlane/QuicDataPlanePlugin.cs`
- Expect: 0 matches
Check QUIC usage: `rg "System.Net.Quic|QuicConnection" Plugins/DataWarehouse.Plugins.AedsCore/DataPlane/QuicDataPlanePlugin.cs`
- Expect: Proper QUIC API usage
  </verify>
  <done>
QuicDataPlanePlugin.cs exists with production-ready raw QUIC transport:
- Multiplexed stream-based transfers via bidirectional QUIC streams
- Connection pooling with idle timeout (60 seconds)
- SHA-256 integrity verification after download
- Progress reporting with transfer rate calculation
- Retry logic for transient failures (max 3 retries)
- Zero forbidden patterns
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Http3DataPlanePlugin and WebTransportDataPlanePlugin</name>
  <files>
    Plugins/DataWarehouse.Plugins.AedsCore/DataPlane/Http3DataPlanePlugin.cs
    Plugins/DataWarehouse.Plugins.AedsCore/DataPlane/WebTransportDataPlanePlugin.cs
  </files>
  <action>
Create 2 additional Data Plane transport plugins.

---

**HTTP/3 Data Plane Plugin:**

File: `Plugins/DataWarehouse.Plugins.AedsCore/DataPlane/Http3DataPlanePlugin.cs`

**Inherit from:** `DataPlaneTransportPluginBase`

**TransportId:** `"http3"`

**Package:** System.Net.Http with HTTP/3 support (built-in to .NET 9)

**Implementation:**

1. **FetchPayloadAsync:**
   - Create `HttpClient` with `SocketsHttpHandler` configured for HTTP/3:
     ```csharp
     var handler = new SocketsHttpHandler
     {
         EnableMultipleHttp3Connections = true,
         PooledConnectionIdleTimeout = TimeSpan.FromSeconds(60)
     };
     var client = new HttpClient(handler);
     ```
   - Send GET request with `HttpVersion.Version30` (HTTP/3):
     ```csharp
     var request = new HttpRequestMessage(HttpMethod.Get, $"{config.ServerUrl}/payloads/{payloadId}")
     {
         Version = HttpVersion.Version30,
         VersionPolicy = HttpVersionPolicy.RequestVersionExact
     };
     ```
   - Add `Authorization` header if `config.AuthToken` provided
   - Read response stream with progress reporting
   - Verify SHA-256 ContentHash after download
   - Return stream

2. **FetchDeltaAsync:**
   - Similar to FetchPayloadAsync, but add query param: `?baseVersion={baseVersion}`

3. **PushPayloadAsync:**
   - Send POST request with `StreamContent(data)`
   - Add metadata headers: `X-Payload-Name`, `X-Content-Hash`, `X-Size-Bytes`
   - Read response JSON with assigned PayloadId

4. **CheckExistsAsync:**
   - Send HEAD request to `/payloads/{payloadId}`
   - Return `response.IsSuccessStatusCode`

5. **FetchInfoAsync:**
   - Send GET request to `/payloads/{payloadId}/info`
   - Deserialize PayloadDescriptor from JSON response

**Fallback handling:**
- If server doesn't support HTTP/3 → graceful downgrade to HTTP/2 (VersionPolicy.RequestVersionOrLower)
- Log downgrade event: "HTTP/3 unavailable, falling back to HTTP/2"

**Connection pooling:** Built-in via HttpClient connection pooling (up to 100 connections per endpoint)

**Error handling:**
- Catch `HttpRequestException` → retry on 5xx errors (max 3 retries)
- Timeout: Use `config.Timeout` for request timeout

---

**WebTransport Data Plane Plugin (STUB):**

File: `Plugins/DataWarehouse.Plugins.AedsCore/DataPlane/WebTransportDataPlanePlugin.cs`

**Inherit from:** `DataPlaneTransportPluginBase`

**TransportId:** `"webtransport"`

**Implementation:** STUB with NotSupportedException

```csharp
using DataWarehouse.SDK.Contracts;
using DataWarehouse.SDK.Distribution;

namespace DataWarehouse.Plugins.AedsCore.DataPlane;

/// <summary>
/// WebTransport data plane plugin (FUTURE SUPPORT).
/// </summary>
/// <remarks>
/// WebTransport is not yet supported in .NET 9 System.Net.Quic API.
/// This plugin is a stub awaiting future .NET release with WebTransport support.
/// Tracked: https://github.com/dotnet/runtime/issues/XXX
/// </remarks>
public class WebTransportDataPlanePlugin : DataPlaneTransportPluginBase
{
    public override string Id => "com.datawarehouse.aeds.dataplane.webtransport";
    public override string Name => "WebTransport Data Plane (STUB)";
    public override string Version => "0.1.0";
    public override PluginCategory Category => PluginCategory.FeatureProvider;
    public override string TransportId => "webtransport";

    protected override Task<Stream> FetchPayloadAsync(
        string payloadId, DataPlaneConfig config, IProgress<TransferProgress>? progress, CancellationToken ct)
        => throw new NotSupportedException("WebTransport is not yet supported in .NET 9. Use QUIC or HTTP/3 instead.");

    protected override Task<Stream> FetchDeltaAsync(
        string payloadId, string baseVersion, DataPlaneConfig config, IProgress<TransferProgress>? progress, CancellationToken ct)
        => throw new NotSupportedException("WebTransport is not yet supported in .NET 9. Use QUIC or HTTP/3 instead.");

    protected override Task<string> PushPayloadAsync(
        Stream data, PayloadMetadata metadata, DataPlaneConfig config, IProgress<TransferProgress>? progress, CancellationToken ct)
        => throw new NotSupportedException("WebTransport is not yet supported in .NET 9. Use QUIC or HTTP/3 instead.");

    protected override Task<bool> CheckExistsAsync(string payloadId, DataPlaneConfig config, CancellationToken ct)
        => throw new NotSupportedException("WebTransport is not yet supported in .NET 9. Use QUIC or HTTP/3 instead.");

    protected override Task<PayloadDescriptor?> FetchInfoAsync(string payloadId, DataPlaneConfig config, CancellationToken ct)
        => throw new NotSupportedException("WebTransport is not yet supported in .NET 9. Use QUIC or HTTP/3 instead.");

    public override Task StartAsync(CancellationToken ct) => Task.CompletedTask;
    public override Task StopAsync() => Task.CompletedTask;
}
```

**Rationale:** Research (12-RESEARCH.md) confirms System.Net.Quic doesn't support WebTransport API yet. Stub plugin documents future enhancement opportunity.

---

**Common for both:**
- Http3DataPlanePlugin: Full implementation with HTTP/3 + fallback to HTTP/2
- WebTransportDataPlanePlugin: Stub with NotSupportedException (acceptable per research findings)
- Zero TODOs in Http3 plugin
  </action>
  <verify>
Build solution: `dotnet build Plugins/DataWarehouse.Plugins.AedsCore/DataWarehouse.Plugins.AedsCore.csproj`
- Expect: 0 errors
Check HTTP/3 usage: `rg "HttpVersion.Version30|HTTP/3" Plugins/DataWarehouse.Plugins.AedsCore/DataPlane/Http3DataPlanePlugin.cs`
- Expect: Proper HTTP/3 API usage
Check WebTransport stub: `rg "NotSupportedException.*WebTransport" Plugins/DataWarehouse.Plugins.AedsCore/DataPlane/WebTransportDataPlanePlugin.cs`
- Expect: NotSupportedException in all methods
Grep for violations in HTTP/3: `rg "TODO|placeholder" Plugins/DataWarehouse.Plugins.AedsCore/DataPlane/Http3DataPlanePlugin.cs`
- Expect: 0 matches
  </verify>
  <done>
2 additional Data Plane transports implemented:
- Http3DataPlanePlugin.cs: HTTP/3 over QUIC with fallback to HTTP/2, integrity verification
- WebTransportDataPlanePlugin.cs: Stub with NotSupportedException documenting future support
All methods implement integrity verification (SHA-256 ContentHash), progress reporting, and retry logic.
  </done>
</task>

</tasks>

<verification>
- [ ] Build passes for AedsCore plugin project with 0 errors
- [ ] 3 Data Plane transport files exist in DataPlane/ subfolder
- [ ] QuicDataPlanePlugin uses System.Net.Quic with connection pooling
- [ ] Http3DataPlanePlugin uses HttpVersion.Version30 with fallback to HTTP/2
- [ ] WebTransportDataPlanePlugin stubs all methods with NotSupportedException
- [ ] SHA-256 integrity verification implemented in QUIC and HTTP/3 plugins
- [ ] Progress reporting with transfer rate calculation (bytes/second)
- [ ] Zero TODOs in QUIC and HTTP/3 plugins
</verification>

<success_criteria>
Phase 12 Plan 03 succeeds when:
1. 3 Data Plane transport plugins implemented (QUIC, HTTP/3, WebTransport stub)
2. QuicDataPlanePlugin: Raw QUIC streams with multiplexing, connection pooling
3. Http3DataPlanePlugin: HTTP/3 over QUIC with graceful HTTP/2 fallback
4. WebTransportDataPlanePlugin: Stub with NotSupportedException (acceptable per research)
5. Integrity verification: SHA-256 ContentHash checked after download
6. Progress reporting: IProgress<TransferProgress> with bytes/second calculation
7. Retry logic for transient failures (max 3 retries with exponential backoff)
8. Zero forbidden patterns in QUIC and HTTP/3 plugins (Rule 13 compliant)
9. Build passes with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-aeds-system/12-03-SUMMARY.md` with:
- 2 production-ready data plane transports (QUIC, HTTP/3)
- 1 stub transport (WebTransport awaiting .NET API support)
- Transport selection guidance (QUIC for raw streams, HTTP/3 for standard HTTP semantics)
- Integrity verification approach (SHA-256 ContentHash + optional ChunkHashes)
- Fallback strategy (HTTP/3 → HTTP/2 if server doesn't support HTTP/3)
</output>
