---
phase: 61-chaos-vaccination
plan: 05
type: execute
wave: 3
depends_on: ["61-01", "61-02"]
files_modified:
  - Plugins/DataWarehouse.Plugins.ChaosVaccination/Scheduling/VaccinationScheduler.cs
  - Plugins/DataWarehouse.Plugins.ChaosVaccination/Scheduling/CronParser.cs
  - Plugins/DataWarehouse.Plugins.ChaosVaccination/Storage/InMemoryChaosResultsDatabase.cs
autonomous: true
must_haves:
  truths:
    - "Vaccination schedules run experiments on a configurable cadence (cron or interval)"
    - "Schedules respect time windows (e.g., only during business hours, only on weekdays)"
    - "All experiment results are stored and queryable"
    - "Results database provides summary statistics across experiments"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.ChaosVaccination/Scheduling/VaccinationScheduler.cs"
      provides: "Schedule management implementing IVaccinationScheduler"
      contains: "class VaccinationScheduler"
    - path: "Plugins/DataWarehouse.Plugins.ChaosVaccination/Scheduling/CronParser.cs"
      provides: "Lightweight cron expression parser"
      contains: "class CronParser"
    - path: "Plugins/DataWarehouse.Plugins.ChaosVaccination/Storage/InMemoryChaosResultsDatabase.cs"
      provides: "In-memory results database implementing IChaosResultsDatabase"
      contains: "class InMemoryChaosResultsDatabase"
  key_links:
    - from: "Plugins/DataWarehouse.Plugins.ChaosVaccination/Scheduling/VaccinationScheduler.cs"
      to: "DataWarehouse.SDK/Contracts/ChaosVaccination/IVaccinationScheduler.cs"
      via: "implements interface"
      pattern: "IVaccinationScheduler"
    - from: "Plugins/DataWarehouse.Plugins.ChaosVaccination/Storage/InMemoryChaosResultsDatabase.cs"
      to: "DataWarehouse.SDK/Contracts/ChaosVaccination/IChaosResultsDatabase.cs"
      via: "implements interface"
      pattern: "IChaosResultsDatabase"
---

<objective>
Build the vaccination scheduler and chaos results database.

Purpose: The scheduler enables automated "vaccination" -- regularly running chaos experiments to verify system resilience, similar to how vaccines periodically challenge the immune system. The results database stores all experiment outcomes for analysis, trending, and audit. Together they make chaos engineering a continuous practice, not a one-off exercise.

Output: Vaccination scheduler with cron + interval support, lightweight cron parser, and in-memory results database.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/61-chaos-vaccination/61-01-SUMMARY.md
@.planning/phases/61-chaos-vaccination/61-02-SUMMARY.md
@DataWarehouse.SDK/Contracts/ChaosVaccination/IVaccinationScheduler.cs
@DataWarehouse.SDK/Contracts/ChaosVaccination/IChaosResultsDatabase.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Cron parser and vaccination scheduler</name>
  <files>
    Plugins/DataWarehouse.Plugins.ChaosVaccination/Scheduling/CronParser.cs
    Plugins/DataWarehouse.Plugins.ChaosVaccination/Scheduling/VaccinationScheduler.cs
  </files>
  <action>
**CronParser.cs:**
- Lightweight cron expression parser -- NO external NuGet packages (Rule 13: no external deps for what can be built)
- Supports standard 5-field cron: minute hour day-of-month month day-of-week
- Special values: * (any), */N (every N), N-M (range), N,M,O (list)
- CronParser.Parse(string expression) -> CronSchedule
- CronSchedule.GetNextOccurrence(DateTimeOffset after) -> DateTimeOffset?
- CronSchedule.Matches(DateTimeOffset time) -> bool
- Handle common expressions: "0 */6 * * *" (every 6 hours), "0 2 * * 1-5" (2am weekdays), "*/30 * * * *" (every 30 min)
- Throw FormatException on invalid expressions with clear message

**VaccinationScheduler.cs** -- implements IVaccinationScheduler:
- Constructor takes IChaosInjectionEngine (from Plan 02), IMessageBus?
- Stores schedules in ConcurrentDictionary&lt;string, VaccinationSchedule&gt;
- Background timer (1-minute tick) checks all enabled schedules:
  1. For each schedule, check if CronExpression matches current time (using CronParser) OR if IntervalMs has elapsed since last run
  2. Check TimeWindow constraints: if TimeWindows specified, verify current time falls within at least one window (DayOfWeek + StartHour/EndHour + TimeZone)
  3. If due: select experiment from schedule.Experiments using weighted random selection (Weight field)
  4. Submit experiment to ChaosInjectionEngine.ExecuteExperimentAsync (fire-and-forget with error handling)
  5. Track last run time per schedule to avoid double-execution
- AddScheduleAsync: Validate schedule (at least one experiment, valid cron if specified), store, publish "chaos.schedule.added" to bus
- RemoveScheduleAsync: Remove from dictionary, publish "chaos.schedule.removed"
- GetSchedulesAsync/GetScheduleAsync: Read operations
- EnableScheduleAsync: Toggle Enabled flag
- GetNextRunTimeAsync: Use CronParser to compute next occurrence after now, respecting TimeWindows
- Concurrency: Respects schedule.MaxConcurrent -- if MaxConcurrent experiments from this schedule are already running, skip this tick
- Cleanup: IDisposable/IAsyncDisposable to stop the background timer
  </action>
  <verify>dotnet build Plugins/DataWarehouse.Plugins.ChaosVaccination/DataWarehouse.Plugins.ChaosVaccination.csproj -- zero errors</verify>
  <done>VaccinationScheduler runs experiments on cron or interval schedules, respects time windows, uses weighted random experiment selection, and respects concurrent experiment limits.</done>
</task>

<task type="auto">
  <name>Task 2: In-memory chaos results database</name>
  <files>
    Plugins/DataWarehouse.Plugins.ChaosVaccination/Storage/InMemoryChaosResultsDatabase.cs
  </files>
  <action>
**InMemoryChaosResultsDatabase.cs** -- implements IChaosResultsDatabase:
- In-memory implementation using ConcurrentDictionary&lt;string, ExperimentRecord&gt; keyed by experiment ID
- Bounded: max 100,000 records (configurable), oldest evicted when full (FIFO via a ConcurrentQueue tracking insertion order)

- StoreAsync: Add record to dictionary + queue, evict oldest if over limit, publish "chaos.results.stored" to bus with experiment ID
- QueryAsync(ExperimentQuery query):
  - Apply filters: FaultTypes (if specified, result.FaultType must be in list), Statuses, Since/Until (on CreatedAt), PluginIds (intersection with AffectedPlugins)
  - Order by CreatedAt descending (default) or ascending
  - Take MaxResults
  - Return filtered list
  - Use LINQ for filtering but pre-filter on date range first for performance

- GetByIdAsync: Direct dictionary lookup
- GetSummaryAsync(ExperimentQuery? filter):
  - Apply same filters as QueryAsync
  - Compute: TotalExperiments, SuccessRate (Completed / Total), AverageRecoveryMs (average of non-null RecoveryTimeMs)
  - MostCommonFaults: GroupBy FaultType, count each, order descending
  - BlastRadiusDistribution: GroupBy ActualBlastRadius, count each

- PurgeAsync(DateTimeOffset olderThan): Remove all records with CreatedAt < olderThan, update insertion queue

- Thread-safe: All operations on ConcurrentDictionary. Queue operations synchronized with lock.
- Memory-efficient: Records are immutable (init-only), no deep cloning needed for reads.

- Note: This is the in-memory implementation for single-node. Distributed/persistent implementations would follow the same interface in a separate storage plugin. This follows the SDK pattern from Phase 26 (in-memory single-node implementations for every distributed contract).
  </action>
  <verify>dotnet build Plugins/DataWarehouse.Plugins.ChaosVaccination/DataWarehouse.Plugins.ChaosVaccination.csproj -- zero errors</verify>
  <done>InMemoryChaosResultsDatabase stores up to 100K experiment records with FIFO eviction, supports filtered queries and summary statistics computation.</done>
</task>

</tasks>

<verification>
- Plugin builds with zero errors
- VaccinationScheduler implements IVaccinationScheduler
- InMemoryChaosResultsDatabase implements IChaosResultsDatabase
- CronParser handles standard 5-field cron expressions
- No external NuGet packages added
</verification>

<success_criteria>
- Schedules trigger experiments at configured times
- Time windows constrain when experiments can run
- Results database stores, queries, and summarizes experiment outcomes
- Bounded memory usage with FIFO eviction
</success_criteria>

<output>
After completion, create `.planning/phases/61-chaos-vaccination/61-05-SUMMARY.md`
</output>
