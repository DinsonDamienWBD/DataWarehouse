---
phase: 61-chaos-vaccination
plan: 03
type: execute
wave: 2
depends_on: ["61-01"]
files_modified:
  - Plugins/DataWarehouse.Plugins.ChaosVaccination/BlastRadius/BlastRadiusEnforcer.cs
  - Plugins/DataWarehouse.Plugins.ChaosVaccination/BlastRadius/IsolationZoneManager.cs
  - Plugins/DataWarehouse.Plugins.ChaosVaccination/BlastRadius/FailurePropagationMonitor.cs
autonomous: true
must_haves:
  truths:
    - "Plugin crash does not crash the kernel"
    - "Node failure does not corrupt cluster state"
    - "Blast radius policies enforce hard limits on failure propagation"
    - "Isolation zones are created before experiments and released after"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.ChaosVaccination/BlastRadius/BlastRadiusEnforcer.cs"
      provides: "Core blast radius enforcement implementing IBlastRadiusEnforcer"
      contains: "class BlastRadiusEnforcer"
    - path: "Plugins/DataWarehouse.Plugins.ChaosVaccination/BlastRadius/IsolationZoneManager.cs"
      provides: "Zone lifecycle management"
      contains: "class IsolationZoneManager"
    - path: "Plugins/DataWarehouse.Plugins.ChaosVaccination/BlastRadius/FailurePropagationMonitor.cs"
      provides: "Real-time failure spread monitoring"
      contains: "class FailurePropagationMonitor"
  key_links:
    - from: "Plugins/DataWarehouse.Plugins.ChaosVaccination/BlastRadius/BlastRadiusEnforcer.cs"
      to: "DataWarehouse.SDK/Contracts/ChaosVaccination/IBlastRadiusEnforcer.cs"
      via: "implements interface"
      pattern: "IBlastRadiusEnforcer"
    - from: "Plugins/DataWarehouse.Plugins.ChaosVaccination/BlastRadius/BlastRadiusEnforcer.cs"
      to: "DataWarehouse.SDK/Contracts/Resilience/ICircuitBreaker.cs"
      via: "uses circuit breakers for isolation"
      pattern: "ICircuitBreaker"
---

<objective>
Implement blast radius enforcement that guarantees failure containment with hard limits.

Purpose: Ensure any single failure's impact is bounded. Plugin crash must not crash the kernel. Node failure must not corrupt cluster state. This is the safety net that makes chaos experiments safe to run. Leverages existing circuit breakers (ICircuitBreaker) and bulkheads (IBulkheadIsolation) from the SDK.

Output: 3 files implementing blast radius enforcement, isolation zones, and failure propagation monitoring.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/61-chaos-vaccination/61-01-SUMMARY.md
@DataWarehouse.SDK/Contracts/Resilience/ICircuitBreaker.cs
@DataWarehouse.SDK/Contracts/Resilience/IBulkheadIsolation.cs
@DataWarehouse.SDK/Contracts/ChaosVaccination/IBlastRadiusEnforcer.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Isolation zone manager and failure propagation monitor</name>
  <files>
    Plugins/DataWarehouse.Plugins.ChaosVaccination/BlastRadius/IsolationZoneManager.cs
    Plugins/DataWarehouse.Plugins.ChaosVaccination/BlastRadius/FailurePropagationMonitor.cs
  </files>
  <action>
**IsolationZoneManager.cs:**
- Manages lifecycle of IsolationZone instances
- ConcurrentDictionary&lt;string, ActiveZone&gt; tracking all active zones
- ActiveZone record: Zone (IsolationZone), CreatedAt (DateTimeOffset), ExperimentId (string?), CircuitBreakerIds (string[]), BulkheadIds (string[])
- CreateZoneAsync: Generates zone ID, creates circuit breakers for each contained plugin (via message bus "resilience.circuit-breaker.create" topic), creates bulkhead allocations, records zone
- ReleaseZoneAsync: Resets circuit breakers, releases bulkheads, removes from tracking
- GetZoneHealthAsync(string zoneId): Reports containment status -- are all plugins still within the zone? Any breaches?
- Auto-cleanup: Zones older than their policy.MaxDurationMs are auto-released via a Timer callback
- Thread-safe with SemaphoreSlim for zone creation/destruction

**FailurePropagationMonitor.cs:**
- Subscribes to message bus topics: "plugin.error.*", "node.health.*", "cluster.membership.*", "resilience.circuit-breaker.state-changed"
- Tracks failure cascade in real-time using a FailureCascadeTracker:
  - ConcurrentDictionary&lt;string, FailureEvent&gt; tracking recent failures
  - FailureEvent record: PluginId, NodeId, FaultType, Timestamp, OriginExperimentId
  - Sliding window (configurable, default 30s) for failure correlation
- DetectPropagation(): Analyzes failure events within the window:
  - If failures span multiple plugins in same zone: propagation within zone (OK if within policy)
  - If failures appear in plugins OUTSIDE any active zone: BREACH detected
  - If failures appear on nodes OUTSIDE any active zone: NODE BREACH detected
- Returns PropagationReport record: HasBreach (bool), BreachedPlugins (string[]), BreachedNodes (string[]), CascadeDepth (int), RootCause (string?), AffectedZones (string[])
- Fires event when breach is detected so BlastRadiusEnforcer can react
- Uses IMessageBus (constructor-injected, nullable for single-node)
  </action>
  <verify>dotnet build Plugins/DataWarehouse.Plugins.ChaosVaccination/DataWarehouse.Plugins.ChaosVaccination.csproj -- zero errors</verify>
  <done>IsolationZoneManager creates/releases zones with circuit breaker and bulkhead backing. FailurePropagationMonitor detects when failures escape their intended blast radius.</done>
</task>

<task type="auto">
  <name>Task 2: Blast radius enforcer</name>
  <files>
    Plugins/DataWarehouse.Plugins.ChaosVaccination/BlastRadius/BlastRadiusEnforcer.cs
  </files>
  <action>
**BlastRadiusEnforcer.cs** -- implements IBlastRadiusEnforcer:
- Constructor takes IMessageBus?, IsolationZoneManager, FailurePropagationMonitor
- CreateIsolationZoneAsync: Delegates to IsolationZoneManager, validates policy against global limits (ChaosVaccinationOptions.GlobalBlastRadiusLimit), returns created IsolationZone
- EnforceAsync(string zoneId):
  1. Gets zone from IsolationZoneManager
  2. Calls FailurePropagationMonitor.DetectPropagation()
  3. If breach detected AND policy.AutoAbortOnBreach:
     a. Fires OnBreachDetected event
     b. Trips circuit breakers for affected plugins via bus message "resilience.circuit-breaker.trip"
     c. Publishes "chaos.blast-radius.breach" to bus for observability
  4. Returns FailureContainmentResult with containment status
- ReleaseZoneAsync: Delegates to IsolationZoneManager
- GetActiveZonesAsync: Returns all active zones from manager

- Background enforcement loop (using Timer, period configurable default 1s):
  - For each active zone, calls EnforceAsync
  - If any zone has a breach, logs and publishes metrics
  - Auto-abort experiment if blast radius exceeded (publishes "chaos.experiment.abort" to bus)

- Enforcement tiers matching BlastRadiusLevel:
  - SingleStrategy: Only the specific strategy instance is affected
  - SinglePlugin: Plugin is isolated, other plugins unaffected
  - PluginCategory: All plugins in the category may be affected (e.g., all storage plugins)
  - SingleNode: Failures contained to one node
  - NodeGroup: Multiple nodes may be affected but cluster core survives
  - Cluster: Full cluster impact (requires explicit approval, only for DR testing)

- Safety invariants (enforced as assertions, never relaxed):
  - Plugin crash NEVER propagates to kernel (kernel wrapped in try/catch for all plugin calls)
  - Node failure NEVER corrupts shared state (all shared state access through transactions)
  - Experiment failure ALWAYS triggers cleanup (finally block in enforcement loop)
  </action>
  <verify>dotnet build Plugins/DataWarehouse.Plugins.ChaosVaccination/DataWarehouse.Plugins.ChaosVaccination.csproj -- zero errors</verify>
  <done>BlastRadiusEnforcer creates isolation zones, monitors failure propagation in real-time, auto-aborts experiments that exceed their blast radius, and guarantees plugin crash != kernel crash.</done>
</task>

</tasks>

<verification>
- Plugin builds with zero errors
- BlastRadiusEnforcer implements IBlastRadiusEnforcer
- IsolationZoneManager tracks zones with circuit breaker backing
- FailurePropagationMonitor subscribes to failure events via bus
- No direct plugin references -- all coordination via message bus
</verification>

<success_criteria>
- Blast radius policies are enforceable with hard limits
- Isolation zones provide circuit breaker + bulkhead protection
- Failure propagation is detected in real-time
- Auto-abort triggers when blast radius is exceeded
</success_criteria>

<output>
After completion, create `.planning/phases/61-chaos-vaccination/61-03-SUMMARY.md`
</output>
