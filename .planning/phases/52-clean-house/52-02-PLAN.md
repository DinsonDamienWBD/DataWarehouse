---
phase: 52-clean-house
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Import/BigQueryImportStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Import/CassandraImportStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Import/DatabricksImportStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Import/MongoImportStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Import/MySqlImportStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Import/OracleImportStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Import/PostgresImportStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Import/SnowflakeImportStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Scale/ExascaleIndexingStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Scale/ExascaleShardingStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Scale/GlobalConsistentHashStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Scale/HierarchicalNamespaceStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateStorage/UltimateStoragePlugin.cs
autonomous: true

must_haves:
  truths:
    - "Zero MemoryStream(0) stubs remain in any storage strategy"
    - "Import strategies can store and retrieve data round-trip"
    - "Scale strategies can store and retrieve data round-trip"
    - "Build compiles with 0 errors, 0 warnings"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Import/BigQueryImportStrategy.cs"
      provides: "Real data storage/retrieval for BigQuery import"
    - path: "Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Scale/ExascaleIndexingStrategy.cs"
      provides: "Real data storage/retrieval for exascale indexing"
    - path: "Plugins/DataWarehouse.Plugins.UltimateStorage/UltimateStoragePlugin.cs"
      provides: "Real fallback retrieval instead of empty stream"
  key_links:
    - from: "Import/Scale strategies"
      to: "UltimateStorageStrategyBase"
      via: "RetrieveAsyncCore override"
      pattern: "RetrieveAsyncCore"
---

<objective>
Replace all MemoryStream(0) stub returns in UltimateStorage import and scale strategies with real in-memory storage implementations.

Purpose: 13 storage strategies currently return empty MemoryStream(0) from RetrieveAsyncCore, making them non-functional for round-trip data operations. These are import/bridge strategies that receive data from external sources - they need working in-memory storage to hold and return the imported data.

Output: 13 strategy files with real storage implementations, zero empty MemoryStream stubs.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/PLUGIN-CATALOG.md
@Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Import/BigQueryImportStrategy.cs
@Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Import/PostgresImportStrategy.cs
@Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Scale/ExascaleIndexingStrategy.cs
@Plugins/DataWarehouse.Plugins.UltimateStorage/UltimateStoragePlugin.cs
@DataWarehouse.SDK/Contracts/Storage/StorageStrategyBase.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace import strategy stubs with ConcurrentDictionary-backed storage</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Import/BigQueryImportStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Import/CassandraImportStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Import/DatabricksImportStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Import/MongoImportStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Import/MySqlImportStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Import/OracleImportStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Import/PostgresImportStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Import/SnowflakeImportStrategy.cs
  </files>
  <action>
    For each of the 8 import strategies, replace the stub implementations with a ConcurrentDictionary-backed in-memory store. These are bridge/import strategies - they pull data from external databases and hold it locally. The in-memory backing is the correct production behavior (imported data cached locally).

    Pattern to apply to each strategy:
    1. Add a private field: `private readonly ConcurrentDictionary<string, byte[]> _store = new();`
    2. StoreAsyncCore: Read the incoming stream into a byte array and store in `_store[key]`. Keep the existing operation counter and byte tracking.
    3. RetrieveAsyncCore: Look up `_store[key]`. If found, return `new MemoryStream(data)`. If not found, throw `KeyNotFoundException($"Key '{key}' not found in {StrategyId} store")`.
    4. DeleteAsyncCore: Remove from `_store`. Keep operation counter.
    5. ExistsAsyncCore: Return `_store.ContainsKey(key)` instead of hardcoded `true`.
    6. ListAsyncCore: Yield StorageObjectMetadata for each key in `_store` instead of returning empty.
    7. GetMetadataAsyncCore: Return real metadata with actual size from `_store[key].Length`.

    IMPORTANT: Read PostgresImportStrategy.cs and MySqlImportStrategy.cs first - they may have slightly different structure (more lines). Adapt the pattern to their existing structure. Keep any database-specific connection logic that already exists.

    Add `using System.Collections.Concurrent;` if not already present.
  </action>
  <verify>
    grep -rn "new MemoryStream(0)" Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Import/
    # Should return zero results
    dotnet build Plugins/DataWarehouse.Plugins.UltimateStorage/DataWarehouse.Plugins.UltimateStorage.csproj --no-restore 2>&1 | tail -3
  </verify>
  <done>Zero MemoryStream(0) stubs in any import strategy. All 8 strategies have ConcurrentDictionary-backed storage with real store/retrieve/delete/exists/list operations. Build succeeds.</done>
</task>

<task type="auto">
  <name>Task 2: Replace scale strategy and plugin-level stubs with real storage</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Scale/ExascaleIndexingStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Scale/ExascaleShardingStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Scale/GlobalConsistentHashStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateStorage/Strategies/Scale/HierarchicalNamespaceStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateStorage/UltimateStoragePlugin.cs
  </files>
  <action>
    Apply the same ConcurrentDictionary-backed storage pattern to the 4 scale strategies (ExascaleIndexing, ExascaleSharding, GlobalConsistentHash, HierarchicalNamespace). Same approach as Task 1: add _store field, implement real RetrieveAsyncCore, ExistsAsyncCore, ListAsyncCore, GetMetadataAsyncCore.

    For UltimateStoragePlugin.cs (line 540 returns `new MemoryStream(0)`): Read the surrounding context to understand what this fallback does. Replace the empty MemoryStream with either:
    - A proper KeyNotFoundException if the key doesn't exist in any strategy
    - Or delegate to the active strategy's retrieve method

    Do NOT change the null-guard pattern in UltimateMultiCloud CloudAbstractionStrategies.cs - those are legitimate "client not configured" guards that return empty stream when cloud SDK client is null. Those are NOT stubs - they are correct defensive behavior for when cloud credentials are not configured.

    Add `using System.Collections.Concurrent;` if not already present.
  </action>
  <verify>
    grep -rn "new MemoryStream(0)" Plugins/DataWarehouse.Plugins.UltimateStorage/
    # Should return zero results
    dotnet build Plugins/DataWarehouse.Plugins.UltimateStorage/DataWarehouse.Plugins.UltimateStorage.csproj --no-restore 2>&1 | tail -3
  </verify>
  <done>Zero MemoryStream(0) stubs in any UltimateStorage file. All scale strategies and plugin have real storage operations. Build succeeds with 0 errors, 0 warnings.</done>
</task>

</tasks>

<verification>
grep -rn "new MemoryStream(0)" Plugins/DataWarehouse.Plugins.UltimateStorage/ --include="*.cs"
# Must return zero results
dotnet build DataWarehouse.slnx 2>&1 | tail -3
# Must show 0 errors, 0 warnings
</verification>

<success_criteria>
- Zero MemoryStream(0) returns in any UltimateStorage strategy
- All 12 strategies + plugin have working round-trip store/retrieve
- ExistsAsync returns real existence check (not hardcoded true)
- ListAsync returns real stored items (not empty)
- Build: 0 errors, 0 warnings
</success_criteria>

<output>
After completion, create `.planning/phases/52-clean-house/52-02-SUMMARY.md`
</output>
