---
phase: 90.5-production-code-review
plan: 04
type: manual
wave: 2
depends_on: ["90.5-03"]
files_modified: [DataWarehouse.Kernel/]
autonomous: false

must_haves:
  truths:
    - "Kernel bootstraps all plugins correctly with real initialization logic"
    - "Message bus routing delivers messages to correct subscribers"
    - "Plugin lifecycle (load, init, start, stop, unload) works end-to-end"
    - "No stub or no-op code paths in the kernel"
    - "Wiring document explains kernel boot sequence, plugin lifecycle, and message routing"
  artifacts:
    - path: ".planning/phases/90.5-production-code-review/wiring/04-kernel-wiring.md"
      provides: "Complete wiring documentation for DataWarehouse.Kernel"
  key_links:
    - from: "DataWarehouse.Kernel"
      to: "DataWarehouse.SDK/Infrastructure/"
      via: "Service resolution and plugin loading"
      pattern: "Kernel consumes Infrastructure to bootstrap the runtime"
---

<objective>
Production Code Review and Gap Closure for DataWarehouse.Kernel.

Purpose: The kernel is the runtime orchestrator. It loads plugins, routes messages, manages lifecycle. Any gap here means plugins fail to start, messages get lost, or the system can't boot.

Output: Zero-gap Kernel with comprehensive wiring documentation.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/PLUGIN-CATALOG.md
@.planning/phases/90.5-production-code-review/90.5-03-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 1: Systematic Scan of Kernel</name>
  <files>DataWarehouse.Kernel/</files>
  <action>

    **MANDATORY PER-FILE REPORTING RULE:**
    Every single .cs file in the project directory MUST be individually listed in the findings report. No exceptions, no summarization across files. For each file report:
    - Full file path and total line count
    - Every finding (stub, no-op, gap, fake payload, TODO) with exact line number(s) and code snippet
    - If the file has zero issues, explicitly list it as: "filename.cs (N lines) â€” CLEAN, no issues"
    
    Do NOT skip any file. Do NOT group files together. Do NOT say "similar pattern in X files".
    Go through every line of code in every file. We are closing all gaps once and for all.
    Perform exhaustive scan of ALL files under DataWarehouse.Kernel/ for:

    1. **Stub methods**: NotImplementedException, NotSupportedException
    2. **Task.CompletedTask / Task.FromResult no-ops**
    3. **Fake payloads or hardcoded values**: Default configurations that should be loaded from settings
    4. **Incomplete implementations**: TODO, partial logic, commented-out code
    5. **Critical paths to verify**:
       - Plugin discovery and loading
       - Plugin dependency resolution
       - Message bus publish/subscribe/route
       - Plugin lifecycle state machine (load -> init -> start -> stop -> unload)
       - Kernel boot sequence
       - Graceful shutdown sequence
       - Health check / heartbeat system
       - Configuration loading and validation

    Present findings with severity ratings to user.
  </action>
  <verify>User reviews findings and approves fix plan</verify>
  <done>Complete inventory of all Kernel gaps presented to user</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Implement Kernel Fixes</name>
  <files>DataWarehouse.Kernel/</files>
  <action>
    Implement all agreed fixes. The kernel must be rock-solid:

    1. **Plugin lifecycle**: Every state transition must work correctly with proper error handling
    2. **Message bus**: Publish must reach all subscribers, dead-letter handling for failed deliveries
    3. **Boot sequence**: Ordered plugin initialization respecting dependency graph
    4. **Shutdown**: Graceful teardown in reverse dependency order with timeout
    5. **All other findings**: Fix remaining stubs and no-ops

    After implementing, rescan and build: `dotnet build DataWarehouse.Kernel/`
  </action>
  <verify>
    Rescan shows zero gaps remaining.
    `dotnet build DataWarehouse.Kernel/` succeeds.
    User confirms fixes.
  </verify>
  <done>All Kernel gaps closed, solution builds clean</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Write Kernel Wiring Document</name>
  <files>.planning/phases/90.5-production-code-review/wiring/04-kernel-wiring.md</files>
  <action>
    Create comprehensive wiring document covering:

    1. **Boot Sequence**: Step-by-step from Main() to all plugins running
    2. **Plugin Discovery**: How plugins are found on disk and loaded into the AppDomain
    3. **Dependency Resolution**: How plugin dependencies are resolved and ordered
    4. **Plugin Lifecycle State Machine**: All states, transitions, and error recovery
    5. **Message Bus Architecture**: Topic model, subscription management, message delivery guarantees
    6. **Configuration System**: How config flows from files/env to plugin options
    7. **Health Monitoring**: Heartbeat, health checks, plugin status reporting
    8. **Shutdown Sequence**: How graceful shutdown propagates through all plugins
    9. **Error Isolation**: How one plugin's failure is contained from affecting others

    Include ASCII state machine diagram for plugin lifecycle.
  </action>
  <verify>User reviews wiring document for completeness</verify>
  <done>Kernel wiring document complete, approved by user</done>
</task>

</tasks>

<verification>
- Zero stubs/no-ops in Kernel
- Plugin lifecycle state machine has no dead-end states
- Message bus routing verified in code review
- Boot and shutdown sequences are complete
- Wiring document covers full kernel architecture
</verification>

<success_criteria>
Kernel is 100% production-ready: boots cleanly, loads all plugins, routes messages correctly, shuts down gracefully. Wiring document complete.
</success_criteria>

<output>
After completion, create `.planning/phases/90.5-production-code-review/90.5-04-SUMMARY.md`
</output>
