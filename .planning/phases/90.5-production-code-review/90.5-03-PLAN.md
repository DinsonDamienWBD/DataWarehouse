---
phase: 90.5-production-code-review
plan: 03
type: manual
wave: 1
depends_on: ["90.5-02"]
files_modified: [DataWarehouse.SDK/Infrastructure/]
autonomous: false

must_haves:
  truths:
    - "CrdtRegistry deserialization works for all CRDT types"
    - "KernelInfrastructure version check performs real semantic comparison"
    - "All distributed infrastructure components have real implementations"
    - "Wiring document explains how Infrastructure connects SDK to Kernel"
  artifacts:
    - path: ".planning/phases/90.5-production-code-review/wiring/03-sdk-infrastructure-wiring.md"
      provides: "Complete wiring documentation for SDK Infrastructure"
  key_links:
    - from: "DataWarehouse.SDK/Infrastructure/"
      to: "DataWarehouse.Kernel"
      via: "Kernel bootstrapping and service registration"
      pattern: "Infrastructure provides the bridge between SDK contracts and runtime"
---

<objective>
Production Code Review and Gap Closure for SDK Infrastructure (DataWarehouse.SDK/Infrastructure/).

Purpose: Infrastructure is the bridge layer between SDK contracts and the kernel runtime. Gaps here break service resolution, distributed coordination, and error handling.

Output: Zero-gap SDK Infrastructure with comprehensive wiring documentation.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/PLUGIN-CATALOG.md
@.planning/phases/90.5-production-code-review/90.5-02-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 1: Systematic Scan of SDK Infrastructure</name>
  <files>DataWarehouse.SDK/Infrastructure/</files>
  <action>

    **MANDATORY PER-FILE REPORTING RULE:**
    Every single .cs file in the project directory MUST be individually listed in the findings report. No exceptions, no summarization across files. For each file report:
    - Full file path and total line count
    - Every finding (stub, no-op, gap, fake payload, TODO) with exact line number(s) and code snippet
    - If the file has zero issues, explicitly list it as: "filename.cs (N lines) â€” CLEAN, no issues"
    
    Do NOT skip any file. Do NOT group files together. Do NOT say "similar pattern in X files".
    Go through every line of code in every file. We are closing all gaps once and for all.
    Perform exhaustive scan of ALL files under DataWarehouse.SDK/Infrastructure/ for:

    1. **Stub methods**: NotImplementedException, NotSupportedException
    2. **Task.CompletedTask / Task.FromResult no-ops**
    3. **Incomplete implementations**: TODO, partial logic
    4. **Known issues**:
       - CrdtRegistry: Deserialization throws NotSupportedException for some CRDT types
       - KernelInfrastructure: Version compatibility check is a no-op (always returns true)
    5. **Subdirectories to scan**: Authority/, Distributed/, InMemory/, Intelligence/, Policy/, Scaling/
    6. **Standalone files**: DeveloperExperience.cs, ErrorHandling.cs, KernelInfrastructure.cs, StandardizedExceptions.cs, StorageConnectionRegistry.cs

    Present findings table to user.
  </action>
  <verify>User reviews findings and approves fix plan</verify>
  <done>Complete inventory of all Infrastructure gaps presented to user</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Implement Infrastructure Fixes</name>
  <files>DataWarehouse.SDK/Infrastructure/</files>
  <action>
    Implement all agreed fixes:

    1. **CrdtRegistry deserialization**: Implement deserialization for ALL registered CRDT types (GCounter, PNCounter, LWWRegister, ORSet, MVRegister, etc.). Each type must round-trip correctly through serialize/deserialize.
    2. **KernelInfrastructure version check**: Implement real semantic versioning comparison (Major.Minor.Patch with pre-release support). Must reject incompatible versions.
    3. **Distributed infrastructure**: Ensure all classes in Distributed/ have real implementations for leader election, consensus, partition detection.
    4. **Policy infrastructure**: Verify Policy/ implementations actually evaluate policies, not just pass-through.
    5. **All other findings**: Fix remaining stubs and no-ops.

    After implementing, rescan and build: `dotnet build DataWarehouse.SDK/`
  </action>
  <verify>
    Rescan shows zero gaps remaining.
    `dotnet build DataWarehouse.SDK/` succeeds.
    User confirms fixes.
  </verify>
  <done>All Infrastructure gaps closed, solution builds clean</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Write SDK Infrastructure Wiring Document</name>
  <files>.planning/phases/90.5-production-code-review/wiring/03-sdk-infrastructure-wiring.md</files>
  <action>
    Create comprehensive wiring document covering:

    1. **Service Registration Flow**: How Infrastructure registers services for kernel DI
    2. **Authority System**: How authority/trust is established and verified
    3. **Distributed Coordination**: CRDT types, their merge semantics, and registry lifecycle
    4. **Policy Evaluation Pipeline**: How policies are loaded, cached, and evaluated
    5. **Scaling Infrastructure**: How scaling decisions flow through the system
    6. **Intelligence Hooks**: How ML/AI integration points connect
    7. **Error Handling Model**: StandardizedExceptions taxonomy and error propagation
    8. **Storage Connection Registry**: How storage backends are discovered and connected
    9. **InMemory Subsystem**: What it provides and when it's used vs persistent storage

    Include flow diagrams for service registration and policy evaluation.
  </action>
  <verify>User reviews wiring document for completeness</verify>
  <done>Infrastructure wiring document complete, approved by user</done>
</task>

</tasks>

<verification>
- Zero stubs/no-ops remaining in Infrastructure/
- CRDT serialization round-trips correctly for all types
- Version check rejects incompatible versions
- Solution builds clean
- Wiring document covers all Infrastructure subsystems
</verification>

<success_criteria>
SDK Infrastructure is 100% production-ready with all distributed coordination, policy evaluation, and service registration working correctly. Wiring document complete.
</success_criteria>

<output>
After completion, create `.planning/phases/90.5-production-code-review/90.5-03-SUMMARY.md`
</output>
