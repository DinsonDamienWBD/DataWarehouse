---
phase: 90.5-production-code-review
plan: 02
type: manual
wave: 1
depends_on: ["90.5-01"]
files_modified: [DataWarehouse.SDK/VirtualDiskEngine/]
autonomous: false

must_haves:
  truths:
    - "Indirect blocks work correctly for large files (no runtime crash)"
    - "MorphLevels 3-6 have real implementations, not throws"
    - "OnlineDefragmenter has real defragmentation logic"
    - "Ed25519 signature verification uses a real implementation"
    - "External sort handles >512MB without loading all to memory"
    - "Wiring document explains VDE block allocation, journaling, and encryption flow"
  artifacts:
    - path: ".planning/phases/90.5-production-code-review/wiring/02-sdk-vde-wiring.md"
      provides: "Complete wiring documentation for VDE subsystem"
  key_links:
    - from: "DataWarehouse.SDK/VirtualDiskEngine/"
      to: "Plugins/DataWarehouse.Plugins.UltimateStorage"
      via: "IBlockDevice implementations"
      pattern: "VDE is the core storage engine consumed by storage plugins"
---

<objective>
Production Code Review and Gap Closure for SDK VirtualDiskEngine (DataWarehouse.SDK/VirtualDiskEngine/).

Purpose: The VDE is the core storage engine. Gaps here mean data loss, corruption, or crashes at runtime. This is the most critical subsystem to get right.

Output: Zero-gap VDE with comprehensive wiring documentation.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/PLUGIN-CATALOG.md
@.planning/phases/90.5-production-code-review/90.5-01-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 1: Systematic Scan of VDE</name>
  <files>DataWarehouse.SDK/VirtualDiskEngine/</files>
  <action>

    **MANDATORY PER-FILE REPORTING RULE:**
    Every single .cs file in the project directory MUST be individually listed in the findings report. No exceptions, no summarization across files. For each file report:
    - Full file path and total line count
    - Every finding (stub, no-op, gap, fake payload, TODO) with exact line number(s) and code snippet
    - If the file has zero issues, explicitly list it as: "filename.cs (N lines) â€” CLEAN, no issues"
    
    Do NOT skip any file. Do NOT group files together. Do NOT say "similar pattern in X files".
    Go through every line of code in every file. We are closing all gaps once and for all.
    Perform exhaustive scan of ALL files under DataWarehouse.SDK/VirtualDiskEngine/ for:

    1. **Stub methods**: NotImplementedException, NotSupportedException throws
    2. **Task.CompletedTask / Task.FromResult no-ops**
    3. **Fake payloads**: Hardcoded byte arrays, dummy data
    4. **Incomplete implementations**: TODO, partial logic, commented-out code
    5. **Known critical issues**:
       - **Indirect blocks**: Missing implementation causes runtime crash for large files (files needing >direct block pointers)
       - **MorphLevels 3-6**: All throw NotSupportedException (levels 0-2 work)
       - **OnlineDefragmenter**: Placeholder blocks that don't actually defragment
       - **Ed25519**: Placeholder signature implementation
       - **External sort**: >512MB loads all to memory instead of streaming

    Classify each finding and present to user with severity (CRITICAL for data-loss paths, HIGH for functionality gaps, MEDIUM for performance issues).

    | File | Line | Severity | Type | Current Code | Suggested Fix |
  </action>
  <verify>User reviews findings and approves fix priorities</verify>
  <done>Complete inventory of all VDE gaps with severity ratings presented to user</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Implement VDE Fixes</name>
  <files>DataWarehouse.SDK/VirtualDiskEngine/</files>
  <action>
    Implement all agreed fixes, starting with CRITICAL severity:

    1. **Indirect blocks**: Implement single-indirect, double-indirect, and triple-indirect block pointer chains following standard filesystem design (ext4-style). Must handle files up to theoretical maximum size.
    2. **MorphLevels 3-6**: Implement each morph level's transformation logic. Follow the pattern established by levels 0-2. Each level must correctly transform block layout.
    3. **OnlineDefragmenter**: Implement real defragmentation that:
       - Identifies fragmented extents
       - Relocates blocks to create contiguous regions
       - Updates all pointer chains atomically
       - Maintains journal consistency during defrag
    4. **Ed25519**: Implement using System.Security.Cryptography or a well-known NuGet package. Must handle key generation, signing, and verification.
    5. **External sort**: Implement streaming merge-sort with configurable memory budget. Use temp files for intermediate runs. Must handle arbitrary data sizes.
    6. **All other findings**: Fix remaining stubs and no-ops.

    After implementing, rescan and build: `dotnet build DataWarehouse.SDK/`
  </action>
  <verify>
    Rescan shows zero stubs/no-ops remaining.
    `dotnet build DataWarehouse.SDK/` succeeds.
    User confirms implementations are correct.
  </verify>
  <done>All VDE gaps closed, large file support works, solution builds clean</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Write VDE Wiring Document</name>
  <files>.planning/phases/90.5-production-code-review/wiring/02-sdk-vde-wiring.md</files>
  <action>
    Create comprehensive wiring document covering:

    1. **Block Allocation Flow**: How blocks are allocated, tracked, and freed (bitmap, B-tree, or extent-based)
    2. **Journal/WAL Flow**: Write path from API call through journal to committed blocks
    3. **Read Path**: How reads resolve through cache -> block device -> physical storage
    4. **Encryption Integration**: Where encryption hooks into the read/write path
    5. **Morph Level System**: What each level does and when transitions occur
    6. **Indirect Block Chain**: How large files use indirect pointers (single/double/triple)
    7. **Defragmentation**: How online defrag works without disrupting reads
    8. **Container Format**: VDE file format layout (superblock, metadata, data regions)
    9. **Concurrency Model**: How concurrent reads/writes are handled (locks, MVCC, etc.)
    10. **Identity/Integrity**: How Ed25519 signatures and checksums protect data

    Include ASCII diagrams for block layout and data flow paths.
  </action>
  <verify>User reviews wiring document for completeness</verify>
  <done>VDE wiring document explains all subsystem connections, approved by user</done>
</task>

</tasks>

<verification>
- Zero NotImplementedException/NotSupportedException throws remaining (except documented guards)
- Indirect blocks support files of arbitrary size
- MorphLevels 0-6 all functional
- External sort handles >512MB without OOM
- Solution builds clean
- Wiring document covers all VDE subsystems
</verification>

<success_criteria>
VDE is 100% production-ready: large files work, all morph levels implemented, defragmentation functional, cryptographic operations real, and complete wiring documentation.
</success_criteria>

<output>
After completion, create `.planning/phases/90.5-production-code-review/90.5-02-SUMMARY.md`
</output>
