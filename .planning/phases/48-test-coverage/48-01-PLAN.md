---
phase: 48
plan: 48-01
title: "Unit Test Coverage"
depends_on: []
---

# Plan 48-01: Unit Test Coverage

## Goal
Achieve comprehensive unit test coverage across all plugins, strategies, and SDK base classes. Target 80%+ line coverage for SDK and Kernel, verify every plugin has unit tests for core logic, and ensure every strategy has at least one test.

## Approach
1. **Baseline Coverage Measurement**:
   - Install coverage tool: `dotnet tool install --global dotnet-coverage`
   - Run existing tests with coverage: `dotnet test --collect:"XPlat Code Coverage"`
   - Generate coverage report: `reportgenerator -reports:**/coverage.cobertura.xml -targetdir:coverage-report`
   - Review coverage report:
     - Identify uncovered files
     - Identify uncovered methods
     - Identify uncovered branches

2. **SDK Base Class Contract Verification**:
   - Read all SDK base classes:
     - `DataWarehouse.SDK/Plugins/PluginBase.cs`
     - `DataWarehouse.SDK/Strategies/StrategyBase.cs`
     - `DataWarehouse.SDK/Strategies/CompressionStrategyBase.cs`
     - `DataWarehouse.SDK/Strategies/EncryptionStrategyBase.cs`
     - `DataWarehouse.SDK/Strategies/StorageBackendStrategyBase.cs`
     - `DataWarehouse.SDK/Strategies/ObservabilityStrategyBase.cs`
     - (all other base classes)
   - For each base class, create contract tests:
     - Verify initialization (constructor, Initialize method)
     - Verify lifecycle (Start, Stop, Dispose)
     - Verify abstract method enforcement (cannot instantiate base class)
     - Verify virtual method default behavior
     - Verify event raising (OnStarted, OnStopped, etc.)
   - Create test helper: `BaseClassContractTest<T>` for reuse

3. **Plugin Core Logic Unit Tests**:
   - For each plugin (60+ plugins):
     - Identify core logic (non-trivial methods, business rules)
     - Write unit tests:
       - Happy path (valid input, expected output)
       - Edge cases (empty input, null input, boundary values)
       - Error cases (invalid input, exception handling)
   - Example: `UltimateCompression`:
     - Test: compress valid data → verify compressed size < original size
     - Test: decompress compressed data → verify matches original
     - Test: compress empty data → verify handles gracefully
     - Test: compress null → verify throws ArgumentNullException
   - Example: `UltimateEncryption`:
     - Test: encrypt valid data → verify ciphertext != plaintext
     - Test: decrypt ciphertext → verify matches plaintext
     - Test: decrypt tampered ciphertext → verify throws exception
     - Test: encrypt null → verify throws ArgumentNullException

4. **Strategy Unit Tests**:
   - For each strategy (130+ storage backends, 50+ compression strategies, etc.):
     - Write at least one unit test per strategy
     - Test core operation:
       - CompressionStrategy: compress → decompress = original
       - EncryptionStrategy: encrypt → decrypt = original
       - StorageBackend: write → read = original
       - ObservabilityStrategy: record metric → verify exported
   - Example: `GzipCompressionStrategy`:
     - Test: compress "Hello World" → verify gzip header (1F 8B)
     - Test: decompress gzip data → verify "Hello World"
   - Example: `S3StorageBackend`:
     - Test: write file → verify S3 PUT request sent (mock S3 client)
     - Test: read file → verify S3 GET request sent, data returned

5. **Kernel Unit Tests**:
   - Test message bus:
     - Publish message → verify subscribers receive
     - Subscribe → publish → verify handler invoked
     - Unsubscribe → publish → verify handler not invoked
   - Test plugin manager:
     - Load plugin → verify plugin registered
     - Unload plugin → verify plugin unregistered
     - Load invalid plugin → verify error
   - Test capability delegation:
     - Request capability → verify correct plugin selected
     - Multiple plugins provide capability → verify priority/fallback

6. **Coverage Target Verification**:
   - Re-run tests with coverage: `dotnet test --collect:"XPlat Code Coverage"`
   - Generate new coverage report
   - Verify coverage targets:
     - SDK: 80%+ line coverage
     - Kernel: 80%+ line coverage
     - Plugins: 60%+ line coverage (lower due to integration dependencies)
   - Identify remaining gaps (files/methods <80%)
   - Write additional tests to close gaps

7. **Test Organization**:
   - Create test project structure:
     - `DataWarehouse.SDK.Tests/` (SDK unit tests)
     - `DataWarehouse.Kernel.Tests/` (Kernel unit tests)
     - `Plugins/DataWarehouse.Plugins.*.Tests/` (plugin unit tests)
   - Use naming convention:
     - Test class: `{ClassName}Tests.cs`
     - Test method: `{MethodName}_{Scenario}_{ExpectedResult}`
     - Example: `GzipCompressionStrategy_Compress_ValidData_ReturnsCompressedData()`

## Scope
**In Scope:**
- Unit tests for all plugins (60+)
- Unit tests for all strategies (200+)
- SDK base class contract verification
- Kernel unit tests (message bus, plugin manager, capability delegation)
- Coverage measurement (baseline, target, gap closure)
- Target: 80%+ line coverage for SDK/Kernel

**Out of Scope:**
- Integration tests (Plan 48-02)
- Edge case/failure mode tests (Plan 48-03)
- Cross-platform tests (Plan 48-04)

## Success Criteria
- [ ] Coverage baseline measured (existing coverage report generated)
- [ ] SDK base class contract tests written (all base classes)
- [ ] Plugin core logic tests written (60+ plugins, happy path + edge cases + error cases)
- [ ] Strategy tests written (200+ strategies, at least one test per strategy)
- [ ] Kernel unit tests written (message bus, plugin manager, capability delegation)
- [ ] Coverage target achieved (SDK: 80%+, Kernel: 80%+)
- [ ] Coverage gaps identified (<80% files/methods)
- [ ] Additional tests written to close gaps
- [ ] All tests pass (green)

## Output
- `TEST-COVERAGE-unit.md`: Unit test coverage report
  - Baseline coverage (before)
  - Final coverage (after)
  - Coverage by assembly (SDK, Kernel, Plugins)
  - Coverage by file (list files <80%)
  - Coverage by method (list methods <80%)
  - Gap analysis (why gaps exist, plan to close)
- Test projects:
  - `DataWarehouse.SDK.Tests/` with unit tests
  - `DataWarehouse.Kernel.Tests/` with unit tests
  - `Plugins/DataWarehouse.Plugins.*.Tests/` with unit tests
- Coverage report HTML (reportgenerator output)
