---
phase: 48
plan: 48-04
title: "Cross-Platform Tests"
depends_on: []
---

# Plan 48-04: Cross-Platform Tests

## Goal
Verify DataWarehouse functions correctly across Windows, Linux, and macOS. Test platform-specific code paths (PlatformServiceManager, hardware probes), FUSE vs WinFsp mount behavior, and ensure consistent behavior across all platforms.

## Approach
1. **Build Verification on All Platforms**:
   - **Windows**:
     - Build on Windows 11 (x64, arm64)
     - Verify build succeeds (`dotnet build`)
     - Verify all tests pass (`dotnet test`)
   - **Linux**:
     - Build on Ubuntu 22.04, Debian 12, RHEL 9, Alpine Linux (x64, arm64)
     - Verify build succeeds
     - Verify all tests pass
   - **macOS**:
     - Build on macOS 14 Sonoma (x64, arm64)
     - Verify build succeeds
     - Verify all tests pass
   - Verify runtime dependencies:
     - .NET 8.0 Runtime installed
     - Native dependencies available (libfuse, WinFsp, etc.)

2. **Platform-Specific Code Path Verification**:
   - **PlatformServiceManager**:
     - Read implementation:
       - `DataWarehouse.SDK/Services/PlatformServiceManager.cs`
       - Windows: uses Windows Services (sc.exe, net.exe)
       - Linux: uses systemd (systemctl)
       - macOS: uses launchd (launchctl)
     - Test on each platform:
       - Install service: `PlatformServiceManager.Install()` → verify service registered
       - Start service: `PlatformServiceManager.Start()` → verify service running
       - Stop service: `PlatformServiceManager.Stop()` → verify service stopped
       - Uninstall service: `PlatformServiceManager.Uninstall()` → verify service removed
     - Verify service auto-start:
       - Reboot machine
       - Verify service starts automatically
   - **Hardware Probes**:
     - Read implementation:
       - `DataWarehouse.SDK/Hardware/HardwareProbeWindows.cs`
       - `DataWarehouse.SDK/Hardware/HardwareProbeLinux.cs`
       - `DataWarehouse.SDK/Hardware/HardwareProbeMacOS.cs`
     - Test on each platform:
       - Probe CPU: verify CPU count, model, architecture (x64, arm64)
       - Probe memory: verify total memory, available memory
       - Probe storage: verify disk count, disk size, disk type (SSD, HDD, NVMe)
       - Probe network: verify network interface count, MAC address, IP address
       - Probe GPU: verify GPU count, GPU model (if available)
     - Verify cross-platform consistency:
       - Same hardware reported identically on all platforms
       - No platform-specific quirks (e.g., Windows reports 16 GB, Linux reports 16.7 GB)

3. **Filesystem Behavior Verification**:
   - **Path Separator**:
     - Windows: backslash `\`
     - Linux/macOS: forward slash `/`
     - Verify code uses `Path.Combine()` (not hardcoded separators)
     - Test: construct path on each platform → verify correct separator
   - **Case Sensitivity**:
     - Windows: case-insensitive (file.txt == FILE.TXT)
     - Linux: case-sensitive (file.txt != FILE.TXT)
     - macOS: case-insensitive by default (but can be case-sensitive)
     - Test: create file "test.txt", attempt to open "TEST.TXT"
       - Windows: succeeds
       - Linux: fails (file not found)
       - macOS: succeeds (default APFS)
     - Verify code handles both behaviors (normalize paths)
   - **Line Endings**:
     - Windows: CRLF (`\r\n`)
     - Linux/macOS: LF (`\n`)
     - Verify code handles both (read files correctly, write files with platform-appropriate endings)

4. **FUSE vs WinFsp Mount Verification**:
   - **FUSE (Linux/macOS)**:
     - Install FUSE: `apt install fuse3` (Linux), `brew install macfuse` (macOS)
     - Mount VDE: `VirtualDiskEngine.Mount("/mnt/vde")`
     - Verify mount point appears: `ls /mnt/vde`
     - Test file operations:
       - Create file: `echo "test" > /mnt/vde/test.txt`
       - Read file: `cat /mnt/vde/test.txt` → verify "test"
       - Delete file: `rm /mnt/vde/test.txt`
       - List directory: `ls /mnt/vde` → verify empty
     - Unmount: `VirtualDiskEngine.Unmount("/mnt/vde")`
     - Verify mount point removed: `ls /mnt/vde` → verify not found
   - **WinFsp (Windows)**:
     - Install WinFsp: download from winfsp.dev
     - Mount VDE: `VirtualDiskEngine.Mount("Z:")`
     - Verify drive appears: `dir Z:\`
     - Test file operations (same as FUSE)
     - Unmount: `VirtualDiskEngine.Unmount("Z:")`
     - Verify drive removed: `dir Z:\` → verify not found
   - **Behavior Consistency**:
     - Same file operations on FUSE and WinFsp
     - Same error handling (permission denied, disk full, etc.)
     - Same performance characteristics (within 10%)

5. **Networking Behavior Verification**:
   - **Port Binding**:
     - Windows: requires admin for ports <1024
     - Linux: requires root for ports <1024 (or CAP_NET_BIND_SERVICE capability)
     - macOS: requires root for ports <1024
     - Test: bind to port 80 as non-root → verify error on all platforms
     - Test: bind to port 8080 as non-root → verify succeeds on all platforms
   - **Socket Options**:
     - SO_REUSEADDR: behavior differs on Windows vs Linux/macOS
     - Test: bind socket with SO_REUSEADDR, verify behavior consistent (use platform-specific defaults)
   - **IPv6**:
     - Verify IPv6 support on all platforms
     - Test: bind to `::1` (IPv6 localhost), connect → verify succeeds
     - Test: dual-stack (IPv4 + IPv6) → verify both work

6. **Process and Signal Handling**:
   - **Process Management**:
     - Windows: uses job objects, process groups
     - Linux/macOS: uses process groups, signals
     - Test: spawn child process → kill parent → verify child terminated (or orphaned, depending on config)
   - **Signal Handling**:
     - Windows: limited signal support (SIGINT, SIGTERM)
     - Linux/macOS: full signal support (SIGINT, SIGTERM, SIGHUP, SIGUSR1, etc.)
     - Test: send SIGTERM → verify graceful shutdown on all platforms
     - Test: send SIGINT (Ctrl+C) → verify graceful shutdown
     - Verify signal handling registered correctly (no default termination)

7. **Performance Parity**:
   - Run same workload on all platforms:
     - Write 1 GB data (compress → encrypt → store)
     - Read 1 GB data (retrieve → decrypt → decompress)
   - Measure performance:
     - Throughput (MB/s)
     - Latency (ms)
     - CPU usage (%)
     - Memory usage (MB)
   - Verify performance parity:
     - Windows vs Linux: within 20%
     - Linux vs macOS: within 20%
     - x64 vs arm64: within 30% (accounting for architecture differences)
   - Identify platform-specific optimizations:
     - Windows: I/O completion ports
     - Linux: io_uring, epoll
     - macOS: kqueue

8. **Deployment and Packaging**:
   - **Windows**:
     - MSI installer (WiX)
     - Windows Service registration
     - Start Menu shortcuts
     - Uninstaller
   - **Linux**:
     - DEB package (Debian/Ubuntu)
     - RPM package (RHEL/Fedora)
     - systemd unit file
     - Man pages
   - **macOS**:
     - DMG installer
     - launchd plist
     - Application bundle (.app)
   - Test installation on each platform:
     - Install → verify files copied, service registered
     - Start → verify service running
     - Use → verify functionality
     - Stop → verify service stopped
     - Uninstall → verify files removed, service unregistered

## Scope
**In Scope:**
- Build verification (Windows, Linux, macOS)
- Platform-specific code paths (PlatformServiceManager, hardware probes)
- Filesystem behavior (path separators, case sensitivity, line endings)
- FUSE vs WinFsp mount behavior
- Networking behavior (port binding, socket options, IPv6)
- Process and signal handling
- Performance parity (Windows vs Linux vs macOS, x64 vs arm64)
- Deployment and packaging (MSI, DEB, RPM, DMG)

**Out of Scope:**
- Unit tests (Plan 48-01)
- Integration tests (Plan 48-02)
- Edge case/failure mode tests (Plan 48-03)

## Success Criteria
- [ ] Build succeeds on Windows, Linux, macOS (x64, arm64)
- [ ] All tests pass on all platforms
- [ ] PlatformServiceManager verified (install, start, stop, uninstall on all platforms)
- [ ] Hardware probes verified (CPU, memory, storage, network, GPU on all platforms)
- [ ] Cross-platform hardware consistency verified (same hardware, same report)
- [ ] Path separator handling verified (Path.Combine used, not hardcoded)
- [ ] Case sensitivity handling verified (normalize paths)
- [ ] Line ending handling verified (read/write correct endings)
- [ ] FUSE mount verified (Linux/macOS: create, read, delete, list, unmount)
- [ ] WinFsp mount verified (Windows: same operations as FUSE)
- [ ] FUSE/WinFsp behavior consistency verified (same file operations, error handling, performance)
- [ ] Port binding verified (<1024 requires admin/root, >=1024 succeeds as non-root)
- [ ] IPv6 verified (bind, connect)
- [ ] Signal handling verified (SIGTERM, SIGINT → graceful shutdown)
- [ ] Performance parity verified (Windows vs Linux vs macOS within 20%, x64 vs arm64 within 30%)
- [ ] Deployment verified (install, start, use, stop, uninstall on all platforms)

## Output
- `TEST-COVERAGE-crossplat.md`: Cross-platform test results
  - Build verification results (Windows, Linux, macOS)
  - Platform-specific code path results (PlatformServiceManager, hardware probes)
  - Filesystem behavior results (path separators, case sensitivity, line endings)
  - FUSE/WinFsp mount verification results
  - Networking behavior results (port binding, IPv6)
  - Signal handling results
  - Performance parity results (throughput, latency, CPU, memory)
  - Deployment verification results (install, uninstall)
  - All platform-specific issues documented
- Test projects:
  - `DataWarehouse.CrossPlatformTests/` with cross-platform tests
  - Test fixtures for platform detection
  - Helper classes for platform-specific operations
