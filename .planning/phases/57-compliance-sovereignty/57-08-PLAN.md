---
phase: 57-compliance-sovereignty
plan: 08
type: execute
wave: 4
depends_on: ["57-04", "57-05"]
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/Passport/PassportAuditStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/SovereigntyMesh/SovereigntyObservabilityStrategy.cs
autonomous: true
must_haves:
  truths:
    - "All passport and sovereignty operations produce audit events"
    - "Observability provides real-time sovereignty mesh health metrics"
    - "Audit trail is immutable and covers passport lifecycle, zone enforcement, and transfers"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/Passport/PassportAuditStrategy.cs"
      provides: "Immutable audit trail for all passport operations"
      min_lines: 200
    - path: "Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/SovereigntyMesh/SovereigntyObservabilityStrategy.cs"
      provides: "Metrics, alerts, and dashboards for sovereignty mesh health"
      min_lines: 250
  key_links:
    - from: "Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/Passport/PassportAuditStrategy.cs"
      to: "DataWarehouse.SDK/Compliance/IComplianceAutomation.cs"
      via: "uses IComplianceAudit interface pattern"
      pattern: "ComplianceAuditEvent|AuditReport"
    - from: "Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/SovereigntyMesh/SovereigntyObservabilityStrategy.cs"
      to: "Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/SovereigntyMesh/ZoneEnforcerStrategy.cs"
      via: "collects enforcement metrics"
      pattern: "enforcement|ZoneEnforcer"
---

<objective>
Implement audit trail and observability for compliance passports and sovereignty mesh.

Purpose: Compliance without audit is not compliance. This plan adds an immutable audit trail for every passport operation (issuance, verification, revocation, renewal) and every sovereignty decision (zone enforcement, cross-border transfer). Also adds observability metrics for real-time mesh health monitoring.

Output: Audit strategy for passports and observability strategy for sovereignty mesh.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/PLUGIN-CATALOG.md
@.planning/phases/57-compliance-sovereignty/57-01-SUMMARY.md
@.planning/phases/57-compliance-sovereignty/57-04-SUMMARY.md
@.planning/phases/57-compliance-sovereignty/57-05-SUMMARY.md
@DataWarehouse.SDK/Compliance/CompliancePassport.cs
@DataWarehouse.SDK/Compliance/IComplianceAutomation.cs
@Plugins/DataWarehouse.Plugins.UltimateCompliance/IComplianceStrategy.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement PassportAuditStrategy</name>
  <files>Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/Passport/PassportAuditStrategy.cs</files>
  <action>
Create `PassportAuditStrategy.cs` extending `ComplianceStrategyBase`. Namespace: `DataWarehouse.Plugins.UltimateCompliance.Strategies.Passport`.

Strategy properties:
- StrategyId: "passport-audit"
- StrategyName: "Compliance Passport Audit Trail"
- Framework: "CompliancePassport"

**Audit event types (string constants):**
- PassportIssued, PassportVerified, PassportRenewed, PassportRevoked, PassportSuspended, PassportReinstated, PassportExpired
- ZoneEnforcementDecision, CrossBorderTransferRequested, CrossBorderTransferApproved, CrossBorderTransferDenied
- AgreementCreated, AgreementExpired, AgreementRevoked
- ZkProofGenerated, ZkProofVerified

**PassportAuditEvent** sealed record:
- `string EventId` (required, GUID)
- `string EventType` (required, one of the constants above)
- `string PassportId` (required)
- `string ObjectId` (required)
- `string? ActorId` (who triggered the event)
- `DateTimeOffset Timestamp` (required)
- `IReadOnlyDictionary<string, object>? Details` (event-specific data)
- `string? SourceJurisdiction`
- `string? DestinationJurisdiction`
- `string? Decision` (for enforcement events)
- `string? Reason`

**Storage:** ConcurrentDictionary<string, List<PassportAuditEvent>> keyed by PassportId. Also maintain a time-ordered global log (ConcurrentQueue<PassportAuditEvent>, bounded at 100,000 entries).

**Methods:**

`LogEventAsync(PassportAuditEvent evt, CancellationToken ct)`:
- Adds to passport-specific list and global queue
- Enforces immutability: once logged, events cannot be modified

`GetPassportAuditTrailAsync(string passportId, CancellationToken ct)`:
- Returns all events for a specific passport, ordered by timestamp

`GetAuditTrailByTimeRangeAsync(DateTimeOffset start, DateTimeOffset end, CancellationToken ct)`:
- Filters global queue for time range

`GetAuditTrailByTypeAsync(string eventType, int limit, CancellationToken ct)`:
- Filters by event type

`GenerateAuditReportAsync(DateTimeOffset start, DateTimeOffset end, CancellationToken ct)` -> PassportAuditReport:
- Aggregates events by type, counts by decision, identifies top objects
- Returns PassportAuditReport

`PassportAuditReport` sealed record:
- ReportId, StartDate, EndDate
- TotalEvents, EventsByType (Dictionary<string, int>)
- PassportsIssued, PassportsRevoked, PassportsExpired
- TransfersApproved, TransfersDenied
- EnforcementDecisions (Dictionary<string, int>)
- TopObjectsByEvents (top 10 objects by event count)

**Convenience methods** for common audit patterns:
- `LogPassportIssuedAsync(CompliancePassport passport, string actorId, CancellationToken ct)`
- `LogPassportVerifiedAsync(string passportId, string objectId, bool isValid, CancellationToken ct)`
- `LogEnforcementDecisionAsync(string passportId, string objectId, string sourceZone, string destZone, ZoneAction decision, CancellationToken ct)`
- `LogCrossBorderTransferAsync(string passportId, string objectId, string sourceJurisdiction, string destJurisdiction, TransferDecision decision, CancellationToken ct)`

Override `CheckComplianceCoreAsync` to verify audit trail exists for the object's passport.

Thread-safe. Bounded collections. No stubs.
  </action>
  <verify>Build: `dotnet build Plugins/DataWarehouse.Plugins.UltimateCompliance/DataWarehouse.Plugins.UltimateCompliance.csproj --no-restore 2>&1 | tail -5`</verify>
  <done>PassportAuditStrategy provides immutable audit trail for all passport and sovereignty operations with bounded storage and report generation.</done>
</task>

<task type="auto">
  <name>Task 2: Implement SovereigntyObservabilityStrategy</name>
  <files>Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/SovereigntyMesh/SovereigntyObservabilityStrategy.cs</files>
  <action>
Create `SovereigntyObservabilityStrategy.cs` extending `ComplianceStrategyBase`. Namespace: `DataWarehouse.Plugins.UltimateCompliance.Strategies.SovereigntyMesh`.

Strategy properties:
- StrategyId: "sovereignty-observability"
- StrategyName: "Sovereignty Mesh Observability"
- Framework: "SovereigntyMesh"

**Metrics collection (all via Interlocked for thread safety):**

Counter metrics (long):
- `passports_issued_total`
- `passports_verified_total`
- `passports_valid_total`
- `passports_invalid_total`
- `passports_expired_total`
- `passports_revoked_total`
- `zone_enforcement_total`
- `zone_enforcement_allowed_total`
- `zone_enforcement_denied_total`
- `zone_enforcement_conditional_total`
- `transfers_total`
- `transfers_approved_total`
- `transfers_denied_total`
- `zk_proofs_generated_total`
- `zk_proofs_verified_total`

Gauge metrics (tracked via ConcurrentDictionary):
- `active_passports` (per object count)
- `active_zones` (per zone count)
- `active_agreements` (per jurisdiction pair count)

Distribution metrics (rolling window, last 1000 samples):
- `passport_issuance_duration_ms`
- `zone_enforcement_duration_ms`
- `transfer_negotiation_duration_ms`

**Methods:**

`IncrementCounterAsync(string metricName, long value = 1)` — thread-safe increment
`SetGaugeAsync(string metricName, long value)` — set current value
`RecordDurationAsync(string metricName, double durationMs)` — add to rolling window

`GetMetricsSnapshotAsync(CancellationToken ct)` -> SovereigntyMetricsSnapshot:
- All counters, gauges, and distribution summaries (p50, p95, p99, avg)

`SovereigntyMetricsSnapshot` sealed record:
- Counters: IReadOnlyDictionary<string, long>
- Gauges: IReadOnlyDictionary<string, long>
- Distributions: IReadOnlyDictionary<string, DistributionSummary>
- Timestamp: DateTimeOffset

`DistributionSummary` sealed record:
- Count, Min, Max, Average, P50, P95, P99

`GetAlerts(CancellationToken ct)` -> IReadOnlyList<SovereigntyAlert>:
- Check thresholds:
  - passports_expired_total > 10% of active_passports -> Alert "High passport expiration rate"
  - zone_enforcement_denied_total > 20% of zone_enforcement_total -> Alert "High enforcement denial rate"
  - transfers_denied_total > 30% of transfers_total -> Alert "High transfer denial rate"

`SovereigntyAlert` sealed record:
- AlertId, Severity (Info/Warning/Critical), Message, MetricName, CurrentValue, Threshold, Timestamp

`GetHealthAsync(CancellationToken ct)` -> SovereigntyHealth:
- Overall health: Healthy if no Critical alerts, Degraded if Warning alerts, Unhealthy if Critical

`SovereigntyHealth` sealed record:
- Status (Healthy/Degraded/Unhealthy), ActiveAlerts, MetricsSnapshot, Timestamp

Override `CheckComplianceCoreAsync` to return health-based compliance result.

Thread-safe. Bounded rolling windows. No stubs.
  </action>
  <verify>Build: `dotnet build Plugins/DataWarehouse.Plugins.UltimateCompliance/DataWarehouse.Plugins.UltimateCompliance.csproj --no-restore 2>&1 | tail -5`</verify>
  <done>SovereigntyObservabilityStrategy collects counters, gauges, distributions, generates alerts, and reports mesh health.</done>
</task>

</tasks>

<verification>
- `dotnet build Plugins/DataWarehouse.Plugins.UltimateCompliance/DataWarehouse.Plugins.UltimateCompliance.csproj` passes with 0 errors
- Audit trail covers all 14 event types
- Observability collects 15+ counter metrics, 3+ gauges, 3+ distributions
- Alert thresholds trigger on high expiration/denial rates
</verification>

<success_criteria>
- Immutable audit trail with bounded storage (100K events max)
- Audit report generation with aggregation by type, time range, top objects
- Counter/gauge/distribution metrics for all sovereignty operations
- Alert system with configurable thresholds
- Health endpoint (Healthy/Degraded/Unhealthy)
- Build: 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/57-compliance-sovereignty/57-08-SUMMARY.md`
</output>
