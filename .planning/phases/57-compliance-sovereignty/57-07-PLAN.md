---
phase: 57-compliance-sovereignty
plan: 07
type: execute
wave: 4
depends_on: ["57-04", "57-05", "57-06"]
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/SovereigntyMesh/SovereigntyMeshOrchestratorStrategy.cs
autonomous: true
must_haves:
  truths:
    - "Sovereignty mesh orchestrator combines zone enforcement, passport verification, and cross-border protocol"
    - "Single entry point ISovereigntyMesh implementation coordinates all sovereignty operations"
    - "Orchestrator issues passports, verifies them, and checks sovereignty in one unified API"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/SovereigntyMesh/SovereigntyMeshOrchestratorStrategy.cs"
      provides: "ISovereigntyMesh implementation orchestrating all sovereignty components"
      min_lines: 300
  key_links:
    - from: "Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/SovereigntyMesh/SovereigntyMeshOrchestratorStrategy.cs"
      to: "DataWarehouse.SDK/Compliance/ISovereigntyMesh.cs"
      via: "implements ISovereigntyMesh"
      pattern: "ISovereigntyMesh"
    - from: "Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/SovereigntyMesh/SovereigntyMeshOrchestratorStrategy.cs"
      to: "Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/SovereigntyMesh/ZoneEnforcerStrategy.cs"
      via: "delegates to ZoneEnforcer"
      pattern: "ZoneEnforcer|EnforceAsync"
    - from: "Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/SovereigntyMesh/SovereigntyMeshOrchestratorStrategy.cs"
      to: "Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/Passport/CrossBorderTransferProtocolStrategy.cs"
      via: "delegates to CrossBorderProtocol"
      pattern: "CrossBorderProtocol|NegotiateTransfer"
    - from: "Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/SovereigntyMesh/SovereigntyMeshOrchestratorStrategy.cs"
      to: "Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/Passport/PassportIssuanceStrategy.cs"
      via: "delegates passport issuance"
      pattern: "IssuePassport|PassportIssuance"
---

<objective>
Implement the ISovereigntyMesh orchestrator that unifies all Phase 57 components.

Purpose: The orchestrator is the single entry point for all sovereignty operations. It implements ISovereigntyMesh from the SDK, wiring together zone enforcement, passport issuance/verification, and cross-border protocol into one cohesive API. This is the strategy that the kernel and other plugins will interact with.

Output: SovereigntyMeshOrchestratorStrategy implementing ISovereigntyMesh.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/PLUGIN-CATALOG.md
@.planning/phases/57-compliance-sovereignty/57-01-SUMMARY.md
@.planning/phases/57-compliance-sovereignty/57-02-SUMMARY.md
@.planning/phases/57-compliance-sovereignty/57-03-SUMMARY.md
@.planning/phases/57-compliance-sovereignty/57-04-SUMMARY.md
@.planning/phases/57-compliance-sovereignty/57-05-SUMMARY.md
@.planning/phases/57-compliance-sovereignty/57-06-SUMMARY.md
@DataWarehouse.SDK/Compliance/ISovereigntyMesh.cs
@DataWarehouse.SDK/Compliance/CompliancePassport.cs
@Plugins/DataWarehouse.Plugins.UltimateCompliance/IComplianceStrategy.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement SovereigntyMeshOrchestratorStrategy</name>
  <files>Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/SovereigntyMesh/SovereigntyMeshOrchestratorStrategy.cs</files>
  <action>
Create `SovereigntyMeshOrchestratorStrategy.cs` extending `ComplianceStrategyBase` and implementing `ISovereigntyMesh`. Namespace: `DataWarehouse.Plugins.UltimateCompliance.Strategies.SovereigntyMesh`.

Strategy properties:
- StrategyId: "sovereignty-mesh-orchestrator"
- StrategyName: "Sovereignty Mesh Orchestrator"
- Framework: "SovereigntyMesh"

**Internal dependencies (lazy-initialized):**
- `_zoneEnforcer`: ZoneEnforcerStrategy instance
- `_crossBorderProtocol`: CrossBorderTransferProtocolStrategy instance
- `_passportIssuance`: PassportIssuanceStrategy instance
- `_passportVerification`: PassportVerificationApiStrategy instance
- `_zkVerification`: ZeroKnowledgePassportVerificationStrategy instance
- `_zoneRegistry`: DeclarativeZoneRegistry instance
- `_lifecycleManager`: PassportLifecycleStrategy instance

All initialized in `InitializeAsync` — create instances and call their InitializeAsync with Configuration.

**ISovereigntyMesh.ZoneEnforcer** property: returns _zoneEnforcer (cast to IZoneEnforcer).
**ISovereigntyMesh.CrossBorderProtocol** property: returns _crossBorderProtocol (cast to ICrossBorderProtocol).

**IssuePassportAsync(string objectId, IReadOnlyList<string> regulations, CancellationToken ct):**
1. Create ComplianceContext from objectId and regulations
2. Call _passportIssuance.IssuePassportAsync
3. Register passport with _lifecycleManager
4. Return passport

**VerifyPassportAsync(string passportId, CancellationToken ct):**
1. Look up passport from _passportIssuance's cache (or _lifecycleManager's registry)
2. If not found: return PassportVerificationResult with IsValid=false, reason="Passport not found"
3. Call _passportVerification.VerifyPassportAsync
4. Return result

**CheckSovereigntyAsync(string objectId, string sourceLocation, string destLocation, CancellationToken ct):**
1. Look up zones for source and destination via _zoneRegistry
2. If no zones found for either: return Allow (no sovereignty constraints)
3. Look up passport for objectId via _passportIssuance
4. Call _zoneEnforcer.EnforceAsync with source/dest zones and passport
5. If enforcement requires cross-border protocol:
   a. Call _crossBorderProtocol.NegotiateTransferAsync
   b. Call _crossBorderProtocol.EvaluateTransferAsync
   c. Merge cross-border decision with zone enforcement result
6. Log the sovereignty check result
7. Return ZoneEnforcementResult

**Additional orchestration methods:**

`CheckAndIssueAsync(string objectId, string sourceLocation, string destLocation, IReadOnlyList<string> regulations, CancellationToken ct)`:
- Combines issuance + sovereignty check in one call
- Issues passport if not exists, then checks sovereignty
- Returns (CompliancePassport, ZoneEnforcementResult) tuple

`GenerateZkProofAsync(string passportId, string claim, CancellationToken ct)`:
- Delegates to _zkVerification.GenerateProofAsync
- Returns ZkPassportProof

`VerifyZkProofAsync(ZkPassportProof proof, CancellationToken ct)`:
- Delegates to _zkVerification.VerifyProofAsync
- Returns ZkVerificationResult

`GetMeshStatusAsync(CancellationToken ct)` -> MeshStatus:
- Returns overall mesh health: total zones, active zones, total passports, valid passports, recent transfers, recent violations

`MeshStatus` sealed record:
- TotalZones, ActiveZones, TotalPassports, ValidPassports, ExpiredPassports, RecentTransfers (24h), RecentViolations (24h), Timestamp

**Statistics aggregation:** Combines stats from all sub-strategies.

Override `CheckComplianceCoreAsync` to run full sovereignty check for the context's operation.

Thread-safe. No stubs.
  </action>
  <verify>Build: `dotnet build Plugins/DataWarehouse.Plugins.UltimateCompliance/DataWarehouse.Plugins.UltimateCompliance.csproj --no-restore 2>&1 | tail -5`</verify>
  <done>SovereigntyMeshOrchestratorStrategy implements ISovereigntyMesh, unifying zone enforcement, passport issuance/verification, cross-border protocol, and ZK verification into one API.</done>
</task>

<task type="auto">
  <name>Task 2: Wire orchestrator into UltimateCompliance plugin registration</name>
  <files>Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/SovereigntyMesh/SovereigntyMeshOrchestratorStrategy.cs</files>
  <action>
In the same file (SovereigntyMeshOrchestratorStrategy.cs), add a static factory method and message bus integration:

**Static factory:**
`static SovereigntyMeshOrchestratorStrategy CreateDefault()`:
- Creates orchestrator with default configuration
- Calls InitializeAsync with empty config
- Returns ready-to-use instance

**Message bus topic registration (via Configuration keys on InitializeAsync):**
If Configuration contains "MessageBusTopics" = true:
- Register handler patterns (as string constants, not actual message bus calls — the plugin's RegisterHandlers will use these):
  - `public const string TopicPassportIssued = "compliance.passport.issued";`
  - `public const string TopicPassportRevoked = "compliance.passport.revoked";`
  - `public const string TopicPassportExpired = "compliance.passport.expired";`
  - `public const string TopicSovereigntyViolation = "compliance.sovereignty.violation";`
  - `public const string TopicCrossBorderTransfer = "compliance.crossborder.transfer";`
  - `public const string TopicZoneActivated = "compliance.zone.activated";`
  - `public const string TopicZoneDeactivated = "compliance.zone.deactivated";`

These topic constants allow other plugins to subscribe to sovereignty events via the message bus.

Ensure InitializeAsync passes Configuration down to all sub-strategies so they can be individually configured.
  </action>
  <verify>Build: `dotnet build Plugins/DataWarehouse.Plugins.UltimateCompliance/DataWarehouse.Plugins.UltimateCompliance.csproj --no-restore 2>&1 | tail -5`</verify>
  <done>Orchestrator has static factory, message bus topic constants, and passes configuration to all sub-strategies.</done>
</task>

</tasks>

<verification>
- `dotnet build Plugins/DataWarehouse.Plugins.UltimateCompliance/DataWarehouse.Plugins.UltimateCompliance.csproj` passes with 0 errors
- ISovereigntyMesh is fully implemented
- CheckSovereigntyAsync combines zone enforcement + cross-border protocol
- IssuePassportAsync + VerifyPassportAsync work end-to-end
- Message bus topics defined for integration
</verification>

<success_criteria>
- ISovereigntyMesh fully implemented with all methods
- Orchestrator wires 7 sub-strategies correctly
- CheckSovereigntyAsync handles: same-zone (allow), cross-zone (enforce), cross-border (negotiate)
- MeshStatus provides health overview
- Message bus topic constants enable event-driven integration
- Build: 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/57-compliance-sovereignty/57-07-SUMMARY.md`
</output>
