---
phase: 57-compliance-sovereignty
plan: 02
type: execute
wave: 2
depends_on: ["57-01"]
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/Passport/PassportIssuanceStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/Passport/PassportLifecycleStrategy.cs
autonomous: true
must_haves:
  truths:
    - "Passport issuance engine generates CompliancePassport from object tags, classification, and 160+ compliance strategies"
    - "Passports have cryptographic signatures for tamper detection"
    - "Passport lifecycle includes renewal, revocation, and suspension"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/Passport/PassportIssuanceStrategy.cs"
      provides: "Automated passport generation from compliance assessment results"
      min_lines: 250
    - path: "Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/Passport/PassportLifecycleStrategy.cs"
      provides: "Passport renewal, revocation, suspension, and expiration management"
      min_lines: 200
  key_links:
    - from: "Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/Passport/PassportIssuanceStrategy.cs"
      to: "DataWarehouse.SDK/Compliance/CompliancePassport.cs"
      via: "creates CompliancePassport instances"
      pattern: "new CompliancePassport|CompliancePassport.*="
    - from: "Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/Passport/PassportIssuanceStrategy.cs"
      to: "Plugins/DataWarehouse.Plugins.UltimateCompliance/IComplianceStrategy.cs"
      via: "extends ComplianceStrategyBase"
      pattern: "ComplianceStrategyBase"
---

<objective>
Implement the Passport Issuance Engine within UltimateCompliance plugin.

Purpose: This is the core passport generation logic. Given an object's tags, data classification, and applicable regulations, it runs compliance assessments against the existing 160+ strategies and produces a signed CompliancePassport. Also handles passport lifecycle (renewal, revocation, suspension).

Output: Two strategy files in UltimateCompliance providing passport issuance and lifecycle management.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/PLUGIN-CATALOG.md
@.planning/phases/57-compliance-sovereignty/57-01-SUMMARY.md
@DataWarehouse.SDK/Compliance/CompliancePassport.cs
@DataWarehouse.SDK/Compliance/ISovereigntyMesh.cs
@DataWarehouse.SDK/Compliance/PassportEnums.cs
@Plugins/DataWarehouse.Plugins.UltimateCompliance/IComplianceStrategy.cs
@Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/SovereigntyMesh/SovereigntyMeshStrategies.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement PassportIssuanceStrategy</name>
  <files>Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/Passport/PassportIssuanceStrategy.cs</files>
  <action>
Create `PassportIssuanceStrategy.cs` extending `ComplianceStrategyBase` (the plugin-local one from IComplianceStrategy.cs, NOT the SDK's ComplianceStrategyBase). Namespace: `DataWarehouse.Plugins.UltimateCompliance.Strategies.Passport`.

Strategy properties:
- StrategyId: "passport-issuance"
- StrategyName: "Compliance Passport Issuance"
- Framework: "CompliancePassport"

Core functionality:

1. **IssuePassportAsync(string objectId, IReadOnlyList<string> regulationIds, ComplianceContext context, CancellationToken ct)**:
   - Takes objectId, list of applicable regulations, and context
   - For each regulation, creates a PassportEntry with:
     - ComplianceScore derived from context attributes (default 1.0 if no assessment data)
     - Status = Active if score >= 0.8, Provisional if 0.5-0.8, PendingReview if < 0.5
     - AssessedAt = DateTimeOffset.UtcNow
     - NextAssessmentDue = based on regulation (GDPR: 6 months, HIPAA: 12 months, PCI-DSS: 3 months, SOX: 12 months, default: 6 months)
   - Builds EvidenceChain from context attributes (if "Evidence" key exists, parse it)
   - Signs the passport using HMAC-SHA256 with a configurable key from Configuration["SigningKey"] (default: generate ephemeral key)
   - Returns CompliancePassport with all fields populated

2. **RenewPassportAsync(CompliancePassport existing, CancellationToken ct)**:
   - Creates a new passport based on existing, with new ExpiresAt and refreshed entries
   - Preserves evidence chain and appends renewal evidence
   - Returns new passport (immutable records, so creates new instance)

3. **SignPassport(CompliancePassport passport)** private method:
   - Serializes passport content (without DigitalSignature field) to JSON
   - Computes HMAC-SHA256 using signing key
   - Returns byte[] signature

4. **VerifySignature(CompliancePassport passport)** public method:
   - Re-computes signature and compares with passport.DigitalSignature
   - Returns bool

5. **GetRegulationAssessmentPeriod(string regulationId)** private method:
   - Returns TimeSpan for assessment intervals per regulation
   - GDPR: 180 days, HIPAA: 365 days, PCI_DSS: 90 days, SOX: 365 days, SOC2: 365 days, ISO27001: 365 days, CCPA: 180 days, default: 180 days

6. **GetPassportExpiry(IReadOnlyList<PassportEntry> entries)** private method:
   - Passport expires at the earliest NextAssessmentDue across all entries
   - Minimum 30 days, maximum 365 days

Override `CheckComplianceCoreAsync` to:
- Check if objectId has a valid passport in the internal ConcurrentDictionary cache
- If valid passport exists: return Compliant
- If expired/missing: return NonCompliant with recommendation to issue/renew

Use ConcurrentDictionary<string, CompliancePassport> for passport storage (keyed by objectId).

Thread-safe throughout. No Task.Delay, no simulations.
  </action>
  <verify>Build the UltimateCompliance project: `dotnet build Plugins/DataWarehouse.Plugins.UltimateCompliance/DataWarehouse.Plugins.UltimateCompliance.csproj --no-restore 2>&1 | tail -5`</verify>
  <done>PassportIssuanceStrategy issues signed CompliancePassports, supports renewal, verifies signatures, and caches passports per object.</done>
</task>

<task type="auto">
  <name>Task 2: Implement PassportLifecycleStrategy</name>
  <files>Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/Passport/PassportLifecycleStrategy.cs</files>
  <action>
Create `PassportLifecycleStrategy.cs` extending `ComplianceStrategyBase`. Namespace: `DataWarehouse.Plugins.UltimateCompliance.Strategies.Passport`.

Strategy properties:
- StrategyId: "passport-lifecycle"
- StrategyName: "Compliance Passport Lifecycle Management"
- Framework: "CompliancePassport"

Core functionality:

1. **Passport Registry** (ConcurrentDictionary<string, PassportRegistryEntry>):
   - Tracks all issued passports with: PassportId, ObjectId, Status, IssuedAt, ExpiresAt, RevocationReason, SuspensionReason, History (list of status changes)
   - `PassportRegistryEntry` internal record with full audit trail

2. **RegisterPassportAsync(CompliancePassport passport, CancellationToken ct)**:
   - Adds passport to registry
   - Records initial status in history

3. **RevokePassportAsync(string passportId, PassportRevocationReason reason, string revokedBy, CancellationToken ct)**:
   - Sets status to Revoked
   - Records reason and revoker in history
   - Returns updated PassportRegistryEntry

4. **SuspendPassportAsync(string passportId, string reason, CancellationToken ct)**:
   - Sets status to Suspended
   - Records reason in history

5. **ReinstatePassportAsync(string passportId, CancellationToken ct)**:
   - Only if currently Suspended
   - Sets status back to Active
   - Records reinstatement in history

6. **GetExpiredPassportsAsync(CancellationToken ct)**:
   - Scans registry for passports where ExpiresAt < DateTimeOffset.UtcNow and Status == Active
   - Returns list for renewal processing

7. **GetPassportHistoryAsync(string passportId, CancellationToken ct)**:
   - Returns full status change history for audit

8. **PassportStatusChange** internal record:
   - OldStatus, NewStatus, Reason, ChangedBy, Timestamp

Override `CheckComplianceCoreAsync` to:
- Check if the object's passport is in the registry
- Validate status is Active and not expired
- Return appropriate ComplianceResult

Thread-safe with ConcurrentDictionary. Full audit trail for every status change.
  </action>
  <verify>Build the UltimateCompliance project: `dotnet build Plugins/DataWarehouse.Plugins.UltimateCompliance/DataWarehouse.Plugins.UltimateCompliance.csproj --no-restore 2>&1 | tail -5`</verify>
  <done>PassportLifecycleStrategy manages full passport lifecycle: register, revoke, suspend, reinstate with complete audit history. Scans for expired passports.</done>
</task>

</tasks>

<verification>
- `dotnet build Plugins/DataWarehouse.Plugins.UltimateCompliance/DataWarehouse.Plugins.UltimateCompliance.csproj` passes with 0 errors
- PassportIssuanceStrategy creates signed passports from regulation lists
- PassportLifecycleStrategy tracks revocation/suspension/reinstatement with history
- Both strategies extend ComplianceStrategyBase correctly
</verification>

<success_criteria>
- Passport issuance produces CompliancePassport with entries per regulation, evidence chain, digital signature
- Passport lifecycle supports revoke, suspend, reinstate with full audit trail
- No Task.Delay, no simulations, no stubs
- Build: 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/57-compliance-sovereignty/57-02-SUMMARY.md`
</output>
