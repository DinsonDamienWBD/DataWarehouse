---
phase: 57-compliance-sovereignty
plan: 03
type: execute
wave: 2
depends_on: ["57-01"]
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/SovereigntyMesh/SovereigntyZoneStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/SovereigntyMesh/DeclarativeZoneRegistry.cs
autonomous: true
must_haves:
  truths:
    - "Sovereignty zones are defined declaratively as tag-based rules"
    - "Zone registry supports 30+ pre-configured zones covering EU, APAC, Americas, ME/Africa"
    - "Zones evaluate data objects against their rules and return Allow/Deny/RequireApproval actions"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/SovereigntyMesh/SovereigntyZoneStrategy.cs"
      provides: "ISovereigntyZone implementation with tag-based rule evaluation"
      min_lines: 200
    - path: "Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/SovereigntyMesh/DeclarativeZoneRegistry.cs"
      provides: "Zone registry with 30+ pre-configured sovereignty zones"
      min_lines: 300
  key_links:
    - from: "Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/SovereigntyMesh/SovereigntyZoneStrategy.cs"
      to: "DataWarehouse.SDK/Compliance/ISovereigntyMesh.cs"
      via: "implements ISovereigntyZone"
      pattern: "ISovereigntyZone"
    - from: "Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/SovereigntyMesh/DeclarativeZoneRegistry.cs"
      to: "Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/SovereigntyMesh/SovereigntyZoneStrategy.cs"
      via: "creates SovereigntyZone instances"
      pattern: "SovereigntyZone"
---

<objective>
Implement declarative sovereignty zones as tag-based rules within UltimateCompliance.

Purpose: Sovereignty zones are the atomic unit of the mesh. Each zone defines which jurisdictions it covers, what regulations it enforces, and tag-based action rules. The registry pre-configures 30+ zones covering major regulatory regions worldwide. Routing checks sovereignty BEFORE allowing data movement.

Output: Zone implementation and registry with 30+ pre-configured zones.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/PLUGIN-CATALOG.md
@.planning/phases/57-compliance-sovereignty/57-01-SUMMARY.md
@DataWarehouse.SDK/Compliance/ISovereigntyMesh.cs
@DataWarehouse.SDK/Compliance/PassportEnums.cs
@Plugins/DataWarehouse.Plugins.UltimateCompliance/IComplianceStrategy.cs
@Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/SovereigntyMesh/SovereigntyMeshStrategies.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement SovereigntyZoneStrategy (ISovereigntyZone)</name>
  <files>Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/SovereigntyMesh/SovereigntyZoneStrategy.cs</files>
  <action>
Create `SovereigntyZoneStrategy.cs` in namespace `DataWarehouse.Plugins.UltimateCompliance.Strategies.SovereigntyMesh`.

Implement `SovereigntyZone` class that implements `ISovereigntyZone` from SDK:

Properties (all set via constructor or init):
- ZoneId, Name, Jurisdictions, RequiredRegulations, ActionRules, IsActive

`EvaluateAsync` implementation:
1. If zone is not active, return ZoneAction.Allow (inactive zones don't block)
2. Check if any tag in context matches ActionRules keys (support wildcard patterns like "pii:*", "classification:*")
3. For each matching rule, collect the ZoneAction
4. If multiple rules match, take the most restrictive action (Deny > Quarantine > RequireAnonymization > RequireEncryption > RequireApproval > Allow)
5. If passport is provided, check if it covers all RequiredRegulations:
   - If passport covers all: reduce action by one severity level (e.g., RequireApproval -> Allow)
   - If passport missing or incomplete: escalate by one level (e.g., Allow -> RequireApproval)
6. Return final ZoneAction

`TagPatternMatcher` private helper:
- Supports exact match: "classification:secret" matches "classification:secret"
- Supports prefix wildcard: "pii:*" matches "pii:name", "pii:email", etc.
- Supports suffix wildcard: "*:eu" matches "jurisdiction:eu", "region:eu"
- Case-insensitive matching

Also implement `SovereigntyZoneBuilder` for fluent zone creation:
- `.WithId(string)`, `.WithName(string)`, `.InJurisdictions(params string[])`, `.Requiring(params string[])`, `.WithRule(string tagPattern, ZoneAction action)`, `.Build()` -> returns SovereigntyZone

Thread-safe. No stubs.
  </action>
  <verify>Build: `dotnet build Plugins/DataWarehouse.Plugins.UltimateCompliance/DataWarehouse.Plugins.UltimateCompliance.csproj --no-restore 2>&1 | tail -5`</verify>
  <done>SovereigntyZone implements ISovereigntyZone with tag pattern matching, passport-aware evaluation, and fluent builder. Action escalation/de-escalation logic works with passports.</done>
</task>

<task type="auto">
  <name>Task 2: Implement DeclarativeZoneRegistry with 30+ zones</name>
  <files>Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/SovereigntyMesh/DeclarativeZoneRegistry.cs</files>
  <action>
Create `DeclarativeZoneRegistry.cs` in namespace `DataWarehouse.Plugins.UltimateCompliance.Strategies.SovereigntyMesh`.

Class `DeclarativeZoneRegistry` extending `ComplianceStrategyBase`:
- StrategyId: "sovereignty-zone-registry"
- StrategyName: "Declarative Sovereignty Zone Registry"
- Framework: "SovereigntyMesh"

Contains ConcurrentDictionary<string, SovereigntyZone> for zone storage.

On `InitializeAsync`, register these pre-configured zones using SovereigntyZoneBuilder:

**EU Zones (6):**
1. eu-gdpr-zone: All 27 EU member states, requires GDPR, rules: pii:* -> RequireEncryption, classification:secret -> Deny (for non-EU destinations)
2. eu-eea-zone: EU + Iceland/Norway/Liechtenstein, requires GDPR, same rules as EU
3. eu-dora-zone: EU financial sector, requires DORA+GDPR, financial:* -> RequireApproval
4. eu-nis2-zone: EU critical infrastructure, requires NIS2+GDPR, infrastructure:* -> RequireEncryption
5. eu-ai-act-zone: EU AI regulation, requires AI_Act, ai-model:* -> RequireApproval, training-data:* -> RequireAnonymization
6. eu-ehealth-zone: EU health data, requires GDPR+ePrivacy, health:* -> RequireEncryption, patient:* -> Deny (outside zone)

**Americas Zones (5):**
7. us-hipaa-zone: US, requires HIPAA, phi:* -> RequireEncryption, health:* -> RequireApproval
8. us-fedramp-zone: US federal, requires FedRAMP, cui:* -> RequireEncryption, classified:* -> Deny
9. us-ccpa-zone: California, requires CCPA, consumer:* -> RequireApproval
10. br-lgpd-zone: Brazil, requires LGPD, pii:* -> RequireEncryption
11. ca-pipeda-zone: Canada, requires PIPEDA, personal:* -> RequireApproval

**APAC Zones (8):**
12. cn-pipl-zone: China, requires PIPL, pii:* -> Deny (for outbound), personal:* -> RequireApproval
13. jp-appi-zone: Japan, requires APPI, personal:* -> RequireApproval
14. sg-pdpa-zone: Singapore, requires PDPA_SG, personal:* -> RequireEncryption
15. au-privacy-zone: Australia, requires Privacy_Act_AU, personal:* -> RequireApproval
16. kr-pipa-zone: South Korea, requires K_PIPA, personal:* -> RequireEncryption
17. in-pdpb-zone: India, requires PDPB, critical-personal:* -> Deny (outbound), personal:* -> RequireApproval
18. hk-pdpo-zone: Hong Kong, requires PDPO_HK, personal:* -> RequireApproval
19. tw-pdpa-zone: Taiwan, requires PDPA_TW, personal:* -> RequireApproval

**Middle East/Africa Zones (5):**
20. ae-pdpl-zone: UAE, requires AE_PDPL, personal:* -> RequireEncryption
21. sa-pdpl-zone: Saudi Arabia, requires SA_PDPL, personal:* -> RequireEncryption, government:* -> Deny
22. za-popia-zone: South Africa, requires POPIA, personal:* -> RequireApproval
23. qa-pdpl-zone: Qatar, requires QA_PDPL, personal:* -> RequireEncryption
24. ng-ndpr-zone: Nigeria, requires NDPR, personal:* -> RequireApproval

**Industry Zones (4):**
25. financial-global-zone: All jurisdictions, requires PCI_DSS+SOX, payment:* -> RequireEncryption, financial:* -> RequireApproval
26. healthcare-global-zone: All jurisdictions, requires HIPAA, health:* -> RequireEncryption, phi:* -> Deny (outside zone)
27. iso27001-zone: All jurisdictions, requires ISO27001, classified:* -> RequireEncryption
28. worm-sec-zone: All jurisdictions, requires SEC_17a4, financial-record:* -> Deny (modification)

**Supranational Zones (3):**
29. five-eyes-zone: US/UK/CA/AU/NZ, requires respective local laws, intelligence:* -> RequireEncryption
30. apec-cbpr-zone: APEC economies, requires CBPR, personal:* -> RequireApproval
31. adequacy-zone: EU-adequate countries (JP/KR/NZ/UK/CH/IL/AR/UY), requires GDPR, pii:* -> Allow (transfers from EU ok)

Public methods:
- `RegisterZoneAsync(SovereigntyZone zone, CancellationToken ct)` — adds custom zone
- `GetZoneAsync(string zoneId, CancellationToken ct)` — retrieves zone
- `GetZonesForJurisdictionAsync(string jurisdictionCode, CancellationToken ct)` — finds all zones containing jurisdiction
- `GetAllZonesAsync(CancellationToken ct)` — returns all zones
- `DeactivateZoneAsync(string zoneId, CancellationToken ct)` — sets zone inactive

Override `CheckComplianceCoreAsync` to check if the operation's source/destination jurisdictions have active zones and return compliance result.

Thread-safe. No stubs.
  </action>
  <verify>Build: `dotnet build Plugins/DataWarehouse.Plugins.UltimateCompliance/DataWarehouse.Plugins.UltimateCompliance.csproj --no-restore 2>&1 | tail -5`</verify>
  <done>DeclarativeZoneRegistry has 31 pre-configured sovereignty zones covering EU, Americas, APAC, ME/Africa, Industry, and Supranational regions. Supports custom zone registration and jurisdiction lookups.</done>
</task>

</tasks>

<verification>
- `dotnet build Plugins/DataWarehouse.Plugins.UltimateCompliance/DataWarehouse.Plugins.UltimateCompliance.csproj` passes with 0 errors
- SovereigntyZone evaluates tag patterns against rules with passport awareness
- DeclarativeZoneRegistry initializes with 31 zones
- GetZonesForJurisdictionAsync("DE") returns eu-gdpr-zone, eu-eea-zone, eu-dora-zone, eu-nis2-zone, eu-ai-act-zone, eu-ehealth-zone
</verification>

<success_criteria>
- 31 sovereignty zones pre-configured covering global regulatory landscape
- Tag-based rule evaluation with wildcard support
- Passport-aware action escalation/de-escalation
- Fluent builder API for custom zone creation
- Build: 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/57-compliance-sovereignty/57-03-SUMMARY.md`
</output>
