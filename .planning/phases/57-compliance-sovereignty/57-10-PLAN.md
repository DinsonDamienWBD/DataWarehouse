---
phase: 57-compliance-sovereignty
plan: 10
type: execute
wave: 6
depends_on: ["57-07", "57-08", "57-09"]
files_modified:
  - Tests/DataWarehouse.Tests/ComplianceSovereignty/CompliancePassportTests.cs
  - Tests/DataWarehouse.Tests/ComplianceSovereignty/SovereigntyMeshTests.cs
autonomous: true
must_haves:
  truths:
    - "End-to-end test proves passport issuance, verification, and sovereignty enforcement work together"
    - "Build passes with 0 errors across SDK and UltimateCompliance"
    - "All 11 new strategy files compile and integrate correctly"
  artifacts:
    - path: "Tests/DataWarehouse.Tests/ComplianceSovereignty/CompliancePassportTests.cs"
      provides: "Unit tests for passport issuance, lifecycle, verification, ZK proofs, and tag integration"
      min_lines: 200
    - path: "Tests/DataWarehouse.Tests/ComplianceSovereignty/SovereigntyMeshTests.cs"
      provides: "Unit tests for zone evaluation, enforcement, cross-border protocol, routing, and observability"
      min_lines: 200
  key_links:
    - from: "Tests/DataWarehouse.Tests/ComplianceSovereignty/CompliancePassportTests.cs"
      to: "Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/Passport/PassportIssuanceStrategy.cs"
      via: "tests passport issuance"
      pattern: "PassportIssuanceStrategy|IssuePassport"
    - from: "Tests/DataWarehouse.Tests/ComplianceSovereignty/SovereigntyMeshTests.cs"
      to: "Plugins/DataWarehouse.Plugins.UltimateCompliance/Strategies/SovereigntyMesh/SovereigntyMeshOrchestratorStrategy.cs"
      via: "tests orchestrator"
      pattern: "SovereigntyMeshOrchestrator|CheckSovereignty"
---

<objective>
Verify end-to-end functionality with tests and full build validation.

Purpose: Validate all Phase 57 components work together. Tests cover passport issuance through sovereignty enforcement, ZK proofs, tag integration, and routing. Full build validation ensures no regressions across the entire solution.

Output: Test files and verified build.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/PLUGIN-CATALOG.md
@.planning/phases/57-compliance-sovereignty/57-01-SUMMARY.md
@.planning/phases/57-compliance-sovereignty/57-07-SUMMARY.md
@.planning/phases/57-compliance-sovereignty/57-08-SUMMARY.md
@.planning/phases/57-compliance-sovereignty/57-09-SUMMARY.md
@DataWarehouse.SDK/Compliance/CompliancePassport.cs
@DataWarehouse.SDK/Compliance/ISovereigntyMesh.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CompliancePassport unit tests</name>
  <files>Tests/DataWarehouse.Tests/ComplianceSovereignty/CompliancePassportTests.cs</files>
  <action>
Create test file. Check existing test project structure first (look at Tests/ directory for the correct project and namespace pattern).

Tests to implement:

**PassportIssuance tests:**
1. `IssuePassport_WithGdprRegulation_ReturnsActivePassport` — Issue passport for GDPR, verify status Active, entry exists, ExpiresAt > now
2. `IssuePassport_WithMultipleRegulations_AllEntriesPresent` — Issue for GDPR+HIPAA+PCI_DSS, verify 3 entries
3. `IssuePassport_HasDigitalSignature` — Verify DigitalSignature is non-null and non-empty
4. `IssuePassport_IsValid_ReturnsTrue` — Verify IsValid() returns true for freshly issued passport

**PassportLifecycle tests:**
5. `RevokePassport_StatusBecomesRevoked` — Register then revoke, verify status change
6. `SuspendPassport_StatusBecomesSuspended` — Register then suspend, verify
7. `ReinstatePassport_StatusBecomesActive` — Suspend then reinstate, verify
8. `GetExpiredPassports_ReturnsExpired` — Create passport with past expiry, verify it appears

**PassportVerification tests:**
9. `VerifyPassport_ValidPassport_ReturnsValid` — Issue and verify, result should be valid
10. `VerifyPassport_ExpiredPassport_ReturnsInvalid` — Create expired passport, verify returns invalid
11. `VerifyPassport_TamperedSignature_ReturnsInvalid` — Modify signature bytes, verify returns invalid

**ZKProof tests:**
12. `GenerateZkProof_ValidClaim_ReturnsProof` — Generate proof for "covers:GDPR", verify non-null
13. `VerifyZkProof_ValidProof_ReturnsTrue` — Generate then verify, result should be valid
14. `GenerateZkProof_FalseClaim_Throws` — Try proving "covers:NONEXISTENT", verify exception

**TagIntegration tests:**
15. `PassportToTags_ContainsAllFields` — Convert passport to tags, verify all expected keys present
16. `TagsToPassport_Roundtrip` — Convert to tags then back, verify equality
17. `FindObjectsByRegulation_FindsMatchingObjects` — Store multiple, query by regulation

Use xUnit with [Fact] attributes. Create strategy instances directly (no DI needed for unit tests). Initialize strategies with empty config via InitializeAsync.
  </action>
  <verify>Run tests: `dotnet test Tests/DataWarehouse.Tests/ --filter "FullyQualifiedName~ComplianceSovereignty.CompliancePassport" --no-restore 2>&1 | tail -10`</verify>
  <done>17 passport tests pass covering issuance, lifecycle, verification, ZK proofs, and tag integration.</done>
</task>

<task type="auto">
  <name>Task 2: Create SovereigntyMesh unit tests and full build validation</name>
  <files>Tests/DataWarehouse.Tests/ComplianceSovereignty/SovereigntyMeshTests.cs</files>
  <action>
Create test file in same directory.

Tests to implement:

**SovereigntyZone tests:**
1. `SovereigntyZone_EvaluatePiiTag_ReturnsRequireEncryption` — Create EU GDPR zone, evaluate "pii:email", verify RequireEncryption
2. `SovereigntyZone_WithPassport_ReducesSeverity` — Zone requires GDPR, passport covers GDPR, verify action reduced
3. `SovereigntyZone_WildcardMatch_Works` — Test "pii:*" matches "pii:name"

**DeclarativeZoneRegistry tests:**
4. `ZoneRegistry_Has31Zones_AfterInit` — Initialize, count zones >= 31
5. `GetZonesForJurisdiction_Germany_ReturnsEuZones` — Query "DE", verify eu-gdpr-zone and eu-eea-zone present
6. `RegisterCustomZone_IsRetrievable` — Register zone, retrieve by ID, verify

**ZoneEnforcer tests:**
7. `EnforceAsync_SameZone_Allows` — Source and dest in same zone, verify Allowed
8. `EnforceAsync_CrossZone_WithPassport_Allows` — Cross-zone with valid passport, verify Allowed
9. `EnforceAsync_CrossZone_WithoutPassport_Denies` — Cross-zone without passport where zone requires one, verify Denied

**CrossBorderProtocol tests:**
10. `NegotiateTransfer_EuToAdequate_UsesAdequacyDecision` — EU->JP, verify LegalBasis = "AdequacyDecision"
11. `NegotiateTransfer_EuToNonAdequate_UsesScc` — EU->US, verify LegalBasis = "SCC"
12. `TransferHistory_IsRecorded` — Make transfer, check history has entry

**SovereigntyRouting tests:**
13. `CheckRouting_SameJurisdiction_Allows` — Same jurisdiction, verify Allowed
14. `CheckRouting_DeniedDestination_SuggestsAlternative` — Denied destination, verify RecommendedLocation present

**Observability tests:**
15. `MetricsSnapshot_HasAllCounters` — After operations, snapshot should have non-zero counters
16. `GetHealth_NoAlerts_ReturnsHealthy` — Fresh mesh, verify Healthy status

**Orchestrator integration test:**
17. `Orchestrator_IssueAndCheckSovereignty_EndToEnd` — Issue passport, check sovereignty for cross-border, verify complete flow

After tests, run full solution build:
`dotnet build DataWarehouse.slnx --no-restore 2>&1 | tail -20`

If build errors in OTHER projects (not Phase 57 files), note them but don't fix — they're pre-existing. Only fix errors in Phase 57 files.

Use xUnit with [Fact] attributes.
  </action>
  <verify>
Run tests: `dotnet test Tests/DataWarehouse.Tests/ --filter "FullyQualifiedName~ComplianceSovereignty.SovereigntyMesh" --no-restore 2>&1 | tail -10`
Full build: `dotnet build DataWarehouse.slnx --no-restore 2>&1 | grep -E "(error|warning|Build succeeded)" | tail -10`
  </verify>
  <done>17 sovereignty mesh tests pass. Full solution build shows 0 new errors from Phase 57 files. All 11 new strategy files + 3 SDK files compile correctly.</done>
</task>

</tasks>

<verification>
- All passport tests pass (17)
- All sovereignty mesh tests pass (17)
- `dotnet build DataWarehouse.slnx` introduces 0 new errors from Phase 57 files
- 3 SDK files + 11 strategy files + 2 test files = 16 total files created in Phase 57
</verification>

<success_criteria>
- 34 total tests passing
- End-to-end flow: issue passport -> check sovereignty -> cross-border negotiation works
- ZK proofs generate and verify correctly
- Tag integration roundtrips losslessly
- Zone registry has 31+ zones
- No new build errors introduced by Phase 57
</success_criteria>

<output>
After completion, create `.planning/phases/57-compliance-sovereignty/57-10-SUMMARY.md`
</output>
