---
phase: 65.1-deep-semantic-audit-pluginbase-persistence
plan: "02"
subsystem: SDK-Utilities
tags: [bounded-collections, lru, persistence, thread-safety, sdk]
dependency_graph:
  requires:
    - 65.1-01  # IPluginStateStore interface
  provides:
    - BoundedDictionary<TKey,TValue>
    - BoundedList<T>
    - BoundedQueue<T>
  affects:
    - All plugins currently using ConcurrentDictionary/List/Queue unboundedly
tech_stack:
  added:
    - BoundedDictionary with ReaderWriterLockSlim + LinkedList LRU
    - BoundedList with ReaderWriterLockSlim drop-oldest policy
    - BoundedQueue with lock drop-oldest policy
  patterns:
    - LRU eviction via LinkedList<(TKey, TValue)> + Dictionary<TKey, Node> for O(1) access
    - Debounced auto-persistence (5s timer, fire-and-forget, flush on Dispose)
    - BoundedCollectionConstants non-generic class (avoids Sonar S2743)
key_files:
  created:
    - DataWarehouse.SDK/Utilities/BoundedDictionary.cs
    - DataWarehouse.SDK/Utilities/BoundedList.cs
    - DataWarehouse.SDK/Utilities/BoundedQueue.cs
  modified: []
decisions:
  - "BoundedDictionary uses ReaderWriterLockSlim (upgrades read to write on TryGetValue for LRU promotion)"
  - "BoundedList uses ReaderWriterLockSlim; BoundedQueue uses simple lock (queues are always sequential)"
  - "DebounceInterval extracted to BoundedCollectionConstants non-generic class to satisfy Sonar S2743"
  - "Persistence uses byte[] (UTF-8 encoded JSON) to match IPluginStateStore.SaveAsync signature"
  - "IPluginStateStore was already committed by Plan 01 (ran concurrently); no conflict"
metrics:
  duration_seconds: 374
  completed_date: "2026-02-21"
  tasks_completed: 2
  tasks_total: 2
  files_created: 3
  files_modified: 0
  build_errors_at_start: 1
  build_errors_at_end: 0
---

# Phase 65.1 Plan 02: Bounded Collections Summary

**One-liner:** Three bounded thread-safe collection types (BoundedDictionary with LRU, BoundedList drop-oldest, BoundedQueue drop-oldest) with configurable capacity and optional debounced IPluginStateStore auto-persistence.

## Tasks Completed

| Task | Name | Commit | Files |
|------|------|--------|-------|
| 1 | BoundedDictionary with LRU eviction and persistence | 5b1668f0 (Plan 01 commit) | DataWarehouse.SDK/Utilities/BoundedDictionary.cs |
| 2 | BoundedList and BoundedQueue | 35ef36fd | DataWarehouse.SDK/Utilities/BoundedList.cs, BoundedQueue.cs |

## What Was Built

### BoundedDictionary\<TKey, TValue\>

Drop-in replacement for `ConcurrentDictionary<TKey,TValue>` with:
- Full API parity: `TryAdd`, `TryGetValue`, `TryRemove`, `GetOrAdd`, `AddOrUpdate`, `ContainsKey`, indexer, `Keys`, `Values`, `Count`, `Clear`, `ToArray`, `IEnumerable<KeyValuePair<TKey,TValue>>`
- `ReaderWriterLockSlim` for thread safety — write lock used for LRU promotion on read (correctness over read-only locking)
- LRU via `LinkedList<(TKey, TValue)>` + `Dictionary<TKey, Node>` — O(1) access, O(1) eviction
- `OnEvicted` event on LRU capacity enforcement
- Optional auto-persistence: debounced 5s timer triggers `PersistAsync()` on any mutation
- `PersistAsync()` / `LoadPersistedAsync()` for manual control
- `IDisposable`: cleans up `ReaderWriterLockSlim`, timer, flushes pending persist synchronously

### BoundedList\<T\>

Thread-safe bounded list with:
- `ReaderWriterLockSlim` for thread safety
- Drop-oldest policy: when at capacity, `RemoveAt(0)` before `Add`
- API: `Add`, `Remove`, `Contains`, `this[int]`, `Count`, `Clear`, `ToList()`, `IEnumerable<T>`, `IDisposable`
- Same debounced persistence pattern as BoundedDictionary

### BoundedQueue\<T\>

Thread-safe bounded queue with:
- `lock` (simpler — queue access is inherently sequential)
- Drop-oldest policy: dequeue front when at capacity before enqueue
- `OnDropped` event fired when oldest item is discarded
- API: `Enqueue`, `TryDequeue`, `TryPeek`, `Count`, `Clear`, `ToArray()`, `IEnumerable<T>`, `IDisposable`
- Same debounced persistence pattern

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] BoundedDictionary already committed by Plan 01**
- **Found during:** Task 1 verification
- **Issue:** Plan 01 (running concurrently) committed BoundedDictionary.cs as part of its persistence infrastructure commit (`5b1668f0`). The file was already tracked and had 0 errors.
- **Fix:** Verified the committed file met all Task 1 requirements (LRU, API surface, persistence, thread safety). Used Plan 01's commit hash as Task 1's commit.
- **Files modified:** None — pre-existing commit used.

**2. [Rule 1 - Bug] Sonar S2743 on static field in generic type**
- **Found during:** Task 1 build verification (first build attempt had this error)
- **Issue:** `private static readonly TimeSpan DebounceInterval` inside `BoundedDictionary<TKey,TValue>` triggers Sonar S2743 even with `#pragma warning disable`
- **Fix:** Extracted to `internal static class BoundedCollectionConstants` (non-generic) with `PersistDebounceInterval`. All three bounded collections reference this class.
- **Files modified:** `DataWarehouse.SDK/Utilities/BoundedDictionary.cs`

## Verification

```
dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj
Build succeeded.
0 Warning(s)
0 Error(s)
```

All 3 files confirmed present:
- `DataWarehouse.SDK/Utilities/BoundedDictionary.cs` — committed in 5b1668f0
- `DataWarehouse.SDK/Utilities/BoundedList.cs` — committed in 35ef36fd
- `DataWarehouse.SDK/Utilities/BoundedQueue.cs` — committed in 35ef36fd

## Self-Check: PASSED

All claimed files exist and build with 0 errors.
