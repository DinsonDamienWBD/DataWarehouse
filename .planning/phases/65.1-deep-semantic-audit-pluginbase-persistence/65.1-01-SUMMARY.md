---
phase: 65.1-deep-semantic-audit-pluginbase-persistence
plan: 01
subsystem: persistence
tags: [IPluginStateStore, IPersistentBackingStore, DefaultPluginStateStore, PluginStateEntry, message-bus, BoundedDictionary]

# Dependency graph
requires: []
provides:
  - IPluginStateStore interface (Save/Load/Delete/ListKeys/Exists, dw:// path convention)
  - IPersistentBackingStore interface (backend contract for storage implementations)
  - DefaultPluginStateStore (routes all ops through IMessageBus with optional direct fallback)
  - PluginStateEntry (serializable state model)
  - BoundedDictionary (LRU-bounded dictionary with auto-persistence via IPluginStateStore)
affects:
  - all plugins that need persistent state (uses IPluginStateStore)
  - storage backend plugins (implement IPersistentBackingStore, subscribe to dw.internal.plugin-state.* topics)
  - v6.0 Dynamic Subsystem Scaling (all 60 plugins get PersistentBackingStore integration)

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Message bus routing: DefaultPluginStateStore uses PublishAndWaitAsync for writes, SendAsync for reads"
    - "Path convention: dw://internal/plugin-state/{pluginId}/{key} for all plugin state"
    - "Fallback pattern: IPersistentBackingStore as direct fallback when bus is unavailable"
    - "Input validation: ValidatePluginId/ValidateKey throw ArgumentException for null/empty"

key-files:
  created:
    - DataWarehouse.SDK/Contracts/Persistence/IPluginStateStore.cs
    - DataWarehouse.SDK/Contracts/Persistence/IPersistentBackingStore.cs
    - DataWarehouse.SDK/Contracts/Persistence/DefaultPluginStateStore.cs
    - DataWarehouse.SDK/Contracts/Persistence/PluginStateEntry.cs
    - DataWarehouse.SDK/Utilities/BoundedDictionary.cs
  modified: []

key-decisions:
  - "DefaultPluginStateStore uses SendAsync (not PublishAndWaitAsync) for Load/List/Exists — these are request-response operations that need data back"
  - "IPersistentBackingStore optional fallback accepted in constructor — supports edge/early-boot scenarios without requiring bus"
  - "Static interface method IPluginStateStore.BuildPath enforces path convention at the interface level"
  - "BoundedDictionary references IPluginStateStore for auto-persistence — was pre-written awaiting this namespace"

patterns-established:
  - "Plugin state path: dw://internal/plugin-state/{pluginId}/{key}"
  - "Bus topics: dw.internal.plugin-state.{write|read|delete|list|exists}"
  - "All state store methods validate pluginId and key, throw ArgumentException on null/whitespace"

# Metrics
duration: 4min
completed: 2026-02-20
---

# Phase 65.1 Plan 01: State Persistence Contracts Summary

**IPluginStateStore/IPersistentBackingStore/DefaultPluginStateStore foundation with message bus routing via dw.internal.plugin-state.* topics and dw:// path convention**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-20T15:51:13Z
- **Completed:** 2026-02-20T15:55:23Z
- **Tasks:** 1
- **Files modified:** 5

## Accomplishments
- Created `IPluginStateStore` with 5 async methods (Save/Load/Delete/ListKeys/Exists) and static `BuildPath` helper enforcing `dw://internal/plugin-state/{pluginId}/{key}` convention
- Created `IPersistentBackingStore` as the backend contract for storage implementations (Write/Read/Delete/List/Exists on raw paths)
- Created `DefaultPluginStateStore` routing all operations through `IMessageBus` — writes use `PublishAndWaitAsync`, reads/queries use `SendAsync` for response; optional `IPersistentBackingStore` fallback for unavailable bus scenarios
- Created `PluginStateEntry` serializable model with Key, Data, ContentType (default application/json), LastModified, Metadata
- Enabled `BoundedDictionary<TKey,TValue>` (pre-written, awaiting Persistence namespace) — LRU-bounded dictionary with auto-persistence via IPluginStateStore and debounced saves

## Task Commits

Each task was committed atomically:

1. **Task 1: Create state persistence contracts and default implementation** - `5b1668f0` (feat)

**Plan metadata:** (docs commit below)

## Files Created/Modified
- `DataWarehouse.SDK/Contracts/Persistence/IPluginStateStore.cs` - Plugin state store interface with 5 async methods and static path builder
- `DataWarehouse.SDK/Contracts/Persistence/IPersistentBackingStore.cs` - Backend storage contract for implementations subscribing to bus topics
- `DataWarehouse.SDK/Contracts/Persistence/DefaultPluginStateStore.cs` - Default implementation routing through IMessageBus with optional direct fallback
- `DataWarehouse.SDK/Contracts/Persistence/PluginStateEntry.cs` - Serializable state entry model (Key, Data, ContentType, LastModified, Metadata)
- `DataWarehouse.SDK/Utilities/BoundedDictionary.cs` - Pre-existing LRU dictionary referencing IPluginStateStore; unlocked by creating the namespace

## Decisions Made
- `SendAsync` used for Load/Exists/ListKeys (request-response needs data back); `PublishAndWaitAsync` used for Save/Delete (fire-and-wait, no payload expected)
- Optional `IPersistentBackingStore` in constructor supports edge scenarios (early boot, tests, air-gapped) without requiring bus
- `BuildPath` implemented as static interface method (C# 8+) to enforce path convention at the contract level — implementors cannot miss it
- Fallback catches all exceptions when backingStore is non-null, ensuring resilience in degraded bus scenarios

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed S2743 Sonar build-breaking error in BoundedDictionary.cs**
- **Found during:** Task 1 (first build attempt)
- **Issue:** `BoundedDictionary<TKey,TValue>` had `private static readonly TimeSpan DebounceInterval` — a static field in a generic type triggers Sonar S2743 as a build error. This file was pre-written awaiting the Persistence namespace; creating the namespace exposed the error.
- **Fix:** Linter extracted constant to a new non-generic `BoundedCollectionConstants` internal static class; `DebounceInterval` renamed `PersistDebounceInterval` and referenced from there
- **Files modified:** `DataWarehouse.SDK/Utilities/BoundedDictionary.cs`
- **Verification:** `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` — 0 errors
- **Committed in:** `5b1668f0` (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (Rule 1 - pre-existing bug in unlocked file)
**Impact on plan:** The fix was necessary — BoundedDictionary.cs could not compile without it. No scope creep; the file was already in the repository awaiting the Persistence namespace.

## Issues Encountered
- `PluginMessage` is in `DataWarehouse.SDK.Utilities` namespace (not `DataWarehouse.SDK.Contracts`) — required adding `using DataWarehouse.SDK.Utilities;` to DefaultPluginStateStore. Identified from first failed build and corrected immediately.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- `IPluginStateStore` is ready for all plugins to inject and use for persistent state
- `IPersistentBackingStore` is ready for storage backend plugins to implement
- `DefaultPluginStateStore` is ready for DI registration in the kernel
- Storage backend plugins must subscribe to `dw.internal.plugin-state.*` topics to handle routed requests
- `BoundedDictionary` is now fully functional with auto-persistence support

---
*Phase: 65.1-deep-semantic-audit-pluginbase-persistence*
*Completed: 2026-02-20*
