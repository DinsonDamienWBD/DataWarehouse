---
phase: 65.1-deep-semantic-audit-pluginbase-persistence
plan: 04
type: execute
wave: 3
depends_on: ["65.1-03"]
files_modified:
  - Metadata/deep-audit-analyzer.py
  - Metadata/deep-audit-report.json
autonomous: true

must_haves:
  truths:
    - "Audit script scans ALL .cs files in the solution"
    - "Detects: Task.CompletedTask stubs, yield break stubs, delegate passthrough, NotImplementedException, empty catch, hardcoded limits, ConcurrentDictionary, sync-over-async, thread safety issues, empty return values, suppressed compiler diagnostics"
    - "Generates structured JSON report with file, line, category, severity, code snippet"
    - "Report categorizes findings by severity: critical, high, medium, low"
  artifacts:
    - path: "Metadata/deep-audit-analyzer.py"
      provides: "Python script for deep semantic code audit"
    - path: "Metadata/deep-audit-report.json"
      provides: "Structured audit findings"
  key_links:
    - from: "deep-audit-analyzer.py"
      to: "all .cs files"
      via: "recursive file scanning"
      pattern: "glob.*\\.cs"
---

<objective>
Create and run a comprehensive deep audit script that finds ALL silent stubs, anti-patterns, and production-readiness issues across the entire codebase.

Purpose: Part B of the phase — automated discovery of every issue that grep-based searches miss. The audit findings drive Wave 4 fix plans.
Output: Python audit script + JSON report with every finding categorized and located
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/65.1-deep-semantic-audit-pluginbase-persistence/65.1-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deep semantic audit analyzer</name>
  <files>Metadata/deep-audit-analyzer.py</files>
  <action>
Create a Python script that scans all .cs files and detects the following categories:

**Category 1: Silent Stubs (severity: critical)**
- `Task.CompletedTask` returns in methods that have meaningful names (not default lifecycle methods like OnMessageAsync, ActivateAsync, ExecuteAsync in PluginBase itself). Detect: method body is ONLY `=> Task.CompletedTask;` or `return Task.CompletedTask;` AND method name suggests it should do work (Publish, Subscribe, Execute, Process, Handle, Send, Write, Save, Apply).
- `yield break` in IAsyncEnumerable methods that should produce items (method name contains: Get, List, Enumerate, Subscribe, Stream, Query, Find, Search).
- Methods returning `default(T)`, `null`, empty array/list/dictionary as the ONLY action (not as a fallback).

**Category 2: No-Op Patterns (severity: high)**
- Delegate passthrough: method receives a strategy/policy/handler parameter but never uses it — calls the inner function directly. Detect: parameter named `strategy`, `policy`, `handler`, `processor`, `filter` that never appears in the method body after the parameter declaration.
- `NotSupportedException` / `NotImplementedException` thrown in non-abstract, non-interface methods.
- Empty catch blocks: `catch` with empty body or only a comment.

**Category 3: Unbounded Collections (severity: high)**
- `ConcurrentDictionary<` usage anywhere in Plugins/ or DataWarehouse.SDK/ (should be BoundedDictionary after migration)
- `new Dictionary<` or `new List<` assigned to class fields without bounds

**Category 4: Sync-over-Async (severity: high)**
- `.GetAwaiter().GetResult()` anywhere
- `.Result` property access on Task (but NOT `Task.FromResult`, `TaskCompletionSource`, or property declarations named `Result`)
- `.Wait()` on Task objects

**Category 5: Obsolete Code (severity: medium)**
- `[Obsolete` attribute on any member
- Files containing `#pragma warning disable CS0618` (obsolete warning suppression)

**Category 6: Hardcoded Limits (severity: low)**
- Magic numbers in collection capacity: `new Dictionary<.*>(1000)`, array allocations with literals > 100
- Hardcoded timeouts: `TimeSpan.FromSeconds(30)`, `TimeSpan.FromMinutes(5)` etc. that aren't in configuration classes

**Category 7: Suppressed Build Diagnostics (severity: high)**
This is a critical step. The project's `Directory.Build.props` line 41 has `<NoWarn>` suppressing 12 diagnostic codes:
CS0618 (obsolete usage), CS0649 (field never assigned), CS0219 (variable assigned not used), CS0414 (field assigned not used), CS0169 (field never used), CS0162 (unreachable code), CS0067 (event never used), CS0168 (variable declared not used), CA1416/CA1418 (platform compat), CA2024 (async cancellation), NU1608 (package version).

To extract these hidden diagnostics:
1. Temporarily remove the suppressed codes from `<NoWarn>` in `Directory.Build.props` (line 41) — change to `<NoWarn>$(NoWarn)</NoWarn>`
2. Also temporarily change `<TreatWarningsAsErrors>false</TreatWarningsAsErrors>` so warnings don't abort
3. Run `dotnet build DataWarehouse.slnx --no-incremental -v diag 2>&1` capturing ALL output
4. Also run `dotnet build DataWarehouse.slnx -bl` to generate `msbuild.binlog` for deep analysis
5. Parse every warning/info/message line: extract file, line, code, message
6. Restore the original `Directory.Build.props`
7. Add each diagnostic to the audit report under Category 7 with the specific CS/CA code

**Known findings from pre-audit build (45 unique in SDK alone):**
- CS0618 ×16: VectorClock obsolete → replace with DottedVersionVector (ReplicationStrategy.cs, CrdtReplicationSync.cs, IMultiMasterReplication.cs)
- CS0067 ×12: Unused events → wire up or remove (BleMesh, LoRaMesh, ZigbeeMesh, InMemory*, LinuxHardwareProbe)
- CA1416 ×8: Platform compat → add [SupportedOSPlatform] guards (HostedOptimizer, HypervisorDetector, FilesystemDetector)
- CS0169 ×5: Dead fields → delete (VulkanAccelerator ×3, WebGpuAccelerator, LoadBalancingManager, ConsciousnessStrategyBase)
- CS0649 ×2: Unassigned fields → initialize or delete (LowLatencyStoragePluginBase, LinuxMtdFlashDevice)
- CS0168 ×1: Unused catch var → use `catch (Exception)` or log (StorageStrategy.cs:721)

Key signals: CS0649/CS0169 = dead fields (remove them), CS0219/CS0414/CS0168 = dead variables (remove them), CS0162 = unreachable code (remove it), CS0067 = dead events (wire up or remove), CS0618 = calling obsolete members (update or remove), CA1416 = platform-specific code needs guards, CA2024 = missing CancellationToken (add it)

This category often reveals MORE issues than regex scanning because the compiler does full semantic analysis that regex cannot.

**Implementation:**
- Use Python regex-based scanning (no Roslyn dependency needed — patterns are clear enough for regex)
- Scan ALL .cs files under the repo root, excluding bin/, obj/, .planning/
- For each finding: record `file` (relative path), `line` (number), `category`, `severity`, `pattern` (which rule matched), `snippet` (the matching line + 2 lines context)
- Output: Write `Metadata/deep-audit-report.json` as a JSON array of findings
- Also print summary to stdout: count by category and severity
- EXCLUDE known-safe patterns: PluginBase.cs lifecycle methods (ActivateAsync, ExecuteAsync, CheckHealthAsync, OnMessageAsync), test files, benchmark files

The script must be robust — handle encoding errors gracefully (use `errors='replace'`), large files, and binary files mixed in.
  </action>
  <verify>Run `python Metadata/deep-audit-analyzer.py` and confirm it completes without errors. Check `Metadata/deep-audit-report.json` exists and contains findings. Verify known issues appear: UltimateStreamingData PublishAsync, UltimateResilience ExecuteWithResilienceAsync, ChaosVaccination .GetAwaiter().GetResult().</verify>
  <done>Audit script runs against full codebase, produces structured JSON report with all findings categorized. Known issues (UltimateStreamingData stubs, UltimateResilience no-op, sync-over-async in ChaosVaccination) appear in report.</done>
</task>

</tasks>

<verification>
- `python Metadata/deep-audit-analyzer.py` exits 0
- `Metadata/deep-audit-report.json` is valid JSON
- Report contains findings in categories 1-7
- Category 7 (suppressed diagnostics) contains compiler-found issues from temporarily removing NoWarn
- Known issues are detected (spot-check 3+ known findings)
</verification>

<success_criteria>
Comprehensive audit report exists with categorized findings covering all .cs files. All known issues from phase scope are detected. Report structure supports automated processing by Wave 4 fix plans.
</success_criteria>

<output>
After completion, create `.planning/phases/65.1-deep-semantic-audit-pluginbase-persistence/65.1-04-SUMMARY.md`
</output>
