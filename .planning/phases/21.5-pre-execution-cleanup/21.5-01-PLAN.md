---
phase: 21.5-pre-execution-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.SDK/Hosting/OperatingMode.cs
  - DataWarehouse.SDK/Hosting/ConnectionType.cs
  - DataWarehouse.SDK/Hosting/ConnectionTarget.cs
  - DataWarehouse.SDK/Hosting/InstallConfiguration.cs
  - DataWarehouse.SDK/Hosting/EmbeddedConfiguration.cs
  - DataWarehouse.Launcher/Integration/DataWarehouseHost.cs
  - DataWarehouse.Launcher/Integration/InstanceConnection.cs
  - DataWarehouse.Launcher/Integration/OperatingMode.cs
  - DataWarehouse.Shared/InstanceManager.cs
  - DataWarehouse.Shared/MessageBridge.cs
  - Metadata/Adapter/OperatingMode.cs
  - Metadata/Adapter/DataWarehouseHost.cs
  - Metadata/Adapter/InstanceConnection.cs
  - DataWarehouse.CLI/Integration/OperatingMode.cs
  - DataWarehouse.CLI/Integration/IKernelAdapter.cs
  - DataWarehouse.CLI/Integration/AdapterFactory.cs
  - DataWarehouse.CLI/Integration/AdapterRunner.cs
autonomous: true

must_haves:
  truths:
    - "OperatingMode (Install/Connect/Embedded/Service), ConnectionType (Local/Remote/InProcess/Cluster), ConnectionTarget, InstallConfiguration, EmbeddedConfiguration each exist exactly ONCE in the codebase, in DataWarehouse.SDK/Hosting/"
    - "All consumers (Launcher, Shared, CLI, GUI, Metadata/Adapter) use DataWarehouse.SDK.Hosting types -- no local type definitions remain"
    - "Shared's InstanceManager uses SDK ConnectionTarget with Host property instead of Address, and SDK ConnectionType with InProcess value"
    - "Shared's MessageBridge switch statements use SDK ConnectionType enum values correctly"
    - "CLI/Integration/ dead code files (4 files) are deleted"
    - "Launcher/Integration/OperatingMode.cs is deleted (types moved to SDK)"
    - "Full solution builds with zero errors after all changes"
  artifacts:
    - path: "DataWarehouse.SDK/Hosting/OperatingMode.cs"
      provides: "Canonical hosting operating mode enum"
      exports: ["OperatingMode"]
    - path: "DataWarehouse.SDK/Hosting/ConnectionType.cs"
      provides: "Canonical connection type enum (superset: Local, Remote, InProcess, Cluster)"
      exports: ["ConnectionType"]
    - path: "DataWarehouse.SDK/Hosting/ConnectionTarget.cs"
      provides: "Canonical connection target class (superset of Launcher + Shared properties)"
      exports: ["ConnectionTarget"]
    - path: "DataWarehouse.SDK/Hosting/InstallConfiguration.cs"
      provides: "Install mode configuration"
      exports: ["InstallConfiguration"]
    - path: "DataWarehouse.SDK/Hosting/EmbeddedConfiguration.cs"
      provides: "Embedded mode configuration"
      exports: ["EmbeddedConfiguration"]
  key_links:
    - from: "DataWarehouse.Shared.InstanceManager"
      to: "DataWarehouse.SDK.Hosting.ConnectionTarget"
      via: "using directive and ConnectionTarget instantiation in ConnectRemoteAsync/ConnectLocalAsync/ConnectInProcessAsync"
      pattern: "using DataWarehouse\\.SDK\\.Hosting"
    - from: "DataWarehouse.Shared.MessageBridge"
      to: "DataWarehouse.SDK.Hosting.ConnectionType"
      via: "switch statements on ConnectionType enum"
      pattern: "ConnectionType\\.Local|ConnectionType\\.Remote|ConnectionType\\.InProcess"
    - from: "DataWarehouse.Launcher.Integration.DataWarehouseHost"
      to: "DataWarehouse.SDK.Hosting"
      via: "using directive for OperatingMode, ConnectionTarget, InstallConfiguration, EmbeddedConfiguration"
      pattern: "using DataWarehouse\\.SDK\\.Hosting"
---

<objective>
Consolidate all duplicate hosting type definitions (OperatingMode, ConnectionType, ConnectionTarget, InstallConfiguration, EmbeddedConfiguration) into a single canonical location at DataWarehouse.SDK/Hosting/. Update all consumers to use SDK types. Delete dead code.

Purpose: Eliminate 3-4 copies of each type scattered across Launcher, CLI, Shared, and Metadata/Adapter. This is the foundation for all v2.0 work -- clean types must exist before refactoring plugin hierarchies.
Output: 5 new SDK files in DataWarehouse.SDK/Hosting/, all consumers updated, 5 dead code files deleted.

NOTE on SC-3 ("CLI Commands import SDK types"): CLI Commands/ folder is dead code -- excluded from compilation by `<Compile Remove="Commands\**" />` in CLI.csproj. These files are never compiled and do not need updating. SC-3 is satisfied because the Commands cannot import anything; PRECLEAN-04 dead code deletion satisfies the intent.

NOTE on Launcher/Program.cs and Launcher/Adapters/DataWarehouseAdapter.cs: These files are listed in the ROADMAP impact map but do NOT need changes. Program.cs uses AdapterFactory/ServiceHost/ServiceOptions which remain in Launcher.Integration namespace. DataWarehouseAdapter.cs uses SDK.Primitives.OperatingMode (kernel scaling mode), not the hosting OperatingMode being moved. Neither file references the 5 moved types.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21.5-pre-execution-cleanup/21.5-RESEARCH.md

# Current type definitions (read these to understand exact current state)
@DataWarehouse.Launcher/Integration/OperatingMode.cs
@DataWarehouse.Shared/InstanceManager.cs
@DataWarehouse.Shared/MessageBridge.cs
@Metadata/Adapter/OperatingMode.cs

# Launcher consumers that need import updates
@DataWarehouse.Launcher/Integration/DataWarehouseHost.cs
@DataWarehouse.Launcher/Integration/InstanceConnection.cs

# Metadata/Adapter consumers
@Metadata/Adapter/DataWarehouseHost.cs
@Metadata/Adapter/InstanceConnection.cs

# GUI consumer (uses InstanceManager, not direct types)
@DataWarehouse.GUI/Components/Pages/Connections.razor

# SDK pattern reference
@DataWarehouse.SDK/Primitives/Enums.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SDK/Hosting/ types as canonical single source of truth</name>
  <files>
    DataWarehouse.SDK/Hosting/OperatingMode.cs
    DataWarehouse.SDK/Hosting/ConnectionType.cs
    DataWarehouse.SDK/Hosting/ConnectionTarget.cs
    DataWarehouse.SDK/Hosting/InstallConfiguration.cs
    DataWarehouse.SDK/Hosting/EmbeddedConfiguration.cs
  </files>
  <action>
  Create new directory `DataWarehouse.SDK/Hosting/` with 5 files. Namespace: `DataWarehouse.SDK.Hosting` for all.

  IMPORTANT: `DataWarehouse.SDK.Primitives.OperatingMode` already exists with values Laptop/Workstation/Server/Hyperscale (kernel scaling). The new `DataWarehouse.SDK.Hosting.OperatingMode` is a DIFFERENT concept (host application modes). Both must coexist. They are in different namespaces so no collision, but add XML doc comments making the distinction clear.

  **File 1: OperatingMode.cs**
  ```csharp
  namespace DataWarehouse.SDK.Hosting;

  /// <summary>
  /// Operating modes for DataWarehouse host applications.
  /// This controls how the host application behaves (install, connect, embed, or run as service).
  /// NOT to be confused with <see cref="DataWarehouse.SDK.Primitives.OperatingMode"/> which controls kernel resource scaling.
  /// </summary>
  public enum OperatingMode
  {
      /// <summary>Install and initialize a new DataWarehouse instance.</summary>
      Install,
      /// <summary>Connect to an existing DataWarehouse instance (local or remote).</summary>
      Connect,
      /// <summary>Run a tiny embedded DataWarehouse instance for local/single-user scenarios.</summary>
      Embedded,
      /// <summary>Run as a Windows service or Linux daemon.</summary>
      Service
  }
  ```

  **File 2: ConnectionType.cs**
  Superset of ALL variants found in codebase:
  ```csharp
  namespace DataWarehouse.SDK.Hosting;

  public enum ConnectionType
  {
      /// <summary>Connect to a local instance via IPC.</summary>
      Local,
      /// <summary>Connect to a remote instance via network.</summary>
      Remote,
      /// <summary>Connect to an in-process instance (direct kernel invocation).</summary>
      InProcess,
      /// <summary>Connect to a cluster of instances.</summary>
      Cluster
  }
  ```
  CRITICAL: Must include BOTH InProcess (from Shared) AND Cluster (from Launcher). This is the superset.

  **File 3: ConnectionTarget.cs**
  Superset of Launcher properties + Shared's Name and Metadata:
  ```csharp
  namespace DataWarehouse.SDK.Hosting;

  public sealed class ConnectionTarget
  {
      public ConnectionType Type { get; set; } = ConnectionType.Local;
      public string Host { get; set; } = "localhost";
      public int Port { get; set; } = 8080;
      public string? LocalPath { get; set; }
      public string? AuthToken { get; set; }
      public bool UseTls { get; set; } = true;
      public int TimeoutSeconds { get; set; } = 30;
      // From Shared's version -- display name and extensible metadata
      public string Name { get; set; } = string.Empty;
      public Dictionary<string, string> Metadata { get; set; } = new();

      public static ConnectionTarget Local(string path) => new()
      {
          Type = ConnectionType.Local,
          LocalPath = path
      };

      public static ConnectionTarget Remote(string host, int port = 8080, bool useTls = true) => new()
      {
          Type = ConnectionType.Remote,
          Host = host,
          Port = port,
          UseTls = useTls
      };
  }
  ```
  Full XML docs on every property and method. Copy the doc comments from Launcher's version for Host, Port, LocalPath, AuthToken, UseTls, TimeoutSeconds. Add docs for Name ("Display name for this connection") and Metadata ("Extensible metadata dictionary for custom connection properties").

  **File 4: InstallConfiguration.cs**
  Copy from Launcher's version exactly (all three copies are identical). Namespace: `DataWarehouse.SDK.Hosting`. Keep sealed class, all 9 properties: InstallPath, DataPath, IncludedPlugins, CreateService, AutoStart, InitialConfig, CreateDefaultAdmin, AdminUsername, AdminPassword. Full XML docs.

  **File 5: EmbeddedConfiguration.cs**
  Copy from Launcher's version exactly (all three copies are identical). Namespace: `DataWarehouse.SDK.Hosting`. Keep sealed class, all 6 properties: PersistData, DataPath, MaxMemoryMb, ExposeHttp, HttpPort, Plugins. Full XML docs.
  </action>
  <verify>
  Build SDK: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj`
  Expect: 0 errors. Verify files exist: `ls DataWarehouse.SDK/Hosting/`
  </verify>
  <done>
  5 files exist in DataWarehouse.SDK/Hosting/ with namespace DataWarehouse.SDK.Hosting. SDK builds cleanly. ConnectionType has all 4 values (Local, Remote, InProcess, Cluster). ConnectionTarget has superset properties (Host, Port, LocalPath, AuthToken, UseTls, TimeoutSeconds, Name, Metadata) plus factory methods.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update all consumers to use SDK Hosting types and delete dead code</name>
  <files>
    DataWarehouse.Launcher/Integration/DataWarehouseHost.cs
    DataWarehouse.Launcher/Integration/InstanceConnection.cs
    DataWarehouse.Launcher/Integration/OperatingMode.cs
    DataWarehouse.Shared/InstanceManager.cs
    DataWarehouse.Shared/MessageBridge.cs
    Metadata/Adapter/OperatingMode.cs
    Metadata/Adapter/DataWarehouseHost.cs
    Metadata/Adapter/InstanceConnection.cs
    DataWarehouse.CLI/Integration/OperatingMode.cs
    DataWarehouse.CLI/Integration/IKernelAdapter.cs
    DataWarehouse.CLI/Integration/AdapterFactory.cs
    DataWarehouse.CLI/Integration/AdapterRunner.cs
  </files>
  <action>
  This task updates all consumers in 4 groups, then deletes dead code.

  **Group A: Launcher (update imports)**

  1. `DataWarehouse.Launcher/Integration/DataWarehouseHost.cs`:
     - Add `using DataWarehouse.SDK.Hosting;`
     - The file currently uses `OperatingMode`, `ConnectionTarget`, `ConnectionType`, `InstallConfiguration`, `EmbeddedConfiguration` from `DataWarehouse.Launcher.Integration` namespace (same file/namespace as OperatingMode.cs).
     - After adding the SDK using directive and deleting OperatingMode.cs, these types will resolve to SDK.Hosting.
     - WARNING: DataWarehouseHost.cs also references `AdapterRunner` which stays in `DataWarehouse.Launcher.Integration`. If there are any ambiguities, use fully qualified names.
     - If DataWarehouseAdapter.cs uses `SDK.Primitives.OperatingMode` (the Laptop/Workstation/Server enum), ensure it has an explicit `using DataWarehouse.SDK.Primitives;` and does NOT import `DataWarehouse.SDK.Hosting` (or uses full qualification like `SDK.Primitives.OperatingMode` where needed).

  2. `DataWarehouse.Launcher/Integration/InstanceConnection.cs`:
     - Add `using DataWarehouse.SDK.Hosting;`
     - Uses `ConnectionTarget` and `ConnectionType` in the `IInstanceConnection` interface and implementations.
     - The `InstanceCapabilities` class defined in this file is Launcher-specific (NOT the same as Shared.Models.InstanceCapabilities). Leave it where it is.

  3. DELETE `DataWarehouse.Launcher/Integration/OperatingMode.cs`:
     - This file defines OperatingMode, ConnectionTarget, ConnectionType, InstallConfiguration, EmbeddedConfiguration in namespace `DataWarehouse.Launcher.Integration`.
     - All these types now live in SDK. Delete the entire file.

  **Group B: Shared (major changes -- replace inline types)**

  4. `DataWarehouse.Shared/InstanceManager.cs`:
     - Add `using DataWarehouse.SDK.Hosting;`
     - REMOVE the inline `ConnectionTarget` class definition (lines 9-16 in current file: `public class ConnectionTarget { Name, Type, Address, Port, Metadata }`)
     - REMOVE the inline `ConnectionType` enum definition (lines 21-26: `Local, Remote, InProcess`)
     - KEEP the `ConnectionProfile` class (lines 31-39) -- it is unique to Shared and not duplicated. Update its `Target` property type -- it already uses `ConnectionTarget` so it will auto-resolve to SDK's version.
     - Update `ConnectRemoteAsync`: change `Address = host` to `Host = host`
     - Update `ConnectLocalAsync`: change `Address = path` to `Host = path`
     - Update `ConnectInProcessAsync`: change `Address = "localhost"` to `Host = "localhost"`
     - Shared's ConnectionTarget had `Name` and `Metadata` -- the SDK version includes both, so these usages remain unchanged.
     - Shared's ConnectionType had `InProcess` -- the SDK version includes it, so the InProcess usage in ConnectInProcessAsync remains unchanged.

  5. `DataWarehouse.Shared/MessageBridge.cs`:
     - Add `using DataWarehouse.SDK.Hosting;`
     - REMOVE any `using DataWarehouse.Shared;` that resolved the old ConnectionType/ConnectionTarget (the file is in namespace DataWarehouse.Shared so the old types were found by namespace).
     - The switch statement in `ConnectAsync` uses `ConnectionType.Local`, `ConnectionType.Remote`, `ConnectionType.InProcess` -- all exist in SDK enum. No value changes needed.
     - The switch statements in `SendAsync` and `SendOneWayAsync` also use these values -- no changes needed.
     - Update `ConnectTcpAsync` call: currently passes `target.Address` -- change to `target.Host`.
     - Update `GetConnectionStats`: currently accesses `_currentTarget.Address` and `_currentTarget.Name` -- `Name` stays the same, change `Address` to `Host`. Update the key string from `"address"` to `"host"` as well.

  **Group C: Metadata/Adapter (update namespace)**

  6. `Metadata/Adapter/OperatingMode.cs`:
     - Currently defines OperatingMode, ConnectionTarget, ConnectionType, InstallConfiguration, EmbeddedConfiguration in namespace `DataWarehouse.Integration`.
     - DELETE all type definitions from this file. Add `using DataWarehouse.SDK.Hosting;` at the top. Keep the `namespace DataWarehouse.Integration;` declaration so the file remains a valid compilation unit.
     - The CLI links these Metadata/Adapter files via `<Compile Include>`, but the CLI Commands that used these types are dead code (`<Compile Remove="Commands\**" />`). The remaining compiled CLI code does not reference these types, so the empty namespace is safe.
     - DataWarehouseHost.cs and InstanceConnection.cs (same Metadata/Adapter directory) will resolve the type names via their own `using DataWarehouse.SDK.Hosting;` directives (added below).

  7. `Metadata/Adapter/DataWarehouseHost.cs`:
     - Currently in namespace `DataWarehouse.Integration`. Uses OperatingMode, ConnectionTarget, etc.
     - Add `using DataWarehouse.SDK.Hosting;` at the top.
     - Since the type definitions are being removed from OperatingMode.cs (same namespace), the SDK using will resolve them.

  8. `Metadata/Adapter/InstanceConnection.cs`:
     - Currently in namespace `DataWarehouse.Integration`. Uses ConnectionTarget, ConnectionType.
     - Add `using DataWarehouse.SDK.Hosting;` at the top.

  **Group D: Delete dead CLI code**

  9. DELETE these 4 files (all dead code per RESEARCH.md -- zero imports from any compiled code):
     - `DataWarehouse.CLI/Integration/OperatingMode.cs`
     - `DataWarehouse.CLI/Integration/IKernelAdapter.cs`
     - `DataWarehouse.CLI/Integration/AdapterFactory.cs`
     - `DataWarehouse.CLI/Integration/AdapterRunner.cs`

  **Group E: GUI -- No changes needed**

  `DataWarehouse.GUI/Components/Pages/Connections.razor` defines its own local `ConnectionProfile` class in the @code block (with string Name, Type, Host). It uses `InstanceManager.ConnectRemoteAsync(host, port)` and `InstanceManager.ConnectLocalAsync(path)` which are methods on Shared's InstanceManager. The GUI never directly imports any Integration types. No changes needed.

  **ZERO REGRESSION CHECK:**
  - InstanceManager.ConnectAsync still accepts ConnectionTarget and passes it to MessageBridge.ConnectAsync
  - MessageBridge.ConnectAsync still switches on ConnectionType.Local/Remote/InProcess
  - ConnectionProfile still wraps a ConnectionTarget
  - All Launcher Integration types that stay (IKernelAdapter, AdapterFactory, AdapterRunner, EmbeddedAdapter, ServiceHost, DataWarehouseHost, InstanceConnection) remain in DataWarehouse.Launcher.Integration namespace
  - Only the 5 shared type definitions move to SDK
  </action>
  <verify>
  Build full solution: `dotnet build DataWarehouse.slnx`
  Expect: 0 errors.
  Verify deleted files:
  - `ls DataWarehouse.CLI/Integration/` should be empty or not exist
  - `ls DataWarehouse.Launcher/Integration/OperatingMode.cs` should not exist
  Verify no remaining local type definitions:
  - `grep -rn "public enum ConnectionType" --include="*.cs"` should return ONLY DataWarehouse.SDK/Hosting/ConnectionType.cs
  - `grep -rn "public class ConnectionTarget" --include="*.cs" | grep -v SDK` should return 0 matches (only SDK version should exist as a class; the Connections.razor local class uses a different name: ConnectionProfile)
  </verify>
  <done>
  All consumers use DataWarehouse.SDK.Hosting types. Shared's InstanceManager uses Host instead of Address. MessageBridge uses Host instead of Address. Launcher's OperatingMode.cs is deleted. CLI's Integration/ dead code (4 files) is deleted. Metadata/Adapter files reference SDK types. Full solution builds with zero errors. Zero regression -- all existing functionality preserved.
  </done>
</task>

</tasks>

<verification>
- [ ] SDK builds: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` passes with 0 errors
- [ ] Full solution builds: `dotnet build DataWarehouse.slnx` passes with 0 errors
- [ ] 5 SDK Hosting files exist: OperatingMode.cs, ConnectionType.cs, ConnectionTarget.cs, InstallConfiguration.cs, EmbeddedConfiguration.cs
- [ ] ConnectionType enum has 4 values: Local, Remote, InProcess, Cluster
- [ ] ConnectionTarget has superset properties: Type, Host, Port, LocalPath, AuthToken, UseTls, TimeoutSeconds, Name, Metadata
- [ ] No duplicate type definitions remain outside SDK/Hosting/ (grep confirms)
- [ ] CLI/Integration/ dead code deleted (4 files)
- [ ] Launcher/Integration/OperatingMode.cs deleted (types moved to SDK)
- [ ] Shared's InstanceManager uses Host not Address
- [ ] Shared's MessageBridge uses Host not Address
- [ ] Metadata/Adapter files reference SDK types
- [ ] All XML documentation preserved on public members
</verification>

<success_criteria>
Plan 21.5-01 succeeds when:
1. ConnectionType, ConnectionTarget, OperatingMode, InstallConfiguration, EmbeddedConfiguration exist exactly once in SDK/Hosting/
2. All consumers (Launcher, Shared, Metadata/Adapter) compile against SDK types
3. CLI/Integration dead code (4 files) and Launcher/Integration/OperatingMode.cs are deleted
4. Shared's code adapted (Address -> Host) without losing any functionality
5. Full solution builds with zero errors
6. SDK.Primitives.OperatingMode (Laptop/Workstation/Server/Hyperscale) remains untouched
</success_criteria>

<output>
After completion, create `.planning/phases/21.5-pre-execution-cleanup/21.5-01-SUMMARY.md`
</output>
