---
phase: 21.5-pre-execution-cleanup
plan: 02
type: execute
wave: 2
depends_on: ["21.5-01"]
files_modified:
  - DataWarehouse.Shared/InstanceManager.cs
  - DataWarehouse.Shared/MessageBridge.cs
  - DataWarehouse.Shared/CapabilityManager.cs
  - DataWarehouse.Shared/Services/ComplianceReportService.cs
  - DataWarehouse.Shared/Services/DeveloperToolsService.cs
  - DataWarehouse.Shared/DataWarehouse.Shared.csproj
  - Plugins/DataWarehouse.Plugins.UniversalDashboards/DashboardStrategyBase.cs
  - Plugins/DataWarehouse.Plugins.UniversalDashboards/Strategies/Export/ExportStrategies.cs
  - Plugins/DataWarehouse.Plugins.UniversalDashboards/DataWarehouse.Plugins.UniversalDashboards.csproj
autonomous: true

must_haves:
  truths:
    - "Zero Newtonsoft.Json calls remain in DataWarehouse.Shared (all 56 calls across 5 files migrated to System.Text.Json)"
    - "Zero Newtonsoft.Json calls remain in UniversalDashboards plugin (all 3 calls migrated)"
    - "Newtonsoft.Json PackageReference removed from DataWarehouse.Shared.csproj"
    - "Newtonsoft.Json PackageReference removed from DataWarehouse.Plugins.UniversalDashboards.csproj"
    - "All serialization/deserialization behavior preserved -- round-trip patterns produce identical results"
    - "Full solution builds with zero errors after migration"
  artifacts:
    - path: "DataWarehouse.Shared/DataWarehouse.Shared.csproj"
      provides: "Shared project file with Newtonsoft.Json dependency removed"
    - path: "Plugins/DataWarehouse.Plugins.UniversalDashboards/DataWarehouse.Plugins.UniversalDashboards.csproj"
      provides: "UniversalDashboards project file with Newtonsoft.Json dependency removed"
  key_links:
    - from: "DataWarehouse.Shared.InstanceManager.SaveProfile"
      to: "System.Text.Json.JsonSerializer.Serialize"
      via: "JSON serialization of ConnectionProfile objects"
      pattern: "JsonSerializer\\.Serialize"
    - from: "DataWarehouse.Shared.Services.ComplianceReportService"
      to: "System.Text.Json.JsonSerializer"
      via: "round-trip serialization of compliance report DTOs from Dictionary<string, object>"
      pattern: "JsonSerializer\\.(Serialize|Deserialize)"
    - from: "DataWarehouse.Shared.MessageBridge.SendTcpAsync"
      to: "System.Text.Json.JsonSerializer"
      via: "message serialization for TCP transport"
      pattern: "JsonSerializer\\.(Serialize|Deserialize)"
---

<objective>
Migrate all Newtonsoft.Json usage in DataWarehouse.Shared (56 calls across 5 files) and UniversalDashboards plugin (3 calls across 2 files) to System.Text.Json. Remove Newtonsoft.Json PackageReference from both projects.

Purpose: Reduce dependency surface per SUPPLY-04 (<=6 direct PackageReferences). System.Text.Json is built into .NET 10, is AOT-friendly, and eliminates an external dependency.
Output: Zero Newtonsoft.Json references in Shared and UniversalDashboards. Two fewer NuGet packages.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21.5-pre-execution-cleanup/21.5-RESEARCH.md

# Files to migrate (read all for current Newtonsoft usage patterns)
@DataWarehouse.Shared/InstanceManager.cs
@DataWarehouse.Shared/MessageBridge.cs
@DataWarehouse.Shared/CapabilityManager.cs
@DataWarehouse.Shared/Services/ComplianceReportService.cs
@DataWarehouse.Shared/Services/DeveloperToolsService.cs
@DataWarehouse.Shared/DataWarehouse.Shared.csproj

# UniversalDashboards files
@Plugins/DataWarehouse.Plugins.UniversalDashboards/DashboardStrategyBase.cs
@Plugins/DataWarehouse.Plugins.UniversalDashboards/Strategies/Export/ExportStrategies.cs
@Plugins/DataWarehouse.Plugins.UniversalDashboards/DataWarehouse.Plugins.UniversalDashboards.csproj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate DataWarehouse.Shared from Newtonsoft.Json to System.Text.Json</name>
  <files>
    DataWarehouse.Shared/InstanceManager.cs
    DataWarehouse.Shared/MessageBridge.cs
    DataWarehouse.Shared/CapabilityManager.cs
    DataWarehouse.Shared/Services/ComplianceReportService.cs
    DataWarehouse.Shared/Services/DeveloperToolsService.cs
    DataWarehouse.Shared/DataWarehouse.Shared.csproj
  </files>
  <action>
  System.Text.Json is built into .NET 10 -- no package reference needed. The migration is mechanical: replace Newtonsoft API calls with System.Text.Json equivalents.

  **Common options pattern:** Create a shared static `JsonSerializerOptions` instance for reuse across all files. Add a static helper class or use a static field at the top of each file:
  ```csharp
  private static readonly JsonSerializerOptions s_jsonOptions = new()
  {
      PropertyNameCaseInsensitive = true,
      WriteIndented = false
  };

  private static readonly JsonSerializerOptions s_indentedJsonOptions = new()
  {
      PropertyNameCaseInsensitive = true,
      WriteIndented = true
  };
  ```
  `PropertyNameCaseInsensitive = true` is needed because the round-trip pattern (serialize object from Dictionary<string,object>, then deserialize to typed DTO) may encounter camelCase property names from the Newtonsoft default.

  **CRITICAL PITFALL (from RESEARCH.md Pitfall 3):** The round-trip serialization pattern used throughout Shared is:
  ```csharp
  var json = JsonConvert.SerializeObject(response.Data["someKey"]);
  var result = JsonConvert.DeserializeObject<SomeType>(json);
  ```
  This works because `response.Data` is `Dictionary<string, object>`. With Newtonsoft, the `object` values are boxed CLR types. With System.Text.Json, if the dictionary was deserialized by System.Text.Json, the `object` values would be `JsonElement` instances. However, in this codebase, the dictionaries are constructed in-memory (not deserialized from JSON) in most cases. The `JsonSerializer.Serialize(objectValue)` call handles `JsonElement` objects correctly by writing their JSON representation, so the round-trip pattern works the same way:
  ```csharp
  var json = JsonSerializer.Serialize(response.Data["someKey"], s_jsonOptions);
  var result = JsonSerializer.Deserialize<SomeType>(json, s_jsonOptions);
  ```

  **File 1: InstanceManager.cs (4 calls)**
  - Replace `using Newtonsoft.Json;` with `using System.Text.Json;`
  - Add static `s_jsonOptions` and `s_indentedJsonOptions` fields
  - Line ~96-97 (ConnectAsync):
    `JsonConvert.SerializeObject(capabilitiesResponse.Data["capabilities"])` -> `JsonSerializer.Serialize(capabilitiesResponse.Data["capabilities"], s_jsonOptions)`
    `JsonConvert.DeserializeObject<InstanceCapabilities>(capabilitiesJson)` -> `JsonSerializer.Deserialize<InstanceCapabilities>(capabilitiesJson, s_jsonOptions)`
  - Line ~236 (SaveProfile):
    `JsonConvert.SerializeObject(profile, Formatting.Indented)` -> `JsonSerializer.Serialize(profile, s_indentedJsonOptions)`
  - Line ~260 (LoadProfiles):
    `JsonConvert.DeserializeObject<ConnectionProfile>(json)` -> `JsonSerializer.Deserialize<ConnectionProfile>(json, s_jsonOptions)`

  **File 2: MessageBridge.cs (2 calls)**
  - Replace `using Newtonsoft.Json;` with `using System.Text.Json;`
  - Add static `s_jsonOptions` field
  - Line ~146 (SendTcpAsync):
    `JsonConvert.SerializeObject(message)` -> `JsonSerializer.Serialize(message, s_jsonOptions)`
  - Line ~186 (SendTcpAsync):
    `JsonConvert.DeserializeObject<Message>(responseJson)` -> `JsonSerializer.Deserialize<Message>(responseJson, s_jsonOptions)`

  **File 3: CapabilityManager.cs (2 calls)**
  - Replace `using Newtonsoft.Json;` with `using System.Text.Json;`
  - Add static `s_jsonOptions` field
  - Line ~196-197 (RefreshCapabilitiesAsync):
    `JsonConvert.SerializeObject(capData)` -> `JsonSerializer.Serialize(capData, s_jsonOptions)`
    `JsonConvert.DeserializeObject<InstanceCapabilities>(capJson)` -> `JsonSerializer.Deserialize<InstanceCapabilities>(capJson, s_jsonOptions)`

  **File 4: ComplianceReportService.cs (30 calls)**
  - Replace `using Newtonsoft.Json;` with `using System.Text.Json;`
  - Add static `s_jsonOptions` field
  - ALL 30 calls follow the identical round-trip pattern:
    ```csharp
    var json = JsonConvert.SerializeObject(response.Data["key"]);
    var result = JsonConvert.DeserializeObject<SomeType>(json) ?? new SomeType();
    ```
    Replace each pair with:
    ```csharp
    var json = JsonSerializer.Serialize(response.Data["key"], s_jsonOptions);
    var result = JsonSerializer.Deserialize<SomeType>(json, s_jsonOptions) ?? new SomeType();
    ```
  - There are 15 serialize + 15 deserialize calls. Process methodically, method by method: GenerateGdprReportAsync, GetDataSubjectRequestsAsync, GetConsentRecordsAsync, GetDataBreachesAsync, GetPersonalDataInventoryAsync, GenerateHipaaReportAsync, GetPhiAccessLogsAsync, GetBaasAsync, GetEncryptionStatusAsync, GetRiskAssessmentsAsync, GenerateSoc2ReportAsync, GetTrustServiceCriteriaAsync, GetControlEvidenceAsync, GetAuditTrailAsync, GetAuditReadinessAsync.
  - Do NOT miss any call. Search for every `JsonConvert` in the file.

  **File 5: DeveloperToolsService.cs (18 calls)**
  - Replace `using Newtonsoft.Json;` with `using System.Text.Json;`
  - Add static `s_jsonOptions` and `s_indentedJsonOptions` fields
  - ALL 18 calls follow the same round-trip pattern as ComplianceReportService.
  - 9 serialize + 9 deserialize calls across: GetApiEndpointsAsync, ExecuteApiCallAsync, GenerateCodeSnippetAsync, GetSchemasAsync, GetSchemaAsync, CreateSchemaAsync, UpdateSchemaAsync, ExportSchemaAsync, ImportSchemaAsync, GetCollectionsAsync, GetFieldsAsync, ExecuteQueryAsync, GetQueryTemplatesAsync, SaveQueryTemplateAsync.
  - If any calls use `Formatting.Indented`, replace with `s_indentedJsonOptions`.
  - Do NOT miss any call. Search for every `JsonConvert` in the file.

  **File 6: DataWarehouse.Shared.csproj**
  - Remove the line: `<PackageReference Include="Newtonsoft.Json" Version="13.0.4" />`
  - Keep `<PackageReference Include="YamlDotNet" Version="16.3.0" />`

  **VERIFICATION PATTERN:** After making changes to each file, mentally verify:
  - Every `using Newtonsoft.Json;` is removed
  - Every `JsonConvert.SerializeObject` is replaced with `JsonSerializer.Serialize`
  - Every `JsonConvert.DeserializeObject<T>` is replaced with `JsonSerializer.Deserialize<T>`
  - Every `Formatting.Indented` is replaced with options using `WriteIndented = true`
  - No JObject, JToken, JArray usage exists (none was found in research)
  </action>
  <verify>
  Build Shared: `dotnet build DataWarehouse.Shared/DataWarehouse.Shared.csproj`
  Expect: 0 errors.
  Verify no remaining Newtonsoft references:
  - `grep -rn "Newtonsoft" DataWarehouse.Shared/ --include="*.cs" --include="*.csproj"` should return 0 matches
  - `grep -rn "JsonConvert" DataWarehouse.Shared/ --include="*.cs"` should return 0 matches
  </verify>
  <done>
  All 56 Newtonsoft.Json calls across 5 Shared files migrated to System.Text.Json. Newtonsoft.Json PackageReference removed from DataWarehouse.Shared.csproj. Shared project builds cleanly. Round-trip serialization patterns preserved with PropertyNameCaseInsensitive option.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate UniversalDashboards plugin from Newtonsoft.Json to System.Text.Json</name>
  <files>
    Plugins/DataWarehouse.Plugins.UniversalDashboards/DashboardStrategyBase.cs
    Plugins/DataWarehouse.Plugins.UniversalDashboards/Strategies/Export/ExportStrategies.cs
    Plugins/DataWarehouse.Plugins.UniversalDashboards/DataWarehouse.Plugins.UniversalDashboards.csproj
  </files>
  <action>
  NOTE: DashboardStrategyBase.cs already has `using System.Text.Json;` (line 7 in current file). It uses BOTH System.Text.Json and Newtonsoft.Json. After migration, only System.Text.Json remains.

  **File 1: DashboardStrategyBase.cs (2 Newtonsoft calls)**
  - Remove `using Newtonsoft.Json;` (line 8)
  - Keep `using System.Text.Json;` (line 7, already present)
  - Line 637: `JsonConvert.SerializeObject(obj, new JsonSerializerSettings { ... })` -- this is a helper method. Look at the JsonSerializerSettings being used:
    - If it uses `Formatting.Indented`, `NullValueHandling.Ignore`, etc., translate to equivalent System.Text.Json options:
      - `Formatting.Indented` -> `WriteIndented = true`
      - `NullValueHandling.Ignore` -> `DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull`
      - `ReferenceLoopHandling.Ignore` -> `ReferenceHandler = ReferenceHandler.IgnoreCycles`
    - Replace with `JsonSerializer.Serialize(obj, new JsonSerializerOptions { ... })`
    - Consider creating a static options field if the same options are reused
  - Line 649: `JsonConvert.DeserializeObject<T>(json)` -> `JsonSerializer.Deserialize<T>(json, s_jsonOptions)`
    - Add a static `s_jsonOptions` with `PropertyNameCaseInsensitive = true`

  **File 2: ExportStrategies.cs (1 Newtonsoft call)**
  - Remove `using Newtonsoft.Json;` (line 3)
  - Add `using System.Text.Json;` if not already present
  - Line 372: `JsonConvert.SerializeObject(ConvertToPlatformFormat(dashboard), Formatting.Indented)`
    -> `JsonSerializer.Serialize(ConvertToPlatformFormat(dashboard), new JsonSerializerOptions { WriteIndented = true })`
    - Or use a static options field for better performance

  **File 3: DataWarehouse.Plugins.UniversalDashboards.csproj**
  - Remove the line: `<PackageReference Include="Newtonsoft.Json" Version="13.0.4" />`
  - Keep all other PackageReferences (System.Net.Http.Json, System.Net.WebSockets.Client, QuestPDF, SkiaSharp)
  </action>
  <verify>
  Build plugin: `dotnet build Plugins/DataWarehouse.Plugins.UniversalDashboards/DataWarehouse.Plugins.UniversalDashboards.csproj`
  Expect: 0 errors.
  Verify no remaining Newtonsoft references:
  - `grep -rn "Newtonsoft" Plugins/DataWarehouse.Plugins.UniversalDashboards/ --include="*.cs" --include="*.csproj"` should return 0 matches
  - `grep -rn "JsonConvert" Plugins/DataWarehouse.Plugins.UniversalDashboards/ --include="*.cs"` should return 0 matches
  Build full solution: `dotnet build DataWarehouse.slnx`
  Expect: 0 errors.
  </verify>
  <done>
  All 3 Newtonsoft.Json calls in UniversalDashboards plugin migrated to System.Text.Json. Newtonsoft.Json PackageReference removed from plugin csproj. Plugin builds cleanly. Full solution builds cleanly. Zero Newtonsoft.Json references remain in either Shared or UniversalDashboards.
  </done>
</task>

</tasks>

<verification>
- [ ] Shared builds: `dotnet build DataWarehouse.Shared/DataWarehouse.Shared.csproj` passes with 0 errors
- [ ] UniversalDashboards builds: `dotnet build Plugins/DataWarehouse.Plugins.UniversalDashboards/DataWarehouse.Plugins.UniversalDashboards.csproj` passes with 0 errors
- [ ] Full solution builds: `dotnet build DataWarehouse.slnx` passes with 0 errors
- [ ] Zero `Newtonsoft` references in DataWarehouse.Shared/ (grep confirms)
- [ ] Zero `Newtonsoft` references in UniversalDashboards/ (grep confirms)
- [ ] Zero `JsonConvert` calls in DataWarehouse.Shared/ (grep confirms)
- [ ] Zero `JsonConvert` calls in UniversalDashboards/ (grep confirms)
- [ ] Newtonsoft.Json removed from Shared.csproj PackageReferences
- [ ] Newtonsoft.Json removed from UniversalDashboards.csproj PackageReferences
- [ ] All serialization uses System.Text.Json with PropertyNameCaseInsensitive = true for deserialization
- [ ] WriteIndented option used where Formatting.Indented was previously used
</verification>

<success_criteria>
Plan 21.5-02 succeeds when:
1. All 56 Newtonsoft.Json calls in Shared (across 5 files) migrated to System.Text.Json
2. All 3 Newtonsoft.Json calls in UniversalDashboards (across 2 files) migrated to System.Text.Json
3. Newtonsoft.Json PackageReference removed from both .csproj files
4. Full solution builds with zero errors
5. Round-trip serialization patterns preserve identical behavior (PropertyNameCaseInsensitive = true)
</success_criteria>

<output>
After completion, create `.planning/phases/21.5-pre-execution-cleanup/21.5-02-SUMMARY.md`
</output>
