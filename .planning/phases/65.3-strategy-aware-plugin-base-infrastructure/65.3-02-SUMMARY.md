---
phase: 65.3-strategy-aware-plugin-base-infrastructure
plan: "02"
subsystem: SDK Contracts / Strategy Infrastructure
tags: [strategy, registry, refactor, consciousness, encryption, connection]
dependency_graph:
  requires: ["65.3-01"]
  provides: ["unified-registry-delegation", "consciousness-strategy-hierarchy"]
  affects: ["Plugins/UltimateEncryption", "Plugins/UltimateConnector", "Plugins/UltimateDataGovernance", "Plugins/UltimateDataCatalog"]
tech_stack:
  added: []
  patterns: ["Delegation pattern (wrapper registry -> generic StrategyRegistry)", "new keyword for property visibility elevation"]
key_files:
  modified:
    - DataWarehouse.SDK/Contracts/Encryption/EncryptionStrategy.cs
    - DataWarehouse.SDK/Connectors/ConnectionStrategyRegistry.cs
    - DataWarehouse.SDK/Contracts/Consciousness/ConsciousnessStrategyBase.cs
    - Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Strategies/IntelligentGovernance/IngestPipelineConsciousnessStrategy.cs
decisions:
  - "ConsciousnessStrategyBase.IsInitialized exposed as public new to preserve public visibility over StrategyBase protected member"
  - "IngestPipelineConsciousnessStrategy.MessageBus uses new keyword + ConfigureIntelligence setter to shadow StrategyBase.MessageBus (protected) as public property"
  - "GetHealth() simplified: removed caching fields (StrategyBase provides GetCachedHealthAsync for async caching); consciousness-specific sync method returns direct status"
metrics:
  duration_minutes: 15
  completed_date: "2026-02-21T03:23:08Z"
  tasks_completed: 2
  files_modified: 4
---

# Phase 65.3 Plan 02: Retire Bespoke Registries + ConsciousnessStrategyBase Migration Summary

**One-liner:** Retired 3 bespoke strategy registries by delegating to `StrategyRegistry<T>` internally, and migrated `ConsciousnessStrategyBase` from standalone base class to `StrategyBase` subclass.

## What Was Built

### Task 1: EncryptionStrategyRegistry and ConnectionStrategyRegistry delegation

Both registries now hold a `private readonly StrategyRegistry<T> _inner` field and delegate all operations through it:

- `EncryptionStrategyRegistry`: replaced `BoundedDictionary<string, IEncryptionStrategy>` with `StrategyRegistry<IEncryptionStrategy> _inner = new(s => s.StrategyId)`. All 6 interface methods delegate to `_inner`. Domain-specific methods (`GetStrategiesBySecurityLevel`, `GetFipsCompliantStrategies`) use `_inner.GetByPredicate`. Added `System.Linq` using directive.
- `ConnectionStrategyRegistry`: replaced `BoundedDictionary<string, IConnectionStrategy>` with `StrategyRegistry<IConnectionStrategy> _inner = new(s => s.StrategyId)`. All 5 methods delegate to `_inner`. `GetByCategory` uses `_inner.GetByPredicate`. Added `using DataWarehouse.SDK.Contracts`.

All public APIs are unchanged — zero callers required modification.

### Task 2: ConsciousnessStrategyBase migrated to StrategyBase hierarchy

`ConsciousnessStrategyBase` changed from:
```
public abstract class ConsciousnessStrategyBase : IConsciousnessStrategy
```
to:
```
public abstract class ConsciousnessStrategyBase : StrategyBase, IConsciousnessStrategy
```

Removed duplicated infrastructure now inherited from `StrategyBase`:
- `_counters` BoundedDictionary — removed; `IncrementCounter`/`GetAllCounters` inherited
- `_initialized` bool — removed; inherited `_initialized` field used
- `_healthCacheExpiry`/`_cachedHealth` — removed; `GetHealth()` simplified to direct `_initialized` check
- `InitializeAsync`/`ShutdownAsync` override — removed; `StrategyBase` handles lifecycle

Added bridge members:
- `public override string Name => DisplayName` — satisfies `StrategyBase.Name` abstract requirement
- `public abstract override string StrategyId` — explicitly re-declared for clarity
- `public new bool IsInitialized` — elevates `protected` member to `public` for backward compat
- `public IReadOnlyDictionary<string, long> GetCounters()` — delegates to `GetAllCounters()`

`ConsciousnessStrategyRegistry` now delegates to `StrategyRegistry<IConsciousnessStrategy>` internally.

### Auto-fix (Rule 1): IngestPipelineConsciousnessStrategy.MessageBus

`IngestPipelineConsciousnessStrategy` had `public IMessageBus? MessageBus { get; set; }` which now hides `StrategyBase.MessageBus` (protected). Fixed by:
```csharp
public new IMessageBus? MessageBus
{
    get => base.MessageBus;
    set => base.ConfigureIntelligence(value);
}
```
This preserves public injection semantics while routing through `StrategyBase.ConfigureIntelligence`.

## Verification

- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore` — 0 errors, 0 warnings
- `dotnet build Plugins/DataWarehouse.Plugins.UltimateEncryption/... --no-restore` — 0 errors, 0 warnings
- `dotnet build Plugins/DataWarehouse.Plugins.UltimateDataGovernance/... --no-restore` — 0 errors, 0 warnings
- `dotnet build Plugins/DataWarehouse.Plugins.UltimateDataCatalog/... --no-restore` — 0 errors, 0 warnings
- `dotnet build DataWarehouse.slnx --no-restore -m:1` — Build succeeded, 0 errors, 0 warnings

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] IngestPipelineConsciousnessStrategy.MessageBus hides inherited StrategyBase.MessageBus**
- **Found during:** Task 2 full solution build
- **Issue:** Plugin had `public IMessageBus? MessageBus { get; set; }` which now shadows `StrategyBase.MessageBus` (protected) when `ConsciousnessStrategyBase` extends `StrategyBase`
- **Fix:** Added `new` keyword, getter routes to `base.MessageBus`, setter calls `base.ConfigureIntelligence(value)` to maintain StrategyBase invariant
- **Files modified:** `Plugins/DataWarehouse.Plugins.UltimateDataGovernance/Strategies/IntelligentGovernance/IngestPipelineConsciousnessStrategy.cs`
- **Commit:** d3459c90

**2. [Rule 3 - Blocking] ConsciousnessStrategyBase.IsInitialized hides StrategyBase.IsInitialized**
- **Found during:** Task 2 SDK build
- **Issue:** CS0108 — `public bool IsInitialized` hides `protected bool IsInitialized` from StrategyBase
- **Fix:** Added `new` keyword (`public new bool IsInitialized => _initialized`) to preserve public visibility
- **Files modified:** `DataWarehouse.SDK/Contracts/Consciousness/ConsciousnessStrategyBase.cs`
- **Commit:** d3459c90

## Commits

| Task | Commit | Description |
|------|--------|-------------|
| Task 1 | 00d6e210 | feat(65.3-02): delegate EncryptionStrategyRegistry and ConnectionStrategyRegistry to generic StrategyRegistry |
| Task 2 | d3459c90 | feat(65.3-02): migrate ConsciousnessStrategyBase to extend StrategyBase and delegate ConsciousnessStrategyRegistry |

## Self-Check: PASSED

| Item | Status |
|------|--------|
| DataWarehouse.SDK/Contracts/Encryption/EncryptionStrategy.cs | FOUND |
| DataWarehouse.SDK/Connectors/ConnectionStrategyRegistry.cs | FOUND |
| DataWarehouse.SDK/Contracts/Consciousness/ConsciousnessStrategyBase.cs | FOUND |
| Commit 00d6e210 (Task 1) | FOUND |
| Commit d3459c90 (Task 2) | FOUND |
