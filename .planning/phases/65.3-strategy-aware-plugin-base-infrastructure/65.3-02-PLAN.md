---
phase: 65.3-strategy-aware-plugin-base-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["65.3-01"]
files_modified:
  - DataWarehouse.SDK/Contracts/Encryption/EncryptionStrategy.cs
  - DataWarehouse.SDK/Connectors/ConnectionStrategyRegistry.cs
  - DataWarehouse.SDK/Contracts/Consciousness/ConsciousnessStrategyBase.cs
autonomous: true
must_haves:
  truths:
    - "EncryptionStrategyRegistry delegates to generic StrategyRegistry internally"
    - "ConnectionStrategyRegistry delegates to generic StrategyRegistry internally"
    - "ConsciousnessStrategyBase extends StrategyBase instead of implementing IConsciousnessStrategy directly"
    - "ConsciousnessStrategyRegistry delegates to generic StrategyRegistry"
    - "All existing callers of the 3 bespoke registries compile without changes"
  artifacts:
    - path: "DataWarehouse.SDK/Contracts/Encryption/EncryptionStrategy.cs"
      provides: "EncryptionStrategyRegistry backed by generic StrategyRegistry"
      contains: "StrategyRegistry"
    - path: "DataWarehouse.SDK/Connectors/ConnectionStrategyRegistry.cs"
      provides: "ConnectionStrategyRegistry backed by generic StrategyRegistry"
      contains: "StrategyRegistry"
    - path: "DataWarehouse.SDK/Contracts/Consciousness/ConsciousnessStrategyBase.cs"
      provides: "ConsciousnessStrategyBase extending StrategyBase"
      contains: "ConsciousnessStrategyBase : StrategyBase"
  key_links:
    - from: "DataWarehouse.SDK/Contracts/Encryption/EncryptionStrategy.cs"
      to: "DataWarehouse.SDK/Contracts/StrategyRegistry.cs"
      via: "EncryptionStrategyRegistry wraps generic StrategyRegistry"
      pattern: "StrategyRegistry"
---

<objective>
Retire the 3 bespoke strategy registries by making them delegate to StrategyRegistry internally, and migrate ConsciousnessStrategyBase from direct interface implementation to extending StrategyBase.

Purpose: Eliminates duplicated registry code across 3 classes. ConsciousnessStrategyBase is the only SDK-level Tier 2 strategy base that doesn't extend StrategyBase.

Output: 3 modified files with internal delegation to generic StrategyRegistry, ConsciousnessStrategyBase migrated to StrategyBase hierarchy
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/65.3-strategy-aware-plugin-base-infrastructure/65.3-01-SUMMARY.md
@DataWarehouse.SDK/Contracts/StrategyRegistry.cs
@DataWarehouse.SDK/Contracts/Encryption/EncryptionStrategy.cs
@DataWarehouse.SDK/Connectors/ConnectionStrategyRegistry.cs
@DataWarehouse.SDK/Contracts/Consciousness/ConsciousnessStrategyBase.cs
@DataWarehouse.SDK/Contracts/StrategyBase.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor EncryptionStrategyRegistry and ConnectionStrategyRegistry to delegate to generic StrategyRegistry</name>
  <files>
    DataWarehouse.SDK/Contracts/Encryption/EncryptionStrategy.cs
    DataWarehouse.SDK/Connectors/ConnectionStrategyRegistry.cs
  </files>
  <action>
IMPORTANT CONSTRAINT: IEncryptionStrategy does NOT extend IStrategy (it has its own StrategyId). Plan 01 already handles this by using `where TStrategy : class` with a `Func` key selector in StrategyRegistry. If Plan 01 used a different constraint, adjust StrategyRegistry first to use `where TStrategy : class` with key selector `Func<TStrategy, string>`.

For EncryptionStrategyRegistry (in EncryptionStrategy.cs, ~line 1035):
- Replace the internal `BoundedDictionary<string, IEncryptionStrategy> _strategies` with `private readonly StrategyRegistry<IEncryptionStrategy> _inner = new(s => s.StrategyId);`
- Delegate all methods:
  - Register -> _inner.Register
  - GetStrategy -> _inner.Get
  - GetAllStrategies -> _inner.GetAll
  - SetDefaultStrategy -> _inner.SetDefault
  - GetDefaultStrategy -> _inner.GetDefault
  - DiscoverStrategies -> _inner.DiscoverFromAssembly
- Keep domain-specific methods (GetStrategiesBySecurityLevel, GetFipsCompliantStrategies) that query _inner.GetByPredicate
- Keep the IEncryptionStrategyRegistry interface unchanged (backward compat)

For ConnectionStrategyRegistry:
- `private readonly StrategyRegistry<IConnectionStrategy> _inner = new(s => s.StrategyId);`
- Delegate: Register -> _inner.Register, Unregister -> _inner.Unregister, Get -> _inner.Get, GetAll -> _inner.GetAll, AutoDiscover -> _inner.DiscoverFromAssembly
- Keep domain-specific method GetByCategory using _inner.GetByPredicate

All public APIs remain identical. This is a pure internal refactor.
  </action>
  <verify>
Build SDK: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore` -- 0 errors, 0 warnings.
Build plugins that use encryption/connection registries: `dotnet build Plugins/DataWarehouse.Plugins.UltimateEncryption/DataWarehouse.Plugins.UltimateEncryption.csproj --no-restore` -- 0 errors, 0 warnings.
  </verify>
  <done>EncryptionStrategyRegistry and ConnectionStrategyRegistry internally delegate to generic StrategyRegistry. All public APIs unchanged. All callers compile.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate ConsciousnessStrategyBase to extend StrategyBase</name>
  <files>DataWarehouse.SDK/Contracts/Consciousness/ConsciousnessStrategyBase.cs</files>
  <action>
ConsciousnessStrategyBase currently: `public abstract class ConsciousnessStrategyBase : IConsciousnessStrategy` with its own counters, health cache, initialization. StrategyBase already provides all of this.

Migrate:
1. Change declaration to: `public abstract class ConsciousnessStrategyBase : StrategyBase, IConsciousnessStrategy`
2. Remove duplicated infrastructure that StrategyBase already provides:
   - `_counters` (BoundedDictionary) -- use inherited `IncrementCounter`/`GetCounter`
   - `_initialized` bool -- use inherited `IsInitialized` / `_initialized`
   - `_healthCacheExpiry` / `_cachedHealth` -- use inherited `GetCachedHealthAsync`
   - Any `InitializeAsync` / `ShutdownAsync` / `Dispose` that duplicate StrategyBase patterns
3. Keep domain-specific members: Category, Capabilities, SemanticDescription, Tags, DisplayName
4. Map IConsciousnessStrategy.StrategyId to StrategyBase.StrategyId (already abstract in both -- just ensure it compiles)
5. Map IConsciousnessStrategy.DisplayName: add `public override string Name => DisplayName;` (StrategyBase.Name is abstract, IConsciousnessStrategy has DisplayName)
6. Handle the ConsciousnessStrategyRegistry in the same file (if present) -- make it delegate to generic StrategyRegistry

Search for all concrete classes extending ConsciousnessStrategyBase and verify they still compile. The key risk is name collisions between StrategyBase members and ConsciousnessStrategyBase members. Fix any conflicts by removing the duplicate member and using the inherited one.

Grep for `ConsciousnessStrategyBase` in Plugins/ to find all concrete implementations that must still compile.
  </action>
  <verify>
Build full solution: `dotnet build DataWarehouse.sln --no-restore` -- 0 errors, 0 warnings. All Consciousness plugin strategies still compile.
  </verify>
  <done>ConsciousnessStrategyBase extends StrategyBase. Duplicated infrastructure removed. All concrete Consciousness strategies compile. ConsciousnessStrategyRegistry (if present) delegates to generic StrategyRegistry.</done>
</task>

</tasks>

<verification>
1. `dotnet build DataWarehouse.sln --no-restore` -- 0 errors, 0 warnings
2. Grep confirms EncryptionStrategyRegistry uses generic StrategyRegistry internally
3. Grep confirms ConnectionStrategyRegistry uses generic StrategyRegistry internally
4. Grep confirms ConsciousnessStrategyBase extends StrategyBase
5. All existing tests pass: `dotnet test DataWarehouse.Tests/ --no-build`
</verification>

<success_criteria>
- All 3 bespoke registries delegate to generic StrategyRegistry internally
- ConsciousnessStrategyBase extends StrategyBase (no longer Tier 2)
- Public APIs of all 3 registries unchanged (backward compatible)
- Full solution builds with 0 errors, 0 warnings
</success_criteria>

<output>
After completion, create `.planning/phases/65.3-strategy-aware-plugin-base-infrastructure/65.3-02-SUMMARY.md`
</output>
