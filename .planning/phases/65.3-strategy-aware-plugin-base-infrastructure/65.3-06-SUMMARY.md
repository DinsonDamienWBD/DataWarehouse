---
phase: 65.3-strategy-aware-plugin-base-infrastructure
plan: "06"
subsystem: plugins/encryption,plugins/compression
tags: [strategy-dispatch, plugin-migration, stats-consolidation, dual-registry]
dependency_graph:
  requires: ["65.3-01", "65.3-02", "65.3-03", "65.3-04", "65.3-05"]
  provides: ["UltimateEncryption uses inherited stats", "UltimateCompression populates inherited registry"]
  affects: ["Plugins/DataWarehouse.Plugins.UltimateEncryption", "Plugins/DataWarehouse.Plugins.UltimateCompression"]
tech_stack:
  added: []
  patterns: ["inherited-stats-delegation", "dual-registry-population"]
key_files:
  modified:
    - Plugins/DataWarehouse.Plugins.UltimateEncryption/UltimateEncryptionPlugin.cs
    - Plugins/DataWarehouse.Plugins.UltimateCompression/UltimateCompressionPlugin.cs
decisions:
  - "Keep EncryptionStrategyRegistry (bespoke) in UltimateEncryptionPlugin for FIPS-specific queries (GetFipsCompliantStrategies, GetStrategiesBySecurityLevel)"
  - "Remove duplicated long counters from UltimateEncryptionPlugin; use EncryptionPluginBase.EncryptionCount/DecryptionCount/TotalBytesEncrypted/TotalBytesDecrypted"
  - "UltimateCompressionPlugin dual-registers into both local _strategies and inherited CompressionStrategyRegistry"
  - "Keep _strategies BoundedDictionary for content-aware SelectBestStrategy entropy analysis"
metrics:
  duration: "~7 minutes"
  completed: "2026-02-21"
  tasks_completed: 2
  files_modified: 2
---

# Phase 65.3 Plan 06: Plugin Migration to Inherited Dispatch Summary

One-liner: Remove duplicated stats counters from UltimateEncryptionPlugin and wire UltimateCompressionPlugin into the inherited CompressionStrategyRegistry dispatch path.

## Objective

Migrate UltimateEncryptionPlugin and UltimateCompressionPlugin to use inherited strategy dispatch infrastructure from Plans 01-03, eliminating duplicated code.

## What Was Done

### Task 1: UltimateEncryptionPlugin Stats Consolidation

The plugin had four duplicated `long` counter fields (`_totalEncryptions`, `_totalDecryptions`, `_totalBytesEncrypted`, `_totalBytesDecrypted`) that duplicated the inherited `EncryptionPluginBase` counters (`EncryptionCount`, `DecryptionCount`, `TotalBytesEncrypted`, `TotalBytesDecrypted`).

Changes made:
- Removed 4 duplicated `long` counter fields
- Removed `_statsLock` (now uses inherited `StatsLock` from `EncryptionPluginBase`)
- Replaced all `Interlocked.Increment/Add(ref _total*)` calls with inherited `UpdateEncryptionStats(bytes)` and `UpdateDecryptionStats(bytes)` in:
  - `OnWriteAsync` (encryption path)
  - `OnReadAsync` (decryption path)
  - `HandleEncryptAsync` (message handler)
  - `HandleDecryptAsync` (message handler)
  - `HandleCascadeEncryptAsync` (cascade path)
  - `HandleReencryptAsync` (re-encryption path)
- Updated `HandleStatsAsync` to read `EncryptionCount`, `DecryptionCount`, `TotalBytesEncrypted`, `TotalBytesDecrypted` via `lock(StatsLock)`
- Updated `BuildStatisticsKnowledge` to read inherited counters under `StatsLock`

Retained (intentional):
- `_registry` (EncryptionStrategyRegistry): retained for FIPS-specific queries (`GetFipsCompliantStrategies`, `GetStrategiesBySecurityLevel`) not available in the generic `StrategyRegistry<T>`
- `_usageStats` (BoundedDictionary): retained for per-strategy operation tracking (no equivalent in base class)

### Task 2: UltimateCompressionPlugin Dual-Registry Population

The plugin had its own `_strategies` BoundedDictionary for storage. The inherited `CompressionPluginBase.CompressionStrategyRegistry` was not being populated, so the base-class dispatch path (`DispatchCompressionStrategyAsync`, `CompressAsync`, `DecompressAsync`) would not resolve any strategies.

Changes made:
- `RegisterStrategy()`: now calls `RegisterCompressionStrategy(strategy)` (inherited) after updating `_strategies`, so both registries stay in sync
- `DiscoverAndRegisterStrategies()`: now calls `RegisterCompressionStrategy(strategy)` for each discovered strategy during assembly scanning
- Updated comment stub from `// Statistics tracking` to note that stats delegation goes to base class

Retained (intentional):
- `_strategies` BoundedDictionary: retained for `SelectBestStrategy()` entropy-based content-aware algorithm selection
- `GetStrategy()`, `GetRegisteredAlgorithms()`: retained for content-aware selection path and public API

## Verification

- `dotnet build Plugins/DataWarehouse.Plugins.UltimateEncryption/ --no-restore`: 0 errors, 0 warnings
- `dotnet build DataWarehouse.slnx --no-restore`: 0 errors, 0 warnings
- `dotnet test DataWarehouse.Tests/ --no-build`: 2369 passed, 3 pre-existing failures (unrelated: performance dict size test + compliance passport test)

## Deviations from Plan

### Auto-fixed Issues

None — plan executed exactly as written.

### Notes on Partial Migration

The plan noted that a full migration of `HandleEncryptAsync`/`HandleDecryptAsync` to the base class `EncryptAsync`/`DecryptAsync` domain methods is constrained because:

1. `IEncryptionStrategy` does not extend `IStrategy` — so `PluginBase.StrategyRegistry<IStrategy>` cannot hold encryption strategies
2. `EncryptionPluginBase.EncryptAsync/DecryptAsync` dispatch through `EncryptionStrategyRegistry` (the generic typed one), but `UltimateEncryptionPlugin` uses the bespoke `EncryptionStrategyRegistry` class for FIPS queries

The handlers correctly use `strategy.EncryptAsync/DecryptAsync` directly on strategies resolved from `_registry`. This is the correct pattern — the stats counters were the only true duplication, and they have been removed.

## Commits

| Task | Commit | Description |
|------|--------|-------------|
| 1    | 99b5fc9c | feat(65.3-06): migrate UltimateEncryptionPlugin to inherited stats infrastructure |
| 2    | 05d849a0 | feat(65.3-06): wire UltimateCompressionPlugin into inherited dispatch registry |

## Self-Check

Files exist:
- Plugins/DataWarehouse.Plugins.UltimateEncryption/UltimateEncryptionPlugin.cs — FOUND
- Plugins/DataWarehouse.Plugins.UltimateCompression/UltimateCompressionPlugin.cs — FOUND

Commits exist:
- 99b5fc9c — FOUND
- 05d849a0 — FOUND
