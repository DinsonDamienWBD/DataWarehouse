---
phase: 74-vde-identity-tamper
plan: 02
type: execute
wave: 2
depends_on: ["74-01"]
files_modified:
  - DataWarehouse.SDK/VirtualDiskEngine/Identity/HeaderIntegritySeal.cs
  - DataWarehouse.SDK/VirtualDiskEngine/Identity/MetadataChainHasher.cs
  - DataWarehouse.SDK/VirtualDiskEngine/Identity/FileSizeSentinel.cs
  - DataWarehouse.SDK/VirtualDiskEngine/Identity/LastWriterIdentity.cs
autonomous: true

must_haves:
  truths:
    - "Header Integrity Seal (HMAC-SHA256) is computed over superblock content and verified on every VDE open"
    - "Metadata Chain Hash covers all metadata regions; any single-byte modification is detected"
    - "File Size Sentinel detects truncation -- a VDE truncated by even 1 byte fails with a clear error"
    - "Last Writer Identity records session ID, timestamp, and node ID of the last writer"
  artifacts:
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Identity/HeaderIntegritySeal.cs"
      provides: "HMAC-SHA256 computation and verification for superblock header"
      exports: ["HeaderIntegritySeal"]
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Identity/MetadataChainHasher.cs"
      provides: "Rolling SHA-256 chain hash across all metadata region blocks"
      exports: ["MetadataChainHasher"]
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Identity/FileSizeSentinel.cs"
      provides: "Validates actual file size against SuperblockV2.ExpectedFileSize"
      exports: ["FileSizeSentinel"]
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Identity/LastWriterIdentity.cs"
      provides: "Records and reads last writer session/node/timestamp from superblock"
      exports: ["LastWriterIdentity"]
  key_links:
    - from: "HeaderIntegritySeal"
      to: "SuperblockV2.HeaderIntegritySeal"
      via: "Computes HMAC-SHA256 over serialized superblock bytes [0..sealOffset) and stores in HeaderIntegritySeal field"
      pattern: "HMACSHA256.*HeaderIntegritySeal"
    - from: "MetadataChainHasher"
      to: "IntegrityAnchor.MetadataChainHash"
      via: "Iterates metadata regions, chains SHA-256 hashes, stores result in MetadataChainHash"
      pattern: "MetadataChainHash.*SHA256"
    - from: "FileSizeSentinel"
      to: "SuperblockV2.ExpectedFileSize"
      via: "Compares file length to ExpectedFileSize field"
      pattern: "ExpectedFileSize"
    - from: "LastWriterIdentity"
      to: "SuperblockV2.LastWriterSessionId/LastWriterTimestamp/LastWriterNodeId"
      via: "Reads/writes last writer fields in superblock"
      pattern: "LastWriter"
---

<objective>
Implement the four runtime integrity checks that execute on every VDE open: header seal verification,
metadata chain hash validation, file size sentinel check, and last writer identity tracking.

Purpose: These checks form the "open-time integrity gate" -- any tampering with the header, metadata
regions, or file size is detected before the VDE is used. Last writer identity provides forensic
traceability for multi-node environments.

Output: Four production classes providing compute/verify for each integrity mechanism.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/74-vde-identity-tamper/74-01-SUMMARY.md
@DataWarehouse.SDK/VirtualDiskEngine/Format/SuperblockV2.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/IntegrityAnchor.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/SuperblockGroup.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/FormatConstants.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/UniversalBlockTrailer.cs
@DataWarehouse.SDK/VirtualDiskEngine/Identity/VdeIdentityException.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: HeaderIntegritySeal + FileSizeSentinel -- HMAC-SHA256 header verification and truncation detection</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/Identity/HeaderIntegritySeal.cs
    DataWarehouse.SDK/VirtualDiskEngine/Identity/FileSizeSentinel.cs
  </files>
  <action>
Create HeaderIntegritySeal.cs -- static class in namespace DataWarehouse.SDK.VirtualDiskEngine.Identity.

The superblock (block 0) already has a 32-byte HeaderIntegritySeal field at the end of the payload (before the universal block trailer). This class computes and verifies that seal.

Methods:
- ComputeSeal(ReadOnlySpan<byte> superblockPayload, byte[] hmacKey) -> byte[32]:
  - Takes the serialized superblock block bytes from offset 0 to (blockSize - UniversalBlockTrailerSize - IntegritySealSize).
  - That is: the seal covers everything in the superblock EXCEPT the seal itself and the trailer.
  - Uses HMAC-SHA256 with the provided key.
  - Returns the 32-byte HMAC.
- WriteSeal(Span<byte> superblockBlock, int blockSize, byte[] hmacKey) -> void:
  - Computes the seal over [0..sealOffset) where sealOffset = blockSize - UniversalBlockTrailerSize - SuperblockV2.IntegritySealSize
  - Writes the 32-byte HMAC at [sealOffset..sealOffset+32)
  - NOTE: Does NOT write the universal block trailer (that happens separately)
- VerifySeal(ReadOnlySpan<byte> superblockBlock, int blockSize, byte[] hmacKey) -> bool:
  - Recomputes HMAC over same range and compares with stored seal using CryptographicOperations.FixedTimeEquals
- VerifyOrThrow(ReadOnlySpan<byte> superblockBlock, int blockSize, byte[] hmacKey):
  - Throws VdeTamperDetectedException("Header integrity seal verification failed: superblock has been modified") on failure

Create FileSizeSentinel.cs -- static class.

Methods:
- Validate(long actualFileSize, long expectedFileSize) -> bool:
  - Returns actualFileSize == expectedFileSize
- Validate(long actualFileSize, in SuperblockV2 superblock) -> bool:
  - Reads superblock.ExpectedFileSize and compares
- ValidateOrThrow(long actualFileSize, in SuperblockV2 superblock):
  - Throws VdeTamperDetectedException with message: "File size sentinel failed: expected {expected} bytes but file is {actual} bytes (delta: {delta} bytes). The VDE file may have been truncated or extended."
- ValidateOrThrow(string filePath, in SuperblockV2 superblock):
  - Gets FileInfo.Length and calls the above

Both classes: [SdkCompatibility("6.0.0", Notes = "Phase 74: VDE Identity (VTMP-03, VTMP-05)")].
  </action>
  <verify>
dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore 2>&1 | tail -5
Expect: Build succeeded, 0 errors.
  </verify>
  <done>
HeaderIntegritySeal.ComputeSeal produces a 32-byte HMAC-SHA256. VerifySeal returns true for unmodified superblock and false after any byte change. FileSizeSentinel.Validate returns false when file size differs from expected. Both throw typed VdeTamperDetectedException on failure.
  </done>
</task>

<task type="auto">
  <name>Task 2: MetadataChainHasher + LastWriterIdentity -- rolling chain hash and writer tracking</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/Identity/MetadataChainHasher.cs
    DataWarehouse.SDK/VirtualDiskEngine/Identity/LastWriterIdentity.cs
  </files>
  <action>
Create MetadataChainHasher.cs -- static class for computing the rolling metadata chain hash.

The metadata chain hash in IntegrityAnchor covers all metadata regions (region directory, policy vault, encryption header, bitmap header, inode table header, WAL headers, and all module region headers). It is a chained SHA-256: hash_n = SHA256(hash_{n-1} || block_content_n).

Methods:
- ComputeChainHash(Stream vdeStream, int blockSize, IReadOnlyDictionary<string, (long StartBlock, long BlockCount)> regions) -> (byte[] chainHash, long generation, long timestamp):
  - Iterates through all metadata regions in block order (sorted by StartBlock ascending)
  - Skips "PrimarySuperblock", "MirrorSuperblock", and "DataRegion" (superblock has its own seal; data is not metadata)
  - For each metadata region, reads the FIRST block only (the header block)
  - Chains: currentHash = SHA256(previousHash || blockBytes)
  - Initial previousHash = 32 zero bytes
  - Returns (finalHash, incrementedGeneration, DateTimeOffset.UtcNow.Ticks)
- ValidateChainHash(Stream vdeStream, int blockSize, IReadOnlyDictionary<string, (long StartBlock, long BlockCount)> regions, ReadOnlySpan<byte> storedHash) -> bool:
  - Recomputes and compares with CryptographicOperations.FixedTimeEquals
- ValidateOrThrow(Stream vdeStream, int blockSize, IReadOnlyDictionary<string, (long StartBlock, long BlockCount)> regions, ReadOnlySpan<byte> storedHash):
  - Throws VdeTamperDetectedException("Metadata chain hash mismatch: one or more metadata regions have been modified since last integrity checkpoint")

Create LastWriterIdentity.cs -- a readonly struct and helper.

LastWriterIdentity struct:
- Guid SessionId
- long TimestampUtcTicks
- Guid NodeId
- Constructor from all three
- static CreateCurrent(Guid nodeId) -> LastWriterIdentity: generates new session GUID, uses DateTimeOffset.UtcNow.Ticks, uses provided nodeId
- static FromSuperblock(in SuperblockV2 sb) -> LastWriterIdentity: reads the three last-writer fields
- ApplyToSuperblock method is not possible (SuperblockV2 is readonly struct), so instead provide:
  static UpdateSuperblockLastWriter(in SuperblockV2 sb, LastWriterIdentity writer) -> SuperblockV2: creates a new SuperblockV2 with all original fields EXCEPT the three last-writer fields replaced with writer's values. This requires calling the SuperblockV2 constructor with all ~30 parameters, copying originals and replacing three.

All classes: [SdkCompatibility("6.0.0", Notes = "Phase 74: VDE Identity (VTMP-04, VTMP-06)")].
  </action>
  <verify>
dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore 2>&1 | tail -5
Expect: Build succeeded, 0 errors.
  </verify>
  <done>
MetadataChainHasher.ComputeChainHash produces a deterministic 32-byte rolling hash. Modifying any metadata region's header block produces a different chain hash. LastWriterIdentity.CreateCurrent generates a unique session ID. UpdateSuperblockLastWriter creates a new superblock with updated writer fields and all other fields preserved.
  </done>
</task>

</tasks>

<verification>
- dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj succeeds with 0 errors
- HeaderIntegritySeal round-trips: compute seal -> write seal -> verify -> true; flip one byte -> verify -> false
- FileSizeSentinel: correct size -> true; truncated by 1 byte -> false with descriptive exception
- MetadataChainHasher: same regions -> same hash; modify one region header -> different hash
- LastWriterIdentity: FromSuperblock reads back what UpdateSuperblockLastWriter wrote
- All classes use System.Security.Cryptography (HMACSHA256, SHA256) -- no third-party dependencies
</verification>

<success_criteria>
1. HeaderIntegritySeal computes HMAC-SHA256 over superblock content and verifies on open
2. MetadataChainHasher chains SHA-256 across all metadata region headers
3. FileSizeSentinel detects any file size deviation from ExpectedFileSize
4. LastWriterIdentity tracks session/node/timestamp of last write operation
5. All verification failures throw VdeTamperDetectedException with descriptive messages
</success_criteria>

<output>
After completion, create `.planning/phases/74-vde-identity-tamper/74-02-SUMMARY.md`
</output>
