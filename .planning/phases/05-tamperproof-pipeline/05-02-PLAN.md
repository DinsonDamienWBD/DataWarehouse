---
phase: 05-tamperproof-pipeline
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Plugins/DataWarehouse.Plugins.TamperProof/Services/DegradationStateService.cs
  - Plugins/DataWarehouse.Plugins.TamperProof/Services/BlockchainVerificationService.cs
  - Plugins/DataWarehouse.Plugins.TamperProof/Services/OrphanCleanupService.cs
  - Plugins/DataWarehouse.Plugins.TamperProof/Pipeline/WritePhaseHandlers.cs
  - DataWarehouse.SDK/Contracts/TamperProof/TamperProofEnums.cs
  - Metadata/TODO.md
autonomous: true

must_haves:
  truths:
    - "All T4.1-T4.15 sub-tasks (62 items) are verified or implemented and marked [x] in TODO.md"
    - "DegradationStateService manages state transitions with event notifications and admin override (T4.6 gap closed)"
    - "ConsensusMode enum includes ExternalAnchor with implementation in BlockchainVerificationService (T4.7.3 gap closed)"
    - "Background orphan cleanup job processes expired orphans with compliance awareness (T4.14.8-T4.14.9 gap closed)"
    - "Chaff padding pattern produces plausible-looking dummy data (T4.12.3 gap closed)"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.TamperProof/Services/DegradationStateService.cs"
      provides: "Centralized state machine with transitions, notifications, auto-detection, admin override"
    - path: "Plugins/DataWarehouse.Plugins.TamperProof/Services/OrphanCleanupService.cs"
      provides: "Background orphan cleanup with compliance-aware expiry and recovery linking"
    - path: "DataWarehouse.SDK/Contracts/TamperProof/TamperProofEnums.cs"
      provides: "ExternalAnchor added to ConsensusMode enum"
  key_links:
    - from: "DegradationStateService"
      to: "InstanceDegradationState enum"
      via: "state transition validation"
      pattern: "InstanceDegradationState"
    - from: "BlockchainVerificationService"
      to: "ConsensusMode.ExternalAnchor"
      via: "mode dispatch"
      pattern: "ConsensusMode\\.ExternalAnchor"
    - from: "OrphanCleanupService"
      to: "OrphanedWormRecord"
      via: "orphan processing"
      pattern: "OrphanedWormRecord|OrphanedWormStatus"
---

<objective>
Verify all T4.1-T4.15 features (recovery, seal, blockchain, WORM, padding, transactional writes, background scanner) and implement the 4 identified gaps: DegradationStateService (T4.6), ExternalAnchor mode (T4.7.3), Chaff padding (T4.12.3), and background orphan cleanup (T4.14.8-T4.14.9).

Purpose: T4 contains the advanced recovery and integrity features. Research found most are implemented but 4 small gaps remain. This plan closes those gaps and syncs TODO.md.

Output: 4 gap implementations + all 62 T4.1-T4.15 sub-tasks marked [x] in TODO.md.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-tamperproof-pipeline/05-RESEARCH.md

@Plugins/DataWarehouse.Plugins.TamperProof/TamperProofPlugin.cs
@Plugins/DataWarehouse.Plugins.TamperProof/Pipeline/WritePhaseHandlers.cs
@Plugins/DataWarehouse.Plugins.TamperProof/Services/RecoveryService.cs
@Plugins/DataWarehouse.Plugins.TamperProof/Services/SealService.cs
@Plugins/DataWarehouse.Plugins.TamperProof/Services/AuditTrailService.cs
@Plugins/DataWarehouse.Plugins.TamperProof/Services/BlockchainVerificationService.cs
@Plugins/DataWarehouse.Plugins.TamperProof/Services/BackgroundIntegrityScanner.cs
@Plugins/DataWarehouse.Plugins.TamperProof/Storage/S3WormStorage.cs
@Plugins/DataWarehouse.Plugins.TamperProof/Storage/AzureWormStorage.cs
@DataWarehouse.SDK/Contracts/TamperProof/TamperProofEnums.cs
@DataWarehouse.SDK/Contracts/TamperProof/TamperProofConfiguration.cs
@DataWarehouse.SDK/Contracts/TamperProof/TamperProofResults.cs
@DataWarehouse.SDK/Contracts/TamperProof/TamperProofManifest.cs
@Metadata/TODO.md (T4 section, lines 2013-2176)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify Existing T4 Implementations and Implement 4 Gaps</name>
  <files>
    Plugins/DataWarehouse.Plugins.TamperProof/Services/DegradationStateService.cs
    Plugins/DataWarehouse.Plugins.TamperProof/Services/BlockchainVerificationService.cs
    Plugins/DataWarehouse.Plugins.TamperProof/Services/OrphanCleanupService.cs
    Plugins/DataWarehouse.Plugins.TamperProof/Pipeline/WritePhaseHandlers.cs
    DataWarehouse.SDK/Contracts/TamperProof/TamperProofEnums.cs
  </files>
  <action>
    **STEP 1: Verify existing T4 implementations (scan, do not modify).**

    Read and confirm production readiness for:
    - T4.1 (TamperRecoveryBehavior enum + 5 modes): Check SDK enum and TamperProofPlugin dispatch
    - T4.2 (RecoverFromWormAsync): Check RecoveryService 6-step recovery
    - T4.3 (SecureCorrectAsync with append-only): Check RecoveryService
    - T4.3.1-T4.3.3: Version increment, provenance linking, blockchain anchoring
    - T4.4 (AuditAsync): Check AuditTrailService for chain verification + provenance
    - T4.5 (Seal mechanism): Check SealService for block/shard/date-range sealing
    - T4.5.1-T4.5.3: Structural lock, behavioral mutability, seal persistence
    - T4.7.1-T4.7.2 (SingleWriter, RaftConsensus): Check ConsensusMode enum
    - T4.8 (Blockchain batching): Check ProcessBlockchainBatchAsync with ConcurrentQueue
    - T4.8.1 (Merkle root): Check ComplianceReportingService.ComputeMerkleRoot
    - T4.9-T4.11 (WORM providers): Check IWormStorageProvider, S3WormStorage, AzureWormStorage
    - T4.12-T4.13 (Padding config): Check ContentPaddingConfig, ShardPaddingConfig in SDK
    - T4.14 (TransactionalWriteManager): Check WritePhaseHandlers.ExecuteTransactionalWriteAsync
    - T4.14.1-T4.14.7, T4.14.10: Write ordering, enums, rollback, orphan tracking, timeout
    - T4.15 (BackgroundIntegrityScanner): Check StartAsync/StopAsync, ScanBlockAsync, ViolationDetected event

    Scan for forbidden patterns in all T4 code paths.

    **STEP 2: Implement Gap 1 -- DegradationStateService (T4.6).**

    Create `Plugins/DataWarehouse.Plugins.TamperProof/Services/DegradationStateService.cs`:
    - Class: `DegradationStateService` (internal, follows existing service pattern)
    - Uses the existing `InstanceDegradationState` enum (6 states: Healthy, Degraded, DegradedReadOnly, DegradedNoRecovery, Offline, Corrupted)
    - Define valid state transitions as a dictionary (e.g., Healthy->Degraded allowed, Corrupted->Healthy not allowed without admin)
    - Methods:
      - `TransitionStateAsync(string instanceId, InstanceDegradationState newState)` -- validates transition, fires event
      - `GetCurrentState(string instanceId)` -- returns current state
      - `AdminOverrideStateAsync(string instanceId, InstanceDegradationState newState, string adminPrincipal, string reason)` -- allows any transition with audit log
      - `DetectStateAsync(string instanceId, HealthCheckResult healthCheck)` -- auto-detect based on provider health (check tier availability, WORM reachability)
    - Event: `StateChanged` event (instanceId, oldState, newState, timestamp, reason)
    - Use `ConcurrentDictionary<string, InstanceDegradationState>` for state storage (matches existing pattern)
    - Add XML documentation on all public members
    - Add ILogger for logging state transitions

    **STEP 3: Implement Gap 2 -- ExternalAnchor blockchain mode (T4.7.3).**

    In `DataWarehouse.SDK/Contracts/TamperProof/TamperProofEnums.cs`:
    - Add `ExternalAnchor` value to `ConsensusMode` enum with XML doc:
      ```
      /// <summary>
      /// Periodic anchoring to external/public blockchain for independent verification.
      /// Provides highest trust level through third-party immutability guarantee.
      /// </summary>
      ExternalAnchor
      ```

    In `Plugins/DataWarehouse.Plugins.TamperProof/Services/BlockchainVerificationService.cs`:
    - Add handling for `ConsensusMode.ExternalAnchor` in the mode dispatch logic
    - Implement external anchor verification: create anchor record with Merkle root hash, timestamp, and target chain identifier
    - The anchor publishes via message bus topic `blockchain.anchor.external` for external chain integration
    - Include fallback: if external anchor service unavailable, queue locally and retry (follows graceful degradation pattern)

    **STEP 4: Implement Gap 3 -- Chaff padding (T4.12.3).**

    In `Plugins/DataWarehouse.Plugins.TamperProof/Pipeline/WritePhaseHandlers.cs`:
    - Find the content padding application logic (or add it to ApplyUserTransformationsAsync if not present)
    - Add Chaff padding mode: generate plausible-looking data using a seeded CSPRNG that produces byte patterns matching typical content distribution (not all zeros or random noise)
    - The `ContentPaddingRecord.PaddingPattern` field should be set to `"Chaff"` for read-side identification
    - Chaff data should be deterministically reproducible from a stored seed (for verification) but indistinguishable from real content

    **STEP 5: Implement Gap 4 -- Background orphan cleanup (T4.14.8-T4.14.9).**

    Create `Plugins/DataWarehouse.Plugins.TamperProof/Services/OrphanCleanupService.cs`:
    - Class: `OrphanCleanupService` (internal, follows BackgroundIntegrityScanner pattern)
    - `StartAsync` / `StopAsync` lifecycle methods using Timer or Task.Delay loop
    - `ProcessOrphansAsync()`:
      - Scan orphan registry for records with `OrphanedWormStatus.PendingExpiry` past expiration
      - For expired orphans: transition to `Reviewed` -> attempt cleanup -> mark `Purged` (if compliance allows)
      - For `TransactionFailed` orphans: attempt recovery linking -- check if a successful retry exists with matching ContentHash, if so link via `LinkedTransactionId` and transition to `LinkedToRetry`
    - Configurable scan interval (default: 1 hour)
    - Use ILogger for all operations
    - Use `ConcurrentDictionary` for orphan registry (matches existing pattern)
    - Add XML documentation on all public members
  </action>
  <verify>
    Run: `dotnet build Plugins/DataWarehouse.Plugins.TamperProof/DataWarehouse.Plugins.TamperProof.csproj --no-restore 2>&1 | tail -5`
    Expect: Build succeeded with 0 errors.

    Verify new files exist:
    - `ls Plugins/DataWarehouse.Plugins.TamperProof/Services/DegradationStateService.cs`
    - `ls Plugins/DataWarehouse.Plugins.TamperProof/Services/OrphanCleanupService.cs`

    Verify ExternalAnchor in enum:
    - `grep "ExternalAnchor" DataWarehouse.SDK/Contracts/TamperProof/TamperProofEnums.cs`

    Scan for forbidden patterns:
    - `grep -rn "NotImplementedException\|TODO:\|FIXME:\|simulation\|placeholder" Plugins/DataWarehouse.Plugins.TamperProof/Services/DegradationStateService.cs Plugins/DataWarehouse.Plugins.TamperProof/Services/OrphanCleanupService.cs`
  </verify>
  <done>
    4 gaps implemented: DegradationStateService (T4.6), ExternalAnchor mode (T4.7.3), Chaff padding (T4.12.3), OrphanCleanupService (T4.14.8-T4.14.9). All T4.1-T4.15 implementations verified production-ready. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Mark T4.1-T4.15 Sub-Tasks Complete in TODO.md</name>
  <files>Metadata/TODO.md</files>
  <action>
    In Metadata/TODO.md, change all T4.1-T4.15 sub-task status from `[ ]` to `[x]` on lines 2018-2146.

    Task ranges to mark complete (all `[ ]` to `[x]`):
    - Lines 2018-2024: T4.1, T4.1.1-T4.1.5, T4.2 (Recovery behaviors)
    - Lines 2029-2033: T4.3, T4.3.1-T4.3.3, T4.4 (Corrections and audit)
    - Lines 2038-2045: T4.5, T4.5.1-T4.5.3, T4.6, T4.6.1-T4.6.3 (Seal and degradation)
    - Lines 2050-2055: T4.7, T4.7.1-T4.7.3, T4.8, T4.8.1 (Blockchain)
    - Lines 2060-2064: T4.9, T4.9.1-T4.9.2, T4.10, T4.11 (WORM)
    - Lines 2069-2077: T4.12, T4.12.1-T4.12.4, T4.13, T4.13.1-T4.13.3 (Padding)
    - Lines 2082-2092: T4.14, T4.14.1-T4.14.10 (Transactional writes)
    - Line 2146: T4.15 (Background scanner)

    Total: approximately 62 line items to mark [x].

    Note: Line numbers are approximate. Search for the exact `| T4.X |` pattern and replace `| [ ] |` with `| [x] |`.

    Do NOT modify T4.16+ lines (hashing, compression, encryption). Those are handled by other plans.
    Do NOT modify the Tier 2 summary table (already shows [x] Complete).
  </action>
  <verify>
    Run: `grep "T4\." Metadata/TODO.md | grep -c "\[ \]"` -- should return only T4.16+ items (hashing/compression lines).
    Run: `grep -E "T4\.(1[0-5]?|[2-9])\b" Metadata/TODO.md | grep "\[ \]" | head -5` -- should return zero results (all T4.1-T4.15 marked).
  </verify>
  <done>All T4.1-T4.15 sub-tasks (62 items) marked [x] in TODO.md. T4.16+ items untouched.</done>
</task>

</tasks>

<verification>
1. `dotnet build Plugins/DataWarehouse.Plugins.TamperProof/DataWarehouse.Plugins.TamperProof.csproj` passes
2. DegradationStateService.cs exists with state transitions, auto-detection, admin override
3. ConsensusMode enum contains ExternalAnchor
4. OrphanCleanupService.cs exists with cleanup and recovery linking
5. Chaff padding logic exists in write pipeline
6. Zero T4.1-T4.15 sub-tasks remain marked `[ ]` in TODO.md
</verification>

<success_criteria>
- 4 implementation gaps closed (DegradationStateService, ExternalAnchor, Chaff padding, OrphanCleanupService)
- All 62 T4.1-T4.15 sub-tasks marked [x] in TODO.md
- Build passes without errors
- Zero forbidden patterns in new code
</success_criteria>

<output>
After completion, create `.planning/phases/05-tamperproof-pipeline/05-02-SUMMARY.md`
</output>
