---
phase: 05-tamperproof-pipeline
plan: 04
type: execute
wave: 2
depends_on: ["05-01", "05-02", "05-03"]
files_modified:
  - DataWarehouse.Tests/TamperProof/IntegrityProviderTests.cs
  - DataWarehouse.Tests/TamperProof/BlockchainProviderTests.cs
  - DataWarehouse.Tests/TamperProof/WormProviderTests.cs
  - DataWarehouse.Tests/TamperProof/AccessLogProviderTests.cs
  - DataWarehouse.Tests/TamperProof/WritePipelineTests.cs
  - DataWarehouse.Tests/TamperProof/ReadPipelineTests.cs
  - DataWarehouse.Tests/TamperProof/TamperDetectionTests.cs
  - DataWarehouse.Tests/TamperProof/RecoveryTests.cs
  - DataWarehouse.Tests/TamperProof/CorrectionWorkflowTests.cs
  - DataWarehouse.Tests/TamperProof/DegradationStateTests.cs
  - DataWarehouse.Tests/TamperProof/WormHardwareTests.cs
  - DataWarehouse.Tests/TamperProof/PerformanceBenchmarkTests.cs
  - DataWarehouse.Tests/DataWarehouse.Tests.csproj
  - Metadata/TODO.md
  - Metadata/CLAUDE.md
autonomous: true

must_haves:
  truths:
    - "TamperProof test files exist in DataWarehouse.Tests/TamperProof/ directory"
    - "Unit tests cover: integrity provider hash verification, blockchain anchoring, WORM write-once enforcement, access log tamper detection"
    - "Integration tests cover: write pipeline 5 phases, read pipeline 5 phases, tamper detection with attribution, recovery from WORM, correction workflow, degradation state transitions, hardware WORM provider patterns"
    - "Performance benchmarks measure hash throughput, write pipeline latency, read pipeline latency using Stopwatch"
    - "All tests build and compile (may not all pass due to missing runtime dependencies, but must compile)"
    - "CLAUDE.md has TamperProof architecture section"
    - "All T6.1-T6.14 sub-tasks marked [x] in TODO.md"
  artifacts:
    - path: "DataWarehouse.Tests/TamperProof/"
      provides: "Complete TamperProof test suite (T6.1-T6.12)"
    - path: "Metadata/CLAUDE.md"
      provides: "TamperProof architecture documentation section"
  key_links:
    - from: "Test files"
      to: "TamperProof SDK contracts"
      via: "using DataWarehouse.SDK.Contracts.TamperProof"
      pattern: "using DataWarehouse\\.SDK\\.Contracts\\.TamperProof"
    - from: "Test files"
      to: "xunit assertions"
      via: "Xunit.Assert"
      pattern: "Assert\\.(True|Equal|NotNull|Throws)"
---

<objective>
Implement the complete TamperProof test suite (T6.1-T6.14): unit tests, integration tests, performance benchmarks, XML doc verification, and CLAUDE.md documentation update.

Purpose: Tests are the only completely unimplemented T6 tasks. This plan creates all 14 test tasks in the existing DataWarehouse.Tests project (no separate test project needed -- tests go in a TamperProof/ subdirectory following the existing Compliance/ pattern).

Output: 12 test files in DataWarehouse.Tests/TamperProof/, updated CLAUDE.md, all T6 items marked [x].
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-tamperproof-pipeline/05-RESEARCH.md

@DataWarehouse.Tests/DataWarehouse.Tests.csproj
@DataWarehouse.Tests/Compliance/ComplianceTestSuites.cs (reference for test patterns)
@DataWarehouse.SDK/Contracts/TamperProof/TamperProofEnums.cs
@DataWarehouse.SDK/Contracts/TamperProof/TamperProofConfiguration.cs
@DataWarehouse.SDK/Contracts/TamperProof/TamperProofManifest.cs
@DataWarehouse.SDK/Contracts/TamperProof/TamperProofResults.cs
@DataWarehouse.SDK/Contracts/TamperProof/ITamperProofProvider.cs
@DataWarehouse.SDK/Contracts/TamperProof/IIntegrityProvider.cs
@DataWarehouse.SDK/Contracts/TamperProof/IBlockchainProvider.cs
@DataWarehouse.SDK/Contracts/TamperProof/IWormStorageProvider.cs
@DataWarehouse.SDK/Contracts/TamperProof/IAccessLogProvider.cs
@Metadata/TODO.md (T6 section, lines 4940-4956)
@Metadata/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Unit Tests (T6.1-T6.4)</name>
  <files>
    DataWarehouse.Tests/TamperProof/IntegrityProviderTests.cs
    DataWarehouse.Tests/TamperProof/BlockchainProviderTests.cs
    DataWarehouse.Tests/TamperProof/WormProviderTests.cs
    DataWarehouse.Tests/TamperProof/AccessLogProviderTests.cs
    DataWarehouse.Tests/DataWarehouse.Tests.csproj
  </files>
  <action>
    Create directory `DataWarehouse.Tests/TamperProof/` for all TamperProof tests.

    **IMPORTANT:** Tests operate against the SDK contract types (enums, configs, manifests, results) since the plugin itself is not directly referenced from the test project (plugin isolation rule). Tests verify:
    - SDK type construction and validation
    - Enum coverage and value correctness
    - Configuration defaults and constraint validation
    - Result factory methods

    If the test project needs BouncyCastle for hash verification, add the package reference to the csproj.

    **T6.1 - IntegrityProviderTests.cs:**
    - Test `HashAlgorithm` enum has all expected values (SHA256, SHA512, SHA3_256, SHA3_384, SHA3_512, Keccak256, Keccak384, Keccak512, BLAKE3, HMAC_SHA256, HMAC_SHA3_256)
    - Test TamperProofManifest creation with FinalContentHash
    - Test integrity verification: given a manifest with known hash, verify hash comparison logic
    - Test hash mismatch detection: tampered data produces different hash
    - Test ShardIntegrityRecord construction with ContentHash
    - Use System.Security.Cryptography.SHA256 for hash computation in tests

    **T6.2 - BlockchainProviderTests.cs:**
    - Test ConsensusMode enum has all 3 values (SingleWriter, RaftConsensus, ExternalAnchor)
    - Test BlockchainAnchor record construction with BlockHash, PreviousBlockHash, Timestamp
    - Test Merkle root computation: given known leaf hashes, verify Merkle root
    - Test blockchain chain integrity: sequential blocks with valid PreviousBlockHash links
    - Test batching configuration: MaxBatchSize, MaxBatchDelay from TamperProofConfiguration

    **T6.3 - WormProviderTests.cs:**
    - Test WormEnforcementMode enum (Software, HardwareIntegrated, Hybrid)
    - Test WormConfiguration construction with RetentionPeriod, EnforcementMode
    - Test write-once semantics: verify WormWriteResult is immutable
    - Test retention period validation: cannot set retention below minimum
    - Test S3 Object Lock configuration: Governance vs Compliance modes
    - Test Azure Immutable Blob configuration: Unlocked vs Locked policies

    **T6.4 - AccessLogProviderTests.cs:**
    - Test AccessLogEntry construction with all required fields (Principal, Action, Timestamp, ObjectId)
    - Test access log integrity: hash chain verification between sequential entries
    - Test time-window query: filter logs by DateTimeOffset range
    - Test tamper detection: modified log entry breaks hash chain
    - Test attribution confidence levels (Unknown, Suspected, Likely, Confirmed)

    Each test file:
    - Namespace: `DataWarehouse.Tests.TamperProof`
    - Uses xunit `[Fact]` and `[Theory]` attributes
    - Uses FluentAssertions where appropriate
    - Full XML documentation on test classes
    - 8-15 test methods per file
  </action>
  <verify>
    Run: `dotnet build DataWarehouse.Tests/DataWarehouse.Tests.csproj --no-restore 2>&1 | tail -10`
    Expect: Build succeeded with 0 errors.
    Run: `ls DataWarehouse.Tests/TamperProof/` -- should show 4 test files.
  </verify>
  <done>4 unit test files created with 30+ test methods covering integrity, blockchain, WORM, and access log providers. All compile successfully.</done>
</task>

<task type="auto">
  <name>Task 2: Create Integration Tests, Benchmarks, and Documentation (T6.5-T6.14)</name>
  <files>
    DataWarehouse.Tests/TamperProof/WritePipelineTests.cs
    DataWarehouse.Tests/TamperProof/ReadPipelineTests.cs
    DataWarehouse.Tests/TamperProof/TamperDetectionTests.cs
    DataWarehouse.Tests/TamperProof/RecoveryTests.cs
    DataWarehouse.Tests/TamperProof/CorrectionWorkflowTests.cs
    DataWarehouse.Tests/TamperProof/DegradationStateTests.cs
    DataWarehouse.Tests/TamperProof/WormHardwareTests.cs
    DataWarehouse.Tests/TamperProof/PerformanceBenchmarkTests.cs
    Metadata/CLAUDE.md
    Metadata/TODO.md
  </files>
  <action>
    **Integration tests (T6.5-T6.11):**

    Tests use SDK types to verify the contracts and data flow patterns. Since plugin code is not directly referenced, integration tests verify the SDK-level pipeline contracts, configuration, and result types.

    **T6.5 - WritePipelineTests.cs:**
    - Test WriteContext construction with all required fields
    - Test pipeline stage ordering: Compress -> Encrypt -> Shard -> WORM -> Blockchain
    - Test SecureWriteResult success/failure factory methods
    - Test TransactionFailureBehavior enum values (Strict, AllowDegraded)
    - Test TierWriteResult construction per tier
    - Test manifest creation with all pipeline records (ContentPaddingRecord, ShardPaddingRecord, EncryptionMetadata)

    **T6.6 - ReadPipelineTests.cs:**
    - Test ReadMode enum (Fast, Verified, Audit)
    - Test SecureReadResult success/failure factory methods
    - Test IntegrityVerificationResult construction
    - Test ShardReconstructionResult with shard count and parity info
    - Test reverse pipeline ordering: Blockchain verify -> Decrypt -> Decompress -> Strip padding

    **T6.7 - TamperDetectionTests.cs:**
    - Test TamperIncidentReport construction with all fields
    - Test TamperSeverity enum values
    - Test attribution analysis: AttributionConfidence mapping
    - Test incident creation with suspect principals list
    - Test access log correlation with time window

    **T6.8 - RecoveryTests.cs:**
    - Test TamperRecoveryBehavior enum (5 values)
    - Test recovery behavior dispatch: AutoRecoverSilent, AutoRecoverWithReport, AlertAndWait, ManualOnly, FailClosed
    - Test RecoveryResult construction
    - Test WORM recovery result with version restoration

    **T6.9 - CorrectionWorkflowTests.cs:**
    - Test correction creates new version (version increment)
    - Test provenance chain linking (supersedes reference)
    - Test CorrectionResult with blockchain anchor reference
    - Test append-only semantics: original version preserved

    **T6.10 - DegradationStateTests.cs:**
    - Test InstanceDegradationState enum (6 values: Healthy, Degraded, DegradedReadOnly, DegradedNoRecovery, Offline, Corrupted)
    - Test valid state transitions (Healthy->Degraded, Degraded->DegradedReadOnly, etc.)
    - Test invalid transitions are rejected (Corrupted->Healthy without admin)
    - Test TransactionResult.DegradationState property

    **T6.11 - WormHardwareTests.cs:**
    - Test S3 Object Lock configuration: GovernanceMode vs ComplianceMode retention
    - Test Azure Immutable Blob: TimeBasedRetention and LegalHold
    - Test WormEnforcementMode.HardwareIntegrated detection pattern
    - Test WORM write result immutability

    **T6.12 - PerformanceBenchmarkTests.cs:**
    - Use `System.Diagnostics.Stopwatch` (not BenchmarkDotNet -- matches project convention)
    - Benchmark SHA-256 hash computation: 1MB, 10MB, 100MB byte arrays
    - Benchmark manifest serialization/deserialization with System.Text.Json
    - Benchmark configuration construction
    - Assert reasonable performance: hash 1MB < 100ms, serialize manifest < 50ms
    - Mark with `[Trait("Category", "Performance")]` for selective test runs

    **T6.13 - XML documentation verification:**
    - The TamperProof plugin csproj already has `<GenerateDocumentationFile>true</GenerateDocumentationFile>` and `<NoWarn>$(NoWarn);CS1591</NoWarn>`.
    - Verify existing XML docs are present on key public APIs in SDK contracts by reading files and confirming `<summary>` tags exist.
    - This is a verification step, not a test file. Document findings in the SUMMARY.

    **T6.14 - Update CLAUDE.md:**
    Add a "TamperProof Pipeline" section to `Metadata/CLAUDE.md` with:
    - Architecture overview: Three-Pillar (Live Data + Blockchain Anchor + WORM Vault)
    - Plugin structure: TamperProofPlugin.cs orchestrator, Pipeline/ (Read/WritePhaseHandlers), Services/ (8 services), Storage/ (S3/Azure WORM), Hashing/ (HashProviders)
    - Key SDK contracts: TamperProofEnums, TamperProofConfiguration, TamperProofManifest, TamperProofResults
    - 5-phase write pipeline: Validate -> Transform -> Shard -> Write -> Anchor
    - 5-phase read pipeline: Manifest -> Reconstruct -> Verify -> Reverse -> Respond
    - Configuration: structural (sealed) vs behavioral (mutable)
    - Recovery behaviors: 5 modes
    - Blockchain consensus: 3 modes (SingleWriter, RaftConsensus, ExternalAnchor)

    **Mark T6 complete in TODO.md:**
    Lines 4943-4956: Change all T6.1-T6.14 from `[ ]` to `[x]`.
  </action>
  <verify>
    Run: `dotnet build DataWarehouse.Tests/DataWarehouse.Tests.csproj --no-restore 2>&1 | tail -10`
    Expect: Build succeeded.

    Run: `ls DataWarehouse.Tests/TamperProof/` -- should show 12 files total (4 from Task 1 + 8 from Task 2).

    Run: `grep "TamperProof Pipeline" Metadata/CLAUDE.md` -- should find the new section.

    Run: `grep "T6\." Metadata/TODO.md | grep "\[ \]"` -- should return zero for the Phase T7 section (lines 4943-4956).
  </verify>
  <done>
    8 integration test + benchmark files created. CLAUDE.md updated with TamperProof architecture section. All T6.1-T6.14 marked [x] in TODO.md. Total: 12 test files, 80+ test methods.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build DataWarehouse.Tests/DataWarehouse.Tests.csproj` passes
2. 12 test files exist in DataWarehouse.Tests/TamperProof/
3. Test files use xunit [Fact]/[Theory], FluentAssertions, proper namespacing
4. Performance benchmarks use Stopwatch (not BenchmarkDotNet)
5. CLAUDE.md contains TamperProof Pipeline architecture section
6. Zero T6 sub-tasks remain marked `[ ]` in TODO.md
</verification>

<success_criteria>
- 12 test files created with 80+ test methods
- All tests compile successfully
- CLAUDE.md has comprehensive TamperProof documentation
- All 14 T6 sub-tasks marked [x] in TODO.md
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-tamperproof-pipeline/05-04-SUMMARY.md`
</output>
