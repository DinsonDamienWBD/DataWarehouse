---
phase: 22-build-safety-supply-chain
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateStorage/DataWarehouse.Plugins.UltimateStorage.csproj
  - Plugins/DataWarehouse.Plugins.UltimateDatabaseStorage/DataWarehouse.Plugins.UltimateDatabaseStorage.csproj
  - Plugins/DataWarehouse.Plugins.UltimateMultiCloud/DataWarehouse.Plugins.UltimateMultiCloud.csproj
  - Plugins/DataWarehouse.Plugins.UltimateCompression/DataWarehouse.Plugins.UltimateCompression.csproj
  - Plugins/DataWarehouse.Plugins.UltimateKeyManagement/DataWarehouse.Plugins.UltimateKeyManagement.csproj
  - Plugins/DataWarehouse.Plugins.AedsCore/DataWarehouse.Plugins.AedsCore.csproj
  - Plugins/DataWarehouse.Plugins.UltimateAccessControl/DataWarehouse.Plugins.UltimateAccessControl.csproj
  - Plugins/DataWarehouse.Plugins.UniversalObservability/DataWarehouse.Plugins.UniversalObservability.csproj
  - Plugins/DataWarehouse.Plugins.UltimateDataTransit/DataWarehouse.Plugins.UltimateDataTransit.csproj
  - Plugins/DataWarehouse.Plugins.UltimateDatabaseProtocol/DataWarehouse.Plugins.UltimateDatabaseProtocol.csproj
  - Plugins/DataWarehouse.Plugins.UniversalDashboards/DataWarehouse.Plugins.UniversalDashboards.csproj
  - Directory.Build.props
  - .config/dotnet-tools.json
autonomous: true

must_haves:
  truths:
    - "All 43+ floating package versions are pinned to exact versions (no * wildcards in any .csproj)"
    - "RestorePackagesWithLockFile is enabled in Directory.Build.props and packages.lock.json files exist"
    - "dotnet list package --vulnerable returns zero known vulnerabilities"
    - "CycloneDX generates a valid SBOM JSON file for the full solution"
    - "No floating version ranges remain anywhere in the solution"
  artifacts:
    - path: "Directory.Build.props"
      provides: "RestorePackagesWithLockFile=true for reproducible builds"
      contains: "RestorePackagesWithLockFile"
    - path: ".config/dotnet-tools.json"
      provides: "Local tool manifest with CycloneDX for SBOM generation"
      contains: "cyclonedx"
  key_links:
    - from: "Directory.Build.props RestorePackagesWithLockFile"
      to: "packages.lock.json in each project"
      via: "NuGet restore generates lock files when this property is true"
      pattern: "RestorePackagesWithLockFile.*true"
---

<objective>
Pin all floating package versions, enable NuGet lock files for reproducible builds, verify zero vulnerabilities, and generate SBOM with CycloneDX.

Purpose: Known, pinned dependency posture with zero vulnerabilities and a generated software bill of materials (SUPPLY-01, SUPPLY-02, SUPPLY-03).
Output: All .csproj files with pinned versions, packages.lock.json files, CycloneDX SBOM artifact, dotnet tool manifest.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-build-safety-supply-chain/22-RESEARCH.md

# Projects with floating versions (from research)
@Plugins/DataWarehouse.Plugins.UltimateStorage/DataWarehouse.Plugins.UltimateStorage.csproj
@Plugins/DataWarehouse.Plugins.UltimateDatabaseStorage/DataWarehouse.Plugins.UltimateDatabaseStorage.csproj
@Plugins/DataWarehouse.Plugins.UltimateMultiCloud/DataWarehouse.Plugins.UltimateMultiCloud.csproj
@Plugins/DataWarehouse.Plugins.UltimateCompression/DataWarehouse.Plugins.UltimateCompression.csproj
@Plugins/DataWarehouse.Plugins.UltimateKeyManagement/DataWarehouse.Plugins.UltimateKeyManagement.csproj
@Plugins/DataWarehouse.Plugins.AedsCore/DataWarehouse.Plugins.AedsCore.csproj
@Plugins/DataWarehouse.Plugins.UltimateAccessControl/DataWarehouse.Plugins.UltimateAccessControl.csproj
@Plugins/DataWarehouse.Plugins.UniversalObservability/DataWarehouse.Plugins.UniversalObservability.csproj
@Plugins/DataWarehouse.Plugins.UltimateDataTransit/DataWarehouse.Plugins.UltimateDataTransit.csproj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pin all floating package versions to exact resolved versions</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateStorage/DataWarehouse.Plugins.UltimateStorage.csproj
    Plugins/DataWarehouse.Plugins.UltimateDatabaseStorage/DataWarehouse.Plugins.UltimateDatabaseStorage.csproj
    Plugins/DataWarehouse.Plugins.UltimateMultiCloud/DataWarehouse.Plugins.UltimateMultiCloud.csproj
    Plugins/DataWarehouse.Plugins.UltimateCompression/DataWarehouse.Plugins.UltimateCompression.csproj
    Plugins/DataWarehouse.Plugins.UltimateKeyManagement/DataWarehouse.Plugins.UltimateKeyManagement.csproj
    Plugins/DataWarehouse.Plugins.AedsCore/DataWarehouse.Plugins.AedsCore.csproj
    Plugins/DataWarehouse.Plugins.UltimateAccessControl/DataWarehouse.Plugins.UltimateAccessControl.csproj
    Plugins/DataWarehouse.Plugins.UniversalObservability/DataWarehouse.Plugins.UniversalObservability.csproj
    Plugins/DataWarehouse.Plugins.UltimateDataTransit/DataWarehouse.Plugins.UltimateDataTransit.csproj
  </files>
  <action>
**Step 1: Discover current resolved versions**

Run `dotnet list DataWarehouse.slnx package --format json` to get the resolved versions for ALL packages in the solution. This shows what version NuGet actually resolved each floating range to.

Alternatively, for each project with floating versions, run:
```bash
dotnet list <project.csproj> package
```

**Step 2: Find and replace all floating versions**

Search ALL .csproj files in the solution for floating version patterns using:
```bash
grep -rn 'Version="[0-9]*\.\*\|Version="[0-9]*\.[0-9]*\.\*' --include="*.csproj" .
```

The research identified 43+ floating versions in these projects (listed by severity):

- **UltimateDatabaseStorage** (13 floating): Npgsql, MySqlConnector, CassandraCSharpDriver, Oracle.ManagedDataAccess.Core, MongoDB.Driver, StackExchange.Redis, Neo4j.Driver, RavenDB.Client, InfluxDB.Client, CouchbaseNetClient, IBM.Data.Db2, Aerospike.Client, LiteDB
- **UltimateStorage** (11 floating): Google.Cloud.Storage.V1, Npgsql, FluentFTP, SSH.NET, Minio, Azure.Storage.Blobs, AWSSDK.S3, Renci.SshNet, StackExchange.Redis, MongoDB.Driver, CouchbaseNetClient
- **UltimateMultiCloud** (7 floating): Azure.ResourceManager, Azure.Identity, Google.Cloud.Storage.V1, AWSSDK.S3, Alibaba.Cloud, Npgsql, StackExchange.Redis
- **UltimateCompression** (3 floating): K4os.Compression.LZ4, ZstdSharp.Port, and possibly others
- **UltimateKeyManagement** (2 floating): AWSSDK.CloudHSMV2, Konscious.Security.Cryptography.Argon2
- **AedsCore** (2 floating): Grpc.Net.Client, Google.Protobuf
- **UltimateAccessControl** (1 floating): SixLabors.ImageSharp
- **UniversalObservability** (2 floating): Prometheus-net, StatsdClient
- **UltimateDataTransit** (1 floating): Grpc.Net.Client

For each floating version (e.g., `Version="10.*"`), replace with the EXACT version that NuGet currently resolves to (from Step 1 output). For example:
- `Version="10.*"` becomes `Version="10.0.3"` (whatever `dotnet list` shows)
- `Version="53.*"` becomes `Version="53.0.1"` (whatever `dotnet list` shows)

**Step 3: Verify no floating versions remain**

After all replacements, search again:
```bash
grep -rn 'Version="[^"]*\*' --include="*.csproj" .
```

This must return ZERO matches.

**Step 4: Restore and build**

Run `dotnet restore DataWarehouse.slnx` to verify all pinned versions resolve correctly, then `dotnet build DataWarehouse.slnx --no-restore` to verify compilation still succeeds.

CRITICAL: Do NOT change the major/minor version of any package. Pin to the EXACT version NuGet was already resolving. This is a zero-behavior-change operation.

CRITICAL: Also check for floating versions in these additional locations:
- DataWarehouse.Tests/*.csproj
- DataWarehouse.Benchmarks/*.csproj
- Any other .csproj not listed above

**Step 5: Fix NuGet root-cause warnings (moved from Plan 22-02 to consolidate all package-level edits)**

Fix NU1510 (unnecessary packages) — remove these PackageReferences:
- `Plugins/DataWarehouse.Plugins.UltimateDatabaseProtocol/DataWarehouse.Plugins.UltimateDatabaseProtocol.csproj`: Remove `<PackageReference Include="System.Data.Common" .../>`
- `Plugins/DataWarehouse.Plugins.UltimateKeyManagement/DataWarehouse.Plugins.UltimateKeyManagement.csproj`: Remove `<PackageReference Include="System.Net.Http.Json" .../>`
- `Plugins/DataWarehouse.Plugins.UniversalDashboards/DataWarehouse.Plugins.UniversalDashboards.csproj`: Remove `<PackageReference Include="System.Net.WebSockets.Client" .../>` and `<PackageReference Include="System.Net.Http.Json" .../>`

Fix NU1603 (version not found) — pin to resolved versions:
- `Plugins/DataWarehouse.Plugins.UltimateDatabaseProtocol/DataWarehouse.Plugins.UltimateDatabaseProtocol.csproj`: Pin MySqlConnector to exact resolved version (e.g., `2.5.0` instead of `>=2.4.1`)
- `Plugins/DataWarehouse.Plugins.UltimateDatabaseProtocol/DataWarehouse.Plugins.UltimateDatabaseProtocol.csproj`: Pin Neo4j.Driver to exact resolved version (e.g., `6.0.0` instead of `>=5.30.0`)

**Step 6: Verify SDK dependency surface (SUPPLY-04)**

Run `dotnet list DataWarehouse.SDK/DataWarehouse.SDK.csproj package` and count direct PackageReferences. The SDK must maintain ≤6 direct PackageReferences (SUPPLY-04). Analyzer packages inherited from Directory.Build.props with `PrivateAssets=all` do NOT count as direct SDK dependencies — they are build-time only.

If the SDK exceeds 6 direct PackageReferences, document which can be removed or made conditional.
  </action>
  <verify>
1. `grep -rn 'Version="[^"]*\*' --include="*.csproj" .` returns ZERO matches
2. `dotnet restore DataWarehouse.slnx` succeeds
3. `dotnet build DataWarehouse.slnx --no-restore` succeeds (exit code 0)
  </verify>
  <done>
All 43+ floating package versions pinned to exact versions. Zero floating version patterns remain in any .csproj file. Solution restores and builds successfully with pinned versions (SUPPLY-02 satisfied).
  </done>
</task>

<task type="auto">
  <name>Task 2: Enable lock files, run vulnerability scan, and generate SBOM</name>
  <files>
    Directory.Build.props
    .config/dotnet-tools.json
  </files>
  <action>
**Step 1: Enable RestorePackagesWithLockFile**

Add `<RestorePackagesWithLockFile>true</RestorePackagesWithLockFile>` to the `<PropertyGroup>` in `Directory.Build.props`. This tells NuGet to generate `packages.lock.json` files alongside each .csproj during restore, ensuring reproducible builds.

**Step 2: Generate lock files**

Run `dotnet restore DataWarehouse.slnx` to generate `packages.lock.json` files for all 69 projects. Each project directory should now contain a `packages.lock.json`.

Verify lock files were created:
```bash
find . -name "packages.lock.json" | wc -l
```
Expected: approximately 69 files (one per project).

NOTE: Lock files should be committed to git. They ensure `dotnet restore --locked-mode` in CI produces identical dependency trees.

**Step 3: Vulnerability scan**

Run the full solution vulnerability scan:
```bash
dotnet list DataWarehouse.slnx package --vulnerable
```

Expected: "No vulnerable packages found." for all projects (verified in research). If any vulnerabilities appear:
1. Document the vulnerability (CVE, package, severity)
2. Update the package if a patched version exists
3. If no patch exists, document the risk and suppress

Also run the more comprehensive check:
```bash
dotnet list DataWarehouse.slnx package --vulnerable --include-transitive
```

This catches vulnerabilities in transitive dependencies too.

**Step 4: Install CycloneDX and generate SBOM**

Create a local dotnet tool manifest (if it doesn't exist):
```bash
dotnet new tool-manifest
```

Install CycloneDX as a local tool:
```bash
dotnet tool install CycloneDX --version 6.0.0
```

This creates/updates `.config/dotnet-tools.json` with the CycloneDX entry.

Generate SBOM for the full solution:
```bash
mkdir -p artifacts/sbom
dotnet CycloneDX DataWarehouse.slnx -o ./artifacts/sbom -f sbom.json --json
```

Verify the generated SBOM:
1. File exists at `artifacts/sbom/sbom.json`
2. File is valid JSON
3. File contains component entries (packages listed)

NOTE: Add `artifacts/` to `.gitignore` if not already present -- SBOM is a build artifact, not source code. But DO commit `.config/dotnet-tools.json` so the tool manifest is shared.

**Step 5: Final verification**

Run a complete restore with locked mode to verify lock files work:
```bash
dotnet restore DataWarehouse.slnx --locked-mode
```

This will FAIL if any package version changed since lock file generation, proving the lock files are working correctly.
  </action>
  <verify>
1. `<RestorePackagesWithLockFile>true</RestorePackagesWithLockFile>` present in Directory.Build.props
2. `packages.lock.json` files exist in project directories (check count)
3. `dotnet list DataWarehouse.slnx package --vulnerable` returns zero vulnerabilities
4. `dotnet list DataWarehouse.slnx package --vulnerable --include-transitive` returns zero vulnerabilities
5. `.config/dotnet-tools.json` exists with CycloneDX 6.0.0 entry
6. `artifacts/sbom/sbom.json` exists and is valid JSON with component entries
7. `dotnet restore DataWarehouse.slnx --locked-mode` succeeds
  </verify>
  <done>
RestorePackagesWithLockFile enabled in Directory.Build.props. Lock files generated for all projects. Zero vulnerabilities confirmed (including transitive). CycloneDX installed as local tool and SBOM generated at artifacts/sbom/sbom.json. Locked-mode restore verified (SUPPLY-01, SUPPLY-03 satisfied).
  </done>
</task>

</tasks>

<verification>
- [ ] Zero floating version patterns in any .csproj (`grep 'Version="[^"]*\*' --include="*.csproj"` returns nothing)
- [ ] `<RestorePackagesWithLockFile>true</RestorePackagesWithLockFile>` in Directory.Build.props
- [ ] `packages.lock.json` files exist (approximately 69)
- [ ] `dotnet list DataWarehouse.slnx package --vulnerable` returns zero vulnerabilities
- [ ] `dotnet list DataWarehouse.slnx package --vulnerable --include-transitive` returns zero vulnerabilities
- [ ] `.config/dotnet-tools.json` has CycloneDX 6.0.0
- [ ] `artifacts/sbom/sbom.json` is valid CycloneDX JSON
- [ ] `dotnet restore DataWarehouse.slnx --locked-mode` succeeds
- [ ] `dotnet build DataWarehouse.slnx` still succeeds after all changes
- [ ] NU1510 warnings fixed (unnecessary PackageReferences removed from 3 projects)
- [ ] NU1603 warnings fixed (versions pinned in UltimateDatabaseProtocol)
- [ ] SDK has ≤6 direct PackageReferences (SUPPLY-04)
</verification>

<success_criteria>
Plan 22-03 succeeds when:
1. All package versions are pinned to exact versions with no floating ranges (SUPPLY-02)
2. NuGet lock files exist for reproducible builds
3. Zero known vulnerabilities in direct and transitive dependencies (SUPPLY-01)
4. CycloneDX SBOM generated for full solution (SUPPLY-03)
5. Solution builds and restores successfully with all changes
6. NU1510 and NU1603 NuGet warnings fixed at root cause
7. SDK maintains ≤6 direct PackageReferences (SUPPLY-04)
</success_criteria>

<output>
After completion, create `.planning/phases/22-build-safety-supply-chain/22-03-SUMMARY.md`
</output>
