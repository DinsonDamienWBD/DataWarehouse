---
phase: 22-build-safety-supply-chain
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Directory.Build.props
  - BannedSymbols.txt
  - DataWarehouse.SDK/DataWarehouse.SDK.csproj
autonomous: true

must_haves:
  truths:
    - "Every project in the solution gets Roslyn analyzers automatically via Directory.Build.props without per-project configuration"
    - "BannedApiAnalyzers enforces a BannedSymbols.txt that blocks deprecated crypto (MD5, SHA1, DES, TripleDES) and SecureString"
    - "SonarAnalyzer.CSharp, Roslynator.Analyzers, SecurityCodeScan.VS2019, and BannedApiAnalyzers are all active on build"
    - "AnalysisLevel is set to latest-recommended with AnalysisMode All for maximum coverage"
    - "The SDK project compiles successfully with all analyzers active (no AD0001 analyzer load failures)"
  artifacts:
    - path: "Directory.Build.props"
      provides: "Centralized analyzer PackageReferences and AnalysisLevel/AnalysisMode configuration"
      contains: "PackageReference Include=\"Microsoft.CodeAnalysis.BannedApiAnalyzers\""
    - path: "BannedSymbols.txt"
      provides: "Banned API list for BannedApiAnalyzers enforcement"
      contains: "System.Security.Cryptography.MD5"
  key_links:
    - from: "Directory.Build.props"
      to: "All 69 .csproj projects"
      via: "MSBuild automatic import of Directory.Build.props in directory tree"
      pattern: "PackageReference Include=\"SonarAnalyzer.CSharp\""
    - from: "BannedSymbols.txt"
      to: "Microsoft.CodeAnalysis.BannedApiAnalyzers"
      via: "AdditionalFiles MSBuild item automatically discovered by analyzer"
      pattern: "AdditionalFiles.*BannedSymbols.txt"
---

<objective>
Install and configure Roslyn analyzers in Directory.Build.props for solution-wide enforcement, create BannedSymbols.txt, and upgrade analysis settings.

Purpose: Every compilation runs static analysis (BUILD-02), catching security vulnerabilities, code quality issues, and banned API usage across all 69 projects automatically.
Output: Updated Directory.Build.props with 4 analyzer packages + upgraded analysis settings, BannedSymbols.txt at solution root.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-build-safety-supply-chain/22-RESEARCH.md

# Current build configuration
@Directory.Build.props
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Roslyn analyzer packages and upgrade analysis settings in Directory.Build.props</name>
  <files>
    Directory.Build.props
  </files>
  <action>
Read the current `Directory.Build.props` at solution root.

Update the `<PropertyGroup>` section:
1. Change `<AnalysisLevel>latest</AnalysisLevel>` to `<AnalysisLevel>latest-recommended</AnalysisLevel>` (enables stricter rule set)
2. Add `<AnalysisMode>All</AnalysisMode>` (enables all analysis categories, not just the default subset)

Add a new `<ItemGroup>` AFTER the `</PropertyGroup>` close tag with these 4 analyzer PackageReferences. Each MUST have `<PrivateAssets>all</PrivateAssets>` and `<IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>` to ensure they are build-time only and NOT shipped with output assemblies:

```xml
<ItemGroup>
  <!-- Roslyn Analyzers: build-time only, NOT shipped with output -->
  <PackageReference Include="Microsoft.CodeAnalysis.BannedApiAnalyzers" Version="3.3.4">
    <PrivateAssets>all</PrivateAssets>
    <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
  </PackageReference>
  <PackageReference Include="SecurityCodeScan.VS2019" Version="5.6.7">
    <PrivateAssets>all</PrivateAssets>
    <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
  </PackageReference>
  <PackageReference Include="SonarAnalyzer.CSharp" Version="10.19.0.132793">
    <PrivateAssets>all</PrivateAssets>
    <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
  </PackageReference>
  <PackageReference Include="Roslynator.Analyzers" Version="4.15.0">
    <PrivateAssets>all</PrivateAssets>
    <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
  </PackageReference>
</ItemGroup>
```

IMPORTANT: Do NOT add `<TreatWarningsAsErrors>true</TreatWarningsAsErrors>` yet -- that is Plan 22-02. Adding analyzers + TreatWarningsAsErrors simultaneously will break the build with hundreds of new analyzer errors.

IMPORTANT: Do NOT change the existing `<NoWarn>` line. Keep it exactly as-is.

IMPORTANT: Do NOT add `<GenerateDocumentationFile>true</GenerateDocumentationFile>` globally yet. CS1591 (missing XML comments) warnings across 1.1M LOC would be overwhelming. The SDK already has XML docs; plugins suppress CS1591 individually.

NOTE: SecurityCodeScan.VS2019 was last updated Sep 2022 and MAY produce `AD0001` analyzer load failures on .NET 10. If it does, it will need to be removed in a follow-up fix, but try it first.
  </action>
  <verify>
Run `dotnet restore DataWarehouse.SDK/DataWarehouse.SDK.csproj` to confirm NuGet resolution succeeds for all 4 new analyzer packages.
Then run `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore` and check output:
- No `error NU*` NuGet failures
- No `AD0001` analyzer load failures
- New analyzer warnings (if any) are warnings, NOT errors (since TreatWarningsAsErrors is not yet enabled)
Capture the full build output for reference in Plan 22-02.
  </verify>
  <done>
Directory.Build.props contains 4 analyzer PackageReferences (BannedApiAnalyzers 3.3.4, SecurityCodeScan.VS2019 5.6.7, SonarAnalyzer.CSharp 10.19.0.132793, Roslynator.Analyzers 4.15.0), AnalysisLevel is latest-recommended, AnalysisMode is All. SDK project restores and builds successfully with all analyzers running.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BannedSymbols.txt and verify analyzer integration with full solution build</name>
  <files>
    BannedSymbols.txt
  </files>
  <action>
Create `BannedSymbols.txt` at the solution root (same directory as `Directory.Build.props` and `DataWarehouse.slnx`).

Content:
```text
# BannedSymbols.txt - DataWarehouse SDK
# Phase 22: Minimal initial set targeting clearly dangerous APIs
# Expand in future phases (Phase 23: Cryptographic Hygiene)

# Deprecated Cryptographic Algorithms (broken, must not use)
T:System.Security.Cryptography.MD5; Use SHA256 or higher - MD5 is cryptographically broken
T:System.Security.Cryptography.SHA1; Use SHA256 or higher - SHA1 has known collision attacks
T:System.Security.Cryptography.DES; Use AES-256 - DES key size is insufficient
T:System.Security.Cryptography.TripleDES; Use AES-256 - 3DES is deprecated by NIST

# Deprecated Security Types
T:System.Security.SecureString; Deprecated in .NET Core+ - use CryptographicOperations.ZeroMemory instead

# Insecure Random Number Generation (for security-sensitive contexts)
# NOTE: System.Random is used legitimately in non-security contexts (benchmarks, tests, simulations)
# Phase 23 will add BannedApiAnalyzers rules scoped to security-sensitive namespaces
# For now, this is documented but NOT banned globally to avoid false positives
```

BannedApiAnalyzers discovers `BannedSymbols.txt` automatically when it is an `AdditionalFiles` item. For solution-wide discovery, add this to `Directory.Build.props` INSIDE the existing `<ItemGroup>` that contains the analyzer PackageReferences:

```xml
<AdditionalFiles Include="$(MSBuildThisFileDirectory)BannedSymbols.txt" Condition="Exists('$(MSBuildThisFileDirectory)BannedSymbols.txt')" />
```

The `$(MSBuildThisFileDirectory)` resolves to the directory containing `Directory.Build.props` (solution root), ensuring all 69 projects find the same file. The `Condition` guard prevents build failures if the file is missing.

After creating the file and updating Directory.Build.props, run a full solution build:
```
dotnet build DataWarehouse.slnx --no-restore
```

Capture and review the output. Expect:
- New warnings from SonarAnalyzer (S-prefixed), Roslynator (RCS-prefixed), SecurityCodeScan (SCS-prefixed)
- Possibly RS-prefixed warnings from BannedApiAnalyzers if any code uses MD5/SHA1/DES/TripleDES/SecureString
- Possibly AD0001 from SecurityCodeScan if it fails to load on .NET 10

If SecurityCodeScan produces `AD0001` analyzer load failures:
1. Remove the SecurityCodeScan.VS2019 PackageReference from Directory.Build.props
2. Add a comment: `<!-- SecurityCodeScan.VS2019 removed: AD0001 on .NET 10, replace with Meziantou.Analyzer in future phase -->`
3. Re-build to confirm the error is gone

Record the total warning count and categories for Plan 22-02 to reference.
  </action>
  <verify>
Run `dotnet build DataWarehouse.slnx` and confirm:
1. Build SUCCEEDS (exit code 0) -- warnings are OK, errors are NOT
2. `BannedSymbols.txt` exists at solution root
3. Grep for `RS0030` in build output to confirm BannedApiAnalyzers is active (RS0030 is the banned symbol diagnostic)
4. Grep for `S` prefix warnings to confirm SonarAnalyzer is active
5. Grep for `RCS` prefix warnings to confirm Roslynator is active
6. No `AD0001` analyzer load failures (or SecurityCodeScan removed if it failed)
  </verify>
  <done>
BannedSymbols.txt exists at solution root with MD5, SHA1, DES, TripleDES, SecureString banned. Directory.Build.props includes AdditionalFiles reference. Full solution builds successfully with all analyzers running. Total warning count documented for Plan 22-02 consumption.
  </done>
</task>

<task type="auto">
  <name>Task 3: Enable XML documentation enforcement on SDK project (BUILD-04)</name>
  <files>
    DataWarehouse.SDK/DataWarehouse.SDK.csproj
  </files>
  <action>
Add `<GenerateDocumentationFile>true</GenerateDocumentationFile>` to the `<PropertyGroup>` in `DataWarehouse.SDK/DataWarehouse.SDK.csproj`.

This enables CS1591 warnings for missing XML documentation on all public types and members in the SDK project ONLY (not all 69 projects — plugins handle this individually).

The SDK already has extensive XML documentation from v1.0 (216 .cs files, 1,300 public types). Enabling this will surface any gaps.

After enabling:
1. Build the SDK: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj`
2. Capture CS1591 warnings (missing XML doc comments)
3. Fix any missing XML docs on public types/members. Focus on:
   - Public classes, interfaces, enums
   - Public methods and properties
   - Public constructors
   - For large numbers of CS1591, prioritize Contracts/ and Primitives/ directories first
4. If the SDK builds with zero CS1591 after fixes, the task is done
5. If some CS1591 remain on internal types that happen to be public for plugin access, add `<NoWarn>$(NoWarn);CS1591</NoWarn>` ONLY on specific files via `#pragma warning disable CS1591` at the top of those files with a comment explaining why

NOTE: Do NOT add GenerateDocumentationFile globally to Directory.Build.props — that would affect all 69 projects and produce thousands of CS1591 warnings. This is SDK-only per BUILD-04.
  </action>
  <verify>
Run `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` and confirm:
1. GenerateDocumentationFile is true in the .csproj
2. Zero CS1591 warnings (all public APIs documented)
3. A .xml documentation file is generated alongside the SDK DLL
  </verify>
  <done>
DataWarehouse.SDK.csproj has GenerateDocumentationFile=true. All public SDK types and members have XML documentation. SDK builds with zero CS1591 warnings (BUILD-04 satisfied).
  </done>
</task>

</tasks>

<verification>
- [ ] Directory.Build.props has 4 analyzer PackageReferences with PrivateAssets=all
- [ ] Directory.Build.props has AnalysisLevel=latest-recommended and AnalysisMode=All
- [ ] BannedSymbols.txt exists at solution root with banned crypto types
- [ ] Directory.Build.props has AdditionalFiles reference to BannedSymbols.txt
- [ ] `dotnet build DataWarehouse.slnx` succeeds (exit code 0)
- [ ] No AD0001 analyzer load failures (or SecurityCodeScan removed if incompatible)
- [ ] Analyzer warnings visible in build output (SonarAnalyzer S*, Roslynator RCS*, BannedApi RS0030)
- [ ] TreatWarningsAsErrors is NOT yet enabled (that is Plan 22-02)
</verification>

<success_criteria>
Plan 22-01 succeeds when:
1. All 69 projects in the solution automatically receive 4 Roslyn analyzer packages via Directory.Build.props (BUILD-02)
2. BannedApiAnalyzers enforces BannedSymbols.txt blocking deprecated crypto and SecureString
3. AnalysisLevel is latest-recommended with AnalysisMode All for maximum rule coverage
4. Full solution builds successfully (warnings allowed, errors are not) -- BUILD-03 partially satisfied (EnforceCodeStyleInBuild was already true)
5. Build output shows active analyzer diagnostics from multiple analyzer packages
</success_criteria>

<output>
After completion, create `.planning/phases/22-build-safety-supply-chain/22-01-SUMMARY.md`
</output>
