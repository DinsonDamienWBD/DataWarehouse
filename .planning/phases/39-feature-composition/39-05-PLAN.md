---
phase: 39-feature-composition
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.SDK/Contracts/Composition/SupplyChainAttestationTypes.cs
  - Plugins/DataWarehouse.Plugins.UltimateStorageProcessing/Composition/SupplyChainAttestationService.cs
autonomous: true

must_haves:
  truths:
    - "Every build output produces an AttestationDocument with source commit, build command, output hashes"
    - "AttestationDocument format is SLSA Level 2 compatible (in-toto Statement structure)"
    - "Attestation hash is anchored to blockchain via TamperProof composition"
    - "Verify(binaryPath) checks binary hash against attestation and returns pass/fail"
  artifacts:
    - path: "DataWarehouse.SDK/Contracts/Composition/SupplyChainAttestationTypes.cs"
      provides: "AttestationDocument, AttestationSubject, AttestationPredicate, AttestationVerificationResult types"
      contains: "record AttestationDocument"
    - path: "Plugins/DataWarehouse.Plugins.UltimateStorageProcessing/Composition/SupplyChainAttestationService.cs"
      provides: "Service that creates SLSA-compatible attestations from build outputs and anchors to blockchain"
      contains: "class SupplyChainAttestationService"
  key_links:
    - from: "SupplyChainAttestationService"
      to: "IMessageBus"
      via: "Subscribe to build.completed and publish to composition.attestation.* topics"
      pattern: "composition\\.attestation"
    - from: "AttestationDocument"
      to: "AttestationSubject"
      via: "Subjects list contains binary artifacts with SHA256 digests"
      pattern: "IReadOnlyList<AttestationSubject>"
    - from: "SupplyChainAttestationService"
      to: "TamperProof blockchain"
      via: "Message bus topic composition.attestation.anchor for blockchain anchoring"
      pattern: "composition\\.attestation\\.anchor"
---

<objective>
Build the Supply Chain Attestation framework that composes TamperProof blockchain anchoring with build strategy outputs to produce SLSA Level 2 compatible attestation documents for every build (COMP-05).

Purpose: Enable cryptographic verification that any binary was built from a specific source commit via specific build steps, with blockchain-anchored integrity proof. Follows the in-toto attestation specification for SLSA Level 2 compatibility.

Output: AttestationDocument types in SDK + SupplyChainAttestationService orchestrator in UltimateStorageProcessing plugin.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/39-feature-composition/39-RESEARCH.md

Key existing files:
@Plugins/DataWarehouse.Plugins.UltimateStorageProcessing/Strategies/Build/DotNetBuildStrategy.cs
@Plugins/DataWarehouse.Plugins.TamperProof/Services/BlockchainVerificationService.cs
@DataWarehouse.SDK/Contracts/TamperProof/IBlockchainProvider.cs
@DataWarehouse.SDK/Contracts/IMessageBus.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: SDK supply chain attestation types (SLSA Level 2 compatible)</name>
  <files>DataWarehouse.SDK/Contracts/Composition/SupplyChainAttestationTypes.cs</files>
  <action>
Create `DataWarehouse.SDK/Contracts/Composition/SupplyChainAttestationTypes.cs` in namespace `DataWarehouse.SDK.Contracts.Composition`:

Model the in-toto attestation specification used by SLSA. The types are our SDK representation of the standard, not a direct JSON schema mapping.

1. `record AttestationSubject`:
   - `string Name` (init, required) -- artifact name (e.g., "DataWarehouse.SDK.dll")
   - `IReadOnlyDictionary<string, string> Digests` (init, required) -- hash algorithm -> hex value (e.g., {"sha256": "abc123..."})
   - `long? SizeBytes` (init)

2. `record BuildStep`:
   - `string Command` (init, required) -- build command executed (e.g., "dotnet build -c Release")
   - `string? WorkingDirectory` (init)
   - `int ExitCode` (init, required)
   - `DateTimeOffset StartedAt` (init, required)
   - `DateTimeOffset CompletedAt` (init, required)
   - `IReadOnlyDictionary<string, string>? Environment` (init) -- relevant env vars (filtered, no secrets)

3. `record BuilderInfo`:
   - `string BuilderId` (init, required) -- e.g., "datawarehouse.build/dotnet@v1"
   - `string BuilderVersion` (init, required)
   - `string? BuilderPlatform` (init) -- OS/arch

4. `record SourceInfo`:
   - `string RepositoryUri` (init, required) -- e.g., "https://github.com/org/repo"
   - `string CommitHash` (init, required) -- exact commit SHA
   - `string? Branch` (init)
   - `string? Tag` (init)
   - `DateTimeOffset? CommitTimestamp` (init)

5. `record AttestationPredicate`:
   - `BuilderInfo Builder` (init, required)
   - `SourceInfo Source` (init, required)
   - `IReadOnlyList<BuildStep> BuildSteps` (init, required)
   - `DateTimeOffset BuildStartedAt` (init, required)
   - `DateTimeOffset BuildCompletedAt` (init, required)
   - `IReadOnlyDictionary<string, string>? BuildConfig` (init) -- build configuration metadata

6. `record AttestationDocument`:
   - `string AttestationId` (init, required) -- GUID
   - `string Type` (init) = "https://in-toto.io/Statement/v1" -- in-toto statement type
   - `string PredicateType` (init) = "https://slsa.dev/provenance/v1" -- SLSA provenance predicate
   - `IReadOnlyList<AttestationSubject> Subjects` (init, required) -- build outputs
   - `AttestationPredicate Predicate` (init, required) -- build provenance
   - `DateTimeOffset IssuedAt` (init, required)
   - `string DocumentHash` (init, required) -- SHA256 of the canonical JSON representation
   - `string? BlockchainAnchorId` (init) -- null if not yet anchored
   - Method `AttestationVerificationResult Verify(string binaryPath)`:
     - Reads the file at binaryPath
     - Computes SHA256 hash of the file
     - Searches Subjects for a matching digest
     - Returns AttestationVerificationResult

7. `record AttestationVerificationResult`:
   - `bool IsValid` (init, required)
   - `string? MatchedSubjectName` (init)
   - `string? ExpectedHash` (init)
   - `string? ActualHash` (init)
   - `string? ErrorMessage` (init)
   - `bool BlockchainAnchored` (init)
   - Static factory: `CreateValid(string subjectName, string hash, bool anchored)`, `CreateInvalid(string expected, string actual, string error)`

All types use `init` setters for immutability. Full XML documentation. The `Type` and `PredicateType` constants follow the SLSA specification URLs. SHA256 for all hash operations (FIPS-compliant).
  </action>
  <verify>
Run `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` -- zero errors. `grep -r "AttestationDocument" DataWarehouse.SDK/` returns matches. `grep "in-toto\|slsa" DataWarehouse.SDK/Contracts/Composition/SupplyChainAttestationTypes.cs` confirms SLSA URLs.
  </verify>
  <done>All 7 attestation types compile in SDK, follow SLSA Level 2 in-toto structure, immutable records, Verify() method validates binary against subjects, XML docs.</done>
</task>

<task type="auto">
  <name>Task 2: SupplyChainAttestationService orchestrator</name>
  <files>Plugins/DataWarehouse.Plugins.UltimateStorageProcessing/Composition/SupplyChainAttestationService.cs</files>
  <action>
Create `Plugins/DataWarehouse.Plugins.UltimateStorageProcessing/Composition/SupplyChainAttestationService.cs` in namespace `DataWarehouse.Plugins.UltimateStorageProcessing.Composition`.

Lives in UltimateStorageProcessing because that plugin owns the 9 build strategies (DotNet, TypeScript, Rust, Go, Docker, Bazel, Gradle, Maven, Npm).

Class `SupplyChainAttestationService`:
- Constructor takes `IMessageBus messageBus`
- Implements `IDisposable`
- Internal state: `ConcurrentDictionary<string, AttestationDocument> _attestations` (bounded to 50,000)

Methods:

1. `Task StartAsync(CancellationToken ct)`:
   - Subscribes to `composition.attestation.build-completed` -- receives build completion events
   - Subscribes to `composition.attestation.verify-request` -- receives verification requests
   - Subscribes to `composition.attestation.anchor-response` -- receives blockchain anchor confirmations
   - Logs startup

2. `Task StopAsync()`:
   - Disposes subscriptions

3. `async Task<AttestationDocument> CreateAttestationAsync(string builderId, string builderVersion, SourceInfo source, IReadOnlyList<BuildStep> buildSteps, IReadOnlyList<string> outputPaths, CancellationToken ct)`:
   - Computes SHA256 hash of each output file at outputPaths
   - Creates AttestationSubject for each output (name = filename, digests = {"sha256": hexHash}, size = file length)
   - Assembles AttestationPredicate with builder, source, and build steps
   - Computes DocumentHash (SHA256 of canonical JSON of the entire document, minus DocumentHash and BlockchainAnchorId)
   - Creates AttestationDocument
   - Publishes `composition.attestation.anchor` via message bus to request blockchain anchoring from TamperProof
   - Stores in _attestations
   - Publishes `composition.attestation.created` event
   - Returns document

4. Private `HandleBuildCompleted(PluginMessage msg)`:
   - Deserializes build result from message (builder ID, source info, build steps, output paths)
   - Calls CreateAttestationAsync
   - Publishes result to `composition.attestation.attestation-issued`

5. Private `HandleAnchorResponse(PluginMessage msg)`:
   - Extracts attestation ID and blockchain anchor ID from message
   - Updates attestation with BlockchainAnchorId (using record `with` expression)

6. `async Task<AttestationVerificationResult> VerifyBinaryAsync(string binaryPath, CancellationToken ct)`:
   - Computes SHA256 of the file at binaryPath
   - Searches all stored attestations for a subject with matching digest
   - If found: returns CreateValid with matched subject name, hash, and blockchain status
   - If not found: returns CreateInvalid with the actual hash and "no matching attestation found"
   - Also publishes `composition.attestation.verification-result` event

7. Private `HandleVerifyRequest(PluginMessage msg)`:
   - Extracts binaryPath from message
   - Calls VerifyBinaryAsync
   - Publishes result back via message bus

8. `Task<AttestationDocument?> GetAttestationAsync(string attestationId)` -- returns specific attestation
9. `Task<IReadOnlyList<AttestationDocument>> GetAttestationsForSourceAsync(string commitHash)` -- returns all attestations for a commit

Canonical JSON for DocumentHash: use `System.Text.Json.JsonSerializer` with `JsonSerializerOptions { WriteIndented = false, PropertyNamingPolicy = JsonNamingPolicy.CamelCase, DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull }`. Sort keys by creating a sorted intermediate dictionary.

File hashing: use `SHA256.HashData(await File.ReadAllBytesAsync(path, ct))` for files under 100MB. For larger files, use streaming hash with `IncrementalHash.CreateHash(HashAlgorithmName.SHA256)`.

All cross-plugin communication via message bus. No direct references to TamperProof plugin or build strategies. Bounded collections. Full XML documentation.
  </action>
  <verify>
Run `dotnet build Plugins/DataWarehouse.Plugins.UltimateStorageProcessing/DataWarehouse.Plugins.UltimateStorageProcessing.csproj` -- zero new errors. Verify service: `grep -c "Attestation\|SHA256\|Subscribe\|composition\\.attestation" Plugins/DataWarehouse.Plugins.UltimateStorageProcessing/Composition/SupplyChainAttestationService.cs` returns >10 matches.
  </verify>
  <done>SupplyChainAttestationService compiles, creates SLSA L2 attestations from build outputs, computes SHA256 digests, anchors to blockchain via message bus, verifies binaries against stored attestations, bounded collections.</done>
</task>

</tasks>

<verification>
1. `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` -- zero errors
2. `dotnet build Plugins/DataWarehouse.Plugins.UltimateStorageProcessing/DataWarehouse.Plugins.UltimateStorageProcessing.csproj` -- zero new errors
3. AttestationDocument.Type == "https://in-toto.io/Statement/v1" (SLSA format)
4. AttestationDocument.Verify(path) validates binary hash against subjects
5. Blockchain anchoring via message bus (no direct TamperProof reference)
6. All public types have XML documentation
</verification>

<success_criteria>
- Build completion -> Attestation creation -> Blockchain anchoring pipeline works via message bus
- SLSA Level 2 compatible format (in-toto Statement v1 type, SLSA provenance v1 predicate)
- Binary verification: compute hash, match against stored attestation subjects
- SHA256 for all hashing (FIPS-compliant)
- Zero new build errors, bounded collections, IDisposable
</success_criteria>

<output>
After completion, create `.planning/phases/39-feature-composition/39-05-SUMMARY.md`
</output>
