---
phase: 76-performance-optimization
plan: 05
type: execute
wave: 4
depends_on: ["76-04"]
files_modified:
  - DataWarehouse.SDK/Infrastructure/Policy/Performance/PolicySimulationSandbox.cs
  - DataWarehouse.SDK/Infrastructure/Policy/Performance/SimulationImpactReport.cs
autonomous: true

must_haves:
  truths:
    - "Simulation sandbox runs full workloads against hypothetical policies without affecting the live engine"
    - "Impact report covers latency, throughput, storage, and compliance projections"
    - "Before-apply comparison shows current vs hypothetical across all affected features"
    - "Sandbox uses an isolated policy store clone so live data is never modified"
  artifacts:
    - path: "DataWarehouse.SDK/Infrastructure/Policy/Performance/PolicySimulationSandbox.cs"
      provides: "Full workload replay against hypothetical policies in isolated sandbox"
      contains: "class PolicySimulationSandbox"
    - path: "DataWarehouse.SDK/Infrastructure/Policy/Performance/SimulationImpactReport.cs"
      provides: "Impact report with latency/throughput/storage/compliance projections"
      contains: "class SimulationImpactReport"
  key_links:
    - from: "DataWarehouse.SDK/Infrastructure/Policy/Performance/PolicySimulationSandbox.cs"
      to: "DataWarehouse.SDK/Infrastructure/Policy/Performance/PolicySimulator.cs"
      via: "Uses PolicySimulator for per-feature what-if analysis"
      pattern: "PolicySimulator|SimulateAsync"
    - from: "DataWarehouse.SDK/Infrastructure/Policy/Performance/PolicySimulationSandbox.cs"
      to: "DataWarehouse.SDK/Infrastructure/Policy/PolicyResolutionEngine.cs"
      via: "Creates isolated PolicyResolutionEngine with cloned store for sandbox"
      pattern: "PolicyResolutionEngine|InMemoryPolicyStore"
    - from: "DataWarehouse.SDK/Infrastructure/Policy/Performance/SimulationImpactReport.cs"
      to: "DataWarehouse.SDK/Infrastructure/Policy/Performance/CheckClassification.cs"
      via: "Reports impact per check timing category"
      pattern: "CheckTiming|CheckClassificationTable"
---

<objective>
Build the policy simulation sandbox that replays full workloads against hypothetical policies and produces an impact report (latency, throughput, storage, compliance) before applying changes to the live engine.

Purpose: PADV-02 requires running full workload simulation against hypothetical policies and reporting projected impact. This lets operators preview the effect of policy changes before committing them, preventing performance regressions and compliance violations.

Output: PolicySimulationSandbox (isolated execution environment), SimulationImpactReport (comprehensive impact analysis with before/after comparison).
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@DataWarehouse.SDK/Infrastructure/Policy/Performance/PolicySimulator.cs
@DataWarehouse.SDK/Infrastructure/Policy/Performance/FastPathPolicyEngine.cs
@DataWarehouse.SDK/Infrastructure/Policy/Performance/CheckClassification.cs
@DataWarehouse.SDK/Infrastructure/Policy/PolicyResolutionEngine.cs
@DataWarehouse.SDK/Infrastructure/Policy/InMemoryPolicyStore.cs
@DataWarehouse.SDK/Infrastructure/Policy/EffectivePolicy.cs
@DataWarehouse.SDK/Contracts/Policy/IPolicyEngine.cs
@DataWarehouse.SDK/Contracts/Policy/PolicyTypes.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: SimulationImpactReport with latency/throughput/storage/compliance projections</name>
  <files>DataWarehouse.SDK/Infrastructure/Policy/Performance/SimulationImpactReport.cs</files>
  <action>
Create `DataWarehouse.SDK/Infrastructure/Policy/Performance/SimulationImpactReport.cs` in namespace `DataWarehouse.SDK.Infrastructure.Policy.Performance` with [SdkCompatibility("6.0.0", Notes = "Phase 76: Performance Optimization (PADV-02)")]:

1. `public sealed record FeatureImpact` -- impact assessment for a single feature:
   - `required string FeatureId { get; init; }`
   - `required CheckTiming Timing { get; init; }` -- from CheckClassificationTable
   - `required IEffectivePolicy CurrentPolicy { get; init; }`
   - `required IEffectivePolicy HypotheticalPolicy { get; init; }`
   - `int IntensityDelta => HypotheticalPolicy.EffectiveIntensity - CurrentPolicy.EffectiveIntensity`
   - `bool AiAutonomyChanged => HypotheticalPolicy.EffectiveAiAutonomy != CurrentPolicy.EffectiveAiAutonomy`
   - `bool CascadeChanged => HypotheticalPolicy.AppliedCascade != CurrentPolicy.AppliedCascade`
   - `required ImpactSeverity Severity { get; init; }` -- computed by impact analyzer

2. `public enum ImpactSeverity`:
   - `None = 0` -- no change
   - `Low = 1` -- minor parameter change, same tier
   - `Medium = 2` -- intensity change >20 points or AI autonomy change
   - `High = 3` -- cascade strategy change or tier change
   - `Critical = 4` -- security downgrade (lower encryption, relaxed access control)

3. `public sealed record LatencyProjection`:
   - `required DeploymentTier CurrentTier { get; init; }`
   - `required DeploymentTier ProjectedTier { get; init; }` -- may change if overrides added/removed
   - `required double CurrentEstimatedNs { get; init; }` -- 0/20/200 based on tier
   - `required double ProjectedEstimatedNs { get; init; }`
   - `double LatencyDeltaNs => ProjectedEstimatedNs - CurrentEstimatedNs`
   - `string LatencyImpact => LatencyDeltaNs switch { 0 => "No change", < 0 => "Improved", _ => "Degraded" }`

4. `public sealed record ThroughputProjection`:
   - `required int CurrentIntensityAverage { get; init; }` -- average intensity across all features
   - `required int ProjectedIntensityAverage { get; init; }`
   - `string ThroughputImpact => ProjectedIntensityAverage switch { var p when p > CurrentIntensityAverage + 10 => "Higher overhead (more processing)", var p when p < CurrentIntensityAverage - 10 => "Lower overhead (less processing)", _ => "Minimal change" }`

5. `public sealed record StorageProjection`:
   - `required int CurrentCompressionIntensity { get; init; }` -- compression feature intensity
   - `required int ProjectedCompressionIntensity { get; init; }`
   - `required int CurrentReplicationIntensity { get; init; }` -- replication feature intensity
   - `required int ProjectedReplicationIntensity { get; init; }`
   - `string StorageImpact` -- computed: if compression down or replication up, "Increased storage usage"

6. `public sealed record ComplianceProjection`:
   - `required IReadOnlyList<string> CurrentSecurityFeatures { get; init; }` -- security features at current levels
   - `required IReadOnlyList<string> ProjectedSecurityFeatures { get; init; }`
   - `required IReadOnlyList<string> Downgrades { get; init; }` -- features where security decreased
   - `required IReadOnlyList<string> Upgrades { get; init; }` -- features where security increased
   - `bool HasSecurityDowngrade => Downgrades.Count > 0`

7. `public sealed class SimulationImpactReport`:
   - `public required DateTimeOffset GeneratedAt { get; init; }`
   - `public required string VdePath { get; init; }`
   - `public required IReadOnlyList<FeatureImpact> FeatureImpacts { get; init; }`
   - `public required LatencyProjection Latency { get; init; }`
   - `public required ThroughputProjection Throughput { get; init; }`
   - `public required StorageProjection Storage { get; init; }`
   - `public required ComplianceProjection Compliance { get; init; }`
   - `public int FeaturesAffected => FeatureImpacts.Count(f => f.IntensityDelta != 0 || f.AiAutonomyChanged || f.CascadeChanged)`
   - `public ImpactSeverity OverallSeverity => FeatureImpacts.Count > 0 ? FeatureImpacts.Max(f => f.Severity) : ImpactSeverity.None`
   - `public bool IsApproved { get; set; }` -- mutable: set by operator after review
   - `public string? ApprovalReason { get; set; }` -- mutable: operator notes

All types use `init` properties for immutability-by-convention. SimulationImpactReport is a class (not record) because it has mutable approval state.
  </action>
  <verify>dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore 2>&1 | tail -5</verify>
  <done>SimulationImpactReport compiles with latency/throughput/storage/compliance projections, ImpactSeverity classification, approval workflow</done>
</task>

<task type="auto">
  <name>Task 2: PolicySimulationSandbox with isolated workload replay</name>
  <files>DataWarehouse.SDK/Infrastructure/Policy/Performance/PolicySimulationSandbox.cs</files>
  <action>
Create `DataWarehouse.SDK/Infrastructure/Policy/Performance/PolicySimulationSandbox.cs` in namespace `DataWarehouse.SDK.Infrastructure.Policy.Performance` with [SdkCompatibility("6.0.0", Notes = "Phase 76: Performance Optimization (PADV-02)")]:

`public sealed class PolicySimulationSandbox : IDisposable`

Constructor takes:
- `IPolicyEngine liveEngine` -- the live engine to read current state from (read-only)
- `IPolicyStore liveStore` -- the live store to clone from (read-only)

Fields:
- `private readonly IPolicyEngine _liveEngine`
- `private readonly IPolicyStore _liveStore`
- `private InMemoryPolicyStore? _sandboxStore` -- isolated clone
- `private PolicyResolutionEngine? _sandboxEngine` -- isolated engine
- `private readonly SemaphoreSlim _initLock = new(1, 1)`
- `private bool _disposed`

Methods:

1. `public async Task<SimulationImpactReport> SimulateWorkloadAsync(string vdePath, IReadOnlyList<FeaturePolicy> hypotheticalPolicies, CancellationToken ct = default)`:
   - Initialize sandbox if needed (lazy init via _initLock)
   - Clone live store to sandbox: get active profile, list overrides for all features, populate _sandboxStore
   - Apply hypothetical policies to sandbox store (SetAsync for each)
   - Create sandbox PolicyResolutionEngine with _sandboxStore and InMemoryPolicyPersistence
   - For each feature, resolve BOTH current (via _liveEngine) and hypothetical (via _sandboxEngine) policies
   - Build FeatureImpact list with severity classification
   - Compute LatencyProjection: classify current and projected deployment tiers
   - Compute ThroughputProjection: average intensity across all features
   - Compute StorageProjection: specifically check "compression" and "replication" features
   - Compute ComplianceProjection: check security-category features for downgrades
   - Return assembled SimulationImpactReport

2. `public async Task<SimulationImpactReport> SimulateProfileAsync(string vdePath, OperationalProfile hypotheticalProfile, CancellationToken ct = default)`:
   - Similar to SimulateWorkloadAsync but applies an entire profile change
   - Extract all FeaturePolicy entries from hypotheticalProfile.FeaturePolicies
   - Pass to SimulateWorkloadAsync

3. `private static ImpactSeverity ClassifySeverity(FeatureImpact impact)`:
   - If no change: None
   - Security features (encryption, access_control, auth_model, key_management, fips_mode) with intensity decrease: Critical
   - Cascade strategy changed: High
   - Intensity delta > 20 or AI autonomy changed: Medium
   - Otherwise: Low

4. `private static double EstimateLatencyNs(DeploymentTier tier)`:
   - VdeOnly: 0.0
   - ContainerStop: 20.0
   - FullCascade: 200.0

5. `public void Reset()`:
   - Clear _sandboxStore, null _sandboxEngine
   - Ready for next simulation run

Dispose pattern: dispose _initLock, null out sandbox fields.

Key invariant: the sandbox NEVER modifies _liveEngine or _liveStore. All hypothetical changes go into _sandboxStore/_sandboxEngine only. The live engine is used strictly for read-only current-state comparison.
  </action>
  <verify>dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore 2>&1 | tail -5</verify>
  <done>PolicySimulationSandbox compiles, runs hypothetical policies in isolated store clone, produces SimulationImpactReport without modifying live engine</done>
</task>

</tasks>

<verification>
```bash
dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj 2>&1 | tail -3
# Must show: Build succeeded. 0 Warning(s). 0 Error(s).
```

Verify PADV-02: SimulateWorkloadAsync produces complete impact report with latency/throughput/storage/compliance
Verify isolation: sandbox uses cloned InMemoryPolicyStore, live engine/store never modified
Verify before-apply: report shows current vs hypothetical for all affected features with severity classification
</verification>

<success_criteria>
- PolicySimulationSandbox runs hypothetical policies in isolated clone
- SimulationImpactReport covers latency, throughput, storage, and compliance projections
- ImpactSeverity correctly classifies security downgrades as Critical
- Sandbox never modifies live engine or store
- Before-apply comparison available for operator review
- Zero compiler warnings
</success_criteria>

<output>
After completion, create `.planning/phases/76-performance-optimization/76-05-SUMMARY.md`
</output>
