---
phase: 46
plan: 46-05
title: "Memory & Resource Profiling"
depends_on: []
---

# Plan 46-05: Memory & Resource Profiling

## Goal
Profile memory usage and resource consumption across the DataWarehouse system. Measure plugin memory footprint, NativeKeyHandle overhead, bounded collection enforcement, and GC (garbage collection) pressure. Identify memory leaks and resource exhaustion risks.

## Approach
1. **Plugin Memory Footprint**:
   - Measure memory usage per plugin at startup (loaded but idle)
   - Measure memory usage under load (1000 operations per plugin)
   - Identify heaviest plugins (top 10 by memory usage)
   - Test plugin unload: verify memory released after unload
   - Use dotnet-counters and dotnet-gcdump for profiling
2. **NativeKeyHandle Overhead**:
   - Measure memory allocated per NativeKeyHandle instance
   - Test scenarios: 100, 1000, 10000 concurrent handles
   - Verify handles are disposed correctly (no handle leaks)
   - Measure GC pressure from handle lifecycle (allocations/sec)
   - Confirm SecureString zero-out on disposal (memory dump analysis)
3. **Bounded Collection Enforcement**:
   - Configure bounded collections: MessageBus queue (max 10000), WAL buffer (max 1GB)
   - Overflow test: submit 20000 messages, verify queue drops oldest or rejects new
   - Memory cap test: write 2GB to WAL buffer, verify enforcement at 1GB
   - Measure memory usage: should not exceed configured bounds
4. **GC Pressure Analysis**:
   - Measure GC collections (Gen0, Gen1, Gen2) during pipeline operations
   - Measure allocation rate (MB/sec) for 10MB write/read workload
   - Identify allocation hotspots (heap snapshots before/after operations)
   - Test GC behavior under sustained load (1000 writes/sec for 5 minutes)
5. **Resource Limits**:
   - Test thread pool exhaustion: max concurrent async operations
   - Test file descriptor limits: max concurrent file handles
   - Test network connection limits: max concurrent gRPC/HTTP connections
   - Measure CPU usage under load (target <80% for 4-core system)
6. **Memory Leak Detection**:
   - Run 1-hour sustained workload (continuous write/read operations)
   - Capture heap snapshots every 10 minutes
   - Analyze for growing object counts (potential leaks)
   - Verify memory stabilizes after workload stops
7. **Automation**:
   - Create profiling harness: `dw profile memory --duration 1h --workload sustained --plugins all`

## Scope
**In Scope:**
- Plugin memory footprint (idle and under load)
- NativeKeyHandle memory overhead and lifecycle
- Bounded collection enforcement (MessageBus, WAL)
- GC pressure (collections, allocation rate, hotspots)
- Resource limits (threads, file descriptors, connections, CPU)
- Memory leak detection (1-hour sustained workload)
- Metrics: MB memory, handles count, GC collections, allocations/sec, CPU %

**Out of Scope:**
- Network performance (Plan 46-04)
- Storage performance (Plan 46-02)
- Distributed systems performance (Plan 46-03)
- Pipeline performance (Plan 46-01)

## Success Criteria
- [ ] Plugin memory footprint measured (idle and under load) for all 60+ plugins
- [ ] Top 10 heaviest plugins identified
- [ ] Plugin unload verified: memory released (heap snapshot comparison)
- [ ] NativeKeyHandle overhead measured (100, 1000, 10000 handles)
- [ ] Zero NativeKeyHandle leaks detected (all handles disposed)
- [ ] Bounded collection overflow verified: MessageBus drops oldest when >10000 messages
- [ ] Bounded collection cap verified: WAL buffer stops at 1GB (does not exceed)
- [ ] GC pressure measured: Gen0/Gen1/Gen2 collections during 10MB write/read
- [ ] Allocation hotspots identified (top 5 allocation sources)
- [ ] Sustained load GC behavior documented (1000 writes/sec for 5 minutes)
- [ ] Thread pool exhaustion limit measured
- [ ] File descriptor limit measured
- [ ] Network connection limit measured
- [ ] CPU usage <80% under sustained load (4-core system)
- [ ] Memory leak test passed: heap stable after 1-hour workload
- [ ] Profiling harness implemented and tested
- [ ] Results exported to CSV/JSON format

## Output
- `46-05-profiling-results.csv`: Raw memory and resource data
- `46-05-memory-analysis.md`: Summary, hotspots, leak analysis, recommendations
- `46-05-heap-snapshots/`: Heap dumps (every 10 minutes during 1-hour test)
- `Tools/Profiling/MemoryProfiler.cs`: Profiling harness implementation
- Updated `.planning/phases/46-performance-benchmarks/STATUS.md` with results
