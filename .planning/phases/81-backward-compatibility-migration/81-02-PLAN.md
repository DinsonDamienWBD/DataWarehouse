---
phase: 81-backward-compatibility-migration
plan: 02
type: execute
wave: 2
depends_on: ["81-01"]
files_modified:
  - DataWarehouse.SDK/VirtualDiskEngine/Compatibility/VdeMigrationEngine.cs
  - DataWarehouse.SDK/VirtualDiskEngine/Compatibility/MigrationModuleSelector.cs
autonomous: true

must_haves:
  truths:
    - "'dw migrate path/to/vde.dwvd' converts a v1.0 VDE to v2.0 format"
    - "User is prompted for module selection before migration begins"
    - "Migration preserves all original data -- zero data loss"
    - "Migrated v2.0 VDE opens correctly with full v2.0 feature access"
    - "Migration can be cancelled without corrupting the source VDE"
  artifacts:
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Compatibility/VdeMigrationEngine.cs"
      provides: "End-to-end v1.0->v2.0 migration with progress reporting"
      exports: ["VdeMigrationEngine", "MigrationResult", "MigrationProgress"]
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Compatibility/MigrationModuleSelector.cs"
      provides: "Module selection logic with presets and validation"
      exports: ["MigrationModuleSelector", "MigrationModulePreset"]
  key_links:
    - from: "VdeMigrationEngine"
      to: "V1CompatibilityLayer"
      via: "Reads v1.0 superblock to get volume metadata for new VDE creation"
      pattern: "V1CompatibilityLayer.*ReadV1Superblock"
    - from: "VdeMigrationEngine"
      to: "VdeCreator + ExtentAwareVdeCopy"
      via: "Creates new v2.0 VDE then copies data blocks extent-aware"
      pattern: "VdeCreator\\.CreateVdeAsync|ExtentAwareVdeCopy"
    - from: "MigrationModuleSelector"
      to: "ModuleId + ModuleRegistry"
      via: "Maps preset names to module manifest bitmasks"
      pattern: "ModuleId\\.|ModuleRegistry"
---

<objective>
Implement the `dw migrate` conversion engine (MIGR-02): v1.0 to v2.0 VDE format migration with interactive module selection, extent-aware data copy, and verification.

Purpose: Provide a safe, non-destructive migration path from v1.0 to v2.0. The source VDE is never modified. A new v2.0 VDE is created alongside it, data is copied extent-aware, and the result is verified before the user is informed of success.

Output: Migration engine and module selector in the Compatibility namespace.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/81-backward-compatibility-migration/81-01-SUMMARY.md
@DataWarehouse.SDK/VirtualDiskEngine/Format/VdeCreator.cs
@DataWarehouse.SDK/VirtualDiskEngine/ModuleManagement/ExtentAwareVdeCopy.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/ModuleDefinitions.cs
@DataWarehouse.SDK/VirtualDiskEngine/Compatibility/VdeFormatDetector.cs
@DataWarehouse.SDK/VirtualDiskEngine/Compatibility/V1CompatibilityLayer.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: MigrationModuleSelector with presets</name>
  <files>DataWarehouse.SDK/VirtualDiskEngine/Compatibility/MigrationModuleSelector.cs</files>
  <action>
Create `DataWarehouse.SDK/VirtualDiskEngine/Compatibility/MigrationModuleSelector.cs` with:

1. **`MigrationModulePreset`** enum: `Standard`, `Minimal`, `Analytics`, `HighSecurity`, `Custom`.
   - Each preset maps to a predefined set of ModuleId values.

2. **`MigrationModuleSelector`** sealed class with `[SdkCompatibility("6.0.0", ...)]`:
   - `GetPresetModules(MigrationModulePreset preset)` -> `IReadOnlyList<ModuleId>`:
     - `Standard`: Security, Compression, Integrity, Snapshot (the 4-module standard profile from Phase 71-06 manifest 0x00001C01: bits 0,10,11,12)
     - `Minimal`: empty list (no modules, bare v2.0 container)
     - `Analytics`: Intelligence, Compression, Snapshot, Query (manifest 0x00003404: bits 2,10,12,13)
     - `HighSecurity`: Security, Compliance, Integrity, Snapshot, Privacy (bits 0,1,11,12,14)
     - `Custom`: returns empty list (caller provides explicit modules)
   - `GetPresetDescription(MigrationModulePreset preset)` -> `string`: human-readable description of what each preset enables.
   - `BuildManifest(IEnumerable<ModuleId> modules)` -> `uint`: OR together (1u << (int)moduleId) for each module.
   - `ValidateModuleSelection(IReadOnlyList<ModuleId> modules)` -> `(bool Valid, string? Error)`:
     - Check for duplicates.
     - Check all values are defined enum values via Enum.IsDefined.
     - Warn (not error) if Integrity is selected without Security.
   - `GetAvailablePresets()` -> `IReadOnlyList<(MigrationModulePreset Preset, string Description, int ModuleCount)>`: lists all presets with descriptions for interactive prompts.

Use FrozenDictionary for preset-to-modules mapping (same pattern as Phase 76-04 CheckClassificationTable). Use inline static init via builder method (S3963 pattern).
  </action>
  <verify>Solution builds: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore -c Release -v q` succeeds with zero errors.</verify>
  <done>MigrationModuleSelector provides 5 named presets, manifest building, and validation for module selection during migration.</done>
</task>

<task type="auto">
  <name>Task 2: VdeMigrationEngine with progress and verification</name>
  <files>DataWarehouse.SDK/VirtualDiskEngine/Compatibility/VdeMigrationEngine.cs</files>
  <action>
Create `DataWarehouse.SDK/VirtualDiskEngine/Compatibility/VdeMigrationEngine.cs` with:

1. **`MigrationProgress`** readonly record struct:
   - `MigrationPhase Phase` (enum: Detecting, ReadingSource, CreatingDestination, CopyingData, VerifyingResult, Complete, Failed)
   - `double PercentComplete` (0.0 to 100.0)
   - `string StatusMessage`
   - `long BytesCopied`
   - `long TotalEstimatedBytes`
   - `TimeSpan Elapsed`

2. **`MigrationResult`** readonly record struct:
   - `bool Success`
   - `string? ErrorMessage`
   - `string SourcePath`
   - `string DestinationPath`
   - `DetectedFormatVersion SourceVersion`
   - `uint NewModuleManifest`
   - `long BlocksCopied`
   - `long BlocksSkipped`
   - `TimeSpan Duration`

3. **`VdeMigrationEngine`** sealed class:
   - Constructor: `VdeMigrationEngine(Action<MigrationProgress>? onProgress = null)`
   - `MigrateAsync(string sourcePath, string destinationPath, IReadOnlyList<ModuleId> selectedModules, CancellationToken ct)` -> `Task<MigrationResult>`:
     **Step 1 - Detect**: Use VdeFormatDetector.DetectAsync to confirm source is v1.0. Reject if v2.0 (already current), unknown, or not DWVD.
     **Step 2 - Read source**: Open source stream read-only. Use V1CompatibilityLayer to read v1.0 superblock. Extract blockSize, totalBlocks, volumeUuid, volumeLabel.
     **Step 3 - Create destination**: Build module manifest via MigrationModuleSelector.BuildManifest. Create VdeCreationProfile with source's blockSize and totalBlocks plus the new manifest. Call VdeCreator.CreateVdeAsync for the destination path.
     **Step 4 - Copy data**: Open source stream for reading. Copy all data blocks from source to destination using raw block copy (NOT ExtentAwareVdeCopy which expects v2.0 source with bitmap region). Use a simple sequential block copy loop with BatchBlockCount=16 and ArrayPool buffers. Skip blocks 0-9 in destination (metadata already created by VdeCreator). Report progress via onProgress callback every 100 batches.
     **Step 5 - Update superblock**: Read the newly created destination superblock. Update volumeLabel from source. Update volumeUuid from source (preserve identity). Write back to blocks 0 and 4 (primary + mirror).
     **Step 6 - Verify**: Use DwvdContentDetector.DetectAsync on destination. Confirm IsDwvd=true, MajorVersion=2. Use VdeFormatDetector to double-check.
     If any step fails: delete destination file if it exists, return MigrationResult with Success=false and error message. Source is NEVER modified.
   - `MigrateWithPresetAsync(string sourcePath, string destinationPath, MigrationModulePreset preset, CancellationToken ct)` -> `Task<MigrationResult>`: convenience wrapper that resolves preset to modules then calls MigrateAsync.
   - `EstimateMigrationAsync(string sourcePath, CancellationToken ct)` -> `Task<(long EstimatedBytes, DetectedFormatVersion Version)>`: quick estimation without performing migration.

Thread safety: NOT thread-safe (one migration at a time per instance). Use ArrayPool for all buffers. Use Stopwatch for Duration. Follow error patterns from ExtentAwareVdeCopy (CopyResult.Failed style).

Important: The source file is read-only throughout. If cancellation is requested, clean up the partial destination file. Use try/finally to ensure cleanup.
  </action>
  <verify>Solution builds: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore -c Release -v q` succeeds with zero errors.</verify>
  <done>VdeMigrationEngine performs complete v1.0->v2.0 migration: detect, read, create, copy, verify -- source never modified, destination verified as valid v2.0.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore -c Release -v q` passes with zero errors
- Both new files exist under `DataWarehouse.SDK/VirtualDiskEngine/Compatibility/`
- MigrationModuleSelector.GetPresetModules(Standard) returns 4 modules matching manifest 0x00001C01
- VdeMigrationEngine.MigrateAsync rejects v2.0 source files (already current format)
</verification>

<success_criteria>
- MIGR-02 satisfied: `dw migrate path/to/vde.dwvd` converts v1.0 to v2.0
- Module selection supported via presets (Standard/Minimal/Analytics/HighSecurity) and custom lists
- Source VDE is NEVER modified (read-only access throughout)
- Destination verified as valid v2.0 before reporting success
- Cancellation cleans up partial destination without corrupting source
</success_criteria>

<output>
After completion, create `.planning/phases/81-backward-compatibility-migration/81-02-SUMMARY.md`
</output>
