---
phase: 81-backward-compatibility-migration
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.SDK/Infrastructure/Policy/Compatibility/V5ConfigMigrator.cs
  - DataWarehouse.SDK/Infrastructure/Policy/Compatibility/PolicyCompatibilityGate.cs
  - DataWarehouse.SDK/Infrastructure/Intelligence/AiAutonomyDefaults.cs
autonomous: true

must_haves:
  truths:
    - "Existing v5.0 config files are auto-read and converted to VDE-level policies on first open"
    - "Multi-level policy behavior is inactive unless an admin explicitly configures it"
    - "PolicyEngine is transparent for existing deployments -- single-level behaves identically to pre-v6.0"
    - "AI autonomy defaults to ManualOnly for all 94 features -- no AI actions without explicit config"
  artifacts:
    - path: "DataWarehouse.SDK/Infrastructure/Policy/Compatibility/V5ConfigMigrator.cs"
      provides: "v5.0 ConfigurationItem to VDE-level FeaturePolicy conversion"
      exports: ["V5ConfigMigrator", "V5MigrationResult"]
    - path: "DataWarehouse.SDK/Infrastructure/Policy/Compatibility/PolicyCompatibilityGate.cs"
      provides: "Multi-level opt-in gate that blocks cascade below VDE level until enabled"
      exports: ["PolicyCompatibilityGate"]
    - path: "DataWarehouse.SDK/Infrastructure/Intelligence/AiAutonomyDefaults.cs"
      provides: "ManualOnly defaults for all 94 features at all 5 policy levels"
      exports: ["AiAutonomyDefaults"]
  key_links:
    - from: "V5ConfigMigrator"
      to: "IPolicyStore + IPolicyPersistence"
      via: "Writes converted policies to store via SetAsync at PolicyLevel.VDE"
      pattern: "IPolicyStore.*SetAsync|PolicyLevel\\.VDE"
    - from: "PolicyCompatibilityGate"
      to: "PolicyResolutionEngine"
      via: "Wraps resolution to clamp all queries to VDE level when multi-level is disabled"
      pattern: "PolicyLevel\\.VDE|IsMultiLevelEnabled"
    - from: "AiAutonomyDefaults"
      to: "AiAutonomyConfiguration"
      via: "Populates all 470 config points with ManualOnly"
      pattern: "AiAutonomyLevel\\.ManualOnly|SetAutonomy"
---

<objective>
Implement v5.0 config auto-migration, multi-level opt-in gate, and ManualOnly AI defaults (MIGR-03, MIGR-04, MIGR-05, MIGR-06).

Purpose: Existing deployments must experience zero behavioral change after upgrading to v6.0. Config files are silently migrated to VDE-level policies, multi-level cascade is dormant until explicitly enabled, and AI takes no autonomous actions by default.

Output: Config migrator, compatibility gate, and AI defaults in the Policy/Compatibility and Intelligence namespaces.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@DataWarehouse.SDK/Infrastructure/Policy/PolicyResolutionEngine.cs
@DataWarehouse.SDK/Infrastructure/Intelligence/AiAutonomyConfiguration.cs
@DataWarehouse.SDK/Contracts/Policy/PolicyEnums.cs
@DataWarehouse.SDK/Primitives/Configuration/ConfigurationItem.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: V5ConfigMigrator and PolicyCompatibilityGate</name>
  <files>DataWarehouse.SDK/Infrastructure/Policy/Compatibility/V5ConfigMigrator.cs, DataWarehouse.SDK/Infrastructure/Policy/Compatibility/PolicyCompatibilityGate.cs</files>
  <action>
**File 1: `V5ConfigMigrator.cs`** in `DataWarehouse.SDK.Infrastructure.Policy.Compatibility`:

`[SdkCompatibility("6.0.0", Notes = "Phase 81: v5.0 config migration (MIGR-03)")]`

1. **`V5MigrationResult`** readonly record struct:
   - `int PoliciesMigrated` -- count of configs successfully converted
   - `int PoliciesSkipped` -- count of configs that had no policy equivalent
   - `IReadOnlyList<string> MigratedFeatureIds` -- which features were migrated
   - `IReadOnlyList<string> Warnings` -- non-fatal issues during migration
   - `bool AlreadyMigrated` -- true if migration marker already existed (idempotent)

2. **`V5ConfigMigrator`** sealed class:
   - Constructor: `V5ConfigMigrator(IPolicyStore store, IPolicyPersistence persistence)`
   - `MigrateFromConfigAsync(IReadOnlyDictionary<string, object> v5Config, string vdePath, CancellationToken ct)` -> `Task<V5MigrationResult>`:
     - Check for migration marker: query store for a sentinel policy with featureId "__v5_migration_complete" at PolicyLevel.VDE. If found, return AlreadyMigrated=true (idempotent).
     - Iterate v5Config entries. For each known feature key (map of ~20 well-known v5.0 config keys to feature IDs: "encryption_enabled"->"encryption", "compression_level"->"compression", "replication_factor"->"replication", "access_control_model"->"access_control", "audit_logging"->"compliance", etc.):
       - Convert value to FeaturePolicy: IntensityLevel derived from v5 value (bool true=80, int=direct, string parsed), Cascade=Inherit (single-level default), AiAutonomy=ManualOnly.
       - Store via `store.SetAsync(featureId, PolicyLevel.VDE, vdePath, policy, ct)`.
     - Write migration marker sentinel.
     - Persist via `persistence.SaveAllAsync(ct)`.
     - Return result with counts and feature IDs.
   - `GetKnownV5ConfigKeys()` -> `IReadOnlyDictionary<string, string>`: returns the v5-key-to-featureId mapping (useful for tooling/diagnostics).
   - Private static `ConvertV5Value(object value)` -> `int` intensity: bool true=80/false=0, int clamped 0-100, string parsed or default 50.

Use FrozenDictionary for the v5-key-to-featureId mapping. Mark with `[SdkCompatibility]`.

**File 2: `PolicyCompatibilityGate.cs`** in same namespace:

`[SdkCompatibility("6.0.0", Notes = "Phase 81: Multi-level opt-in gate (MIGR-04, MIGR-05)")]`

**`PolicyCompatibilityGate`** sealed class implementing `IPolicyEngine` (decorator pattern):
- Constructor: `PolicyCompatibilityGate(IPolicyEngine inner, bool multiLevelEnabled = false)`
- `bool IsMultiLevelEnabled { get; private set; }` -- starts false by default
- `EnableMultiLevel()` -- sets IsMultiLevelEnabled = true (admin opt-in)
- `DisableMultiLevel()` -- sets IsMultiLevelEnabled = false (revert to single-level)

Decorator behavior for `ResolveAsync`:
- If `IsMultiLevelEnabled == false`: Rewrite the incoming `PolicyResolutionContext.Path` to contain only the first segment (VDE name), effectively clamping all resolution to VDE level. This makes the cascade engine behave identically to a flat/single-level system.
- If `IsMultiLevelEnabled == true`: Pass through to inner engine unmodified.

Decorator behavior for all other IPolicyEngine methods (`ResolveAllAsync`, `GetActiveProfileAsync`, `SetActiveProfileAsync`, `SimulateAsync`):
- Pass through to inner engine. SimulateAsync also applies the path clamping when multi-level is disabled.

This approach means MIGR-04 (no multi-level unless admin configures) and MIGR-05 (PolicyEngine transparent) are achieved without modifying PolicyResolutionEngine itself.

Private helper: `ClampToVdeLevel(string path)` -> extracts first path segment, returns "/{vdeName}".
  </action>
  <verify>Solution builds: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore -c Release -v q` succeeds with zero errors.</verify>
  <done>V5ConfigMigrator converts v5.0 config entries to VDE-level policies idempotently; PolicyCompatibilityGate blocks multi-level cascade by default, making PolicyEngine transparent for existing deployments.</done>
</task>

<task type="auto">
  <name>Task 2: AiAutonomyDefaults with ManualOnly for all 94 features</name>
  <files>DataWarehouse.SDK/Infrastructure/Intelligence/AiAutonomyDefaults.cs</files>
  <action>
Create `DataWarehouse.SDK/Infrastructure/Intelligence/AiAutonomyDefaults.cs` with:

`[SdkCompatibility("6.0.0", Notes = "Phase 81: AI ManualOnly defaults (MIGR-06)")]`

**`AiAutonomyDefaults`** static class:

1. `ApplyManualOnlyDefaults(AiAutonomyConfiguration config)` -> `void`:
   - Iterate all 5 PolicyLevel values.
   - For each level, call `config.SetAutonomyForLevel(level, AiAutonomyLevel.ManualOnly)`.
   - This sets all 94*5 = 470 config points to ManualOnly.

2. `CreateManualOnlyConfiguration()` -> `AiAutonomyConfiguration`:
   - Create new `AiAutonomyConfiguration(AiAutonomyLevel.ManualOnly)` (ManualOnly as default level).
   - Call `ApplyManualOnlyDefaults(config)` to also explicitly set all known features.
   - Return config.

3. `IsFullyManualOnly(AiAutonomyConfiguration config)` -> `bool`:
   - Iterate all known features (from CheckClassificationTable via all CheckTiming values) and all 5 PolicyLevel values.
   - Return true only if every single config point returns ManualOnly.
   - This is the verification method: after applying defaults, `IsFullyManualOnly` must return true.

4. `GetDefaultAutonomyLevel()` -> `AiAutonomyLevel`: returns `AiAutonomyLevel.ManualOnly`. Single source of truth for the v6.0 default.

5. `const string DefaultJustification = "AI autonomy defaults to ManualOnly per MIGR-06. No AI actions occur without explicit administrator configuration."` -- human-readable justification for audit logs.

This class is pure (no I/O, no mutable state). It provides the factory and verification for MIGR-06. The existing `AiAutonomyConfiguration` constructor already accepts a default level, but `AiAutonomyDefaults` makes the v6.0 policy explicit and verifiable: every one of the 94 features at every policy level starts at ManualOnly.
  </action>
  <verify>Solution builds: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore -c Release -v q` succeeds with zero errors.</verify>
  <done>AiAutonomyDefaults guarantees ManualOnly for all 470 config points; IsFullyManualOnly provides verification; no AI actions occur without explicit admin configuration.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore -c Release -v q` passes with zero errors
- All three new files exist in their respective directories
- V5ConfigMigrator maps at least 20 v5.0 config keys to feature IDs
- PolicyCompatibilityGate.IsMultiLevelEnabled defaults to false
- AiAutonomyDefaults.CreateManualOnlyConfiguration() produces config where IsFullyManualOnly() returns true
</verification>

<success_criteria>
- MIGR-03: v5.0 configs auto-migrated to VDE-level policies via V5ConfigMigrator
- MIGR-04: Multi-level policy inactive by default via PolicyCompatibilityGate (multiLevelEnabled=false)
- MIGR-05: PolicyEngine transparent for existing deployments (VDE-level clamping makes cascade invisible)
- MIGR-06: AI is ManualOnly for all 94 features at all 5 policy levels
- All four requirements verifiable via code: IsMultiLevelEnabled==false, IsFullyManualOnly()==true, AlreadyMigrated idempotency
</success_criteria>

<output>
After completion, create `.planning/phases/81-backward-compatibility-migration/81-03-SUMMARY.md`
</output>
