---
phase: 81-backward-compatibility-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.SDK/VirtualDiskEngine/Compatibility/VdeFormatDetector.cs
  - DataWarehouse.SDK/VirtualDiskEngine/Compatibility/CompatibilityModeContext.cs
  - DataWarehouse.SDK/VirtualDiskEngine/Compatibility/V1CompatibilityLayer.cs
autonomous: true

must_haves:
  truths:
    - "A v1.0 VDE file is auto-detected by reading its first block and recognizing MajorVersion==1"
    - "v1.0 VDE opens in read-only compatibility mode with no data loss or errors"
    - "v2.0 VDE opens normally with no compatibility overhead"
    - "Unknown or corrupted format is rejected with a descriptive error, not a crash"
  artifacts:
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Compatibility/VdeFormatDetector.cs"
      provides: "Format version detection and routing"
      exports: ["VdeFormatDetector", "DetectedFormatVersion"]
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Compatibility/CompatibilityModeContext.cs"
      provides: "Compat mode state: read-only flag, degraded feature set, version info"
      exports: ["CompatibilityModeContext"]
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Compatibility/V1CompatibilityLayer.cs"
      provides: "v1.0 superblock parsing, graceful degradation for missing v2.0 regions"
      exports: ["V1CompatibilityLayer"]
  key_links:
    - from: "VdeFormatDetector"
      to: "MagicSignature + DwvdContentDetector"
      via: "Reads first block, uses MagicSignature.Deserialize to check MajorVersion"
      pattern: "MagicSignature\\.Deserialize"
    - from: "V1CompatibilityLayer"
      to: "CompatibilityModeContext"
      via: "Creates context with ReadOnly=true, version info, degraded feature list"
      pattern: "CompatibilityModeContext"
---

<objective>
Implement v1.0 VDE auto-detection and compatibility mode opening (MIGR-01).

Purpose: Existing v1.0 deployments must continue working without any administrator action. When a v1.0 format VDE is opened, the system auto-detects the format version, enters a read-only compatibility mode, and provides access to all data without forced migration.

Output: Three files in a new `Compatibility/` namespace providing format detection, compatibility context, and v1.0 interpretation.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@DataWarehouse.SDK/VirtualDiskEngine/Format/MagicSignature.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/FormatConstants.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/SuperblockV2.cs
@DataWarehouse.SDK/VirtualDiskEngine/FileExtension/DwvdContentDetector.cs
@DataWarehouse.SDK/VirtualDiskEngine/Identity/FormatFingerprintValidator.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: VdeFormatDetector and DetectedFormatVersion</name>
  <files>DataWarehouse.SDK/VirtualDiskEngine/Compatibility/VdeFormatDetector.cs</files>
  <action>
Create `DataWarehouse.SDK/VirtualDiskEngine/Compatibility/VdeFormatDetector.cs` with:

1. **`DetectedFormatVersion`** readonly record struct:
   - `byte MajorVersion` (1 or 2)
   - `byte MinorVersion`
   - `ushort SpecRevision`
   - `bool IsV1` => MajorVersion == 1
   - `bool IsV2` => MajorVersion == 2
   - `bool IsUnknown` => MajorVersion != 1 && MajorVersion != 2
   - `string FormatDescription` computed property ("DWVD v{Major}.{Minor} rev{Spec}")

2. **`VdeFormatDetector`** static class with `[SdkCompatibility("6.0.0", Notes = "Phase 81: ...")]`:
   - `DetectFromBytes(ReadOnlySpan<byte> data)` -> `DetectedFormatVersion?`:
     - Needs at least 16 bytes (MagicSignatureSize).
     - Read first 4 bytes as big-endian uint32; must equal 0x44575644 ("DWVD") or return null.
     - Read byte[4] as MajorVersion, byte[5] as MinorVersion, bytes[6-7] as SpecRevision (LE).
     - For v2.0: additionally validate namespace anchor (bytes 8-12 = "dw://") via MagicSignature.Deserialize + Validate(). If namespace invalid, still return the version but mark via a `bool NamespaceValid` field on DetectedFormatVersion.
     - For v1.0: namespace anchor may not exist (v1.0 format predates it); skip namespace check.
     - Return `new DetectedFormatVersion(major, minor, specRev, namespaceValid)`.
   - `DetectFromStream(Stream stream)` -> `DetectedFormatVersion?`: reads first 16 bytes, delegates to DetectFromBytes.
   - `DetectAsync(string filePath, CancellationToken ct)` -> `Task<DetectedFormatVersion?>`: opens file async, reads first 16 bytes, delegates.

Use `BinaryPrimitives` for all reads (no BitConverter). Use `stackalloc` for the 16-byte read buffer in sync overloads. Follow the same patterns as `DwvdContentDetector` (sync/async overloads, null-check arguments, FileStream with bufferSize and useAsync).
  </action>
  <verify>Solution builds: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore -c Release -v q` succeeds with zero errors.</verify>
  <done>VdeFormatDetector can distinguish v1.0, v2.0, and unknown formats from raw bytes, streams, or file paths.</done>
</task>

<task type="auto">
  <name>Task 2: CompatibilityModeContext and V1CompatibilityLayer</name>
  <files>DataWarehouse.SDK/VirtualDiskEngine/Compatibility/CompatibilityModeContext.cs, DataWarehouse.SDK/VirtualDiskEngine/Compatibility/V1CompatibilityLayer.cs</files>
  <action>
**File 1: `CompatibilityModeContext.cs`**

Create sealed class `CompatibilityModeContext` in `DataWarehouse.SDK.VirtualDiskEngine.Compatibility`:
- `DetectedFormatVersion SourceVersion { get; }` -- version of the opened VDE
- `bool IsReadOnly { get; }` -- true for v1.0 compat mode (writes disabled)
- `bool IsCompatibilityMode { get; }` -- true when not running in native v2.0 mode
- `IReadOnlyList<string> DegradedFeatures { get; }` -- features unavailable in compat mode (e.g., "ModuleManagement", "PolicyCascade", "ExtentBasedAllocation", "InodeV2Fields")
- `IReadOnlyList<string> AvailableFeatures { get; }` -- features still functional (e.g., "DataRead", "MetadataRead", "BasicSearch", "Export")
- `string MigrationHint { get; }` -- user-facing message: "Run 'dw migrate <path>' to convert to v2.0 format for full feature access."
- Static factory: `ForV1(DetectedFormatVersion version)` returns context with ReadOnly=true, CompatibilityMode=true, populated degraded/available lists.
- Static factory: `ForV2Native(DetectedFormatVersion version)` returns context with ReadOnly=false, CompatibilityMode=false, empty degraded list.
- Static factory: `ForUnknown(DetectedFormatVersion version)` throws `VdeFormatException` with descriptive message.

**File 2: `V1CompatibilityLayer.cs`**

Create sealed class `V1CompatibilityLayer` in same namespace:
- Constructor takes `Stream sourceStream, int blockSize` (validated same as ExtentAwareVdeCopy).
- `ReadV1SuperblockAsync(CancellationToken ct)` -> `Task<V1SuperblockSummary>`:
  - Reads first block from stream.
  - Parses v1.0 superblock layout: magic (4 bytes), version (2 bytes), blockSize (4 bytes at offset 0x08), totalBlocks (8 bytes at offset 0x0C), volumeUuid (16 bytes at offset 0x14), volumeLabel (64 bytes at offset 0x24). These offsets represent a plausible v1.0 layout.
  - Returns `V1SuperblockSummary` readonly record struct with: VolumeUuid, VolumeLabel (string), TotalBlocks, BlockSize, MajorVersion, MinorVersion.
- `GetCompatibilityContext()` -> `CompatibilityModeContext`: creates ForV1 context.
- `EstimateDataSizeBytes()` -> `long`: totalBlocks * blockSize for migration size estimation.

`V1SuperblockSummary` readonly record struct defined in same file.

Both classes: use `[SdkCompatibility("6.0.0", ...)]`, BinaryPrimitives for reads, ArrayPool for buffer management, async FileStream patterns matching ExtentAwareVdeCopy.
  </action>
  <verify>Solution builds: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore -c Release -v q` succeeds with zero errors.</verify>
  <done>CompatibilityModeContext provides complete compat state for v1.0 VDEs; V1CompatibilityLayer can parse v1.0 superblocks and expose data for migration tooling.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore -c Release -v q` passes with zero errors
- All three new files exist under `DataWarehouse.SDK/VirtualDiskEngine/Compatibility/`
- `VdeFormatDetector.DetectFromBytes` returns IsV1=true for a buffer with MajorVersion=1 and IsV2=true for MajorVersion=2
- `CompatibilityModeContext.ForV1()` returns ReadOnly=true with degraded feature list
</verification>

<success_criteria>
- MIGR-01 satisfied: v1.0 format VDEs are auto-detected and opened in read-only compatibility mode
- No data loss: v1.0 data is accessible via V1CompatibilityLayer
- No forced migration: compat mode provides read access without requiring conversion
- v2.0 VDEs are unaffected (ForV2Native path has zero overhead)
</success_criteria>

<output>
After completion, create `.planning/phases/81-backward-compatibility-migration/81-01-SUMMARY.md`
</output>
