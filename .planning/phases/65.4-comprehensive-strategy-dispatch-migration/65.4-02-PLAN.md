---
phase: 65.4-comprehensive-strategy-dispatch-migration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.SDK/Contracts/Hierarchy/DataPipeline/StoragePluginBase.cs
  - DataWarehouse.SDK/Contracts/Hierarchy/DataPipeline/ReplicationPluginBase.cs
  - DataWarehouse.SDK/Contracts/Hierarchy/DataPipeline/DataTransitPluginBase.cs
  - DataWarehouse.SDK/Contracts/Hierarchy/DataPipeline/IntegrityPluginBase.cs
autonomous: true

must_haves:
  truths:
    - "StoragePluginBase has typed StrategyRegistry<IStorageStrategy> and StoreWithStrategyAsync/RetrieveWithStrategyAsync domain ops"
    - "ReplicationPluginBase has typed StrategyRegistry<IReplicationStrategy> and ReplicateWithStrategyAsync domain op"
    - "DataTransitPluginBase has typed StrategyRegistry<IDataTransitStrategy> and TransferWithStrategyAsync domain op"
    - "IntegrityPluginBase has typed StrategyRegistry<IIntegrityStrategy> and VerifyWithStrategyAsync/ComputeHashWithStrategyAsync domain ops"
  artifacts:
    - path: "DataWarehouse.SDK/Contracts/Hierarchy/DataPipeline/StoragePluginBase.cs"
      provides: "Storage strategy dispatch infrastructure"
      contains: "StrategyRegistry<IStorageStrategy>"
    - path: "DataWarehouse.SDK/Contracts/Hierarchy/DataPipeline/ReplicationPluginBase.cs"
      provides: "Replication strategy dispatch infrastructure"
      contains: "StrategyRegistry<IReplicationStrategy>"
    - path: "DataWarehouse.SDK/Contracts/Hierarchy/DataPipeline/DataTransitPluginBase.cs"
      provides: "Transit strategy dispatch infrastructure"
      contains: "StrategyRegistry<IDataTransitStrategy>"
    - path: "DataWarehouse.SDK/Contracts/Hierarchy/DataPipeline/IntegrityPluginBase.cs"
      provides: "Integrity strategy dispatch infrastructure"
      contains: "ComputeHashWithStrategyAsync"
  key_links:
    - from: "DataWarehouse.SDK/Contracts/Hierarchy/DataPipeline/StoragePluginBase.cs"
      to: "DataWarehouse.SDK/Contracts/StrategyRegistry.cs"
      via: "typed registry instantiation"
      pattern: "new StrategyRegistry<IStorageStrategy>"
    - from: "DataWarehouse.SDK/Contracts/Hierarchy/DataPipeline/ReplicationPluginBase.cs"
      to: "DataWarehouse.SDK/Contracts/StrategyRegistry.cs"
      via: "typed registry instantiation"
      pattern: "new StrategyRegistry<IReplicationStrategy>"
---

<objective>
Add typed strategy registries and domain operations to ALL DataPipeline branch plugin bases (Storage, Replication, DataTransit, Integrity).

Purpose: These bases serve ~20 plugins. Adding domain ops here means plugins can inherit dispatch instead of rolling their own registries.
Output: Four updated base classes with strategy dispatch following the EncryptionPluginBase pattern.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@DataWarehouse.SDK/Contracts/Hierarchy/DataPipeline/EncryptionPluginBase.cs
@DataWarehouse.SDK/Contracts/StrategyRegistry.cs
@DataWarehouse.SDK/Contracts/PluginBase.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add strategy dispatch to StoragePluginBase and ReplicationPluginBase</name>
  <files>
    DataWarehouse.SDK/Contracts/Hierarchy/DataPipeline/StoragePluginBase.cs
    DataWarehouse.SDK/Contracts/Hierarchy/DataPipeline/ReplicationPluginBase.cs
  </files>
  <action>
Follow the EXACT pattern from EncryptionPluginBase (lines 59-146 of that file). For each base, add a NEW region after existing code (do NOT remove any existing methods or properties):

**StoragePluginBase** -- add after the `#region AI Hooks` section, before `#region Metadata`:

1. `#region Typed Storage Strategy Registry`
2. Private field: `private StrategyRegistry<DataWarehouse.SDK.Contracts.Storage.IStorageStrategy>? _storageStrategyRegistry;`
3. Private lock: `private readonly object _storageRegistryLock = new();`
4. Protected property: `StorageStrategyRegistry` returning `StrategyRegistry<IStorageStrategy>` with lazy init using `s => s.StrategyId` key selector
5. `RegisterStorageStrategy(IStorageStrategy strategy)` method
6. `DispatchStorageStrategyAsync<TResult>(string? explicitStrategyId, CommandIdentity? identity, Dictionary<string, object>? dataContext, Func<IStorageStrategy, Task<TResult>> operation, CancellationToken ct)` method -- follows DispatchEncryptionStrategyAsync pattern exactly (AI selection fallback, ACL check, registry lookup)
7. `#endregion`
8. `#region Domain Operations (Strategy-Dispatched)`
9. `StoreWithStrategyAsync(string key, Stream data, string? strategyId, CommandIdentity? identity, IDictionary<string, string>? metadata, CancellationToken ct)` -- dispatches to strategy.StoreAsync via DispatchStorageStrategyAsync. Note: IStorageStrategy has StoreAsync/RetrieveAsync/DeleteAsync methods.
10. `RetrieveWithStrategyAsync(string key, string? strategyId, CommandIdentity? identity, CancellationToken ct)` -- dispatches to strategy.RetrieveAsync
11. Override `GetDefaultStrategyId()` returning null (no default -- plugins set their own)
12. `#endregion`

Use `using IStorageStrategy = DataWarehouse.SDK.Contracts.Storage.IStorageStrategy;` at the top to disambiguate from `DataWarehouse.SDK.Contracts.IStorageOrchestration.IStorageStrategy` if needed.

Add `using DataWarehouse.SDK.Security;` for CommandIdentity (already in the file's namespace).

**ReplicationPluginBase** -- add after existing abstract methods, before `#region Metadata`:

1. `#region Typed Replication Strategy Registry`
2. Same lazy pattern with `StrategyRegistry<IReplicationStrategy>` using key selector `s => s.StrategyId`
3. `RegisterReplicationStrategy(IReplicationStrategy strategy)` method
4. `DispatchReplicationStrategyAsync<TResult>(...)` method -- same pattern
5. `#endregion`
6. `#region Domain Operations (Strategy-Dispatched)`
7. `ReplicateWithStrategyAsync(string key, string[] targetNodes, string? strategyId, CommandIdentity? identity, CancellationToken ct)` -- dispatches to strategy
8. `GetSyncStatusWithStrategyAsync(string key, string? strategyId, CommandIdentity? identity, CancellationToken ct)` -- dispatches to strategy
9. Override `GetDefaultStrategyId()` returning `DefaultReplicationMode` (existing property)
10. `#endregion`

Add using statements: `using DataWarehouse.SDK.Contracts.Replication;` and `using DataWarehouse.SDK.Security;` and `using DataWarehouse.SDK.Contracts;`

CRITICAL: Do NOT change any existing method signatures. The new domain ops are ADDITIONAL virtual protected methods. The existing public abstract methods remain unchanged.
  </action>
  <verify>
Run: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore` -- must compile with 0 errors 0 warnings.
Grep both files for `StrategyRegistry<` to confirm typed registries exist.
  </verify>
  <done>StoragePluginBase and ReplicationPluginBase both have typed strategy registries, dispatch methods, and domain operations. SDK compiles clean.</done>
</task>

<task type="auto">
  <name>Task 2: Add strategy dispatch to DataTransitPluginBase and IntegrityPluginBase</name>
  <files>
    DataWarehouse.SDK/Contracts/Hierarchy/DataPipeline/DataTransitPluginBase.cs
    DataWarehouse.SDK/Contracts/Hierarchy/DataPipeline/IntegrityPluginBase.cs
  </files>
  <action>
Same pattern as Task 1:

**DataTransitPluginBase** -- add after existing abstract methods, before `#region Metadata`:

1. `#region Typed Transit Strategy Registry`
2. Lazy `StrategyRegistry<IDataTransitStrategy>` with `s => s.StrategyId` key selector
3. `RegisterTransitStrategy(IDataTransitStrategy strategy)` method
4. `DispatchTransitStrategyAsync<TResult>(...)` method
5. `#endregion`
6. `#region Domain Operations (Strategy-Dispatched)`
7. `TransferWithStrategyAsync(string key, Dictionary<string, object> target, string? strategyId, CommandIdentity? identity, CancellationToken ct)` -- dispatches transfer
8. `GetTransferStatusWithStrategyAsync(string transferId, string? strategyId, CommandIdentity? identity, CancellationToken ct)` -- dispatches status check
9. Override `GetDefaultStrategyId()` returning `TransportProtocol`
10. `#endregion`

Add: `using DataWarehouse.SDK.Contracts.Transit;` and `using DataWarehouse.SDK.Security;` and `using DataWarehouse.SDK.Contracts;`

**IntegrityPluginBase** -- add after existing methods, before `#region Metadata`:

Note: IntegrityPluginBase does not have a dedicated `IIntegrityStrategy` in the SDK. Check for one at `DataWarehouse.SDK/Contracts/Integrity/`. If it doesn't exist, use `IStrategy` from `DataWarehouse.SDK.Contracts` as the typed parameter (the base PluginBase registry already handles IStrategy). In that case, add the dispatch methods but use `StrategyRegistry<IStrategy>` (which is already available from PluginBase.StrategyRegistry). Instead of a NEW typed registry, provide convenience domain operation methods that wrap the existing `ExecuteWithStrategyAsync`:

1. `#region Domain Operations (Strategy-Dispatched)`
2. `VerifyWithStrategyAsync(string key, string? strategyId, CommandIdentity? identity, CancellationToken ct)` -- wraps `ExecuteWithStrategyAsync` from PluginBase
3. `ComputeHashWithStrategyAsync(Stream data, string? strategyId, CommandIdentity? identity, CancellationToken ct)` -- wraps `ExecuteWithStrategyAsync`
4. `#endregion`

These domain ops provide the same convenience pattern without requiring a new typed registry (since IStrategy from PluginBase already covers integrity strategies).

CRITICAL: Do NOT change existing abstract methods. New methods are ADDITIONAL virtual protected.
  </action>
  <verify>
Run: `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore` -- must compile with 0 errors 0 warnings.
Grep both files for `WithStrategyAsync` to confirm domain ops exist.
  </verify>
  <done>DataTransitPluginBase and IntegrityPluginBase have strategy dispatch domain operations. SDK compiles clean.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore` passes with 0 errors 0 warnings
- All 4 DataPipeline bases have strategy dispatch infrastructure
- No existing method signatures changed
</verification>

<success_criteria>
All DataPipeline branch bases (Storage, Replication, DataTransit, Integrity) have typed strategy registries and domain operations matching the EncryptionPluginBase pattern. SDK compiles clean.
</success_criteria>

<output>
After completion, create `.planning/phases/65.4-comprehensive-strategy-dispatch-migration/65.4-02-SUMMARY.md`
</output>
