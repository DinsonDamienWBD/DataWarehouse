---
phase: 65.4-comprehensive-strategy-dispatch-migration
plan: "05"
subsystem: storage-plugins
tags:
  - strategy-dispatch
  - plugin-migration
  - registry-cleanup
  - wave-3
dependency_graph:
  requires:
    - 65.4-01
    - 65.4-02
  provides:
    - UltimateStorage-base-dispatch
    - UltimateRAID-typed-registry
    - UltimateDatabaseStorage-base-dispatch
  affects:
    - Plugins/DataWarehouse.Plugins.UltimateStorage
    - Plugins/DataWarehouse.Plugins.UltimateRAID
    - Plugins/DataWarehouse.Plugins.UltimateDatabaseStorage
tech_stack:
  patterns:
    - StrategyRegistry<T> generic typed registry replacing bespoke registries
    - pragma CS0618 suppression for transitional obsolescence
    - GetByPredicate() lambda filter as replacement for category/tier convenience methods
key_files:
  modified:
    - Plugins/DataWarehouse.Plugins.UltimateStorage/UltimateStoragePlugin.cs
    - Plugins/DataWarehouse.Plugins.UltimateStorage/StorageStrategyRegistry.cs
    - Plugins/DataWarehouse.Plugins.UltimateStorage/Features/AutoTieringFeature.cs
    - Plugins/DataWarehouse.Plugins.UltimateStorage/Features/CostBasedSelectionFeature.cs
    - Plugins/DataWarehouse.Plugins.UltimateStorage/Features/CrossBackendMigrationFeature.cs
    - Plugins/DataWarehouse.Plugins.UltimateStorage/Features/LatencyBasedSelectionFeature.cs
    - Plugins/DataWarehouse.Plugins.UltimateStorage/Features/LifecycleManagementFeature.cs
    - Plugins/DataWarehouse.Plugins.UltimateStorage/Features/MultiBackendFanOutFeature.cs
    - Plugins/DataWarehouse.Plugins.UltimateStorage/Features/RaidIntegrationFeature.cs
    - Plugins/DataWarehouse.Plugins.UltimateStorage/Features/ReplicationIntegrationFeature.cs
    - Plugins/DataWarehouse.Plugins.UltimateStorage/Features/StoragePoolAggregationFeature.cs
    - Plugins/DataWarehouse.Plugins.UltimateStorage/Migration/StorageDocumentationGenerator.cs
    - Plugins/DataWarehouse.Plugins.UltimateRAID/UltimateRaidPlugin.cs
    - Plugins/DataWarehouse.Plugins.UltimateRAID/RaidStrategyRegistry.cs
    - Plugins/DataWarehouse.Plugins.UltimateDatabaseStorage/UltimateDatabaseStoragePlugin.cs
    - Plugins/DataWarehouse.Plugins.UltimateDatabaseStorage/DatabaseStorageStrategyRegistry.cs
decisions:
  - "UltimateStorage: Removed private _registry field; all calls now route through inherited StoragePluginBase.StorageStrategyRegistry (StrategyRegistry<IStorageStrategy>)"
  - "UltimateRAID: IRaidStrategy is not IStrategy/IReplicationStrategy, so used StrategyRegistry<IRaidStrategy> alias (RaidRegistry) as private field instead of ReplicationStrategyRegistry"
  - "UltimateDatabaseStorage: Added GetDatabaseStrategy()/GetAllDatabaseStrategies() helpers that cast IStorageStrategy to DatabaseStorageStrategyBase for typed domain access"
  - "Feature files (AutoTiering, CostBased, etc.) kept using StorageStrategyRegistry class but suppressed CS0618 with pragma - full feature migration deferred to v6.0"
metrics:
  duration_seconds: 817
  completed_date: "2026-02-21"
  tasks_completed: 2
  files_modified: 16
---

# Phase 65.4 Plan 05: UltimateStorage, UltimateRAID, UltimateDatabaseStorage Registry Migration Summary

Wave 3 migration of three plugins from standalone custom registries to base class dispatch using the generic `StrategyRegistry<T>` infrastructure established in Plans 01 and 02.

## What Was Done

### Task 1: UltimateStorage (commit 9adc9a05)

Migrated `UltimateStoragePlugin` to use `StoragePluginBase.StorageStrategyRegistry` (inherited `StrategyRegistry<IStorageStrategy>`):

- Removed `private readonly StorageStrategyRegistry _registry` field
- Constructor no longer instantiates standalone registry
- All registry operations now route through inherited property:
  - `_registry.GetAllStrategies()` → `StorageStrategyRegistry.GetAll()`
  - `_registry.GetStrategy(id)` → `StorageStrategyRegistry.Get(id)`
  - `_registry.DiscoverStrategies(asm)` → `StorageStrategyRegistry.DiscoverFromAssembly(asm)`
  - `_registry.GetStrategiesByCategory(cat)` → `StorageStrategyRegistry.GetByPredicate(s => GetStrategyCategory(s.StrategyId).Equals(cat, ...))`
  - `_registry.GetAllStrategies().Count` → `StorageStrategyRegistry.Count`
- `public Registry` property changed type to `StrategyRegistry<IStorageStrategy>`
- `StorageStrategyRegistry` class and `IStorageStrategyRegistry` interface marked `[Obsolete]`
- Feature files (`AutoTieringFeature`, `CostBasedSelectionFeature`, etc.) received `#pragma warning disable CS0618` to suppress TreatWarningsAsErrors; their full migration is deferred to v6.0

### Task 2: UltimateRAID (commit 1829c380)

`IRaidStrategy` does not implement `IReplicationStrategy` or `IStrategy`, so `ReplicationStrategyRegistry` cannot be used. Instead:

- Added using alias: `RaidRegistry = StrategyRegistry<IRaidStrategy>`
- `_registry` field changed from `RaidStrategyRegistry` to `RaidRegistry`
- Constructor initializes: `_registry = new RaidRegistry(s => s.StrategyId)`
- All `_registry.GetStrategy()` → `_registry.Get()`
- All `_registry.GetAllStrategies()` → `_registry.GetAll()`
- `GetStrategiesByCategory()` → `_registry.GetByPredicate(s => s.Category.Equals(...))`
- `DiscoverStrategies()` → `_registry.DiscoverFromAssembly()`
- `RaidStrategyRegistry` and `IRaidStrategyRegistry` marked `[Obsolete]`

### Task 2: UltimateDatabaseStorage (commit 1829c380)

`DatabaseStorageStrategyBase` extends `StorageStrategyBase` (which implements `IStorageStrategy`), making the inherited `StorageStrategyRegistry` usable. However typed domain access required helpers:

- Removed `_strategyRegistry` field entirely
- `DiscoverFromAssembly()` now called on `StorageStrategyRegistry` (inherited)
- Added `GetDatabaseStrategy(id)` private helper: `StorageStrategyRegistry.Get(id) as DatabaseStorageStrategyBase`
- Added `GetAllDatabaseStrategies()` private helper: `StorageStrategyRegistry.GetAll().OfType<DatabaseStorageStrategyBase>()`
- All `_strategyRegistry.GetStrategy()` replaced with `GetDatabaseStrategy()`
- All `_strategyRegistry.GetAllStrategies()` replaced with `GetAllDatabaseStrategies()`
- `_strategyRegistry.GetAllStatistics()` replaced with inline `.ToDictionary(s => s.StrategyId, s => s.GetDatabaseStatistics())`
- `_strategyRegistry.Clear()` removed from dispose (strategies are not tracked in a separate registry anymore)
- `DatabaseStorageStrategyRegistry` and `IDatabaseStorageStrategyRegistry` marked `[Obsolete]`
- Removed `public new IDatabaseStorageStrategyRegistry StrategyRegistry` shadow property

## Verification Results

- `dotnet build DataWarehouse.Plugins.UltimateStorage.csproj --no-restore`: 0 errors, 0 warnings
- `dotnet build DataWarehouse.Plugins.UltimateRAID.csproj --no-restore`: 0 errors, 0 warnings
- `dotnet build DataWarehouse.Plugins.UltimateDatabaseStorage.csproj --no-restore`: 0 errors, 0 warnings
- `grep "new StorageStrategyRegistry()" UltimateStoragePlugin.cs`: NOT FOUND
- `grep "new RaidStrategyRegistry()\|new DatabaseStorageStrategyRegistry()" *.cs`: NOT FOUND
- All three standalone registry files have `[Obsolete]` on both class and interface

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing critical] Feature files in UltimateStorage also referenced obsolete StorageStrategyRegistry**
- **Found during:** Task 1 build verification
- **Issue:** 10 Feature/Migration files passed `StorageStrategyRegistry` in constructors; with `TreatWarningsAsErrors=true`, CS0618 became fatal errors
- **Fix:** Added `#pragma warning disable CS0618` to each Feature file; full feature migration deferred to v6.0 per plan guidance
- **Files modified:** AutoTieringFeature.cs, CostBasedSelectionFeature.cs, CrossBackendMigrationFeature.cs, LatencyBasedSelectionFeature.cs, LifecycleManagementFeature.cs, MultiBackendFanOutFeature.cs, RaidIntegrationFeature.cs, ReplicationIntegrationFeature.cs, StoragePoolAggregationFeature.cs, StorageDocumentationGenerator.cs
- **Commit:** 9adc9a05

**2. [Rule 1 - Bug] UltimateDatabaseStorage.DisposeAsyncCore called _strategyRegistry.Clear() which is not on StoragePluginBase registry**
- **Found during:** Task 2 migration
- **Issue:** `StorageStrategyRegistry` (inherited) has no `Clear()` method
- **Fix:** Removed the `Clear()` call - strategies are now referenced only via the inherited registry which manages its own lifecycle
- **Commit:** 1829c380

## Self-Check: PASSED

All key files exist on disk. Both task commits (9adc9a05, 1829c380) verified in git log. All 3 plugins build with 0 errors, 0 warnings.
