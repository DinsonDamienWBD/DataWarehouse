---
phase: 65.4-comprehensive-strategy-dispatch-migration
plan: "03"
subsystem: SDK Feature Branch Base Classes
tags: [strategy-dispatch, feature-plugins, security, observability, streaming, compute, media]
dependency_graph:
  requires: ["65.4-02"]
  provides: ["strategy-dispatch-security", "strategy-dispatch-observability", "strategy-dispatch-streaming", "strategy-dispatch-compute", "strategy-dispatch-media"]
  affects: ["Plugins/DataWarehouse.Plugins.*.cs"]
tech_stack:
  added: []
  patterns: ["typed-strategy-registry", "lazy-init-lock", "acl-dispatch", "domain-operations"]
key_files:
  created: []
  modified:
    - DataWarehouse.SDK/Contracts/Hierarchy/Feature/SecurityPluginBase.cs
    - DataWarehouse.SDK/Contracts/Hierarchy/Feature/ObservabilityPluginBase.cs
    - DataWarehouse.SDK/Contracts/Hierarchy/Feature/StreamingPluginBase.cs
    - DataWarehouse.SDK/Contracts/Hierarchy/Feature/ComputePluginBase.cs
    - DataWarehouse.SDK/Contracts/Hierarchy/Feature/MediaPluginBase.cs
decisions:
  - "IObservabilityStrategy lacks StrategyId on interface; key selector casts to ObservabilityStrategyBase?.StrategyId with GetType().Name fallback"
  - "IComputeRuntimeStrategy lacks StrategyId; uses Runtime.ToString() as registry key (enum name matches RuntimeType property)"
  - "IMediaStrategy lacks StrategyId on interface; key selector casts to MediaStrategyBase?.StrategyId with GetType().Name fallback"
  - "PublishResult and MediaFormat exist in both SDK root contracts and feature namespaces; use fully qualified Streaming.PublishResult and Media.MediaFormat to disambiguate"
  - "StreamingPluginBase.SubscribeWithStrategyAsync returns Task<IAsyncEnumerable<StreamMessage>> to maintain async dispatch pattern while preserving pull-based enumerable"
metrics:
  duration: "~15 minutes"
  completed: "2026-02-21"
  tasks_completed: 2
  files_modified: 5
---

# Phase 65.4 Plan 03: Feature Branch Strategy Dispatch (Batch 1) Summary

Added typed strategy registries and domain operations to the five Feature branch plugin bases covering Security, Observability, Streaming, Compute, and Media. These 5 bases serve approximately 15 plugins; strategy dispatch here enables plugins to inherit rather than custom-build registries.

## What Was Built

### Task 1: SecurityPluginBase, ObservabilityPluginBase, StreamingPluginBase

**SecurityPluginBase** (`DataWarehouse.SDK/Contracts/Hierarchy/Feature/SecurityPluginBase.cs`):
- `StrategyRegistry<ISecurityStrategy>` with `s => s.StrategyId` key selector (ISecurityStrategy has StrategyId directly)
- `RegisterSecurityStrategy(ISecurityStrategy strategy)` method
- `DispatchSecurityStrategyAsync<TResult>(...)` with ACL enforcement
- `AuthenticateWithStrategyAsync(credentials, strategyId, identity, ct)` domain operation — builds SecurityContext and calls `strategy.EvaluateAsync`
- `AuthorizeWithStrategyAsync(resource, action, strategyId, identity, ct)` domain operation
- `GetDefaultStrategyId()` returns null (no fixed default for security)

**ObservabilityPluginBase** (`DataWarehouse.SDK/Contracts/Hierarchy/Feature/ObservabilityPluginBase.cs`):
- `StrategyRegistry<IObservabilityStrategy>` with `(s as ObservabilityStrategyBase)?.StrategyId ?? s.GetType().Name` key selector
- `RegisterObservabilityStrategy(IObservabilityStrategy strategy)` method
- `DispatchObservabilityStrategyAsync<TResult>(...)` with ACL enforcement
- `RecordMetricWithStrategyAsync(metric, strategyId, identity, ct)` — builds `MetricValue.Gauge(name, value)` and calls `strategy.MetricsAsync`
- `TraceWithStrategyAsync(span, strategyId, identity, ct)` — builds `SpanContext.CreateRoot(operationName)` and calls `strategy.TracingAsync`
- `GetDefaultStrategyId()` returns null

**StreamingPluginBase** (`DataWarehouse.SDK/Contracts/Hierarchy/Feature/StreamingPluginBase.cs`):
- `StrategyRegistry<IStreamingStrategy>` with `s => s.StrategyId` key selector
- `RegisterStreamingStrategy(IStreamingStrategy strategy)` method
- `DispatchStreamingStrategyAsync<TResult>(...)` with ACL enforcement
- `PublishWithStrategyAsync(topic, data, strategyId, identity, ct)` — reads Stream into `StreamMessage.Data` and calls `strategy.PublishAsync`
- `SubscribeWithStrategyAsync(topic, strategyId, identity, ct)` — returns `Task<IAsyncEnumerable<StreamMessage>>` from `strategy.SubscribeAsync`
- `GetDefaultStrategyId()` returns null

### Task 2: ComputePluginBase, MediaPluginBase

**ComputePluginBase** (`DataWarehouse.SDK/Contracts/Hierarchy/Feature/ComputePluginBase.cs`):
- `StrategyRegistry<IComputeRuntimeStrategy>` with `s => s.Runtime.ToString()` key selector
- `RegisterComputeStrategy(IComputeRuntimeStrategy strategy)` method
- `DispatchComputeStrategyAsync<TResult>(...)` with ACL enforcement
- `ExecuteWorkloadWithStrategyAsync(workload, strategyId, identity, ct)` — builds `ComputeTask` from workload dict and calls `strategy.ExecuteAsync`
- `GetDefaultStrategyId()` returns `RuntimeType` (so WASM plugin defaults to "WASM" strategy etc.)

**MediaPluginBase** (`DataWarehouse.SDK/Contracts/Hierarchy/Feature/MediaPluginBase.cs`):
- `StrategyRegistry<IMediaStrategy>` with `(s as MediaStrategyBase)?.StrategyId ?? s.GetType().Name` key selector
- `RegisterMediaStrategy(IMediaStrategy strategy)` method
- `DispatchMediaStrategyAsync<TResult>(...)` with ACL enforcement
- `ProcessMediaWithStrategyAsync(media, strategyId, identity, ct)` — extracts Stream and `Media.MediaFormat`, builds `Media.TranscodeOptions`, calls `strategy.TranscodeAsync`
- `GetDefaultStrategyId()` returns `MediaType` (so Video plugin defaults to "Video" strategy etc.)

## Verification

```
dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj --no-restore
Build succeeded.
    0 Warning(s)
    0 Error(s)
```

All 5 files confirmed to contain `StrategyRegistry<`:
- SecurityPluginBase.cs: `StrategyRegistry<ISecurityStrategy>`
- ObservabilityPluginBase.cs: `StrategyRegistry<IObservabilityStrategy>`
- StreamingPluginBase.cs: `StrategyRegistry<IStreamingStrategy>`
- ComputePluginBase.cs: `StrategyRegistry<IComputeRuntimeStrategy>`
- MediaPluginBase.cs: `StrategyRegistry<IMediaStrategy>`

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] IObservabilityStrategy has no StrategyId on interface**
- **Found during:** Task 1
- **Issue:** The plan specified `s => s.StrategyId` as key selector, but `IObservabilityStrategy` does not define `StrategyId` on the interface. `StrategyId` is only available on `ObservabilityStrategyBase` which inherits from `StrategyBase`.
- **Fix:** Used `(s as ObservabilityStrategyBase)?.StrategyId ?? s.GetType().Name` key selector to safely access `StrategyId` when available, with type name fallback.
- **Files modified:** `ObservabilityPluginBase.cs`

**2. [Rule 1 - Bug] IComputeRuntimeStrategy has no StrategyId on interface**
- **Found during:** Task 2
- **Issue:** `IComputeRuntimeStrategy` uses `Runtime` (a `ComputeRuntime` enum) rather than `StrategyId`.
- **Fix:** Used `s => s.Runtime.ToString()` as key selector. This aligns with `RuntimeType` property used as default strategy ID.
- **Files modified:** `ComputePluginBase.cs`

**3. [Rule 1 - Bug] IMediaStrategy has no StrategyId on interface**
- **Found during:** Task 2
- **Issue:** Same pattern as Observability — `StrategyId` is only on `MediaStrategyBase`.
- **Fix:** Used `(s as MediaStrategyBase)?.StrategyId ?? s.GetType().Name` key selector.
- **Files modified:** `MediaPluginBase.cs`

**4. [Rule 1 - Bug] PublishResult namespace ambiguity**
- **Found during:** Task 1 (build failure)
- **Issue:** `PublishResult` exists in both `DataWarehouse.SDK.Contracts` and `DataWarehouse.SDK.Contracts.Streaming`. The compiler resolved to the wrong one.
- **Fix:** Used fully qualified `Streaming.PublishResult` in the method signature and dispatch call.
- **Files modified:** `StreamingPluginBase.cs`

**5. [Rule 1 - Bug] MediaFormat namespace ambiguity**
- **Found during:** Task 2 (build failure)
- **Issue:** `MediaFormat` exists in both `DataWarehouse.SDK.Contracts` (ActiveStoragePluginBases.cs) and `DataWarehouse.SDK.Contracts.Media`. Compiler resolved to wrong one.
- **Fix:** Used fully qualified `Media.MediaFormat` and `Media.TranscodeOptions` throughout `MediaPluginBase.cs`.
- **Files modified:** `MediaPluginBase.cs`

## Commits

- `f819b172` — feat(65.4-03): add strategy dispatch to SecurityPluginBase, ObservabilityPluginBase, StreamingPluginBase
- `ad34ac11` — feat(65.4-03): add strategy dispatch to ComputePluginBase and MediaPluginBase

## Self-Check: PASSED
