---
phase: 65.4-comprehensive-strategy-dispatch-migration
plan: 05
type: execute
wave: 3
depends_on: ["65.4-01", "65.4-02"]
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateStorage/UltimateStoragePlugin.cs
  - Plugins/DataWarehouse.Plugins.UltimateStorage/StorageStrategyRegistry.cs
  - Plugins/DataWarehouse.Plugins.UltimateRAID/UltimateRaidPlugin.cs
  - Plugins/DataWarehouse.Plugins.UltimateRAID/RaidStrategyRegistry.cs
  - Plugins/DataWarehouse.Plugins.UltimateDatabaseStorage/UltimateDatabaseStoragePlugin.cs
  - Plugins/DataWarehouse.Plugins.UltimateDatabaseStorage/DatabaseStorageStrategyRegistry.cs
autonomous: true

must_haves:
  truths:
    - "UltimateStorage uses inherited StoragePluginBase.StorageStrategyRegistry instead of standalone StorageStrategyRegistry"
    - "UltimateRAID uses inherited StrategyRegistry instead of standalone RaidStrategyRegistry"
    - "UltimateDatabaseStorage uses inherited StrategyRegistry instead of standalone DatabaseStorageStrategyRegistry"
    - "All 3 plugins build with 0 errors 0 warnings"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateStorage/UltimateStoragePlugin.cs"
      provides: "Migrated storage plugin using base class dispatch"
      contains: "RegisterStorageStrategy"
    - path: "Plugins/DataWarehouse.Plugins.UltimateRAID/UltimateRaidPlugin.cs"
      provides: "Migrated RAID plugin using base class dispatch"
      contains: "RegisterStrategy"
  key_links:
    - from: "Plugins/DataWarehouse.Plugins.UltimateStorage/UltimateStoragePlugin.cs"
      to: "DataWarehouse.SDK/Contracts/Hierarchy/DataPipeline/StoragePluginBase.cs"
      via: "inherited strategy dispatch"
      pattern: "RegisterStorageStrategy|StorageStrategyRegistry"
---

<objective>
Migrate UltimateStorage, UltimateRAID, and UltimateDatabaseStorage plugins from standalone custom registries to inherited base class dispatch.

Purpose: These 3 plugins have the most straightforward DUPLICATE Pattern A registries. Migration validates the pattern for subsequent batches.
Output: 3 plugins using base class dispatch, standalone registry files marked with [Obsolete] or simplified to thin wrappers.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/65.4-comprehensive-strategy-dispatch-migration/65.4-01-SUMMARY.md
@.planning/phases/65.4-comprehensive-strategy-dispatch-migration/65.4-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate UltimateStorage plugin to base class dispatch</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateStorage/UltimateStoragePlugin.cs
    Plugins/DataWarehouse.Plugins.UltimateStorage/StorageStrategyRegistry.cs
  </files>
  <action>
**Step 1: Analyze current usage.**
Read `UltimateStoragePlugin.cs` to find all references to `StorageStrategyRegistry` (the custom class). Identify:
- Where the registry is instantiated (`new StorageStrategyRegistry()` or similar)
- Where `Register()` is called
- Where `GetStrategy()`, `GetAllStrategies()`, `GetStrategiesByCategory()`, `GetStrategiesByTier()` are called
- Where `DiscoverStrategies()` is called
- Where `GetDefaultStrategy()`, `SetDefaultStrategy()` are called

Also check all `Features/*.cs` files in the UltimateStorage plugin for registry references.

**Step 2: Migrate the plugin class.**
In `UltimateStoragePlugin.cs`:
1. Replace the field holding the custom `StorageStrategyRegistry` instance with usage of inherited `StorageStrategyRegistry` property (from StoragePluginBase, Plan 02)
2. Replace `_registry.Register(strategy)` calls with `RegisterStorageStrategy(strategy)` (inherited)
3. Replace `_registry.GetStrategy(id)` calls with `StorageStrategyRegistry.Get(id)` (inherited typed registry)
4. Replace `_registry.GetAllStrategies()` with `StorageStrategyRegistry.GetAll()` (inherited)
5. Replace `_registry.DiscoverStrategies(assemblies)` with `StorageStrategyRegistry.DiscoverFromAssembly(assemblies)` (inherited via StrategyRegistry<T>)
6. For `GetStrategiesByCategory(category)` and `GetStrategiesByTier(tier)` -- these are custom convenience methods. Replace with `StorageStrategyRegistry.GetByPredicate(s => ...)` using the inherited `GetByPredicate` method
7. Replace `_registry.SetDefaultStrategy(id)` with `StorageStrategyRegistry.SetDefault(id)`
8. Replace `_registry.GetDefaultStrategy()` with `StorageStrategyRegistry.GetDefault()`

**Step 3: Handle the standalone registry file.**
In `StorageStrategyRegistry.cs`:
- Add `[Obsolete("Use inherited StoragePluginBase.StorageStrategyRegistry. This class will be removed in v6.0.")]` to the class
- Keep `IStorageStrategyRegistry` interface (other code may reference it) but add `[Obsolete]`
- Do NOT delete the file -- mark as obsolete for safe deprecation

**Step 4: Update Feature files.**
Check `Features/*.cs` files in UltimateStorage for direct `StorageStrategyRegistry` references. Update to use the plugin's inherited registry.

CRITICAL: This is a mechanical migration. The runtime behavior MUST be identical. If any custom method has no direct equivalent on StrategyRegistry<T>, keep a thin wrapper in the plugin that delegates to the inherited registry.
  </action>
  <verify>
Run: `dotnet build Plugins/DataWarehouse.Plugins.UltimateStorage/DataWarehouse.Plugins.UltimateStorage.csproj --no-restore` -- 0 errors (warnings OK for [Obsolete]).
Grep `UltimateStoragePlugin.cs` for `new StorageStrategyRegistry()` -- should NOT appear (migrated away).
  </verify>
  <done>UltimateStorage plugin uses inherited StoragePluginBase dispatch. Standalone registry marked [Obsolete]. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate UltimateRAID and UltimateDatabaseStorage plugins</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateRAID/UltimateRaidPlugin.cs
    Plugins/DataWarehouse.Plugins.UltimateRAID/RaidStrategyRegistry.cs
    Plugins/DataWarehouse.Plugins.UltimateDatabaseStorage/UltimateDatabaseStoragePlugin.cs
    Plugins/DataWarehouse.Plugins.UltimateDatabaseStorage/DatabaseStorageStrategyRegistry.cs
  </files>
  <action>
Same pattern as Task 1 for each plugin:

**UltimateRAID:**
1. Read `UltimateRaidPlugin.cs` and find all `RaidStrategyRegistry` references
2. UltimateRAID inherits from StoragePluginBase (or check actual hierarchy). If it doesn't inherit a base with typed IRaidStrategy registry, use the PluginBase.StrategyRegistry (IStrategy-based) with `RegisterStrategy()` and `ResolveStrategy<IRaidStrategy>(id, identity)`
3. Replace custom registry usage with inherited methods
4. Mark `RaidStrategyRegistry.cs` with `[Obsolete]`
5. Check all feature files for registry references

**UltimateDatabaseStorage:**
1. Read `UltimateDatabaseStoragePlugin.cs` and find all `DatabaseStorageStrategyRegistry` references
2. This plugin likely inherits StoragePluginBase. Use inherited `StorageStrategyRegistry` (which is StrategyRegistry<IStorageStrategy>). If DatabaseStorageStrategyBase extends IStorageStrategy, direct migration works. If not, use PluginBase.StrategyRegistry.
3. Replace custom registry usage with inherited methods
4. Mark `DatabaseStorageStrategyRegistry.cs` with `[Obsolete]`

For both: If the custom registry has methods with no direct equivalent on StrategyRegistry<T> (like GetByCategory), implement thin wrappers using `GetByPredicate()`.

CRITICAL: Zero regression. The strategies must be discoverable and resolvable after migration.
  </action>
  <verify>
Run: `dotnet build Plugins/DataWarehouse.Plugins.UltimateRAID/DataWarehouse.Plugins.UltimateRAID.csproj --no-restore && dotnet build Plugins/DataWarehouse.Plugins.UltimateDatabaseStorage/DataWarehouse.Plugins.UltimateDatabaseStorage.csproj --no-restore` -- 0 errors each.
Grep both plugin files for `new.*StrategyRegistry()` -- should NOT appear.
  </verify>
  <done>UltimateRAID and UltimateDatabaseStorage use inherited dispatch. Custom registries marked [Obsolete]. Build passes.</done>
</task>

</tasks>

<verification>
- All 3 plugins build with 0 errors
- No `new StorageStrategyRegistry()`, `new RaidStrategyRegistry()`, `new DatabaseStorageStrategyRegistry()` instantiations remain
- Standalone registry files marked [Obsolete]
</verification>

<success_criteria>
UltimateStorage, UltimateRAID, UltimateDatabaseStorage all migrated to base class dispatch. Custom registries preserved but marked obsolete.
</success_criteria>

<output>
After completion, create `.planning/phases/65.4-comprehensive-strategy-dispatch-migration/65.4-05-SUMMARY.md`
</output>
