---
phase: 85-competitive-edge
plan: 08
type: execute
wave: 3
depends_on: []
files_modified:
  - DataWarehouse.SDK/VirtualDiskEngine/Lakehouse/DeltaIcebergTransactionLog.cs
  - DataWarehouse.SDK/VirtualDiskEngine/Lakehouse/LakehouseTableOperations.cs
  - DataWarehouse.SDK/VirtualDiskEngine/Lakehouse/TimeTravelEngine.cs
autonomous: true

must_haves:
  truths:
    - "Delta Lake and Iceberg transaction logs are stored natively in VDE (not as files)"
    - "Atomic multi-table commits succeed or fail as a unit"
    - "Time-travel queries read VDE snapshots to access historical table versions"
    - "Schema evolution is tracked via Policy Vault"
  artifacts:
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Lakehouse/DeltaIcebergTransactionLog.cs"
      provides: "VDE-native transaction log for Delta Lake and Iceberg table formats"
      exports: ["DeltaIcebergTransactionLog", "TransactionEntry", "TransactionAction"]
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Lakehouse/LakehouseTableOperations.cs"
      provides: "Table-level operations: commit, schema evolution, partition management"
      exports: ["LakehouseTableOperations", "TableSchema", "PartitionSpec"]
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Lakehouse/TimeTravelEngine.cs"
      provides: "Time-travel query engine using VDE snapshot mechanism"
      exports: ["TimeTravelEngine", "TimeTravelQuery"]
  key_links:
    - from: "DeltaIcebergTransactionLog"
      to: "VDE region"
      via: "Transaction entries stored in dedicated VDE region (not filesystem)"
      pattern: "ConcurrentDictionary.*TransactionEntry"
    - from: "TimeTravelEngine"
      to: "VDE snapshots"
      via: "Resolves historical table state from snapshot chain"
      pattern: "Snapshot"
    - from: "LakehouseTableOperations"
      to: "DeltaIcebergTransactionLog"
      via: "All table mutations go through transaction log"
      pattern: "TransactionLog\\.Commit"
---

<objective>
Implement native Delta Lake/Iceberg table operations in VDE: VDE-native transaction logs (not file-based), atomic multi-table commits, time-travel queries via VDE snapshots, and schema evolution tracked through the Policy Vault.

Purpose: Lakehouse table formats (Delta Lake, Apache Iceberg) are the industry standard for analytical data. Native VDE integration eliminates the file-system overhead and leverages VDE's snapshot mechanism for time travel.
Output: Transaction log, table operations, time-travel engine.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@DataWarehouse.SDK/VirtualDiskEngine/CopyOnWrite/
@DataWarehouse.SDK/VirtualDiskEngine/Regions/
</context>

<tasks>

<task type="auto">
  <name>Task 1: VDE-native transaction log</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/Lakehouse/DeltaIcebergTransactionLog.cs
  </files>
  <action>
Create the Lakehouse directory under VirtualDiskEngine.

**DeltaIcebergTransactionLog.cs**: VDE-native transaction log supporting both Delta Lake and Iceberg semantics:
- `LakehouseFormat` enum: DeltaLake, Iceberg
- `TransactionAction` enum: AddFile, RemoveFile, AddPartition, RemovePartition, SetSchema, SetProperties, CommitInfo
- `TransactionEntry` record: `long Version` (monotonically increasing per table), `string TableId`, `TransactionAction Action`, `DateTimeOffset Timestamp`, `string? FilePath` (for AddFile/RemoveFile), `Dictionary<string, string>? Properties`, `string? SchemaJson` (for SetSchema), `string CommitId` (GUID)
- `TransactionCommit` record: `long Version`, `string TableId`, `IReadOnlyList<TransactionEntry> Entries`, `string CommitId`, `DateTimeOffset Timestamp`, `bool IsAtomic`
- `MultiTableTransaction` class: groups commits across multiple tables for atomic multi-table commit:
  - `void AddTableCommit(string tableId, IReadOnlyList<TransactionEntry> entries)`
  - `bool IsComplete { get; }` -- all tables committed
  - `string TransactionGroupId` (shared GUID)
- `DeltaIcebergTransactionLog` class:
  - Constructor takes `LakehouseFormat format` and optional `ILogger`
  - Internal storage: `ConcurrentDictionary<string, SortedList<long, TransactionCommit>>` keyed by tableId, sorted by version
  - `ValueTask<long> CommitAsync(string tableId, IReadOnlyList<TransactionEntry> entries, CancellationToken ct)` -- appends new version; uses SemaphoreSlim(1,1) per table for serialized version increment (no gap); returns new version number
  - `ValueTask<long> CommitMultiTableAsync(MultiTableTransaction transaction, CancellationToken ct)` -- atomic multi-table: acquire all table locks in sorted order (deadlock prevention), commit all or rollback
  - `ValueTask<TransactionCommit?> GetVersionAsync(string tableId, long version, CancellationToken ct)`
  - `ValueTask<IReadOnlyList<TransactionCommit>> GetHistoryAsync(string tableId, long fromVersion, long toVersion, CancellationToken ct)`
  - `ValueTask<long> GetLatestVersionAsync(string tableId, CancellationToken ct)`
  - `ValueTask<IReadOnlyList<TransactionEntry>> GetSnapshotAtVersionAsync(string tableId, long version, CancellationToken ct)` -- replays log from version 0 to target, returns effective state (AddFile minus RemoveFile)
  - `TransactionLogStats GetStats()` -- record: `int TableCount`, `long TotalVersions`, `long TotalEntries`

Thread-safe via per-table SemaphoreSlim; multi-table uses sorted lock acquisition.
  </action>
  <verify>
`dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` compiles with 0 errors.
  </verify>
  <done>DeltaIcebergTransactionLog stores versioned transaction entries per table with atomic multi-table commits and log replay for snapshot reconstruction.</done>
</task>

<task type="auto">
  <name>Task 2: Table operations and time-travel engine</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/Lakehouse/LakehouseTableOperations.cs
    DataWarehouse.SDK/VirtualDiskEngine/Lakehouse/TimeTravelEngine.cs
  </files>
  <action>
**LakehouseTableOperations.cs**: Table-level operations built on transaction log:
- `ColumnDefinition` record: `string Name`, `string DataType` (Parquet-compatible types: INT32, INT64, FLOAT, DOUBLE, BINARY, BOOLEAN, STRING, TIMESTAMP_MILLIS, DATE, DECIMAL), `bool IsNullable`, `string? Comment`
- `TableSchema` record: `int SchemaId` (auto-increment), `IReadOnlyList<ColumnDefinition> Columns`, `IReadOnlyList<string> PartitionColumns`, `Dictionary<string, string>? Properties`
- `PartitionSpec` record: `string FieldName`, `PartitionTransform Transform`, `int? BucketCount` (for Hash)
- `PartitionTransform` enum: Identity, Year, Month, Day, Hour, Hash, Truncate
- `LakehouseTableOperations` class:
  - Constructor takes `DeltaIcebergTransactionLog transactionLog` and optional `ILogger`
  - `ValueTask<string> CreateTableAsync(string tableName, TableSchema schema, CancellationToken ct)` -- creates table with initial schema entry in transaction log; returns tableId
  - `ValueTask EvolveSchemaAsync(string tableId, TableSchema newSchema, CancellationToken ct)` -- adds SetSchema entry; validates backward compatibility (no removing required columns, no type narrowing)
  - `ValueTask AddFilesAsync(string tableId, IReadOnlyList<string> filePaths, Dictionary<string, string>? partitionValues, CancellationToken ct)` -- creates AddFile transaction entries
  - `ValueTask RemoveFilesAsync(string tableId, IReadOnlyList<string> filePaths, CancellationToken ct)` -- creates RemoveFile entries (logical delete for time travel)
  - `ValueTask OptimizeAsync(string tableId, CancellationToken ct)` -- compaction: merge small files into larger ones (AddFile new + RemoveFile old in single atomic commit)
  - `ValueTask<TableSchema?> GetCurrentSchemaAsync(string tableId, CancellationToken ct)` -- replay log to find latest SetSchema
  - `ValueTask<IReadOnlyList<string>> ListActiveFilesAsync(string tableId, CancellationToken ct)` -- replay log: AddFile minus RemoveFile
  - `ValueTask VacuumAsync(string tableId, TimeSpan retentionPeriod, CancellationToken ct)` -- permanently remove files older than retention (Delta Lake VACUUM semantics)

**TimeTravelEngine.cs**: Query historical table state via VDE snapshots:
- `TimeTravelQuery` record: `string TableId`, `TimeTravelTarget Target` -- what point in time to query
- `TimeTravelTarget` : either version-based or timestamp-based:
  - `static TimeTravelTarget AtVersion(long version)`
  - `static TimeTravelTarget AtTimestamp(DateTimeOffset timestamp)`
  - `long? Version`, `DateTimeOffset? Timestamp` (one or the other)
- `TimeTravelResult` record: `string TableId`, `long ResolvedVersion`, `DateTimeOffset VersionTimestamp`, `TableSchema SchemaAtVersion`, `IReadOnlyList<string> ActiveFilesAtVersion`
- `TimeTravelEngine` class:
  - Constructor takes `DeltaIcebergTransactionLog transactionLog`, `LakehouseTableOperations tableOps`, and optional `ILogger`
  - `ValueTask<TimeTravelResult> QueryAsync(TimeTravelQuery query, CancellationToken ct)`:
    - If version-based: directly replay log to that version
    - If timestamp-based: binary search transaction log for latest version at or before timestamp
  - `ValueTask<IReadOnlyList<long>> ListVersionsAsync(string tableId, DateTimeOffset? from, DateTimeOffset? to, CancellationToken ct)` -- list all versions in time range
  - `ValueTask<IReadOnlyDictionary<string, object>> DiffVersionsAsync(string tableId, long fromVersion, long toVersion, CancellationToken ct)` -- returns added/removed files between versions
  - `TimeTravelStats GetStats()` -- record: `long QueriesExecuted`, `long VersionLookups`, `long TimestampLookups`

Namespace: `DataWarehouse.SDK.VirtualDiskEngine.Lakehouse`
  </action>
  <verify>
`dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` compiles with 0 errors and 0 warnings.
  </verify>
  <done>LakehouseTableOperations provides create/evolve/add/remove/optimize/vacuum operations; TimeTravelEngine queries historical table state by version or timestamp.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` passes with 0 errors, 0 warnings
- All three files exist under DataWarehouse.SDK/VirtualDiskEngine/Lakehouse/
- DeltaIcebergTransactionLog supports both DeltaLake and Iceberg formats
- Multi-table atomic commits use sorted lock acquisition for deadlock prevention
- TimeTravelEngine resolves both version-based and timestamp-based queries
- Schema evolution validates backward compatibility
</verification>

<success_criteria>
- VDE-native transaction log for Delta Lake and Iceberg formats
- Atomic multi-table commits with deadlock-free locking
- Table operations: create, schema evolution, file management, compaction, vacuum
- Time-travel queries by version and by timestamp
- Log replay reconstructs table state at any historical version
- Full solution builds clean
</success_criteria>

<output>
After completion, create `.planning/phases/85-competitive-edge/85-08-SUMMARY.md`
</output>
