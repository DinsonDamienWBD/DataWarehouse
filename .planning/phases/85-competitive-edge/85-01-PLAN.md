---
phase: 85-competitive-edge
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.SDK/VirtualDiskEngine/BlockExport/IVdeBlockExporter.cs
  - DataWarehouse.SDK/VirtualDiskEngine/BlockExport/VdeBlockExportPath.cs
  - DataWarehouse.SDK/VirtualDiskEngine/BlockExport/ZeroCopyBlockReader.cs
autonomous: true

must_haves:
  truths:
    - "SMB/NFS/iSCSI/FC/NVMe-oF protocol strategies can serve VDE blocks directly without traversing plugin layer"
    - "Zero-copy I/O path reads VDE region data with no intermediate buffer allocation"
    - "Block export path provides >2x throughput over plugin-mediated reads"
  artifacts:
    - path: "DataWarehouse.SDK/VirtualDiskEngine/BlockExport/IVdeBlockExporter.cs"
      provides: "Contract for VDE-direct block export"
      exports: ["IVdeBlockExporter"]
    - path: "DataWarehouse.SDK/VirtualDiskEngine/BlockExport/VdeBlockExportPath.cs"
      provides: "Protocol-agnostic VDE block export fast path with zero-copy semantics"
      exports: ["VdeBlockExportPath"]
    - path: "DataWarehouse.SDK/VirtualDiskEngine/BlockExport/ZeroCopyBlockReader.cs"
      provides: "Memory-mapped zero-copy block reader for direct region access"
      exports: ["ZeroCopyBlockReader"]
  key_links:
    - from: "VdeBlockExportPath"
      to: "IBlockDevice"
      via: "Direct block read from VDE file"
      pattern: "IBlockDevice\\.Read"
    - from: "ZeroCopyBlockReader"
      to: "RegionDirectory"
      via: "Region-aware block lookup"
      pattern: "RegionDirectory"
---

<objective>
Create a VDE-native zero-copy block export path that allows NAS/SAN protocol strategies (SMB, NFS, iSCSI, FC, NVMe-oF) to serve VDE blocks directly from VDE regions, bypassing the full plugin processing pipeline on the hot path.

Purpose: Eliminate the plugin-layer overhead for block-level protocol serving, achieving >2x throughput for storage protocol strategies that already exist but currently go through the full plugin stack.
Output: IVdeBlockExporter contract, VdeBlockExportPath implementation, ZeroCopyBlockReader for direct region access.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@DataWarehouse.SDK/VirtualDiskEngine/IBlockDevice.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/RegionDirectory.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/RegionPointerTable.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/UniversalBlockTrailer.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/SuperblockV2.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: IVdeBlockExporter contract and ZeroCopyBlockReader</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/BlockExport/IVdeBlockExporter.cs
    DataWarehouse.SDK/VirtualDiskEngine/BlockExport/ZeroCopyBlockReader.cs
  </files>
  <action>
Create the BlockExport directory under VirtualDiskEngine.

**IVdeBlockExporter.cs**: Define the contract for VDE-direct block export:
- `ReadOnlyMemory<byte> ReadBlockZeroCopy(long blockAddress)` -- returns block data without copying to intermediate buffer
- `ValueTask<int> ReadBlocksAsync(long startBlock, int count, Memory<byte> destination)` -- batch block read into caller-owned buffer
- `bool TryGetRegionForBlock(long blockAddress, out RegionPointerTable.Entry region)` -- resolves which region owns a block
- `BlockExportCapabilities GetCapabilities()` -- reports what the exporter supports (zero-copy, batch, scatter-gather)

**BlockExportCapabilities**: Flags enum with ZeroCopy, BatchRead, ScatterGather, DirectMemoryMap.

**ZeroCopyBlockReader.cs**: Implements IVdeBlockExporter using memory-mapped file access:
- Constructor takes IBlockDevice and block size (from VdeConstants)
- `ReadBlockZeroCopy` uses `MemoryMappedFile.CreateFromFile` with `MemoryMappedFileAccess.Read` for the VDE file, then `MemoryMappedViewAccessor` to return a ReadOnlyMemory slice at `blockAddress * blockSize` with length `blockSize`
- Cache the MemoryMappedFile instance (create once, reuse); dispose via IDisposable
- `ReadBlocksAsync` reads contiguous blocks directly into the destination buffer (no intermediate allocation)
- `TryGetRegionForBlock` looks up the block in RegionDirectory to find the owning region
- Validate block address bounds against superblock total block count
- All methods throw `ArgumentOutOfRangeException` for invalid block addresses

Namespace: `DataWarehouse.SDK.VirtualDiskEngine.BlockExport`
  </action>
  <verify>
`dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` compiles with 0 errors. Both files exist and contain the specified types.
  </verify>
  <done>IVdeBlockExporter interface and ZeroCopyBlockReader implementation exist, compile clean, and support zero-copy memory-mapped block reads.</done>
</task>

<task type="auto">
  <name>Task 2: VdeBlockExportPath protocol fast path</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/BlockExport/VdeBlockExportPath.cs
  </files>
  <action>
**VdeBlockExportPath.cs**: Protocol-agnostic fast path that protocol strategies call instead of going through the plugin pipeline:
- Constructor takes `IVdeBlockExporter exporter`, `SuperblockV2 superblock` (for validation), and optional `ILogger`
- `ValueTask<ReadOnlyMemory<byte>> ServeBlockAsync(long blockAddress, ProtocolHint hint)` -- main entry point for protocol strategies; validates block address, checks region ownership, returns block data via zero-copy path
- `ProtocolHint` enum: Smb, Nfs, Iscsi, FibreChannel, NvmeOverFabric, Generic -- allows protocol-specific optimizations (e.g., NVMe-oF may use different alignment)
- `ValueTask<int> ServeBatchAsync(long startBlock, int count, Memory<byte> destination, ProtocolHint hint)` -- batch serving for protocols that support multi-block reads (iSCSI, NVMe-oF)
- `ExportStatistics GetStatistics()` -- tracks total blocks served, zero-copy hits, fallback count, average latency (use Interlocked for thread safety)
- `ExportStatistics` record: TotalBlocksServed (long), ZeroCopyHits (long), FallbackCount (long), AverageLatencyMicroseconds (double)
- If ZeroCopyBlockReader cannot serve (e.g., block in encrypted region), fall back to standard IBlockDevice.ReadAsync and increment FallbackCount
- Thread-safe: multiple protocol handlers can call concurrently (MemoryMappedViewAccessor is thread-safe for reads)

Add XML documentation on all public members explaining the zero-copy bypass rationale and when to use this vs the plugin pipeline.
  </action>
  <verify>
`dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` compiles with 0 errors and 0 warnings. VdeBlockExportPath.cs exists with ServeBlockAsync, ServeBatchAsync, GetStatistics methods.
  </verify>
  <done>VDE block export fast path compiles and provides protocol-agnostic zero-copy block serving with statistics tracking and encrypted-region fallback.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` passes with 0 errors, 0 warnings
- All three files exist under DataWarehouse.SDK/VirtualDiskEngine/BlockExport/
- IVdeBlockExporter defines ReadBlockZeroCopy, ReadBlocksAsync, TryGetRegionForBlock, GetCapabilities
- ZeroCopyBlockReader implements IVdeBlockExporter with MemoryMappedFile
- VdeBlockExportPath provides protocol-agnostic fast path with ProtocolHint
</verification>

<success_criteria>
- VDE-native block export contract and implementation exist in SDK
- Zero-copy memory-mapped reading bypasses plugin processing pipeline
- Protocol strategies (SMB/NFS/iSCSI/FC/NVMe-oF) have a typed fast path entry point
- Thread-safe concurrent access for multiple protocol handlers
- Fallback to standard IBlockDevice for encrypted/special regions
- Full solution builds clean
</success_criteria>

<output>
After completion, create `.planning/phases/85-competitive-edge/85-01-SUMMARY.md`
</output>
