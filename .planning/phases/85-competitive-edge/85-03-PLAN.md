---
phase: 85-competitive-edge
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.SDK/VirtualDiskEngine/FormalVerification/TlaPlusModels.cs
  - DataWarehouse.SDK/VirtualDiskEngine/FormalVerification/WalRecoveryModel.cs
  - DataWarehouse.SDK/VirtualDiskEngine/FormalVerification/RaftConsensusModel.cs
  - DataWarehouse.SDK/VirtualDiskEngine/FormalVerification/BTreeInvariantsModel.cs
autonomous: true

must_haves:
  truths:
    - "TLA+ models exist for WAL crash recovery, Raft consensus, B-Tree split/merge, and superblock update"
    - "Models are expressed as C# data structures that can generate TLA+ specification text"
    - "All model invariants are verifiable by TLC model checker"
  artifacts:
    - path: "DataWarehouse.SDK/VirtualDiskEngine/FormalVerification/TlaPlusModels.cs"
      provides: "TLA+ model generation framework and CI integration entry point"
      exports: ["TlaPlusModelGenerator", "TlaPlusSpec", "ModelCheckResult"]
    - path: "DataWarehouse.SDK/VirtualDiskEngine/FormalVerification/WalRecoveryModel.cs"
      provides: "TLA+ specification for WAL crash recovery correctness"
      exports: ["WalRecoveryModel"]
    - path: "DataWarehouse.SDK/VirtualDiskEngine/FormalVerification/RaftConsensusModel.cs"
      provides: "TLA+ specification for Raft leader election and log replication"
      exports: ["RaftConsensusModel"]
    - path: "DataWarehouse.SDK/VirtualDiskEngine/FormalVerification/BTreeInvariantsModel.cs"
      provides: "TLA+ specification for B-Tree/Be-tree split/merge invariants and superblock update"
      exports: ["BTreeInvariantsModel", "SuperblockUpdateModel"]
  key_links:
    - from: "TlaPlusModelGenerator"
      to: "All model classes"
      via: "Generates TLA+ text from C# model definitions"
      pattern: "GenerateSpec"
---

<objective>
Create TLA+ formal verification models for the four critical VDE subsystems (WAL crash recovery, Raft consensus, B-Tree split/merge, VDE superblock update) as C# model classes that generate TLA+ specification text, with a CI integration entry point for running TLC model checker.

Purpose: Formal verification proves correctness of critical algorithms mathematically, not just by testing. This is a competitive differentiator against storage products that rely solely on testing.
Output: TLA+ model generator framework, four formal models, CI runner integration.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@DataWarehouse.SDK/VirtualDiskEngine/Journal/
@DataWarehouse.SDK/VirtualDiskEngine/Format/SuperblockV2.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: TLA+ model generator framework and WAL recovery model</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/FormalVerification/TlaPlusModels.cs
    DataWarehouse.SDK/VirtualDiskEngine/FormalVerification/WalRecoveryModel.cs
  </files>
  <action>
Create the FormalVerification directory under VirtualDiskEngine.

**TlaPlusModels.cs**: Framework for generating TLA+ specs from C# models:
- `TlaPlusSpec` record: `string ModuleName`, `string SpecText`, `string[] Invariants`, `string[] TemporalProperties`, `ModelConfig Config`
- `ModelConfig` record: `int MaxStates` (default 1_000_000), `int Workers` (default 4), `Dictionary<string, int> Constants` -- model parameters
- `ModelCheckResult` record: `bool Passed`, `string? CounterExample`, `long StatesExplored`, `TimeSpan Duration`, `string[] ViolatedInvariants`
- `ITlaPlusModel` interface: `TlaPlusSpec GenerateSpec(ModelConfig? config = null)`
- `TlaPlusModelGenerator` static class:
  - `string GenerateTlcConfig(TlaPlusSpec spec)` -- generates .cfg file content for TLC
  - `string GenerateCiScript(IReadOnlyList<TlaPlusSpec> specs)` -- generates shell script that runs TLC on all specs (downloads TLC jar if missing, runs java -jar tla2tools.jar -config spec.cfg spec.tla)
  - `ModelCheckResult ParseTlcOutput(string tlcStdout)` -- parses TLC output for PASS/FAIL, state count, counterexample traces
  - `IReadOnlyList<ITlaPlusModel> GetAllModels()` -- returns all four models for CI batch run

**WalRecoveryModel.cs**: TLA+ model for WAL crash recovery:
- Implements ITlaPlusModel
- State variables: walEntries (sequence), dataBlocks (function), crashed (bool), recovering (bool)
- Actions: WriteWalEntry, FlushToData, Crash (at any point), Recover (replay WAL)
- Invariants:
  - DataConsistency: after recovery, dataBlocks matches committed WAL entries
  - WalCompleteness: every committed write has a WAL entry
  - RecoveryIdempotence: running recovery twice produces same state
  - NoPartialWrites: crash during flush leaves data in pre-flush or post-flush state (never partial)
- Model constants: MaxEntries (default 5 for tractable state space), MaxBlocks (default 3)
- GenerateSpec produces valid TLA+ module text with all variables, Init, Next, and invariant definitions
  </action>
  <verify>
`dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` compiles with 0 errors. WalRecoveryModel.GenerateSpec() produces non-empty TLA+ text containing "MODULE" and "INVARIANT".
  </verify>
  <done>TLA+ framework and WAL recovery model compile and generate valid TLA+ specification text with crash recovery invariants.</done>
</task>

<task type="auto">
  <name>Task 2: Raft, B-Tree, and superblock update models</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/FormalVerification/RaftConsensusModel.cs
    DataWarehouse.SDK/VirtualDiskEngine/FormalVerification/BTreeInvariantsModel.cs
  </files>
  <action>
**RaftConsensusModel.cs**: TLA+ model for Raft consensus:
- Implements ITlaPlusModel
- State variables: nodes (set), currentTerm (function node->nat), votedFor (function), log (function node->sequence), commitIndex (function), state (function node->{Follower,Candidate,Leader})
- Actions: RequestVote, GrantVote, AppendEntries, HandleTimeout, CommitEntry, NodeCrash, NodeRestart
- Invariants:
  - ElectionSafety: at most one leader per term
  - LogMatching: if two logs have entry with same index and term, all preceding entries match
  - LeaderCompleteness: committed entry present in all future leaders' logs
  - StateMachineSafety: all nodes that apply entry N apply same command
- Model constants: NumNodes (default 3), MaxTerm (default 3), MaxLogLen (default 4)

**BTreeInvariantsModel.cs**: Two models in one file:
1. **BTreeInvariantsModel**: TLA+ model for B-Tree/Bepsilon-tree split/merge:
   - State variables: nodes (set of {keys, children, isLeaf}), root
   - Actions: Insert, Delete, Split (when node full), Merge (when node underflow), Redistribute
   - Invariants:
     - OrderInvariant: keys in each node are sorted
     - BalanceInvariant: all leaves at same depth
     - OccupancyInvariant: every non-root node has >= ceil(order/2) keys
     - ParentChildConsistency: parent separators correctly bracket child key ranges
   - Model constants: Order (default 3 for small state space), MaxKeys (default 6)

2. **SuperblockUpdateModel**: TLA+ model for VDE superblock update:
   - State variables: primary (superblock), mirror (superblock at block 7), version (nat), crashed (bool)
   - Actions: BeginUpdate, WritePrimary, WriteMirror, IncrementVersion, Crash, RecoverFromMirror
   - Invariants:
     - MirrorConsistency: after recovery, exactly one of primary/mirror is valid and consistent
     - VersionMonotonicity: version never decreases after recovery
     - AtomicVisibility: readers see either old or new superblock, never partial
   - Model constants: MaxVersion (default 3)

Both implement ITlaPlusModel. GenerateSpec produces complete TLA+ module text.
  </action>
  <verify>
`dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` compiles with 0 errors. All three models (Raft, BTree, Superblock) produce non-empty TLA+ spec text.
  </verify>
  <done>Raft consensus, B-Tree invariants, and superblock update TLA+ models compile and generate valid specification text with all safety invariants.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` passes with 0 errors, 0 warnings
- All four files exist under DataWarehouse.SDK/VirtualDiskEngine/FormalVerification/
- Each model's GenerateSpec returns valid TLA+ text with MODULE header, VARIABLES, Init, Next, and INVARIANT sections
- TlaPlusModelGenerator.GenerateCiScript produces a runnable shell script
</verification>

<success_criteria>
- Four TLA+ formal verification models (WAL, Raft, B-Tree, Superblock) exist as C# classes
- Each model generates complete TLA+ specification text
- CI integration script generator exists for running TLC model checker
- All safety invariants documented and included in specs
- Full solution builds clean
</success_criteria>

<output>
After completion, create `.planning/phases/85-competitive-edge/85-03-SUMMARY.md`
</output>
