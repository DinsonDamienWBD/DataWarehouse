---
phase: 85-competitive-edge
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.SDK/Security/ActiveDirectory/IKerberosAuthenticator.cs
  - DataWarehouse.SDK/Security/ActiveDirectory/SpnegoNegotiator.cs
  - DataWarehouse.SDK/Security/ActiveDirectory/ActiveDirectoryRoleMapper.cs
autonomous: true

must_haves:
  truths:
    - "SPNEGO negotiation accepts Kerberos tickets from AD-joined clients"
    - "Kerberos ticket validation verifies service principal and ticket integrity"
    - "AD group membership maps to DataWarehouse roles without manual per-user configuration"
  artifacts:
    - path: "DataWarehouse.SDK/Security/ActiveDirectory/IKerberosAuthenticator.cs"
      provides: "Contract for Kerberos authentication and ticket validation"
      exports: ["IKerberosAuthenticator", "KerberosTicket", "KerberosValidationResult"]
    - path: "DataWarehouse.SDK/Security/ActiveDirectory/SpnegoNegotiator.cs"
      provides: "SPNEGO token exchange for Negotiate auth"
      exports: ["SpnegoNegotiator"]
    - path: "DataWarehouse.SDK/Security/ActiveDirectory/ActiveDirectoryRoleMapper.cs"
      provides: "AD group-to-DW role mapping with configurable rules"
      exports: ["ActiveDirectoryRoleMapper", "AdGroupRoleMapping"]
  key_links:
    - from: "SpnegoNegotiator"
      to: "IKerberosAuthenticator"
      via: "Delegates ticket validation after SPNEGO unwrap"
      pattern: "IKerberosAuthenticator\\.Validate"
    - from: "ActiveDirectoryRoleMapper"
      to: "AccessControl"
      via: "Maps AD groups to DW roles for access enforcement"
      pattern: "AdGroupRoleMapping"
---

<objective>
Implement native Active Directory / Kerberos authentication for DataWarehouse -- SPNEGO negotiation, Kerberos ticket validation, AD group-to-role mapping, and service principal management.

Purpose: Enterprise environments require seamless AD integration. Existing LDAP strategy handles directory queries but not Kerberos authentication. This adds the authentication layer so AD-joined clients authenticate transparently.
Output: IKerberosAuthenticator contract, SpnegoNegotiator, ActiveDirectoryRoleMapper.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@DataWarehouse.SDK/Security/AccessControl.cs
@DataWarehouse.SDK/Security/ISecurityContext.cs
@DataWarehouse.SDK/Security/SecurityContracts.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Kerberos authentication contract and SPNEGO negotiator</name>
  <files>
    DataWarehouse.SDK/Security/ActiveDirectory/IKerberosAuthenticator.cs
    DataWarehouse.SDK/Security/ActiveDirectory/SpnegoNegotiator.cs
  </files>
  <action>
Create the ActiveDirectory directory under Security.

**IKerberosAuthenticator.cs**: Define Kerberos authentication types and contract:
- `KerberosTicket` record: `byte[] TokenData`, `string ClientPrincipal`, `string ServicePrincipal`, `DateTimeOffset ValidUntil`, `KerberosEncryptionType EncType`
- `KerberosEncryptionType` enum: Aes256CtsHmacSha1, Aes128CtsHmacSha1, Rc4Hmac (legacy, should warn)
- `KerberosValidationResult` record: `bool IsValid`, `string? Principal`, `string[]? Groups`, `string? ErrorMessage`, `DateTimeOffset? ExpiresAt`
- `ServicePrincipalConfig` record: `string ServiceName` (default "datawarehouse"), `string? Realm`, `string? KeytabPath`, `bool AllowDelegation`
- `IKerberosAuthenticator` interface:
  - `ValueTask<KerberosValidationResult> ValidateTicketAsync(byte[] ticket, CancellationToken ct)`
  - `ValueTask<byte[]> GetServiceTokenAsync(ServicePrincipalConfig config, CancellationToken ct)` -- for mutual auth
  - `bool IsAvailable { get; }` -- true if Kerberos infrastructure is reachable

**SpnegoNegotiator.cs**: Handles SPNEGO (RFC 4178) token exchange:
- Constructor takes `IKerberosAuthenticator authenticator` and optional `ILogger`
- `NegotiationState` enum: Initial, ChallengeIssued, Authenticated, Failed
- `SpnegoContext` class: tracks multi-leg negotiation state, current NegotiationState, and session key
- `ValueTask<SpnegoResponse> ProcessTokenAsync(byte[] incomingToken, SpnegoContext context, CancellationToken ct)` -- main entry: parse SPNEGO wrapper (OID 1.3.6.1.5.5.2), extract Kerberos AP-REQ, delegate to IKerberosAuthenticator, return SPNEGO response token
- `SpnegoResponse` record: `byte[]? ResponseToken`, `NegotiationState State`, `KerberosValidationResult? Result`
- Parse GSS-API header: check OID, extract mechanism token (Kerberos OID 1.2.840.113554.1.2.2)
- If RC4-HMAC ticket detected, log warning about weak encryption but still process (configurable via `bool RejectLegacyEncryption`)

Namespace: `DataWarehouse.SDK.Security.ActiveDirectory`
  </action>
  <verify>
`dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` compiles with 0 errors.
  </verify>
  <done>IKerberosAuthenticator and SpnegoNegotiator exist with SPNEGO token parsing and Kerberos ticket validation delegation.</done>
</task>

<task type="auto">
  <name>Task 2: AD group-to-role mapping</name>
  <files>
    DataWarehouse.SDK/Security/ActiveDirectory/ActiveDirectoryRoleMapper.cs
  </files>
  <action>
**ActiveDirectoryRoleMapper.cs**: Maps Active Directory group SIDs/names to DataWarehouse roles:
- `AdGroupRoleMapping` record: `string AdGroupIdentifier` (SID or distinguished name), `string DwRole`, `int Priority` (higher priority wins on conflict), `bool IsWildcard` (e.g., "Domain Admins" -> "admin")
- `ActiveDirectoryRoleMappingConfig` record: `IReadOnlyList<AdGroupRoleMapping> Mappings`, `string DefaultRole` (default "viewer"), `bool MapDomainAdminsToAdmin` (default true), `bool MapEnterpriseAdminsToSuperAdmin` (default true)
- `ActiveDirectoryRoleMapper` class:
  - Constructor takes `ActiveDirectoryRoleMappingConfig config` and optional `ILogger`
  - `IReadOnlyList<string> MapGroupsToRoles(IReadOnlyList<string> adGroups)` -- resolves AD group list to DW roles using configured mappings, ordered by priority, highest priority mapping wins per group
  - `string GetEffectiveRole(IReadOnlyList<string> adGroups)` -- returns single highest-privilege role (for primary role assignment); use well-known precedence: super_admin > admin > operator > editor > viewer
  - Built-in well-known mappings (applied when MapDomainAdminsToAdmin/MapEnterpriseAdminsToSuperAdmin are true):
    - "Domain Admins" / S-1-5-21-*-512 -> "admin"
    - "Enterprise Admins" / S-1-5-21-*-519 -> "super_admin"
    - "Domain Users" / S-1-5-21-*-513 -> "viewer"
  - `void ValidateConfig()` -- checks for duplicate group mappings, warns on conflicting priorities
  - Thread-safe: config is immutable after construction; FrozenDictionary for group->mapping lookup

All public types have XML documentation explaining the AD integration model and configuration options.
  </action>
  <verify>
`dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` compiles with 0 errors and 0 warnings.
  </verify>
  <done>ActiveDirectoryRoleMapper maps AD groups to DW roles with well-known defaults, configurable mappings, priority-based conflict resolution, and FrozenDictionary lookup.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` passes with 0 errors, 0 warnings
- All three files exist under DataWarehouse.SDK/Security/ActiveDirectory/
- IKerberosAuthenticator defines ValidateTicketAsync and GetServiceTokenAsync
- SpnegoNegotiator handles SPNEGO OID parsing and multi-leg negotiation
- ActiveDirectoryRoleMapper maps AD groups to DW roles with built-in well-known mappings
</verification>

<success_criteria>
- Native AD/Kerberos authentication contract exists in SDK
- SPNEGO negotiation handles GSS-API token exchange
- Kerberos ticket validation with encryption type awareness
- AD group-to-role mapping with configurable priority rules
- Well-known AD groups (Domain Admins, Enterprise Admins) have default mappings
- Full solution builds clean
</success_criteria>

<output>
After completion, create `.planning/phases/85-competitive-edge/85-02-SUMMARY.md`
</output>
