---
phase: 90-device-discovery-physical-block
plan: 06
type: execute
wave: 4
depends_on: ["90-02", "90-03", "90-04", "90-05"]
files_modified:
  - Plugins/DataWarehouse.Plugins.UltimateFilesystem/Strategies/DeviceDiscoveryStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateFilesystem/Strategies/DeviceHealthStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateFilesystem/Strategies/DevicePoolStrategy.cs
  - Plugins/DataWarehouse.Plugins.UltimateFilesystem/UltimateFilesystemPlugin.cs
autonomous: true

must_haves:
  truths:
    - "Device discovery, health monitoring, and pool management are registered as filesystem strategies"
    - "UltimateFilesystemPlugin handles device.* message bus topics for device lifecycle"
    - "Message bus events are published for device discovery, health changes, pool mutations, hot-swap"
    - "All Phase 90 functionality is accessible through the UltimateFilesystem plugin's message bus API"
  artifacts:
    - path: "Plugins/DataWarehouse.Plugins.UltimateFilesystem/Strategies/DeviceDiscoveryStrategy.cs"
      provides: "Strategy wrapping DeviceDiscoveryService + DeviceTopologyMapper"
      contains: "class DeviceDiscoveryStrategy"
    - path: "Plugins/DataWarehouse.Plugins.UltimateFilesystem/Strategies/DeviceHealthStrategy.cs"
      provides: "Strategy wrapping PhysicalDeviceManager + SmartMonitor"
      contains: "class DeviceHealthStrategy"
    - path: "Plugins/DataWarehouse.Plugins.UltimateFilesystem/Strategies/DevicePoolStrategy.cs"
      provides: "Strategy wrapping DevicePoolManager + HotSwapManager + BaremetalBootstrap"
      contains: "class DevicePoolStrategy"
  key_links:
    - from: "UltimateFilesystemPlugin"
      to: "DeviceDiscoveryStrategy"
      via: "message handler routing for device.discover topic"
      pattern: "device\\.discover"
    - from: "UltimateFilesystemPlugin"
      to: "DeviceHealthStrategy"
      via: "message handler routing for device.health topic"
      pattern: "device\\.health"
    - from: "UltimateFilesystemPlugin"
      to: "DevicePoolStrategy"
      via: "message handler routing for device.pool topic"
      pattern: "device\\.pool"
    - from: "DevicePoolStrategy"
      to: "DevicePoolManager"
      via: "delegates pool operations"
      pattern: "DevicePoolManager"
---

<objective>
Wire all Phase 90 device management classes as UltimateFilesystem strategies with message bus integration. Add device.* message topics to UltimateFilesystemPlugin for device lifecycle operations.

Purpose: Makes device management accessible through the standard plugin message bus API, consistent with the microkernel architecture. Other plugins (CompoundBlockDevice in Phase 91, VDE) can discover and manage devices via message bus.
Output: Three strategy files plus updated plugin with device message handlers.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md (Phase 90, success criteria 8: all device management in UltimateFilesystem)
@.planning/phases/90-device-discovery-physical-block/90-01-SUMMARY.md
@.planning/phases/90-device-discovery-physical-block/90-02-SUMMARY.md
@.planning/phases/90-device-discovery-physical-block/90-03-SUMMARY.md
@.planning/phases/90-device-discovery-physical-block/90-04-SUMMARY.md
@.planning/phases/90-device-discovery-physical-block/90-05-SUMMARY.md
@Plugins/DataWarehouse.Plugins.UltimateFilesystem/UltimateFilesystemPlugin.cs (existing plugin with filesystem.* handlers)
@Plugins/DataWarehouse.Plugins.UltimateFilesystem/FilesystemStrategyBase.cs (FilesystemStrategyBase, FilesystemStrategyCategory, registry)
@Plugins/DataWarehouse.Plugins.UltimateFilesystem/Strategies/DriverStrategies.cs (example strategy pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Device management strategies</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateFilesystem/Strategies/DeviceDiscoveryStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateFilesystem/Strategies/DeviceHealthStrategy.cs
    Plugins/DataWarehouse.Plugins.UltimateFilesystem/Strategies/DevicePoolStrategy.cs
  </files>
  <action>
All three strategies extend `FilesystemStrategyBase` and use `FilesystemStrategyCategory.Block` (closest existing category for device-level operations). Add `[SdkCompatibility("6.0.0")]` to each.

**DeviceDiscoveryStrategy.cs** - namespace DataWarehouse.Plugins.UltimateFilesystem.Strategies:
- StrategyId: `"device-discovery"`
- DisplayName: `"Device Discovery"`
- Wraps `DeviceDiscoveryService` (from SDK) and `DeviceTopologyMapper` (from DeviceManagement/)
- Instantiates both in InitializeCoreAsync
- DetectAsync: not applicable, return null
- ReadBlockAsync/WriteBlockAsync: not applicable, throw NotSupportedException("Use device.discover message topic")
- GetMetadataAsync: return metadata with device count, topology summary
- **Additional public methods** (called by plugin message handlers):
  - `Task<IReadOnlyList<PhysicalDeviceInfo>> DiscoverAsync(DeviceDiscoveryOptions? options, CancellationToken ct)` -- delegates to DeviceDiscoveryService
  - `DeviceTopologyTree BuildTopology(IReadOnlyList<PhysicalDeviceInfo> devices)` -- delegates to DeviceTopologyMapper
  - `IReadOnlyList<NumaAffinityInfo> GetNumaAffinity(DeviceTopologyTree tree)` -- delegates to DeviceTopologyMapper

**DeviceHealthStrategy.cs** - same namespace:
- StrategyId: `"device-health"`
- DisplayName: `"Device Health Monitor"`
- Wraps `PhysicalDeviceManager`, `SmartMonitor`, `FailurePredictionEngine` (from DeviceManagement/)
- Instantiates SmartMonitor + FailurePredictionEngine in InitializeCoreAsync; PhysicalDeviceManager needs DeviceDiscoveryService (get from DeviceDiscoveryStrategy or instantiate fresh)
- **Additional public methods**:
  - `Task<PhysicalDeviceHealth> GetHealthAsync(string devicePath, BusType busType, CancellationToken ct)` -- delegates to SmartMonitor
  - `FailurePrediction GetPrediction(string deviceId, PhysicalDeviceHealth health)` -- delegates to FailurePredictionEngine
  - `PhysicalDeviceManager GetDeviceManager()` -- exposes manager for HotSwapManager integration
- DisposeCoreAsync: stop PhysicalDeviceManager

**DevicePoolStrategy.cs** - same namespace:
- StrategyId: `"device-pool"`
- DisplayName: `"Device Pool Manager"`
- Wraps `DevicePoolManager`, `HotSwapManager`, `BaremetalBootstrap`, `DeviceJournal` (from DeviceManagement/)
- Instantiates PoolMetadataCodec, DeviceJournal, DevicePoolManager, HotSwapManager, BaremetalBootstrap in InitializeCoreAsync
- **Additional public methods**:
  - `Task<DevicePoolDescriptor> CreatePoolAsync(string name, StorageTier? tier, LocalityTag? locality, IReadOnlyList<IPhysicalBlockDevice> devices, CancellationToken ct)` -- delegates to DevicePoolManager
  - `Task<IReadOnlyList<DevicePoolDescriptor>> GetPoolsAsync()` -- delegates to DevicePoolManager
  - `Task<BootstrapResult> BootstrapAsync(CancellationToken ct)` -- delegates to BaremetalBootstrap
  - `Task StartHotSwapAsync(CancellationToken ct)` -- starts HotSwapManager
  - `Task StopHotSwapAsync()` -- stops HotSwapManager
  - `HotSwapManager GetHotSwapManager()` -- exposes for event subscription
- DisposeCoreAsync: stop hot-swap, dispose pool manager
  </action>
  <verify>
Run `dotnet build Plugins/DataWarehouse.Plugins.UltimateFilesystem/DataWarehouse.Plugins.UltimateFilesystem.csproj` and confirm zero errors. Grep for all three strategy IDs: "device-discovery", "device-health", "device-pool".
  </verify>
  <done>
Three strategies (DeviceDiscoveryStrategy, DeviceHealthStrategy, DevicePoolStrategy) wrap all Phase 90 device management classes and are auto-discoverable by FilesystemStrategyRegistry.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire device.* message bus topics into UltimateFilesystemPlugin</name>
  <files>
    Plugins/DataWarehouse.Plugins.UltimateFilesystem/UltimateFilesystemPlugin.cs
  </files>
  <action>
Modify the existing UltimateFilesystemPlugin.cs to add device management message handlers. Read the file first.

**Add to GetCapabilities() list:**
```
new() { Name = "device.discover", DisplayName = "Discover Devices", Description = "Enumerate physical storage devices" },
new() { Name = "device.topology", DisplayName = "Device Topology", Description = "Build controller->bus->device tree" },
new() { Name = "device.health", DisplayName = "Device Health", Description = "Get SMART health for a device" },
new() { Name = "device.predict", DisplayName = "Failure Prediction", Description = "Predict device failure risk" },
new() { Name = "device.pool.create", DisplayName = "Create Pool", Description = "Create named device pool" },
new() { Name = "device.pool.list", DisplayName = "List Pools", Description = "List all device pools" },
new() { Name = "device.pool.delete", DisplayName = "Delete Pool", Description = "Delete a device pool" },
new() { Name = "device.bootstrap", DisplayName = "Bare-Metal Bootstrap", Description = "Initialize from raw devices" },
new() { Name = "device.hotswap.start", DisplayName = "Start Hot-Swap", Description = "Enable hot-swap monitoring" },
new() { Name = "device.hotswap.stop", DisplayName = "Stop Hot-Swap", Description = "Disable hot-swap monitoring" },
```

**Add to OnMessageAsync switch:**
```csharp
"device.discover" => HandleDeviceDiscoverAsync(message),
"device.topology" => HandleDeviceTopologyAsync(message),
"device.health" => HandleDeviceHealthAsync(message),
"device.predict" => HandleDevicePredictAsync(message),
"device.pool.create" => HandleDevicePoolCreateAsync(message),
"device.pool.list" => HandleDevicePoolListAsync(message),
"device.pool.delete" => HandleDevicePoolDeleteAsync(message),
"device.bootstrap" => HandleDeviceBootstrapAsync(message),
"device.hotswap.start" => HandleDeviceHotswapStartAsync(message),
"device.hotswap.stop" => HandleDeviceHotswapStopAsync(message),
```

**Add private handler methods** in a new `#region Device Management Handlers` section:
- Each handler: get the appropriate strategy from `_registry.Get("device-discovery"|"device-health"|"device-pool")`, cast to the concrete strategy type, call the corresponding method, populate message.Payload with results.
- `HandleDeviceDiscoverAsync`: call DeviceDiscoveryStrategy.DiscoverAsync, return device list as serializable dictionaries in payload
- `HandleDeviceTopologyAsync`: call DiscoverAsync then BuildTopology, return tree summary (controller count, device count, NUMA nodes)
- `HandleDeviceHealthAsync`: requires "devicePath" and "busType" in payload, calls DeviceHealthStrategy.GetHealthAsync
- `HandleDevicePredictAsync`: requires "deviceId" in payload, calls GetPrediction with latest health
- `HandleDevicePoolCreateAsync`: requires "poolName" and "devicePaths" in payload, calls DevicePoolStrategy.CreatePoolAsync
- `HandleDevicePoolListAsync`: calls DevicePoolStrategy.GetPoolsAsync, returns pool descriptors
- `HandleDevicePoolDeleteAsync`: requires "poolId" in payload, calls DevicePoolManager.DeletePoolAsync
- `HandleDeviceBootstrapAsync`: calls DevicePoolStrategy.BootstrapAsync, returns BootstrapResult
- `HandleDeviceHotswapStartAsync`/`StopAsync`: calls DevicePoolStrategy.StartHotSwapAsync/StopHotSwapAsync

**Update SemanticDescription** to mention device discovery and management.
**Update SemanticTags** to include `"device-discovery"`, `"smart"`, `"device-pool"`, `"hot-swap"`, `"bare-metal"`.
**Update GetMetadata()** to include device strategy counts.

Error handling: all handlers wrap in try-catch, setting message.Payload["success"]=false and message.Payload["error"] on failure, consistent with existing handler pattern.
  </action>
  <verify>
Run `dotnet build Plugins/DataWarehouse.Plugins.UltimateFilesystem/DataWarehouse.Plugins.UltimateFilesystem.csproj` and confirm zero errors. Grep for "device.discover" and "device.bootstrap" in UltimateFilesystemPlugin.cs to confirm message handlers are wired.
  </verify>
  <done>
UltimateFilesystemPlugin handles 10 device.* message bus topics. All Phase 90 functionality is accessible through the standard plugin message bus API. Strategies are auto-discovered by the existing FilesystemStrategyRegistry.
  </done>
</task>

</tasks>

<verification>
- `dotnet build` succeeds for UltimateFilesystem plugin
- UltimateFilesystemPlugin.OnMessageAsync routes all device.* topics
- Three new strategies are registered in FilesystemStrategyRegistry
- GetCapabilities returns device.* capabilities
- SemanticTags include device-related tags
- All handlers follow existing error handling pattern (success/error in payload)
</verification>

<success_criteria>
All Phase 90 device management is accessible through UltimateFilesystem's message bus API. Device discovery, health monitoring, pool management, topology, hot-swap, and bare-metal bootstrap are all message-bus-addressable, consistent with the microkernel architecture.
</success_criteria>

<output>
After completion, create `.planning/phases/90-device-discovery-physical-block/90-06-SUMMARY.md`
</output>
