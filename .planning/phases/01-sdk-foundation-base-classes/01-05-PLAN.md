---
phase: 01-sdk-foundation-base-classes
plan: 05
type: tdd
wave: 2
depends_on: ["01-01"]
files_modified:
  - DataWarehouse.Tests/Infrastructure/EnvelopeEncryptionIntegrationTests.cs
  - DataWarehouse.Tests/Infrastructure/EnvelopeEncryptionBenchmarks.cs
  - DataWarehouse.SDK/Security/IKeyStore.cs
  - DataWarehouse.SDK/Contracts/Encryption/EncryptionStrategy.cs
  - Metadata/TODO.md
autonomous: true
must_haves:
  truths:
    - "Envelope mode integration tests exist that test all 6 encryption plugins with both Direct and Envelope key management modes"
    - "Envelope mode benchmarks exist comparing Direct vs Envelope performance"
    - "KeyManagementMode enum has both Direct and Envelope values"
    - "IEnvelopeKeyStore interface has WrapKeyAsync and UnwrapKeyAsync methods"
    - "EncryptionStrategyBase supports both Direct and Envelope modes in its encrypt/decrypt flow"
    - "All integration tests pass"
  artifacts:
    - path: "DataWarehouse.Tests/Infrastructure/EnvelopeEncryptionIntegrationTests.cs"
      provides: "Integration tests for envelope encryption mode (T5.1.2)"
      contains: "EnvelopeEncryptionIntegrationTests"
    - path: "DataWarehouse.Tests/Infrastructure/EnvelopeEncryptionBenchmarks.cs"
      provides: "Performance benchmarks for Direct vs Envelope encryption (T5.1.4)"
      contains: "EnvelopeEncryptionBenchmarks"
    - path: "DataWarehouse.SDK/Security/IKeyStore.cs"
      provides: "Key management interfaces including IEnvelopeKeyStore"
      contains: "IEnvelopeKeyStore"
    - path: "DataWarehouse.SDK/Contracts/Encryption/EncryptionStrategy.cs"
      provides: "Encryption strategy infrastructure supporting both key modes"
      contains: "EncryptionStrategyBase"
  key_links:
    - from: "DataWarehouse.SDK/Contracts/Encryption/EncryptionStrategy.cs"
      to: "DataWarehouse.SDK/Security/IKeyStore.cs"
      via: "Envelope mode uses IEnvelopeKeyStore for key wrapping"
      pattern: "IEnvelopeKeyStore"
    - from: "DataWarehouse.Tests/Infrastructure/EnvelopeEncryptionIntegrationTests.cs"
      to: "DataWarehouse.SDK/Security/IKeyStore.cs"
      via: "Tests verify both Direct and Envelope key modes"
      pattern: "KeyManagementMode"
---

<objective>
Verify and complete envelope encryption support (T5.1.2 integration tests, T5.1.4 benchmarks) and validate that the SDK encryption infrastructure correctly supports both Direct and Envelope key management modes.

Purpose: Envelope encryption is critical for HSM integration and key rotation without re-encrypting data. The types exist (verified in research) but integration tests and benchmarks are missing. This plan verifies the SDK types and creates the missing test/benchmark files.

Output: Verified envelope encryption SDK types, integration test file, benchmark file, TODO.md updated.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-sdk-foundation-base-classes/01-RESEARCH.md
@.planning/phases/01-sdk-foundation-base-classes/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify envelope encryption SDK types and write integration tests (T5.1.2)</name>
  <files>
    DataWarehouse.SDK/Security/IKeyStore.cs
    DataWarehouse.SDK/Contracts/Encryption/EncryptionStrategy.cs
    DataWarehouse.Tests/Infrastructure/EnvelopeEncryptionIntegrationTests.cs
    Metadata/TODO.md
  </files>
  <action>
    **Step 1: Verify SDK envelope types are production-ready**

    Read `DataWarehouse.SDK/Security/IKeyStore.cs` and verify:
    1. `KeyManagementMode` enum exists with `Direct = 0` and `Envelope = 1`
    2. `IKeyStore` interface exists with key retrieval methods
    3. `IEnvelopeKeyStore` interface extends `IKeyStore` with:
       - `Task<byte[]> WrapKeyAsync(byte[] plainKey, string kekId, CancellationToken ct)`
       - `Task<byte[]> UnwrapKeyAsync(byte[] wrappedKey, string kekId, CancellationToken ct)`
    4. `EnvelopeHeader` type exists with wrapped DEK, KEK ID, algorithm info
    5. `EncryptionMetadata` type exists with mode indicator

    Read `DataWarehouse.SDK/Contracts/Encryption/EncryptionStrategy.cs` and verify:
    1. `EncryptionStrategyBase` class handles both Direct and Envelope modes
    2. Envelope flow: generate DEK -> wrap DEK with KEK -> encrypt data with DEK -> store wrapped DEK in metadata
    3. Direct flow: get key from IKeyStore -> encrypt data with key
    4. Both modes produce serializable metadata

    If any SDK types are incomplete: fix them. If they have stubs or placeholder logic: implement real logic.

    **Step 2: Write integration tests (T5.1.2)**

    Create `DataWarehouse.Tests/Infrastructure/EnvelopeEncryptionIntegrationTests.cs`:

    Test scenarios (use in-memory test implementations of IKeyStore and IEnvelopeKeyStore):

    1. `Direct_Mode_Encrypt_Decrypt_RoundTrip` — Encrypt data using Direct mode, decrypt, verify original data matches
    2. `Envelope_Mode_Encrypt_Decrypt_RoundTrip` — Encrypt data using Envelope mode (DEK wrapped by KEK), decrypt by unwrapping DEK then decrypting, verify original data matches
    3. `Envelope_Mode_Metadata_Contains_WrappedDek` — Verify that metadata from envelope encryption includes the wrapped DEK and KEK identifier
    4. `Direct_And_Envelope_Produce_Different_Metadata` — Same plaintext encrypted with both modes produces different metadata structures
    5. `Envelope_Mode_Key_Rotation_Without_Reencrypt` — Simulate re-wrapping DEK with new KEK without re-encrypting data; old wrapped DEK becomes invalid, new wrapped DEK works
    6. `Invalid_KEK_Unwrap_Throws` — Attempting to unwrap DEK with wrong KEK throws appropriate exception

    Create test helper classes:
    - `InMemoryKeyStore : IKeyStore` — simple dictionary-based key store for testing
    - `InMemoryEnvelopeKeyStore : IEnvelopeKeyStore` — simple AES-based key wrapping for testing

    Follow existing test patterns from `DataWarehouse.Tests/Infrastructure/SdkInfrastructureTests.cs`.
    Mark T5.1.2 as [x] in TODO.md (line 3389) after tests pass.
  </action>
  <verify>
    Run `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter "FullyQualifiedName~EnvelopeEncryptionIntegration"` — all tests pass.
    Grep for `KeyManagementMode` in IKeyStore.cs — must exist with Direct and Envelope values.
    Grep for `IEnvelopeKeyStore` in IKeyStore.cs — must exist with WrapKeyAsync and UnwrapKeyAsync.
  </verify>
  <done>
    Envelope encryption SDK types verified production-ready. 6 integration tests written and passing covering Direct mode, Envelope mode, metadata verification, key rotation, and error cases. T5.1.2 marked [x] in TODO.md.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write envelope mode performance benchmarks (T5.1.4)</name>
  <files>
    DataWarehouse.Tests/Infrastructure/EnvelopeEncryptionBenchmarks.cs
    Metadata/TODO.md
  </files>
  <action>
    Create `DataWarehouse.Tests/Infrastructure/EnvelopeEncryptionBenchmarks.cs`:

    This is a benchmark test file that measures and compares Direct vs Envelope encryption performance. Since BenchmarkDotNet may not be available, implement as xUnit tests with timing measurements.

    **Benchmark scenarios:**

    1. `Benchmark_Direct_Mode_Encryption` — Time 1000 encrypt operations using Direct mode with various data sizes (1KB, 10KB, 100KB, 1MB)
    2. `Benchmark_Envelope_Mode_Encryption` — Time 1000 encrypt operations using Envelope mode with same data sizes
    3. `Benchmark_Direct_Mode_Decryption` — Time 1000 decrypt operations using Direct mode
    4. `Benchmark_Envelope_Mode_Decryption` — Time 1000 decrypt operations using Envelope mode
    5. `Benchmark_Key_Wrap_Unwrap_Overhead` — Measure overhead of WrapKeyAsync + UnwrapKeyAsync separately
    6. `Compare_Direct_Vs_Envelope_Overhead` — Assert envelope mode overhead is within acceptable bounds (e.g., <20% slower than direct for key wrapping, data encryption should be identical speed since same algorithm is used)

    Implementation approach:
    - Use `Stopwatch` for timing
    - Use the same InMemoryKeyStore/InMemoryEnvelopeKeyStore from Task 1
    - Generate random test data of specified sizes
    - Run each scenario multiple times, calculate average, min, max
    - Log results via xUnit output (`ITestOutputHelper`)
    - Tests should PASS (not fail) — they measure and report, not enforce strict thresholds (since test environment varies)

    **If BenchmarkDotNet is available in the test project:** Use it for proper benchmarking instead. Check the test .csproj for the package.

    Mark T5.1.4 as [x] in TODO.md (line 3391) after benchmarks run successfully.
  </action>
  <verify>
    Run `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter "FullyQualifiedName~EnvelopeEncryptionBenchmark"` — all benchmarks run and pass.
    Verify benchmark file has at least 5 test methods measuring different scenarios.
    Verify output includes timing information for both Direct and Envelope modes.
  </verify>
  <done>
    Envelope encryption benchmarks written and running. Benchmarks measure Direct vs Envelope performance across multiple data sizes. Results show envelope overhead is quantified. T5.1.4 marked [x] in TODO.md.
  </done>
</task>

</tasks>

<verification>
1. `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj` — all tests pass (new and existing)
2. Integration tests verify both Direct and Envelope key management modes
3. Integration tests verify metadata contains wrapped DEK in Envelope mode
4. Integration tests verify key rotation works without re-encryption
5. Benchmarks measure and report Direct vs Envelope performance
6. KeyManagementMode enum has Direct and Envelope values
7. IEnvelopeKeyStore has WrapKeyAsync and UnwrapKeyAsync methods
8. TODO.md T5.1.2 and T5.1.4 marked [x]
</verification>

<success_criteria>
- All envelope encryption SDK types verified production-ready
- 6+ integration tests passing for envelope encryption
- 5+ benchmark scenarios measuring Direct vs Envelope performance
- Both Direct and Envelope key management modes work end-to-end
- TODO.md T5.1.2 (line 3389) and T5.1.4 (line 3391) marked [x]
</success_criteria>

<output>
After completion, create `.planning/phases/01-sdk-foundation-base-classes/01-05-SUMMARY.md`
</output>
