---
phase: 71-vde-format-v2
plan: 06
type: execute
wave: 4
depends_on: ["71-03", "71-04", "71-05"]
files_modified:
  - DataWarehouse.SDK/VirtualDiskEngine/Format/VdeCreationProfile.cs
  - DataWarehouse.SDK/VirtualDiskEngine/Format/DualWalHeader.cs
  - DataWarehouse.SDK/VirtualDiskEngine/Format/ThinProvisioning.cs
  - DataWarehouse.SDK/VirtualDiskEngine/Format/VdeCreator.cs
autonomous: true

must_haves:
  truths:
    - "All 7 creation profiles (Minimal, Standard, Enterprise, MaxSecurity, Edge/IoT, Analytics, Custom) are defined with correct module manifests"
    - "VdeCreator produces a valid DWVD v2.0 file that passes magic signature and trailer validation"
    - "Dual WAL headers (Metadata WAL + Data WAL) are initialized in the created VDE"
    - "Thin provisioning: a 1TB VDE with 1MB data occupies ~1MB on disk via sparse file semantics"
    - "Sub-4K block sizes (512B, 1K, 2K) are supported for IoT/embedded profiles"
    - "Custom profile allows any module combination and block size"
  artifacts:
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Format/VdeCreationProfile.cs"
      provides: "7 preset profiles + Custom with all configuration"
      exports: ["VdeCreationProfile", "VdeProfileType"]
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Format/DualWalHeader.cs"
      provides: "Metadata WAL and Data WAL header structures"
      exports: ["WalHeader", "WalType"]
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Format/ThinProvisioning.cs"
      provides: "Sparse file creation and thin provisioning support"
      exports: ["ThinProvisioning"]
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Format/VdeCreator.cs"
      provides: "Creates complete DWVD v2.0 files from profiles"
      exports: ["VdeCreator"]
  key_links:
    - from: "VdeCreator"
      to: "SuperblockGroup, RegionDirectory, InodeLayoutDescriptor, UniversalBlockTrailer"
      via: "assembles all format components into a complete VDE file"
      pattern: "SuperblockGroup|RegionDirectory|InodeLayoutDescriptor"
    - from: "VdeCreationProfile"
      to: "ModuleManifestField, ModuleConfigField"
      via: "each profile specifies module manifest and config"
      pattern: "ModuleManifest|ModuleConfig"
---

<objective>
Implement the 7 VDE creation profiles (Minimal, Standard, Enterprise, MaxSecurity, Edge/IoT, Analytics, Custom), Dual WAL headers (Metadata + Data), thin provisioning with sparse file semantics, and the VdeCreator that assembles all format components into a complete DWVD v2.0 file.

Purpose: This is the integration plan that ties all format components together into a working VDE creator. After this plan, the system can create valid DWVD v2.0 files with any module combination, any block size (512-64K), and thin provisioning.
Output: Four source files completing the v2.0 format implementation.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/v6.0-VDE-FORMAT-v2.0-SPEC.md
@.planning/phases/71-vde-format-v2/71-01-SUMMARY.md
@.planning/phases/71-vde-format-v2/71-02-SUMMARY.md
@.planning/phases/71-vde-format-v2/71-03-SUMMARY.md
@.planning/phases/71-vde-format-v2/71-04-SUMMARY.md
@.planning/phases/71-vde-format-v2/71-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Creation profiles, Dual WAL, and thin provisioning</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/Format/VdeCreationProfile.cs
    DataWarehouse.SDK/VirtualDiskEngine/Format/DualWalHeader.cs
    DataWarehouse.SDK/VirtualDiskEngine/Format/ThinProvisioning.cs
  </files>
  <action>
**VdeCreationProfile.cs**:

`VdeProfileType` enum: `Minimal, Standard, Enterprise, MaxSecurity, EdgeIoT, Analytics, Custom`

`VdeCreationProfile` readonly record struct:
- `VdeProfileType ProfileType`
- `string Name`
- `string Description`
- `uint ModuleManifest` (ModuleManifestField value)
- `Dictionary<ModuleId, byte> ModuleConfigLevels` (per-module nibble values)
- `int BlockSize` (default 4096)
- `long TotalBlocks` (logical size)
- `bool ThinProvisioned` (default true)
- `byte TamperResponseLevel` (0x00-0x04, default 0x00)

Static factory methods for each profile (matching spec exactly):
- `static VdeCreationProfile Minimal(long totalBlocks)`:
  Manifest=0x00000000, BlockSize=4096, no modules, TamperResponse=WARN
- `static VdeCreationProfile Standard(long totalBlocks)`:
  Manifest=0x00000C01 (SEC+INTG+SNAP+CMPR bits 0,10,11,12), BlockSize=4096
  Config: SEC=0x2, INTG=0x2, SNAP=0x1, CMPR=0x2
- `static VdeCreationProfile Enterprise(long totalBlocks)`:
  Manifest=0x00040C0F (SEC+CMPL+INTL+TAGS+CMPR+INTG+ALOG bits 0,1,2,3,10,11,18), BlockSize=4096
  Config: SEC=0x3, CMPL=0x3, INTL=0x2, TAGS=0x3, CMPR=0x2, INTG=0x2, ALOG=0x1
- `static VdeCreationProfile MaxSecurity(long totalBlocks)`:
  Manifest=0x0007FFFF (all 19 modules), BlockSize=4096
  Config: all modules at 0xF, TamperResponse=AUTO_QUARANTINE (0x04)
- `static VdeCreationProfile EdgeIoT(long totalBlocks)`:
  Manifest=0x00000840 (STRM+INTG bits 6,11), BlockSize=512
  Config: STRM=0x1, INTG=0x1
- `static VdeCreationProfile Analytics(long totalBlocks)`:
  Manifest=0x00003C04 (INTL+CMPR+SNAP+QURY bits 2,10,12,13), BlockSize=65536
  Config: INTL=0x2, CMPR=0x3, SNAP=0x1, QURY=0x2
- `static VdeCreationProfile Custom(long totalBlocks, uint manifest, Dictionary<ModuleId, byte> configLevels, int blockSize = 4096)`:
  User-specified everything

- `InodeSizeResult GetInodeLayout() => InodeSizeCalculator.Calculate(ModuleManifest)`
- `ModuleManifestField GetManifest() => new(ModuleManifest)`
- `ModuleConfigField GetConfig()` — builds from ModuleConfigLevels dictionary

**DualWalHeader.cs**:

`WalType` enum: `MetadataWal, DataWal`

`WalHeader` readonly struct (fits in one block payload):
- `WalType Type`
- `uint Version` (1)
- `long SequenceStart` (first sequence number)
- `long SequenceEnd` (last committed)
- `long HeadOffset` (byte offset of oldest entry)
- `long TailOffset` (byte offset of write cursor)
- `long TotalEntries`
- `long MaxBlocks` (WAL capacity in blocks)
- `long UsedBlocks`
- `long CreatedTimestampUtc`
- `long LastCheckpointTimestamp`
- `uint CheckpointInterval` (entries between checkpoints)
- `bool IsClean` (true if properly closed)

Methods:
- `static WalHeader CreateMetadataWal(long maxBlocks)` — defaults for metadata WAL
- `static WalHeader CreateDataWal(long maxBlocks)` — defaults for data WAL
- `static void Serialize(in WalHeader header, Span<byte> buffer)` — writes to buffer
- `static WalHeader Deserialize(ReadOnlySpan<byte> buffer)` — reads from buffer

Metadata WAL: sized at 0.5% of total blocks (min 64 blocks). Block type tag: MWAL.
Data WAL: sized at 1% of total blocks (min 128 blocks). Block type tag: DWAL.

**ThinProvisioning.cs** — Static utility class:

- `static FileStream CreateSparseFile(string path, long logicalSize)`:
  1. Create file with FileMode.Create
  2. Set file length to logicalSize using FileStream.SetLength (creates sparse file on NTFS/ext4/APFS)
  3. On Windows: use DeviceIoControl with FSCTL_SET_SPARSE to mark as sparse (P/Invoke)
  4. Return the stream positioned at 0

- `static void WriteSparseBlock(FileStream stream, long blockOffset, ReadOnlySpan<byte> data)`:
  Seek to blockOffset, write data. Unwritten regions remain holes (zero-read, no disk allocation).

- `static bool IsSparseFileSupported()`:
  Check OS: Windows (NTFS check) or Linux (assume yes for ext4/xfs/btrfs) or macOS (APFS).
  Return true/false.

- `static long GetPhysicalSize(string path)`:
  On Windows: use GetCompressedFileSize (P/Invoke). On Linux: stat().st_blocks * 512.
  Fallback: FileInfo.Length if native call fails.

- `static long GetLogicalSize(string path)` => FileInfo.Length

For the P/Invoke on Windows, use `[LibraryImport("kernel32.dll")]` with .NET 7+ source generation or traditional `[DllImport]`. Mark P/Invoke methods as private, expose only the high-level API.

Use `[SdkCompatibility("6.0.0")]`. Namespace: `DataWarehouse.SDK.VirtualDiskEngine.Format`.
  </action>
  <verify>
`dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` compiles. All 7 profiles produce valid module manifests. ThinProvisioning.CreateSparseFile creates a file where logical size >> physical size.
  </verify>
  <done>Seven creation profiles match spec exactly. Dual WAL headers initialized. Thin provisioning creates sparse files where a 1TB VDE with 1MB data uses ~1MB on disk.</done>
</task>

<task type="auto">
  <name>Task 2: VDE Creator -- assembles complete DWVD v2.0 files</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/Format/VdeCreator.cs
  </files>
  <action>
**VdeCreator.cs** — The integration class that creates complete DWVD v2.0 files:

`VdeCreator` static class:

`static async Task<string> CreateVdeAsync(string filePath, VdeCreationProfile profile, CancellationToken cancellationToken = default)`:

Implementation steps:
1. **Validate profile**: block size is valid (power of 2, 512-65536), total blocks > minimum (at least 64 blocks for metadata)
2. **Calculate layout**:
   - Blocks 0-3: Primary Superblock Group
   - Blocks 4-7: Mirror Superblock Group
   - Blocks 8-9: Region Directory (2 blocks)
   - Blocks 10-11: Reserved for Policy Vault (if SEC module active)
   - Blocks 12-13: Reserved for Encryption Header (if SEC module active)
   - Block 14+: Allocation Bitmap (1 bit per block, ceil(totalBlocks / (blockPayloadSize * 8)) blocks)
   - After bitmap: Inode Table (initial size: min(1024, totalBlocks/256) blocks)
   - After inode table: Metadata WAL region (0.5% of totalBlocks, min 64)
   - After MWAL: Data WAL region (1% of totalBlocks, min 128, only if Streaming module active)
   - After WAL(s): module-specific regions (from ModuleRegistry.GetRequiredRegions)
   - Remaining: Data Region
3. **Build Superblock Group**:
   - Create SuperblockV2 with magic, version, block size, total blocks, volume UUID (Guid.NewGuid()), module manifest, module config from profile
   - Create RegionPointerTable with entries for each allocated region
   - Create ExtendedMetadata (zeroed initially)
   - Create IntegrityAnchor (zeroed initially — populated on first checkpoint)
   - Create InodeLayoutDescriptor from module manifest
4. **Create file**:
   - If profile.ThinProvisioned: use ThinProvisioning.CreateSparseFile
   - Else: create regular file with pre-allocated size
5. **Write metadata blocks**:
   - Write Superblock Group at blocks 0-3 (with trailers)
   - Write Mirror Superblock Group at blocks 4-7 (identical copy)
   - Write Region Directory at blocks 8-9 (with trailers)
   - Write allocation bitmap (mark metadata blocks as allocated)
   - Write inode table header block (first block of inode region)
   - Write WAL headers (Metadata WAL, and Data WAL if applicable)
   - For each module-specific region: write region header block (with appropriate block type tag in trailer)
6. **All other blocks remain unwritten** (sparse holes = zeros = free space)
7. **Return** file path

Additional methods:
- `static VdeLayoutInfo CalculateLayout(VdeCreationProfile profile)` — returns region map without creating file (for preview/display)
- `static bool ValidateVde(string filePath)` — opens file, checks magic signature, validates all block trailers in metadata region, returns true/false

`VdeLayoutInfo` readonly record struct:
- `int BlockSize`
- `long TotalBlocks`
- `long MetadataBlocks` (total blocks used by metadata)
- `long DataBlocks` (blocks available for data)
- `double OverheadPercent`
- `int InodeSize`
- `IReadOnlyDictionary<string, (long StartBlock, long BlockCount)> Regions`

The CreateVdeAsync method should write blocks using the sparse-aware pattern: seek to the block offset, write the block data (including trailer), skip unneeded blocks. On thin-provisioned files, unwritten blocks are zero-cost.

Use `[SdkCompatibility("6.0.0")]`. Namespace: `DataWarehouse.SDK.VirtualDiskEngine.Format`.
  </action>
  <verify>
`dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` compiles. Run a quick validation: `VdeCreator.CalculateLayout(VdeCreationProfile.Minimal(256))` returns valid layout with correct overhead. All files in Format/ directory exist (should be ~18 files total across all 6 plans).
  </verify>
  <done>VdeCreator assembles all v2.0 format components into complete DWVD files. All 7 profiles produce valid, openable VDEs. Thin provisioning via sparse files. Validation method checks magic + trailers.</done>
</task>

</tasks>

<verification>
1. `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` — zero errors
2. All 7 profiles defined with correct module manifests matching spec
3. VdeCreator.CreateVdeAsync produces a file with valid magic signature at bytes 0-15
4. All metadata block trailers pass verification (XxHash64 check)
5. Thin provisioned file: logical size >> physical size for large VDE with minimal data
6. Sub-4K block sizes work: EdgeIoT profile uses 512B blocks
7. Analytics profile uses 64KB blocks
8. VdeCreator.ValidateVde returns true for freshly created VDEs
</verification>

<success_criteria>
- Four source files compile cleanly
- Seven creation profiles with correct manifests, configs, block sizes
- Dual WAL (Metadata + Data) headers initialized
- Thin provisioning creates sparse files
- VdeCreator is the integration point: profile in, valid VDE file out
- All phase success criteria from roadmap are achievable with this implementation
</success_criteria>

<output>
After completion, create `.planning/phases/71-vde-format-v2/71-06-SUMMARY.md`
</output>
