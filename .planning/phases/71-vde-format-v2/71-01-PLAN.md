---
phase: 71-vde-format-v2
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.SDK/VirtualDiskEngine/Format/FormatConstants.cs
  - DataWarehouse.SDK/VirtualDiskEngine/Format/MagicSignature.cs
  - DataWarehouse.SDK/VirtualDiskEngine/Format/FeatureFlags.cs
  - DataWarehouse.SDK/VirtualDiskEngine/Format/BlockTypeTags.cs
autonomous: true

must_haves:
  truths:
    - "16-byte magic signature validates correctly for valid DWVD v2.0 files"
    - "Magic signature rejects files that are not DWVD v2.0"
    - "Feature flags (Incompatible, ReadOnly, Compatible) round-trip through serialize/deserialize"
    - "MinReaderVersion and MinWriterVersion fields gate forward compatibility"
    - "All 22 block type tags are defined as uint32 constants matching ASCII encoding"
  artifacts:
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Format/FormatConstants.cs"
      provides: "V2 format version constants, block sizes, magic bytes"
      contains: "FormatMajorVersion"
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Format/MagicSignature.cs"
      provides: "16-byte magic signature struct with serialize/deserialize/validate"
      exports: ["MagicSignature"]
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Format/FeatureFlags.cs"
      provides: "Three feature flag enums and version gating struct"
      exports: ["IncompatibleFeatureFlags", "ReadOnlyCompatibleFeatureFlags", "CompatibleFeatureFlags", "FormatVersionInfo"]
    - path: "DataWarehouse.SDK/VirtualDiskEngine/Format/BlockTypeTags.cs"
      provides: "All 22 block type tag uint32 constants"
      exports: ["BlockTypeTags"]
  key_links:
    - from: "MagicSignature"
      to: "FormatConstants"
      via: "uses FormatMajorVersion, FormatMinorVersion, SpecRevision"
      pattern: "FormatConstants\\.(FormatMajorVersion|FormatMinorVersion)"
---

<objective>
Define the foundational DWVD v2.0 format constants: 16-byte magic signature, version fields, feature flags (Incompatible/ReadOnly/Compatible), MinReaderVersion/MinWriterVersion for forward compatibility, and all 22 block type tags.

Purpose: Every subsequent plan (superblock, region directory, module system, inode, creation profiles) depends on these constants and types. This is the format's identity.
Output: Four source files in a new `Format/` subdirectory under VirtualDiskEngine.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/v6.0-VDE-FORMAT-v2.0-SPEC.md
@DataWarehouse.SDK/VirtualDiskEngine/VdeConstants.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Format constants and 16-byte magic signature</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/Format/FormatConstants.cs
    DataWarehouse.SDK/VirtualDiskEngine/Format/MagicSignature.cs
  </files>
  <action>
Create `DataWarehouse.SDK/VirtualDiskEngine/Format/` directory.

**FormatConstants.cs** — Static class with v2.0 constants:
- `FormatMajorVersion = 2` (byte)
- `FormatMinorVersion = 0` (byte)
- `SpecRevision = 1` (ushort)
- `MagicSignatureSize = 16` (int)
- `UniversalBlockTrailerSize = 16` (int)
- `DefaultBlockSize = 4096`, `MinBlockSize = 512`, `MaxBlockSize = 65536` (int)
- `SuperblockGroupBlocks = 4` (blocks per superblock group)
- `SuperblockMirrorStartBlock = 4` (long)
- `RegionDirectoryStartBlock = 8` (long)
- `RegionDirectoryBlocks = 2` (int)
- `MaxRegionSlots = 127` (int)
- `RegionSlotSize = 32` (int)
- `MaxKeySlots = 63` (int)
- `InodeCoreSize = 304` (int — core fields before module fields)
- `InodeAlignmentMultiple = 64` (int)
- `MaxExtentsPerInode = 8` (int)
- `ExtentSize = 24` (int — bytes per extent entry)
- `InlineTagAreaSize = 128` (int)
- `MaxModules = 32` (int)
- `DefinedModules = 19` (int)
- `DwvdAsciiBytes` — readonly byte[] = { 0x44, 0x57, 0x56, 0x44 } ("DWVD")
- `NamespaceAnchorBytes` — readonly byte[] = { 0x64, 0x77, 0x3A, 0x2F, 0x2F } ("dw://")

Use `[SdkCompatibility("6.0.0")]` attribute on the class. Namespace: `DataWarehouse.SDK.VirtualDiskEngine.Format`.

**MagicSignature.cs** — Readonly struct `MagicSignature`:
Fields: `FormatIdentifier` (uint, "DWVD" = 0x44575644), `MajorVersion` (byte), `MinorVersion` (byte), `SpecRevision` (ushort), `NamespaceAnchor` (ulong, holds "dw://" + 3 padding bytes packed into 8 bytes but stored as 5+3).

Methods:
- `static MagicSignature CreateDefault()` — returns v2.0 signature
- `static void Serialize(in MagicSignature sig, Span<byte> buffer)` — writes 16 bytes: bytes 0-3 "DWVD", byte 4 major, byte 5 minor, bytes 6-7 spec revision LE, bytes 8-12 "dw://", bytes 13-15 zero padding
- `static MagicSignature Deserialize(ReadOnlySpan<byte> buffer)` — reads 16 bytes
- `bool Validate()` — checks DWVD bytes, dw:// bytes, padding is zero; returns bool
- `bool IsCompatible(byte minMajor, byte minMinor)` — version compatibility check

Store the raw 16 bytes as individual fields to avoid heap allocation. Use `BinaryPrimitives` for endianness.
  </action>
  <verify>
`dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` compiles with zero errors. Verify `MagicSignature.CreateDefault().Validate()` returns true by inspecting the logic.
  </verify>
  <done>FormatConstants has all v2.0 constants. MagicSignature serializes/deserializes 16 bytes correctly. Validation rejects non-DWVD files.</done>
</task>

<task type="auto">
  <name>Task 2: Feature flags, version gating, and block type tags</name>
  <files>
    DataWarehouse.SDK/VirtualDiskEngine/Format/FeatureFlags.cs
    DataWarehouse.SDK/VirtualDiskEngine/Format/BlockTypeTags.cs
  </files>
  <action>
**FeatureFlags.cs** — Three `[Flags]` enums + version gating struct:

`IncompatibleFeatureFlags : uint` — features that PREVENT older readers from opening:
- `None = 0`
- `EncryptionEnabled = 1 << 0`
- `WormRegionActive = 1 << 1`
- `RaidEnabled = 1 << 2`
- `ComputeCacheActive = 1 << 3`
- `FabricLinksActive = 1 << 4`
- `ConsensusLogActive = 1 << 5`

`ReadOnlyCompatibleFeatureFlags : uint` — features that allow read-only access by older readers:
- `None = 0`
- `CompressionEnabled = 1 << 0`
- `ReplicationEnabled = 1 << 1`
- `StreamingRegionActive = 1 << 2`
- `SnapshotActive = 1 << 3`
- `IntelligenceCacheActive = 1 << 4`

`CompatibleFeatureFlags : uint` — features fully compatible with older readers:
- `None = 0`
- `TagIndexActive = 1 << 0`
- `PolicyEngineActive = 1 << 1`
- `TamperProofChainActive = 1 << 2`
- `ComplianceVaultActive = 1 << 3`
- `AirgapMode = 1 << 4`
- `FuseCompatMode = 1 << 5`
- `DirtyFlag = 1 << 6`

`FormatVersionInfo` — readonly struct with:
- `MinReaderVersion` (ushort) — minimum version that can READ this VDE
- `MinWriterVersion` (ushort) — minimum version that can WRITE this VDE
- `IncompatibleFeatures` (IncompatibleFeatureFlags)
- `ReadOnlyCompatibleFeatures` (ReadOnlyCompatibleFeatureFlags)
- `CompatibleFeatures` (CompatibleFeatureFlags)
- `bool CanRead(ushort readerVersion)` — true if readerVersion >= MinReaderVersion
- `bool CanWrite(ushort writerVersion)` — true if writerVersion >= MinWriterVersion
- `bool HasIncompatibleFeatures(IncompatibleFeatureFlags check)` — bitwise AND check
- `static void Serialize(in FormatVersionInfo info, Span<byte> buffer)` — writes 16 bytes (2+2+4+4+4)
- `static FormatVersionInfo Deserialize(ReadOnlySpan<byte> buffer)` — reads 16 bytes

**BlockTypeTags.cs** — Static class with uint constants for all 22 block type tags, encoded as ASCII big-endian (matching spec):
- `SUPB = 0x53555042` ("SUPB"), `RMAP = 0x524D4150` ("RMAP"), `POLV = 0x504F4C56`, `ENCR = 0x454E4352`, `BMAP = 0x424D4150`, `INOD = 0x494E4F44`, `TAGI = 0x54414749`, `MWAL = 0x4D57414C`, `MTRK = 0x4D54524B`, `BTRE = 0x42545245`, `SNAP = 0x534E4150`, `REPL = 0x5245504C`, `RAID = 0x52414944`, `COMP = 0x434F4D50`, `INTE = 0x494E5445`, `STRE = 0x53545245`, `XREF = 0x58524546`, `WORM = 0x574F524D`, `CODE = 0x434F4445`, `DWAL = 0x4457414C`, `DATA = 0x44415441`, `FREE = 0x46524545`
- Also add: `CMVT = 0x434D5654`, `ALOG = 0x414C4F47`, `CLOG = 0x434C4F47`, `DICT = 0x44494354`, `ANON = 0x414E4F4E`, `MLOG = 0x4D4C4F47` (from module registry in spec)
- `static string TagToString(uint tag)` — converts to 4-char ASCII
- `static uint StringToTag(string s)` — converts 4-char ASCII to uint
- `static bool IsKnownTag(uint tag)` — checks against known set

Use `[SdkCompatibility("6.0.0")]` on all types.
  </action>
  <verify>
`dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` compiles with zero errors. Verify block type tag hex values match ASCII encoding (e.g., 'S'=0x53, 'U'=0x55, 'P'=0x50, 'B'=0x42 => SUPB=0x53555042).
  </verify>
  <done>Three feature flag enums defined with all spec flags. FormatVersionInfo gates read/write access. All 22+ block type tags defined as uint constants with string conversion utilities.</done>
</task>

</tasks>

<verification>
1. `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` — zero errors
2. All four files exist under `DataWarehouse.SDK/VirtualDiskEngine/Format/`
3. `FormatConstants.FormatMajorVersion == 2`
4. `MagicSignature.CreateDefault().Validate()` returns true (by code inspection)
5. `BlockTypeTags.SUPB == 0x53555042` (verify hex matches "SUPB" ASCII)
</verification>

<success_criteria>
- Four new source files compile cleanly
- Magic signature is exactly 16 bytes per spec
- Feature flags cover all spec-defined flags
- Block type tags cover all 22+ types from spec
- FormatVersionInfo provides version gating
</success_criteria>

<output>
After completion, create `.planning/phases/71-vde-format-v2/71-01-SUMMARY.md`
</output>
