---
phase: 65-infrastructure
plan: 04
type: execute
wave: 3
depends_on: ["65-01", "65-02", "65-03"]
files_modified:
  - DataWarehouse.SDK/Contracts/Query/QueryExecutionEngine.cs
  - DataWarehouse.SDK/Contracts/Query/TagAwareQueryExtensions.cs
  - Plugins/DataWarehouse.Plugins.Virtualization.SqlOverObject/SqlOverObjectPlugin.cs
autonomous: true

must_haves:
  truths:
    - "SQL queries execute against registered tables and return ColumnarBatch results"
    - "Tag-aware queries can filter/join on DW metadata tags (SELECT * FROM t WHERE tag('owner') = 'admin')"
    - "SqlOverObjectPlugin integrates the new parser/planner/engine replacing regex-based parsing"
  artifacts:
    - path: "DataWarehouse.SDK/Contracts/Query/QueryExecutionEngine.cs"
      provides: "Executes physical query plans against table data sources"
      min_lines: 300
    - path: "DataWarehouse.SDK/Contracts/Query/TagAwareQueryExtensions.cs"
      provides: "Tag function support in SQL (tag(), has_tag(), tag_count())"
      min_lines: 80
  key_links:
    - from: "QueryExecutionEngine"
      to: "CostBasedQueryPlanner"
      via: "plan generation"
      pattern: "IQueryPlanner.*Plan"
    - from: "QueryExecutionEngine"
      to: "ColumnarEngine"
      via: "batch execution"
      pattern: "ColumnarEngine|ColumnarBatch"
    - from: "SqlOverObjectPlugin"
      to: "QueryExecutionEngine"
      via: "query delegation"
      pattern: "QueryExecutionEngine|ExecuteQuery"
---

<objective>
Build the query execution engine that runs physical plans against data sources, add tag-aware query extensions, and integrate into the existing SqlOverObjectPlugin.

Purpose: Connects the parser (Plan 01), planner (Plan 02), and columnar engine (Plan 03) into a working end-to-end query pipeline. Adds DW-specific tag functions for metadata-aware queries. Updates SqlOverObjectPlugin to use the real engine.

Output: QueryExecutionEngine, TagAwareQueryExtensions, updated SqlOverObjectPlugin.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/65-infrastructure/65-01-SUMMARY.md
@.planning/phases/65-infrastructure/65-02-SUMMARY.md
@.planning/phases/65-infrastructure/65-03-SUMMARY.md
@Plugins/DataWarehouse.Plugins.Virtualization.SqlOverObject/SqlOverObjectPlugin.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Query execution engine with tag-aware extensions</name>
  <files>
    DataWarehouse.SDK/Contracts/Query/QueryExecutionEngine.cs
    DataWarehouse.SDK/Contracts/Query/TagAwareQueryExtensions.cs
  </files>
  <action>
Create QueryExecutionEngine.cs:
- Constructor takes ISqlParser, IQueryPlanner, and IDataSourceProvider
- IDataSourceProvider interface: GetTableData(string tableName, List<string> columns, CancellationToken ct) -> IAsyncEnumerable<ColumnarBatch>; GetTableStatistics(string tableName) -> TableStatistics?
- ExecuteQueryAsync(string sql, CancellationToken ct = default) -> QueryResult
- QueryResult record: Batches (IAsyncEnumerable<ColumnarBatch>), Schema (list of ColumnInfo: Name, Type), RowsAffected (long?), ExecutionTimeMs (double), QueryPlan (QueryPlanNode for EXPLAIN)
- Execute pipeline: Parse SQL -> Plan -> Optimize -> Execute physical plan nodes
- Physical execution for each node type:
  - TableScanNode: call IDataSourceProvider.GetTableData()
  - FilterNode: call ColumnarEngine.FilterBatch on each input batch
  - ProjectNode: call ColumnarEngine.ScanBatch for column selection
  - HashJoinNode: build hash table from build side, probe with probe side (spill to disk if > 256MB)
  - NestedLoopJoinNode: for each left row, scan right side
  - SortNode: collect all batches into memory, sort by keys (external sort if > 512MB)
  - AggregateNode: streaming aggregation using ColumnarEngine.GroupByAggregate
  - LimitNode: count rows and stop producing after limit reached
- EXPLAIN support: if SQL starts with "EXPLAIN", return the plan as a single-column text result
- CancellationToken threaded through all async operations

Create TagAwareQueryExtensions.cs:
- Register custom SQL functions: tag(column, tag_name) -> value, has_tag(column, tag_name) -> bool, tag_count(column) -> int
- ITagProvider interface: GetTag(string objectKey, string tagName) -> string?; HasTag(string objectKey, string tagName) -> bool; GetTagCount(string objectKey) -> int
- TagFunctionResolver: resolves tag() calls in WHERE/SELECT to ITagProvider lookups
- Integration: QueryExecutionEngine checks for tag functions in expressions and resolves via ITagProvider before filter evaluation
- Example: SELECT * FROM objects WHERE tag('classification') = 'confidential' AND has_tag('retention_policy')
  </action>
  <verify>dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj — zero errors</verify>
  <done>QueryExecutionEngine runs full SQL queries through parse->plan->execute pipeline; tag() and has_tag() functions resolve against ITagProvider</done>
</task>

<task type="auto">
  <name>Task 2: Integrate query engine into SqlOverObjectPlugin</name>
  <files>
    Plugins/DataWarehouse.Plugins.Virtualization.SqlOverObject/SqlOverObjectPlugin.cs
  </files>
  <action>
Update SqlOverObjectPlugin to use the new query engine infrastructure:

1. Add private QueryExecutionEngine field initialized in OnHandshakeAsync
2. Create PluginDataSourceProvider : IDataSourceProvider that wraps the existing _tableRegistry and _fileReader
   - GetTableData reads from file system via _fileReader, parses CSV/JSON/Parquet into ColumnarBatch
   - GetTableStatistics returns cached stats from _tableRegistry (row count, column types)
3. Replace the existing regex-based ExecuteQueryAsync with delegation to QueryExecutionEngine.ExecuteQueryAsync
4. Keep backward compatibility: existing RegisterTable, SetFileReader, GetStatistics APIs unchanged
5. Convert QueryResult.Batches to the plugin's existing result format (DataRow[] / JsonElement[]) for backward compat
6. Add EXPLAIN support: "EXPLAIN SELECT ..." returns the query plan as formatted text
7. Wire ITagProvider to DW's tag system via MessageBus topic "tags.get" and "tags.has"
8. Update capability list to include "cost_based_planner", "columnar_execution", "tag_queries"

Preserve ALL existing functionality — the new engine is an upgrade, not a replacement. If the new parser fails to parse a query (e.g., DW-specific syntax), fall back to the existing regex parser with a warning log.
  </action>
  <verify>dotnet build Plugins/DataWarehouse.Plugins.Virtualization.SqlOverObject/ — zero errors. Existing VirtualizationSqlOverObjectTests still pass</verify>
  <done>SqlOverObjectPlugin uses QueryExecutionEngine for SQL execution with fallback to legacy parser; tag-aware queries work via MessageBus</done>
</task>

</tasks>

<verification>
- Full solution build passes
- Existing VirtualizationSqlOverObjectTests pass unchanged
- EXPLAIN SELECT produces readable query plan text
- Tag-aware query syntax parses and resolves
</verification>

<success_criteria>
End-to-end SQL query execution works through SqlOverObjectPlugin: parse -> plan -> optimize -> execute -> columnar results. Tag-aware queries supported.
</success_criteria>

<output>
After completion, create `.planning/phases/65-infrastructure/65-04-SUMMARY.md`
</output>
