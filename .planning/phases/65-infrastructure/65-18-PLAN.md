---
phase: 65-infrastructure
plan: 18
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.SDK/Configuration/UserConfigurationSystem.cs
  - DataWarehouse.SDK/Configuration/ConfigurationHierarchy.cs
  - DataWarehouse.SDK/Configuration/IUserOverridable.cs
  - DataWarehouse.SDK/Configuration/FeatureToggleRegistry.cs
autonomous: true

must_haves:
  truths:
    - "Every feature supports strategy selection via configuration (not just code)"
    - "Configuration hierarchy: Instance -> Tenant -> User (user overrides tenant overrides instance)"
    - "AllowUserToOverride flag controls whether users can change settings"
    - "Parameter tuning is available for all configurable strategies"
  artifacts:
    - path: "DataWarehouse.SDK/Configuration/UserConfigurationSystem.cs"
      provides: "Unified configuration system with hierarchy"
      min_lines: 200
    - path: "DataWarehouse.SDK/Configuration/ConfigurationHierarchy.cs"
      provides: "Instance/Tenant/User config cascade"
      min_lines: 100
    - path: "DataWarehouse.SDK/Configuration/IUserOverridable.cs"
      provides: "Interface marking configurable features"
      exports: ["IUserOverridable", "ConfigurableParameter"]
    - path: "DataWarehouse.SDK/Configuration/FeatureToggleRegistry.cs"
      provides: "Runtime feature toggle management"
      min_lines: 100
  key_links:
    - from: "UserConfigurationSystem"
      to: "ConfigurationHierarchy"
      via: "config resolution"
      pattern: "ConfigurationHierarchy|Resolve"
    - from: "FeatureToggleRegistry"
      to: "IMessageBus"
      via: "toggle change events"
      pattern: "config\\.toggle\\.changed"
---

<objective>
Build the user configuration system that enables strategy selection, parameter tuning, and per-tenant/per-user overrides for every feature.

Purpose: Currently, strategies are selected programmatically. Users need to configure DW via settings files or API without code changes. The configuration hierarchy (Instance -> Tenant -> User) enables multi-tenant deployments where each tenant and user can customize behavior within admin-defined bounds.

Output: UserConfigurationSystem, ConfigurationHierarchy, IUserOverridable, FeatureToggleRegistry in SDK/Configuration/.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/PLUGIN-CATALOG.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configuration hierarchy and IUserOverridable</name>
  <files>
    DataWarehouse.SDK/Configuration/ConfigurationHierarchy.cs
    DataWarehouse.SDK/Configuration/IUserOverridable.cs
  </files>
  <action>
Create IUserOverridable.cs:
- IUserOverridable interface: applied to features/strategies that can be configured by users
  - IReadOnlyList<ConfigurableParameter> GetConfigurableParameters()
  - void ApplyConfiguration(IReadOnlyDictionary<string, object> config)
  - IReadOnlyDictionary<string, object> GetCurrentConfiguration()
- ConfigurableParameter record:
  - Name (string), DisplayName (string), Description (string)
  - ParameterType (enum: String, Int, Double, Bool, Enum, StringList)
  - DefaultValue (object), CurrentValue (object)
  - AllowUserToOverride (bool) — if false, only Instance-level can set
  - AllowTenantToOverride (bool) — if false, only Instance-level can set
  - Validation: MinValue, MaxValue (for numeric), AllowedValues (for enum/string), RegexPattern (for string)
  - Category (string) — for UI grouping (e.g., "Performance", "Security", "Storage")
- [ConfigurableAttribute]: applied to properties on strategy classes
  - Parameters: DisplayName, Description, AllowUserToOverride (default true), Category, Min, Max, AllowedValues

Create ConfigurationHierarchy.cs:
- ConfigurationLevel enum: Instance, Tenant, User
- ConfigurationHierarchy class:
  - SetConfiguration(ConfigurationLevel level, string scope, string key, object value)
    - level=Instance, scope="" (global)
    - level=Tenant, scope=tenantId
    - level=User, scope=userId
  - GetEffectiveValue<T>(string key, string? tenantId = null, string? userId = null) -> T
    - Resolution order: User > Tenant > Instance > Default
    - Respects AllowUserToOverride/AllowTenantToOverride flags
    - If user override not allowed, skip user level
  - GetEffectiveConfiguration(string? tenantId = null, string? userId = null) -> IReadOnlyDictionary<string, object>
- Storage: ConcurrentDictionary<(ConfigurationLevel, string scope, string key), object>
- Persistence: serialize to JSON, load on startup
- IConfigurationStore interface: SaveAsync(ConfigurationLevel, scope, key, value), LoadAllAsync() -> configs
  - FileConfigurationStore: saves to {dataDir}/config/{level}/{scope}.json
  - InMemoryConfigurationStore: for testing
  </action>
  <verify>dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj — zero errors</verify>
  <done>ConfigurationHierarchy resolves Instance->Tenant->User with AllowUserToOverride enforcement; IUserOverridable interface and [Configurable] attribute exist</done>
</task>

<task type="auto">
  <name>Task 2: User configuration system and feature toggles</name>
  <files>
    DataWarehouse.SDK/Configuration/UserConfigurationSystem.cs
    DataWarehouse.SDK/Configuration/FeatureToggleRegistry.cs
  </files>
  <action>
Create UserConfigurationSystem.cs:
- Central configuration facade that ties everything together
- Constructor: IPluginCapabilityRegistry, ConfigurationHierarchy, IMessageBus
- DiscoverConfigurableFeatures() -> IReadOnlyList<ConfigurableFeature>
  - Scans all loaded plugins and strategies for IUserOverridable or [Configurable]
  - ConfigurableFeature: PluginId, FeatureName, Parameters (list of ConfigurableParameter)
- ApplyStrategySelection(string pluginId, string strategyCategory, string strategyId, ConfigurationLevel level, string? scope = null)
  - Example: ApplyStrategySelection("compression", "default_algorithm", "brotli-q6", Tenant, "tenant-123")
  - Publishes "config.strategy.changed" to message bus
- ApplyParameterTuning(string pluginId, string parameterName, object value, ConfigurationLevel level, string? scope = null)
  - Validates against ConfigurableParameter constraints (min, max, allowed values)
  - Throws ConfigurationValidationException if invalid
- GetFeatureConfiguration(string pluginId, string? tenantId = null, string? userId = null) -> FeatureConfiguration
  - Returns all effective configuration for a plugin considering hierarchy
- ExportConfiguration(ConfigurationLevel level, string? scope = null) -> string (JSON)
- ImportConfiguration(string json, ConfigurationLevel level, string? scope = null)

Create FeatureToggleRegistry.cs:
- IFeatureToggleRegistry: IsEnabled(string featureName, string? tenantId = null, string? userId = null) -> bool
- RegisterToggle(string featureName, bool defaultEnabled, string description)
- SetToggle(string featureName, bool enabled, ConfigurationLevel level, string? scope = null)
- Built-in toggles (registered on startup):
  - "intelligence.enabled" (default: true) — enables/disables AI features
  - "encryption.at_rest" (default: true) — enables/disables encryption at rest
  - "compression.enabled" (default: true)
  - "replication.enabled" (default: false) — requires explicit opt-in
  - "telemetry.enabled" (default: true)
  - "experimental.features" (default: false)
- Toggle change events: publish "config.toggle.changed" with feature name and new state
- Evaluation: checks hierarchy (User > Tenant > Instance > Default)
- Percentage rollout support: SetToggle("feature", percentage: 50) -> enabled for 50% of users (hash userId % 100 < percentage)
  </action>
  <verify>dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj — zero errors</verify>
  <done>UserConfigurationSystem provides strategy selection and parameter tuning with hierarchy; FeatureToggleRegistry supports per-feature toggles with percentage rollout</done>
</task>

</tasks>

<verification>
- Build passes with zero errors
- ConfigurationHierarchy resolves User > Tenant > Instance > Default
- AllowUserToOverride=false prevents user-level changes
- FeatureToggleRegistry supports percentage rollout
</verification>

<success_criteria>
User configuration system exists: strategy selection, parameter tuning, Instance/Tenant/User hierarchy with AllowUserToOverride, feature toggles with percentage rollout. Every configurable feature discoverable via API.
</success_criteria>

<output>
After completion, create `.planning/phases/65-infrastructure/65-18-SUMMARY.md`
</output>
