---
phase: 65-infrastructure
plan: 17
type: execute
wave: 2
depends_on: ["65-16"]
files_modified:
  - DataWarehouse.Tests/Plugins/**
  - DataWarehouse.Tests/Integration/**
autonomous: true

must_haves:
  truths:
    - "Every plugin has at least basic smoke tests (identity, capabilities, health)"
    - "Integration tests verify cross-plugin message bus communication"
    - "Query engine has end-to-end tests (parse -> plan -> execute -> results)"
    - "Edge cases and error paths are tested (invalid input, timeout, resource exhaustion)"
  artifacts:
    - path: "DataWarehouse.Tests/Plugins/"
      provides: "Plugin smoke tests for all 63 plugins"
      min_lines: 400
    - path: "DataWarehouse.Tests/Integration/"
      provides: "Integration and edge case tests"
      min_lines: 300
  key_links:
    - from: "Plugin tests"
      to: "Plugins/*"
      via: "plugin instantiation and verification"
      pattern: "new.*Plugin\\(\\)|Assert\\.Equal.*Id"
---

<objective>
Expand plugin test coverage and add integration/edge case tests to reach 80%+ overall coverage.

Purpose: Plan 16 covered SDK/Kernel. This covers plugins (63 plugins need at least smoke tests) and integration scenarios (cross-plugin bus communication, query engine E2E, error handling). Combined with Plan 16, this achieves the 80% coverage target.

Output: Plugin smoke tests + integration tests + edge case tests.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/65-infrastructure/65-16-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Plugin smoke tests for all 63 plugins</name>
  <files>
    DataWarehouse.Tests/Plugins/PluginSmokeTests.cs
    DataWarehouse.Tests/Plugins/StrategyRegistrationTests.cs
  </files>
  <action>
Create PluginSmokeTests.cs — verify every plugin can be instantiated and has correct identity:

Use [Theory] with [MemberData] pattern to test all plugins from a single test method:
```csharp
public static IEnumerable<object[]> AllPlugins => new[] {
    new object[] { new UltimateStoragePlugin(), "com.datawarehouse.storage" },
    new object[] { new UltimateEncryptionPlugin(), "com.datawarehouse.encryption" },
    // ... all 63 plugins
};

[Theory, MemberData(nameof(AllPlugins))]
public void Plugin_HasCorrectIdentity(IPlugin plugin, string expectedIdPrefix) { ... }
```

Tests per plugin (via [Theory]):
1. Plugin_HasCorrectIdentity: Id is not null/empty, starts with expected prefix
2. Plugin_HasNonEmptyName: Name is not null/empty
3. Plugin_HasValidVersion: Version parses as valid semver
4. Plugin_ReportsCapabilities: GetCapabilities() returns non-null list
5. Plugin_DefaultHealthIsHealthy: CheckHealthAsync returns Healthy

Create StrategyRegistrationTests.cs — verify strategy registration is correct:
- For each plugin that registers strategies, verify:
  - No duplicate strategy IDs within a plugin
  - No null/empty strategy names
  - Strategy count matches expected (approximate — use ranges)
- Sample 5 large plugins: UltimateStorage (100+), UltimateEncryption (50+), UltimateCompression (50+), UltimateConnector (200+), UltimateAccessControl (100+)
- Verify strategy instances can be created (default constructor)

Total: ~315 tests (63 plugins * 5 identity tests) + ~25 strategy tests = 340 new tests
  </action>
  <verify>dotnet test DataWarehouse.Tests/ --filter "PluginSmokeTests|StrategyRegistrationTests" — all pass</verify>
  <done>340+ smoke tests covering all 63 plugins with identity, capability, and health verification; strategy registration tests for top 5 plugins</done>
</task>

<task type="auto">
  <name>Task 2: Integration and edge case tests</name>
  <files>
    DataWarehouse.Tests/Integration/QueryEngineIntegrationTests.cs
    DataWarehouse.Tests/Integration/MessageBusIntegrationTests.cs
    DataWarehouse.Tests/Integration/EdgeCaseTests.cs
  </files>
  <action>
Create QueryEngineIntegrationTests.cs (20+ tests):
- End-to-end: parse SQL -> plan -> execute -> verify results
- Simple SELECT: SELECT * FROM test_table (in-memory data source)
- SELECT with WHERE: filter rows correctly
- SELECT with JOIN: hash join produces correct result
- SELECT with GROUP BY: aggregation (COUNT, SUM, AVG, MIN, MAX)
- SELECT with ORDER BY: results sorted
- SELECT with LIMIT/OFFSET: pagination
- EXPLAIN: returns query plan text
- Invalid SQL: produces SqlParseException with line/column
- Empty result: query returns zero rows (not null/error)
- Large dataset: 100K rows, verify streaming (no OOM)

Create MessageBusIntegrationTests.cs (15+ tests):
- Cross-plugin communication: Plugin A publishes, Plugin B receives
- Topic wildcards: "storage.*" matches "storage.read" and "storage.write"
- Request/response: send request, receive response via correlation ID
- Timeout: request with timeout, verify TimeoutException after deadline
- Concurrent subscribers: 10 subscribers on same topic, all receive message
- Unsubscribe during publish: no crash or deadlock
- Authenticated bus: topic requires authentication, unauthenticated publish rejected

Create EdgeCaseTests.cs (15+ tests):
- Null input: every public SDK method handles null gracefully
- Empty string: key operations (store, retrieve) handle empty key
- Very large input: 100MB data through compression (ArrayPool usage, no OOM)
- Unicode: file paths, keys, queries with Unicode characters
- Concurrent access: 100 parallel store operations, all succeed
- Dispose during operation: cancel a long-running operation, verify clean shutdown
- Thread.Sleep absence: grep test confirming zero Thread.Sleep in production code (except tests)
- Sync-over-async: verify no .Result/.Wait()/.GetAwaiter().GetResult() in SDK (should be < 10 total)

Total: ~50 integration/edge tests
  </action>
  <verify>dotnet test DataWarehouse.Tests/ — all tests pass. Total should exceed 1500</verify>
  <done>50+ integration and edge case tests covering query engine E2E, message bus cross-plugin communication, and error paths; total test count 1500+</done>
</task>

</tasks>

<verification>
- `dotnet test DataWarehouse.Tests/` — all tests pass, zero failures
- Total test count exceeds 1500 (1062 existing + 180 from Plan 16 + 390 from this plan)
- All 63 plugins have at least smoke tests
</verification>

<success_criteria>
390+ new tests. All 63 plugins have smoke tests. Integration tests verify query engine and message bus. Edge cases cover null, unicode, concurrency, and resource limits. Total tests exceed 1500.
</success_criteria>

<output>
After completion, create `.planning/phases/65-infrastructure/65-17-SUMMARY.md`
</output>
