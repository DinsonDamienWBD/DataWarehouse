---
phase: 65-infrastructure
plan: 10
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.SDK/Security/SupplyChain/SbomGenerator.cs
  - DataWarehouse.SDK/Security/SupplyChain/DependencyScanner.cs
  - DataWarehouse.SDK/Security/SupplyChain/ISbomProvider.cs
autonomous: true

must_haves:
  truths:
    - "SBOM generation produces valid CycloneDX 1.5 and SPDX 2.3 documents"
    - "Dependency vulnerability scanning checks NuGet packages against known CVEs"
    - "SBOM includes all 63 plugin assemblies with their transitive dependencies"
  artifacts:
    - path: "DataWarehouse.SDK/Security/SupplyChain/ISbomProvider.cs"
      provides: "SBOM generation interface"
      exports: ["ISbomProvider", "SbomFormat"]
    - path: "DataWarehouse.SDK/Security/SupplyChain/SbomGenerator.cs"
      provides: "CycloneDX and SPDX SBOM generation"
      min_lines: 250
    - path: "DataWarehouse.SDK/Security/SupplyChain/DependencyScanner.cs"
      provides: "Vulnerability scanning against known CVE database"
      min_lines: 150
  key_links:
    - from: "SbomGenerator"
      to: "Assembly metadata"
      via: "reflection"
      pattern: "Assembly.*GetReferencedAssemblies|AppDomain"
    - from: "DependencyScanner"
      to: "SbomGenerator"
      via: "SBOM consumption"
      pattern: "ISbomProvider|SbomDocument"
---

<objective>
Build runtime SBOM generation and dependency vulnerability scanning for supply chain security.

Purpose: Phase 22 had CycloneDX for build-time SBOM but it was blocked by AWSSDK transitive conflicts. This builds RUNTIME SBOM generation (from loaded assemblies) and a vulnerability scanner that checks dependencies against known CVEs. Required for supply chain security completeness (SLSA, SOC2, FedRAMP).

Output: ISbomProvider + SbomGenerator (CycloneDX/SPDX) + DependencyScanner in SDK/Security/SupplyChain/.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: SBOM generation (CycloneDX + SPDX)</name>
  <files>
    DataWarehouse.SDK/Security/SupplyChain/ISbomProvider.cs
    DataWarehouse.SDK/Security/SupplyChain/SbomGenerator.cs
  </files>
  <action>
Create DataWarehouse.SDK/Security/SupplyChain/ folder.

Create ISbomProvider.cs:
- ISbomProvider interface: GenerateAsync(SbomFormat format, SbomOptions? options = null, CancellationToken ct = default) -> Task<SbomDocument>
- SbomFormat enum: CycloneDX_1_5_Json, CycloneDX_1_5_Xml, SPDX_2_3_Json, SPDX_2_3_TagValue
- SbomDocument record: Format, Content (string — serialized SBOM), GeneratedAt (DateTimeOffset), ComponentCount (int), VulnerabilityCount (int)
- SbomOptions: IncludeTransitive (bool, default true), IncludeHashes (bool, default true), IncludeLicenses (bool, default true), CreatorTool (string, default "DataWarehouse SBOM Generator")

Create SbomGenerator.cs implementing ISbomProvider:

Component discovery (runtime):
- Use AppDomain.CurrentDomain.GetAssemblies() to get all loaded assemblies
- For each assembly: name, version, file hash (SHA-256), file path
- Filter: skip System.*, Microsoft.* (framework), focus on DataWarehouse.* and third-party NuGet packages
- For NuGet packages: parse *.deps.json files (RuntimeTarget/libraries section) to get package names, versions, and transitive deps
- Use Assembly.GetReferencedAssemblies() for dependency graph

CycloneDX 1.5 JSON output:
- bomFormat: "CycloneDX", specVersion: "1.5"
- metadata: timestamp, tools (DataWarehouse SBOM Generator), component (DataWarehouse root)
- components array: type (library), name, version, purl (pkg:nuget/name@version), hashes [{alg: SHA-256, content: hex}]
- dependencies array: ref -> dependsOn[]
- Use System.Text.Json for serialization (source-generated context)

SPDX 2.3 JSON output:
- spdxVersion: "SPDX-2.3", dataLicense: "CC0-1.0"
- packages: name, SPDXID, versionInfo, downloadLocation, checksums
- relationships: DEPENDS_ON between packages
- Use System.Text.Json for serialization

Both formats produced WITHOUT external NuGet dependencies — pure C# string/JSON generation.

Caching: regenerate only when assembly list changes (check loaded assembly count + hash).
  </action>
  <verify>dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj — zero errors</verify>
  <done>SbomGenerator produces valid CycloneDX 1.5 and SPDX 2.3 SBOM documents from runtime assembly information</done>
</task>

<task type="auto">
  <name>Task 2: Dependency vulnerability scanner</name>
  <files>
    DataWarehouse.SDK/Security/SupplyChain/DependencyScanner.cs
  </files>
  <action>
Create DependencyScanner.cs:

IDependencyScanner interface:
- ScanAsync(SbomDocument sbom, CancellationToken ct) -> DependencyScanResult
- ScanAsync(CancellationToken ct) -> DependencyScanResult — generates SBOM internally then scans

DependencyScanResult record:
- ScannedAt (DateTimeOffset), ComponentsScanned (int), VulnerabilitiesFound (int)
- Vulnerabilities (IReadOnlyList<VulnerabilityFinding>)
- Summary: Critical/High/Medium/Low counts

VulnerabilityFinding record:
- PackageName, PackageVersion, CveId (string), Severity (VulnSeverity enum), Description, FixedInVersion (string?), Published (DateTimeOffset?), References (list of Uri)

DependencyScanner implementation:
- Offline mode (default): check against embedded known-vulnerability database
  - Ship a minimal embedded database of critical NuGet CVEs (top 50 most common)
  - Format: JSON resource file with package name -> [{cve, affected_versions, severity, fixed_in}]
  - Version range matching: parse semver ranges (>=, <, etc.) to check if current version is affected
- Online mode (optional): call GitHub Advisory Database API or OSV.dev API
  - IVulnerabilityDatabase interface: QueryAsync(string packageName, string version, CancellationToken ct) -> IReadOnlyList<VulnerabilityFinding>
  - GitHubAdvisoryClient: calls api.github.com/advisories (no auth needed for public data)
  - OsvClient: calls api.osv.dev/v1/query (no auth needed)
  - Timeout 10s per query, fail open (missing data = no finding, not error)
- Rate limiting: max 10 queries/sec to external APIs
- Results cached for 24h (configurable)

Integration:
- Publish scan results to message bus: "security.supply-chain.scan-complete"
- Expose via IHealthCheck: returns Degraded if any High/Critical vulnerabilities found
- Scheduled scanning: IScanScheduler with configurable interval (default: daily)
  </action>
  <verify>dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj — zero errors</verify>
  <done>DependencyScanner checks packages against CVE database (offline embedded + optional online), produces VulnerabilityFinding results, publishes to bus</done>
</task>

</tasks>

<verification>
- Build passes with zero errors
- SbomGenerator produces JSON output with components array
- DependencyScanner can scan in offline mode
</verification>

<success_criteria>
SBOM generation (CycloneDX + SPDX) and dependency vulnerability scanning exist in SDK/Security/SupplyChain/. Runtime component discovery works across all loaded assemblies.
</success_criteria>

<output>
After completion, create `.planning/phases/65-infrastructure/65-10-SUMMARY.md`
</output>
