---
phase: 65-infrastructure
plan: 16
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.Tests/SDK/**
  - DataWarehouse.Tests/Kernel/**
autonomous: true

must_haves:
  truths:
    - "SDK base classes (PluginBase, StrategyBase, domain bases) have >80% test coverage"
    - "Distributed contracts (SWIM, Raft, CRDT) have correctness tests"
    - "Security contracts (IKeyStore, ISiemTransport, IContainmentAction) have tests"
    - "Input validation (Guards, SizeLimitOptions) has boundary tests"
  artifacts:
    - path: "DataWarehouse.Tests/SDK/"
      provides: "SDK unit tests"
      min_lines: 500
    - path: "DataWarehouse.Tests/Kernel/"
      provides: "Kernel integration tests"
      min_lines: 200
  key_links:
    - from: "SDK tests"
      to: "DataWarehouse.SDK"
      via: "xUnit test assertions"
      pattern: "Assert\\.|\\[Fact\\]|\\[Theory\\]"
---

<objective>
Expand SDK and Kernel test coverage from ~25% to 80%+ with focused unit and integration tests.

Purpose: Current test suite has 1062 tests but coverage is concentrated on a few areas. SDK base classes, distributed components, and security contracts need comprehensive tests. This is the foundation for confidence in all other v5.0 changes.

Output: 200+ new tests across SDK and Kernel test directories.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: SDK base class and contract tests</name>
  <files>
    DataWarehouse.Tests/SDK/PluginBaseTests.cs
    DataWarehouse.Tests/SDK/StrategyBaseTests.cs
    DataWarehouse.Tests/SDK/GuardsTests.cs
    DataWarehouse.Tests/SDK/BoundedCollectionTests.cs
    DataWarehouse.Tests/SDK/StorageAddressTests.cs
  </files>
  <action>
Create comprehensive SDK tests. For each test class, use [Trait("Category", "Unit")] and xUnit.

PluginBaseTests.cs (20+ tests):
- Lifecycle: Initialize -> Execute -> Shutdown sequence
- IDisposable: Dispose zeros state, double-dispose is safe
- IAsyncDisposable: DisposeAsync works
- Capability registration: RegisterCapability adds to registry
- Knowledge registration: RegisterKnowledge adds to bank
- Health check: default returns Healthy
- CancellationToken: cancellation stops operations

StrategyBaseTests.cs (15+ tests):
- Lifecycle: Initialize -> Shutdown
- Name/Description/StrategyId properties
- Dispose/DisposeAsync cleanup
- Domain base classes: at least one test per domain base (verify abstract contract)

GuardsTests.cs (25+ tests):
- NotNull: throws on null, passes non-null
- NotNullOrEmpty: throws on null, empty, whitespace; passes valid string
- InRange: int, long, double ranges with boundary tests
- ValidPath: path traversal rejection (../, ..\\, %2e%2e, null bytes)
- ValidRegex: regex timeout enforcement
- MaxSize: message size (10MB), knowledge object size (1MB)
- Each Guard method: test exact boundary (at limit passes, at limit+1 fails)

BoundedCollectionTests.cs (15+ tests):
- BoundedDictionary: max capacity enforced, oldest evicted, count correct
- BoundedQueue: max capacity, dequeue order, overflow behavior
- Thread safety: concurrent add from multiple threads, count remains <= max
- Empty collection operations: dequeue from empty, remove from empty

StorageAddressTests.cs (20+ tests):
- Each variant: FilePath, BlockDevice, NvmeNamespace, ObjectKey, NetworkEndpoint, GpioPin, I2cBus, SpiBus, CustomAddress
- Implicit conversions: string -> StorageAddress, Uri -> StorageAddress
- ToKey(), ToUri(), ToPath() conversions
- Equality and GetHashCode
- Round-trip: create -> serialize -> deserialize -> equals original
  </action>
  <verify>dotnet test DataWarehouse.Tests/ --filter "Category=Unit" — all new tests pass</verify>
  <done>95+ new unit tests for SDK base classes, Guards, BoundedCollections, StorageAddress; all pass</done>
</task>

<task type="auto">
  <name>Task 2: Distributed and security contract tests</name>
  <files>
    DataWarehouse.Tests/SDK/DistributedTests.cs
    DataWarehouse.Tests/SDK/SecurityContractTests.cs
    DataWarehouse.Tests/SDK/VirtualDiskTests.cs
    DataWarehouse.Tests/Kernel/MessageBusTests.cs
  </files>
  <action>
Create distributed system tests:

DistributedTests.cs (30+ tests):
- SWIM: join cluster, suspect detection, incarnation increment, GetMembers caching
- Raft: leader election (single node = immediate leader), log append, term increment
- Raft: vote request handling (grant if term higher, reject if already voted)
- CRDT GCounter: increment, merge (Math.Max per node), idempotent merge
- CRDT PNCounter: increment/decrement, merge correctness
- CRDT ORSet: add, remove, concurrent add+remove resolution, tombstone GC
- ConsistentHashRing: key distribution, virtual nodes, add/remove node rebalancing
- InMemory implementations: all 13 in-memory contracts (basic smoke tests)

SecurityContractTests.cs (20+ tests):
- SIEM: SiemEvent construction, severity mapping
- SiemTransportBridge: event batching, flush on batch full
- IncidentResponseEngine: create incident, execute action, auto-response rule trigger
- ContainmentActions: each action produces correct bus topic
- SBOM: SbomGenerator produces valid CycloneDX JSON structure
- DependencyScanner: offline scan with known-vulnerable package
- SLSA: provenance generation and verification (level 1/2/3)

VirtualDiskTests.cs (20+ tests):
- Block allocation: allocate, free, reallocate
- WAL: append entry, replay after "crash" (close and reopen)
- Inode: create, read metadata, update, delete
- B-Tree: insert, lookup, delete, range scan
- CoW: write creates new block, original unchanged
- Snapshot: create snapshot, verify data unchanged after subsequent writes

MessageBusTests.cs (15+ tests):
- Publish/subscribe: subscriber receives published message
- Topic filtering: subscriber only gets matching topics
- In-process Channel<T>: messages delivered correctly
- Unsubscribe: no messages after unsubscribe
- Concurrent publish: multiple publishers, single subscriber, all messages received
  </action>
  <verify>dotnet test DataWarehouse.Tests/ --filter "Category=Unit" — all new tests pass. Total test count should be 1200+</verify>
  <done>85+ new tests for distributed (SWIM/Raft/CRDT), security (SIEM/SBOM/SLSA), VDE, and MessageBus; total tests 1200+</done>
</task>

</tasks>

<verification>
- `dotnet test DataWarehouse.Tests/` — all tests pass, zero failures
- New test count: 180+ added
- Coverage areas: SDK base classes, Guards, distributed, security, VDE, MessageBus
</verification>

<success_criteria>
180+ new unit tests added. SDK base classes, distributed contracts, security infrastructure, and VDE all have comprehensive test coverage. Total test count exceeds 1200.
</success_criteria>

<output>
After completion, create `.planning/phases/65-infrastructure/65-16-SUMMARY.md`
</output>
