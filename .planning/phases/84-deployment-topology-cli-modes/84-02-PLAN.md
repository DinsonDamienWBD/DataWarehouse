---
phase: 84-deployment-topology-cli-modes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.CLI/Commands/VdeCommands.cs
  - DataWarehouse.CLI/Program.cs
autonomous: true
must_haves:
  truths:
    - "dw vde create --modules security,tags,replication creates a DWVD file with exactly those 3 modules active"
    - "Module names are validated against the 19 known ModuleId values"
    - "Invalid module names produce a clear error message listing valid modules"
    - "VDE creation uses VdeCreator and VdeCreationProfile from Phase 71"
    - "Residency strategy prompt is shown per MRES-08"
  artifacts:
    - path: "DataWarehouse.CLI/Commands/VdeCommands.cs"
      provides: "VDE create command implementation"
      contains: "VdeCreator"
    - path: "DataWarehouse.CLI/Program.cs"
      provides: "dw vde create subcommand registration"
      contains: "CreateVdeCommand"
  key_links:
    - from: "DataWarehouse.CLI/Commands/VdeCommands.cs"
      to: "DataWarehouse.SDK/VirtualDiskEngine/Format/VdeCreator.cs"
      via: "Calls VdeCreator.CreateAsync with composed profile"
      pattern: "VdeCreator"
    - from: "DataWarehouse.CLI/Commands/VdeCommands.cs"
      to: "DataWarehouse.SDK/VirtualDiskEngine/Format/ModuleDefinitions.cs"
      via: "Parses module names to ModuleId enum"
      pattern: "ModuleId"
---

<objective>
Implement `dw vde create` CLI command with `--modules` flag that creates composable VDE files using the Phase 71 VDE v2.0 format engine.

Purpose: DPLY-05 requires CLI VDE composition; MRES-08 requires residency prompts during creation.
Output: VdeCommands.cs with create subcommand, wired into Program.cs.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@DataWarehouse.SDK/VirtualDiskEngine/Format/VdeCreator.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/VdeCreationProfile.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/ModuleDefinitions.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/ModuleManifest.cs
@DataWarehouse.CLI/Program.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: VdeCommands.cs with create command</name>
  <files>DataWarehouse.CLI/Commands/VdeCommands.cs</files>
  <action>
Create `DataWarehouse.CLI/Commands/VdeCommands.cs`:

```csharp
namespace DataWarehouse.CLI.Commands;
```

Implement `public static class VdeCommands` with:

**`CreateAsync(string outputPath, string modules, string? profile, int blockSize, long totalBlocks, string? residencyStrategy)`:**

1. Parse `modules` (comma-separated) into `List<ModuleId>`:
   - Split on comma, trim whitespace, lowercase
   - For each name, try `Enum.TryParse<ModuleId>(name, ignoreCase: true, out var id)`
   - If any name fails, print error with all valid module names (iterate `Enum.GetValues<ModuleId>()`) and return
   - Example valid: "security,tags,replication" -> [ModuleId.Security, ModuleId.Tags, ModuleId.Replication]

2. Build `ModuleManifestField` via `ModuleManifestField.FromModules(parsedModules.ToArray())`

3. If `profile` is specified, try to use a named preset (`VdeProfileType`); otherwise build a Custom profile:
   ```csharp
   var creationProfile = new VdeCreationProfile
   {
       ProfileType = VdeProfileType.Custom,
       Name = "Custom",
       Description = $"Custom VDE with modules: {modules}",
       ModuleManifest = manifest.Value,
       ModuleConfigLevels = parsedModules.ToDictionary(m => m, _ => (byte)1),
       BlockSize = blockSize,
       TotalBlocks = totalBlocks,
       ThinProvisioned = true,
   };
   ```

4. Residency strategy prompt (MRES-08): Show a table of module names with their default residency. If `residencyStrategy` is null, use Spectre.Console `SelectionPrompt` to pick from: "VdePrimary", "PluginOnly", "VdeFirstSync", "FallbackAndRepair". Print selected strategy.

5. Create VDE using `VdeCreator`:
   ```csharp
   await using var stream = File.Create(outputPath);
   var creator = new VdeCreator();
   await creator.CreateAsync(stream, creationProfile, CancellationToken.None);
   ```

6. Display summary: output path, file size, active modules, block size, total blocks.

**`ListModulesAsync()`:**
List all 19 modules with their ModuleId, abbreviation (from ModuleRegistry if accessible), and description.

**`InspectAsync(string path)`:**
Open a DWVD file, read superblock, display active modules, block size, total blocks, format version.

Use `Spectre.Console` for all output (Table, Panel, MarkupLine).
  </action>
  <verify>Build `DataWarehouse.CLI` with `dotnet build DataWarehouse.CLI/DataWarehouse.CLI.csproj` -- zero errors.</verify>
  <done>VdeCommands.CreateAsync creates a real DWVD file with user-selected modules via VdeCreator; module name validation works; residency prompt shown.</done>
</task>

<task type="auto">
  <name>Task 2: Wire dw vde command group into Program.cs</name>
  <files>DataWarehouse.CLI/Program.cs</files>
  <action>
In `Program.cs`:

1. Add a `CreateVdeCommand(Option<OutputFormat> formatOption)` method that builds:
   ```
   dw vde
     create  -- Create a new VDE file
     list-modules -- List available VDE modules
     inspect -- Inspect an existing VDE file
   ```

2. `create` subcommand options:
   - `--output` or `-o` (required): Output .dwvd file path
   - `--modules` or `-m` (required): Comma-separated module names
   - `--profile`: Named profile (minimal, standard, enterprise, max-security, edge-iot, analytics)
   - `--block-size`: Block size in bytes (default 4096)
   - `--total-blocks`: Total blocks (default 1048576 = 4GB at 4K blocks)
   - `--residency`: Residency strategy (optional, prompts if omitted)

3. `list-modules` subcommand: no options, calls `VdeCommands.ListModulesAsync()`

4. `inspect` subcommand:
   - Positional `path` argument
   - Calls `VdeCommands.InspectAsync(path)`

5. Register in `BuildRootCommand()`: `rootCommand.Subcommands.Add(CreateVdeCommand(formatOption));`

6. For `create` subcommand, use `SetAction` to extract all options and call `VdeCommands.CreateAsync(...)`.
  </action>
  <verify>Build `DataWarehouse.CLI` with `dotnet build DataWarehouse.CLI/DataWarehouse.CLI.csproj` -- zero errors. `dw vde create --help` shows all options.</verify>
  <done>`dw vde` command group with create/list-modules/inspect subcommands is registered; CLI builds and help text renders correctly.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.sln` compiles with zero errors
- `dw vde create --modules security,tags --output test.dwvd` would create a file
- `dw vde list-modules` lists all 19 modules
</verification>

<success_criteria>
- `dw vde create --modules security,tags,replication --output test.dwvd` creates a valid DWVD v2.0 file
- Invalid module names produce error with valid module list
- Residency strategy prompt appears when --residency not specified
- All 19 ModuleId values are listable via `dw vde list-modules`
- Solution builds with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/84-deployment-topology-cli-modes/84-02-SUMMARY.md`
</output>
