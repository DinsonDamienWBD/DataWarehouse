---
phase: 84-deployment-topology-cli-modes
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.CLI/Commands/ServerCommands.cs
  - DataWarehouse.CLI/Program.cs
  - DataWarehouse.Shared/Services/PortableMediaDetector.cs
autonomous: true
must_haves:
  truths:
    - "ServerCommands.ShowStatusAsync queries real server status via InstanceManager HTTP API"
    - "ServerCommands.StartServerAsync performs real kernel lifecycle (no Task.Delay stubs)"
    - "ServerCommands.StopServerAsync performs real kernel shutdown (no Task.Delay stubs)"
    - "CLI Program.cs uses await FindLocalLiveInstanceAsync (no sync-over-async)"
    - "FindLocalLiveInstance sync wrapper is marked [Obsolete]"
  artifacts:
    - path: "DataWarehouse.CLI/Commands/ServerCommands.cs"
      provides: "Real server lifecycle management"
      contains: "HttpClient"
    - path: "DataWarehouse.CLI/Program.cs"
      provides: "Async FindLocalLiveInstance call"
      contains: "await.*FindLocalLiveInstanceAsync"
  key_links:
    - from: "DataWarehouse.CLI/Commands/ServerCommands.cs"
      to: "DataWarehouse.Kernel/KernelBuilder.cs"
      via: "Uses KernelBuilder for real Start/Stop lifecycle"
      pattern: "KernelBuilder"
    - from: "DataWarehouse.CLI/Program.cs"
      to: "DataWarehouse.Shared/Services/PortableMediaDetector.cs"
      via: "Calls async FindLocalLiveInstanceAsync"
      pattern: "FindLocalLiveInstanceAsync"
---

<objective>
Fix CLI stubs: replace ServerCommands fake data with real HTTP API queries, replace Task.Delay lifecycle stubs with real kernel management, and fix sync-over-async in Program.cs.

Purpose: DPLY-09 (ShowStatusAsync real data), DPLY-10 (Start/Stop real lifecycle), DPLY-11 (sync-over-async fix).
Output: Production-ready ServerCommands and async-clean Program.cs.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@DataWarehouse.CLI/Commands/ServerCommands.cs
@DataWarehouse.CLI/Program.cs
@DataWarehouse.Shared/Services/PortableMediaDetector.cs
@DataWarehouse.Kernel/KernelBuilder.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix ServerCommands with real implementations</name>
  <files>DataWarehouse.CLI/Commands/ServerCommands.cs</files>
  <action>
Rewrite `ServerCommands.cs` to replace all stubs:

**ShowStatusAsync():**
- If `_runningKernel != null` (local server running):
  - Query real data: `_runningKernel.KernelId`, `_runningKernel.OperatingMode`, `_runningKernel.Plugins.GetAllPlugins().Count()`
  - Calculate real uptime from `_startTime` (add a `private static DateTime? _startTime` field, set in StartServerAsync)
  - Display real memory: `Process.GetCurrentProcess().WorkingSet64 / (1024 * 1024)` MB
  - Display .NET version: `Environment.Version`
- If no local kernel, try HTTP API check:
  - Use `HttpClient` to GET `http://localhost:{port}/api/v1/info` (use the port from the last start, or default 8080)
  - If reachable, parse JSON response for version, uptime, connections
  - If not reachable, show "No server instance detected" (not fake "Running" data!)
- Remove ALL hardcoded fake data (the "15d 7h 23m" uptime, "45 active" connections, "1,234" requests/sec)

**StartServerAsync(int port, string mode):**
- Keep the real `KernelBuilder.Create()...BuildAndInitializeAsync()` path (already exists)
- Remove `await Task.Delay(500)` and `await Task.Delay(300)` lines -- replace with actual kernel start verification
- After kernel init, verify it's actually running by checking `_runningKernel.Plugins.GetAllPlugins().Any()`
- Record `_startTime = DateTime.UtcNow`
- Display real plugin count, not hardcoded

**StopServerAsync(bool graceful):**
- Remove `await Task.Delay(500)`, `await Task.Delay(300)`, `await Task.Delay(400)` lines
- If graceful: call `_runningKernel.DisposeAsync()` which handles graceful shutdown internally
- If not graceful: cancel the CTS immediately then dispose
- Clear `_startTime = null`
- The existing `_serverCts?.Cancel()` + `DisposeAsync()` pattern is fine; just remove the Task.Delay stubs

**ShowInfoAsync():**
- Remove `await Task.Delay(300)` stub
- Keep the real system info display but update version to pull from assembly metadata
- Update plugin count: if kernel running, show real count; otherwise show "N/A"
  </action>
  <verify>Build `DataWarehouse.CLI` with `dotnet build DataWarehouse.CLI/DataWarehouse.CLI.csproj` -- zero errors. Grep for `Task.Delay` in ServerCommands.cs should return zero matches.</verify>
  <done>ServerCommands has zero Task.Delay stubs; ShowStatusAsync queries real kernel or HTTP API; Start/Stop use real kernel lifecycle; all hardcoded fake data removed.</done>
</task>

<task type="auto">
  <name>Task 2: Fix sync-over-async in Program.cs and mark sync wrapper obsolete</name>
  <files>DataWarehouse.CLI/Program.cs, DataWarehouse.Shared/Services/PortableMediaDetector.cs</files>
  <action>
**Program.cs:**
The current code at line 56 calls the sync wrapper:
```csharp
var liveInstanceUrl = PortableMediaDetector.FindLocalLiveInstance();
```
This must be changed to the async version. Since `Main` is already `async Task<int>`:
```csharp
var liveInstanceUrl = await PortableMediaDetector.FindLocalLiveInstanceAsync();
```
This is a one-line fix but critical for correctness (the sync wrapper uses `.GetAwaiter().GetResult()` which can deadlock).

**PortableMediaDetector.cs:**
Mark the sync wrapper as obsolete:
```csharp
[Obsolete("Use FindLocalLiveInstanceAsync instead. Sync wrapper risks deadlock.")]
public static string? FindLocalLiveInstance(int[]? portsToCheck = null)
```
Do NOT delete the method (backward compat for any other callers), just mark it `[Obsolete]`.
  </action>
  <verify>Build `DataWarehouse.CLI` and `DataWarehouse.Shared` -- zero errors. Grep for `FindLocalLiveInstance\(\)` (without Async) in Program.cs should return zero non-obsolete calls.</verify>
  <done>Program.cs uses `await FindLocalLiveInstanceAsync()`; sync wrapper marked [Obsolete]; no sync-over-async in CLI entry point; both projects build cleanly.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.sln` compiles with zero errors (obsolete warning in PortableMediaDetector is acceptable)
- Zero `Task.Delay` calls in ServerCommands.cs
- Zero sync-over-async `FindLocalLiveInstance()` calls in Program.cs
- No hardcoded fake server status data
</verification>

<success_criteria>
- ShowStatusAsync shows real data (kernel state, real uptime, real memory) or "no server detected" (never fake data)
- StartServerAsync/StopServerAsync use real kernel lifecycle with zero Task.Delay stubs
- Program.cs line 56 uses await FindLocalLiveInstanceAsync()
- FindLocalLiveInstance sync wrapper is [Obsolete]
- Solution builds with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/84-deployment-topology-cli-modes/84-05-SUMMARY.md`
</output>
