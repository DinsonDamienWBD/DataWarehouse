---
phase: 84-deployment-topology-cli-modes
plan: 04
type: execute
wave: 2
depends_on: ["84-01"]
files_modified:
  - DataWarehouse.SDK/Hosting/InstallShellRegistration.cs
  - DataWarehouse.CLI/Commands/InstallCommand.cs
autonomous: true
must_haves:
  truths:
    - "Install mode automatically registers .dwvd shell handlers on the current OS"
    - "Windows registration uses HKCU registry entries (non-admin)"
    - "Linux registration writes freedesktop MIME and magic files to user-local dirs"
    - "macOS registration writes UTI plist to user-local LaunchServices"
    - "Secondary extensions (.dwvd.snap, .dwvd.delta, .dwvd.meta, .dwvd.lock) are also registered"
    - ".dw script extension is registered"
  artifacts:
    - path: "DataWarehouse.SDK/Hosting/InstallShellRegistration.cs"
      provides: "Cross-platform shell registration orchestrator"
      contains: "RegisterFileExtensions"
    - path: "DataWarehouse.CLI/Commands/InstallCommand.cs"
      provides: "Calls shell registration during install"
      contains: "InstallShellRegistration"
  key_links:
    - from: "DataWarehouse.CLI/Commands/InstallCommand.cs"
      to: "DataWarehouse.SDK/Hosting/InstallShellRegistration.cs"
      via: "Calls RegisterFileExtensions after successful install"
      pattern: "InstallShellRegistration"
    - from: "DataWarehouse.SDK/Hosting/InstallShellRegistration.cs"
      to: "DataWarehouse.SDK/VirtualDiskEngine/FileExtension/OsIntegration/WindowsShellHandler.cs"
      via: "Uses WindowsShellHandler verbs for Windows registration"
      pattern: "WindowsShellHandler"
---

<objective>
Wire shell handler and file extension registration into the install flow so `.dwvd` files are automatically associated with DataWarehouse on install.

Purpose: DPLY-07 and DPLY-08 require automatic shell handler and extension registration during install mode.
Output: InstallShellRegistration orchestrator in SDK, called from InstallCommand during install.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@DataWarehouse.SDK/VirtualDiskEngine/FileExtension/OsIntegration/WindowsShellHandler.cs
@DataWarehouse.SDK/VirtualDiskEngine/FileExtension/OsIntegration/WindowsRegistryBuilder.cs
@DataWarehouse.SDK/VirtualDiskEngine/FileExtension/OsIntegration/WindowsProgId.cs
@DataWarehouse.SDK/VirtualDiskEngine/FileExtension/OsIntegration/LinuxMimeInfo.cs
@DataWarehouse.SDK/VirtualDiskEngine/FileExtension/OsIntegration/LinuxMagicRule.cs
@DataWarehouse.SDK/VirtualDiskEngine/FileExtension/OsIntegration/MacOsUti.cs
@DataWarehouse.SDK/VirtualDiskEngine/FileExtension/DwvdMimeType.cs
@DataWarehouse.SDK/VirtualDiskEngine/FileExtension/SecondaryExtension.cs
@DataWarehouse.CLI/Commands/InstallCommand.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: InstallShellRegistration orchestrator</name>
  <files>DataWarehouse.SDK/Hosting/InstallShellRegistration.cs</files>
  <action>
Create `DataWarehouse.SDK/Hosting/InstallShellRegistration.cs`:

```csharp
namespace DataWarehouse.SDK.Hosting;
```

Implement `public static class InstallShellRegistration` with `[SdkCompatibility("6.0.0", Notes = "Phase 84: Install-time shell registration (DPLY-07, DPLY-08)")]`:

**`RegisterFileExtensions(string installPath, IProgress<string>? progress = null)`:**

1. Detect OS via `OperatingSystem.IsWindows()`, `IsLinux()`, `IsMacOS()`.

2. **Windows path:**
   - Use `WindowsRegistryBuilder` (from Phase 79) to generate HKCU registry entries for:
     - Primary `.dwvd` extension -> `DataWarehouse.Dwvd` ProgID
     - Secondary extensions: `.dwvd.snap` -> `DataWarehouse.DwvdSnap`, `.dwvd.delta` -> `DataWarehouse.DwvdDelta`, `.dwvd.meta` -> `DataWarehouse.DwvdMeta`, `.dwvd.lock` -> `DataWarehouse.DwvdLock`
     - `.dw` script extension -> `DataWarehouse.DwScript` ProgID
   - Use `WindowsShellHandler.GetPrimaryVerbs()` (or construct verbs) for open/inspect/verify shell verbs.
   - Write ProgID entries with command templates pointing to `Path.Combine(installPath, "dw.exe")`.
   - Generate a PowerShell script string that writes HKCU entries (since Phase 79 WindowsRegistryBuilder produces registry-compatible output). Execute via `Process.Start("powershell", ...)` or write to `.reg` file and import. Prefer the PowerShell approach for HKCU (non-admin).
   - Report progress: "Registering Windows shell handlers..."

3. **Linux path:**
   - Use `LinuxMimeInfo` to generate the `~/.local/share/mime/packages/datawarehouse-dwvd.xml` file.
   - Use `LinuxMagicRule` to generate `~/.local/share/mime/magic` entries.
   - Write `.desktop` file to `~/.local/share/applications/datawarehouse.desktop` with `Exec=dw open %f` and `MimeType=application/vnd.datawarehouse.dwvd`.
   - Run `update-mime-database ~/.local/share/mime` and `update-desktop-database ~/.local/share/applications` via Process.Start.
   - Report progress: "Registering Linux MIME types and desktop entries..."

4. **macOS path:**
   - Use `MacOsUti` to generate the UTI declaration plist.
   - Write to `~/Library/LaunchServices/` or use `duti` if available.
   - Run `lsregister` to refresh: `/System/Library/Frameworks/CoreServices.framework/Frameworks/LaunchServices.framework/Support/lsregister -f <installPath>`.
   - Report progress: "Registering macOS UTI types..."

5. All registration is idempotent (overwrites existing entries safely).

6. Return a `ShellRegistrationResult` record with `bool Success`, `string[] RegisteredExtensions`, `string? Error`.

**`UnregisterFileExtensions()`:** Reverse of above (for uninstall). Remove all entries created by RegisterFileExtensions.
  </action>
  <verify>Build `DataWarehouse.SDK` with `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` -- zero errors.</verify>
  <done>InstallShellRegistration.RegisterFileExtensions handles Windows/Linux/macOS; all 6 extensions registered (.dwvd, 4 secondary, .dw); idempotent writes; SDK builds cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Call shell registration from InstallCommand</name>
  <files>DataWarehouse.CLI/Commands/InstallCommand.cs</files>
  <action>
In `InstallCommand.ExecuteAsync`, after `host.InstallAsync(config, progress)` returns successfully:

1. Add shell registration step:
   ```csharp
   ctx.Status("[cyan]Registering file extensions...[/]");
   var shellResult = InstallShellRegistration.RegisterFileExtensions(
       path,
       new Progress<string>(msg => ctx.Status($"[cyan]{msg}[/]")));
   ```

2. Display registration result:
   - If success: `AnsiConsole.MarkupLine($"  File extensions: [green]{string.Join(", ", shellResult.RegisteredExtensions)}[/]");`
   - If failure: `AnsiConsole.MarkupLine($"  File extensions: [yellow]Registration failed: {shellResult.Error}[/]");` (non-fatal -- install still succeeds)

3. Only run shell registration when topology includes VDE (DwPlusVde or VdeOnly). Skip for DwOnly since it doesn't handle .dwvd files locally:
   ```csharp
   if (DeploymentTopologyDescriptor.RequiresVdeEngine(deploymentTopology))
   {
       // register shell handlers
   }
   ```

Add `using DataWarehouse.SDK.Hosting;` if not already present.
  </action>
  <verify>Build `DataWarehouse.CLI` with `dotnet build DataWarehouse.CLI/DataWarehouse.CLI.csproj` -- zero errors.</verify>
  <done>Install command calls InstallShellRegistration after successful install for VDE-capable topologies; registration results displayed; CLI builds cleanly.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.sln` compiles with zero errors
- InstallShellRegistration handles all 3 OS platforms
- Shell registration is called only for VDE-capable topologies
- Registration is non-fatal (install succeeds even if registration fails)
</verification>

<success_criteria>
- InstallShellRegistration.RegisterFileExtensions exists and handles Windows/Linux/macOS
- .dwvd, .dwvd.snap, .dwvd.delta, .dwvd.meta, .dwvd.lock, and .dw extensions are registered
- InstallCommand calls registration after successful install (VDE topologies only)
- Registration failure is logged as warning, not error
- Solution builds with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/84-deployment-topology-cli-modes/84-04-SUMMARY.md`
</output>
