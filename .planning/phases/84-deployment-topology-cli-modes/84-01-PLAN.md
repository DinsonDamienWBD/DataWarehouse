---
phase: 84-deployment-topology-cli-modes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - DataWarehouse.SDK/Hosting/DeploymentTopology.cs
  - DataWarehouse.SDK/Hosting/InstallConfiguration.cs
  - DataWarehouse.CLI/Commands/InstallCommand.cs
  - DataWarehouse.CLI/Program.cs
autonomous: true
must_haves:
  truths:
    - "dw install --topology dw-only deploys DW kernel without local VDE engine"
    - "dw install --topology vde-only deploys slim VDE host without full DW kernel"
    - "dw install --topology dw+vde deploys both co-located (current default, made explicit)"
    - "DW-only can specify a remote VDE connection URL at install time"
    - "VDE-only host accepts remote DW connections over network"
  artifacts:
    - path: "DataWarehouse.SDK/Hosting/DeploymentTopology.cs"
      provides: "DeploymentTopology enum and topology descriptor"
      contains: "enum DeploymentTopology"
    - path: "DataWarehouse.SDK/Hosting/InstallConfiguration.cs"
      provides: "Topology field on InstallConfiguration"
      contains: "DeploymentTopology"
    - path: "DataWarehouse.CLI/Commands/InstallCommand.cs"
      provides: "Topology-aware install flow"
      contains: "topology"
    - path: "DataWarehouse.CLI/Program.cs"
      provides: "CLI --topology option on install command"
      contains: "--topology"
  key_links:
    - from: "DataWarehouse.CLI/Program.cs"
      to: "DataWarehouse.CLI/Commands/InstallCommand.cs"
      via: "CreateInstallCommand passes topology to ExecuteAsync"
      pattern: "topology"
    - from: "DataWarehouse.CLI/Commands/InstallCommand.cs"
      to: "DataWarehouse.SDK/Hosting/InstallConfiguration.cs"
      via: "Sets Topology property before calling host.InstallAsync"
      pattern: "config\\.Topology"
---

<objective>
Add deployment topology model (DW-only, VDE-only, DW+VDE) and wire it into the CLI install command so users can choose which components to deploy.

Purpose: DPLY-01 through DPLY-04 require three distinct deployment topologies selectable at install time.
Output: DeploymentTopology enum, updated InstallConfiguration, topology-aware install command with --topology flag.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@DataWarehouse.SDK/Hosting/InstallConfiguration.cs
@DataWarehouse.SDK/Hosting/OperatingMode.cs
@DataWarehouse.CLI/Commands/InstallCommand.cs
@DataWarehouse.CLI/Program.cs
@DataWarehouse.Launcher/Integration/DataWarehouseHost.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: DeploymentTopology enum and InstallConfiguration update</name>
  <files>DataWarehouse.SDK/Hosting/DeploymentTopology.cs, DataWarehouse.SDK/Hosting/InstallConfiguration.cs</files>
  <action>
Create `DataWarehouse.SDK/Hosting/DeploymentTopology.cs` with:

```csharp
namespace DataWarehouse.SDK.Hosting;

/// <summary>
/// Deployment topology determines which components are deployed on a host.
/// Selected at install time via <c>dw install --topology</c>.
/// </summary>
public enum DeploymentTopology
{
    /// <summary>Full DW kernel + local VDE engine co-located on the same host (default).</summary>
    DwPlusVde = 0,

    /// <summary>DW kernel only. Connects to remote VDE instances over the network for storage.</summary>
    DwOnly = 1,

    /// <summary>VDE engine only. Slim host without full DW kernel. Accepts remote DW connections.</summary>
    VdeOnly = 2,
}

/// <summary>
/// Describes a deployment topology's characteristics: what runs, what connects remotely.
/// </summary>
public static class DeploymentTopologyDescriptor
{
    public static bool RequiresDwKernel(DeploymentTopology topology) =>
        topology is DeploymentTopology.DwPlusVde or DeploymentTopology.DwOnly;

    public static bool RequiresVdeEngine(DeploymentTopology topology) =>
        topology is DeploymentTopology.DwPlusVde or DeploymentTopology.VdeOnly;

    public static bool RequiresRemoteVdeConnection(DeploymentTopology topology) =>
        topology == DeploymentTopology.DwOnly;

    public static bool AcceptsRemoteDwConnections(DeploymentTopology topology) =>
        topology == DeploymentTopology.VdeOnly;

    public static string GetDescription(DeploymentTopology topology) => topology switch
    {
        DeploymentTopology.DwPlusVde => "Full DataWarehouse + VDE co-located (default)",
        DeploymentTopology.DwOnly => "DataWarehouse kernel only (connects to remote VDE)",
        DeploymentTopology.VdeOnly => "VDE engine only (accepts remote DW connections)",
        _ => throw new ArgumentOutOfRangeException(nameof(topology)),
    };
}
```

Add `[SdkCompatibility("6.0.0", Notes = "Phase 84: Deployment topology (DPLY-01)")]` to both types.

Update `InstallConfiguration.cs` to add:
- `public DeploymentTopology Topology { get; set; } = DeploymentTopology.DwPlusVde;` (default = co-located for backward compat)
- `public string? RemoteVdeUrl { get; set; }` (used when Topology == DwOnly, URL of remote VDE to connect to)
- `public int VdeListenPort { get; set; } = 9443;` (used when Topology == VdeOnly, port to accept DW connections)
  </action>
  <verify>Build `DataWarehouse.SDK` with `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj` -- zero errors.</verify>
  <done>DeploymentTopology enum exists with 3 values; InstallConfiguration has Topology, RemoteVdeUrl, VdeListenPort properties; SDK builds cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Wire --topology into CLI install command</name>
  <files>DataWarehouse.CLI/Program.cs, DataWarehouse.CLI/Commands/InstallCommand.cs</files>
  <action>
In `Program.cs` `CreateInstallCommand()`:
- Add `var topologyOption = new Option<string>("--topology") { Description = "Deployment topology: dw-only, vde-only, dw+vde (default)", DefaultValueFactory = _ => "dw+vde" };`
- Add `command.Options.Add(topologyOption);`
- Pass topology value into parameters dict: `parameters["topology"] = parseResult.GetValue(topologyOption);`
- Add `var remoteVdeOption = new Option<string?>("--remote-vde") { Description = "Remote VDE URL (for dw-only topology)" };` and wire similarly.
- Add `var vdePortOption = new Option<int>("--vde-port") { Description = "VDE listen port (for vde-only topology)", DefaultValueFactory = _ => 9443 };` and wire similarly.

In `InstallCommand.cs` `ExecuteAsync()`:
- Add `string topology = "dw+vde"` parameter, `string? remoteVdeUrl = null`, `int vdeListenPort = 9443`.
- Parse topology string to enum: `var deploymentTopology = topology.ToLowerInvariant() switch { "dw-only" => DeploymentTopology.DwOnly, "vde-only" => DeploymentTopology.VdeOnly, _ => DeploymentTopology.DwPlusVde };`
- Set `config.Topology = deploymentTopology;`, `config.RemoteVdeUrl = remoteVdeUrl;`, `config.VdeListenPort = vdeListenPort;`
- After preset detection, display selected topology: `AnsiConsole.MarkupLine($"  Topology: [yellow]{DeploymentTopologyDescriptor.GetDescription(deploymentTopology)}[/]");`
- Add validation: if DwOnly and remoteVdeUrl is null, emit warning "DW-only topology without --remote-vde; you'll need to configure remote VDE later."
- If VdeOnly, skip the full kernel initialization (only write VDE config, skip DW-specific dirs/config).
  </action>
  <verify>Build `DataWarehouse.CLI` with `dotnet build DataWarehouse.CLI/DataWarehouse.CLI.csproj` -- zero errors.</verify>
  <done>CLI `install` command accepts `--topology dw-only|vde-only|dw+vde`, `--remote-vde`, and `--vde-port` options; topology is set on InstallConfiguration before host.InstallAsync call; CLI builds cleanly.</done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.sln` compiles with zero errors
- `DeploymentTopology` enum is referenced from both SDK and CLI
- `--topology` option appears in CLI install help
</verification>

<success_criteria>
- DeploymentTopology enum with DwPlusVde, DwOnly, VdeOnly exists in SDK
- InstallConfiguration has Topology, RemoteVdeUrl, VdeListenPort properties
- CLI `dw install --topology dw-only` parses correctly and sets DwOnly
- VDE-only topology skips DW kernel init steps
- Solution builds with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/84-deployment-topology-cli-modes/84-01-SUMMARY.md`
</output>
