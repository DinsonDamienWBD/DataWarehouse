---
phase: 84-deployment-topology-cli-modes
plan: 06
type: execute
wave: 3
depends_on: ["84-01", "84-02", "84-04", "84-05"]
files_modified:
  - DataWarehouse.Tests/Integration/DeploymentTopologyTests.cs
  - DataWarehouse.Tests/Integration/VdeComposerTests.cs
  - DataWarehouse.Tests/Integration/ShellRegistrationTests.cs
autonomous: true
must_haves:
  truths:
    - "Tests verify all three topology configurations install correctly"
    - "Tests verify VDE composer creates valid DWVD files with specified modules"
    - "Tests verify shell registration produces correct entries per OS"
    - "Tests verify ServerCommands returns real data (not stubs)"
    - "Tests verify FindLocalLiveInstanceAsync is used (no sync-over-async)"
  artifacts:
    - path: "DataWarehouse.Tests/Integration/DeploymentTopologyTests.cs"
      provides: "Topology install and mode tests"
      contains: "DeploymentTopology"
    - path: "DataWarehouse.Tests/Integration/VdeComposerTests.cs"
      provides: "VDE creation and module validation tests"
      contains: "VdeCreator"
    - path: "DataWarehouse.Tests/Integration/ShellRegistrationTests.cs"
      provides: "Shell registration verification tests"
      contains: "InstallShellRegistration"
  key_links:
    - from: "DataWarehouse.Tests/Integration/DeploymentTopologyTests.cs"
      to: "DataWarehouse.SDK/Hosting/DeploymentTopology.cs"
      via: "Tests all enum values and descriptor methods"
      pattern: "DeploymentTopology"
    - from: "DataWarehouse.Tests/Integration/VdeComposerTests.cs"
      to: "DataWarehouse.SDK/VirtualDiskEngine/Format/VdeCreator.cs"
      via: "Creates VDE files with various module combinations"
      pattern: "VdeCreator"
---

<objective>
Write integration tests covering all deployment modes, topologies, VDE composer flow, shell registration, and CLI stub fixes.

Purpose: DPLY-12 requires integration tests for all modes and topologies.
Output: Three test files with comprehensive coverage of Phase 84 features.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@DataWarehouse.SDK/Hosting/DeploymentTopology.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/VdeCreator.cs
@DataWarehouse.SDK/VirtualDiskEngine/Format/ModuleDefinitions.cs
@DataWarehouse.SDK/Hosting/InstallShellRegistration.cs
@DataWarehouse.CLI/Commands/ServerCommands.cs
@DataWarehouse.CLI/Commands/VdeCommands.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deployment topology and server command tests</name>
  <files>DataWarehouse.Tests/Integration/DeploymentTopologyTests.cs</files>
  <action>
Create `DeploymentTopologyTests.cs` with xUnit tests:

**Topology Model Tests (10+):**
- `DeploymentTopology_HasThreeValues` -- Enum has DwPlusVde, DwOnly, VdeOnly
- `DwPlusVde_RequiresBothKernelAndVde` -- descriptor.RequiresDwKernel and RequiresVdeEngine both true
- `DwOnly_RequiresKernelOnly` -- RequiresDwKernel true, RequiresVdeEngine false
- `VdeOnly_RequiresVdeEngineOnly` -- RequiresDwKernel false, RequiresVdeEngine true
- `DwOnly_RequiresRemoteVdeConnection` -- RequiresRemoteVdeConnection true
- `VdeOnly_AcceptsRemoteDwConnections` -- AcceptsRemoteDwConnections true
- `DwPlusVde_NoRemoteConnections` -- neither remote VDE nor accepts DW
- `GetDescription_ReturnsNonEmpty_ForAllValues` -- iterate all enum values
- `InstallConfiguration_DefaultTopology_IsDwPlusVde` -- new InstallConfiguration().Topology == DwPlusVde
- `InstallConfiguration_TopologyCanBeSet` -- set and retrieve each topology value
- `InstallConfiguration_RemoteVdeUrl_DefaultNull` -- new InstallConfiguration().RemoteVdeUrl is null
- `InstallConfiguration_VdeListenPort_Default9443` -- new InstallConfiguration().VdeListenPort == 9443

**Server Commands Tests (5+):**
- `ServerCommands_ShowStatusAsync_NoKernel_ReportsNoServer` -- when no kernel running, should NOT show fake "Running" data
- `ServerCommands_NoTaskDelayStubs` -- use reflection/source analysis to verify no Task.Delay in ServerCommands (or just verify behavior)
- `FindLocalLiveInstanceAsync_NoServer_ReturnsNull` -- async method returns null when no server on test ports
- `FindLocalLiveInstance_SyncWrapper_IsObsolete` -- use reflection to check [Obsolete] attribute on the sync wrapper
- `Program_UsesAsyncFindLocalLiveInstance` -- static analysis or grep to verify no sync call

Use `[Fact]` and `[Theory]` attributes. Use `Assert.Equal`, `Assert.True`, `Assert.Null`.
  </action>
  <verify>Build and run tests: `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter "FullyQualifiedName~DeploymentTopology" --no-restore` -- all pass.</verify>
  <done>15+ deployment topology and server command tests pass; all three topology values tested; server stubs verified removed; async usage verified.</done>
</task>

<task type="auto">
  <name>Task 2: VDE composer and shell registration tests</name>
  <files>DataWarehouse.Tests/Integration/VdeComposerTests.cs, DataWarehouse.Tests/Integration/ShellRegistrationTests.cs</files>
  <action>
**VdeComposerTests.cs (15+):**
- `ParseModules_ValidNames_ReturnsModuleIds` -- "security,tags,replication" parses to 3 ModuleIds
- `ParseModules_CaseInsensitive` -- "Security,TAGS,Replication" works
- `ParseModules_InvalidName_ThrowsOrReturnsError` -- "security,nonexistent" fails gracefully
- `CreateVde_SecurityOnly_HasSecurityModule` -- create with just Security, verify manifest bit 0 set
- `CreateVde_AllModules_HasAll19Active` -- create with all 19 module names
- `CreateVde_EmptyModules_ReturnsError` -- empty string fails
- `CreateVde_CustomProfile_CorrectBlockSize` -- block size 8192 is stored correctly
- `CreateVde_DefaultBlockSize_Is4096` -- default block size
- `CreateVde_ProducesValidFile` -- create file, verify it starts with DWVD magic bytes
- `CreateVde_FileSize_GreaterThanZero` -- output file has content
- `ModuleManifest_FromNames_MatchesFromIds` -- parsing names produces same manifest as FromModules
- `VdeCreationProfile_Custom_HasCorrectType` -- ProfileType == Custom
- `VdeCreationProfile_ModuleConfigLevels_DefaultOne` -- each selected module has config level 1
- `ListModules_Returns19Modules` -- Enum.GetValues<ModuleId>().Length == 19
- `InspectVde_ReadsBackModules` -- create then inspect, modules match

Use temp files via `Path.GetTempFileName()` with `.dwvd` extension. Clean up in Dispose/finally.

**ShellRegistrationTests.cs (8+):**
- `RegisterFileExtensions_ReturnsSuccess` -- call on current OS, verify Success is true (or at least no exception)
- `RegisterFileExtensions_RegistersPrimaryExtension` -- .dwvd in RegisteredExtensions list
- `RegisterFileExtensions_RegistersSecondaryExtensions` -- .dwvd.snap, .dwvd.delta, .dwvd.meta, .dwvd.lock present
- `RegisterFileExtensions_RegistersScriptExtension` -- .dw present
- `RegisterFileExtensions_IsIdempotent` -- call twice, no error
- `UnregisterFileExtensions_DoesNotThrow` -- unregister succeeds without error
- `RegisterFileExtensions_SkipsForDwOnlyTopology_Logic` -- verify DwOnly does not require VDE engine (ensures install command skips registration)
- `RegisterFileExtensions_HandlesInvalidPath_Gracefully` -- non-existent install path produces error result, not exception

Note: Some OS-specific registration tests may need to be conditional via `[SkipOnPlatform]` or `OperatingSystem.IsWindows()` checks, since registry operations only work on Windows, etc. Use `Skip` property on `[Fact]` for cross-platform safety.
  </action>
  <verify>Build and run tests: `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter "FullyQualifiedName~VdeComposer|FullyQualifiedName~ShellRegistration" --no-restore` -- all pass.</verify>
  <done>23+ tests covering VDE composer (module parsing, file creation, inspection) and shell registration (all extensions, idempotency, cross-platform) all pass.</done>
</task>

</tasks>

<verification>
- `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --no-restore` -- all new and existing tests pass
- `dotnet build DataWarehouse.sln` -- zero errors
- Test count: 38+ new tests across 3 files
</verification>

<success_criteria>
- 15+ deployment topology tests pass covering all enum values and descriptor logic
- 5+ server command tests verify no stubs and async usage
- 15+ VDE composer tests verify module parsing, file creation, and inspection
- 8+ shell registration tests verify extension registration across platforms
- All existing tests continue to pass (zero regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/84-deployment-topology-cli-modes/84-06-SUMMARY.md`
</output>
