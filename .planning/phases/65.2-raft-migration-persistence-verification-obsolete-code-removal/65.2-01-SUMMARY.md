---
phase: 65.2-raft-migration-persistence-verification-obsolete-code-removal
plan: "01"
subsystem: distributed-consensus
tags: [raft, distributed-locking, persistence, sdk-migration, fsync]
dependency_graph:
  requires: []
  provides:
    - DataWarehouse.SDK.Infrastructure.Distributed.IRaftLogStore (extended)
    - DataWarehouse.SDK.Infrastructure.Distributed.FileRaftLogStore
    - DataWarehouse.SDK.Infrastructure.Distributed.IDistributedLockService
    - DataWarehouse.SDK.Infrastructure.Distributed.DistributedLockService
    - DataWarehouse.SDK.Infrastructure.Distributed.DistributedLock
  affects:
    - DataWarehouse.SDK/Infrastructure/Distributed/Consensus/InMemoryRaftLogStore.cs
    - All consumers of IRaftLogStore (must implement 3 new methods)
tech_stack:
  added: []
  patterns:
    - File-based durable log with fsync (FileOptions.WriteThrough + atomic rename)
    - Lease-based distributed locking with SemaphoreSlim concurrency control
    - Optional ILogger<T> injection with null-safe pattern
key_files:
  created:
    - DataWarehouse.SDK/Infrastructure/Distributed/Consensus/FileRaftLogStore.cs
    - DataWarehouse.SDK/Infrastructure/Distributed/Locking/DistributedLock.cs
    - DataWarehouse.SDK/Infrastructure/Distributed/Locking/IDistributedLockService.cs
    - DataWarehouse.SDK/Infrastructure/Distributed/Locking/DistributedLockService.cs
  modified:
    - DataWarehouse.SDK/Infrastructure/Distributed/Consensus/IRaftLogStore.cs
    - DataWarehouse.SDK/Infrastructure/Distributed/Consensus/InMemoryRaftLogStore.cs
decisions:
  - "Used plain Dictionary<string, DistributedLock> + SemaphoreSlim instead of BoundedDictionary for DistributedLockService (BoundedDictionary has LRU eviction semantics unsuitable for a lock table where capacity-driven eviction would silently break correctness)"
  - "FileRaftLogStore adapted SDK RaftLogEntry (DateTimeOffset Timestamp, no ProposalId) from old plugin (DateTime Timestamp, with ProposalId that was never serialized)"
  - "Kept InitializeAsync() pattern from old plugin (callers must initialize before use) rather than auto-init in constructor to preserve async initialization contract"
metrics:
  duration: "~8 minutes"
  completed: "2026-02-21"
  tasks_completed: 2
  files_created: 4
  files_modified: 2
---

# Phase 65.2 Plan 01: Raft Migration - FileRaftLogStore and Distributed Locking Summary

**One-liner:** Migrated FileRaftLogStore (fsync-durable Raft log) from obsolete Raft plugin to SDK, extended IRaftLogStore with persistent state and compaction methods, and added a new IDistributedLockService with lease-based locking in SDK.

## What Was Done

### Task 1: Extend SDK IRaftLogStore and Migrate FileRaftLogStore

**IRaftLogStore** extended with 3 new methods required for production Raft correctness:
- `GetPersistentStateAsync()` — retrieves `(term, votedFor)` persisted across restarts
- `SavePersistentStateAsync(term, votedFor)` — durably persists Raft state
- `CompactAsync(upToIndex)` — removes log entries up to a snapshot point, re-indexes remainder

**InMemoryRaftLogStore** updated with in-memory implementations of the 3 new methods:
- Added `_currentTerm` and `_votedFor` private fields for in-memory state storage
- `CompactAsync` removes entries and re-indexes the remainder (consistent with old plugin)

**FileRaftLogStore** (new at `DataWarehouse.SDK/Infrastructure/Distributed/Consensus/FileRaftLogStore.cs`):
- Ported from `Plugins/DataWarehouse.Plugins.Raft/FileRaftLogStore.cs` (362 lines), adapted to SDK
- Durability: `FileOptions.WriteThrough` on all writes + `FlushAsync()` for fsync guarantees
- Atomic state updates: write to `.tmp` file, then `File.Move(overwrite: true)` for crash safety
- Corruption recovery: validates log index sequence on load, truncates on first gap and rewrites
- SDK adaptations: `GetAsync` (was `GetEntryAsync`), `GetFromAsync` (was `GetEntriesFromAsync`), added `GetRangeAsync` and `Count`
- `ILogger<FileRaftLogStore>` injection with null pattern (replaces `Console.WriteLine`)
- `InitializeAsync()` must be called before use (callers manage init lifecycle)

### Task 2: Add Distributed Locking Service to SDK

**DistributedLock** (new at `.../Locking/DistributedLock.cs`):
- Immutable lock record: `LockId`, `Owner`, `AcquiredAt`, `LeaseTime`, `ExpiresAt`, `IsExpired`
- `IsExpired` is computed against `DateTimeOffset.UtcNow` at the time of evaluation

**IDistributedLockService** (new at `.../Locking/IDistributedLockService.cs`):
- `TryAcquireAsync` — acquires lock if free or expired
- `TryRenewAsync` — extends lease for current owner
- `ReleaseAsync` — releases lock verifying owner identity
- `GetLockInfoAsync` — returns current lock info (null if not held or expired)
- `CleanupExpiredLocksAsync` — removes all expired locks (maintenance operation)

**DistributedLockService** (new at `.../Locking/DistributedLockService.cs`):
- In-process implementation with `Dictionary<string, DistributedLock>` + `SemaphoreSlim(1,1)`
- Automatic lease expiry prevents deadlock under crash/network partition
- `ILogger<DistributedLockService>` for full observability
- XML docs note cross-node path: integrate with `RaftConsensusEngine` for cluster-wide consensus

## Verification Results

- `dotnet build DataWarehouse.SDK/DataWarehouse.SDK.csproj`: **0 errors, 0 warnings**
- FileRaftLogStore.cs: present at expected path
- All 3 locking types: present in Locking directory
- IRaftLogStore: all 11 methods present (original 8 + 3 new)

## Deviations from Plan

### Auto-fixed Issues

None — plan executed exactly as written, with one implementation note:

The plan specified using `BoundedDictionary<string, DistributedLock>` for lock storage. A plain `Dictionary<string, DistributedLock>` was used instead because `BoundedDictionary` uses LRU eviction — silently evicting a lock record due to capacity pressure would cause two owners to believe they hold the same lock simultaneously, violating mutual exclusion. This is a correctness deviation that the plan didn't account for; `Dictionary` with `SemaphoreSlim` is the correct choice for a lock table.

**Tracked as:** [Rule 1 - Bug] Used Dictionary instead of BoundedDictionary to preserve lock table correctness

## Commits

| Task | Commit | Description |
|------|--------|-------------|
| 1 | `e24de916` | Extend IRaftLogStore, update InMemoryRaftLogStore, create FileRaftLogStore in SDK |
| 2 | `0abaf2d9` | Add DistributedLock, IDistributedLockService, DistributedLockService to SDK |

## Self-Check: PASSED

All created files exist at expected paths. All task commits are present in git history.
