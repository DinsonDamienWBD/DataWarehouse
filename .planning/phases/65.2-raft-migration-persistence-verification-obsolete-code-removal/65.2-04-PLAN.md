---
phase: 65.2-raft-migration-persistence-verification-obsolete-code-removal
plan: 04
type: execute
wave: 3
depends_on: ["65.2-01", "65.2-03"]
files_modified:
  - DataWarehouse.slnx
  - DataWarehouse.Tests/DataWarehouse.Tests.csproj
  - DataWarehouse.Tests/Plugins/RaftBugFixTests.cs
  - DataWarehouse.Tests/Plugins/PluginSmokeTests.cs
  - DataWarehouse.Tests/Integration/ClusterFormationIntegrationTests.cs
autonomous: true

must_haves:
  truths:
    - "Plugins/DataWarehouse.Plugins.Raft/ directory is completely deleted"
    - "DataWarehouse.slnx no longer references the Raft plugin project"
    - "No test file references DataWarehouse.Plugins.Raft namespace"
    - "dotnet build DataWarehouse.slnx passes with zero warnings"
    - "dotnet test DataWarehouse.Tests passes with no Raft-related failures"
  artifacts:
    - path: "DataWarehouse.slnx"
      provides: "Solution without obsolete Raft plugin"
  key_links:
    - from: "DataWarehouse.Tests/DataWarehouse.Tests.csproj"
      to: "DataWarehouse.slnx"
      via: "no Raft project reference"
      pattern: "(?!.*Plugins\\.Raft)"
---

<objective>
Delete the obsolete Raft plugin entirely and update all test files that reference it.

Purpose: The old Raft plugin (`Plugins/DataWarehouse.Plugins.Raft/`) is marked `[Obsolete("Replaced by UltimateConsensus with Multi-Raft. Remove in v4.0.")]`. With FileRaftLogStore migrated to SDK (Plan 01) and UltimateConsensus rewired to SDK engine (Plan 03), the old plugin has no remaining unique value. Deleting it removes 1,777+ lines of dead code and eliminates the last production `[Obsolete]` attribute.

Output: Raft plugin directory deleted, solution file updated, test files rewritten to use UltimateConsensus or SDK types.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/65.2-raft-migration-persistence-verification-obsolete-code-removal/65.2-01-SUMMARY.md
@.planning/phases/65.2-raft-migration-persistence-verification-obsolete-code-removal/65.2-03-SUMMARY.md
@DataWarehouse.slnx
@DataWarehouse.Tests/DataWarehouse.Tests.csproj
@DataWarehouse.Tests/Plugins/RaftBugFixTests.cs
@DataWarehouse.Tests/Plugins/PluginSmokeTests.cs
@DataWarehouse.Tests/Integration/ClusterFormationIntegrationTests.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete obsolete Raft plugin and remove all references</name>
  <files>
    DataWarehouse.slnx
    DataWarehouse.Tests/DataWarehouse.Tests.csproj
  </files>
  <action>
1. **Delete the entire Raft plugin directory:**
   ```bash
   rm -rf Plugins/DataWarehouse.Plugins.Raft/
   ```
   This removes: RaftConsensusPlugin.cs (1,777 lines), FileRaftLogStore.cs (362 lines), IRaftLogStore.cs (81 lines), DataWarehouse.Plugins.Raft.csproj, bin/, obj/, packages.lock.json.

2. **Update DataWarehouse.slnx:**
   Remove the line: `<Project Path="Plugins/DataWarehouse.Plugins.Raft/DataWarehouse.Plugins.Raft.csproj" />`

3. **Update DataWarehouse.Tests.csproj:**
   Remove the line: `<ProjectReference Include="..\Plugins\DataWarehouse.Plugins.Raft\DataWarehouse.Plugins.Raft.csproj" />`

4. **Verify no other files reference `DataWarehouse.Plugins.Raft`:**
   Search the entire codebase for any remaining `using DataWarehouse.Plugins.Raft` or `DataWarehouse.Plugins.Raft` references. Fix any found.
  </action>
  <verify>
    `ls Plugins/DataWarehouse.Plugins.Raft/ 2>&1` returns "No such file or directory".
    `grep -r "DataWarehouse.Plugins.Raft" DataWarehouse.slnx DataWarehouse.Tests/DataWarehouse.Tests.csproj` returns no matches.
  </verify>
  <done>
    Raft plugin directory deleted. Solution file and test project no longer reference it.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite test files to use SDK and UltimateConsensus types</name>
  <files>
    DataWarehouse.Tests/Plugins/RaftBugFixTests.cs
    DataWarehouse.Tests/Plugins/PluginSmokeTests.cs
    DataWarehouse.Tests/Integration/ClusterFormationIntegrationTests.cs
  </files>
  <action>
1. **DELETE `DataWarehouse.Tests/Plugins/RaftBugFixTests.cs`:**
   This entire file (170+ lines) tests the obsolete RaftConsensusPlugin. The tests cover:
   - FileRaftLogStore initialization, append, retrieve, corruption handling
   - RaftConsensusPlugin catch blocks and exception handling
   These are no longer relevant since:
   - FileRaftLogStore is now in the SDK (tested via SDK tests if needed)
   - RaftConsensusPlugin no longer exists
   Delete the file entirely.

2. **Update `DataWarehouse.Tests/Plugins/PluginSmokeTests.cs`:**
   - Remove the line with `#pragma warning disable CS0618` for RaftConsensusPlugin
   - Remove the test data row: `new object[] { "RaftConsensus", new Func<PluginBase>(() => new DataWarehouse.Plugins.Raft.RaftConsensusPlugin()), "raft" }`
   - Remove any `using DataWarehouse.Plugins.Raft;` statement
   - Do NOT add an UltimateConsensus smoke test row if one already exists (it likely does since UltimateConsensus is a separate plugin). If no UltimateConsensus row exists, add one:
     `new object[] { "UltimateConsensus", new Func<PluginBase>(() => new DataWarehouse.Plugins.UltimateConsensus.UltimateConsensusPlugin()), "consensus" }`

3. **Rewrite `DataWarehouse.Tests/Integration/ClusterFormationIntegrationTests.cs`:**
   This file tests RaftConfiguration from the old plugin. Rewrite ALL tests to use:
   - SDK's `RaftConfiguration` (from `DataWarehouse.SDK.Infrastructure.Distributed` namespace) which has: ElectionTimeoutMinMs, ElectionTimeoutMaxMs, HeartbeatIntervalMs, MaxLogEntries
   - UltimateConsensusPlugin for plugin-level tests

   Specific test rewrites:
   - `RaftConfiguration_Initialization_ShouldBeValid` -> Test SDK RaftConfiguration defaults
   - `RaftCluster_ThreeNodes_ConfigurationsShouldBeValid` -> Test SDK RaftConfiguration for multi-node
   - `RaftConfiguration_ShouldAcceptCustomSettings` -> Test SDK RaftConfiguration custom values
   - `RaftConfiguration_DefaultValues_ShouldBeCorrect` -> Test SDK defaults (150ms/300ms/50ms/10000)
   - `RaftCluster_SingleNode_ConfigurationIsValid` -> Test single-node SDK config
   - `RaftPlugin_Metadata_ShouldIndicateObsoleteStatus` -> REMOVE (no longer obsolete plugin)
   - `RaftConfiguration_DefaultValues_ShouldBeReasonable` -> Merge with defaults test
   - `RaftCluster_FiveNodes_ShouldSurviveTwoFailures` -> Test multi-node config with SDK types

   Remove ALL `using DataWarehouse.Plugins.Raft;` statements.
   Remove ALL `#pragma warning disable CS0618` lines related to Raft.
   Use `using DataWarehouse.SDK.Infrastructure.Distributed;` for SDK types.

4. **Build and run tests:**
   ```bash
   dotnet build DataWarehouse.slnx
   dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter "FullyQualifiedName~ClusterFormation|FullyQualifiedName~PluginSmoke"
   ```
  </action>
  <verify>
    `dotnet build DataWarehouse.slnx` passes with zero errors and zero warnings.
    `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj --filter "FullyQualifiedName~ClusterFormation|FullyQualifiedName~PluginSmoke" --no-build` passes with zero failures.
    `grep -r "DataWarehouse.Plugins.Raft" DataWarehouse.Tests/` returns no matches.
  </verify>
  <done>
    RaftBugFixTests.cs deleted. PluginSmokeTests.cs updated to remove Raft row. ClusterFormationIntegrationTests.cs rewritten to use SDK RaftConfiguration and UltimateConsensus. All tests pass. No references to the deleted Raft plugin remain in test code.
  </done>
</task>

</tasks>

<verification>
- `dotnet build DataWarehouse.slnx` passes with zero errors and zero warnings
- `dotnet test DataWarehouse.Tests/DataWarehouse.Tests.csproj` passes with zero Raft-related failures
- `Plugins/DataWarehouse.Plugins.Raft/` directory does not exist
- `grep -r "DataWarehouse.Plugins.Raft" .` returns no matches (excluding .git and bin/obj)
- No `[Obsolete]` attributes remain in production plugin code
</verification>

<success_criteria>
- Obsolete Raft plugin completely deleted (directory, solution reference, test project reference)
- All 3 test files updated: RaftBugFixTests deleted, PluginSmokeTests cleaned, ClusterFormationTests rewritten
- Full solution builds with zero warnings
- All tests pass
- Zero remaining references to DataWarehouse.Plugins.Raft namespace
</success_criteria>

<output>
After completion, create `.planning/phases/65.2-raft-migration-persistence-verification-obsolete-code-removal/65.2-04-SUMMARY.md`
</output>
