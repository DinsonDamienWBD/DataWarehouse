---
phase: 47
plan: 47-05
title: "Infrastructure Security"
depends_on: []
---

# Plan 47-05: Infrastructure Security

## Goal
Verify infrastructure security against attacks. Test plugin isolation (malicious plugin kernel access), dependency confusion (NuGet substitution), DLL injection/assembly loading attacks, Docker escape (container breakout), K8s RBAC policy, and service account least privilege.

## Approach
1. **Plugin Isolation Verification (Malicious Plugin Kernel Access)**:
   - Create malicious plugin:
     - Attempt to access kernel internals (reflection, private fields)
     - Attempt to access other plugin data (cross-plugin access)
     - Attempt to modify kernel configuration
     - Attempt to load unsigned assembly
   - Load malicious plugin
   - Verify isolation:
     - Reflection blocked (SecurityCritical attributes, AppDomain sandboxing)
     - Cross-plugin access blocked (each plugin has isolated AppDomain or AssemblyLoadContext)
     - Kernel configuration immutable (read-only access)
     - Unsigned assembly loading blocked (strong name verification)
   - Verify plugin permissions:
     - Plugin manifest declares required permissions (filesystem, network, database)
     - User approves permissions on plugin install
     - Plugin cannot exceed declared permissions (runtime enforcement)

2. **Dependency Confusion Verification (NuGet Substitution)**:
   - Attempt to substitute internal package with malicious public package:
     - Create malicious package with same name as internal package (e.g., `DataWarehouse.SDK`)
     - Publish to public NuGet registry
     - Restore packages (`dotnet restore`)
     - Verify internal package used (not public malicious package)
   - Verify NuGet source priority:
     - Internal feed (Azure Artifacts, GitHub Packages) has higher priority than public feed
     - NuGet.config configured correctly
   - Verify package signature validation:
     - Packages signed with company key
     - Unsigned packages rejected
     - Packages signed with untrusted key rejected
   - Verify package hash verification:
     - Package hash stored in lock file (packages.lock.json)
     - Package hash verified on restore
     - Modified package rejected

3. **DLL Injection/Assembly Loading Attack Verification**:
   - Attempt to inject malicious DLL into DataWarehouse process:
     - Use Windows API (LoadLibrary, CreateRemoteThread) → verify blocked by process isolation
     - Use .NET reflection (Assembly.Load) → verify blocked by assembly validation
   - Verify assembly loading restrictions:
     - Only signed assemblies loaded (strong name verification)
     - Only assemblies from trusted locations loaded (application directory, GAC)
     - Assemblies from untrusted locations blocked (Downloads, Temp)
   - Verify code signing:
     - All DataWarehouse assemblies signed with Authenticode certificate
     - Signature verified on load
     - Modified assemblies rejected
   - Verify AppDomain/AssemblyLoadContext isolation:
     - Each plugin loaded in isolated context
     - Plugin cannot load assembly into kernel context

4. **Docker Escape Verification (Container Breakout)**:
   - Deploy DataWarehouse in Docker container
   - Attempt container escape:
     - **Privileged container**: attempt to mount host filesystem (`docker run --privileged`) → verify container not privileged
     - **Shared namespace**: attempt to share PID/NET/IPC namespace with host → verify namespaces isolated
     - **Volume mount**: attempt to mount sensitive host paths (`/etc`, `/root`, `/var/run/docker.sock`) → verify sensitive paths not mounted
     - **Capability**: attempt to use dangerous capabilities (CAP_SYS_ADMIN, CAP_NET_ADMIN) → verify capabilities dropped
   - Verify Docker security best practices:
     - Non-root user (USER directive in Dockerfile)
     - Read-only root filesystem (--read-only)
     - No new privileges (--security-opt=no-new-privileges)
     - AppArmor/SELinux profile applied
     - Resource limits (CPU, memory, PIDs)
   - Attempt kernel exploits (dirty cow, dirty pipe) → verify patched kernel or mitigations applied

5. **K8s RBAC Policy Verification**:
   - Read K8s RBAC manifests (Role, RoleBinding, ClusterRole, ClusterRoleBinding)
   - Verify least privilege:
     - Service account has minimal permissions (list pods, get configmaps, update secrets)
     - No cluster-admin binding
     - No wildcard permissions (`*` verbs, `*` resources)
   - Attempt privilege escalation:
     - Service account attempts to create new Role with elevated permissions → verify rejected (HTTP 403)
     - Service account attempts to bind ClusterRole to self → verify rejected
   - Verify pod security policies:
     - Pods cannot run privileged
     - Pods cannot mount host paths
     - Pods cannot use host network/PID/IPC
     - Pods run as non-root user

6. **Service Account Least Privilege Verification**:
   - Verify service account permissions:
     - **Windows**: service runs as Local Service or Network Service (not SYSTEM unless required)
     - **Linux**: service runs as dedicated user (not root unless required)
   - Verify filesystem permissions:
     - Service account has read/write access only to data directory
     - Service account has read-only access to config directory
     - Service account has no access to other users' directories
   - Verify network permissions:
     - Service account can bind to service ports (>1024)
     - Service account cannot bind to privileged ports (<1024) unless required
   - Verify database permissions:
     - Service account has read/write access to application database
     - Service account has no access to system databases
     - Service account cannot create/drop databases (unless admin)

## Scope
**In Scope:**
- Plugin isolation (malicious plugin kernel access)
- Dependency confusion (NuGet substitution)
- DLL injection/assembly loading attacks
- Docker escape (container breakout)
- K8s RBAC policy
- Service account least privilege

**Out of Scope:**
- OWASP Top 10 (Plan 47-01)
- Cryptographic security (Plan 47-02)
- Network security (Plan 47-03)
- Data security (Plan 47-04)

## Success Criteria
- [ ] Plugin isolation verified (reflection blocked, cross-plugin access blocked, kernel config immutable, unsigned assembly blocked)
- [ ] Plugin permissions verified (declared in manifest, user approval, runtime enforcement)
- [ ] Dependency confusion blocked (internal feed priority, package signature validation, hash verification)
- [ ] DLL injection blocked (LoadLibrary blocked, Assembly.Load blocked, strong name verification)
- [ ] Assembly loading restrictions verified (signed assemblies only, trusted locations only)
- [ ] Code signing verified (Authenticode signature, signature verification)
- [ ] Docker escape blocked (not privileged, namespaces isolated, sensitive paths not mounted, capabilities dropped)
- [ ] Docker security best practices verified (non-root user, read-only rootfs, no new privileges, AppArmor/SELinux, resource limits)
- [ ] K8s RBAC least privilege verified (minimal permissions, no cluster-admin, no wildcards)
- [ ] K8s privilege escalation blocked (cannot create Role, cannot bind ClusterRole)
- [ ] Pod security policies verified (not privileged, no host mounts, no host network, non-root)
- [ ] Service account least privilege verified (Local Service/dedicated user, minimal filesystem/network/database permissions)
- [ ] All findings documented with severity (CRITICAL, HIGH, MEDIUM, LOW)

## Output
- `47-05-infrastructure-security-report.md`: Test results for infrastructure security
  - Plugin isolation verification results
  - Dependency confusion verification results
  - DLL injection/assembly loading verification results
  - Docker escape verification results
  - K8s RBAC policy verification results
  - Service account least privilege verification results
  - All vulnerabilities found with severity and remediation
- Updated `.planning/phases/47-penetration-testing/STATUS.md` with pass/fail results
