---
phase: 47
plan: 47-02
title: "Cryptographic Verification"
depends_on: []
---

# Plan 47-02: Cryptographic Verification

## Goal
Verify cryptographic implementation security including key material lifecycle, NativeKeyHandle memory protection, envelope encryption, FIPS mode compliance, post-quantum cryptography readiness, and CSPRNG (cryptographically secure pseudo-random number generator) usage throughout the system.

## Approach
1. **Key Material Lifecycle**:
   - Key generation: verify keys generated with CSPRNG (not weak RNG)
   - Key storage: verify keys stored in HSM or encrypted with KEK (Key Encryption Key)
   - Key rotation: trigger rotation, verify old key securely deleted (overwritten + metadata cleared)
   - Key expiration: set expiration, verify expired keys rejected
   - Key destruction: delete key, verify unrecoverable (memory wiped, storage overwritten)
2. **NativeKeyHandle Memory Protection**:
   - Memory dump: create heap dump while NativeKeyHandle active, search for plaintext keys
   - Verify keys protected (encrypted or zero-filled)
   - Dispose test: dispose handle, capture heap dump, verify key wiped
   - Leak test: create 1000 handles, dispose all, verify memory released (no leaks)
3. **Envelope Encryption**:
   - Verify DEK (Data Encryption Key) encrypted with KEK before storage
   - Verify KEK stored in HSM or protected storage (not plaintext)
   - Test key unwrap: decrypt DEK with KEK, verify correct key retrieved
   - Test key rotation: rotate KEK, verify all DEKs re-encrypted with new KEK
4. **FIPS Mode Compliance**:
   - Enable FIPS mode: `--preset paranoid --fips`
   - Verify only FIPS-approved algorithms used (AES-256, SHA-256, HMAC-SHA256, RSA-2048+, ECDSA P-256+)
   - Verify non-FIPS algorithms rejected (Blowfish, MD5, SHA1, RC4)
   - Run FIPS self-tests (NIST test vectors)
   - Verify cryptographic module boundary documented
5. **Post-Quantum Cryptography Readiness**:
   - Test hybrid key exchange: classical (ECDH) + post-quantum (Kyber, Dilithium)
   - Verify post-quantum algorithms available (even if not default)
   - Test migration path: encrypt with classical, decrypt with hybrid, verify backward compatibility
6. **CSPRNG Everywhere**:
   - Audit codebase: verify all RNG usage is cryptographically secure (RandomNumberGenerator, not Random)
   - Test entropy: generate 1MB random data, run NIST SP 800-22 statistical tests
   - Verify IV/nonce generation uses CSPRNG
   - Verify salt generation uses CSPRNG
7. **Algorithm Selection**:
   - Encryption: verify AES-256-GCM or ChaCha20-Poly1305 (authenticated encryption)
   - Hashing: verify SHA-256 or SHA-512 (no MD5/SHA1)
   - MAC: verify HMAC-SHA256 or Poly1305
   - Key derivation: verify PBKDF2, Argon2, or HKDF
   - Signing: verify RSA-2048+ or ECDSA P-256+
8. **Side-Channel Resistance**:
   - Timing attack: measure decryption time for correct vs incorrect keys, verify constant-time
   - Padding oracle: attempt padding oracle attack (invalid padding), verify constant error response

## Scope
**In Scope:**
- Key lifecycle: generation, storage, rotation, expiration, destruction
- NativeKeyHandle memory protection
- Envelope encryption (DEK/KEK)
- FIPS 140-2/140-3 compliance
- Post-quantum cryptography
- CSPRNG usage
- Algorithm selection (encryption, hashing, MAC, key derivation, signing)
- Side-channel resistance (timing, padding oracle)

**Out of Scope:**
- OWASP Top 10 (Plan 47-01)
- Network security (Plan 47-03)
- Data security (Plan 47-04)
- Infrastructure security (Plan 47-05)
- Performance testing (Phase 46)

## Success Criteria
- [ ] Keys generated with CSPRNG (verified via code audit)
- [ ] Keys stored encrypted or in HSM (no plaintext keys in storage)
- [ ] Key rotation succeeds, old key overwritten (verified via hex dump)
- [ ] Expired keys rejected (decryption fails with "key expired" error)
- [ ] Key destruction verified: memory dump shows no plaintext keys after deletion
- [ ] NativeKeyHandle memory dump: no plaintext keys found
- [ ] NativeKeyHandle dispose: memory wiped (verified via heap snapshot)
- [ ] Envelope encryption: DEK encrypted with KEK (verified via storage inspection)
- [ ] KEK rotation: all DEKs re-encrypted (verified via audit log)
- [ ] FIPS mode: only approved algorithms used (AES-256, SHA-256, RSA-2048+)
- [ ] Non-FIPS algorithms rejected in FIPS mode (error logged)
- [ ] FIPS self-tests pass (NIST test vectors)
- [ ] Post-quantum algorithms available (Kyber, Dilithium detected in crypto registry)
- [ ] CSPRNG usage verified (code audit: no `new Random()`, only `RandomNumberGenerator`)
- [ ] NIST SP 800-22 randomness tests pass
- [ ] Authenticated encryption used (AES-GCM or ChaCha20-Poly1305)
- [ ] No weak algorithms (MD5, SHA1, RC4) in codebase
- [ ] Constant-time decryption (timing variance <1ms for correct vs incorrect keys)
- [ ] Padding oracle blocked (invalid padding returns generic error)

## Output
- `47-02-crypto-verification-report.md`: Test results for all cryptographic controls
- `47-02-fips-compliance.txt`: FIPS mode validation and self-test results
- `47-02-memory-dumps/`: Heap dumps (before/after NativeKeyHandle disposal)
- `47-02-randomness-tests.json`: NIST SP 800-22 statistical test results
- Updated `.planning/phases/47-penetration-testing/STATUS.md` with pass/fail results
