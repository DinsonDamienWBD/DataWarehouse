---
phase: 47-penetration-testing
plan: 47-v4.5-01
title: "Attack Surface Mapping & Reconnaissance"
type: execute
wave: 1
depends_on: []
files_modified: [".planning/phases/47-penetration-testing/47-v4.5-01-RECON-REPORT.md"]
autonomous: true
must_haves:
  truths:
    - "Every entry point (API, CLI, message bus topic, plugin interface, network listener) is enumerated"
    - "Every trust boundary is identified with crossing analysis"
    - "Every deserialization point is cataloged with input source classification"
    - "Data flow maps exist for sensitive material (keys, credentials, PII, tokens)"
  artifacts:
    - path: ".planning/phases/47-penetration-testing/47-v4.5-01-RECON-REPORT.md"
      provides: "Complete attack surface map and recon report"
  key_links:
    - from: "recon report"
      to: "all subsequent attack plans"
      via: "entry point catalog feeds targeting decisions"
      pattern: "entry_points|trust_boundaries|data_flows"
---

# Plan 47-v4.5-01: Attack Surface Mapping & Reconnaissance

<objective>
Map the COMPLETE attack surface of DataWarehouse like a red team operator performing initial reconnaissance. Enumerate every entry point, trust boundary, data flow, deserialization sink, and privilege transition. This is the intelligence-gathering phase that feeds all subsequent attack plans.

Purpose: You cannot attack what you cannot see. Previous pentests (v4.3) missed entire attack surfaces (Launcher API was unprotected for months). Systematic recon prevents blind spots.
Output: Comprehensive attack surface map with prioritized target list for Plans 02-07.
</objective>

<execution_context>
@C:/Users/ddamien/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ddamien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/PLUGIN-CATALOG.md
@.planning/phases/47-penetration-testing/47-CONTEXT.md
@.planning/phases/47-penetration-testing/47-COMBINED-SUMMARY.md
@.planning/phases/47-security-pentest/v4.3-SECURITY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Entry Point & Trust Boundary Enumeration</name>
  <files>.planning/phases/47-penetration-testing/47-v4.5-01-RECON-REPORT.md</files>
  <action>
Perform systematic reconnaissance across the entire codebase. Think like an attacker doing external recon followed by white-box source access.

**Phase A: Network-Facing Entry Points**
Scan for ALL network listeners and API surfaces:
- HTTP/HTTPS endpoints: Search for `MapGet`, `MapPost`, `Map`, `UseEndpoints`, `app.Run`, `HttpListener`, `WebApplication` across ALL projects (not just Dashboard/Launcher)
- gRPC services: Search for `ServerServiceDefinition`, `GrpcService`, proto service definitions
- WebSocket listeners: Search for `WebSocket`, `AcceptWebSocketAsync`, MQTT broker endpoints
- QUIC/UDP listeners: Search for `QuicListener`, `UdpClient.Receive`, CoAP endpoints
- Raw TCP: Search for `TcpListener`, `Socket.Bind`, `Socket.Listen`
- Named pipes / Unix sockets: Search for `NamedPipeServerStream`, `UnixDomainSocketEndPoint`
- For EACH: record the binding address, port, authentication requirement, and what data it accepts

**Phase B: Message Bus Attack Surface**
Map the internal message bus as an attacker who has gained plugin-level access:
- Enumerate ALL message bus topics: Search for `Publish`, `Subscribe`, `Send`, `Handle` on IMessageBus
- Identify topics that carry sensitive data (keys, credentials, commands)
- Identify topics that trigger privileged operations (write, delete, admin)
- Map which plugins subscribe to which topics (producer/consumer graph)
- Identify if ANY topic lacks CommandIdentity validation

**Phase C: Trust Boundary Analysis**
Identify every place where trust level changes:
- Plugin boundary: Where does the kernel trust plugin input?
- User input boundaries: Where does external input first enter the system?
- Inter-node boundaries: Where does data from remote nodes enter?
- AI provider boundaries: Where do AI model responses enter the system?
- Configuration boundaries: Where do config values influence security decisions?
- Assembly loading boundaries: Where are DLLs loaded from disk?
- For EACH: classify as "validated", "partially validated", or "unvalidated"

**Phase D: Deserialization Sink Catalog**
Enumerate every deserialization point as these are prime RCE targets:
- JSON deserialization: `JsonSerializer.Deserialize`, `JsonConvert.DeserializeObject` -- what types? Is type discrimination used?
- Protobuf/MessagePack/binary: Any custom serialization?
- XML parsing: `XDocument.Load`, `XmlDocument.LoadXml`, `XmlReader` -- are settings hardened?
- For EACH: record input source (network, disk, config, user) and whether type validation exists

**Phase E: Sensitive Data Flow Mapping**
Trace how sensitive material moves through the system:
- Cryptographic keys: From generation (KeyManagement) through storage to use -- where are they in plaintext?
- User credentials: From input through hashing to storage -- where could they leak?
- API tokens: Where stored, how transmitted, how validated?
- Encryption at rest: Which paths write plaintext to disk before encrypting?
- Log sanitization: Do logs ever contain sensitive values? Search for `_logger.Log` near key/password/token variables
  </action>
  <verify>
The recon report must contain:
1. A numbered list of ALL network-facing entry points (expect 20+)
2. A message bus topic graph showing producer/consumer relationships
3. A trust boundary diagram (text-based) with validation status
4. A deserialization sink table with input source and hardening status
5. A sensitive data flow map for keys, credentials, and tokens
Run `grep -c "Entry Point\|Trust Boundary\|Deserialization\|Data Flow" .planning/phases/47-penetration-testing/47-v4.5-01-RECON-REPORT.md` to confirm all sections present
  </verify>
  <done>Complete attack surface map with 20+ entry points enumerated, all trust boundaries classified, all deserialization sinks cataloged, and sensitive data flows traced. Prioritized target list for subsequent plans.</done>
</task>

<task type="auto">
  <name>Task 2: v4.3/v4.4 Fix Regression Verification</name>
  <files>.planning/phases/47-penetration-testing/47-v4.5-01-RECON-REPORT.md</files>
  <action>
Re-verify ALL findings from the v4.3 pentest (47-COMBINED-SUMMARY.md) and v4.4 fixes. An attacker always checks if "fixed" vulnerabilities were actually fixed or just patched superficially.

**For each v4.3 finding, verify:**

CRIT-01 (TLS bypass in 15 files):
- v4.4 claimed to fix 13 of 15. Verify EACH of the 13 files now has proper validation.
- v4.5 scan found 1 remaining (GrpcStorageStrategy). Verify the other 2 (QuicDataPlane, AdaptiveTransport) are genuinely fixed.
- Search for ANY new TLS bypass introduced since v4.4: `grep -r "=> true" --include="*.cs" | grep -i "certificate\|cert\|ssl\|tls"`
- Check if fixes use the DashboardStrategyBase pattern (configurable VerifySsl) or something weaker

HIGH-01/02 (XXE):
- Verify XmlDocumentRegenerationStrategy now uses DtdProcessing.Prohibit
- Verify SamlStrategy now uses XmlResolver = null
- Search for ANY new XML parsing without DtdProcessing.Prohibit

HIGH-03 (Unauthenticated Launcher API):
- Check if authentication was added to /api/v1/execute, /api/v1/message, /api/v1/info, /api/v1/capabilities
- If auth added, test for bypass: Can the auth be skipped with malformed headers?

HIGH-04 (SHA256 password hashing):
- Verify DataWarehouseHost password hashing upgraded from SHA256
- Check what algorithm is used now -- is it PBKDF2/Argon2id or still weak?

HIGH-05 (Default admin password):
- Verify "admin" default is removed
- Check: Is there a new default? Does null/empty bypass validation?

MEDIUM/LOW findings: Spot-check 3-4 of the original findings.

**ALSO: Search for NEW instances of old patterns:**
- New TLS bypasses introduced in v4.4/v4.5 code
- New hardcoded credentials
- New XML parsing without protection
- New Process.Start with user-influenced arguments
  </action>
  <verify>
For each v4.3 finding, the report must state: VERIFIED FIXED, PARTIALLY FIXED (with details), or STILL VULNERABLE.
At minimum: 3 CRITICAL, 5 HIGH, 3 MEDIUM findings re-verified.
  </verify>
  <done>All v4.3 findings re-verified with evidence. Any regressions or partial fixes documented with exact file:line references. New instances of old vulnerability patterns identified.</done>
</task>

</tasks>

<verification>
- Recon report exists and contains all 5 sections (entry points, bus topics, trust boundaries, deserialization, data flows)
- All v4.3 findings have verification status (fixed/partial/vulnerable)
- Report includes prioritized target list for subsequent plans
</verification>

<success_criteria>
- 20+ entry points enumerated with authentication status
- All 27 v4.3 findings re-verified
- Zero blind spots in attack surface coverage
- Prioritized target list ready for Plans 02-07
</success_criteria>

<output>
After completion, create `.planning/phases/47-penetration-testing/47-v4.5-01-SUMMARY.md`
</output>
