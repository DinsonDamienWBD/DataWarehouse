# v4.5-07: Supply Chain & Infrastructure Attack Findings

**Date:** 2026-02-19
**Tester:** Ethical Hacker (Automated Red Team)
**Scope:** NuGet supply chain, DLL hijacking, configuration injection, build pipeline, monitoring gaps
**Methodology:** Package vulnerability scanning, assembly loading path analysis, configuration trust boundary mapping, audit coverage gap analysis

---

## Executive Summary

The DataWarehouse supply chain and infrastructure attack surface is **well-defended** in the dependency management domain (zero known vulnerabilities, all lock files committed), but has **significant weaknesses** in assembly loading (kernel bypasses PluginLoader), configuration injection (security-sensitive settings controllable via environment variables), and monitoring blind spots (audit trail not wired to kernel operations). The most impactful finding is that **configuration injection via environment variables can disable TLS verification, enable admin account creation, and bypass rate limiting** -- all without any audit trail.

**Findings by Severity:**
- HIGH: 1 (INFRA-01)
- MEDIUM: 3 (INFRA-02, INFRA-03, INFRA-04)
- LOW: 1 (INFRA-05)
- INFO: 1 (INFRA-06)

---

## Attack 1: NuGet Dependency Audit

### Result: CLEAN

`dotnet list package --vulnerable` across all 72 projects returned **zero vulnerable packages**. This confirms v4.3 INFO-05 still holds true.

All packages are from the official NuGet.org feed (`https://api.nuget.org/v3/index.json`) and the local Microsoft SDK fallback (`C:\Program Files (x86)\Microsoft SDKs\NuGetPackages\`). No custom or private feeds are configured.

**Positive findings:**
- All 72 projects have `packages.lock.json` committed -- builds are deterministic
- No custom NuGet feeds configured (no MITM opportunity on private feeds)
- All packages are well-known, widely-used .NET ecosystem packages

---

## Attack 2: Typosquatting & Dependency Confusion

### Result: LOW RISK

**Package name analysis:** All referenced packages are mainstream .NET ecosystem packages (Microsoft.*, System.*, Grpc.*, BouncyCastle, SharpCompress, etc.). No obscure or similarly-named packages that could indicate typosquatting were found.

**Dependency confusion risk:** The project uses ONLY the public NuGet.org feed. There are no internal/private package names that could be registered on nuget.org by an attacker (dependency confusion attack). The package namespace `DataWarehouse.*` is used only as project references, never as NuGet packages.

**Lock file coverage:** All 72 projects have `packages.lock.json` files committed. This provides:
- Deterministic builds (exact versions pinned)
- Protection against phantom dependency updates
- Detection of supply chain tampering (lock file hash changes visible in PR review)

**No nuget.config found in repository root.** This means the project relies on machine-level NuGet configuration. In a CI/CD environment, this could lead to inconsistent package resolution if the build machine has additional feeds configured. However, this is an operational concern, not a vulnerability.

---

## Attack 3: DLL Hijacking / Assembly Loading Attacks

### INFRA-01: Kernel Assembly Loading Bypasses All Security Validation (HIGH)

**CVSS 3.1:** 7.2 (AV:L/AC:L/PR:H/UI:N/S:C/C:H/I:H/A:H)
**CWE:** CWE-426 (Untrusted Search Path), CWE-829 (Inclusion of Functionality from Untrusted Control Sphere)

This is a consolidation of FINDING-04 (Recon) and ISO-02 (Bus/Plugin), confirming the DLL hijacking vector with additional assembly search path analysis.

**Two distinct loading paths exist:**

| Path | Security | Usage |
|------|----------|-------|
| `PluginLoader` (SDK) | Hash verification, signature check, size limits, blocklist, collectible AssemblyLoadContext | Available but NOT used by kernel |
| `DataWarehouseKernel.LoadPluginsFromAssemblyAsync` | `Assembly.LoadFrom()` with ZERO validation | Used for ALL kernel plugin loading |

**Assembly search order for `Assembly.LoadFrom`:**
1. The exact path provided (the `assemblyPath` parameter)
2. If the assembly has dependencies, .NET probes: application base directory, `deps.json` entries, runtime package store

**DLL hijacking scenario:**
1. Attacker places a malicious DLL at the expected plugin path (e.g., `Plugins/DataWarehouse.Plugins.UltimateStorage/DataWarehouse.Plugins.UltimateStorage.dll`)
2. The kernel loads it via `Assembly.LoadFrom(assemblyPath)` with no hash/signature check
3. The malicious DLL's `IPlugin` implementation runs with full kernel trust
4. All kernel services (message bus, capability registry, storage) are accessible

**Dashboard PluginDiscoveryService:** Reads the `PluginsDirectory` configuration value (default: `{AppContext.BaseDirectory}/Plugins`) and scans for assemblies. This path is configurable via `IConfiguration`, meaning environment variables or config files can redirect it to an attacker-controlled directory.

**Impact:** Arbitrary code execution in the kernel process. Combined with the message bus having no access enforcement (AUTH-01), the malicious plugin has full system access.

---

## Attack 4: Configuration Injection

### INFRA-02: Environment Variable Configuration Injection (MEDIUM)

**CVSS 3.1:** 6.5 (AV:L/AC:L/PR:H/UI:N/S:C/C:H/I:H/A:N)
**CWE:** CWE-15 (External Control of System or Configuration Setting)

ASP.NET Core reads configuration from (in priority order):
1. Command-line arguments (highest priority)
2. Environment variables (prefixed with `ASPNETCORE_` or `DOTNET_`, or hierarchical with `__` separator)
3. `appsettings.{Environment}.json`
4. `appsettings.json`
5. User secrets (development only)

**Security-sensitive configuration values that can be injected via environment variables:**

| Setting | Impact if Injected | Evidence |
|---------|-------------------|----------|
| `VerifySsl` / `VerifySslCertificates` | Disables TLS certificate validation on 18 strategies | All configurable bypasses read from config |
| `AdminPassword` | Sets admin password (if `CreateDefaultAdmin` is true) | `DataWarehouseHost.cs:448-449` |
| `CreateDefaultAdmin` | Enables default admin user creation | `DataWarehouseHost.cs:448` |
| `JwtOptions:SecretKey` | Controls JWT signing key | `Program.cs:29-34` |
| `PluginsDirectory` | Redirects plugin loading to arbitrary directory | `PluginDiscoveryService.cs:180-181` |
| `ASPNETCORE_ENVIRONMENT` | If set to "Development", enables hardcoded JWT secret | `Program.cs:29` |
| `Logging:LogLevel:Default` | Can suppress security logging | Standard ASP.NET Core |

**Attack scenario (container escape):**
1. Attacker gains access to container orchestration (Kubernetes, Docker Compose)
2. Injects `VerifySslCertificates=false` as environment variable
3. All TLS validation disabled across 18 strategies
4. MITM all external connections

**Attack scenario (shared hosting):**
1. Attacker on shared host sets `ASPNETCORE_ENVIRONMENT=Development`
2. Dashboard uses hardcoded JWT secret key
3. Attacker forges admin JWT tokens
4. Full admin access to Dashboard

**Mitigating factors:**
- Requires local/container access to set environment variables
- `AdminPassword` validation throws on empty (cannot create admin with empty password)
- JWT secret validation throws in non-Development mode if unconfigured

---

### INFRA-03: ConfigurationAuditLog Not Wired to Kernel (MEDIUM)

**CVSS 3.1:** 5.3 (AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:H/A:N)
**CWE:** CWE-778 (Insufficient Logging)

The `ConfigurationAuditLog` class exists and provides append-only logging of configuration changes (who, what, when, old/new values). However, it is **not wired** to the kernel's configuration loading path or to the `ConfigurationChangeApi`. The audit log is a standalone utility that must be explicitly instantiated and called.

**Evidence:**
- `ConfigurationAuditLog` defined in `SDK/Primitives/Configuration/ConfigurationAuditLog.cs`
- `ConfigurationChangeApi` exists in `SDK/Primitives/Configuration/ConfigurationChangeApi.cs`
- No grep results show the kernel or any plugin instantiating `ConfigurationAuditLog` in production code paths

**Impact:** Configuration changes (including security-sensitive ones like TLS bypass, admin creation) are not audited. An attacker who modifies configuration leaves no trail.

---

### INFRA-04: Audit Trail File Not Tamper-Protected (MEDIUM)

**CVSS 3.1:** 4.7 (AV:L/AC:H/PR:L/UI:N/S:U/C:N/I:H/A:N)
**CWE:** CWE-117 (Improper Output Neutralization for Logs)

The `ConfigurationAuditLog` writes to a plain text file using `File.AppendAllText`. The audit entries are:
- Not hash-chained (each entry independent, can be selectively deleted)
- Not signed (integrity not verifiable)
- Not encrypted (confidentiality not protected)
- Written without restrictive file permissions (any process user can modify)

The `IAuditTrail` interface (SDK) and `AuditTrailService` (TamperProof plugin) exist and provide a more robust audit mechanism with immutability guarantees, but these are plugin-level, not kernel-level.

**Impact:** An attacker who gains filesystem access can tamper with audit logs to cover their tracks.

---

## Attack 5: Build & Deployment Pipeline

### INFRA-05: No MSBuild Target Injection Found (LOW)

**CVSS 3.1:** 2.0 (Informational)

**Build pipeline analysis:**
- All 72 `.csproj` files contain only `<TargetFramework>` declarations (no `<Target>`, `<Exec>`, or remote `<Import>` elements)
- No post-build scripts found that execute with elevated privileges
- No MSBuild imports from network paths
- No CI/CD pipeline configuration files found in the repository (`.github/workflows/`, `.gitlab-ci.yml`, `azure-pipelines.yml`, `Jenkinsfile`)
- No `Directory.Build.props` or `Directory.Build.targets` files found that could inject build-time code

**Assessment:** The build pipeline is clean. However, the absence of CI/CD configuration means builds are not reproducible and there is no automated security scanning in the pipeline.

---

## Attack 6: Logging & Monitoring Blind Spots

### INFRA-06: Monitoring Blind Spot Inventory (INFO)

**Operations that do NOT generate audit logs:**

| Operation | Risk | Why No Audit |
|-----------|------|-------------|
| Plugin loading/unloading via kernel | HIGH | Kernel uses `Assembly.LoadFrom` directly, no audit hook |
| Message bus publish/subscribe | HIGH | DefaultMessageBus has no logging interceptor for message content |
| Configuration changes via env vars | HIGH | Environment variables bypass all config change logging |
| Raft consensus operations | MEDIUM | No audit log for leader elections, log commits, membership changes |
| CRDT replication merges | MEDIUM | Silent merge with no audit trail of data changes |
| SWIM membership changes | MEDIUM | Node join/leave/dead events not audit-logged |
| Federation heartbeat updates | MEDIUM | Topology changes not audit-logged |
| Plugin marketplace install/update | HIGH | No audit trail for plugin lifecycle operations |
| Key rotation operations | MEDIUM | `KeyRotationScheduler` logs to ILogger but not to audit trail |

**Audit coverage gap analysis:**

The `IAuditTrail` interface is comprehensive but is only implemented in:
1. `InMemoryAuditTrail` (SDK) -- volatile, lost on restart
2. `AuditTrailService` (TamperProof plugin) -- persistent but optional

The kernel does NOT have an `IAuditTrail` instance. Plugins that want audit logging must implement it themselves or use the TamperProof plugin's service via message bus.

**Can an attacker disable logging?** Yes:
1. Environment variable injection: Set `Logging:LogLevel:Default=None` to suppress all logging
2. Configuration injection: Modify logging configuration in `appsettings.json`
3. Plugin unloading: If TamperProof plugin is unloaded, audit trail service is gone
4. File deletion: Audit log files have no integrity protection

**Impact:** An attacker who gains system access can operate without detection by suppressing logging, modifying audit files, or exploiting the many operations that have no audit coverage.

---

## Summary Table

| ID | Finding | CVSS | Severity | Status |
|----|---------|------|----------|--------|
| INFRA-01 | Kernel assembly loading bypasses PluginLoader | 7.2 | HIGH | Confirmed (consolidates FINDING-04, ISO-02) |
| INFRA-02 | Environment variable configuration injection | 6.5 | MEDIUM | Confirmed |
| INFRA-03 | ConfigurationAuditLog not wired to kernel | 5.3 | MEDIUM | Confirmed |
| INFRA-04 | Audit trail file not tamper-protected | 4.7 | MEDIUM | Confirmed |
| INFRA-05 | No MSBuild injection vectors found | 2.0 | LOW | Clean |
| INFRA-06 | Monitoring blind spots inventory | N/A | INFO | Documented |

### Supply Chain Positive Findings

1. **Zero known vulnerable NuGet packages** across all 72 projects
2. **All 72 projects have packages.lock.json** committed -- deterministic builds
3. **No typosquatting risk** -- all packages are well-known mainstream libraries
4. **No dependency confusion risk** -- only public NuGet.org feed used
5. **No MSBuild injection vectors** -- clean .csproj files, no remote imports
6. **No custom NuGet feeds** that could be MITM'd
