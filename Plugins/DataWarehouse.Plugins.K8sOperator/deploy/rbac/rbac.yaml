---
# ServiceAccount for the DataWarehouse Operator
apiVersion: v1
kind: ServiceAccount
metadata:
  name: datawarehouse-operator
  namespace: datawarehouse-system
  labels:
    app.kubernetes.io/name: datawarehouse-operator
    app.kubernetes.io/component: operator
---
# ClusterRole with permissions for the operator
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: datawarehouse-operator-role
  labels:
    app.kubernetes.io/name: datawarehouse-operator
rules:
  # Core API resources
  - apiGroups: [""]
    resources:
      - pods
      - pods/log
      - pods/exec
      - services
      - services/finalizers
      - endpoints
      - persistentvolumeclaims
      - events
      - configmaps
      - secrets
      - serviceaccounts
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: [""]
    resources:
      - persistentvolumes
      - nodes
      - namespaces
    verbs: ["get", "list", "watch"]
  # Apps API resources
  - apiGroups: ["apps"]
    resources:
      - deployments
      - daemonsets
      - replicasets
      - statefulsets
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Batch API resources
  - apiGroups: ["batch"]
    resources:
      - jobs
      - cronjobs
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # RBAC resources
  - apiGroups: ["rbac.authorization.k8s.io"]
    resources:
      - roles
      - rolebindings
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Policy resources
  - apiGroups: ["policy"]
    resources:
      - poddisruptionbudgets
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Autoscaling resources
  - apiGroups: ["autoscaling"]
    resources:
      - horizontalpodautoscalers
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: ["autoscaling.k8s.io"]
    resources:
      - verticalpodautoscalers
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Storage resources
  - apiGroups: ["storage.k8s.io"]
    resources:
      - storageclasses
    verbs: ["get", "list", "watch"]
  # Networking resources
  - apiGroups: ["networking.k8s.io"]
    resources:
      - networkpolicies
      - ingresses
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Custom resources - DataWarehouse
  - apiGroups: ["datawarehouse.io"]
    resources:
      - datawarehouseclusters
      - datawarehouseclusters/status
      - datawarehouseclusters/finalizers
      - datawarehouseclusters/scale
      - datawarehousebackups
      - datawarehousebackups/status
      - datawarehousebackups/finalizers
      - datawarehousestorages
      - datawarehousestorages/status
      - datawarehousestorages/finalizers
      - datawarehousereplications
      - datawarehousereplications/status
      - datawarehousereplications/finalizers
      - datawarehousetenants
      - datawarehousetenants/status
      - datawarehousetenants/finalizers
      - datawarehousepolicies
      - datawarehousepolicies/status
      - datawarehousepolicies/finalizers
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Monitoring - Prometheus Operator
  - apiGroups: ["monitoring.coreos.com"]
    resources:
      - servicemonitors
      - podmonitors
      - prometheusrules
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Cert-manager
  - apiGroups: ["cert-manager.io"]
    resources:
      - certificates
      - certificaterequests
      - issuers
      - clusterissuers
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Velero for backups
  - apiGroups: ["velero.io"]
    resources:
      - backups
      - schedules
      - restores
      - backupstoragelocations
      - volumesnapshotlocations
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # KEDA for autoscaling
  - apiGroups: ["keda.sh"]
    resources:
      - scaledobjects
      - scaledjobs
      - triggerauthentications
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Istio for traffic management
  - apiGroups: ["networking.istio.io"]
    resources:
      - virtualservices
      - destinationrules
      - gateways
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Leader election
  - apiGroups: ["coordination.k8s.io"]
    resources:
      - leases
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Admission webhooks
  - apiGroups: ["admissionregistration.k8s.io"]
    resources:
      - mutatingwebhookconfigurations
      - validatingwebhookconfigurations
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
---
# ClusterRoleBinding to bind the role to the service account
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: datawarehouse-operator-rolebinding
  labels:
    app.kubernetes.io/name: datawarehouse-operator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: datawarehouse-operator-role
subjects:
  - kind: ServiceAccount
    name: datawarehouse-operator
    namespace: datawarehouse-system
---
# Role for leader election in operator namespace
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: datawarehouse-operator-leader-election
  namespace: datawarehouse-system
  labels:
    app.kubernetes.io/name: datawarehouse-operator
rules:
  - apiGroups: [""]
    resources:
      - configmaps
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: ["coordination.k8s.io"]
    resources:
      - leases
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: [""]
    resources:
      - events
    verbs: ["create", "patch"]
---
# RoleBinding for leader election
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: datawarehouse-operator-leader-election
  namespace: datawarehouse-system
  labels:
    app.kubernetes.io/name: datawarehouse-operator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: datawarehouse-operator-leader-election
subjects:
  - kind: ServiceAccount
    name: datawarehouse-operator
    namespace: datawarehouse-system
