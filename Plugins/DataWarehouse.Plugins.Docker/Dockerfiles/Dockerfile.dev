# DataWarehouse Development Image
# datawarehouse/core:dev
#
# Full-featured development image with debugging tools and utilities.
# Includes SDK for building and testing.
# NOT recommended for production use.
#
# Features:
# - Full .NET 10 SDK
# - Debug symbols and tools
# - Shell access with useful utilities
# - Hot reload support
# - Visual Studio remote debugging support
# - Performance profiling tools

ARG DOTNET_VERSION=10.0
FROM mcr.microsoft.com/dotnet/sdk:${DOTNET_VERSION} AS base

# Labels for OCI compliance
LABEL org.opencontainers.image.title="DataWarehouse Development"
LABEL org.opencontainers.image.description="Development image with debugging tools for DataWarehouse"
LABEL org.opencontainers.image.vendor="DataWarehouse"
LABEL org.opencontainers.image.source="https://github.com/datawarehouse/datawarehouse"
LABEL org.opencontainers.image.licenses="MIT"

# Install development dependencies and debugging tools
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    wget \
    ca-certificates \
    tzdata \
    libicu-dev \
    vim \
    nano \
    htop \
    procps \
    net-tools \
    iputils-ping \
    dnsutils \
    strace \
    gdb \
    lsof \
    git \
    jq \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Install .NET diagnostic tools
RUN dotnet tool install --global dotnet-counters \
    && dotnet tool install --global dotnet-dump \
    && dotnet tool install --global dotnet-trace \
    && dotnet tool install --global dotnet-monitor

# Add tools to PATH
ENV PATH="${PATH}:/root/.dotnet/tools"

# Create directories
RUN mkdir -p /app /data /logs /config /src /tests

# Set working directory
WORKDIR /app

# Copy source code for development
COPY . /src/

# Environment configuration for development
ENV DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=false \
    DOTNET_RUNNING_IN_CONTAINER=true \
    DOTNET_USE_POLLING_FILE_WATCHER=true \
    DOTNET_WATCH_RESTART_ON_RUDE_EDIT=true \
    ASPNETCORE_URLS=http://+:8080 \
    ASPNETCORE_ENVIRONMENT=Development \
    DATAWAREHOUSE_DATA_PATH=/data \
    DATAWAREHOUSE_LOG_PATH=/logs \
    DATAWAREHOUSE_CONFIG_PATH=/config \
    DATAWAREHOUSE_DEBUG=true \
    TZ=UTC

# Enable remote debugging
ENV VSDBG_DOWNLOAD_URL=https://aka.ms/getvsdbgsh
RUN curl -sSL $VSDBG_DOWNLOAD_URL | bash /dev/stdin -v latest -l /vsdbg

# Health check (more lenient for development)
HEALTHCHECK --interval=60s --timeout=30s --start-period=120s --retries=5 \
    CMD curl -f http://localhost:8080/health || exit 1

# Volume mounts
VOLUME ["/data", "/logs", "/config", "/src", "/tests"]

# Expose ports
# 8080 - HTTP API
# 5432 - PostgreSQL wire protocol
# 9876 - Docker plugin API
# 4024 - Remote debugger
EXPOSE 8080 5432 9876 4024

# Run as root for development flexibility
# (allows installing additional packages, debugging, etc.)

# Graceful shutdown handling
STOPSIGNAL SIGTERM

# Entry point for development with hot reload
ENTRYPOINT ["dotnet", "watch", "--project", "/src/DataWarehouse.Kernel"]

# Default command
CMD ["run", "--", "--config", "/config/datawarehouse.dev.json"]
