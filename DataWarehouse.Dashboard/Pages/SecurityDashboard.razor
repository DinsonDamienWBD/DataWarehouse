@page "/security-dashboard"
@using DataWarehouse.Dashboard.Services
@inject DashboardApiClient ApiClient
@inject ILogger<SecurityDashboard> Logger
@implements IDisposable

<PageTitle>Security Dashboard - DataWarehouse</PageTitle>

@if (_error != null)
{
    <div class="alert alert-warning d-flex align-items-center" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <div>@_error</div>
    </div>
}

@if (_loading && _posture == null)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="text-muted mt-2">Loading security data...</p>
    </div>
}
else
{
    <!-- Security Score & Summary -->
    <div class="row g-4 mb-4">
        <!-- Score -->
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-3">Security Score</h6>
                    <div class="position-relative d-inline-block">
                        <div class="rounded-circle d-flex align-items-center justify-content-center"
                             style="width: 120px; height: 120px; border: 6px solid @GetScoreColor(_posture?.Score ?? 0); margin: 0 auto;">
                            <div>
                                <div class="h2 mb-0 fw-bold">@(_posture?.Score ?? 0)</div>
                                <small class="text-muted">/ @(_posture?.MaxScore ?? 100)</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vulnerability Findings -->
        <div class="col-xl-5 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-3">Vulnerability Findings</h6>
                    <div class="row g-2">
                        <div class="col-3 text-center">
                            <div class="border border-danger rounded p-2">
                                <div class="h4 mb-0 text-danger">@(_posture?.CriticalFindings ?? 0)</div>
                                <small class="text-muted">Critical</small>
                            </div>
                        </div>
                        <div class="col-3 text-center">
                            <div class="border border-warning rounded p-2">
                                <div class="h4 mb-0 text-warning">@(_posture?.HighFindings ?? 0)</div>
                                <small class="text-muted">High</small>
                            </div>
                        </div>
                        <div class="col-3 text-center">
                            <div class="border border-info rounded p-2">
                                <div class="h4 mb-0 text-info">@(_posture?.MediumFindings ?? 0)</div>
                                <small class="text-muted">Medium</small>
                            </div>
                        </div>
                        <div class="col-3 text-center">
                            <div class="border rounded p-2">
                                <div class="h4 mb-0 text-secondary">@(_posture?.LowFindings ?? 0)</div>
                                <small class="text-muted">Low</small>
                            </div>
                        </div>
                    </div>
                    <div class="text-muted small mt-2 text-center">
                        Last scan: @FormatTimeAgo(_posture?.LastScanTime ?? default)
                    </div>
                </div>
            </div>
        </div>

        <!-- Access Control -->
        <div class="col-xl-4 col-md-12">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-3">Access Control</h6>
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="border rounded p-3 text-center">
                                <div class="h3 mb-0">@(_posture?.ActiveSessions ?? 0)</div>
                                <small class="text-muted">Active Sessions</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border rounded p-3 text-center">
                                <div class="h3 mb-0 @(_posture?.FailedAuthAttemptsLastHour > 10 ? "text-danger" : "")">
                                    @(_posture?.FailedAuthAttemptsLastHour ?? 0)
                                </div>
                                <small class="text-muted">Failed Auth (1h)</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Security Events & SIEM Status -->
    <div class="row g-4 mb-4">
        <!-- Recent Security Events -->
        <div class="col-xl-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-shield-exclamation me-2"></i>Recent Security Events</h5>
                    <span class="badge bg-primary">@_events.Count events</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-hover table-sm mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="width: 140px;">Timestamp</th>
                                    <th style="width: 80px;">Severity</th>
                                    <th>Source</th>
                                    <th>Description</th>
                                    <th>Category</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var evt in _events)
                                {
                                    <tr>
                                        <td class="text-muted small">@evt.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                        <td>
                                            <span class="badge @GetSeverityBadgeClass(evt.Severity)">
                                                @evt.Severity
                                            </span>
                                        </td>
                                        <td>
                                            <span class="small">@evt.Source</span>
                                            @if (!string.IsNullOrEmpty(evt.SourceIp))
                                            {
                                                <br /><code class="small">@evt.SourceIp</code>
                                            }
                                        </td>
                                        <td class="small">@evt.Description</td>
                                        <td><span class="badge bg-secondary">@evt.Category</span></td>
                                    </tr>
                                }
                                @if (!_events.Any())
                                {
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-3">
                                            No security events recorded
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- SIEM Transport Status -->
        <div class="col-xl-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-broadcast me-2"></i>SIEM Transports</h5>
                </div>
                <div class="card-body">
                    @if (_siemTransports.Any())
                    {
                        @foreach (var transport in _siemTransports)
                        {
                            <div class="border rounded p-3 mb-2">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <strong class="small">@transport.TransportName</strong>
                                    @if (transport.IsConnected)
                                    {
                                        <span class="badge bg-success">Connected</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger">Disconnected</span>
                                    }
                                </div>
                                <div class="text-muted" style="font-size: 0.75rem;">
                                    <div>Type: @transport.TransportType</div>
                                    <div>Events sent: @transport.EventsSentTotal.ToString("N0")</div>
                                    @if (transport.EventsDropped > 0)
                                    {
                                        <div class="text-danger">Dropped: @transport.EventsDropped.ToString("N0")</div>
                                    }
                                    <div>Last event: @FormatTimeAgo(transport.LastEventSent)</div>
                                    @if (!string.IsNullOrEmpty(transport.ErrorMessage))
                                    {
                                        <div class="text-danger mt-1">@transport.ErrorMessage</div>
                                    }
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-broadcast" style="font-size: 2rem;"></i>
                            <p class="mb-0 mt-2 small">No SIEM transports configured</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Incident Response -->
    <div class="row g-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-exclamation-diamond me-2"></i>Active Incidents</h5>
                    @{
                        var openCount = _incidents.Count(i => i.Status.Equals("Open", StringComparison.OrdinalIgnoreCase));
                    }
                    @if (openCount > 0)
                    {
                        <span class="badge bg-danger">@openCount open</span>
                    }
                    else
                    {
                        <span class="badge bg-success">All clear</span>
                    }
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Severity</th>
                                    <th>Title</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Assigned To</th>
                                    <th>Resolved</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var incident in _incidents)
                                {
                                    <tr>
                                        <td><code>@incident.Id</code></td>
                                        <td>
                                            <span class="badge @GetSeverityBadgeClass(incident.Severity)">
                                                @incident.Severity
                                            </span>
                                        </td>
                                        <td>
                                            <strong>@incident.Title</strong>
                                            @if (!string.IsNullOrEmpty(incident.Description))
                                            {
                                                <br /><small class="text-muted">@TruncateText(incident.Description, 80)</small>
                                            }
                                        </td>
                                        <td>
                                            <span class="badge @GetIncidentStatusClass(incident.Status)">
                                                @incident.Status
                                            </span>
                                        </td>
                                        <td class="text-muted small">@incident.CreatedAt.ToString("yyyy-MM-dd HH:mm")</td>
                                        <td>@(string.IsNullOrEmpty(incident.AssignedTo) ? "Unassigned" : incident.AssignedTo)</td>
                                        <td class="text-muted small">
                                            @if (incident.ResolvedAt.HasValue)
                                            {
                                                @incident.ResolvedAt.Value.ToString("yyyy-MM-dd HH:mm")
                                            }
                                            else
                                            {
                                                <span class="text-warning">Pending</span>
                                            }
                                        </td>
                                    </tr>
                                }
                                @if (!_incidents.Any())
                                {
                                    <tr>
                                        <td colspan="7" class="text-center text-muted py-4">
                                            <i class="bi bi-shield-check text-success" style="font-size: 2rem;"></i>
                                            <p class="mb-0 mt-2">No active incidents</p>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<div class="text-muted small mt-3 text-end">
    Auto-refreshes every 15 seconds
</div>

@code {
    private SecurityPostureDto? _posture;
    private List<SecurityEventDto> _events = new();
    private List<SecurityIncidentDto> _incidents = new();
    private List<SiemTransportStatusDto> _siemTransports = new();
    private string? _error;
    private bool _loading = true;
    private PeriodicTimer? _refreshTimer;
    private CancellationTokenSource? _cts;

    protected override async Task OnInitializedAsync()
    {
        _cts = new CancellationTokenSource();
        await RefreshDataAsync();
        _ = AutoRefreshLoopAsync(_cts.Token);
    }

    private async Task AutoRefreshLoopAsync(CancellationToken cancellationToken)
    {
        _refreshTimer = new PeriodicTimer(TimeSpan.FromSeconds(15));
        try
        {
            while (await _refreshTimer.WaitForNextTickAsync(cancellationToken))
            {
                await RefreshDataAsync();
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (OperationCanceledException)
        {
            // Normal disposal
        }
    }

    private async Task RefreshDataAsync()
    {
        try
        {
            _loading = true;
            var postureTask = ApiClient.GetSecurityPostureAsync(_cts?.Token ?? default);
            var eventsTask = ApiClient.GetSecurityEventsAsync(50, _cts?.Token ?? default);
            var incidentsTask = ApiClient.GetSecurityIncidentsAsync(_cts?.Token ?? default);
            var siemTask = ApiClient.GetSiemTransportStatusAsync(_cts?.Token ?? default);

            await Task.WhenAll(postureTask, eventsTask, incidentsTask, siemTask);

            _posture = await postureTask;
            _events = (await eventsTask).ToList();
            _incidents = (await incidentsTask).ToList();
            _siemTransports = (await siemTask).ToList();
            _error = null;
        }
        catch (DashboardApiException ex)
        {
            _error = ex.Message;
            Logger.LogWarning(ex, "Failed to refresh security dashboard");
        }
        catch (Exception ex)
        {
            _error = "Unexpected error loading security data.";
            Logger.LogError(ex, "Unexpected error refreshing security dashboard");
        }
        finally
        {
            _loading = false;
        }
    }

    private static string GetScoreColor(int score) => score switch
    {
        >= 80 => "#198754",  // green
        >= 60 => "#ffc107",  // yellow
        >= 40 => "#fd7e14",  // orange
        _ => "#dc3545"       // red
    };

    private static string GetSeverityBadgeClass(string severity) => severity.ToLowerInvariant() switch
    {
        "critical" => "bg-danger",
        "high" => "bg-warning text-dark",
        "medium" => "bg-info",
        "low" => "bg-secondary",
        "info" => "bg-light text-dark border",
        _ => "bg-secondary"
    };

    private static string GetIncidentStatusClass(string status) => status.ToLowerInvariant() switch
    {
        "open" => "bg-danger",
        "contained" => "bg-warning text-dark",
        "resolved" => "bg-success",
        "closed" => "bg-secondary",
        _ => "bg-secondary"
    };

    private static string FormatTimeAgo(DateTime utcTime)
    {
        if (utcTime == default) return "Never";
        var elapsed = DateTime.UtcNow - utcTime;
        if (elapsed.TotalSeconds < 5) return "Just now";
        if (elapsed.TotalSeconds < 60) return $"{(int)elapsed.TotalSeconds}s ago";
        if (elapsed.TotalMinutes < 60) return $"{(int)elapsed.TotalMinutes}m ago";
        if (elapsed.TotalHours < 24) return $"{(int)elapsed.TotalHours}h ago";
        return $"{(int)elapsed.TotalDays}d ago";
    }

    private static string TruncateText(string text, int maxLength)
    {
        if (text.Length <= maxLength) return text;
        return text[..maxLength] + "...";
    }

    public void Dispose()
    {
        _cts?.Cancel();
        _cts?.Dispose();
        _refreshTimer?.Dispose();
    }
}
