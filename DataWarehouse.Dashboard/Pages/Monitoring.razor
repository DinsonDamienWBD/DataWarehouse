@page "/monitoring"
@inject ISystemHealthService HealthService
@implements IDisposable

<PageTitle>Monitoring - DataWarehouse</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="mb-0">System Monitoring</h4>
        <small class="text-muted">Real-time system metrics and performance monitoring</small>
    </div>
    <div class="d-flex gap-2">
        <select class="form-select form-select-sm" style="width: 150px;" @bind="_timeRange">
            <option value="15">Last 15 min</option>
            <option value="60">Last hour</option>
            <option value="360">Last 6 hours</option>
            <option value="1440">Last 24 hours</option>
        </select>
        <button class="btn btn-sm btn-outline-primary" @onclick="RefreshData">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
    </div>
</div>

<!-- System Health Overview -->
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-heart-pulse me-2"></i>System Health</h5>
                @if (_health != null)
                {
                    <span class="badge @GetHealthBadgeClass(_health.OverallStatus) fs-6">
                        @_health.OverallStatus
                    </span>
                }
            </div>
            <div class="card-body">
                @if (_health?.Components != null)
                {
                    <div class="row">
                        @foreach (var component in _health.Components)
                        {
                            <div class="col-md-4 col-lg-3 mb-3">
                                <div class="card h-100 @GetComponentCardClass(component.Status)">
                                    <div class="card-body py-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span>@component.Name</span>
                                            <span class="badge @GetHealthBadgeClass(component.Status)">
                                                @component.Status
                                            </span>
                                        </div>
                                        @if (!string.IsNullOrEmpty(component.Message))
                                        {
                                            <small class="text-muted">@component.Message</small>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm"></div>
                        Loading health data...
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Resource Usage -->
<div class="row g-4 mb-4">
    <div class="col-xl-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <h6 class="text-muted mb-3">CPU Usage</h6>
                <div class="position-relative" style="width: 150px; height: 150px; margin: 0 auto;">
                    <svg viewBox="0 0 36 36" class="circular-chart">
                        <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        <path class="circle @GetCircleClass(_metrics?.CpuUsagePercent ?? 0)"
                              stroke-dasharray="@((_metrics?.CpuUsagePercent ?? 0).ToString("F0")), 100"
                              d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    </svg>
                    <div class="position-absolute top-50 start-50 translate-middle">
                        <h3 class="mb-0">@((_metrics?.CpuUsagePercent ?? 0).ToString("F1"))%</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <h6 class="text-muted mb-3">Memory Usage</h6>
                @{
                    var memPercent = _metrics != null && _metrics.MemoryTotalBytes > 0
                        ? (double)_metrics.MemoryUsedBytes / _metrics.MemoryTotalBytes * 100
                        : 0;
                }
                <div class="position-relative" style="width: 150px; height: 150px; margin: 0 auto;">
                    <svg viewBox="0 0 36 36" class="circular-chart">
                        <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        <path class="circle @GetCircleClass(memPercent)"
                              stroke-dasharray="@memPercent.ToString("F0"), 100"
                              d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    </svg>
                    <div class="position-absolute top-50 start-50 translate-middle">
                        <h3 class="mb-0">@memPercent.ToString("F1")%</h3>
                    </div>
                </div>
                <small class="text-muted">
                    @FormatBytes(_metrics?.MemoryUsedBytes ?? 0) / @FormatBytes(_metrics?.MemoryTotalBytes ?? 0)
                </small>
            </div>
        </div>
    </div>
    <div class="col-xl-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <h6 class="text-muted mb-3">Disk Usage</h6>
                @{
                    var diskPercent = _metrics != null && _metrics.DiskTotalBytes > 0
                        ? (double)_metrics.DiskUsedBytes / _metrics.DiskTotalBytes * 100
                        : 0;
                }
                <div class="position-relative" style="width: 150px; height: 150px; margin: 0 auto;">
                    <svg viewBox="0 0 36 36" class="circular-chart">
                        <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        <path class="circle @GetCircleClass(diskPercent)"
                              stroke-dasharray="@diskPercent.ToString("F0"), 100"
                              d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    </svg>
                    <div class="position-absolute top-50 start-50 translate-middle">
                        <h3 class="mb-0">@diskPercent.ToString("F1")%</h3>
                    </div>
                </div>
                <small class="text-muted">
                    @FormatBytes(_metrics?.DiskUsedBytes ?? 0) / @FormatBytes(_metrics?.DiskTotalBytes ?? 0)
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Performance Metrics -->
<div class="row g-4 mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <h6 class="text-muted">Active Connections</h6>
                <h3>@(_metrics?.ActiveConnections ?? 0)</h3>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <h6 class="text-muted">Requests/Second</h6>
                <h3>@((_metrics?.RequestsPerSecond ?? 0).ToString("F1"))</h3>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <h6 class="text-muted">Thread Count</h6>
                <h3>@(_metrics?.ThreadCount ?? 0)</h3>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <h6 class="text-muted">Uptime</h6>
                <h3>@FormatUptime(_metrics?.UptimeSeconds ?? 0)</h3>
            </div>
        </div>
    </div>
</div>

<!-- Alerts -->
<div class="card border-0 shadow-sm">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-bell me-2"></i>Active Alerts</h5>
        <span class="badge bg-danger">@_alerts.Count(a => !a.IsAcknowledged)</span>
    </div>
    <div class="card-body p-0">
        @if (_alerts.Any())
        {
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Severity</th>
                            <th>Title</th>
                            <th>Message</th>
                            <th>Time</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var alert in _alerts)
                        {
                            <tr>
                                <td><span class="badge @GetAlertBadgeClass(alert.Severity)">@alert.Severity</span></td>
                                <td>@alert.Title</td>
                                <td>@alert.Message</td>
                                <td class="text-muted small">@alert.Timestamp.ToString("HH:mm:ss")</td>
                                <td>
                                    @if (alert.IsAcknowledged)
                                    {
                                        <span class="badge bg-secondary">Acknowledged</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning text-dark">Active</span>
                                    }
                                </td>
                                <td>
                                    @if (!alert.IsAcknowledged)
                                    {
                                        <button class="btn btn-sm btn-outline-primary" @onclick="() => AcknowledgeAlert(alert.Id)">
                                            Acknowledge
                                        </button>
                                    }
                                    <button class="btn btn-sm btn-outline-secondary" @onclick="() => ClearAlert(alert.Id)">
                                        Clear
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="text-center py-5">
                <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                <h5 class="mt-3">No Active Alerts</h5>
                <p class="text-muted">All systems are operating normally.</p>
            </div>
        }
    </div>
</div>

<style>
    .circular-chart {
        width: 100%;
        height: 100%;
    }

    .circle-bg {
        fill: none;
        stroke: #eee;
        stroke-width: 3.8;
    }

    .circle {
        fill: none;
        stroke-width: 2.8;
        stroke-linecap: round;
        animation: progress 1s ease-out forwards;
    }

    .circle.green { stroke: #28a745; }
    .circle.yellow { stroke: #ffc107; }
    .circle.red { stroke: #dc3545; }

    @@keyframes progress {
        0% { stroke-dasharray: 0 100; }
    }
</style>

@code {
    private SystemHealthStatus? _health;
    private SystemMetrics? _metrics;
    private List<SystemAlert> _alerts = new();
    private int _timeRange = 60;
    private Timer? _refreshTimer;

    protected override async Task OnInitializedAsync()
    {
        await RefreshData();
        _refreshTimer = new Timer(async _ => await RefreshData(), null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
    }

    private async Task RefreshData()
    {
        try
        {
            _health = await HealthService.GetSystemHealthAsync();
            _metrics = HealthService.GetCurrentMetrics();
            _alerts = HealthService.GetAlerts(false).ToList();
            await InvokeAsync(StateHasChanged);
        }
        catch
        {
            // Silently ignore refresh failures - UI will show stale data until next successful refresh
        }
    }

    private async Task AcknowledgeAlert(string alertId)
    {
        await HealthService.AcknowledgeAlertAsync(alertId, "admin");
        await RefreshData();
    }

    private async Task ClearAlert(string alertId)
    {
        await HealthService.ClearAlertAsync(alertId);
        await RefreshData();
    }

    private string GetHealthBadgeClass(HealthStatus status) => status switch
    {
        HealthStatus.Healthy => "bg-success",
        HealthStatus.Degraded => "bg-warning text-dark",
        HealthStatus.Critical => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetComponentCardClass(HealthStatus status) => status switch
    {
        HealthStatus.Healthy => "",
        HealthStatus.Degraded => "border-warning",
        HealthStatus.Critical => "border-danger",
        _ => ""
    };

    private string GetAlertBadgeClass(AlertSeverity severity) => severity switch
    {
        AlertSeverity.Info => "bg-info",
        AlertSeverity.Warning => "bg-warning text-dark",
        AlertSeverity.Error => "bg-danger",
        AlertSeverity.Critical => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetCircleClass(double percent)
    {
        if (percent < 60) return "green";
        if (percent < 80) return "yellow";
        return "red";
    }

    private string FormatBytes(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        int order = 0;
        double size = bytes;
        while (size >= 1024 && order < sizes.Length - 1) { order++; size /= 1024; }
        return $"{size:F1} {sizes[order]}";
    }

    private string FormatUptime(long seconds)
    {
        var ts = TimeSpan.FromSeconds(seconds);
        if (ts.TotalDays >= 1) return $"{(int)ts.TotalDays}d {ts.Hours}h";
        if (ts.TotalHours >= 1) return $"{(int)ts.TotalHours}h {ts.Minutes}m";
        return $"{ts.Minutes}m {ts.Seconds}s";
    }

    public void Dispose() => _refreshTimer?.Dispose();
}
